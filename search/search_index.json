{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Linux 201 \u8fdb\u9636\u6559\u7a0b","text":"<p>\u6b22\u8fce\u6765\u5230 Linux 201 \u8fdb\u9636\u6559\u7a0b\uff0c\u672c\u6559\u7a0b\u4e3b\u8981\u9762\u5411 Debian \u53ca\u5176\u884d\u751f\u53d1\u884c\u7248\uff08\u5982 Ubuntu \u7b49\uff09\u7684\u7cfb\u7edf\u8fd0\u7ef4\uff0c\u56e0\u6b64\u4e0e\u4f20\u7edf\u7684 Linux \u6559\u7a0b\u6709\u6240\u4e0d\u540c\u3002</p> <ul> <li>\u4f5c\u4e3a\u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\u662f\u4e00\u9879\u57fa\u672c\u6280\u80fd\uff0c\u56e0\u6b64\u672c\u6559\u7a0b\u4e0d\u4f1a\u4ecb\u7ecd\u56fe\u5f62\u754c\u9762\u5de5\u5177</li> <li>\u5404\u79cd\u8f6f\u4ef6\u5de5\u5177\u90fd\u9644\u5e26\u4e86\u5b8c\u5584\u7684 man \u624b\u518c\uff0c\u56e0\u6b64\u672c\u6559\u7a0b\u4e5f\u4e0d\u4f1a\u8be6\u7ec6\u4ecb\u7ecd\u6240\u6709\u8f6f\u4ef6\u7684\u6bcf\u4e2a\u7ec6\u8282</li> </ul>"},{"location":"advanced/","title":"\u9ad8\u7ea7\u5185\u5bb9","text":""},{"location":"advanced/caddy/","title":"Caddy","text":"<p>Pending Review</p> <p>Caddy \u662f\u4e00\u4e2a\u7528 Go \u7f16\u5199\u7684 HTTP/2 web \u670d\u52a1\u5668\uff0c\u5177\u6709\u81ea\u52a8 HTTPS \u529f\u80fd\u3002\u5b83\u7684\u8bbe\u8ba1\u76ee\u6807\u662f\u7b80\u5355\u3001\u6613\u4e8e\u4f7f\u7528\u3002</p> <p>\u4e0e Nginx \u76f8\u6bd4\uff0cCaddy \u786e\u5b9e\u66f4\u50cf\u662f\u4e2a\u73a9\u5177\uff0c\u4f46\u662f\u66f4\u50cf\u662f\u90a3\u79cd\u81ea\u5e26\u7535\u6c60\u7684\u73a9\u5177\uff0c\u66f4\u5229\u4e8e\u4eba\u7c7b\u4f7f\u7528\uff0c\u53ef\u4ee5\u5feb\u901f\u642d\u5efa Prototype \u800c\u4e0d\u7528\u82b1\u8d39\u592a\u591a\u65f6\u95f4\u5728\u914d\u7f6e\u4e0a\u3002</p>"},{"location":"advanced/caddy/#_1","title":"\u5b89\u88c5","text":"<p>\u4ee5 Debian \u4e3a\u4f8b\uff1a</p> <pre><code>sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl\ncurl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg\ncurl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list\nsudo apt update\nsudo apt install caddy\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u65b9\u6cd5\u5b89\u88c5\u7684 Caddy \u4f1a\u9ed8\u8ba4\u914d\u7f6e systemd \u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>systemctl</code> \u6765\u7ba1\u7406\uff1a</p> <pre><code>sudo systemctl start caddy\nsudo systemctl stop caddy\nsudo systemctl restart caddy\n</code></pre> <p>\u9ed8\u8ba4\u7684 <code>Caddyfile</code> \u7684\u76ee\u5f55\u5728 <code>/etc/caddy/Caddyfile</code>\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>Caddyfile</code> \u6765\u914d\u7f6e Caddy \u7684\u884c\u4e3a\u3002</p> <p>Validate</p> <p>\u5728\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u91cd\u542f Caddy \u4e4b\u524d\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u68c0\u67e5 Caddyfile \u683c\u5f0f\uff0c\u907f\u514d\u914d\u7f6e\u9519\u8bef\u5bfc\u81f4\u670d\u52a1\u505c\u673a\uff08\u7c7b\u4f3c <code>nginx -t</code>\uff09\uff1a</p> <pre><code>caddy validate --config /etc/caddy/Caddyfile\n</code></pre>"},{"location":"advanced/caddy/#_2","title":"\u5e38\u7528\u914d\u7f6e","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u4e9b\u5e38\u7528\u7684 Caddyfile \u914d\u7f6e\u793a\u4f8b\uff1a</p>"},{"location":"advanced/caddy/#_3","title":"\u9759\u6001\u6587\u4ef6\u670d\u52a1\u5668","text":"<pre><code>example.com {\n    root /var/www\n    gzip\n    log /var/log/access.log\n    errors /var/log/error.log\n}\n</code></pre>"},{"location":"advanced/caddy/#_4","title":"\u53cd\u5411\u4ee3\u7406","text":"<pre><code>example.com {\n    proxy / localhost:8080\n}\n</code></pre> <p>Simple LB</p> <p>\u4f7f\u7528\u5982\u4e0b\u914d\u7f6e\u53ef\u505a\u7b80\u5355\u7684 Load Balance\uff1a</p> <pre><code>example.com {\n    proxy / localhost:8080 localhost:8081 {\n        policy round_robin\n    }\n}\n</code></pre>"},{"location":"advanced/cuda/","title":"CUDA \u73af\u5883\u7b80\u4ecb","text":"<p>\u672c\u6587\u521d\u7a3f\uff08\u4e5f\u8bb8\uff09\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>CUDA\uff08Compute Unified Device Architecture\uff09\u662f\u7531 NVIDIA \u516c\u53f8\u63a8\u51fa\u7684\u5f00\u53d1\u5957\u4ef6\uff0c\u5b83\u5141\u8bb8\u8f6f\u4ef6\u5f00\u53d1\u4eba\u5458\u4f7f\u7528 NVIDIA \u7684 GPU\uff08\u56fe\u5f62\u5904\u7406\u5355\u5143\uff09\u8fdb\u884c\u901a\u7528\u8ba1\u7b97\uff0c\u5229\u7528 GPU \u5f3a\u5927\u7684\u5e76\u884c\u5904\u7406\u80fd\u529b\u6765\u52a0\u901f\u8ba1\u7b97\u5bc6\u96c6\u578b\u4efb\u52a1\uff0c\u5e38\u7528\u4e8e\u79d1\u5b66\u8ba1\u7b97\u3001\u5de5\u7a0b\u6a21\u62df\u3001\u673a\u5668\u5b66\u4e60\u7b49\u9886\u57df\u3002</p> <p>\u5305\u542b\u7684\u7ec4\u4ef6\u5305\u62ec\uff1a</p> <ul> <li> <p>CUDA \u9a71\u52a8\u548c\u8fd0\u884c\u65f6\uff1a\u8fd9\u662f\u8fde\u63a5\u4f60\u7684\u8f6f\u4ef6\u548c GPU \u786c\u4ef6\u7684\u57fa\u7840\u5c42\uff0c\u5b83\u5141\u8bb8\u4f60\u7684\u7a0b\u5e8f\u5728 GPU \u4e0a\u6267\u884c\u3002</p> </li> <li> <p>CUDA \u7f16\u8bd1\u5668\uff08nvcc\uff09\uff1a\u8fd9\u662f\u4e00\u4e2a\u5c06 CUDA \u4ee3\u7801\u8f6c\u6362\u6210 GPU \u53ef\u4ee5\u7406\u89e3\u7684\u5f62\u5f0f\u7684\u7f16\u8bd1\u5668\u3002</p> </li> <li> <p>CUDA \u5e93\uff1a\u8fd9\u4e9b\u5e93\u5305\u62ec\u4e00\u7cfb\u5217\u9884\u5236\u7684\u3001\u9ad8\u6548\u7684\u51fd\u6570\uff0c\u6bd4\u5982\u7ebf\u6027\u4ee3\u6570\u8fd0\u7b97\uff08cuBLAS\uff09\u3001\u5085\u91cc\u53f6\u53d8\u6362\uff08cuFFT\uff09\u7b49\u3002</p> </li> <li> <p>CUDA \u5de5\u5177\uff1a\u6bd4\u5982\u6027\u80fd\u5206\u6790\u5668\uff08NVIDIA Nsight \u548c Visual Profiler\uff09\u548c\u8c03\u8bd5\u5de5\u5177\uff0c\u5b83\u4eec\u5e2e\u52a9\u5f00\u53d1\u8005\u4f18\u5316\u548c\u8c03\u8bd5 CUDA \u5e94\u7528\u7a0b\u5e8f\u3002</p> </li> </ul>"},{"location":"advanced/cuda/#cuda_1","title":"\u914d\u7f6e CUDA \u73af\u5883","text":""},{"location":"advanced/cuda/#_1","title":"\u786c\u4ef6\u51c6\u5907","text":"<p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u786e\u8ba4\u663e\u5361\u662f\u5426\u652f\u6301\u652f\u6301 CUDA\u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u67e5\u770b\u652f\u6301\u7684\u5217\u8868\uff1ahttps://developer.nvidia.com/CUDA-gpus</p> <p>\u8868\u4e2d\u7684<code>Compute Capability</code>\u4ee3\u8868\u8ba1\u7b97\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u8868\u660e\u4e86 GPU \u652f\u6301\u7684 CUDA \u7279\u6027\u548c\u6307\u4ee4\u96c6\u7248\u672c\u3002</p>"},{"location":"advanced/cuda/#cuda_2","title":"\u5b89\u88c5 CUDA","text":"<p>\u867d\u7136\u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0b\uff0cCUDA \u7684\u591a\u79cd\u4e0d\u540c\u7684\u5b89\u88c5\u65b9\u5f0f\uff0c\u4f46\u603b\u7684\u6765\u8bf4\uff0c\u5728 Linux \u4e0b\uff0cCUDA \u7684\u5b89\u88c5\u65b9\u5f0f\u5927\u81f4\u5206\u4e3a\uff1a</p> <ol> <li> <p>\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u7684\u4ed3\u5e93\u548c\u5305\u7ba1\u7406\u7cfb\u7edf\u8fdb\u884c\u5b89\u88c5\uff08\u63a8\u8350\uff09</p> <ul> <li>\u90e8\u5206 linux \u53d1\u884c\u7248\u4e0d\u652f\u6301\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u5b89\u88c5 cuda</li> </ul> </li> <li> <p>\u4ece\u5b98\u7f51\u4e0b\u8f7d\u5b89\u88c5\u5305\uff0c\u5e76\u7528\u5305\u7ba1\u7406\u7cfb\u7edf\u8fdb\u884c\u5b89\u88c5</p> </li> <li> <p>\u4f7f\u7528\u5b98\u65b9 runfile \u4e00\u952e\u5b89\u88c5</p> <ul> <li>\u4f7f\u7528\u5b98\u65b9 runfile \u4e00\u952e\u5b89\u88c5\u7684\u65b9\u5f0f\u8f83\u4e3a\u65b9\u4fbf\uff0c\u4f46\u662f\u5728\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4f1a\u8986\u76d6\u7cfb\u7edf\u4e2d\u7684\u67d0\u4e9b\u6587\u4ef6\uff0c\u53ef\u80fd\u4f1a\u7834\u574f\u7cfb\u7edf\u3002\u53e6\u5916 runfile \u5b89\u88c5\u7ba1\u7406\u9ebb\u70e6\uff0c\u4e0d\u80fd\u50cf\u5305\u7ba1\u7406\u5668\u5728\u5b89\u88c5\u8f6f\u4ef6\u65f6\u4f1a\u81ea\u52a8\u5904\u7406\u4f9d\u8d56\u5173\u7cfb\uff0c\u9700\u8981\u7528\u6237\u624b\u52a8\u5904\u7406\u4f9d\u8d56\u95ee\u9898\u3002</li> </ul> </li> </ol> <p>\u5bf9\u4e8e\u540e\u4e24\u79cd\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5728\u5b98\u7f51\u4e0b\u8f7d\u9875\u9762https://developer.nvidia.com/CUDA-downloads\u9009\u62e9\u5408\u9002\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7f51\u9875\u5c06\u7ed9\u51fa\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u7684\u5b89\u88c5\u6307\u4ee4\u3002</p> <p>\u5bf9\u4e8e\u7b2c\u4e00\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u8fd9\u91cc\u4ee5\u5e38\u7528\u7684 Ubuntu \u4e3a\u4f8b\uff1a</p>"},{"location":"advanced/cuda/#_2","title":"\u5b89\u88c5\u9884\u7f16\u8bd1\u7684\u5185\u6838\u6a21\u5757","text":"<pre><code>sudo apt install linux-modules-nvidia-${DRIVER_BRANCH}${SERVER}-${LINUX_FLAVOUR}\n</code></pre> <p><code>${DRIVER_BRANCH}</code>\u662f Nvidia \u9a71\u52a8\u7684\u7248\u672c\u53f7\uff0c\u4f8b\u5982<code>525</code>,<code>535</code>\u7b49</p> <p><code>${SERVER}</code>\u53ef\u4ee5\u662f<code>-server</code>\u6216\u4e3a\u7a7a\uff0c\u4ee3\u8868\u662f\u5426\u9009\u62e9\u4e3a\u670d\u52a1\u5668\u4f18\u5316\u7684\u7248\u672c\u3002</p> <p><code>${LINUX_FLAVOUR}</code>\u53ef\u4ee5\u662f<code>generic</code>\uff0c<code>lowlatency</code>\u7b49\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u9009\u62e9\u524d\u8005\uff0c\u9664\u975e\u5e0c\u671b\u7cfb\u7edf\u5c3d\u53ef\u80fd\u7684\u5b9e\u65f6\uff0c\u540c\u65f6\u53c8\u4e0d\u5e0c\u671b\u964d\u4f4e\u592a\u591a\u7684\u6027\u80fd\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>sudo apt install linux-modules-nvidia-525-generic\n</code></pre>"},{"location":"advanced/cuda/#_3","title":"\u5b89\u88c5\u7528\u6237\u7a7a\u95f4\u7684\u9a71\u52a8\u548c\u5e93","text":"<pre><code>sudo apt install nvidia-driver-${DRIVER_BRANCH}${SERVER}\n</code></pre> <p>\u53c2\u6570\u610f\u4e49\u540c\u4e0a</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>sudo apt install nvidia-driver-525\n</code></pre>"},{"location":"advanced/cuda/#_4","title":"\u67e5\u770b\u663e\u5361\u72b6\u6001","text":"<pre><code>nvidia-smi\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u53ef\u4ee5\u5217\u4e3e\u5e76\u67e5\u770b\u663e\u5361\u7684\u8d44\u6e90\u4f7f\u7528\u7387\uff0c\u6e29\u5ea6\uff0c\u529f\u7387\u7b49\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u80fd\u591f\u67e5\u770b\u5230\u4f60\u7684\u663e\u5361\uff0c\u90a3\u4e48\u606d\u559c\u4f60\uff0c\u663e\u5361\u5df2\u7ecf\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002</p> <p>Tip</p> <p><code>nvidia-smi</code>\u754c\u9762\u53f3\u4e0a\u89d2\u663e\u793a\u7684 CUDA \u7248\u672c\u662f\u6307\u5f53\u524d\u7cfb\u7edf\u4e0a\u5b89\u88c5\u7684 NVIDIA \u9a71\u52a8\u652f\u6301\u7684\u6700\u9ad8 CUDA \u7248\u672c\uff0c\u5e76\u4e0d\u662f\u5df2\u5b89\u88c5\u7684 CUDA \u7248\u672c</p>"},{"location":"advanced/cuda/#_5","title":"\u6dfb\u52a0\u73af\u5883\u53d8\u91cf\uff08\u53ef\u9009\uff09","text":"<p>\u5982\u679c\u4f60\u60f3\u8981\u65b9\u4fbf\u5730\u5728 Shell \u4e2d\u4f7f\u7528 CUDA \u6307\u4ee4\uff0c\u9700\u8981\u5c06\u53ef\u6267\u884c\u6587\u4ef6\u76ee\u5f55\u52a0\u5230<code>PATH</code>\u73af\u5883\u53d8\u91cf\u4e2d</p> <p>\u5728<code>~/.bashrc</code>\u7b49\u6587\u4ef6\u4e2d\u6dfb\u52a0\u8fd9\u4e00\u884c</p> <pre><code>export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}\n</code></pre> <p>\u4ee5\u4fbf\u6267\u884c nvcc \u7b49\u7a0b\u5e8f\u3002</p> <p>\u5982\u679c\u7f16\u8bd1\u9879\u76ee\u65f6\u627e\u4e0d\u5230 CUDA \u5e93\uff0c\u5219\u9700\u8981\u66f4\u65b0\u52a8\u6001\u94fe\u63a5\u5e93\u8def\u5f84\u3002</p> <p>\u5728<code>~/.bashrc</code>\u7b49\u6587\u4ef6\u4e2d\u6dfb\u52a0\u8fd9\u4e00\u884c</p> <pre><code>export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}\n</code></pre>"},{"location":"advanced/nmap/","title":"Nmap: \u7f51\u7edc\u63a2\u6d4b\u548c\u5b89\u5168\u68c0\u67e5\u5de5\u5177","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>Nmap\uff08Network Mapper\uff09\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u7f51\u7edc\u63a2\u6d4b\u548c\u5b89\u5168\u68c0\u67e5\u5de5\u5177\u3002\u5b83\u7531 Gordon Lyon\uff08\u4e5f\u88ab\u79f0\u4e3a Fyodor Vaskovich\uff09\u521b\u9020\uff0c\u5e76\u9996\u6b21\u53d1\u5e03\u4e8e 1997 \u5e74\u3002\u4e3b\u8981\u529f\u80fd\u5305\u62ec\uff0c\u4e3b\u673a\u53d1\u73b0\uff0c\u7aef\u53e3\u626b\u63cf\uff0c\u670d\u52a1\u7248\u672c\u63a2\u6d4b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u68c0\u6d4b\uff0c\u811a\u672c\u626b\u63cf\u7b49\u3002\u7531\u4e8e\u5176\u5f3a\u5927\u7684\u529f\u80fd\u548c\u7075\u6d3b\u6027\uff0cNmap \u5df2\u7ecf\u6210\u4e3a\u4e16\u754c\u4e0a\u6700\u53d7\u6b22\u8fce\u7684\u7f51\u7edc\u626b\u63cf\u5de5\u5177\u4e4b\u4e00\uff0c\u5e76\u88ab\u5e7f\u6cdb\u5e94\u7528\u4e8e\u5b89\u5168\u793e\u533a\u548c IT \u884c\u4e1a\u3002</p> <p>\u8fd9\u662f\u4e00\u4efd Nmap \u4f7f\u7528\u624b\u518c\uff0c\u4f60\u53ef\u4ee5\u53c2\u8003\u672c\u6587\u5feb\u901f\u4e0a\u624b\u4f7f\u7528\u3002</p>"},{"location":"advanced/nmap/#nmap_1","title":"\u5b89\u88c5 Nmap","text":"<p>\u5728\u5927\u591a\u6570 Linux \u53d1\u884c\u7248\u4e2d\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5305\u7ba1\u7406\u5668\u5b89\u88c5 Nmap\uff1a</p>"},{"location":"advanced/nmap/#debianubuntu","title":"Debian/Ubuntu","text":"<pre><code>sudo apt-get install nmap\n</code></pre>"},{"location":"advanced/nmap/#centosfedora","title":"CentOS/Fedora","text":"<pre><code>sudo yum install nmap\n</code></pre>"},{"location":"advanced/nmap/#arch-linux","title":"Arch Linux","text":"<pre><code>sudo pacman -S nmap\n</code></pre>"},{"location":"advanced/nmap/#nmap_2","title":"Nmap \u57fa\u672c\u7528\u6cd5\u4e3e\u4f8b","text":"<p>Question</p> <p>\u4f60\u7684\u5ba4\u53cb\u6709\u4e00\u53f0\u670d\u52a1\u5668\uff0c\u5728\u4e0a\u9762\u8fd0\u884c\u4e86\u5f88\u591a\u670d\u52a1\u3002\u6709\u4e9b\u662f\u53ea\u7ed9\u81ea\u5df1\u4ec5\u9650\u4ed6\u81ea\u5df1\u672c\u673a\u4f7f\u7528\u7684\uff0c\u6709\u4e9b\u4e5f\u8bb8\u4e0d\u5c0f\u5fc3\u5bf9\u5916\u5f00\u653e\u4e86\u3002\u4f60\u975e\u5e38\u70ed\u5fc3\uff0c\u60f3\u5e2e\u5b83\u68c0\u67e5\u4e00\u4e0b\u610f\u5916\u66b4\u9732\u7684\u670d\u52a1\uff0c\u8981\u600e\u4e48\u505a\u5462\uff1f</p>"},{"location":"advanced/nmap/#_1","title":"\u57fa\u672c\u626b\u63cf","text":"<p>\u626b\u63cf\u7f51\u7edc\u4e2d\u7684\u4e3b\u673a\uff0c\u5f00\u653e\u7684\u7aef\u53e3\u548c\u5bf9\u5e94\u7684\u8fd0\u884c\u7684\u670d\u52a1\u3002</p> <p></p> <p>Tip</p> <p>\u5728\u626b\u63cf\u4e2d\u6309\u4e0b\u4efb\u610f\u952e\u53ef\u4ee5\u663e\u793a\u8fdb\u5ea6</p>"},{"location":"advanced/nmap/#_2","title":"\u6307\u5b9a\u5730\u5740","text":"<p>\u626b\u63cf\u5355\u4e2a\u4e3b\u673a\uff1a</p> <pre><code>nmap [target]\n</code></pre> <p>\u626b\u63cf\u591a\u4e2a\u4e3b\u673a\uff1a</p> <pre><code>nmap [target1] [target2] [target3]\n</code></pre> <p>\u626b\u63cf\u6574\u4e2a\u5b50\u7f51\uff1a</p> <pre><code>nmap [subnet]/24\n</code></pre> <p>Tip</p> <p>\u5982\u679c\u4f60\u60f3\u626b\u63cf\u6574\u4e2a\u7f51\u7edc\uff0c\u4f46\u9700\u8981\u8df3\u8fc7\u67d0\u4e9b\u4e3b\u673a\uff0c\u53ef\u4ee5\u4f7f\u7528 --exclude \u9009\u9879\u3002</p> <p>Question</p> <p>\u4f60\u7684\u670d\u52a1\u5668\u5728\u5927\u673a\u623f\u91cc\uff0c\u4f60\u8bb0\u5f97\u4f60\u5728\u4e0a\u9762\u5f00\u4e86\u4e00\u4e2a\u8fd0\u884c\u572825565\u7aef\u53e3\u4e0a\u7684\u670d\u52a1\u3002\u4f46\u662f\u2026\u2026\u4f60\u5fd8\u8bb0\u5b83\u7684ip\u4e86\u3002\u600e\u4e48\u5feb\u901f\u627e\u5230\u5b83\u5462</p>"},{"location":"advanced/nmap/#_3","title":"\u6307\u5b9a\u7aef\u53e3","text":"<p>\u626b\u63cf\u7279\u5b9a\u7aef\u53e3\uff1a</p> <pre><code>nmap -p [port] [target]\n</code></pre> <p>\u626b\u63cf\u591a\u4e2a\u7aef\u53e3\uff1a</p> <pre><code>nmap -p [port1],[port2],[port3] [target]\n</code></pre> <p>\u626b\u63cf\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u7aef\u53e3\uff1a</p> <pre><code>nmap -p [start_port]-[end_port] [target]\n</code></pre>"},{"location":"advanced/nmap/#_4","title":"\u6307\u5b9a\u7f51\u7edc\u534f\u8bae","text":"<p>\u6267\u884c SYN \u626b\u63cf\uff1a</p> <p>\uff08\u53ef\u80fd\u9700\u8981 root \u6743\u9650\uff0c\u5426\u5219\u65e0\u6cd5\u53d1\u9001\u539f\u59cb\u62a5\u6587\uff09</p> <pre><code>sudo nmap -sS [target]\n</code></pre> <p>\u6267\u884c UDP \u626b\u63cf\uff08\u53ef\u80fd\u9700\u8981\u8f83\u957f\u65f6\u95f4\uff09\uff1a</p> <pre><code>sudo nmap -sU [target]\n</code></pre>"},{"location":"advanced/nmap/#_5","title":"\u670d\u52a1\u548c\u7248\u672c\u68c0\u6d4b","text":"<p>\u68c0\u6d4b\u670d\u52a1\u7684\u7248\u672c\u4fe1\u606f\uff1a</p> <pre><code>nmap -sV [target]\n</code></pre> <p>Question</p> <p>\u5b9e\u9a8c\u5ba4\u8dd1\u4e86 20 \u5e74\u7684\u53e4\u8463\u670d\u52a1\u5668\u662f\u4ec0\u4e48\u64cd\u4f5c\u7cfb\u7edf\u5462\uff1f\ud83e\udd14</p>"},{"location":"advanced/nmap/#_6","title":"\u64cd\u4f5c\u7cfb\u7edf\u68c0\u6d4b","text":"<p>\u68c0\u6d4b\u67d0\u4e2a\u4e3b\u673a\u7684\u64cd\u4f5c\u7cfb\u7edf\uff1a</p> <pre><code>nmap -O [target]\n</code></pre> <p>Tip</p> <p>\u4f7f\u7528 -T \u9009\u9879\u53ef\u4ee5\u8bbe\u7f6e Nmap \u7684\u626b\u63cf\u901f\u5ea6\uff0c-T4 \u548c -T5 \u9009\u9879\u53ef\u4ee5\u52a0\u5feb\u626b\u63cf\u901f\u5ea6\uff0c\u4f46\u4e5f\u66f4\u5bb9\u6613\u88ab\u5165\u4fb5\u68c0\u6d4b\u7cfb\u7edf\uff08IDS\uff09\u53d1\u73b0\u3002\u5982\u679c\u60f3\u8981\u66f4\u9690\u853d\u5730\u626b\u63cf\uff0c\u53ef\u4ee5\u9009\u62e9 -T2 \u6216 -T3\u3002</p>"},{"location":"advanced/nmap/#_7","title":"\u8f93\u51fa\u683c\u5f0f","text":"<p>Nmap \u652f\u6301\u7684\u8f93\u51fa\u683c\u5f0f\u5305\u62ec\uff1a</p> <ul> <li>\u6807\u51c6\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u3002</li> <li>-oN \u8f93\u51fa\u5230\u666e\u901a\u6587\u4ef6\u3002</li> <li>-oX \u8f93\u51fa\u4e3a XML \u683c\u5f0f\u3002</li> <li>-oG \u8f93\u51fa\u4e3a grep \u53cb\u597d\u683c\u5f0f\u3002</li> <li>-oA \u8f93\u51fa\u6240\u6709\u4e0a\u8ff0\u683c\u5f0f\u3002</li> </ul> <p>\u4f8b\u5982\u60f3\u8981\u8f93\u51fa\u5230\u6587\u4ef6\uff0c\u53ef\u4ee5\u8fd9\u6837\u505a\uff1a</p> <pre><code>nmap -oN output.txt [target]\n</code></pre> <p>Tip</p> <p>\u5982\u679c\u4f60\u4e0d\u559c\u6b22\u547d\u4ee4\u884c\uff0c\u53ef\u4ee5\u4f7f\u7528 Nmap \u7684\u56fe\u5f62\u7528\u6237\u754c\u9762\u7248\u672c Zenmap\uff0c\u5b83\u63d0\u4f9b\u4e86\u7528\u6237\u53cb\u597d\u7684\u754c\u9762\u6765\u8fd0\u884c\u626b\u63cf\u548c\u5206\u6790\u7ed3\u679c\u3002</p>"},{"location":"dev/","title":"\u5f00\u53d1\u901f\u67e5\u624b\u518c","text":""},{"location":"dev/git/","title":"\u7248\u672c\u7ba1\u7406\u4e0e\u5408\u4f5c","text":"<p>Pending Review</p>"},{"location":"dev/git/#git","title":"Git \u4f7f\u7528\u6280\u5de7","text":""},{"location":"dev/git/#git-config-file","title":"\u672c\u5730\u914d\u7f6e","text":"<p>\u914d\u7f6e\u6587\u4ef6</p> <p>Git \u7684\u914d\u7f6e\u6587\u4ef6\u4e00\u822c\u5b58\u653e\u4e8e <code>~/.gitconfig</code> \u6216 <code>~/.config/git/config</code> \u4e2d, \u53ef\u4ee5\u4f7f\u7528 <code>git config --global --edit</code> \u5feb\u901f\u6253\u5f00\u914d\u7f6e\u6587\u4ef6, \u4f60\u53ef\u4ee5\u76f4\u63a5\u62f7\u8d1d\u4e0b\u9762\u7684\u5185\u5bb9\u3002</p> <p>\u4e0b\u6587\u4e2d\u4f1a\u8bb2\u89e3\u90e8\u5206\u914d\u7f6e\u7684\u4f5c\u7528\u53ca\u6ce8\u610f\u4e8b\u9879\u3002</p> <p>\u7f29\u8fdb\u95ee\u9898</p> <p>\u4e0b\u9762\u7684\u6587\u6863\u4e2d\uff0c<code>.gitconfig</code> \u7684\u914d\u7f6e\u6587\u4ef6\u5747\u4f7f\u7528 4 \u4e2a\u7a7a\u683c\u800c\u4e0d\u662f <code>tab</code> \u8fdb\u884c\u7f29\u8fdb\u3002</p>"},{"location":"dev/git/#git-alias","title":"\u5e38\u7528\u522b\u540d","text":"<pre><code>[alias]\n    aliases = !git config --get-regexp alias | sed -re 's/alias\\\\.(\\\\S*)\\\\s(.*)$/\\\\1 = \\\\2/g'\n    ci = commit\n    co = checkout\n    st = status\n    lg = log --graph --date=relative --pretty=tformat:'%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%an %ad)%Creset'\n    oops = commit --amend --no-edit\n    reword = commit --amend\n    push-with-lease = push --force-with-lease\n    uncommit = reset --soft HEAD~1\n</code></pre>"},{"location":"dev/git/#git-config","title":"\u5e38\u7528\u914d\u7f6e","text":"<pre><code>[color]\n    ui = auto\n[color \"branch\"]\n    upstream = green\n    remote = red\n[core]\n    editor = nvim\n    excludesfile = ~/.gitignore_global\n[commit]\n    template = ~/.gitmessage\n[pull]\n    ff = only\n[push]\n    default = upstream\n    followTags = true\n[tag]\n    sort = version:refname\n</code></pre>"},{"location":"dev/git/#git-gitignore","title":"gitignore","text":"<p>GitHub \u5728 \u8fd9\u91cc \u63d0\u4f9b\u4e86\u4e00\u4e9b\u5e38\u89c1\u7684 <code>.gitignore</code> \u6587\u4ef6\uff0c\u5bf9\u4e8e\u8f83\u4e3a\u590d\u6742\u7684\u9879\u76ee\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528gitignore.io \u751f\u6210\u3002</p> <p><code>.env</code> \u6587\u4ef6\u4e0e <code>.gitignore</code></p> <p>\u6709\u4e9b\u9879\u76ee\u5728\u5f00\u53d1\u7684\u9014\u4e2d\uff0c\u53ef\u80fd\u5f15\u5165<code>.env</code>\u7528\u4e8e\u5b58\u653e\u6d4b\u8bd5\u73af\u5883\u7684\u914d\u7f6e\uff0c\u8fd9\u7c7b\u6587\u4ef6\u901a\u5e38\u5305\u542b\u654f\u611f\u4fe1\u606f\uff0c\u56e0\u6b64\u5e94\u8be5\u88ab\u52a0\u5165\u5230<code>.gitignore</code>\u4e2d\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u56de\u9000\u65f6 <code>.env</code> \u4f1a\u88ab\u5ffd\u7565\uff0c\u5982\u679c\u6b64\u65f6 <code>.gitignore</code> \u4e0d\u542b <code>.env</code>\uff0c <code>.env</code> \u4f1a\u88ab\u89c6\u4f5c untracked files\u3002</p> <pre><code>classDiagram\ndirection LR\nCommitA --|&gt; CommitB : \"Add .env to .gitignore\"\nCommitB --|&gt; CommitA_revert : reset --hard\nCommitA: .gitignore (without .env)\nCommitB: .gitignore (including .env)\nCommitB: .env\nCommitA_revert: .env (untracked)\nCommitA_revert: .gitignore (without .env)</code></pre> <p>\u6b64\u65f6\u9700\u624b\u52a8\u5c06<code>.env</code> \u79fb\u9664\u7248\u672c\u63a7\u5236\uff0c\u4f8b\u5982 <code>mv ./.env ../.env.bk</code> \u4ee5\u9632\u6b62<code>.env</code>\u88ab\u63d0\u4ea4\u3002</p> <p>\u4ec5\u672c\u5730\u7684 gitignore</p> <p>\u672c\u5730\u7684 <code>.git/info/exclude</code> \u8d77\u5230\u4e0e <code>.gitignore</code> \u76f8\u540c\u7684\u4f5c\u7528\uff0c\u4f46\u662f\u4e0d\u4f1a\u88ab\u63d0\u4ea4\u5230\u7248\u672c\u5e93\u4e2d\uff0c\u9002\u7528\u4e8e\u4ee5\u4e0b\u7684\u60c5\u51b5\uff1a</p> <ul> <li>\u9879\u76ee\u4e0d\u5141\u8bb8\u4fee\u6539 <code>.gitignore</code></li> <li>\u76ee\u5f55\u540d\u79f0\u672c\u8eab\u5305\u542b\u654f\u611f\u4fe1\u606f</li> <li>\u4e0d\u5e0c\u671b <code>.gitignore</code> \u53c2\u4e0e\u5230\u7248\u672c\u63a7\u5236\u4e2d</li> </ul> <p>\u8be6\u7ec6\u7684\u6587\u6863\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\u3002</p>"},{"location":"dev/git/#git-global-gitignore","title":"Global gitignore","text":"<p>\u5bf9\u4e8e\u4e00\u4e9b\u5e38\u89c1\u7684\u6587\u4ef6\u7c7b\u578b\uff0c\u53ef\u4ee5\u5728\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\uff1a</p> <pre><code>[core]\n    excludesfile = ~/.gitignore_global\n</code></pre> <pre><code># ~/.gitignore_global\n*~\n.DS_Store # for macOS\n.idea\n*.cache\n.vscode\n</code></pre>"},{"location":"dev/git/#git-hooks","title":"Git Hook","text":"<p>\u5bf9\u4e8e\u4e00\u4e9b\u91cd\u590d\u6027\u7684\u5de5\u4f5c\uff08\u4f8b\u5982\u683c\u5f0f\u5316\u4ee3\u7801\u3001\u68c0\u67e5\u4ee3\u7801\u98ce\u683c\u7b49\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 Git Hook \u6765\u81ea\u52a8\u5316\u3002</p> <p>\u4e00\u4e2a\u53eb\u8f83\u4e3a\u6210\u719f\u7684\u6846\u67b6\u662f pre-commit\uff0c\u5b83\u652f\u6301\u591a\u79cd\u8bed\u8a00\u548c\u5de5\u5177\uff0c\u4f8b\u5982 <code>black</code>\u3001<code>flake8</code>\u3001<code>eslint</code> \u7b49\uff0c\u8fd9\u91cc \u63d0\u4f9b\u4e86\u4e00\u4e9b\u5e38\u7528\u7684 hook.</p> <p>\u5982\u679c\u53ea\u9700\u8981\u5728 commit \u540e\u8fd0\u884c\u4e00\u6bb5\u811a\u672c</p> <p>\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u65b9\u6cd5\u8fdb\u884c\u914d\u7f6e\uff1a <pre><code># \u5728\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u521b\u5efa .git/hooks/post-commit\ntouch .git/hooks/__hook_name__\nchmod +x .git/hooks/__hook_name__\n</code></pre></p> <pre><code># .git/hooks/post-commit\n#!/bin/bash\n\n# \u5728\u8fd9\u91cc\u5199\u5165\u4f60\u7684\u811a\u672c\nfor file in $(git diff --cached --name-only --diff-filter=ACM | grep '\\.py$'); do\n    black $file\ndone\n</code></pre>"},{"location":"dev/git/#git-submodule","title":"Git Submodule","text":"<p>Submodule \u53ef\u4ee5\u7528\u6765\u6dfb\u52a0\u5916\u90e8\u9879\u76ee\uff0c\u4f8b\u5982\u5411\u4e00\u4e2a C++ \u9879\u76ee\u4e2d\u6dfb\u52a0 Eigen\uff1a</p> <pre><code>git submodule add https://gitlab.com/libeigen/eigen.git src/eigen\n</code></pre> <p>\u5982\u679c\u5df2\u7ecf clone \u5230\u4e86\u5b50\u76ee\u5f55 <code>src/eigen</code> \u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u6cd5\u6dfb\u52a0\uff1a</p> <pre><code>git rm --cached -f src/eigen # if you've already added it to the index\ngit submodule add &lt;url_of_eigen&gt; src/eigen\n</code></pre>"},{"location":"dev/git/#git-rebase-merge","title":"Rebase \u4e0e Merge","text":"<p>\u4e00\u822c\u6765\u8bf4\uff0c\u6211\u4eec\u5e0c\u671b\u4fdd\u6301\u9879\u76ee\u6709\u7ebf\u6027\u7684\u63d0\u4ea4\u5386\u53f2\uff0c\u8fd9\u6837\u53ef\u4ee5\u66f4\u5bb9\u6613\u5730\u8ffd\u6eaf\u95ee\u9898\uff0c\u56e0\u6b64\u63a8\u8350\u4f7f\u7528 <code>rebase</code> \u6765\u5408\u5e76\u5206\u652f\u3002</p> <pre><code>git checkout -b feature\ngit commit -a --alow-empty -m \"feat: aaaaaa\"\ngit checkout master\ngit commit -a --alow-empty -m \"feat: bbbbbb\"\ngit checkout feature\ngit rebase master\n</code></pre> <p>\u901a\u8fc7\u5982\u4e0b\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u5f97 <code>rebase</code> \u6210\u4e3a\u9ed8\u8ba4\u884c\u4e3a\uff1a</p> <pre><code>[pull]\n    rebase = true\n</code></pre>"},{"location":"dev/git/#git-commit-message","title":"Commit Message Convention","text":"<p>\u5bf9\u4e8e\u591a\u4eba\u534f\u4f5c\u7684\u9879\u76ee\uff0c\u826f\u597d\u7684 commit message \u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u80e1\u4e71\u4f7f\u7528\u8bf8\u5982 <code>update</code>\u3001<code>fix</code>\u3001<code>change</code> \u7b49\u65e0\u610f\u4e49\u7684 Commit Message\uff0c\u4f1a\u4f7f\u5f97\u9879\u76ee\u7684\u5386\u53f2\u8bb0\u5f55\u53d8\u5f97\u96be\u4ee5\u7406\u89e3\uff0c\u4e5f\u4f1a\u7ed9\u540e\u7eed\u7684\u7ef4\u62a4\u5e26\u6765\u56f0\u96be\u3002</p> <p>Conventional Commits</p> <p>\u4e00\u79cd\u5e38\u89c1\u7684 Commit Message \u683c\u5f0f\u662f Conventional Commits\uff0c\u5b83\u7684\u683c\u5f0f\u662f\uff1a</p> <pre><code>&lt;type&gt;[optional scope]: &lt;description&gt;\n\n[optional body]\n\n[optional footer(s)]\n</code></pre> <p>\u5176\u4e2d\uff1a</p> <ul> <li><code>type</code> \u662f commit \u7684\u7c7b\u578b\uff0c\u53ef\u4ee5\u662f <code>feat</code>\u3001<code>fix</code>\u3001<code>docs</code>\u3001<code>style</code>\u3001<code>refactor</code>\u3001<code>perf</code>\u3001<code>test</code>\u3001<code>build</code>\u3001<code>ci</code>\u3001<code>chore</code> \u7b49\u3002</li> <li><code>scope</code> \u662f commit \u7684\u4f5c\u7528\u57df</li> <li><code>description</code> \u662f commit \u7684\u7b80\u8981\u63cf\u8ff0</li> <li><code>body</code> \u662f commit \u7684\u8be6\u7ec6\u63cf\u8ff0\uff0c\u901a\u5e38\u4f1a\u5f15\u7528 issue\u3001\u89e3\u91ca\u4fee\u6539\u7684\u539f\u56e0\u7b49</li> <li><code>footer</code> \u901a\u5e38\u7528\u4e8e\u5f15\u7528 issue\u3001\u5173\u95ed issue \u7b49\uff0c\u4f8b\u5982 <code>Closes #123</code>\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u6307\u5b9a breaking change \u7b49</li> </ul> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u4ee5\u4e0a\u89c4\u8303\u4ec5\u4ec5\u53ea\u662f\u63a8\u8350\uff0c\u5b9e\u9645\u4f7f\u7528\u65f6\u53ef\u4ee5\u6839\u636e\u9879\u76ee\u7684\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u8c03\u6574\uff0c\u4f8b\u5982\u672c\u6587\u6863\u6240\u5b58\u653e\u7684\u4ed3\u5e93\u662f\u4e00\u4e2a\u6587\u6863\u7c7b\u7684\u9879\u76ee\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u53ef\u4ee5\u76f4\u63a5\u7701\u7565\u6389<code>type</code>.</p> <p>Commit Message \u6a21\u677f</p> <p>\u5373\u4fbf\u4e0d\u4e25\u683c\u9075\u5faa\u4e0a\u8ff0\u89c4\u8303\uff0c\u8bbe\u7f6e\u4e00\u4e2a commit message \u6a21\u677f\u4e5f\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u4f8b\u5982\uff0c\u53ef\u4ee5\u5c06 \u8fd9\u91cc\u7684\u4f8b\u5b50 \u6dfb\u52a0\u5230 <code>~/.gitmessage</code>\uff1a</p> <pre><code># ~/.gitconfig\n[commit]\n    template = ~/.gitmessage\n</code></pre> <p>\u6dfb\u52a0\u540e\u4e0d\u8981\u5fd8\u8bb0\u5728\u9996\u884c\u6dfb\u52a0\u7a7a\u884c\uff0c\u8fd9\u6837 <code>git commit</code> \u65f6\u65e0\u9700\u65b0\u5efa\u4e00\u884c\u3002</p>"},{"location":"dev/git/#github","title":"GitHub \u4f7f\u7528\u6280\u5de7","text":""},{"location":"dev/git/#github-cli","title":"GitHub CLI","text":"<p>GitHub CLI \u662f GitHub \u5b98\u65b9\u63d0\u4f9b\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u7ba1\u7406 GitHub \u4ed3\u5e93\u3001Issue\u3001Pull Request \u7b49\u3002</p> <p>\u4f8b\u5982\uff0c\u7ed9 <code>ustclug/Linux201-docs</code> \u4fee bug \u7684\u6d41\u7a0b\u53ef\u4ee5\u7b80\u5316\u4e3a\uff1a</p> <pre><code>gh repo clone ustclug/Linux201-docs\ngit commit -a -m \"fix: some bug\"\ngh pr create\n</code></pre>"},{"location":"dev/git/#github-gpg","title":"GPG \u7b7e\u540d","text":"<p>SSH Key \u53ea\u7528\u6765\u9a8c\u8bc1 push \u73af\u8282\u7684\u8eab\u4efd\uff0c\u800c GPG Key \u5219\u7528\u6765\u9a8c\u8bc1 Commit \u7684\u771f\u5b9e\u6027\u3002</p> <p>GitHub \u5bf9 GPG Key \u7684\u6587\u6863\u63cf\u8ff0\u5f88\u8be6\u7ec6\uff0c\u6211\u4eec\u5c06\u5176\u5217\u5728\u8fd9\u91cc\uff1a</p> <ul> <li>\u751f\u6210 GPG Key<ul> <li>\u4fee\u6539 GPG Key \u4fe1\u606f</li> </ul> </li> <li>\u8bbe\u7f6e Git \u4f7f\u7528 GPG Sign</li> <li>\u5728 GitHub \u4e0a\u5173\u8054 GPG Key</li> </ul>"},{"location":"dev/git/#github-issue","title":"Issue","text":"<p>\u4e0b\u9762\u5173\u4e8e Markdown \u7684\u7279\u6027\u5e76\u4e0d\u9650\u4e8e Issue\uff0c\u4e5f\u9002\u7528\u4e8e Pull Request \u7b49\u3002</p>"},{"location":"dev/git/#github-link","title":"GitHub \u94fe\u63a5","text":"<p>\u6211\u4eec\u4ee5 ustclug/mirrorrequest#213 \u4e3a\u4f8b\uff1a</p> <ul> <li>\u5728 Issue \u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>#</code> \u6765\u5f15\u7528\u5176\u4ed6 Issue / PR\uff0c\u4f8b\u5982 <code>#133</code></li> <li> <p>\u53ef\u4ee5\u901a\u8fc7 <code>user/repo#issue_number</code> \u7684\u65b9\u5f0f\u5f15\u7528\u5176\u4ed6\u4ed3\u5e93\u7684 Issue / PR\uff0c\u4f8b\u5982 <code>tuna/issues#341</code></p> <ul> <li> <p>\u5f53\u4e00\u4e2a PR \u5305\u542b\u5982\u4e0b\u5173\u952e\u5b57\uff0c\u5e76\u4e14\u6309\u7167\u4e0a\u8ff0\u65b9\u6cd5\u8fde\u63a5\u5230\u4e00\u4e2a Issue \u65f6\uff0c\u5408\u5e76\u8fd9\u4e2a PR \u4f1a\u5173\u95ed\u5bf9\u5e94\u7684 issue\uff1a</p> <pre><code>close(s,d) #123\nfix(es, ed) #123\nresolve(s, d) #123\n</code></pre> </li> </ul> </li> <li> <p>\u53ef\u4ee5\u901a\u8fc7 GitHub Web \u4e0a Copy permalink \u7684\u65b9\u5f0f\u83b7\u53d6\u4ee3\u7801\u7684\u94fe\u63a5\uff0c\u4f8b\u5982\u6253\u5f00 ustclug/mirrorrequest/README.md \u540e\uff0c\u53ef\u4ee5\u9009\u62e9\u67d0\u4e00\u884c\uff0c\u70b9\u51fb\u5de6\u4fa7\u7684\u83dc\u5355\uff0c\u9009\u62e9 Copy permalink, \u5373\u53ef\u83b7\u5f97\u8bf8\u5982 https://github.com/ustclug/mirrorrequest/blob/f23dd1f1cbe81f01e4f878ac11ee064b6c7d70ec/README.md?plain=1#L1 \u8fd9\u6837\u7684\u94fe\u63a5\u3002</p> <ul> <li>\u8fd9\u6837\u7684\u94fe\u63a5\u53ef\u4ee5\u5728 Issue \u4e2d\u76f4\u63a5\u7c98\u8d34\uff0c\u4f1a\u88ab\u4ee5\u4ee3\u7801\u6846\u7684\u5f62\u5f0f\u6e32\u67d3\u5230 Issue \u4e2d\uff0c\u65b9\u4fbf\u5176\u4ed6\u4eba\u8fc5\u901f\u4e86\u89e3\u95ee\u9898\u3002</li> <li>\u70b9\u51fb\u540e\u4e5f\u53ef\u4ee5\u76f4\u63a5\u590d\u5236\u5730\u5740\u680f\u4e2d\u7684 URL\uff0c\u8fd9\u6837\u7684\u94fe\u63a5\u603b\u662f\u6307\u5411\u67d0\u4e2a branch \u6216\u8005 tag \u7684\uff0c\u800c\u4e0d\u662f\u7279\u5b9a commit\uff0c\u4f46\u8fd9\u6837\u7684\u4f5c\u6cd5\u53ef\u80fd\u4f1a\u5bfc\u81f4\u94fe\u63a5\u5931\u6548\u3002</li> </ul> </li> </ul>"},{"location":"dev/git/#github-gfm","title":"GitHub Flavor Markdown","text":"<p>\u6b63\u5982\u5176\u4ed6\u7f16\u8f91\u5668\u5bf9 Markdown \u7684\u652f\u6301\u4e00\u6837\uff0cGitHub \u652f\u6301\u4e00\u4e2a Markdown \u65b9\u8a00\uff08\u8d85\u96c6\uff09\u7684\u5199\u6cd5\uff0c\u79f0\u4e3a GitHub Flavor Markdown\u3002</p> <p>\u6211\u4eec\u5728\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e9b\u4f60\u53ef\u80fd\u611f\u5174\u8da3\u7684 feature\uff1a</p> <ul> <li> <p>Mermaid \u5173\u7cfb\u56fe</p> <p>Mermaid \u662f\u4e00\u79cd\u7b80\u5355\u4e14\u5f3a\u5927\u7684\u5173\u7cfb\u56fe/\u6d41\u7a0b\u56fe\u8bed\u6cd5\uff0c\u4f8b\u5982\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u5173\u7cfb\u56fe\uff1a</p> <pre><code>```mermaid\ngraph LR;\n    A--&gt;B;\n    A--&gt;C;\n    B--&gt;D;\n    C--&gt;D;\n```\n</code></pre> <pre><code>graph LR;\n    A--&gt;B;\n    A--&gt;C;\n    B--&gt;D;\n    C--&gt;D;</code></pre> </li> <li> <p>MathJax \u652f\u6301</p> <p>GitHub \u901a\u8fc7 MathJax \u652f\u6301 LaTeX \u516c\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>$ \\frac 12 $</code> \u7684\u5f62\u5f0f\u521b\u5efa\u884c\u5185\u516c\u5f0f\uff0c <code>$$ \\frac 12 $$</code> \u7684\u5f62\u5f0f\u521b\u5efa\u5757\u7ea7\u516c\u5f0f\u3002</p> </li> <li> <p>\u8fdb\u5ea6\u8ddf\u8e2a</p> <p>\u5728 Issue \u6b63\u6587\u4e2d\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\u5217\u8868\uff0c\u4f8b\u5982\uff1a</p> <pre><code>- [x] Task 1 #123\n- [ ] Task 2\n</code></pre> <p>\u6b64\u65f6\u53ef\u4ee5\u5c06\u8fd9\u4e2a Issue \u8f6c\u5316\u4e3a\u4e00\u4e2a\u4efb\u52a1\u5217\u8868\uff0c\u65b9\u4fbf\u8ffd\u8e2a\u4efb\u52a1\u7684\u8fdb\u5ea6\uff0c\u540c\u65f6 <code>#123</code> \u4f1a\u88ab\u6807\u8bb0\u4e3a <code>Tracked by #xxx</code>\u3002</p> </li> </ul>"},{"location":"dev/git/#github-issue-template","title":"Issue \u6a21\u677f","text":"<p>\u5bf9\u4e8e\u5927\u578b\u9879\u76ee\uff0c\u4f7f\u7528 Issue template \u53ef\u4ee5\u4f7f\u5f97 Issue \u66f4\u52a0\u89c4\u8303\u5316\uff0c\u4f8b\u5982\uff0c\u53ef\u4ee5\u5728 <code>.github/ISSUE_TEMPLATE/bug_report.yml</code> \u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>name: Bug Report\nabout: Create a report to help us improve\nlabels:\n    - bug\nbody:\n    - type: textarea\n      id: bug-description\n      attributes:\n        label: Describe the bug\n        description: A clear and concise description of what the bug is.\n        placeholder: I'm always frustrated when...\n      validations:\n        required: true\n</code></pre> <p>\u53ef\u4ee5\u53c2\u8003 ustclug/mirrorrequest/.../01-mirror-request.yml, GitHub \u6587\u6863.</p>"},{"location":"dev/git/#github-pr","title":"Pull Request","text":"<p>\u5bf9\u4e8e Maintainer \u6765\u8bf4\uff0cPull Request \u66f4\u50cf\u662f Merge Request, \u4ed6\u4eec\u4f1a\u68c0\u67e5\u4ee3\u7801\u3001\u6d4b\u8bd5\u4ee3\u7801\u3001review \u4ee3\u7801\uff0c\u7136\u540e\u5c06\u4ee3\u7801\u5408\u5e76\u5230\u4e3b\u5206\u652f\u4e2d\u3002</p> <p>GitHub \u5728 \u8fd9\u91cc \u4ecb\u7ecd\u4e86\u5408\u5e76 PR \u7684\u65b9\u5f0f\uff0c\u7b80\u5355\u6765\u8bf4\u8ddf\u672c\u5730 merge / rebase \u6ca1\u6709\u592a\u5927\u533a\u522b\u3002</p> <ul> <li>PR \u4e2d\u4ec5\u6709\u4e00\u4e2a commit \u65f6\uff0c\u63a8\u8350\u4f7f\u7528 Rebase \u5408\u5e76 PR</li> <li>\u5f53 PR \u4e2d\u5305\u542b\u591a\u6b21 commit\uff0c\u4f46\u5b9e\u9645\u4e0a\u5e94\u5f53\u5408\u5e76\u4e3a\u4e00\u4e2a\u65f6\uff08\u4f8b\u5982\u7ecf\u8fc7 Review \u540e\uff09\uff0c\u63a8\u8350\u4f7f\u7528 Squash \u5408\u5e76 PR</li> <li>\u591a\u6b21 commit \u6765\u63d0\u4ea4\u65b0 feature \u65f6\uff0c\u63a8\u8350\u4f7f\u7528 Merge \u5408\u5e76 PR</li> </ul>"},{"location":"dev/git/#github-actions","title":"GitHub Actions","text":"<p>GitHub Actions \u662f GitHub \u63d0\u4f9b\u7684 CI/CD \u670d\u52a1\uff0c\u53ef\u4ee5\u7528\u4e8e\u81ea\u52a8\u5316\u6784\u5efa\u3001\u6d4b\u8bd5\u3001\u90e8\u7f72\u7b49\u3002</p> <p>GitHub Actions Pricing</p> <p>\u5bf9\u4e8e Public \u4ed3\u5e93\uff0cGitHub \u63d0\u4f9b\u4e86\u514d\u8d39\u7684\u670d\u52a1\uff0c\u5bf9\u4e8e Private \u4ed3\u5e93\uff0cGitHub \u63d0\u4f9b\u4e86 2000 \u5206\u949f\u7684\u514d\u8d39\u670d\u52a1\u3002</p> <p>\u5173\u4e8e\u8ba1\u8d39\u95ee\u9898\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\u3002</p> <p>\u5bf9\u4e8e GitHub Actions \u7684\u5199\u6cd5\uff0c\u53ea\u9700\u8981\u5173\u5fc3\u5982\u4e0b\u51e0\u4ef6\u4e8b\u60c5\uff1a</p> <ul> <li>\u4f55\u65f6\u5e94\u5f53\u89e6\u53d1 Action\uff1a\u4f8b\u5982 <code>on: push, pull_request</code></li> <li>\u5982\u4f55\u5728 GitHub Actions \u4e0a\u642d\u5efa\u73af\u5883\uff08\u4f8b\u5982\u5b89\u88c5\u4f9d\u8d56\u3001\u914d\u7f6e\u73af\u5883\u53d8\u91cf\u7b49\uff09</li> <li>\u4ea7\u7269\u7684\u5b58\u653e\u4f4d\u7f6e\uff1a\u4f8b\u5982 <code>artifacts</code>\u3001<code>release</code></li> </ul> <p>\u5982\u679c\u6d89\u53ca\u5230 Secret Key\uff0c\u8fd8\u5e94\u5f53\u6ce8\u610f\u5b89\u5168\u95ee\u9898\uff08\u9650\u5236\u89e6\u53d1\u6761\u4ef6\u3001\u4ea7\u7269\u7b49\uff09\u3002</p> <p>GitHub \u5728 \u8fd9\u91cc \u63d0\u4f9b\u4e86\u8be6\u7ec6\u7684\u6587\u6863\u3002</p>"},{"location":"dev/git/#ci-cd","title":"Other CI/CD systems","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u4e9b\u5176\u4ed6\u5e38\u7528\u7684 CI/CD \u63d0\u4f9b\u5546\uff0c\u5b83\u4eec\u63d0\u4f9b\u4e86\u7c7b\u4f3c\u7684\u670d\u52a1\uff1a</p> <ul> <li>Travis CI</li> <li>Circle CI</li> <li>GitLab CI</li> <li>Jenkins</li> <li>Azure Pipelines</li> </ul> <p>\u8003\u8651\u5230 GitHub Actions \u7684\u514d\u8d39\u989d\u5ea6\uff0c\u4ee5\u53ca\u4e0e GitHub \u7684\u65e0\u7f1d\u96c6\u6210\u7b49\uff0c\u5df2\u7ecf\u8db3\u591f\u6ee1\u8db3\u5927\u591a\u6570\u9879\u76ee\u7684\u9700\u6c42\uff0c\u56e0\u6b64\u6211\u4eec\u5728\u8fd9\u91cc\u4e0d\u518d\u8be6\u7ec6\u4ecb\u7ecd\u5176\u4ed6 CI/CD \u7cfb\u7edf\u3002</p>"},{"location":"dev/ssh/","title":"SSH \u4f7f\u7528\u6280\u5de7","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u5c3d\u7ba1 SSH \u662f\u4e00\u79cd\u5f00\u653e\u534f\u8bae\uff0c\u5b83\u7684\u4e3b\u6d41\u5b9e\u73b0 OpenSSH \u5177\u6709\u6700\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u56e0\u6b64\u672c\u6559\u7a0b\u53ea\u4ecb\u7ecd OpenSSH \u7684\u4f7f\u7528\u3002</p>"},{"location":"dev/ssh/#ssh-config","title":"\u5ba2\u6237\u7aef\u914d\u7f6e","text":"<p>SSH \u5ba2\u6237\u7aef\u4f1a\u6309\u987a\u5e8f\u5904\u7406\u4ee5\u4e0b\u914d\u7f6e\uff0c\u5148\u51fa\u73b0\u7684\u914d\u7f6e\u4f18\u5148\u7ea7\u66f4\u9ad8\uff1a</p> <ul> <li>\u547d\u4ee4\u884c\u53c2\u6570</li> <li><code>~/.ssh/config</code></li> <li><code>/etc/ssh/ssh_config</code></li> </ul> <p>OpenSSH \u7684\u6240\u6709\u914d\u7f6e\u9879\u90fd\u53ef\u4ee5\u5728 ssh_config(5) \u4e2d\u627e\u5230\uff0c\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u7528\u7684\u914d\u7f6e\u3002</p> <p>\u5bf9\u4e8e\u7ecf\u5e38\u767b\u5f55\u7684\u4e3b\u673a\uff0c\u53ef\u4ee5\u5728 <code>~/.ssh/config</code> \u4e2d\u914d\u7f6e\u4e3b\u673a\u522b\u540d\u3001\u7528\u6237\u540d\u3001\u7aef\u53e3\u7b49\u4fe1\u606f\uff0c\u4ee5\u7b80\u5316\u767b\u5f55\u547d\u4ee4\u3002</p> <pre><code>Host example\n  Hostname example.com\n  User sshuser\n  Port 22\n</code></pre> <p>\u6ce8\u610f SSH config \u6ca1\u6709\u63d0\u4f9b\u5bc6\u7801\u914d\u7f6e\uff0c\u56e0\u4e3a\u8fd9\u662f\u4e0d\u5b89\u5168\u7684\uff0c\u8bf7\u4f7f\u7528\u5bc6\u94a5\u767b\u5f55\u3002</p>"},{"location":"dev/ssh/#public-key-authentication","title":"\u516c\u94a5\u8ba4\u8bc1","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cSSH \u4f1a\u5bfb\u627e <code>~/.ssh/id_*</code> \u4f5c\u4e3a\u79c1\u94a5\uff0c\u5176\u4e2d <code>*</code> \u90e8\u5206\u53ef\u4ee5\u662f <code>rsa</code>\u3001<code>dsa</code>\u3001<code>ecdsa</code>\u3001<code>ed25519</code> \u7b49\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>-i</code> \u53c2\u6570\u6307\u5b9a\u79c1\u94a5\u6587\u4ef6\u3002\u79c1\u94a5\u7684\u6587\u4ef6\u540d\u52a0\u4e0a <code>.pub</code> \u540e\u7f00\u5c31\u662f\u516c\u94a5\u6587\u4ef6\uff0c\u6682\u65f6\u6ca1\u6709\u65b9\u6cd5\u6307\u5b9a\u516c\u94a5\u6587\u4ef6\u7684\u8def\u5f84\u3002\u5982\u679c\u8981\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u79c1\u94a5\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>IdentityFile</code> \u9009\u9879\uff0c\u4f8b\u5982\uff1a</p> <pre><code>Host example\n  IdentityFile ~/.ssh/id_rsa\n  #CertificateFile ~/.ssh/id_rsa-cert.pub\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u9664\u975e\u4e3a\u4e86\u517c\u5bb9\u4e00\u4e9b\u975e\u5e38\u53e4\u8001\uff08\u5982 10 \u5e74\u524d\u7684\uff09\u6216\u975e\u5e38\u7b80\u5355\u7684\uff08\u5982\u5d4c\u5165\u5f0f\uff09\u7cfb\u7edf\u800c\u4e0d\u5f97\u4e0d\u4f7f\u7528\u8f83\u77ed\u7684 RSA \u5bc6\u94a5\u5bf9\u7684\u65f6\u5019\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528 Ed25519 \u5bc6\u94a5\u5bf9\uff0c\u6216\u8005 ECDSA \u5bc6\u94a5\u5bf9\u3002\u8fd9\u4e24\u79cd\u57fa\u4e8e\u692d\u5706\u66f2\u7ebf\u7684\u5bc6\u7801\u5b66\u7b97\u6cd5\u6bd4 RSA \u66f4\u5b89\u5168\uff0c\u800c\u4e14\u6027\u80fd\u4e5f\u66f4\u597d\u3002\u5982\u679c\u4e0d\u5f97\u4e0d\u4f7f\u7528 RSA \u7684\u8bdd\uff0c\u8bf7\u5c3d\u53ef\u80fd\u4f7f\u7528 3072 \u4f4d\u6216\u66f4\u957f\u7684\u5bc6\u94a5\u957f\u5ea6\u3002\u5bc6\u94a5\u957f\u5ea6\u53ef\u4ee5\u5728\u4f7f\u7528 <code>ssh-keygen</code> \u751f\u6210\u5bc6\u94a5\u5bf9\u65f6\u6307\u5b9a\uff08<code>-b</code>\uff09\uff0c\u5176\u4e2d\u4e0d\u540c\u7b97\u6cd5\u652f\u6301\u4e0e\u63a8\u8350\u7684\u957f\u5ea6\u4e5f\u662f\u4e0d\u540c\u7684\uff1a</p> \u7b97\u6cd5 \u652f\u6301\u957f\u5ea6 \u63a8\u8350\u957f\u5ea6 \u8bf4\u660e RSA 1024-4096 3072 \u6216\u4ee5\u4e0a \u66fe\u7ecf\u7684\u63a8\u8350\u957f\u5ea6\u662f 2048 \u4f4d\uff0c\u4f46 2020 \u5e74\u4ee5\u540e\u8ba4\u4e3a\u8fd9\u4e2a\u957f\u5ea6\u5df2\u4e0d\u591f\u5b89\u5168 DSA\uff08\u4e0d\u63a8\u8350\uff09 1024 1024 \u7531\u4e8e\u5b89\u5168\u6027\u95ee\u9898\uff0cOpenSSH 7.0 \u4ee5\u540e\u4e0d\u518d\u9ed8\u8ba4\u652f\u6301 DSA \u5bc6\u94a5 ECDSA 256 / 384 / 521 256 / 384 / 521 \u7531\u4e8e\u692d\u5706\u66f2\u7ebf\u53c2\u6570\u9009\u62e9\u7684\u7279\u6b8a\u6027\uff0c\u53ea\u6709\u8fd9\u4e09\u79cd\u957f\u5ea6\u53ef\u9009\u3002\u6ce8\u610f\u6700\u540e\u4e00\u4e2a\u9009\u9879\u662f 521\uff0c\u4e0d\u662f 512 Ed25519 - - Ed25519 \u662f\u57fa\u4e8e Edwards \u66f2\u7ebf\u7684\u7b97\u6cd5\uff0c\u6ca1\u6709\u201c\u957f\u5ea6\u201d\u8fd9\u79cd\u53c2\u6570"},{"location":"dev/ssh/#port-forwarding","title":"\u7aef\u53e3\u8f6c\u53d1","text":"<p>SSH \u652f\u6301\u4e09\u79cd\u7aef\u53e3\u8f6c\u53d1\uff1a</p> <ul> <li> <p>\u672c\u5730\u7aef\u53e3\u8f6c\u53d1\uff08Local port forwarding\uff09\uff1a\u5728\u672c\u5730\u4e0a\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u8fdc\u7a0b\u4e3b\u673a\u7684\u6307\u5b9a\u7aef\u53e3\u3002\u5373\u5c06\u8fdc\u7a0b\u4e3b\u673a\u4e0a\u67d0\u4e2a\u670d\u52a1\u7684\u7aef\u53e3\u8f6c\u53d1\u5230\u672c\u5730\u3002\u4f8b\u5982\uff1a</p> <pre><code>ssh -L 8080:localhost:80 example\n</code></pre> <p>\u672c\u5730\u7aef\u53e3\u8f6c\u53d1\u9ed8\u8ba4\u76d1\u542c\u5728 localhost\u3002\u5982\u679c\u8981\u76d1\u542c\u5176\u4ed6\u5730\u5740\uff0c\u53ef\u4ee5\u6307\u5b9a\u9700\u8981\u76d1\u542c\u7684\u5730\u5740\uff0c\u4f8b\u5982\uff1a</p> <pre><code>ssh -L 0.0.0.0:8080:localhost:80 example\n</code></pre> <p>\u867d\u7136 SSH \u5ba2\u6237\u7aef\u4e5f\u6709\u4e00\u4e2a <code>GatewayPorts</code> \u9009\u9879\uff0c\u4f46\u5b83\u53ea\u5f71\u54cd\u6ca1\u6709\u6307\u5b9a\u76d1\u542c\u5730\u5740\u7684\u8bed\u6cd5\u6a21\u5f0f\uff08\u5373\u4e09\u6bb5\u5f0f <code>localport:remotehost:remoteport</code>\uff09\u3002\u6307\u5b9a\u56db\u6bb5\u5f0f\u8bed\u6cd5\u540e\uff0c<code>GatewayPorts</code> \u9009\u9879\u4e0d\u518d\u8d77\u4f5c\u7528\u3002</p> </li> <li> <p>\u8fdc\u7a0b\u7aef\u53e3\u8f6c\u53d1\uff08Remote port forwarding\uff09\uff1a\u5728\u8fdc\u7a0b\u4e3b\u673a\u4e0a\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u672c\u5730\u7684\u6307\u5b9a\u7aef\u53e3\u3002\u5373\u5c06\u672c\u5730\u67d0\u4e2a\u670d\u52a1\u7684\u7aef\u53e3\u8f6c\u53d1\u5230\u8fdc\u7a0b\u4e3b\u673a\u4e0a\u3002\u4f8b\u5982\uff1a</p> <pre><code>ssh -R 8080:localhost:80 example\n</code></pre> <p>\u4e0a\u9762\u547d\u4ee4\u8868\u793a\u5728\u8fdc\u7a0b\u4e3b\u673a example \u4e0a\u76d1\u542c 8080 \u7aef\u53e3\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u672c\u5730\u7684 80 \u7aef\u53e3\u3002</p> <p>\u6ce8\u610f\u8fdc\u7a0b\u7aef\u53e3\u8f6c\u53d1\u9ed8\u8ba4\u53ea\u80fd\u76d1\u542c localhost\u3002\u5982\u679c\u8981\u76d1\u542c\u5176\u4ed6\u5730\u5740\uff0c\u9700\u8981\u5728\u8fdc\u7a0b\u4e3b\u673a\u7684 <code>sshd_config</code> \u4e2d\u8bbe\u7f6e <code>GatewayPorts yes</code>\u3002\u4e0e\u53e6\u5916\u4e24\u79cd\u7aef\u53e3\u8f6c\u53d1\u4e0d\u540c\uff0c\u5ba2\u6237\u7aef\u65e0\u6cd5\u8986\u76d6\u670d\u52a1\u7aef\u7684 <code>GatewayPorts</code> \u8bbe\u5b9a\u3002</p> </li> <li> <p>\u52a8\u6001\u7aef\u53e3\u8f6c\u53d1\uff08Dynamic port forwarding\uff09\uff1a\u5728\u672c\u5730\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\u7528\u4f5c SOCKS5 \u4ee3\u7406\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u8fdc\u7a0b\u4e3b\u673a\u3002\u76f8\u5f53\u4e8e\u5229\u7528\u4e86\u8fdc\u7a0b\u4e3b\u673a\u4f5c\u4e3a\u4ee3\u7406\u3002\u4f8b\u5982\uff1a</p> <pre><code>ssh -D 1080 example\n</code></pre> <p>\u7531\u4e8e SOCKS \u4ee3\u7406\u662f\u4e00\u4e2a\u901a\u7528\u7684\u4ee3\u7406\u534f\u8bae\uff0c\u56e0\u6b64\u53ef\u4ee5\u7528\u4e8e\u4efb\u4f55 TCP \u8fde\u63a5\uff0c\u4e0d\u4ec5\u4ec5\u662f HTTP\u3002</p> <p>\u4e0e LocalForward \u7c7b\u4f3c\uff0cDynamicForward \u4e5f\u53ef\u4ee5\u6307\u5b9a\u76d1\u542c\u5730\u5740\uff1a</p> <pre><code>ssh -D 0.0.0.0:1080 example\n</code></pre> <p>\u540c\u6837\u5730\uff0c<code>GatewayPorts</code> \u53ea\u5f71\u54cd\u6ca1\u6709\u6307\u5b9a\u76d1\u542c\u5730\u5740\u7684\u8bed\u6cd5\u6a21\u5f0f\uff08\u5373\u53ea\u7ed9\u51fa\u4e86\u4e00\u4e2a\u7aef\u53e3\uff09\u3002\u6307\u5b9a\u76d1\u542c\u5730\u5740\u540e\uff0c<code>GatewayPorts</code> \u9009\u9879\u4e0d\u518d\u8d77\u4f5c\u7528\u3002</p> </li> </ul> <p>\u4ee5\u4e0a\u4e09\u79cd\u7aef\u53e3\u8f6c\u53d1\u90fd\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\uff0c\u4f8b\u5982\uff1a</p> <pre><code>Host example\n  LocalForward 8080 localhost:80\n  LocalForward 8081 localhost:8081\n  RemoteForward 8080 localhost:80\n  RemoteForward 8081 localhost:8081\n  DynamicForward 1080\n  DynamicForward 1081\n</code></pre> <p><code>-L</code>\u3001<code>-R</code>\u3001<code>-D</code> \u548c\u914d\u7f6e\u6587\u4ef6\u4e2d\u5bf9\u5e94\u7684\u9009\u9879\u90fd\u53ef\u4ee5\u591a\u6b21\u51fa\u73b0\uff0c\u6307\u5b9a\u591a\u6761\u8f6c\u53d1\u89c4\u5219\uff0c\u5b83\u4eec\u4e92\u76f8\u72ec\u7acb\u3001\u4e0d\u4f1a\u8986\u76d6\uff0c\u56e0\u6b64\u5982\u679c\u91cd\u590d\u6307\u5b9a\u4e86\u540c\u4e00\u4e2a\u7aef\u53e3\uff0c\u5c31\u4f1a\u51fa\u73b0\u51b2\u7a81\u3002</p>"},{"location":"dev/ssh/#jump-host","title":"\u8df3\u677f","text":"<p>SSH \u652f\u6301\u901a\u8fc7\u8df3\u677f\u673a\u8fde\u63a5\u76ee\u6807\u4e3b\u673a\uff0c\u5373\u5148 SSH \u767b\u5f55 jump-host\uff0c\u518d\u4ece jump-host \u767b\u5f55\u76ee\u6807\u4e3b\u673a\u3002\u4e00\u4e9b\u53d7\u9650\u7684\u7f51\u7edc\u73af\u5883\u5e38\u5e38\u91c7\u7528\u8fd9\u79cd\u65b9\u6848\uff0c\u4f8b\u5982\u4e00\u4e2a\u96c6\u7fa4\u5185\u53ea\u6709\u8df3\u677f\u673a\u66b4\u9732\u5728\u516c\u7f51\u4e0a\uff0c\u800c\u5176\u4ed6\u4e3b\u673a\u90fd\u5728\u88ab\u9694\u79bb\u7684\u5185\u7f51\u4e2d\uff0c\u53ea\u80fd\u901a\u8fc7\u8df3\u677f\u673a\u8bbf\u95ee\u3002</p> <p><code>ssh</code> \u547d\u4ee4\u7684 <code>-J</code> \u9009\u9879\u53ef\u4ee5\u6307\u5b9a\u8df3\u677f\u673a\uff0c\u4f8b\u5982\uff1a</p> <pre><code>ssh -J user@jumphost.example.com user@realhost.example.com\n</code></pre> <p>\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u8bed\u53e5\u662f <code>ProxyJump user@jumphost.example.com</code>\u3002</p> <p>\u5982\u679c\u8981\u7ed9\u8df3\u677f\u673a\u8bbe\u7f6e\u66f4\u591a\u53c2\u6570\uff0c\u5982\u7aef\u53e3\u7b49\uff0c\u5219\u5fc5\u987b\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>Host jumphost\n  HostName jumphost.example.com\n  User jumphostuser\n  Port 2333\n\nHost realhost\n  HostName realhost.example.com\n  User realhostuser\n  ProxyJump jumphost\n</code></pre>"},{"location":"dev/ssh/#_1","title":"\u6587\u4ef6\u4f20\u8f93","text":"<p>SFTP\uff08Secure File Transfer Protocol\uff09\u548c SCP\uff08Secure Copy Protocol\uff09\u90fd\u662f\u57fa\u4e8e SSH \u7684\u53e6\u4e00\u79cd\u6587\u4ef6\u4f20\u8f93\u5de5\u5177\uff0c\u5b83\u7528\u4e8e\u5728\u672c\u5730\u548c\u8fdc\u7a0b\u7cfb\u7edf\u4e4b\u95f4\u5b89\u5168\u5730\u590d\u5236\u6587\u4ef6\u3002SCP \u529f\u80fd\u76f8\u5bf9\u7b80\u5355\uff0c\u4e3b\u8981\u63d0\u4f9b\u6587\u4ef6\u7684\u590d\u5236\u529f\u80fd\u3002SFTP \u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u534f\u8bae\uff0c\u5efa\u7acb\u5728 SSH \u4e4b\u4e0a\uff0c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4ea4\u4e92\u5f0f\u6587\u4ef6\u4f20\u8f93\u4f1a\u8bdd\u548c\u66f4\u4e30\u5bcc\u7684\u6587\u4ef6\u64cd\u4f5c\u529f\u80fd\uff0c\u5305\u62ec\u5bf9\u6587\u4ef6\u7684\u6d4f\u89c8\u3001\u7f16\u8f91\u548c\u7ba1\u7406\u3002</p>"},{"location":"dev/ssh/#scp","title":"SCP","text":"<p>SCP \u662f\u57fa\u4e8e SSH (Secure Shell) \u534f\u8bae\u7684\u6587\u4ef6\u4f20\u8f93\u5de5\u5177\uff0c\u5b83\u5141\u8bb8\u7528\u6237\u5728\u672c\u5730\u548c\u8fdc\u7a0b\u4e3b\u673a\u4e4b\u95f4\u5b89\u5168\u5730\u590d\u5236\u6587\u4ef6\u3002SCP \u4f7f\u7528 SSH \u8fdb\u884c\u6570\u636e\u4f20\u8f93\uff0c\u63d0\u4f9b\u540c SSH \u76f8\u540c\u7ea7\u522b\u7684\u5b89\u5168\u6027\uff0c\u5305\u62ec\u6570\u636e\u52a0\u5bc6\u548c\u7528\u6237\u8ba4\u8bc1\u3002</p> <p>SCP \u547d\u4ee4\u7684\u57fa\u672c\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>scp [\u9009\u9879] [\u6e90\u6587\u4ef6] [\u76ee\u6807\u6587\u4ef6]\n</code></pre> <p>\u5176\u4e2d\uff0c\u6e90\u6587\u4ef6\u6216\u76ee\u6807\u6587\u4ef6\u7684\u683c\u5f0f\u53ef\u4ee5\u662f\u672c\u5730\u8def\u5f84\uff0c\u6216\u8005\u8fdc\u7a0b\u8def\u5f84\uff0c\u5982 <code>\u7528\u6237\u540d@\u4e3b\u673a\u540d:\u6587\u4ef6\u8def\u5f84</code>\u3002</p>"},{"location":"dev/ssh/#_2","title":"\u6587\u4ef6\u590d\u5236","text":"<p>\u4ece\u672c\u5730\u590d\u5236\u5230\u8fdc\u7a0b\u670d\u52a1\u5668</p> <pre><code>scp /path/to/local/file username@remotehost:/path/to/remote/directory\n</code></pre> <p>\u6216\u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u590d\u5236\u5230\u672c\u5730</p> <pre><code>scp username@remotehost:/path/to/remote/file /path/to/local/directory\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u63d0\u793a\u60a8\u8f93\u5165\u8fdc\u7a0b\u4e3b\u673a\u4e0a\u7528\u6237\u7684\u5bc6\u7801\uff0c\u9664\u975e\u60a8\u5df2\u7ecf\u8bbe\u7f6e\u4e86 SSH \u5bc6\u94a5\u8ba4\u8bc1\u3002</p> <p>Tip</p> <p>\u4f60\u53ef\u4ee5\u4e00\u6b21\u6027\u4f20\u8f93\u591a\u4e2a\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u5c06\u5b83\u4eec\u4f5c\u4e3a\u6e90\u8def\u5f84\u7684\u53c2\u6570\u3002 \u4f8b\u5982\uff1a<code>scp file1.txt file2.txt username@remotehost:/path/to/remote/directory</code></p>"},{"location":"dev/ssh/#_3","title":"\u590d\u5236\u76ee\u5f55","text":"<p>\u5982\u679c\u9700\u8981\u590d\u5236\u6574\u4e2a\u76ee\u5f55\uff0c\u9700\u8981\u4f7f\u7528 <code>-r</code> \u9009\u9879\uff0c\u8fd9\u8868\u793a\u9012\u5f52\u590d\u5236\uff1a</p> <pre><code>scp -r /path/to/local/directory username@remotehost:/path/to/remote/directory\n</code></pre>"},{"location":"dev/ssh/#_4","title":"\u4f7f\u7528\u975e\u6807\u51c6\u7aef\u53e3","text":"<p>\u5982\u679c\u8fdc\u7a0b\u4e3b\u673a\u7684 SSH \u670d\u52a1\u4e0d\u662f\u8fd0\u884c\u5728\u6807\u51c6\u7aef\u53e3\uff0822\uff09\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 <code>-P</code> \u9009\u9879\u6307\u5b9a\u7aef\u53e3\uff1a</p> <pre><code>scp -P 2222 /path/to/local/file username@remotehost:/path/to/remote/directory\n</code></pre>"},{"location":"dev/ssh/#_5","title":"\u9650\u5236\u5e26\u5bbd","text":"<p>\u4f7f\u7528 <code>-l</code> \u9009\u9879\u53ef\u4ee5\u9650\u5236 SCP \u4f7f\u7528\u7684\u5e26\u5bbd\uff0c\u5355\u4f4d\u662f <code>Kbit/s</code>\uff1a</p> <pre><code>scp -l 1024 /path/to/local/file username@remotehost:/path/to/remote/directory\n</code></pre>"},{"location":"dev/ssh/#_6","title":"\u4fdd\u7559\u6587\u4ef6\u5c5e\u6027","text":"<p>\u4f7f\u7528 <code>-p</code> \u9009\u9879\u53ef\u4ee5\u4fdd\u7559\u539f\u6587\u4ef6\u7684\u4fee\u6539\u65f6\u95f4\u548c\u8bbf\u95ee\u6743\u9650\uff1a</p> <pre><code>scp -p /path/to/local/file username@remotehost:/path/to/remote/directory\n</code></pre>"},{"location":"dev/ssh/#_7","title":"\u5f00\u542f\u538b\u7f29","text":"<p>\u4f7f\u7528 <code>-C</code> \u9009\u9879\u5f00\u542f\u538b\u7f29\uff0c\u53ef\u4ee5\u51cf\u5c11\u4f20\u8f93\u6570\u636e\u91cf\u5e76\u63d0\u5347\u4f20\u8f93\u901f\u5ea6\uff0c\u7279\u522b\u5bf9\u4e8e\u6587\u672c\u6587\u4ef6\u6548\u679c\u663e\u8457\u3002</p> <pre><code>scp -C /path/to/local/file username@remotehost:/path/to/remote/directory\n</code></pre>"},{"location":"dev/ssh/#sftp","title":"SFTP","text":"<p>SFTP \u662f\u4e00\u79cd\u5b89\u5168\u7684\u6587\u4ef6\u4f20\u8f93\u534f\u8bae\uff0c\u5b83\u5728 SSH \u7684\u57fa\u7840\u4e0a\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6269\u5c55\u7684\u529f\u80fd\u96c6\u5408\uff0c\u7528\u4e8e\u6587\u4ef6\u8bbf\u95ee\u3001\u6587\u4ef6\u4f20\u8f93\u548c\u6587\u4ef6\u7ba1\u7406\u3002\u4e0e SCP \u76f8\u6bd4\uff0cSFTP \u63d0\u4f9b\u4e86\u66f4\u4e30\u5bcc\u7684\u64cd\u4f5c\u6587\u4ef6\u548c\u76ee\u5f55\u7684\u529f\u80fd\uff0c\u4f8b\u5982\u5217\u51fa\u76ee\u5f55\u5185\u5bb9\u3001\u5220\u9664\u6587\u4ef6\u3001\u521b\u5efa\u548c\u5220\u9664\u76ee\u5f55\u7b49\u3002\u7531\u4e8e SFTP \u5728\u4f20\u8f93\u8fc7\u7a0b\u4e2d\u4f7f\u7528 SSH \u63d0\u4f9b\u7684\u52a0\u5bc6\u901a\u9053\uff0c\u56e0\u6b64\u5b83\u80fd\u591f\u4fdd\u8bc1\u6570\u636e\u7684\u5b89\u5168\u6027\u548c\u9690\u79c1\u6027\u3002</p>"},{"location":"dev/ssh/#sftp_1","title":"\u542f\u52a8 SFTP \u4f1a\u8bdd","text":"<p>\u8981\u8fde\u63a5\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>sftp username@remotehost\n</code></pre> <p>\u5982\u679c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 SSH \u670d\u52a1\u4f7f\u7528\u7684\u4e0d\u662f\u9ed8\u8ba4\u7aef\u53e3\uff0822\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>-P</code> \u9009\u9879\u6307\u5b9a\u7aef\u53e3\uff1a</p> <pre><code>sftp -P 2233 username@remotehost\n</code></pre>"},{"location":"dev/ssh/#_8","title":"\u6587\u4ef6\u548c\u76ee\u5f55\u64cd\u4f5c","text":"<ul> <li><code>ls</code>\uff1a\u5217\u51fa\u8fdc\u7a0b\u76ee\u5f55\u7684\u5185\u5bb9\u3002</li> <li><code>get remote-file [local-file]</code>\uff1a\u4e0b\u8f7d\u6587\u4ef6\u3002</li> <li><code>put local-file [remote-file]</code>\uff1a\u4e0a\u4f20\u6587\u4ef6\u3002</li> <li><code>mkdir directory-name</code>\uff1a\u521b\u5efa\u8fdc\u7a0b\u76ee\u5f55\u3002</li> <li><code>rmdir directory-name</code>\uff1a\u5220\u9664\u8fdc\u7a0b\u76ee\u5f55\u3002</li> <li><code>rm file-name</code>\uff1a\u5220\u9664\u8fdc\u7a0b\u6587\u4ef6\u3002</li> <li><code>chmod mode file-name</code>\uff1a\u6539\u53d8\u8fdc\u7a0b\u6587\u4ef6\u7684\u6743\u9650\u3002</li> <li><code>pwd</code>\uff1a\u663e\u793a\u5f53\u524d\u8fdc\u7a0b\u76ee\u5f55\u3002</li> <li><code>lpwd</code>\uff1a\u663e\u793a\u5f53\u524d\u672c\u5730\u76ee\u5f55\u3002</li> <li><code>cd directory-name</code>\uff1a\u6539\u53d8\u8fdc\u7a0b\u5de5\u4f5c\u76ee\u5f55\u3002</li> <li><code>lcd directory-name</code>\uff1a\u6539\u53d8\u672c\u5730\u5de5\u4f5c\u76ee\u5f55\u3002</li> </ul>"},{"location":"dev/ssh/#sftp_2","title":"\u9000\u51fa SFTP \u4f1a\u8bdd","text":"<p>\u8f93\u5165 <code>exit</code> \u6216 <code>bye</code> \u6765\u7ec8\u6b62 SFTP \u4f1a\u8bdd\u3002</p> <p>\u4f7f\u7528\u811a\u672c\u8fdb\u884c\u81ea\u52a8\u5316\u64cd\u4f5c</p> <p>\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u5305\u542bSFTP\u547d\u4ee4\u7684\u6279\u5904\u7406\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u8ba9SFTP\u4f1a\u8bdd\u81ea\u52a8\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6 <code>upload.txt</code>\uff0c\u5176\u4e2d\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <p><pre><code>put file1.txt\nput file2.jpg\nput file3.pdf\nquit\n</code></pre> \u7136\u540e\u4f7f\u7528\u547d\u4ee4 <code>sftp -b upload.txt username@remotehost</code> \u6765\u81ea\u52a8\u4e0a\u4f20\u6587\u4ef6\u3002</p>"},{"location":"dev/ssh/#connection-reuse","title":"\u9ad8\u7ea7\u529f\u80fd\uff1a\u8fde\u63a5\u590d\u7528","text":"<p>SSH \u534f\u8bae\u5141\u8bb8\u5728\u4e00\u6761\u8fde\u63a5\u5185\u8fd0\u884c\u591a\u4e2a channel\uff0c\u5176\u4e2d\u6bcf\u4e2a channel \u53ef\u4ee5\u662f\u4e00\u4e2a shell session\u3001\u7aef\u53e3\u8f6c\u53d1\u3001scp \u547d\u4ee4\u7b49\u3002OpenSSH \u652f\u6301\u8fde\u63a5\u590d\u7528\uff0c\u5373\u4e00\u4e2a SSH \u8fdb\u7a0b\u5728\u540e\u53f0\u4fdd\u6301\u8fde\u63a5\uff0c\u5176\u4ed6\u5ba2\u6237\u7aef\u5728\u8fde\u63a5\u540c\u4e00\u4e2a\u4e3b\u673a\u65f6\u53ef\u4ee5\u590d\u7528\u8fd9\u4e2a\u8fde\u63a5\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u63e1\u624b\u8ba4\u8bc1\u7b49\uff0c\u53ef\u4ee5\u663e\u8457\u51cf\u5c11\u8fde\u63a5\u65f6\u95f4\u3002\u8fd9\u5728\u9891\u7e41\u8fde\u63a5\u540c\u4e00\u4e2a\u4e3b\u673a\u65f6\u975e\u5e38\u6709\u7528\uff0c\u5c24\u5176\u662f\u5f53\u4e3b\u673a\u7684\u5ef6\u8fdf\u8f83\u5927\u3001\u5e38\u7528\u64cd\u4f5c\u6240\u9700\u7684 RTT \u8f83\u591a\u65f6\uff08\u4f8b\u5982\u4ece GitHub \u62c9\u53d6\u4ed3\u5e93\uff0c\u6216\u8005\u524d\u6587\u6240\u8ff0\u7684\u8df3\u677f\u673a\u4f7f\u7528\u65b9\u5f0f\uff09\u3002</p> <p>\u542f\u7528\u8fde\u63a5\u590d\u7528\u9700\u8981\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u540c\u65f6\u6307\u5b9a <code>ControlMaster</code>\u3001<code>ControlPath</code> \u548c <code>ControlPersist</code> \u4e09\u4e2a\u9009\u9879\uff08\u5b83\u4eec\u7684\u9ed8\u8ba4\u503c\u90fd\u662f\u7981\u7528\u6216\u8005\u5f88\u4e0d\u53cb\u597d\u7684\u503c\uff09\uff1a</p> <pre><code>Host *\n  ControlMaster auto\n  ControlPath /tmp/sshcontrol-%C\n  ControlPersist yes\n</code></pre> <p>\u5176\u4e2d <code>%C</code> \u662f <code>%l%h%p%r</code> \u7684 hash\uff0c\u56e0\u6b64\u8fde\u63a5\u4e0d\u540c\u4e3b\u673a\u7684 control socket \u4e0d\u4f1a\u51b2\u7a81\u3002\u4f46\u662f\uff0c\u5982\u679c\u4f60\u5c1d\u8bd5\u7528\u76f8\u540c\u7684\u7528\u6237\u540d\u548c\u4e0d\u540c\u7684\u516c\u94a5\u8fde\u63a5\u540c\u4e00\u4e2a\u76ee\u6807\uff08\u4f8b\u5982 <code>git@github.com</code>\uff09\uff0c\u7531\u4e8e\u6ca1\u6709\u65b0\u5efa\u8fde\u63a5\u7684\u8fc7\u7a0b\uff0c\u4f60\u6307\u5b9a\u7684\u516c\u94a5\u5e76\u4e0d\u4f1a\u751f\u6548\uff0c\u89e3\u51b3\u65b9\u6cd5\u662f\u518d\u5355\u72ec\u6307\u5b9a\u53e6\u4e00\u4e2a <code>ControlPath</code>\u3002</p>"},{"location":"dev/ssh/#sshd-config","title":"\u670d\u52a1\u7aef\u914d\u7f6e","text":"<p>\u670d\u52a1\u7aef\u7684\u914d\u7f6e\u4e0e\u5ba2\u6237\u7aef\u6709\u4e00\u4e9b\u4e0d\u540c\u70b9\uff1a</p> <ul> <li>sshd \u670d\u52a1\u7aef\u7a0b\u5e8f\u53ea\u6709\u5f88\u5c11\u91cf\u7684\u547d\u4ee4\u884c\u53c2\u6570\uff0c\u5404\u79cd\u914d\u7f6e\u90fd\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b8c\u6210\u3002\u7279\u522b\u6ce8\u610f\uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u4e0d\u5b58\u5728\uff0csshd \u4f1a\u62d2\u7edd\u542f\u52a8\u3002</li> <li>sshd \u4ec5\u6709\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6 <code>/etc/ssh/sshd_config</code>\uff0c\u5b83\u7684\u914d\u7f6e\u9879\u53ef\u4ee5\u5728 sshd_config(5) \u4e2d\u627e\u5230\u3002</li> </ul> <p>sshd \u63a5\u53d7 SIGHUP \u4fe1\u53f7\u4f5c\u4e3a\u91cd\u65b0\u8f7d\u5165\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\u3002<code>sshd -t</code> \u547d\u4ee4\u53ef\u4ee5\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\u662f\u5426\u6b63\u786e\uff0c\u8fd9\u4e5f\u662f\u5927\u591a\u6570\u53d1\u884c\u7248\u63d0\u4f9b\u7684 <code>ssh.service</code> \u4e2d\u6307\u5b9a\u7684 <code>ExecStartPre=</code> \u547d\u4ee4\u548c\u7b2c\u4e00\u6761 <code>ExecReload=</code> \u547d\u4ee4\uff0c\u5373\u5728\u5c1d\u8bd5\u542f\u52a8\u548c\u91cd\u65b0\u52a0\u8f7d\u670d\u52a1\u524d\u5148\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\u3002</p>"},{"location":"dev/ssh/#include","title":"\u62c6\u5206\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4ece OpenSSH 7.3p1 \u5f00\u59cb\uff0cssh_config \u548c sshd_config \u90fd\u652f\u6301 <code>Include</code> \u9009\u9879\uff0c\u53ef\u4ee5\u5728\u4e3b\u914d\u7f6e\u6587\u4ef6\u4e2d include \u5176\u4ed6\u6587\u4ef6\u3002\u4e0e C \u7684 <code>#include</code> \u6216 Nginx \u7684 <code>include</code> \u4e0d\u540c\uff0cSSH config \u91cc\u7684 <code>Include</code> \u4e0d\u7b49\u4ef7\u4e8e\u6587\u672c\u63d2\u5165\u66ff\u6362\uff0c\u5e76\u4e14 <code>Include</code> \u53ef\u4ee5\u51fa\u73b0\u5728 <code>Host</code> \u548c <code>Match</code> \u5757\u4e2d\u3002\u56e0\u6b64\u4e00\u4e2a\uff08\u4e0d\u592a\u5e38\u89c1\u7684\uff09\u5751\u662f\uff1a</p> \u9519\u8bef\u5199\u6cd5 <pre><code>Host example\n  HostName example.com\n  User user\n\nInclude ~/.ssh/global.conf\n</code></pre> <p>\u56e0\u4e3a SSH \u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u65f6\u662f\u4e0d\u4f1a\u770b\u7f29\u8fdb\u7684\uff0c\u56e0\u6b64\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 Include \u4ec5\u5bf9 <code>Host example</code> \u751f\u6548\u3002\u6b63\u786e\u7684\u5199\u6cd5\u662f\u5c06\u5176\u653e\u5728\u4e00\u4e2a <code>Match all</code> \u5757\uff08\u6216\u8005 <code>Host *</code>\uff09\u4e2d\uff1a</p> \u6b63\u786e\u5199\u6cd5 <pre><code>Host example\n  HostName example.com\n  User user\n\nMatch all\n  Include ~/.ssh/global.conf\n</code></pre> <p>\u66f4\u52a0\u63a8\u8350\u7684\u5199\u6cd5\u662f\u5c06 <code>Include</code> \u653e\u5728\u914d\u7f6e\u6587\u4ef6\u5f00\u5934\uff1a</p> <p>\u63a8\u8350\u5199\u6cd5</p> <pre><code>Include ~/.ssh/global.conf\n\nHost example\n  HostName example.com\n  User user\n</code></pre>"},{"location":"dev/ssh/#traps","title":"\u4e00\u4e9b\u5751\u70b9","text":"<p>\u5728 OpenSSH \u5185\u90e8\uff0c\u540c\u4e00\u4e2a\u201c\u4ee3\u53f7\u201d\u53ef\u80fd\u6307\u4ee3\u591a\u79cd\uff08\u6709\u5173\u8054\u4f46\uff09\u4e0d\u540c\u7684\u7ec6\u8282\u3002\u4f8b\u5982 <code>ssh-rsa</code> \u81f3\u5c11\u6709\u4ee5\u4e0b\u4e09\u79cd\u4e0d\u540c\u7684\u542b\u4e49\uff1a</p> <ul> <li>RSA \u5bc6\u94a5\u5bf9\u6216 RSA \u516c\u94a5\u7b97\u6cd5\uff08<code>id_rsa</code> \u548c <code>id_rsa.pub</code> \u6587\u4ef6\uff09</li> <li>\u57fa\u4e8e RSA / SHA-1 \u7684 SSH \u8bc1\u4e66\u7684\u7b7e\u540d\u7b97\u6cd5\uff08<code>CASignatureAlgorithms</code>\uff09</li> </ul> <p>\u8fd9\u79cd\u7b97\u6cd5\u5df2\u7ecf\u5728 OpenSSH 8.2 \u4e2d\u88ab\u6dd8\u6c70\uff0c\u800c OpenSSH 7.2 \u8d77\u5c31\u5df2\u7ecf\u652f\u6301\u66ff\u4ee3\u7b97\u6cd5 <code>rsa-sha2-256</code> \u548c <code>rsa-sha2-512</code>\uff08\u91c7\u7528 SHA-256 \u548c SHA-512 \u54c8\u5e0c\u7b97\u6cd5\uff09\uff0c\u867d\u7136\u76f4\u5230 OpenSSH 8.2\uff0c\u4f7f\u7528 RSA CA \u79c1\u94a5\u7b7e\u51fa\u6765\u7684\u8bc1\u4e66\u624d\u9ed8\u8ba4\u91c7\u7528 <code>rsa-sha2-512</code> \u7b97\u6cd5\u3002</p> <p>\u5982\u679c\u4f60\u6b63\u5728\u4f7f\u7528\u4e00\u4e2a RSA CA\uff0c\u90a3\u4e48\u4f60\u9700\u8981\u5c06\u5df2\u6709\u7684\u8bc1\u4e66\u4f7f\u7528 OpenSSH 8.2 \u4ee5\u4e0a\u7684\u7248\u672c\u91cd\u65b0\u7b7e\u540d\u3002</p> <p>\u5982\u679c\u9700\u8981\u4e34\u65f6\u517c\u5bb9 \u2264 7.1 \u7248\u672c\u7684 OpenSSH\uff0c\u53ef\u4ee5\u5728 <code>~/.ssh/config</code> \u6216 <code>sshd_config</code> \u4e2d\u6307\u5b9a <code>CASignatureAlgorithms +ssh-rsa</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4f7f\u7528\u65e7\u7248\u672c\u7684\u8bc1\u4e66\u7b7e\u540d\u7b97\u6cd5\u4e86\u3002</p> <ul> <li>\u57fa\u4e8e RSA / SHA-1 \u7684\u516c\u94a5\u7b7e\u540d\u7b97\u6cd5\u5957\u4ef6\uff08<code>ssh-rsa</code>\uff09\u3002\u4e0e\u524d\u9762\u7684\u8bc1\u4e66\u4e0d\u540c\uff0c\u8fd9\u79cd\u7b7e\u540d\u7b97\u6cd5\u662f\u7528\u4e8e\u7528\u6237\u767b\u5f55\u65f6\u7684\u516c\u94a5\u9a8c\u8bc1\uff0c\u4e0d\u4f1a\u4fdd\u5b58\u5728\u6587\u4ef6\u91cc\uff0c\u800c\u662f\u5728 SSH \u534f\u8bae\u5185\u90e8\u4f7f\u7528\u3002</li> </ul> <p>\u4e0e\u524d\u4e00\u4e2a\u91c7\u7528 SHA-1 \u4f5c\u4e3a\u54c8\u5e0c\u7b97\u6cd5\u7684\u7b97\u6cd5\u5957\u4ef6\u7c7b\u4f3c\uff0cOpenSSH 8.8 \u8d77\u4e5f\u4e0d\u518d\u9ed8\u8ba4\u542f\u7528\uff0c\u4e14\u66ff\u4ee3\u7b97\u6cd5\u4e5f\u5206\u522b\u53eb\u505a <code>rsa-sha2-256</code> \u548c <code>rsa-sha2-512</code>\u3002\u597d\u6d88\u606f\u662f\uff0c\u4f60\u4e0d\u9700\u8981\u91cd\u65b0\u7b7e\u53d1\u4efb\u4f55\u8bc1\u4e66\uff0c\u53ea\u8981\u786e\u4fdd\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u7684 OpenSSH \u7248\u672c\u90fd\u4e0d\u4f4e\u4e8e 7.2 \u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u5982\u679c\u9700\u8981\u4e34\u65f6\u517c\u5bb9 \u2264 7.1 \u7248\u672c\u7684 OpenSSH\uff0c\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u9009\u9879 <code>HostkeyAlgorithms</code> \u548c <code>PubkeyAcceptedAlgorithms</code> \u542f\u7528\u3002\u8fd9\u4e24\u4e2a\u9009\u9879\u5206\u522b\u63a7\u5236\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u7684\u516c\u94a5\u7b7e\u540d\u7b97\u6cd5\u5957\u4ef6\uff0c\u5e76\u4e14\u5728\u4e24\u7aef\u90fd\u53ef\u4ee5\u6307\u5b9a\u3002</p>"},{"location":"ops/","title":"\u8fd0\u7ef4\u57fa\u7840","text":""},{"location":"ops/checklist/","title":"\u8fd0\u7ef4\u68c0\u67e5\u5355","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u672c\u8282\u4e3b\u8981\u63d0\u4f9b\u5982\u5355/\u591a\u53f0 Linux \u670d\u52a1\u5668\u4f9b\u591a\u7528\u6237\u5206\u4eab\u7684\u60c5\u51b5\u4e0b\u7684\u8fd0\u7ef4\u914d\u7f6e\u548c\u68c0\u67e5\u6e05\u5355\u3002</p> <p>\u5982\u679c\u9075\u5faa\u672c\u8282\u63d0\u4f9b\u7684\u5185\u5bb9\u8fdb\u884c\u8bbe\u7f6e\u548c\u6392\u67e5\u64cd\u4f5c\uff0c\u5219\u53ef\u4ee5\u90e8\u7f72\u57fa\u672c\u53ef\u7528\u7684\u670d\u52a1\u5668\u73af\u5883\uff0c\u5e76\u4e14\u9632\u8303\u5e38\u89c1\u7684\u7f51\u7edc\u5b89\u5168\u95ee\u9898\u3002</p>"},{"location":"ops/checklist/#_2","title":"\u7cfb\u7edf\u5b89\u88c5","text":"<ul> <li>\u4f7f\u7528 PXE \u65b9\u5f0f\u6216 U \u76d8\u5b89\u88c5\u8f83\u7a33\u5b9a\u4e14\u786e\u4fdd\u9002\u5f53\u957f\u5ea6\u7684\u7ef4\u62a4\u65f6\u95f4\u7684 Linux \u53d1\u884c\u7248</li> <li>\u5b89\u88c5\u65f6\u5bf9\u6709 root \u6216\u6709 sudo \u6743\u9650\u7684\u7528\u6237\u8bbe\u7f6e\u5f3a\u5bc6\u7801</li> <li>\u5c3d\u91cf\u5728 SSD \u4e0a\u90e8\u7f72\u7cfb\u7edf rootfs\uff0c\u5e76\u4e14\u786e\u8ba4\u5206\u533a\u65b9\u6848\u5408\u7406</li> </ul>"},{"location":"ops/checklist/#_3","title":"\u8f6f\u4ef6\u5b89\u88c5","text":"<ul> <li>\u5bf9\u4e8e\u90e8\u7f72\u5728\u4e2d\u56fd\u5927\u9646\u5730\u533a\u7684\u670d\u52a1\u5668\uff0c\u4f7f\u7528\u955c\u50cf\u7ad9\u66ff\u6362\u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\u63d0\u4f9b\u7684\u6e90</li> <li>\u9664\u975e\u786e\u6709\u9700\u8981\uff0c\u4e0d\u4f7f\u7528\u9664\u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\u4e4b\u5916\u7684\u65b9\u6cd5\u5b89\u88c5\u8f6f\u4ef6\u5230 <code>/home</code> \u5916\u7684\u4f4d\u7f6e\uff1b\u5bf9\u4f7f\u7528\u975e\u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\u4e4b\u5916\u7684\u65b9\u6cd5\u5b89\u88c5\u5230 <code>/home</code> \u5916\u4f4d\u7f6e\u7684\u8f6f\u4ef6\uff0c\u7cfb\u7edf\u7ba1\u7406\u5458\u5e94\u5efa\u7acb\u53f0\u8d26</li> <li>\u5bf9\u4e8e\u5b9e\u9a8c\u5ba4\u573a\u5408\uff0c\u5728\u7cfb\u7edf\u76ee\u5f55\u5185\u8bbe\u7f6e\u6070\u5f53\u7248\u672c\u7684\u7f16\u8bd1\u548c\u5f00\u53d1\u73af\u5883\uff0c\u5e76\u5bf9\u6709\u989d\u5916\u9700\u6c42\u7684\u7528\u6237\u7684\u63d0\u4f9b\u5728\u5bb6\u76ee\u5f55\u8bbe\u7f6e\u5355\u72ec\u5de5\u5177\u94fe\u7684\u9002\u5f53\u6307\u5f15 <p>TODO: explain</p> </li> </ul>"},{"location":"ops/checklist/#_4","title":"\u8fdc\u7a0b\u7ba1\u7406","text":"<ul> <li>\u5bf9\u4e8e\u5e26\u6709 IPMI \u7b49\u5e26\u5916\u7ba1\u7406\u529f\u80fd\u7684\u670d\u52a1\u5668\uff0c\u5c06\u5176\u542f\u7528\uff0c\u5e76\u914d\u7f6e\u56fa\u5b9a IP \u5730\u5740\u548c\u5b89\u5168\u7684\u5bc6\u7801\u540e\u63a5\u5165\u7f51\u7edc <p>\u6b63\u786e\u914d\u7f6e\u7684 IPMI \u529f\u80fd\u5c06\u4e3a\u670d\u52a1\u5668\u5d29\u6e83\u7b49\u65e0\u6cd5\u6b63\u5e38\u767b\u5f55\u8fdb\u5165\u670d\u52a1\u5668\u7684\u60c5\u51b5\u4e0b\u7684\u91cd\u542f\u64cd\u4f5c\u63d0\u4f9b\u65b9\u4fbf\uff0c\u53ef\u63d0\u5347\u5982\u5047\u671f\u7b49\u60c5\u51b5\u4e0b\u7684\u670d\u52a1\u5668\u53ef\u9760\u6027\u3002</p> </li> <li>\u6b63\u786e\u8bbe\u7f6e SSH\uff0c\u5e76\u4f5c\u4e3a\u8fdc\u7a0b\u7ba1\u7406\u7684\u4e3b\u8981\u624b\u6bb5 <p>TODO: add ref to ssh &amp; explain</p> </li> </ul>"},{"location":"ops/checklist/#_5","title":"\u7cfb\u7edf\u5b89\u5168","text":"<ul> <li>\u662f\u5426\u6240\u6709\u7528\u6237\u90fd\uff08\u6216\u8005\u81f3\u5c11 root \u53ca\u6709 sudo \u6743\u9650\u7684\u7528\u6237\uff09\u5177\u6709\u5f3a\u5bc6\u7801\uff1f</li> <li>SSH \u7684\u5bc6\u7801\u767b\u5f55\u662f\u5426\u5df2\u7981\u7528\uff1f\uff08<code>PasswordAuthentication no</code>\uff09<ul> <li>\u5982\u679c\u6709\u4efb\u4f55\u539f\u56e0\u9700\u8981\u542f\u7528\u5bc6\u7801\u767b\u5f55\uff0c\u662f\u5426\u5df2\u7981\u7528 root \u7528\u6237\u7684\u5bc6\u7801\u767b\u5f55\uff1f\uff08<code>PermitRootLogin prohibit-password</code>\uff09</li> <li>\u6216\u8005\uff0c\u4ec5\u5bf9\u6709\u9700\u8981\u7684\u7528\u6237\u542f\u7528\u5bc6\u7801\u767b\u5f55\uff1f\uff08<code>Match user &lt;username&gt;</code>\u3001<code>PasswordAuthentication yes</code>\uff09</li> </ul> </li> </ul>"},{"location":"ops/checklist/#_6","title":"\u7f51\u7edc\u5b89\u5168","text":"<ul> <li>MySQL\u3001PostgreSQL\u3001Redis \u7b49\u6570\u636e\u5e93\u670d\u52a1\u662f\u5426\u53ea\u76d1\u542c\u4e86\u672c\u5730\u5730\u5740\uff1f<ul> <li>\u6216\u8005\uff0c\u5df2\u7ecf\u914d\u7f6e\u4e86\u5916\u90e8\u9632\u706b\u5899\u963b\u65ad\u76f8\u5173\u7aef\u53e3\u7684\u5165\u7ad9\u8fde\u63a5\uff1f\uff08MySQL: 3306\uff0cPostgreSQL: 5432\uff0cRedis: 6379\uff09</li> </ul> </li> </ul>"},{"location":"ops/debug/","title":"\u95ee\u9898\u8c03\u8bd5","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>\u672c\u90e8\u5206\u4ecb\u7ecd\u8c03\u8bd5\u95ee\u9898\u65f6\u7684\u4e00\u822c\u601d\u8def\u548c\u65b9\u6cd5\u3002 \u8bf7\u6ce8\u610f\u672c\u90e8\u5206\u65e0\u6cd5\u9762\u9762\u4ff1\u5230\uff0c\u56e0\u6b64\u53ea\u80fd\u591f\u63d0\u4f9b\u4e00\u4e9b\u5728\u8fd0\u7ef4\u4e0a\u5e38\u7528\u7684\u65b9\u6cd5\uff0c\u5177\u4f53\u95ee\u9898\u9700\u8981\u5177\u4f53\u5206\u6790\u3002</p>"},{"location":"ops/debug/#status-and-logs","title":"\u670d\u52a1\u72b6\u6001\u4e0e\u65e5\u5fd7","text":"<p>\u5f53\u51fa\u73b0\u5f02\u5e38\uff0c\u767b\u5f55\u7cfb\u7edf\u540e\uff0c\u7b2c\u4e00\u4ef6\u4e8b\u60c5\u53ef\u80fd\u662f\u68c0\u67e5\u5f53\u524d\u7cfb\u7edf\u7684\u670d\u52a1\u72b6\u6001\u3002 <code>systemctl --failed</code> \u53ef\u4ee5\u5217\u51fa\u5f53\u524d\u5931\u8d25\u7684\u670d\u52a1\u3002 \u5982\u679c\u663e\u793a\u5927\u91cf\u670d\u52a1\u5931\u8d25\uff0c\u90a3\u4e48\u8bf4\u660e\u53ef\u80fd\u9047\u5230\u4e86\u6bd4\u8f83\u4e25\u91cd\u7684\u95ee\u9898\uff0c\u4f8b\u5982\u78c1\u76d8\u5df2\u6ee1\u7b49\u3002 \u53ef\u4ee5\u5148\u5c1d\u8bd5\u5c06\u5931\u8d25\u7684\u670d\u52a1\u6062\u590d\u3002<code>systemctl status</code> \u53ef\u4ee5\u5217\u51fa\u5f53\u524d\u7cfb\u7edf\u4e2d\u7684 cgroup \u60c5\u51b5\uff08\u7ea6\u7b49\u4e8e\u6240\u6709\u6b63\u5728\u8fd0\u884c\u7684\u670d\u52a1\u4ee5\u53ca\u8fdb\u7a0b\u7684\u6811\uff09\u3002</p> <p>\u68c0\u67e5\u65e5\u5fd7\u5185\u5bb9\u4e5f\u662f\u68c0\u67e5\u3001\u6392\u9664\u95ee\u9898\u7684\u91cd\u8981\u6b65\u9aa4\u3002 \u73b0\u4ee3\u57fa\u4e8e systemd \u7684 Linux \u7cfb\u7edf\u7684\u65e5\u5fd7\u901a\u5e38\u7531 systemd-journald \u8d1f\u8d23\u7ba1\u7406\u3002 \u4ee5\u4e0b\u662f\u5e38\u7528\u7684\u547d\u4ee4\uff1a</p> <ul> <li><code>journalctl -b</code>: \u67e5\u770b\u672c\u6b21\u5f00\u673a\u7684\u65e5\u5fd7\u3002\u5728 <code>-b</code> \u540e\u52a0\u4e0a <code>-1</code>/<code>-2</code> \u7b49\u53ef\u4ee5\u67e5\u770b\u4e0a\u6b21/\u4e0a\u4e0a\u6b21\u7b49\u7684\u5f00\u673a\u65e5\u5fd7\u3002</li> <li><code>journalctl --since \"1 hour ago\"</code>: \u67e5\u770b\u6700\u8fd1\u4e00\u5c0f\u65f6\u7684\u65e5\u5fd7\u3002</li> <li><code>journalctl -u xxx.service</code>: \u67e5\u770b\u67d0\u4e2a\u670d\u52a1\u7684\u65e5\u5fd7\u3002</li> <li><code>journalctl -f</code>: \u5b9e\u65f6\u67e5\u770b\u65e5\u5fd7\u3002</li> <li><code>journalctl -b -k</code>: \u67e5\u770b\u672c\u6b21\u542f\u52a8\u7684\u5185\u6838\u6001\u65e5\u5fd7\u3002   <code>dmesg</code> \u7684\u547d\u4ee4\u867d\u7136\u4e5f\u53ef\u4ee5\u67e5\u770b\uff0c\u4f46\u662f\u56e0\u4e3a\u5185\u6838\u5185\u5b58\u6709\u9650\uff0c\u6240\u4ee5\u53ef\u80fd\u770b\u4e0d\u5230\u8f83\u65e9\u7684\u5185\u6838\u6001\u65e5\u5fd7\u4fe1\u606f\u3002   journald \u4f1a\u5e2e\u6211\u4eec\u6301\u4e45\u5316\u5185\u6838\u6001\u65e5\u5fd7\u4fe1\u606f\u3002</li> </ul> <p>journalctl \u9ed8\u8ba4\u4f1a\u4f7f\u7528 pager\uff08\u6362\u53e5\u8bdd\u8bf4\uff0c<code>less</code>\uff09\u663e\u793a\u65e5\u5fd7\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u540e\u9762\u63a5\u4e2a <code>| grep ...</code> \u6765\u8fc7\u6ee4\u65e5\u5fd7\u3002 \u6b64\u5916\uff0c\u5982\u679c\u4f7f\u7528\u4e86\u7528\u6237\u670d\u52a1\uff08user service\uff09\uff0c\u90a3\u4e48\u68c0\u67e5\u7528\u6237\u670d\u52a1\u7684\u72b6\u6001\u6216\u8005\u65e5\u5fd7\u65f6\uff0c\u9700\u8981\u52a0\u4e0a <code>--user</code> \u53c2\u6570\u3002</p> <p>@taoky: journald \u7684\u4e00\u70b9\u5410\u69fd</p> <p>\u9996\u5148\u2026\u2026journald \u770b\u65e5\u5fd7\u592a\u6162\u4e86\uff0c\u65e5\u5fd7\u5f88\u591a\u7684\u8bdd\u5b9e\u5728\u662f\u6162\u3002 \u800c\u4e14 <code>systemctl status xxx.service</code> \u56e0\u4e3a\u8981\u663e\u793a\u6700\u8fd1\u51e0\u6761\u65e5\u5fd7\uff0c \u4e5f\u8ddf\u7740\u6162\u2014\u2014\u5728 mirrors \u670d\u52a1\u5668\u4e0a\u751a\u81f3\u8981\u4e00\u5206\u591a\u949f\u624d\u80fd\u663e\u793a\u51fa\u670d\u52a1\u72b6\u6001\u3002 \u5173\u4e8e\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u9605\u8bfb\u4ee5\u4e0b\u8ba8\u8bba:</p> <ul> <li>https://github.com/systemd/systemd/issues/2460</li> <li>https://github.com/systemd/systemd/pull/29261</li> <li>https://github.com/systemd/systemd/pull/30209</li> </ul> <p>\u7136\u540e\uff0cjournald \u8bbe\u7f6e\u6309\u7167\u65f6\u95f4\u7684 retention \u4e5f\u4e0d\u592a\u65b9\u4fbf\u3002 \u6bd4\u5982\u8bf4\uff0c\u5982\u679c\u60f3\u4fdd\u7559 180 \u5929\u7684\u65e5\u5fd7\u7684\u8bdd\uff0c\u600e\u4e48\u8bbe\u7f6e journald \u5462\uff1f <code>MaxRetentionSec</code> \u4f3c\u4e4e\u4e0d\u591f\u2026\u2026</p> <p>\u6700\u540e\u4e00\u70b9\u662f\uff0c\u5982\u679c\u8981\u5b9e\u65f6\u770b\u5185\u6838\u6001\u65e5\u5fd7\uff0c\u6211\u66f4\u63a8\u8350\u7528 <code>dmesg -w</code>\uff0c\u56e0\u4e3a\u989c\u8272\u66f4\u597d\u770b\u4e00\u4e9b\u3002</p> <p>\u5927\u90e8\u5206\u7684 Debian \u7cfb\u7edf\u4f1a\u9884\u88c5 rsyslog\uff0c\u5b83\u4f1a\u5c06 journald \u7684\u65e5\u5fd7\u8f6c\u53d1\u5230 <code>/var/log/syslog</code>\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5e38\u89c4\u7684\u547d\u4ee4\u884c\u6587\u672c\u5904\u7406\u5de5\u5177\u5206\u6790\u3002 \u5176\u4ed6\u4e00\u4e9b\u8f6f\u4ef6\u53ef\u80fd\u4e5f\u4e0d\u4f1a\u4f7f\u7528 journald\uff0c\u800c\u662f\u76f4\u63a5\u5c06\u65e5\u5fd7\u5199\u5165\u5230 <code>/var/log/</code> \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 nginx\u3002</p> <p>logrotate \u4f1a\u5b9a\u671f\uff08\u4e00\u822c\u662f\u6bcf\u5929\uff0c\u6216\u8005\u6587\u4ef6\u8db3\u591f\u5927\u7684\u65f6\u5019\uff0c\u8bf7\u53c2\u8003 <code>/etc/logrotate*</code> \u5bf9\u5e94\u7684\u914d\u7f6e\uff09\u300c\u8f6e\u8f6c\u300d\uff08rotate\uff09\u65e5\u5fd7\u6587\u4ef6\uff1a \u8fd9\u662f\u4e00\u4e2a\u5c06\u65e7\u65e5\u5fd7\u538b\u7f29\uff0c\u66f4\u65e7\u7684\u65e5\u5fd7\u5220\u9664\u7684\u8fc7\u7a0b\u3002\u4e3a\u4e86\u5206\u6790\u88ab\u538b\u7f29\u8fc7\u7684\u5386\u53f2\u65e5\u5fd7\uff0c\u53ef\u4ee5\u4f7f\u7528\u5bf9\u5e94\u538b\u7f29\u8f6f\u4ef6\u63d0\u4f9b\u7684\u5de5\u5177\uff0c\u4f8b\u5982 <code>gz</code> \u683c\u5f0f\u5bf9\u5e94 <code>zcat</code>/<code>zgrep</code>\uff0c<code>xz</code> \u683c\u5f0f\u5bf9\u5e94 <code>xzcat</code>/<code>xzgrep</code>\uff0c<code>zst</code> \u683c\u5f0f\u5bf9\u5e94 <code>zstdcat</code>/<code>zstdgrep</code> \u7b49\u7b49\u3002</p>"},{"location":"ops/debug/#procfs-and-strace","title":"procfs \u4e0e strace","text":"<p><code>/proc</code>\uff08procfs\uff09\u662f\u5185\u6838\u4ee5\u6587\u4ef6\u7cfb\u7edf\u5f62\u5f0f\u5411\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u7684\u67e5\u770b\u3001\u7ba1\u7406\u8fdb\u7a0b\u72b6\u6001\u7684\u63a5\u53e3\u3002 \u5176\u4e2d <code>/proc/self</code> \u6307\u5411\u4e86\u8bbf\u95ee\u6587\u4ef6\u7684\u5f53\u524d\u8fdb\u7a0b\u7684\u4fe1\u606f\uff0c<code>/proc/&lt;pid&gt;</code> \u5219\u6307\u5411\u4e86 PID \u5bf9\u5e94\u8fdb\u7a0b\u7684\u4fe1\u606f\u3002 \u5e38\u5173\u6ce8\u7684\u4fe1\u606f\uff08\u4e0d\u4f1a\u76f4\u63a5\u4ece <code>htop</code> \u7b49\u83b7\u5f97\u7684\u4fe1\u606f\uff09\u6709\uff1a</p> <ul> <li><code>cwd</code> \u4e0e <code>exe</code>\uff1a\u7a0b\u5e8f\u7684\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u4e0e\u53ef\u6267\u884c\u6587\u4ef6\u8def\u5f84</li> <li><code>fd</code> \u76ee\u5f55\u5305\u542b\u4e86\u6240\u6709\u7a0b\u5e8f\u6253\u5f00\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26</li> <li><code>stack</code>\uff1a\u7a0b\u5e8f\u5728\u5185\u6838\u6001\u7684\u6808\u4fe1\u606f\uff0c\u8fd9\u4e00\u9879\u4fe1\u606f\u5728\u7a0b\u5e8f\u4e00\u76f4\u5904\u4e8e D \u72b6\u6001\uff08\u4e0d\u53ef\u4e2d\u65ad\u7761\u7720\uff09\u65f6\u7279\u522b\u6709\u7528</li> </ul> <p>\u5728\u5206\u6790\u8fdb\u7a0b\u884c\u4e3a\u65f6\uff0c\u53e6\u4e00\u4e2a\u76f8\u5f53\u6709\u7528\u7684\u5de5\u5177\u662f <code>strace</code>\u3002\u5b83\u53ef\u4ee5\u8f93\u51fa\u7a0b\u5e8f\u4f7f\u7528\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528\u4fe1\u606f\uff0c\u5728\u8c03\u8bd5\u8bb8\u591a\u95ee\u9898\u7684\u65f6\u5019\u90fd\u53ef\u4ee5\u63d0\u4f9b\u5f88\u5927\u7684\u5e2e\u52a9\u3002\u4e00\u4e9b\u5e38\u7528\u7684\u547d\u4ee4\u6709\uff1a</p> <ul> <li><code>strace ls</code>\uff1a\u8ddf\u8e2a <code>ls</code> \u7684\u7cfb\u7edf\u8c03\u7528</li> <li><code>strace -f bash</code>\uff1a\u8ddf\u8e2a <code>bash</code> \u53ca\u5176 fork \u51fa\u7684\u5b50\u8fdb\u7a0b\u7684\u7cfb\u7edf\u8c03\u7528</li> <li><code>strace -p &lt;pid&gt;</code>\uff1a\u8ddf\u8e2a\u6307\u5b9a PID \u7684\u8fdb\u7a0b\u7684\u7cfb\u7edf\u8c03\u7528</li> <li><code>strace -e openat ls</code>\uff1a\u53ea\u8ddf\u8e2a <code>openat</code> \u7cfb\u7edf\u8c03\u7528</li> <li><code>strace -ff -o /tmp/test.log bash</code>\uff1a\u5c06 <code>bash</code> \u53ca\u5176 fork \u51fa\u7684\u5b50\u8fdb\u7a0b\u7684\u7cfb\u7edf\u8c03\u7528\u8f93\u51fa\u5230 <code>/tmp/test.log.*</code></li> </ul> <p>Sysinternals' Procmon</p> <p>Windows \u7cfb\u7edf\u4e0a\u7684\u7c7b\u4f3c\u5de5\u5177\u662f Sysinternals \u7684 Procmon\uff0c \u53ef\u4ee5\u67e5\u770b\u6240\u6709\u8fdb\u7a0b\u5bf9\u6587\u4ef6\u7cfb\u7edf\u3001\u6ce8\u518c\u8868\u7b49\u7684\u64cd\u4f5c\u3002 \u6709\u8da3\u7684\u662f\uff0cSysinternals \u5728\u591a\u5e74\u524d\u4e5f\u63a8\u51fa\u4e86 Procmon \u7684 Linux \u7248\u672c\uff0c \u4f7f\u7528\u4e86 eBPF \u6280\u672f\u5b9e\u73b0\uff08\u8be6\u89c1\u4e0b\u6587\uff09\u3002</p> <p>\u6848\u4f8b\uff1aCentOS 7 \u5bb9\u5668\u4f7f\u7528 <code>yum</code> \u5b89\u88c5\u8f6f\u4ef6\u7684 bug</p> <p>\u5728\u67d0\u4e9b\u914d\u7f6e\u4e0b\uff0c\u53ef\u4ee5\u6ce8\u610f\u5230 <code>centos:7</code> \u5bb9\u5668\u4e2d\u4f7f\u7528 <code>yum</code> \u5b89\u88c5\u8f6f\u4ef6\u65f6\u4f1a\u5361\u4f4f\uff1a</p> <pre><code>$ sudo docker run -it --rm centos:7 bash\n[root@16c7cc5f835d /]# yum update\n\uff08\u7565\uff09\n  Updating   : tzdata-2024a-1.el7.noarch                                                                                      1/102 \n  Updating   : bash-4.2.46-35.el7_9.x86_64                                                                                    2/102 \n  Updating   : glibc-common-2.17-326.el7_9.x86_64                                                                             3/102 \n  Updating   : nss-softokn-freebl-3.90.0-6.el7_9.x86_64                                                                       4/102 \n  Updating   : glibc-2.17-326.el7_9.x86_64                                                                                    5/102\n</code></pre> <p>\u6b64\u65f6\u53d1\u73b0 <code>/usr/bin/python /usr/bin/yum update</code> CPU \u5360\u7528 100%\u3002\u4f7f\u7528 <code>strace</code> \u8ddf\u8e2a <code>yum</code> \u7684\u7cfb\u7edf\u8c03\u7528\uff1a</p> <pre><code>$ sudo strace -f -p 3163763\nfcntl(441032195, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032196, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032197, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032198, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032199, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032200, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032201, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032202, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032203, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032204, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032205, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032206, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032207, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032208, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032209, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032210, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032211, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032212, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032213, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032214, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032215, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032216, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032217, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032218, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032219, F_GETFD)               = -1 EBADF (Bad file descriptor)\nfcntl(441032220, F_GETFD)               = -1 EBADF (Bad file descriptor)\n...\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\u5176\u5728\u904d\u5386\u6240\u6709\u53ef\u80fd\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4f46\u662f\u5728\u8be5\u5bb9\u5668\u73af\u5883\u4e2d\uff0c\u8fd9\u4e2a\u8303\u56f4\u8fc7\u5927\uff0c\u5bfc\u81f4\u4e86 <code>yum</code> \u5361\u4f4f\u3002 \u641c\u7d22\u540e\u53ef\u4ee5\u53d1\u73b0\u8fd9\u662f\u4e2a\u5df2\u77e5\u7684 bug\uff1a\u5982\u679c\u5bb9\u5668\u6ca1\u6709\u9650\u5236\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u8303\u56f4\uff0c\u90a3\u4e48\u9ed8\u8ba4\u503c\u5c31\u7279\u522b\u5927\uff1a</p> <pre><code>[root@16c7cc5f835d /]# ulimit -n\n1073741816\n</code></pre> <p>\u800c\u67d0\u4e9b\u7a0b\u5e8f\u65e0\u6cd5\u6b63\u786e\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\uff08\u9ed8\u8ba4\u6587\u4ef6\u63cf\u8ff0\u7b26\u8303\u56f4\u4e0d\u5927\uff0c\u7136\u540e\u4e00\u4e2a\u4e00\u4e2a\u53bb\u5c1d\u8bd5\u64cd\u4f5c\uff09\u3002 \u4e0d\u4ec5\u662f <code>yum</code>\uff0c\u8bf8\u5982 <code>xinetd</code> \u7b49\u4e5f\u6709\u7c7b\u4f3c\u7684\u95ee\u9898\uff08ref\uff09\u3002</p> <p>\u9664 strace \u4ee5\u5916\uff0cLinux \u4e2d\u8fd8\u6709\u5f88\u591a\u7528\u4e8e\u76d1\u63a7\u3001\u8ffd\u8e2a\u7cfb\u7edf\u72b6\u6001\u7684\u5de5\u5177\uff0c\u5982\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u9700\u8981\u6839\u636e\u5177\u4f53\u60c5\u51b5\u9009\u62e9\u5408\u9002\u7684\u5de5\u5177\u3002\u672c\u6587\u4ea6\u65e0\u6cd5\u8be6\u7ec6\u4ecb\u7ecd\u6bcf\u4e00\u4e2a\u5de5\u5177\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u56e0\u6b64\u8bf7\u53c2\u8003\u5bf9\u5e94\u5de5\u5177\u7684\u624b\u518c\u3002</p>"},{"location":"ops/debug/#debug-symbols-and-gdb","title":"\u8c03\u8bd5\u7b26\u53f7\u4e0e gdb","text":"<p>\u6709\u7684\u65f6\u5019\uff0c\u6211\u4eec\u4f1a\u9047\u5230\u7a0b\u5e8f\u5d29\u6e83\u7684\u60c5\u51b5\u3002\u9664\u4e86\u7a0b\u5e8f\u672c\u8eab\u7559\u4e0b\u7684\u65e5\u5fd7\u4ee5\u5916\uff0c\u53e6\u4e00\u4e2a\u91cd\u8981\u7684\u4fe1\u606f\u5c31\u662f\u7a0b\u5e8f\u7684 coredump\u3002 coredump \u4e2d\u5305\u542b\u4e86\u7a0b\u5e8f\u7684\u5185\u5b58\u4fe1\u606f\uff0c\u901a\u8fc7\u89e3\u6790 coredump\uff0c\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u5728\u7a0b\u5e8f\u5d29\u6e83\u65f6\u8be6\u7ec6\u7684\u8c03\u7528\u6808\u4fe1\u606f\uff0c\u8fd9\u5bf9\u4e8e\u6392\u67e5\u95ee\u9898\u975e\u5e38\u6709\u5e2e\u52a9\u3002</p> <p>\u5728\u5b89\u88c5\u4e86 systemd-coredump \u7684\u7cfb\u7edf\u4e0a\uff0c\u5176\u4f1a\u81ea\u52a8\u6536\u96c6\u7a0b\u5e8f\u5d29\u6e83\u65f6\u7684 coredump\uff1b \u5bf9\u4e8e\u6b63\u5728\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>gcore</code> \u547d\u4ee4\u6765\u751f\u6210 coredump\u3002 \u4f46\u662f coredump \u8fd8\u9700\u8981\u914d\u5408\u8c03\u8bd5\u7b26\u53f7\u624d\u80fd\u8fdb\u884c\u5206\u6790\uff0c\u5426\u5219\u5f97\u5230\u7684\u5185\u5bb9\u5305\u62ec\u5199\u7a0b\u5e8f\u7684\u4eba\u81ea\u5df1\u90fd\u4e0d\u53ef\u80fd\u770b\u61c2\u3002 \u5bf9\u4e8e Debian\uff0c\u53ef\u4ee5\u53c2\u8003 https://wiki.debian.org/HowToGetABacktrace \u6765\u83b7\u53d6\u8c03\u8bd5\u7b26\u53f7\uff0c\u5176\u4ed6\u7684\u53d1\u884c\u7248\u5219\u9700\u8981\u9605\u8bfb\u53d1\u884c\u7248\u5bf9\u5e94\u7684\u624b\u518c\u3002 \u4e00\u822c\u6765\u8bb2\uff0c\u8bb8\u591a\u53d1\u884c\u7248\u76ee\u524d\u90fd\u63d0\u4f9b\u4e86\u4ece debuginfod \u81ea\u52a8\u83b7\u53d6\u8c03\u8bd5\u7b26\u53f7\u7684\u529f\u80fd\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9\u624b\u52a8\u5b89\u88c5\u8c03\u8bd5\u7b26\u53f7\u5305\u3002</p> <p>\u6709\u4e86\u8c03\u8bd5\u7b26\u53f7\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>gdb</code> \u5206\u6790 coredump \u4e86\u3002\u5bf9\u4e8e systemd-coredump\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ coredumpctl list\n\uff08\u627e\u5230\u5bf9\u5e94\u7684 coredump \u4ee5\u53ca\u5176 pid\uff09\n$ coredumpctl gdb &lt;pid&gt;  # \u5982\u679c\u662f\u6700\u8fd1\u4e00\u6b21\u7684 coredump\uff0c\u53ef\u4ee5\u7701\u7565 &lt;pid&gt;\n</code></pre> <p>\u5982\u679c\u662f coredump \u6587\u4ef6\u7684\u5f62\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528 gdb\uff1a</p> <pre><code>gdb -c core.123456 # \u5047\u8bbe coredump \u6587\u4ef6\u540d\u4e3a core.123456\n</code></pre> <p>\u5982\u679c\u5e0c\u671b\u8fd0\u884c\u65f6\u8c03\u8bd5\uff0c\u6216\u8005\u76f4\u63a5\u4f7f\u7528 gdb \u542f\u52a8\u5e0c\u671b\u8c03\u8bd5\u7684\u7a0b\u5e8f\uff1a</p> <pre><code>$ gdb -p &lt;pid&gt;  # \u9644\u52a0\uff08attach\uff09\u5230\u6307\u5b9a\u7684 pid \u8c03\u8bd5\n$ gdb /path/to/program  # \u76f4\u63a5\u542f\u52a8 gdb \u5e76\u8c03\u8bd5\u6307\u5b9a\u7684\u7a0b\u5e8f\n$ gdb --args /path/to/program arg1 arg2  # \u542f\u52a8 gdb \u5e76\u8c03\u8bd5\u6307\u5b9a\u7684\u7a0b\u5e8f\uff0c\u540c\u65f6\u4f20\u5165\u53c2\u6570\n$ gdb --args env VAR=VALUE /path/to/program arg1 arg2  # \u542f\u52a8 gdb \u5e76\u8c03\u8bd5\u6307\u5b9a\u7684\u7a0b\u5e8f\uff0c\u540c\u65f6\u4f20\u5165\u73af\u5883\u53d8\u91cf\u548c\u53c2\u6570\nGNU gdb (GDB) 14.2\nCopyright (C) 2023 Free Software Foundation, Inc.\n...\n&gt;&gt;&gt; run  # \u542f\u52a8\u7a0b\u5e8f\uff0c\u5728\u542f\u52a8\u7a0b\u5e8f\u524d\uff0c\u53ef\u4ee5\u8fdb\u884c\u65ad\u70b9\u8bbe\u7f6e\u7b49\u64cd\u4f5c\n</code></pre> <p>\u5728\u8fdb\u5165\u8c03\u8bd5\u73af\u5883\u540e\uff0c\u4f7f\u7528 <code>bt</code> \u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u7ebf\u7a0b\u7684\u8c03\u7528\u6808\u3002\u5728\u8c03\u8bd5\u7b26\u53f7\u914d\u7f6e\u6b63\u786e\u7684\u60c5\u51b5\u4e0b\uff0c\u81f3\u5c11\u5927\u90e8\u5206\u7684\u4fe1\u606f\u90fd\u80fd\u88ab\u663e\u793a\u51fa\u6765\uff08\u800c\u4e0d\u662f\u4e00\u5806 <code>???</code>\uff09\u3002</p> \u4e00\u4e2a coredump \u7684\u8c03\u7528\u6808\u4f8b\u5b50 <pre><code>&gt;&gt;&gt; bt\n#0  g_type_check_instance_cast\n    (type_instance=type_instance@entry=0x60166e80e040, iface_type=0x60166aa86e20 [GtkWidget/GInitiallyUnowned])\n    at ../glib/gobject/gtype.c:4217\n#1  0x00007408aee7a370 in registry_handle_global\n    (data=0x60166e80e040, registry=&lt;optimized out&gt;, name=81, interface=0x60166f7c7840 \"wl_output\", version=&lt;optimized out&gt;)\n    at ../spice-gtk-0.42/src/wayland-extensions.c:77\n#2  0x00007408ca373596 in ??? () at /usr/lib/libffi.so.8\n#3  0x00007408ca37000e in ??? () at /usr/lib/libffi.so.8\n#4  0x00007408ca372bd3 in ffi_call () at /usr/lib/libffi.so.8\n#5  0x00007408c327f645 in wl_closure_invoke (closure=closure@entry=0x60166f7c7760, target=&lt;optimized out&gt;, \n    target@entry=0x60166ead1ff0, opcode=opcode@entry=0, data=&lt;optimized out&gt;, flags=1) at ../wayland-1.22.0/src/connection.c:1025\n#6  0x00007408c327fe73 in dispatch_event (display=display@entry=0x60166a9ffed0, queue=0x60166a9fffc0)\n    at ../wayland-1.22.0/src/wayland-client.c:1631\n#7  0x00007408c328013c in dispatch_queue (queue=0x60166a9fffc0, display=0x60166a9ffed0) at ../wayland-1.22.0/src/wayland-client.c:1777\n#8  wl_display_dispatch_queue_pending (display=0x60166a9ffed0, queue=0x60166a9fffc0) at ../wayland-1.22.0/src/wayland-client.c:2019\n#9  0x00007408c3478a39 in ??? () at /usr/lib/libgdk-3.so.0\n#10 0x00007408c3444fa9 in gdk_display_get_event () at /usr/lib/libgdk-3.so.0\n#11 0x00007408c3480208 in ??? () at /usr/lib/libgdk-3.so.0\n#12 0x00007408c8ee8f69 in g_main_dispatch (context=0x60166aa114b0) at ../glib/glib/gmain.c:3476\n#13 0x00007408c8f473a7 in g_main_context_dispatch_unlocked (context=0x60166aa114b0) at ../glib/glib/gmain.c:4284\n#14 g_main_context_iterate_unlocked.isra.0\n    (context=context@entry=0x60166aa114b0, block=block@entry=1, dispatch=dispatch@entry=1, self=&lt;optimized out&gt;)\n    at ../glib/glib/gmain.c:4349\n#15 0x00007408c8ee7162 in g_main_context_iteration (context=context@entry=0x60166aa114b0, may_block=may_block@entry=1)\n    at ../glib/glib/gmain.c:4414\n#16 0x00007408c8c95b66 in g_application_run (application=0x60166abe9ce0 [GtkApplication], argc=&lt;optimized out&gt;, argv=0x0)\n    at ../glib/gio/gapplication.c:2577\n#17 0x00007408ca373596 in ??? () at /usr/lib/libffi.so.8\n#18 0x00007408ca37000e in ??? () at /usr/lib/libffi.so.8\n#19 0x00007408ca372bd3 in ffi_call () at /usr/lib/libffi.so.8\n#20 0x00007408c90566d1 in ??? () at /usr/lib/python3.11/site-packages/gi/_gi.cpython-311-x86_64-linux-gnu.so\n#21 0x00007408c9055090 in ??? () at /usr/lib/python3.11/site-packages/gi/_gi.cpython-311-x86_64-linux-gnu.so\n#22 0x00007408c9f98366 in _PyObject_Call\n    (kwargs=&lt;optimized out&gt;, args=0x7408bb5b3140, callable=0x7408c4561470, tstate=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;)\n    at Objects/call.c:343\n#23 PyObject_Call (callable=0x7408c4561470, args=0x7408bb5b3140, kwargs=&lt;optimized out&gt;) at Objects/call.c:355\n#24 0x00007408c9f6a64d in do_call_core\n    (use_tracing=&lt;optimized out&gt;, kwdict=0x7408bb575d80, callargs=0x7408bb5b3140, func=0x7408c4561470, tstate=&lt;optimized out&gt;)\n    at Python/ceval.c:7349\n#25 _PyEval_EvalFrameDefault (tstate=&lt;optimized out&gt;, frame=&lt;optimized out&gt;, throwflag=&lt;optimized out&gt;) at Python/ceval.c:5376\n#26 0x00007408ca01fae4 in _PyEval_EvalFrame (throwflag=0, frame=0x7408ca403020, tstate=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;)\n    at ./Include/internal/pycore_ceval.h:73\n#27 _PyEval_Vector\n    (tstate=tstate@entry=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;, func=func@entry=0x7408c9b06020, locals=locals@entry=0x7408c9b26c80, args=args@entry=0x0, argcount=argcount@entry=0, kwnames=kwnames@entry=0x0) at Python/ceval.c:6434\n#28 0x00007408ca01f4cc in PyEval_EvalCode (co=0x7408c9af8620, globals=&lt;optimized out&gt;, locals=0x7408c9b26c80) at Python/ceval.c:1148\n#29 0x00007408ca03cd03 in run_eval_code_obj\n    (tstate=tstate@entry=0x7408ca30d6d8 &lt;_PyRuntime+166328&gt;, co=co@entry=0x7408c9af8620, globals=globals@entry=0x7408c9b26c80, locals=locals@entry=0x7408c9b26c80) at Python/pythonrun.c:1741\n#30 0x00007408ca038e0a in run_mod\n    (mod=mod@entry=0x60166a2cd578, filename=filename@entry=0x7408c9ad4580, globals=globals@entry=0x7408c9b26c80, locals=locals@entry=0x7408c9b26c80, flags=flags@entry=0x7ffd781984f8, arena=arena@entry=0x7408c9a4f7b0) at Python/pythonrun.c:1762\n#31 0x00007408ca04f383 in pyrun_file\n    (fp=fp@entry=0x60166a23d470, filename=filename@entry=0x7408c9ad4580, start=start@entry=257, globals=globals@entry=0x7408c9b26c80, locals=locals@entry=0x7408c9b26c80, closeit=closeit@entry=1, flags=0x7ffd781984f8) at Python/pythonrun.c:1657\n#32 0x00007408ca04ecf5 in _PyRun_SimpleFileObject (fp=0x60166a23d470, filename=0x7408c9ad4580, closeit=1, flags=0x7ffd781984f8)\n    at Python/pythonrun.c:440\n#33 0x00007408ca04d5f8 in _PyRun_AnyFileObject (fp=0x60166a23d470, filename=0x7408c9ad4580, closeit=1, flags=0x7ffd781984f8)\n    at Python/pythonrun.c:79\n#34 0x00007408ca048098 in pymain_run_file_obj (skip_source_first_line=0, filename=0x7408c9ad4580, program_name=0x7408c9b26ef0)\n    at Modules/main.c:360\n#35 pymain_run_file (config=0x7408ca2f3720 &lt;_PyRuntime+59904&gt;) at Modules/main.c:379\n#36 pymain_run_python (exitcode=0x7ffd781984f0) at Modules/main.c:601\n#37 Py_RunMain () at Modules/main.c:680\n#38 0x00007408ca0131eb in Py_BytesMain (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at Modules/main.c:734\n#39 0x00007408c9c43cd0 in __libc_start_call_main\n    (main=main@entry=0x601669c16120 &lt;main&gt;, argc=argc@entry=2, argv=argv@entry=0x7ffd78198748)\n    at ../sysdeps/nptl/libc_start_call_main.h:58\n#40 0x00007408c9c43d8a in __libc_start_main_impl\n    (main=0x601669c16120 &lt;main&gt;, argc=2, argv=0x7ffd78198748, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7ffd78198738) at ../csu/libc-start.c:360\n#41 0x0000601669c16045 in _start ()\n</code></pre> <p>\u6b64\u5916\uff0c<code>bt full</code> \u53ef\u4ee5\u663e\u793a\u5f53\u524d\u7ebf\u7a0b\u5b8c\u6574\u7684\u8c03\u7528\u6808\uff0c<code>thread apply all bt full</code> \u53ef\u4ee5\u663e\u793a\u6240\u6709\u7ebf\u7a0b\u7684\u5b8c\u6574\u8c03\u7528\u6808\u3002\u8fd9\u4e9b\u4fe1\u606f\u5728\u6c47\u62a5 bug \u65f6\u4f1a\u975e\u5e38\u6709\u7528\u3002</p> <p>\u5982\u679c\u9700\u8981\u81ea\u884c\u5c1d\u8bd5\u4ece coredump \u83b7\u53d6\u4fe1\u606f\uff0c\u4ee5\u4e0b\u7684\u547d\u4ee4\u4e5f\u4f1a\u6709\u5e2e\u52a9\uff1a</p> <ul> <li><code>up</code>/<code>down</code>\uff1a\u5207\u6362\u5230\u4e0a\u4e00\u5c42/\u4e0b\u4e00\u5c42\u8c03\u7528\u6808</li> <li><code>info args</code> \u4e0e <code>info locals</code>\uff1a\u663e\u793a\u5f53\u524d\u51fd\u6570\u7684\u53c2\u6570\u4e0e\u5c40\u90e8\u53d8\u91cf\u3002\u7531\u4e8e\u7f16\u8bd1\u5668\u4f18\u5316\uff0c\u4e00\u90e8\u5206\u53d8\u91cf\u4f1a\u53d8\u6210 <code>&lt;optimized out&gt;</code>\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u4e22\u5931</li> <li><code>l</code>\uff1a\u663e\u793a\u5f53\u524d\u51fd\u6570\u7684\u6e90\u7801</li> <li><code>print xxx</code>\uff1a\u6253\u5370\u53d8\u91cf\u7684\u503c\uff0c\u53c2\u6570\u652f\u6301\u8868\u8fbe\u5f0f\uff08\u9700\u8981\u5bf9 C \u7684\u6307\u9488\u4e0e\u7c7b\u578b\u7cfb\u7edf\u6709\u4e00\u5b9a\u7684\u4e86\u89e3\uff09</li> </ul> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0ccoredump \u53ea\u5305\u542b\u4e86\u5d29\u6e83\u73b0\u573a\u7684\u4fe1\u606f\uff0c\u5bfc\u81f4\u5d29\u6e83\u7684\u539f\u56e0\u6709\u53ef\u80fd\u5e76\u4e0d\u5728 coredump \u4e2d\uff1a \u4f8b\u5982\u5728\u4e4b\u524d\u7684\u6267\u884c\u4e2d\uff0c\u7a0b\u5e8f\u5df2\u7ecf\u5411\u9519\u8bef\u7684\u4f4d\u7f6e\u5199\u5165\u6570\u636e\uff0c\u53ea\u662f\u6ca1\u6709\u7acb\u523b\u89e6\u53d1\u95ee\u9898\u3002 \u8fd9\u5c31\u9700\u8981\u8003\u8651\u4f7f\u7528\u5176\u4ed6\u7684\u65b9\u6cd5\u6392\u67e5\u95ee\u9898\uff0c\u4f8b\u5982\u5728\u8fd0\u884c\u65f6\u4f7f\u7528 <code>valgrind</code> \u68c0\u67e5\u5185\u5b58\u8bbf\u95ee\uff0c\u6216\u8005\u7f16\u8bd1\u65f6\u5c31\u6dfb\u52a0 AddressSanitizer \u7b49\u5de5\u5177\u3002</p>"},{"location":"ops/debug/#ebpf","title":"eBPF","text":"<p>\u672c\u90e8\u5206\u4e3b\u8981\u4ecb\u7ecd eBPF \u7684\u4f7f\u7528\u3002 \u5728\u9047\u5230\u7591\u96be\u95ee\u9898\u65f6\uff0ceBPF \u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4ee5\u975e\u5e38\u4f4e\u7684\u4ee3\u4ef7\u5728\u7ebf\u4e0a\u7cfb\u7edf\u4e2d\u83b7\u53d6\u5185\u6838\u6001\u4e0e\u5e94\u7528\u7a0b\u5e8f\u66f4\u591a\u7684\u4fe1\u606f\u3002 \u5bf9\u4e8e\u9700\u8981\u83b7\u53d6\u5185\u6838\u4fe1\u606f\u7684\u573a\u666f\uff0c\u5f88\u53ef\u80fd\u9700\u8981\u9605\u8bfb\u5185\u6838\u6e90\u7801\uff0celixir.bootlin.com \u63d0\u4f9b\u4e86\u5728\u6d4f\u89c8\u5668\u4e2d\u65b9\u4fbf\u7684\u5185\u6838\u6e90\u7801\u9605\u8bfb\u529f\u80fd\uff0c\u652f\u6301\u5feb\u901f\u8df3\u8f6c\u5230\u7b26\u53f7\u7b49\u529f\u80fd\u3002</p> <p>bcc \u4e0e bpftrace \u662f\u4e24\u4e2a\u5e38\u7528\u7684 eBPF \u5de5\u5177\uff0c\u7528\u6237\u53ef\u4ee5\u7528\u5b83\u4eec\u7f16\u5199\u81ea\u5df1\u7684 eBPF \u7a0b\u5e8f\u6765\u83b7\u53d6\u5185\u6838\u6001\u4fe1\u606f\u3002 \u6b64\u5916\uff0c\u5b83\u4eec\u8fd8\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\uff08\u793a\u4f8b\uff09\u5de5\u5177\uff0c\u5bf9\u4e00\u4e9b\u5e38\u89c1\u7684\u95ee\u9898\u63d0\u4f9b\u4e86\u89e3\u51b3\u65b9\u6848\uff0c\u5982\u4e0b\u9762\u4e24\u5f20\u56fe\u6240\u793a \uff08\u4ee5\u4e0b\u5de5\u5177\u7684\u4f7f\u7528\u8bf7\u81ea\u884c\u67e5\u9605\u8d44\u6599\uff09\uff1a</p> <p></p> <p></p> <p>\u8003\u8651\u5230 bpftrace \u4f7f\u7528\u8f83\u4e3a\u7b80\u5355\uff08\u4e0d\u9700\u8981\u5199 C \u4ee3\u7801\uff09\uff0c\u56e0\u6b64\u4ee5\u4e0b\u5bf9 bpftrace \u505a\u7b80\u5355\u4ecb\u7ecd\u3002</p>"},{"location":"ops/debug/#kernel-ebpf","title":"\u5185\u6838\u6001","text":"<p>bpftrace \u4e2d\u5305\u542b\u4e86\u51e0\u79cd\u5185\u6838\u6001\u7684\u300c\u63a2\u9488\u300d\uff08probe\uff09\uff1a</p> <ul> <li>kprobe\uff1a\u9ed8\u8ba4\u5728\u51fd\u6570\u5165\u53e3\u5904\u63d2\u5165 probe\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u504f\u79fb\u91cf\uff0c\u4ece\u800c\u5728\u51fd\u6570\u7684\u4efb\u610f\u4f4d\u7f6e\u63d2\u5165 probe</li> <li>kretprobe\uff1a\u5728\u51fd\u6570\u8fd4\u56de\u65f6\u63d2\u5165 probe\uff0c\u53ef\u4ee5\u83b7\u53d6\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u4e0d\u80fd\u83b7\u53d6\u51fd\u6570\u7684\u53c2\u6570</li> <li>tracepoint\uff1a\u5728\u5185\u6838\u9884\u5148\u5b9a\u4e49\u7684 tracepoint \u5904\u63d2\u5165 probe</li> <li>kfunc/kretfunc\uff1a\u5728\u51fd\u6570\u8c03\u7528/\u8fd4\u56de\u65f6\u63d2\u5165 probe\uff0c\u76f8\u6bd4\u4e8e kprobe/kretprobe\uff0c\u4e0d\u80fd\u5728\u4efb\u610f\u4f4d\u7f6e\u63d2\u5165\uff0c\u4f46\u662f\u6027\u80fd\u66f4\u597d\uff0c\u5e76\u4e14\u53ef\u4ee5\u83b7\u53d6\u5230\u7c7b\u578b\u4fe1\u606f\uff0ckretfunc \u4e5f\u53ef\u4ee5\u83b7\u53d6\u51fd\u6570\u7684\u53c2\u6570</li> </ul> <p>\u4f7f\u7528 <code>bpftrace -l</code> \u53ef\u4ee5\u83b7\u53d6\u5230\u5f53\u524d\u7cfb\u7edf\u652f\u6301\u7684\u6240\u6709 probe\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u5185\u6838\u7248\u672c\u8d8a\u65b0\uff0c\u652f\u6301\u8d8a\u597d\u3002</p> <pre><code>$ sudo bpftrace -l\n\uff08\u7701\u7565\uff09\ntracepoint:xhci-hcd:xhci_setup_addressable_virt_device\ntracepoint:xhci-hcd:xhci_setup_device\ntracepoint:xhci-hcd:xhci_setup_device_slot\ntracepoint:xhci-hcd:xhci_stop_device\ntracepoint:xhci-hcd:xhci_urb_dequeue\ntracepoint:xhci-hcd:xhci_urb_enqueue\ntracepoint:xhci-hcd:xhci_urb_giveback\n</code></pre> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\u662f\u83b7\u53d6\u7cfb\u7edf\u4e4b\u540e\u6267\u884c\u7684\u6240\u6709\u7a0b\u5e8f\uff08execsnoop\uff09\u3002 \u4ee5\u4e0b\u662f\u4e00\u4e2a\u7b80\u5316\u7684\u7248\u672c\uff0c\u8f93\u51fa\u6267\u884c\u4e86 <code>execve()</code> \u7684\u7a0b\u5e8f\uff0c\u4ee5\u53ca\u5176\u53c2\u6570\uff08\u6587\u4ef6\u8def\u5f84\uff09\uff1a</p> <pre><code>$ sudo bpftrace -e 'tracepoint:syscalls:sys_enter_execve { printf(\"%s %s\\n\", comm, str(args-&gt;filename)); }'\nAttaching 1 probe...\ncode /home/username/.nix-profile/bin/docker\ncode /usr/lib/rustup/bin/docker\ncode /home/username/.local/bin/docker\ncode /home/username/.cargo/bin/docker\n^C\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>args-&gt;filename</code> \u83b7\u53d6\u5230 <code>execve()</code> \u7684\u53c2\u6570\uff0c\u56e0\u4e3a bpftrace \u80fd\u591f\u83b7\u53d6\u5230\u76f8\u5173\u7684\u7c7b\u578b\u4fe1\u606f\uff1a</p> <pre><code>$ sudo bpftrace -lv tracepoint:syscalls:sys_enter_execve\ntracepoint:syscalls:sys_enter_execve\n    int __syscall_nr\n    const char * filename\n    const char *const * argv\n    const char *const * envp\n</code></pre> <p>\u6709\u7684\u65f6\u5019\uff0c\u4f60\u9700\u8981\u8ffd\u8e2a\u7684\u51fd\u6570\u4e0d\u5728 tracepoint \u4e2d\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u4f7f\u7528 kprobe/kretprobe\uff08\u6216\u8005 kfunc/kretfunc\uff09\uff0c \u4f8b\u5982\u4e0b\u9762\u8fd9\u4e2a\u8ffd\u8e2a <code>try_charge_memcg</code> \u7684\u7b2c\u4e09\u4e2a\u53c2\u6570 <code>nr_pages</code> \u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo bpftrace -e 'kprobe:try_charge_memcg { printf(\"%d\\n\", arg2); }'  # \u7b2c\u4e00\u4e2a\u53c2\u6570\u662f arg0\n1\n1\n1\n2\n...\n^C\n$ # \u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u4e0d\u5e0c\u671b\u8ffd\u8e2a\u6574\u4e2a\u7cfb\u7edf\u5bf9\u67d0\u4e2a\u5185\u6838\u51fd\u6570\u7684\u8c03\u7528\uff0c\u53ea\u9700\u8981\u8ffd\u8e2a\u67d0\u4e2a\u8fdb\u7a0b\u7684\u8c03\u7528\uff0c\u56e0\u6b64\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a\n$ # \u5047\u8bbe PID \u4e3a 1234567\n$ sudo bpftrace -e 'kprobe:try_charge_memcg /pid == 1234567/ { printf(\"%d\\n\", arg2); }'\n1\n1\n...\n</code></pre> <p>\u4f7f\u7528 kprobe \u548c kretprobe \u65f6\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684 pattern \u662f\uff1akprobe \u8bb0\u5f55\u67d0\u79cd\u72b6\u6001\uff08\u4f8b\u5982\u65f6\u95f4\u6216\u8005\u8c03\u7528\u53c2\u6570\uff09\uff0c\u7136\u540e\u5728 kretprobe \u4e2d\u8f93\u51fa\u3002 \u76f8\u5173\u7684\u4f8b\u5b50\u53ef\u4ee5\u53c2\u8003 bpftrace \u7684\u793a\u4f8b\u4e0e\u6587\u6863\u3002</p> <p>\u5728\u652f\u6301 kfunc \u7684\u73af\u5883\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528 kfunc \u8ba9\u903b\u8f91\u66f4\u52a0\u6e05\u6670\uff1a</p> <pre><code>$ sudo bpftrace -lv kfunc:try_charge_memcg\nkfunc:vmlinux:try_charge_memcg\n    struct mem_cgroup * memcg\n    gfp_t gfp_mask\n    unsigned int nr_pages\n    int retval\n$ sudo bpftrace -e 'kfunc:try_charge_memcg { printf(\"%d\\n\", args-&gt;nr_pages); }'\n...\n</code></pre>"},{"location":"ops/debug/#user-space-ebpf","title":"\u7528\u6237\u6001","text":"<p>eBPF \u6280\u672f\u4e5f\u53ef\u4ee5\u7528\u4e8e\u7528\u6237\u6001\u8c03\u8bd5\uff0c\u5728 bpftrace \u4e2d\u5bf9\u5e94\u7684\u662f uprobe \u548c uretprobe\u3002</p> <p>\u4ee5\u4e0b\u9762\u7684 C++ \u7a0b\u5e8f\u4e3a\u4f8b\u5b50\uff1a</p> <pre><code>#include &lt;iostream&gt;\n\nint example(int a, int b) {\n    return a + b;\n}\n\nint main(void) {\n    for (int i = 0; i &lt; 1024; i++) {\n        int a = i, b = i + 1;\n        std::cout &lt;&lt; example(a, b) &lt;&lt; std::endl;\n    }\n    return 0;\n}\n</code></pre> <p>\u7f16\u8bd1\u5e76\u67e5\u770b\u7b26\u53f7\uff1a</p> <pre><code>$ g++ example.cpp -O0 -o example\n$ nm example\n0000000000004040 B __bss_start\n                 w __cxa_finalize@GLIBC_2.2.5\n0000000000004028 D __data_start\n0000000000004028 W data_start\n0000000000004030 D __dso_handle\n0000000000003db0 d _DYNAMIC\n0000000000004038 D _edata\n0000000000004158 B _end\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u627e\u5230 <code>example()</code> \u51fd\u6570\u5bf9\u5e94\u7684\u7b26\u53f7\uff1a</p> <pre><code>$ nm example | grep example\n0000000000001220 T _Z7exampleii\n</code></pre> <p>\u7b26\u53f7\u7684\u540d\u79f0\u4fee\u9970\uff08Name mangling\uff09</p> <p>\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u4e0a\u9762\u7684\u7b26\u53f7\u540d\u4e0d\u662f <code>example</code>\uff0c\u800c\u662f <code>_Z7exampleii</code>\u3002 C++ \u4ee5\u53ca\u5176\u4ed6\u67d0\u4e9b\u8bed\u8a00\uff08\u4f8b\u5982 Rust\uff09\u4f1a\u5728\u7f16\u8bd1\u671f\u4fee\u6539\u51fd\u6570\u7684\u540d\u79f0\uff0c\u4ee5\u4fbf\u652f\u6301\u51fd\u6570\u91cd\u8f7d\u7b49\u7279\u6027\u3002 \u8fd9\u91cc\u7684\u540d\u5b57\u7ecf\u8fc7 demangle \u4e4b\u540e\u5c31\u662f <code>example(int, int)</code>\u3002</p> <p><code>nm</code></p> <p><code>nm</code> \u662f\u4e00\u4e2a\u7528\u4e8e\u67e5\u770b\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e2d\u7b26\u53f7\u7684\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u67e5\u770b\u51fd\u6570\u3001\u53d8\u91cf\u7b49\u7684\u5730\u5740\u3002 \u5982\u679c\u4e0d\u52a0\u53c2\u6570\uff0c\u90a3\u4e48\u5176\u4f1a\u5217\u51fa\u6587\u4ef6\u4e2d\u7684\u9759\u6001\u7b26\u53f7\uff08\u4f8b\u5982\u5168\u5c40\u53d8\u91cf\u3001\u51fd\u6570\u7b49\uff09\u3002 \u5bf9\u4e8e\u52a8\u6001\u94fe\u63a5\u5e93\uff08<code>.so</code> \u6587\u4ef6\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>nm -D</code> \u6765\u67e5\u770b\u5176\u66b4\u9732\u7ed9\u5e94\u7528\u7684\u52a8\u6001\u7b26\u53f7\u3002</p> <p>\u4f7f\u7528 uprobe \u8ffd\u8e2a <code>example()</code> \u51fd\u6570\u7684\u8c03\u7528\uff1a</p> <pre><code>$ sudo bpftrace -e 'uprobe:/path/to/example:_Z7exampleii { printf(\"example(%d, %d)\\n\", arg0, arg1); }'\nAttaching 1 probe...\n\uff08\u5728\u53e6\u4e00\u4e2a\u7ec8\u7aef\u6267\u884c ./example \u4e4b\u540e\uff09\nexample(0, 1)\nexample(1, 2)\n...\nexample(1023, 1024)\n</code></pre> <p>\u7f16\u8bd1\u5668\u4f18\u5316</p> <p>\u5982\u679c\u4e0a\u9762\u7684\u4f8b\u5b50\u4f7f\u7528 <code>-O2</code>\uff0c\u90a3\u4e48\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u8fd9\u91cc\u7684 bpftrace \u6ca1\u6709\u8f93\u51fa\u4efb\u4f55\u5185\u5bb9\u3002 \u8fd9\u662f\u56e0\u4e3a\u7f16\u8bd1\u5668\u8fdb\u884c\u4e86\u5185\u8054\u4f18\u5316\uff0c\u5c06 <code>example()</code> \u51fd\u6570\u5185\u8054\u5230\u4e86 <code>main()</code> \u51fd\u6570\u4e2d\uff0c\u7701\u53bb\u4e86\u51fd\u6570\u8c03\u7528\u7684\u5f00\u9500\u3002 \u65e2\u7136\u6ca1\u6709\u51fd\u6570\u8c03\u7528\uff0c\u90a3\u4e48\u4e5f\u5c31\u6ca1\u6709 uprobe \u53ef\u4ee5\u8ffd\u8e2a\u7684\u5730\u65b9\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>objdump -d</code> \u6765\u67e5\u770b\u7f16\u8bd1\u540e\u7684\u6c47\u7f16\u4ee3\u7801\uff0c\u4ee5\u786e\u8ba4\u662f\u5426\u53d1\u751f\u4e86\u5185\u8054\u4f18\u5316\u3002</p> <p>\u4f7f\u7528 uprobe \u8ffd\u8e2a\u5bb9\u5668\u4e2d\u7684\u7a0b\u5e8f</p> <p>\u5728\u5bb9\u5668\u4e2d\u7f16\u8bd1\u5e76\u8fd0\u884c\u4e0b\u9762\u7684\u7a0b\u5e8f\uff1a</p> <pre><code>#include &lt;iostream&gt;\n#include &lt;random&gt;\n#include &lt;unistd.h&gt;\n\nint example(int a, int b) {\n    return a + b;\n}\n\nint main(void) {\n    std::random_device rd;\n    std::mt19937 gen(rd());\n    std::uniform_int_distribution&lt;&gt; distr(1, 1024);\n    for (;;) {\n        int a = distr(gen), b = distr(gen);\n        std::cout &lt;&lt; example(a, b) &lt;&lt; std::endl;\n        sleep(1);\n    }\n    return 0;\n}\n</code></pre> <p>\u5c1d\u8bd5\u8ffd\u8e2a\u5bf9\u5e94\u7a0b\u5e8f\u7684 <code>example()</code> \u51fd\u6570\u8c03\u7528\u3002</p> <p>\u63d0\u793a\uff1aprocfs \u4e2d\u7684 <code>/proc/&lt;pid&gt;/root</code> \u76ee\u5f55\u53ef\u80fd\u4f1a\u6709\u6240\u5e2e\u52a9\u3002</p> <p>\u66f4\u591a\u7684\u4f8b\u5b50\u4e0e\u8bf4\u660e\u53ef\u4ee5\u53c2\u8003\uff1a</p> <ul> <li>The bpftrace One-Liner Tutorial\uff08\u4e2d\u6587\u7248\uff09</li> <li>bpftrace(8) Manual Page</li> </ul>"},{"location":"ops/debug/#supplement","title":"\u8865\u5145\u9605\u8bfb","text":"<ul> <li>Linux debugging, profiling and tracing training Course by bootlin\uff1aBootlin \u516c\u53f8\u63d0\u4f9b\u7684 Linux \u8c03\u8bd5\u7b49\u6709\u5173\u7684\u8d44\u6599\uff0c\u5305\u62ec slides \u548c\u7ec3\u4e60\u5b9e\u9a8c</li> <li>Linux Extended BPF (eBPF) Tracing Tools\uff1a\u8457\u540d\u7684\u7cfb\u7edf\u6027\u80fd\u5206\u6790\u4e13\u5bb6 Brendan Gregg \u6574\u7406\u7684 eBPF \u76f8\u5173\u7684\u5de5\u5177\u8d44\u6599\uff1bBrendan Gregg \u7684\u535a\u5ba2\u4e5f\u6709\u5f88\u591a\u5173\u4e8e\u7cfb\u7edf\u6027\u80fd\u5206\u6790\u7684\u4fe1\u606f\uff0c\u6b64\u5916\u672c\u6587\u7684\u51e0\u5f20\u5de5\u5177\u5408\u96c6\u56fe\u4e5f\u51fa\u81ea\u4ed6\u624b</li> </ul>"},{"location":"ops/network/","title":"\u7f51\u7edc\u7cfb\u7edf","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p>"},{"location":"ops/network/#_2","title":"\u8def\u7531","text":""},{"location":"ops/package/","title":"\u5305\u7ba1\u7406\u5668","text":"<p>\u5728 Linux \u7cfb\u7edf\u4e2d\u5f80\u5f80\u6709\u4e00\u4e9b\u7cfb\u7edf\u8d1f\u8d23\u8f6f\u4ef6\u7684\u5b89\u88c5\uff0c\u5347\u7ea7\uff0c\u5378\u8f7d\u3002\u8fd9\u4e2a\u7cfb\u7edf\u88ab\u79f0\u4f5c\u5305\u7ba1\u7406\u5668\uff08Package Manager\uff09\u3002</p> <p>\u5305\u7ba1\u7406\u5668\u7684\u8303\u7574\u8f83\u5e7f\uff1a\u7ba1\u7406\u7cfb\u7edf\u7684\uff0c\u6bd4\u5982 apt\uff0czypper\uff1b\u7ba1\u7406\u73af\u5883\u7684\uff0c\u6bd4\u5982 conda\uff1b\u7ba1\u7406\u8bed\u8a00\u5305\u7684\uff0c\u6bd4\u5982 pip\uff0cgem\uff1b\u6709\u4e00\u4e9b\u5305\u7ba1\u7406\u5668\u751a\u81f3\u662f\u8bed\u8a00\u7684\u201c\u9644\u5c5e\u201d\uff0c\u5982 cargo</p> <p>\u672c\u6587\u5c06\u7740\u91cd\u8bb2\u89e3 Debian \u7684\u5305\u7ba1\u7406\u5668\u3002</p> <p>Debian \u7684\u5305\u7ba1\u7406\u5668\u662f APT\uff08Advanced package tool\uff09&amp; dpkg \u5176\u4e2d\uff0cdpkg \u8d1f\u8d23\u4e2d\u4f4e\u5c42\u64cd\u4f5c\uff0c\u5305\u62ec.deb \u5305\u7684\u5b89\u88c5\uff0c\u5378\u8f7d\uff0c\u4ee5\u53ca\u4fe1\u606f\u67e5\u8be2\uff0cdpkg \u8fd8\u53ef\u4ee5\u68c0\u67e5\u4f9d\u8d56\u7684\u5b89\u88c5\u60c5\u51b5\u3002</p> <p>APT \u4e3b\u8981\u529f\u80fd\u662f\u89e3\u6790\u5305\u7684\u4f9d\u8d56\u4fe1\u606f\uff0c\u4ece\u7ebf\u4e0a\uff08\u6216\u7ebf\u4e0b\uff09\u7684\u8f6f\u4ef6\u4ed3\u5e93\uff08repository\uff09\u4e0b\u8f7d\uff08\u79bb\u7ebf\u4e0b\u8f7d\uff09.deb \u8f6f\u4ef6\u5305\uff0c\u7136\u540e\u6309\u7167\u5408\u7406\u7684\u987a\u5e8f\u8c03\u7528<code>dpkg</code>\uff0c\u5728\u5fc5\u8981\u65f6\u4f7f\u7528<code>--force</code>\u3002</p>"},{"location":"ops/package/#deb","title":"\u5b89\u88c5\u4e00\u4e2a\u5305\uff08.deb\uff09\u7684\u8fc7\u7a0b","text":"<p>\u5728\u8fd9\u4e00\u6bb5\u4e2d\uff0c\u53ef\u4ee5\u81ea\u5df1\u624b\u64cd\uff08\u5176\u5b9e\u5efa\u8bae\u4e0d\u8981\uff09\u5b89\u88c5\u82e5\u5e72\u5305\uff0c\u8fd9\u91cc\u4ee5<code>apt-utils</code>\u4e3a\u4f8b\u8fdb\u884c\u6f14\u793a\uff0c\u8fd9\u4e2a\u5305\u7684\u4f9d\u8d56\u5728 debian \u73af\u5883\u4e2d\u5e94\u5f53\u5df2\u7ecf\u88ab\u914d\u7f6e\u5b8c\u6210\u3002</p> <ol> <li> <p>\u51c6\u5907\u5de5\u4f5c\uff1a\u83b7\u5f97<code>apt-utils</code>\u7684\u4e0b\u8f7d\u5730\u5740\uff0c\u5e76\u4e14\u5728\u7cfb\u7edf\u4e2d\u4e0b\u8f7d\u3002\u521b\u5efa/tmp/install-temp \u6587\u4ef6\u5939\u3002</p> <pre><code>cd /tmp\nmkdir install-temp\ncd install-temp\nwget http://ftp.cn.debian.org/debian/pool/main/a/apt/apt-utils_2.7.12_amd64.deb\n\n# \u53ef\u4ee5\u89c2\u5bdf\u5305\u7684\u5185\u5bb9\n# dpkg -c apt-utils_2.7.12_amd64.deb\n# apt-file list apt-utils # \u8fd9\u4e2a\u547d\u4ee4\u4f4d\u4e8e apt-file \u5305\u4e2d\n</code></pre> </li> <li> <p>\u89e3\u5305</p> <pre><code>ar -x apt-utils_2.7.12_amd64.deb\n\n# \u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4ee3\u66ff\n\ndpkg-deb -R apt-utils_2.7.12_amd64.deb .\n\n# \u6ce8\u610f\u4e24\u8005\u7ed3\u679c\u4e0d\u540c\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u5e76\u4e14\u89c2\u5bdf\u533a\u522b\n</code></pre> </li> <li> <p>\u79fb\u52a8\u6587\u4ef6</p> <p>\u5c06\u6587\u4ef6\u79fb\u52a8\u81f3\u5176\u5b89\u88c5\u4f4d\u7f6e\uff0c\u8be5\u5305\u7ed3\u6784\u5341\u5206\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5c\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5176\u5b9e\u5305\u542b\u5728\u89e3\u5305\u4e2d\u3002</p> <pre><code>sudo tar xpvf data.tar.xf --directory=/\n\n# \u6216\u8005......\n\nsudo rsync -av usr /\n</code></pre> </li> <li> <p>\u5728 dpkg \u7684\u8f85\u52a9\u6587\u4ef6\u4e2d\u4fee\u6539\u4e3a\u5df2\u5b89\u88c5</p> <p>\u590d\u5236 control.tar.xz \u4e2d\u7684 control\uff0c\u5e76\u6dfb\u52a0\u5230/var/lib/dpkg/status \u4e2d\u7684\u5408\u9002\u4f4d\u7f6e\uff0c\u6dfb\u52a0 Status \u884c\u76ee</p> <p>\u5c06 control.tar.xz \u4e2d\u7684 md5sum \u79fb\u52a8\u5230/var/lib/dpkg/list/\u5305\u540d.md5sum</p> <pre><code>tar tf /tmp/install-temp/data.tar.xz | sed -e 's/^.//' -e 's/^\\/$/\\/\\./' &gt; /var/lib/dpkg/list/\u5305\u540d.list\n</code></pre> <p>\u8fd9\u4e2a\u5305\u7684\u7ed3\u6784\u5341\u5206\u7b80\u5355\uff0c\u4ec5\u4f5c\u53c2\u8003\u7528\uff0c\u5927\u591a\u6570\u7684\u5305\u5305\u542b preinst\uff0cpostinst\uff0cconffiles\uff0cprerm\uff0cpostrm \u7b49\u9644\u52a0\u5c5e\u6027\uff0c\u5b89\u88c5\u8fc7\u7a0b\u6b65\u9aa4\u6bd4\u8be5\u4f8b\u590d\u6742\u5f88\u591a\uff0c\u56e0\u6b64\u8bf7\u614e\u91cd\uff08\u4e0d\u8981\uff09\u4f7f\u7528\u4ee5\u4e0a\u6b65\u9aa4\uff01\u5c3d\u53ef\u80fd\u4f7f\u7528 gpkg \u7b49\u5de5\u5177\u8fdb\u884c\u5305\u7684\u64cd\u4f5c\u3002</p> </li> </ol>"},{"location":"ops/package/#_2","title":"\u914d\u7f6e\u6587\u4ef6\u4e0e\u8f85\u52a9\u6587\u4ef6","text":"<p><code>dpkg</code>\u7684\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e<code>/etc/dpkg/</code>\uff0c\u8f85\u52a9\u6587\u4ef6\u4f4d\u4e8e<code>/var/lib/dpkg/</code></p> <p>APT \u7684\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e<code>/etc/apt</code>\uff0c\u8f85\u52a9\u6587\u4ef6\u4f4d\u4e8e<code>/var/lib/apt</code></p> <p>\u53ef\u4ee5\u89c2\u5bdf<code>/var/lib/apt/lists</code>\u4e2d\u7684\u6587\u4ef6\u4f5c\u4e3a\u53c2\u8003</p> <p>TODO</p>"},{"location":"ops/package/#_3","title":"\u91cd\u8981\u800c\u4e0d\u5e38\u89c1\u7684\u529f\u80fd","text":"<p>TODO</p>"},{"location":"ops/security/","title":"\u5b89\u5168","text":"<p>\u672c\u6587\u521d\u7a3f\u7f16\u5199\u4e2d</p>"},{"location":"ops/security/#what-is-security","title":"\u300c\u5b89\u5168\u300d\u662f\u4ec0\u4e48\uff1f","text":""},{"location":"ops/security/#attackers","title":"\u653b\u51fb\u65b9\u89c6\u89d2\uff1a\u5e38\u89c1\u5b89\u5168\u95ee\u9898\u7b80\u4ecb","text":""},{"location":"ops/security/#defenders","title":"\u9632\u5b88\u65b9\u89c6\u89d2\uff1a\u5982\u4f55\u9632\u5fa1\u653b\u51fb","text":""},{"location":"ops/security/#fakessh","title":"\u8349\u8239\u501f\u7bad\uff0c\u770b\u770b\u4f60\u7684","text":"<p>\u516c\u7f51 SSH \u626b\u63cf\u6bcf\u5929\u3001\u6bcf\u65f6\u6bcf\u523b\u90fd\u5728\u53d1\u751f\uff0c\u800c\u4e14\u8fd9\u79cd\u626b\u63cf\u901a\u5e38\u662f\u81ea\u52a8\u5316\u3001\u6210\u89c4\u6a21\u7684\uff0c\u53ef\u4ee5\u642d\u5efa\u4e00\u4e2a\u5047\u7684 ssh server\uff0c\u6765\u4e00\u7aa5\u653b\u51fb\u8005\u7684\u884c\u4e3a\u3002</p> <pre><code>docker run -it --rm\\\n    -p 127.0.0.1:2022:2022\\\n    -v sshesame-data:/data\\\n    [-v $PWD/sshesame.yaml:/config.yaml]\\\n    ghcr.io/jaksi/sshesame\n</code></pre> <p>sshesame \u4f1a\u5c06\u6240\u6709\u8bb0\u5f55\u7684\u884c\u4e3a\u6253\u5370\u5230 stdout, \u53ef\u4ee5\u4f7f\u7528 <code>docker logs</code> \u67e5\u770b\u3002</p> <p>docker port</p> <p>docker \u4f1a\u4fee\u6539 iptables \u89c4\u5219\uff0c\u901a\u8fc7 <code>-p</code> \u653e\u901a\u7684\u7aef\u53e3\u9ed8\u8ba4\u8bbe\u7f6e\u5728 <code>0.0.0.0</code> \uff08\u5141\u8bb8\u6240\u6709 IP \u8bbf\u95ee\uff09\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u91cc\u8fd9\u662f\u9884\u671f\u7684\u884c\u4e3a\u3002</p> <p>\u5982\u679c\u4f60\u53ea\u5e0c\u671b\u672c\u5730\u8bbf\u95ee\uff08\u5982\u6570\u636e\u5e93\uff09\uff0c\u8bf7\u6307\u5b9a <code>-p 127.0.0.1:2022:2022</code> \u8fd9\u6837\u7684\u53c2\u6570\u3002</p>"},{"location":"ops/security/#lessons","title":"\u6559\u8bad","text":""},{"location":"ops/security/#personal-computer-security","title":"\u4fdd\u62a4\u4e2a\u4eba\u8ba1\u7b97\u673a\u7684\u5b89\u5168","text":"<p>\u65b0\u95fb\u9009\u6458\uff1aSSH \u8f6f\u4ef6\u4e0e\u540e\u95e8</p> <p>Putty\u3001Winscp\u7b49\u6c49\u5316\u7248\u8f6f\u4ef6\u5185\u7f6e\u540e\u95e8\u4e8b\u4ef6 \u4e0a\u4e07\u670d\u52a1\u5668\u8d26\u6237\u6cc4\u9732</p> <p>\u7ecf\u5b89\u5168\u5382\u5546\u8bc1\u5b9e\uff0c\u90e8\u5206\u6c49\u5316\u7248PuTTY\u3001WinSCP\u3001SSH Secure\u7b49\u5f00\u6e90\u8f6f\u4ef6\u5b58\u5728\u540e\u95e8\u7a0b\u5e8f\uff0c\u53ef\u80fd\u5bfc\u81f4Linux\u670d\u52a1\u5668\u7cfb\u7edf\u7ba1\u7406\u5458\u5bc6\u7801\u53ca\u8d44\u6599\u6cc4\u9732\u3002\u6709\u77e5\u60c5\u4eba\u58eb\u900f\u9732\uff0c\u622a\u81f3\u76ee\u524d\uff0cPuTTY\u540e\u95e8\u670d\u52a1\u5668\u53d7\u5bb3\u8d26\u6237\u5df2\u8fbe\u52301\u4e07\u591a\uff0c\u4e14\u4ecd\u5728\u6301\u7eed\u589e\u52a0\u3002</p> <p>\u2026\u2026\u2026\u2026\u5176\u4e2dPuTTY\u4ece\u6ca1\u6709\u5b98\u65b9\u4e2d\u6587\u7248\uff0c\u800cWinSCP\u5df2\u7ecf\u62e5\u6709\u5b98\u65b9\u4e2d\u6587\u7248\u3002\u6700\u8fd1\u6709Linux\u670d\u52a1\u5668\u7ba1\u7406\u5458\u53d1\u73b0\uff0c\u4e0a\u8ff0\u5de5\u5177\u7684\u975e\u5b98\u65b9\u201c\u6c49\u5316\u7248\u201d\u7591\u4f3c\u5185\u7f6e\u540e\u95e8\uff0c\u90e8\u5206\u7f51\u7ad9\u548c\u4f01\u4e1a\u670d\u52a1\u5668\u5df2\u56e0\u6b64\u906d\u5230\u9ed1\u5ba2\u653b\u51fb\uff0c\u5bfc\u81f4\u7cfb\u7edfroot\u5bc6\u7801\u6cc4\u6f0f\u4ee5\u53ca\u8d44\u6599\u6cc4\u6f0f\u3002</p> <p>\u2026\u2026\u2026\u2026PuTTY\u7b49\u8f6f\u4ef6\u672c\u8eab\u662f\u5f00\u6e90\u7684\uff0c\u6c49\u5316\u7248\u5c5e\u4e8e\u201c\u88ab\u4eba\u52a8\u4e86\u624b\u811a\u201d\uff0c\u5b89\u5168\u6027\u5f80\u5f80\u96be\u4ee5\u4fdd\u969c\u3002</p> <p>Trojanized versions of PuTTY utility being used to spread backdoor</p> <p>Researchers believe hackers ... have been pushing a Trojanized version of the PuTTY networking utility in an attempt to backdoor the network of organizations they want to spy on.</p> <p>...at least one customer it serves had an employee who installed the fake network utility by accident...</p> <p>\u603b\u7ed3\uff1a\u8bf7\u6c38\u8fdc\u4ece\u5b98\u7f51\uff08\u4ee5\u53ca\u5176\u4ed6\u53ef\u4fe1\u7684\u6e20\u9053\uff09\u4e0b\u8f7d\u8fd0\u7ef4\u7c7b\u8f6f\u4ef6\uff0c\u5e76\u4e14\u6c38\u8fdc\u4e0d\u8981\u78b0\u8bf8\u5982\u300c\u7834\u89e3\u300d\u300c\u6c49\u5316\u300d\u7248\u672c\u7684\u8fd0\u7ef4\u8f6f\u4ef6\u3002 \u505a\u4e0d\u5230\u8fd9\u4e00\u70b9\u7684\u8fd0\u7ef4\u5e94\u5f53\u88ab\u7acb\u523b\u5f00\u9664\u3002</p> <p>\u65b0\u95fb\u9009\u6458\uff1aLastPass \u4e0e Plex</p> <p>\u80cc\u666f\uff1aLastPass \u662f\u4e00\u6b3e\u514d\u8d39\u7684\u5728\u7ebf\u5bc6\u7801\u7ba1\u7406\u5668\uff0c\u66fe\u7ecf\u51fa\u73b0\u8fc7\u591a\u6b21\u5b89\u5168\u4e8b\u4ef6\uff1bPlex \u662f\u4e00\u6b3e\u5bb6\u5ead\u5a92\u4f53\u670d\u52a1\u5668\u8f6f\u4ef6\u3002</p> <p>Lastpass\u4e8b\u4ef6\u8ffd\u8e2a\uff1a\u9ed1\u5ba2\u5229\u7528Plex\u6f0f\u6d1e\u7a83\u53d6\u4e86\u6838\u5fc3\u5de5\u7a0b\u5e08\u7684\u4e3b\u5bc6\u7801</p> <p>Lastpass \u7ec8\u4e8e\u53c8\u516c\u5e03\u4e86\u88ab\u9ed1\u7684\u8c03\u67e5\u8fdb\u5c55\uff0c\u672c\u6b21\u66f4\u65b0\u7684\u8c03\u67e5\u62a5\u544a\u6307\u51fa\uff1aLastpass \u4e00\u540d\u6838\u5fc3\u5de5\u7a0b\u5e08\u7684\u5bb6\u5ead\u529e\u516c\u7535\u8111\u906d\u5230\u9ed1\u5ba2\u7684\u5165\u3002\u8fd9\u8fd8\u6d89\u53ca\u4e86\u53e6\u5916\u4e00\u6b3e\u77e5\u540d\u8f6f\u4ef6\uff1a\u6d41\u5a92\u4f53\u8f6f\u4ef6 Plex\u3002</p> <p>\u2026\u2026\u2026\u2026</p> <p>\u6700\u521d\u9ed1\u5ba2\u5e94\u8be5\u662f\u5df2\u7ecf\u7784\u51c6 Lastpass \u7684\u8fd9\u540d\u6838\u5fc3\u5de5\u7a0b\u5e08\uff0c\u8be5\u5de5\u7a0b\u5e08\u662f Lastpass \u56db\u540d\u638c\u63e1 DevOps \u89e3\u5bc6\u5bc6\u94a5\u7684\u5de5\u7a0b\u5e08\u4e4b\u4e00\u3002</p> <p>\u9ed1\u5ba2\u901a\u8fc7 Plex \u5b58\u5728\u7684\u8fdc\u7a0b\u4ee3\u7801\u6267\u884c\u6f0f\u6d1e\uff0c\u5728\u8fd9\u540d\u6838\u5fc3\u5de5\u7a0b\u5e08\u7684\u5bb6\u5ead\u529e\u516c\u7535\u8111\u4e0a\u5b89\u88c5\u4e86\u952e\u76d8\u8bb0\u5f55\u5668\uff0c\u5de5\u7a0b\u5e08\u767b\u5f55 DevOps \u65f6\uff0c\u8f93\u5165\u89e3\u5bc6\u5bc6\u94a5 (\u76f8\u5f53\u4e8e\u4e3b\u5bc6\u7801) \u7684\u65f6\u5019\u952e\u76d8\u8bb0\u5f55\u5668\u6210\u529f\u7a83\u53d6\u4e86\u4e3b\u5bc6\u7801\u3002</p> <p>Plex\u6025\u5fd9\u89e3\u91ca\uff1aLastpass\u88ab\u9ed1\u4e0e\u4ed6\u4eec\u65e0\u5173 2\u5e74\u524d\u7684\u6f0f\u6d1e\u90fd\u4e0d\u4fee\u590d</p> <p>\u641e\u7b11\u7684\u662f Plex \u73b0\u5728\u7ad9\u51fa\u6765\u56de\u5e94\u8868\u793a\u81ea\u5df1\u4e0d\u80cc\u9505\uff0c\u56e0\u4e3a\u88ab\u9ed1\u7684 Lastpass \u5de5\u7a0b\u5e08\u4e24\u5e74\u591a\u90fd\u6ca1\u6709\u66f4\u65b0\u81ea\u5df1\u7684 Plex \u8f6f\u4ef6\uff0c\u4e5f\u5c31\u662f\u957f\u671f\u4f7f\u7528\u5e26\u6709\u5b89\u5168\u6f0f\u6d1e\u7684\u7248\u672c\u3002</p> <p>Plex \u79f0 2020 \u5e74 5 \u6708 7 \u65e5\u8be5\u516c\u53f8\u62ab\u9732\u4e86\u4e00\u4e2a\u5b89\u5168\u6f0f\u6d1e\uff0c\u8be5\u6f0f\u6d1e\u5141\u8bb8\u90a3\u4e9b\u6709\u6743\u9650\u8bbf\u95ee\u670d\u52a1\u5668\u7ba1\u7406\u5458 Plex \u8d26\u6237\u7684\u4eba\uff0c\u901a\u8fc7\u76f8\u673a\u4e0a\u4f20\u529f\u80fd\u4e0a\u4f20\u6076\u610f\u6587\u4ef6\u5230\u5a92\u4f53\u5e93\uff0c\u7136\u540e\u5229\u7528\u670d\u52a1\u5668\u6570\u636e\u76ee\u5f55\u7684\u4f4d\u7f6e\u4e0e\u4e0a\u4f20\u7684\u5e93\u91cd\u53e0\uff0c\u5e76\u8ba9\u5a92\u4f53\u670d\u52a1\u5668\u81ea\u52a8\u6267\u884c\u8fd9\u4e2a\u6076\u610f\u6587\u4ef6\u3002</p> <p>\u62ab\u9732\u6f0f\u6d1e\u7684\u5f53\u5929 Plex \u5c31\u63a8\u51fa\u4e86 Plex Media Server v1.19.3 \u7248\u4fee\u590d\u4e86\u8be5\u6f0f\u6d1e\uff0c\u7136\u540e\u81f3\u5c11\u5230 2022 \u5e74 8 \u6708 Lastpass \u5de5\u7a0b\u5e08\u90fd\u6ca1\u6709\u5347\u7ea7\u81ea\u5df1\u7684\u8f6f\u4ef6\u3002</p> <p>\u603b\u7ed3\uff1a\u4fdd\u8bc1\u81ea\u5df1\u5b89\u88c5\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0e\u5e94\u7528\u5b89\u88c5\u4e86\u6700\u65b0\u7684\u5b89\u5168\u66f4\u65b0\uff0c\u5e76\u4e14\u907f\u514d\u7ee7\u7eed\u4f7f\u7528\u5df2\u7ecf\u7ed3\u675f\u652f\u6301\u7684\u8f6f\u4ef6\u3002 endoflife.date \u6574\u7406\u4e86\u4e00\u4e9b\u8f6f\u4ef6\u7684\u652f\u6301\u5468\u671f\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u53c2\u8003\u3002</p> <p>\u771f\u5b9e\u6848\u4f8b\uff1a\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u968f\u610f\u4e0b\u8f7d\u7834\u89e3\u8f6f\u4ef6</p> <p>\u5c0f A \u662f\u4e00\u540d\u5b66\u751f\uff0c\u56e0\u4e3a\u7814\u7a76\u9886\u57df\u7684\u9700\u8981\uff0c\u9700\u8981\u4f7f\u7528\u67d0\u6b3e\u4ed8\u8d39\u7684 CAD \u8f6f\u4ef6\u3002 TA \u5148\u524d\u56e0\u4e3a\u81ea\u5df1\u5199\u7684\u7a0b\u5e8f\u7ecf\u5e38\u88ab\u62a5\u6bd2\uff0c\u56e0\u6b64\u5173\u95ed\u4e86\u6740\u6bd2\u8f6f\u4ef6\u3002 \u641c\u7d22\u540e\uff0cTA \u5728 GitHub \u4e0a\u627e\u5230\u4e86\u4e00\u4e2a\u4ed3\u5e93\uff0c\u4f3c\u4e4e\u662f\u7834\u89e3\u7248\uff1a</p> <p></p> <p>\u5b89\u88c5\u540e\u4f3c\u4e4e\u4e00\u5207\u6b63\u5e38\uff0c\u4f46\u662f\u51e0\u5929\u4e4b\u540e\uff0cTA \u53d1\u73b0\u81ea\u5df1\u7684 GitHub \u8d26\u53f7 star \u4e86\u5947\u602a\u7684\u4ed3\u5e93\uff0c\u5e76\u4e14\u521b\u5efa\u4e86\u4e00\u4e2a\u8be1\u5f02\u7684\u4ed3\u5e93\uff0c\u5185\u5bb9\u4e3a\u70ed\u95e8\u6e38\u620f\u300c\u5e7b\u517d\u5e15\u9c81\u300d\u7684\u7834\u89e3\u7248\u3002TA \u611f\u89c9\u5f88\u8be7\u5f02\uff0c\u56e0\u4e3a\u81ea\u5df1\u7684 GitHub \u8d26\u53f7\u65e9\u5df2\u5f00\u542f\u4e86\u4e24\u6b65\u9a8c\u8bc1\uff082FA\uff09\uff01</p> <p>\u68c0\u67e5 Security Log \u540e\u53d1\u73b0\uff0c\u5728\u4e00\u5929\u524d\uff0c\u6709\u4e00\u4e2a\u6765\u81ea\u82f1\u56fd\u7684 IP \u4f7f\u7528 Windows Chrome\u300c\u5207\u6362\u300d\u4e86\u81ea\u5df1\u5728 Windows \u6d4f\u89c8\u5668\u4e2d\u7684 session \u7684\u56fd\u5bb6\uff0c\u4f46\u662f TA \u6ca1\u6709\u5728 Windows \u4e0b\u4f7f\u7528\u8fc7 Chrome\u3002\u5728\u51fa\u95ee\u9898\u7684\u5f53\u5929\u4e0b\u5348\uff0c\u53e6\u4e00\u4e2a\u6765\u81ea\u4e4c\u514b\u5170\u7684 IP \u4f7f\u7528\u4e00\u4e2a Python \u811a\u672c\u6267\u884c\u4e86\u4e00\u7cfb\u5217\u64cd\u4f5c\uff0c\u5305\u62ec\u521b\u5efa\u4e86\u90a3\u4e2a\u5947\u602a\u7684\u4ed3\u5e93\u3002\u7531\u4e8e\u653b\u51fb\u8005\u76f4\u63a5\u5077\u53d6\u4e86\u6d4f\u89c8\u5668\u7684 session\uff0c\u56e0\u6b64\u975e\u654f\u611f\u64cd\u4f5c\uff08\u4f8b\u5982\u521b\u5efa\u4ed3\u5e93\uff09\u4e0d\u4f1a\u89e6\u53d1\u4e24\u6b65\u9a8c\u8bc1\u3002</p> <p>\u5728\u8bbe\u7f6e\u4e2d\u7684 Sessions \u9875\u9762\u79fb\u9664\u4e86\u5176\u4ed6\u7684 session \u4e4b\u540e\uff0cTA \u68c0\u67e5\u4e86\u81ea\u5df1\u7684\u7535\u8111\uff0c\u5f00\u59cb\u6000\u7591\u8fd9\u4e2a\u300c\u7834\u89e3\u8f6f\u4ef6\u300d\u3002\u5c06\u5b89\u88c5\u5305\u7684 zip \u4e0a\u4f20\u81f3 VirusTotal (1) \u540e\uff0c\u53d1\u73b0\u8fd9\u4e2a\u5b89\u88c5\u5305\u4f1a\u6267\u884c\u5404\u79cd\u53ef\u7591\u884c\u4e3a\uff0c\u4f8b\u5982\u4ece\u7f51\u7edc\u4e0b\u8f7d\u5176\u4ed6\u53ef\u6267\u884c\u7a0b\u5e8f\u5e76\u8fd0\u884c\u3001\u5c06\u81ea\u5df1\u52a0\u5165 Windows Defender \u7684\u767d\u540d\u5355\u7b49\u3002</p> <ol> <li>VirusTotal \u662f\u4e00\u4e2a\u53ef\u4ee5\u4e0a\u4f20\u6587\u4ef6\u8fdb\u884c\u591a\u5f15\u64ce\u626b\u63cf\u7684\u7f51\u7ad9\uff08\u5305\u62ec\u56fd\u9645\u4e0e\u56fd\u5185\u7684\u77e5\u540d\u6740\u6bd2\u8f6f\u4ef6\uff09\uff0c\u5e76\u4e14\u8fd8\u4f1a\u901a\u8fc7\u6c99\u76d2\u8fd0\u884c\u6587\u4ef6\uff0c\u67e5\u770b\u5176\u884c\u4e3a\u3002VirusTotal \u662f\u5b89\u5168\u7814\u7a76\u4eba\u5458\u7684\u5e38\u7528\u5de5\u5177\u4e4b\u4e00\u3002</li> </ol> <p>\u8fdb\u4e00\u6b65\u5206\u6790\u53d1\u73b0\uff0c\u8fd9\u4e2a\u538b\u7f29\u5305\u4ec5\u4ec5\u53ea\u662f\u4e2a\u6076\u610f\u8f6f\u4ef6\u4e0b\u8f7d\u5668\uff1a\u5b83\u4f1a\u4ece Pastebin \u670d\u52a1 (1) \u83b7\u53d6\u6076\u610f\u8f6f\u4ef6\u7684\u4e0b\u8f7d\u94fe\u63a5\uff0c\u4e0b\u8f7d\u540e\u8fd0\u884c\u3002\u800c\u8fd0\u884c\u7684\u6076\u610f\u8f6f\u4ef6\u53c8\u4f1a\u4ece\u653b\u51fb\u8005\u521b\u5efa\u7684 Steam \u7684\u4e2a\u4eba\u9875\u9762\u4e0e Telegram \u9891\u9053\u83b7\u53d6\u653b\u51fb\u6307\u4ee4\uff1a</p> <ol> <li>Pastebin \u662f\u4e00\u4e2a\u6587\u672c\u5206\u4eab\u670d\u52a1\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u4e0a\u9762\u5206\u4eab\u6587\u672c\u3001\u4ee3\u7801\u7b49\u3002\u7531\u4e8e\u5176\u533f\u540d\u6027\uff0c\u4e5f\u7ecf\u5e38\u88ab\u7528\u4e8e\u5206\u4eab\u6076\u610f\u8f6f\u4ef6\u7684\u914d\u7f6e\u6587\u4ef6\u3001\u4e0b\u8f7d\u94fe\u63a5\u7b49\u3002</li> </ol> <p></p> <p>\u4e8e\u662f TA \u7684\u673a\u5668\u5c31\u8fd9\u6837\u6ca6\u9677\u4e86\u3002</p> <p>\u603b\u7ed3\uff1a\u4e0d\u8981\u968f\u4fbf\u5173\u6740\u6bd2\u8f6f\u4ef6\u3001\u8dd1\u7834\u89e3\u7a0b\u5e8f\uff1b\u5c31\u7b97\u771f\u7684\u4e0d\u5f97\u4e0d\u8981\u4e5f\u8bf7\u52a1\u5fc5\u5728\u865a\u62df\u673a\u91cc\u9762\u8fd0\u884c\u3002</p>"},{"location":"ops/service/","title":"\u670d\u52a1\u4e0e\u65e5\u5fd7\u7ba1\u7406","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u73b0\u4ee3\u7684 Linux \u53d1\u884c\u7248\u90fd\u4f7f\u7528 systemd \u6765\u7ba1\u7406\u7cfb\u7edf\u670d\u52a1\uff0c\u56e0\u6b64\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd systemd \u73af\u5883\u4e0b\u7684\u670d\u52a1\u4e0e\u65e5\u5fd7\u7ba1\u7406\uff0cGentoo \u7528\u6237\u8bf7\u7ed5\u9053\u3002</p> <p>\u65e9\u671f\uff082014 \u5e74\u4ee5\u524d\uff09\u8fd8\u6709 SysVinit \u548c Upstart \u7b49\uff0c\u4f46\u73b0\u5728\u5df2\u7ecf\u5f88\u5c11\u89c1\u4e86\u3002SysVinit \u8fd8\u6709\u4e00\u4e2a\u73b0\u4ee3\u5316\u7684\u66ff\u4ee3\u54c1\uff0c\u53eb\u505a OpenRC\u3002</p>"},{"location":"ops/service/#init","title":"Init","text":"<p>Init \u8fdb\u7a0b\u662f Linux \u542f\u52a8\u65f6\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u8d1f\u8d23\u542f\u52a8\u7cfb\u7edf\u7684\u5404\u79cd\u670d\u52a1\u5e76\u6700\u7ec8\u542f\u52a8 shell\u3002\u4f20\u7edf\u7684 init \u7a0b\u5e8f\u4f4d\u4e8e <code>/sbin/init</code>\uff0c\u800c\u73b0\u4ee3\u53d1\u884c\u7248\u4e2d\u5b83\u4e00\u822c\u662f\u6307\u5411 <code>/lib/systemd/systemd</code> \u7684\u8f6f\u94fe\u63a5\uff0c\u5373\u7531 systemd \u4f5c\u4e3a PID 1 \u8fd0\u884c\u3002</p> <p>PID 1 \u5728 Linux \u4e2d\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u5730\u4f4d\uff1a</p> <ul> <li>\u4e0d\u53d7 <code>SIGKILL</code> \u6216 <code>SIGSTOP</code> \u4fe1\u53f7\u5f71\u54cd\uff0c\u4e0d\u80fd\u88ab\u6740\u6b7b\u6216\u6682\u505c\u3002\u7c7b\u4f3c\u5730\uff0c\u5373\u4f7f\u6536\u5230\u4e86\u5176\u4ed6\u672a\u6ce8\u518c\u7684\u4fe1\u53f7\uff0c\u9ed8\u8ba4\u884c\u4e3a\u4e5f\u662f\u5ffd\u7565\uff0c\u800c\u4e0d\u662f\u7ed3\u675f\u8fdb\u7a0b\u6216\u6302\u8d77\u3002</li> <li>\u5f53\u5176\u4ed6\u8fdb\u7a0b\u9000\u51fa\u65f6\uff0c\u8fd9\u4e9b\u8fdb\u7a0b\u7684\u5b50\u8fdb\u7a0b\u4f1a\u7531 PID 1 \u63a5\u7ba1\uff0c\u56e0\u6b64 PID 1 \u9700\u8981\u8d1f\u8d23\u56de\u6536\uff08<code>wait(2)</code>\uff09\u8fd9\u4e9b\u50f5\u5c38\u8fdb\u7a0b\u3002</li> </ul>"},{"location":"ops/service/#systemd","title":"Systemd \u4e0e\u670d\u52a1","text":"<p>Systemd \u662f\u4e00\u5927\u5768\u8f6f\u4ef6\uff0c\u5305\u62ec\u670d\u52a1\u7ba1\u7406\uff08PID 1\uff09\u3001\u65e5\u5fd7\u7ba1\u7406\uff08systemd-journald\uff09\u3001\u7f51\u7edc\u7ba1\u7406\uff08systemd-networkd\uff09\u3001\u672c\u5730 DNS \u7f13\u5b58\uff08systemd-resolved\uff09\u3001\u65f6\u95f4\u540c\u6b65\uff08systemd-timesyncd\uff09\u7b49\uff0c\u672c\u6587\u4e3b\u8981\u5173\u5fc3\u670d\u52a1\u7ba1\u7406\u548c\u65e5\u5fd7\u7ba1\u7406\u3002</p>"},{"location":"ops/service/#unit","title":"Unit","text":"<p>\u5728 systemd \u4e2d\uff0c\u8fd0\u884c\u4e00\u4e2a\u5b8c\u6574\u7cfb\u7edf\u6240\u9700\u7684\u6bcf\u4e2a\u90e8\u4ef6\u90fd\u4f5c\u4e3a\u201c\u5355\u5143\u201d\uff08unit\uff09\u7ba1\u7406\u3002\u4e00\u4e2a unit \u53ef\u4ee5\u662f\u670d\u52a1\uff08<code>.service</code>\uff09\u3001\u6302\u8f7d\u70b9\uff08<code>.mount</code>\uff09\u3001\u8bbe\u5907\uff08<code>.device</code>\uff09\u3001\u5b9a\u65f6\u5668\uff08<code>.timer</code>\uff09\u4ee5\u81f3\u4e8e\u76ee\u6807\uff08<code>.target</code>\uff09\u7b49\uff0c\u5b8c\u6574\u7684\u5217\u8868\u53ef\u4ee5\u5728 <code>systemd.unit(5)</code> \u4e2d\u627e\u5230\u3002</p> <pre><code>graph TD\nU(unit) --&gt; A(service)\nU --&gt; B(mount)\nU --&gt; C(device)\nU --&gt; D(target)\nU --&gt; E(slice)\nU --&gt; F(scope)</code></pre> <p>Systemd unit \u7684\u914d\u7f6e\u6587\u4ef6\u4e3b\u8981\u4ece\u4ee5\u4e0b\u76ee\u5f55\u6309\u987a\u5e8f\u8f7d\u5165\uff0c\u5176\u4e2d\u540c\u540d\u7684\u6587\u4ef6\u53ea\u53d6\u627e\u5230\u7684\u7b2c\u4e00\u4e2a\uff1a</p> <ul> <li><code>/etc/systemd/system</code>\uff1a\u672c\u5730\u914d\u7f6e\u6587\u4ef6\uff0c\u4f18\u5148\u7ea7\u6700\u9ad8\uff0c\u8fd9\u4e5f\u662f\u552f\u4e00\u4e00\u4e2a\u7ba1\u7406\u5458\u53ef\u4ee5\u624b\u52a8\u4fee\u6539\u6587\u4ef6\u7684\u5730\u65b9\u3002</li> <li><code>/run/systemd/system</code>\uff1a\u8fd0\u884c\u65f6\u76ee\u5f55\uff0c\u5b58\u653e\u7531 systemd \u6216\u5176\u4ed6\u7a0b\u5e8f\u52a8\u6001\u521b\u5efa\u7684 unit\u3002\u6ce8\u610f <code>/run</code> \u76ee\u5f55\u91cd\u542f\u540e\u4f1a\u88ab\u6e05\u7a7a\u3002</li> <li><code>/usr/lib/systemd/system</code>\uff1a\u7cfb\u7edf\u914d\u7f6e\u6587\u4ef6\uff0c\u4f18\u5148\u7ea7\u6700\u4f4e\uff0c\u4e00\u822c\u7531\u53d1\u884c\u7248\uff08\u8f6f\u4ef6\u5305\u7ba1\u7406\u5668\uff09\u63d0\u4f9b\u3002</li> </ul> <p>\u5b9e\u9645\u4f1a\u641c\u7d22\u7684\u76ee\u5f55\u6bd4\u8fd9\u591a\u5f97\u591a\uff08\u53c8\u5230\u4e86\u770b man \u7684\u65f6\u5019\u4e86\uff09\uff0c\u4f46\u662f\u4e00\u822c\u53ea\u9700\u8981\u5173\u5fc3\u4e0a\u9762\u8fd9\u4e09\u4e2a\u3002</p> <p>\u5f88\u591a\u901a\u8fc7 <code>systemctl</code> \u547d\u4ee4\u6539\u53d8\u7684\u914d\u7f6e\u90fd\u4f1a\u88ab\u4fdd\u5b58\u5230 <code>/etc/systemd/system</code> \u76ee\u5f55\u4e0b\uff0c\u4f8b\u5982\uff1a</p> <ul> <li><code>systemctl enable [some-unit]</code> \u672c\u8d28\u4e0a\u662f\u5728 <code>/etc/systemd/system</code> \u76ee\u5f55\u4e0b\u521b\u5efa\u8f6f\u94fe\u63a5\u3002</li> <li><code>systemctl disable [some-unit]</code> \u5219\u662f\u5220\u9664\u4e0a\u9762\u521b\u5efa\u7684\u8f6f\u94fe\u63a5\u3002</li> <li><code>systemctl edit [some-unit]</code> \u4f1a\u63d0\u4f9b\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u5e76\u5728\u7f16\u8f91\u5b8c\u4e4b\u540e\u5c06\u5176\u4fdd\u5b58\u5230 <code>/etc/systemd/system/[some-unit].d/override.conf</code> \u6587\u4ef6\u4e2d\uff0c\u5b9e\u73b0\u5bf9 unit \u7684\u4fee\u6539\u3002</li> </ul> <p>\u76f8\u6bd4\u4e8e\u624b\u5de5\u4fee\u6539\u6587\u4ef6\uff0c\u4f7f\u7528 <code>systemctl</code> \u66f4\u52a0\u5b89\u5168\uff0c\u5b83\u4f1a\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\uff0c\u800c\u4e14\u4e0d\u9700\u8981\u518d\u989d\u5916\u8fd0\u884c <code>systemctl daemon-reload</code>\u3002</p> <p>Unit \u7684\u914d\u7f6e\u6587\u4ef6\u662f\u4e00\u4e2a INI \u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u901a\u5e38\u5305\u62ec\u4e00\u4e2a <code>[Unit]</code> section\uff0c\u7136\u540e\u6839\u636e unit \u7684\u7c7b\u578b\u4e0d\u540c\u6709\u4e0d\u540c\u7684 section\u3002\u4f8b\u5982\u4e00\u4e2a\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u4f1a\u6709 <code>[Service]</code> section\uff0c\u5e76\u901a\u5e38\u4f1a\u5305\u542b\u4e00\u4e2a <code>[Install]</code> section\u3002\u4ee5 cron \u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u4f8b\uff1a</p> /lib/systemd/system/cron.service<pre><code>[Unit]\nDescription=Regular background program processing daemon\nDocumentation=man:cron(8)\nAfter=remote-fs.target nss-user-lookup.target\n\n[Service]\nEnvironmentFile=-/etc/default/cron\nExecStart=/usr/sbin/cron -f -P $EXTRA_OPTS\nIgnoreSIGPIPE=false\nKillMode=process\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"ops/service/#unit-dependency","title":"\u987a\u5e8f\u4e0e\u4f9d\u8d56","text":"<p>\u76f8\u6bd4\u4e8e SysVinit\uff08\u5b8c\u5168\u987a\u5e8f\u542f\u52a8\uff09\u548c upstart\uff08\u57fa\u4e8e event \u89e6\u53d1\u7684\u65b9\u5f0f\u6709\u9650\u7684\u5e76\u884c\uff09\uff0csystemd \u7684\u6bcf\u4e2a unit \u90fd\u660e\u786e\u6307\u5b9a\u4e86\u4f9d\u8d56\u5173\u7cfb\uff0c\u5206\u6790\u4f9d\u8d56\u5173\u7cfb\u540e systemd \u5c31\u53ef\u4ee5\u6700\u5927\u5316\u5e76\u884c\u542f\u52a8\u670d\u52a1\uff0c\u8fd9\u6837\u53ef\u4ee5\u5927\u5927\u7f29\u77ed\u542f\u52a8\u65f6\u95f4\u3002</p> <p>Systemd \u4e2d\u7684 unit \u6709\u5f88\u591a\u72b6\u6001\uff0c\u5927\u81f4\u53ef\u4ee5\u5f52\u4e3a\u4ee5\u4e0b\u51e0\u7c7b\uff1a</p> <ul> <li>inactive\uff1a\u672a\u542f\u52a8</li> <li>activating\uff1a\u6b63\u5728\u542f\u52a8</li> <li>active\uff1a\u5df2\u542f\u52a8\uff08\u6210\u529f\uff09</li> <li>deactivating\uff1a\u6b63\u5728\u505c\u6b62</li> <li>failed\uff1a\u542f\u52a8\u5931\u8d25</li> </ul> <p>\u5927\u90e8\u5206\u7cfb\u7edf unit \u90fd\u4f1a\u4f7f\u7528\u4ee5\u4e0b\u51e0\u4e2a\u5b57\u6bb5\uff1a</p> <code>Wants=</code> \u548c <code>Requires=</code> <p>\u6307\u5b9a unit \u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u4f8b\u5982\u7f51\u7edc\u670d\u52a1\u901a\u5e38\u4f1a\u4f9d\u8d56 <code>network.target</code>\uff0c\u5373\u5f53\u7f51\u7edc\u5f00\u59cb\u914d\u7f6e\u65f6\u624d\u4f1a\u8fd0\u884c\u3002 \u4e24\u8005\u90fd\u5728 <code>[Unit]</code> section \u4e2d\u6307\u5b9a\uff0c\u533a\u522b\u5728\u4e8e <code>Requires=</code> \u662f\u5f3a\u4f9d\u8d56\uff0c\u5373\u5982\u679c\u88ab\u4f9d\u8d56\u7684 unit \u6ca1\u6709\u542f\u52a8\u6216\u542f\u52a8\u5931\u8d25\uff0c\u90a3\u4e48\u5f53\u524d unit \u4e5f\u4f1a\u88ab\u6807\u8bb0\u4e3a\u5931\u8d25\uff1b \u800c <code>Wants=</code> \u662f\u5f31\u4f9d\u8d56\uff0c\u5373\u5c1d\u8bd5\u542f\u52a8\u88ab\u4f9d\u8d56\u7684 unit\uff0c\u4f46\u5982\u679c\u5931\u8d25\u4e86\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5f53\u524d unit \u7684\u542f\u52a8\u3002</p> <code>WantedBy=</code> \u548c <code>RequiredBy=</code> <p>\u4e0e\u4e0a\u9762\u4e24\u4e2a\u76f8\u53cd\uff0c\u6307\u5b9a\u4e86\u5176\u4ed6 unit \u4f9d\u8d56\u5f53\u524d unit\u3002 \u8fd9\u4e24\u4e2a\u5b57\u6bb5\u5728 <code>[Install]</code> section \u4e2d\u6307\u5b9a\uff0c\u5e76\u4e14\u4ec5\u5f53\u5bf9\u5e94\u7684 unit \u88ab\u542f\u7528\uff08<code>systemctl enable</code>\uff09\u65f6\u624d\u4f1a\u751f\u6548\u3002</p> <code>Before=</code> \u548c <code>After=</code> <p>\u6307\u5b9a\u542f\u52a8\u987a\u5e8f\uff0c\u5373\u76f8\u5173\u7684 unit \u9700\u8981\u5728\u524d\u8005\u542f\u52a8\u5b8c\u6210\uff0c\u8fdb\u5165 active \u72b6\u6001\u540e\u624d\u4f1a\u5c1d\u8bd5\u542f\u52a8\u3002\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u5728 <code>[Unit]</code> section \u4e2d\u6307\u5b9a\u3002 \u4e0e Wants/Requires \u4e0d\u540c\uff0cBefore/After \u53ea\u662f\u6307\u5b9a\u542f\u52a8\u987a\u5e8f\uff0c\u4e0d\u5f71\u54cd\u4f9d\u8d56\u5173\u7cfb\u3002</p>"},{"location":"ops/service/#target","title":"Target","text":"<p>Target \u662f\u4e00\u7ec4\u670d\u52a1\uff08\u5176\u4ed6 unit\uff09\u7684\u96c6\u5408\uff0c\u901a\u8fc7 target \u8fd9\u6837\u4e00\u5c42\u62bd\u8c61\u53ef\u4ee5\u66f4\u65b9\u4fbf\u5730\u7ba1\u7406\u670d\u52a1\u7684\u542f\u52a8\u987a\u5e8f\uff0c\u7c7b\u4f3c SysVinit \u4e2d\u7684 runlevel\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u201c\u7cfb\u7edf\u542f\u52a8\u76ee\u6807\u201d\u3002 \u4f8b\u5982\u7f51\u7edc\u670d\u52a1\u5e94\u8be5 <code>Requires=network-online.target</code> \u5e76\u4e14 <code>After=network-online.target</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u7f51\u7edc\u670d\u52a1\u5728\u7f51\u7edc\u8fde\u901a\u540e\u518d\u542f\u52a8\u3002</p> <p>Systemd \u5728\u5f00\u673a\u65f6\u4f1a\u5c1d\u8bd5\u542f\u52a8 default.target\uff0c\u8fd9\u4e2a target \u4e00\u822c\u662f\u6307\u5411 graphical.target \u7684\u8f6f\u94fe\u63a5\uff0c\u5373\u542f\u52a8\u56fe\u5f62\u754c\u9762\u76f8\u5173\u7684\u670d\u52a1\uff0c\u53e6\u4e00\u4e2a\u5e38\u89c1\u7684 multi-user.target \u5219\u662f\u547d\u4ee4\u884c\u6a21\u5f0f\u3002</p> systemd target SysVinit runlevel \u8bf4\u660e poweroff.target 0 \u5173\u673a rescue.target 1 \u5355\u7528\u6237\u6a21\u5f0f \uff08\u65e0\uff09 2 \uff08systemd \u4e0d\u4f7f\u7528\u8fd9\u4e2a runlevel\uff09 multi-user.target 3 \u591a\u7528\u6237\u6a21\u5f0f\uff0c\u4f46\u53ea\u6709\u547d\u4ee4\u884c \uff08\u65e0\uff09 4 \uff08systemd \u4e0d\u4f7f\u7528\u8fd9\u4e2a runlevel\uff09 graphical.target 5 \u56fe\u5f62\u754c\u9762 reboot.target 6 \u91cd\u542f emergency.target S \u7d27\u6025\u6a21\u5f0f halt.target \uff08\u65e0\uff09 \u7cfb\u7edf\u5df2\u7ecf\u505c\u6b62\uff0c\u4f46\u662f\u65e2\u4e0d\u65ad\u7535\u4e5f\u4e0d\u91cd\u542f\uff0c\u53ef\u4ee5\u770b\u5230\u5173\u673a\u65e5\u5fd7 <p>\u9ed8\u8ba4\u7684 target \u53ef\u4ee5\u901a\u8fc7 <code>systemctl set-default</code> \u547d\u4ee4\u4fee\u6539\uff0c\u6216\u8005\u5728 GRUB \u4e2d\u4e3a kernel cmdline \u6307\u5b9a <code>systemd.unit=</code>\u3002 \u4e0e\u5176\u4ed6 <code>systemctl</code> \u547d\u4ee4\u4e00\u6837\uff0c\u524d\u8005\u7684\u672c\u8d28\u662f\u521b\u5efa\u4e00\u4e2a\u8f6f\u94fe\u63a5 <code>/etc/systemd/system/default.target</code>\u3002</p>"},{"location":"ops/service/#service","title":"Service","text":"<p>Service \u4e5f\u5c31\u662f\u6211\u4eec\u6700\u5e38\u89c1\u7684\u670d\u52a1\uff0c\u5b83\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u4e00\u4e2a <code>[Service]</code> section\uff0c\u5305\u62ec\u4e86\u670d\u52a1\u7684\u542f\u52a8\u547d\u4ee4\u548c\u4e00\u7cfb\u5217\u5176\u4ed6\u914d\u7f6e\u3002\u4ee5\u4e0a\u9762\u7684 cron \u670d\u52a1\u4e3a\u4f8b\uff1a</p> <ul> <li><code>[Unit]</code> \u90e8\u5206\u6307\u5b9a\u7684 <code>After=remote-fs.target nss-user-lookup.target</code> \u8868\u793a cron \u4f1a\u5728\u7cfb\u7edf\u8fbe\u5230\u8fd9\u4e24\u4e2a target \u4e4b\u540e\u624d\u542f\u52a8\uff0c\u5373\u8fdc\u7a0b\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u5b8c\u6210\u548c\u7528\u6237\u4fe1\u606f\u670d\u52a1\uff08<code>getent passwd</code> \u7b49\u547d\u4ee4\u53ef\u7528\uff09\u90fd\u5df2\u7ecf\u542f\u52a8\u3002</li> <li><code>EnvironmentFile=-/etc/default/cron</code> \u8868\u793a\u4f1a\u8bfb\u53d6 <code>/etc/default/cron</code> \u6587\u4ef6\u4e2d\u7684\u73af\u5883\u53d8\u91cf\u3002\u5f00\u5934\u7684 <code>-</code> \u8868\u793a\u5982\u679c\u8fd9\u4e2a\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u5ffd\u7565\u3002</li> <li> <p><code>ExecStart=/usr/sbin/cron -f -P $EXTRA_OPTS</code> \u6307\u5b9a\u4e86\u670d\u52a1\u7684\u542f\u52a8\u547d\u4ee4\uff0c\u5176\u4e2d <code>$EXTRA_OPTS</code> \u662f\u4ece\u4e0a\u9762\u7684\u6587\u4ef6\u4e2d\u8bfb\u53d6\u7684\u73af\u5883\u53d8\u91cf\u3002</p> <p>Tip</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u5efa\u8bae\u5bf9\u547d\u4ee4\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u56e0\u4e3a systemd \u542f\u52a8\u670d\u52a1\u65f6\u5e76\u4e0d\u4f1a\u4f7f\u7528\u7cfb\u7edf\u914d\u7f6e\u7684 <code>$PATH</code> \u73af\u5883\u53d8\u91cf\uff0c\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u786c\u7f16\u7801\u7684\u5217\u8868\u3002</p> </li> <li> <p><code>Restart=on-failure</code> \u8868\u793a\u670d\u52a1\u5728\u5931\u8d25\u65f6\u4f1a\u81ea\u52a8\u91cd\u542f\u3002<code>Restart=</code> \u7684\u53d6\u503c\u548c\u542b\u4e49\u53ef\u4ee5\u5728 systemd.service \u6587\u6863\u4e2d\u627e\u5230\u3002</p> </li> <li>\u6700\u540e\u7684 <code>[Install]</code> \u90e8\u5206\u6307\u5b9a\u4e86\u670d\u52a1\u7684\u542f\u52a8\u7ea7\u522b\uff0c\u5373 <code>WantedBy=multi-user.target</code> \u8868\u793a\u5728\u591a\u7528\u6237\u6a21\u5f0f\u4e0b\u542f\u52a8\u3002</li> </ul> <p>\u5176\u4ed6\u5e38\u7528\u7684\u914d\u7f6e\u8fd8\u6709\uff1a</p> <code>ExecStartPre=</code>\u3001<code>ExecStartPost=</code>\u3001<code>ExecStopPost=</code> <p>\u5728\u670d\u52a1\u542f\u52a8\u524d\u3001\u542f\u52a8\u540e\u3001\u505c\u6b62\u540e\u6267\u884c\u7684\u547d\u4ee4\u3002\u53ef\u7528\u4e8e\u68c0\u67e5\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u786e\u3001\u521b\u5efa\u4e34\u65f6\u6587\u4ef6\u3001\u6e05\u7406\u4e34\u65f6\u6587\u4ef6\u7b49\u3002\u4f8b\u5982 ssh.service \u5c31\u4f1a\u4f7f\u7528 <code>ExecStartPre=/usr/sbin/sshd -t</code> \u6765\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u786e\u3002</p> <code>ExecReload=</code> <p>\u6307\u5b9a\u91cd\u8f7d\u670d\u52a1\u7684\u547d\u4ee4\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u505a\u6cd5\u662f <code>ExecReload=/bin/kill -HUP $MAINPID</code>\u3002 \u914d\u7f6e\u4e86 <code>ExecReload=</code> \u4e4b\u540e\u5373\u53ef\u4f7f\u7528 <code>systemctl reload [service]</code> \u547d\u4ee4\u6765\u5411\u670d\u52a1\u7684\u4e3b\u8fdb\u7a0b\u53d1\u9001 SIGHUP \u4fe1\u53f7\u3002\u4e00\u4e9b\u670d\u52a1\u8fd8\u6709\u81ea\u5df1\u7684 reload \u547d\u4ee4\uff0c\u4f8b\u5982 nginx \u7684 <code>ExecReload=/usr/sbin/nginx -s reload</code>\u3002</p> <code>Type=</code> <p>\u6307\u5b9a\u670d\u52a1\u7684\u7c7b\u578b\u3002\u5927\u90e8\u5206\u670d\u52a1\u90fd\u7531\u4e00\u4e2a\u5728\u540e\u53f0\u8fd0\u884c\u7684\u8fdb\u7a0b\u7ec4\u6210\uff0c\u6b64\u65f6\u53ef\u4ee5\u7701\u7565 Type \u4f7f\u7528\u9ed8\u8ba4\u503c <code>simple</code>\uff0c\u6216\u8005\u66f4\u63a8\u8350\u7684\u505a\u6cd5\u662f <code>Type=exec</code>\u3002\u5176\u4ed6\u7684\u670d\u52a1\u7c7b\u578b\u53c2\u89c1\u4e0b\u9762\u7684 Service Type \u4e00\u8282\u3002</p> <code>User=</code>\u3001<code>Group=</code> \u548c <code>SupplementaryGroups=</code> <p>\u6307\u5b9a\u8fd0\u884c\u670d\u52a1\u7684\u7528\u6237\u548c\u7ec4\uff0c\u4ee5\u53ca\u989d\u5916\u7684\u9644\u52a0\u7ec4\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u670d\u52a1\u4f1a\u4ee5 <code>root</code> \u7528\u6237\u8fd0\u884c\uff0c\u5982\u679c\u6709\u5b89\u5168\u548c\u6743\u9650\u7ba1\u7406\u7684\u9700\u6c42\uff0c\u90a3\u4e48\u4f60\u5e94\u8be5\u914d\u7f6e\u8fd9\u51e0\u9879\u8bbe\u7f6e\u3002</p> <p>Tip</p> <p>\u5982\u679c\u4f60\u6709\u989d\u5916\u7684\u5b89\u5168\u9700\u6c42\uff0c\u53ef\u4ee5\u53c2\u8003 Sandboxing \u4e00\u8282\u4f7f\u7528 systemd \u63d0\u4f9b\u7684\u9ad8\u7ea7\u9694\u79bb\u529f\u80fd\u3002</p>"},{"location":"ops/service/#service-type","title":"Service Type","text":"simple \u548c exec <p>\u662f\u6700\u5e38\u89c1\u7684\u670d\u52a1\u7c7b\u578b\uff0c\u670d\u52a1\u4e3b\u4f53\u662f\u4e00\u4e2a\u957f\u671f\u8fd0\u884c\u7684\u8fdb\u7a0b\u3002 \u4e24\u8005\u7684\u533a\u522b\u5728\u4e8e <code>simple</code> \u7c7b\u578b\u201c\u542f\u52a8\u5373\u6210\u529f\u201d\uff0c\u5373 <code>systemctl start</code> \u4f1a\u7acb\u523b\u6210\u529f\u9000\u51fa\uff1b \u800c <code>exec</code> \u7c7b\u578b\u4f1a\u786e\u4fdd <code>ExecStart=</code> \u547d\u4ee4\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u5305\u62ec <code>User=</code> \u548c <code>Group=</code> \u5b58\u5728\u3001\u6240\u6307\u5b9a\u7684\u547d\u4ee4\u5b58\u5728\u4e14\u53ef\u6267\u884c\u7b49\u3002 \u56e0\u6b64\u73b0\u4ee3\u7684\u670d\u52a1\u5e94\u8be5\u5c3d\u91cf\u4f7f\u7528 <code>Type=exec</code>\u3002</p> forking <p>\u4e00\u4e9b\u4f20\u7edf\u7684\u670d\u52a1\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u542f\u52a8\u547d\u4ee4\u4f1a fork \u51fa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u7136\u540e\u9000\u51fa\uff0c\u5b9e\u9645\u670d\u52a1\u7531\u8fd9\u4e2a\u5b50\u8fdb\u7a0b\u63d0\u4f9b\u3002 \u8fd9\u79cd\u670d\u52a1\u9700\u8981\u914d\u7f6e <code>PIDFile=</code>\uff0c\u4ee5\u4fbf systemd \u80fd\u591f\u6b63\u786e\u8ffd\u8e2a\u670d\u52a1\u7684\u4e3b\u8fdb\u7a0b\u3002\u5f53 <code>PIDFile=</code> \u6307\u5b9a\u7684\u6587\u4ef6\u5b58\u5728\u4e14\u5305\u542b\u4e00\u4e2a\u6709\u6548\u7684 PID \u65f6\uff0csystemd \u8ba4\u4e3a\u670d\u52a1\u5df2\u7ecf\u542f\u52a8\u6210\u529f\u3002</p> oneshot <p>\u4e00\u6b21\u6027\u670d\u52a1\uff0c\u5373\u542f\u52a8\u540e\u8fd0\u884c\u4e00\u6b21 <code>ExecStart=</code> \u547d\u4ee4\uff0c\u7136\u540e\u9000\u51fa\u3002 \u8fd9\u4e2a Type \u6709\u4e24\u79cd\u4f7f\u7528\u573a\u666f\uff1a</p> <ol> <li>\u4e00\u6b21\u6027\u7684\u521d\u59cb\u5316\u6216\u8005\u6e05\u7406\u5de5\u4f5c\u3001\u6216\u8005\u6539\u53d8\u7cfb\u7edf\u72b6\u6001\u7684\u547d\u4ee4\u7b49\uff08\u5982\u4e00\u4e9b <code>ip</code> \u547d\u4ee4\uff09\uff1b</li> <li>\u548c timer \u914d\u5408\u4f7f\u7528\uff0c\u5373\u5b9a\u65f6\u4efb\u52a1\u3002</li> </ol> <p>\u5982\u679c\u4f60\u6709 Type=oneshot \u7684\u670d\u52a1\uff0c\u90a3\u4e48\u4f60\u5f88\u53ef\u80fd\u4e5f\u60f3\u914d\u7f6e <code>RemainAfterExit=yes</code>\uff0c\u8fd9\u6837\u914d\u7f6e\u7684\u547d\u4ee4\u6267\u884c\u5b8c\u6210\u540e\u4f1a\u4e00\u76f4\u4fdd\u6301 active \u72b6\u6001\u3002</p> notify \u548c dbus <p>\u7c7b\u4f3c <code>simple</code> \u548c <code>exec</code>\uff0c\u4f46\u662f\u670d\u52a1\u4f1a\u5728\u542f\u52a8\u5b8c\u6210\u540e\u4e3b\u52a8\u901a\u77e5 systemd\u3002 \u4e0e\u524d\u9762\u7684\u7c7b\u578b\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u7c7b\u670d\u52a1\u9700\u8981\u7a0b\u5e8f\u4e3b\u52a8\u652f\u6301 <code>sd_notify</code> \u6216\u8005 D-Bus \u63a5\u53e3\u3002</p>"},{"location":"ops/service/#timers","title":"\u5b9a\u65f6\u4efb\u52a1","text":"<p>Systemd \u63d0\u4f9b\u4e86 timer \u7c7b\u578b\u7684 unit\uff0c\u7528\u4e8e\u5b9a\u65f6\u6267\u884c\u4efb\u52a1\u3002\u4e00\u4e2a timer unit \u901a\u5e38\u4f1a\u5bf9\u5e94\u4e00\u4e2a service unit\uff0c\u5373\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u70b9\u6216\u8005\u65f6\u95f4\u95f4\u9694\u89e6\u53d1 service \u7684\u542f\u52a8\u3002</p> <p>\u76f8\u6bd4\u4e8e\u66f4\u5e38\u89c1\u7684\u5b9a\u65f6\u4efb\u52a1\u65b9\u6848 CRON\uff0csystemd timers \u5177\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a</p> <ul> <li> <p>\u66f4\u4e30\u5bcc\u7684\u65f6\u95f4\u8868\u8fbe\u5f0f\uff0c\u9664\u4e86\u7b49\u4ef7\u4e8e crontab \u7684 <code>OnCalendar=</code> \u65f6\u95f4\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>OnUnitActiveSec=</code>\uff08\u670d\u52a1\u542f\u52a8\u540e\uff09\u3001<code>OnBootSec=</code>\uff08\u7cfb\u7edf\u542f\u52a8\u540e\uff09\u7b49\u6307\u5b9a\u5176\u4ed6\u65f6\u95f4\u8ba1\u7b97\u65b9\u5f0f\u3002</p> <ul> <li> <p>\u4f8b\u5982\uff0c<code>systemd-tmpfiles-clean.timer</code> \u5c31\u662f\u5728\u7cfb\u7edf\u542f\u52a8\u540e 15 \u5206\u949f\u89e6\u53d1\u4e00\u6b21 <code>systemd-tmpfiles-clean.service</code>\uff0c\u7136\u540e\u6bcf\u5929\u89e6\u53d1\u4e00\u6b21\uff0c\u7528\u4e8e\u6e05\u7406\u4e34\u65f6\u6587\u4ef6\u3002</p> /lib/systemd/system/systemd-tmpfiles-clean.timer<pre><code>[Timer]\nOnBootSec=15min\nOnUnitActiveSec=1d\n</code></pre> </li> </ul> </li> <li> <p>\u66f4\u52a0\u7cbe\u786e\u7684\u65f6\u95f4\u63a7\u5236\uff0c\u901a\u8fc7 <code>AccuracySec=</code> \u53ef\u4ee5\u652f\u6301\u79d2\u7ea7\u751a\u81f3\u66f4\u7ec6\u7684\u65f6\u95f4\u7cbe\u5ea6\u3002     \u4e00\u822c\u4e0d\u63a8\u8350\u5c0f\u4e8e 1 \u5206\u949f\u7684\u65f6\u95f4\u7cbe\u5ea6\uff0c\u5426\u5219\u7cfb\u7edf\u8ba1\u65f6\u5668\u9700\u8981\u9891\u7e41\u5524\u9192\uff0c\u53ef\u80fd\u4f1a\u5f71\u54cd\u7cfb\u7edf\u6027\u80fd\u3002</p> </li> <li><code>RandomizedDelaySec=</code> \u53ef\u4ee5\u914d\u7f6e\u6bcf\u6b21\u89e6\u53d1\u65f6\u968f\u673a\u5ef6\u8fdf\u7684\u65f6\u95f4\uff0c\u907f\u514d\u5927\u91cf\u670d\u52a1\u5728\u540c\u4e00\u65f6\u95f4\u70b9\u542f\u52a8\u3002     \u8fd9\u5728\u4f7f\u7528\u540c\u4e00\u4efd\u7cfb\u7edf\u955c\u50cf\u90e8\u7f72\u5927\u91cf\u865a\u62df\u673a\u6216\u7c7b\u4f3c\u573a\u666f\u4e0b\u975e\u5e38\u6709\u7528\uff0c\u53ef\u4ee5\u907f\u514d\u5927\u91cf\u8ba1\u5212\u4efb\u52a1\u540c\u65f6\u89e6\u53d1\uff0c\u5bfc\u81f4\u7cfb\u7edf\u8d1f\u8f7d\u8fc7\u9ad8\u3002</li> <li><code>Persistent=</code> \u53ef\u4ee5\u786e\u4fdd\u5982\u679c\u56e0\u5173\u673a\u3001\u91cd\u542f\u7b49\u539f\u56e0\u9519\u8fc7\u4e86\u8bbe\u5b9a\u65f6\u95f4\uff0c\u5b9a\u65f6\u4efb\u52a1\u4f1a\u5728\u4e0b\u6b21\u7cfb\u7edf\u542f\u52a8\u540e\u4f1a\u7acb\u5373\u6267\u884c\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7 <code>systemctl enable</code> \u548c <code>systemctl disable</code> \u542f\u7528\u548c\u7981\u7528\u5b9a\u65f6\u4efb\u52a1\uff0c\u800c\u65e0\u9700\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u3002     \u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>systemctl status</code> \u67e5\u770b timer \u548c service \u7684\u72b6\u6001\uff0c\u4ee5\u53ca <code>journalctl</code> \u67e5\u770b\u65e5\u5fd7\u3002</li> <li>\u57fa\u4e8e service \u800c\u4e0d\u662f\u7b80\u5355\u8fd0\u884c\u547d\u4ee4\u7684\u4f18\u70b9\uff1a<ul> <li>\u4eab\u53d7 service \u7684\u5168\u90e8\u597d\u5904\uff0c\u5982\u4f9d\u8d56\u7ba1\u7406\u3001\u73af\u5883\u53d8\u91cf\u3001\u81ea\u52a8\u91cd\u542f\u7b49\uff0c\u4e5f\u5305\u62ec\u5b89\u5168\u4e0e\u9694\u79bb\u7b49\u9ad8\u7ea7\u529f\u80fd\u3002</li> <li>\u5229\u7528 service \u5355\u5b9e\u4f8b\u7684\u7279\u6027\uff0c\u907f\u514d\u4e00\u4e2a\u4efb\u52a1\u540c\u65f6\u8fd0\u884c\u591a\u4efd\u5b9e\u4f8b\uff0c\u5373\u5f53\u4efb\u52a1\u5df2\u7ecf\u5728\u8fd0\u884c\u800c\u6ca1\u6709\u7ed3\u675f\u65f6\uff0c\u4e0d\u4f1a\u7ee7\u7eed\u542f\u52a8\u65b0\u7684\u8fdb\u7a0b\u3002\u5728 cron \u4e2d\uff0c\u8fd9\u901a\u5e38\u9700\u8981\u501f\u52a9\u989d\u5916\u7684\u5de5\u5177\u5b9e\u73b0\uff0c\u5982 <code>flock(1)</code>\u3002</li> </ul> </li> </ul> <p>Timers \u7684\u4e3b\u8981\u7f3a\u70b9\u662f\uff1a</p> <ul> <li>\u914d\u7f6e\u6587\u4ef6\u7e41\u7410\uff0c\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u81f3\u5c11\u9700\u8981\u521b\u5efa\u4e24\u4e2a\u6587\u4ef6\uff0c\u4e00\u4e2a\u662f timer unit\uff0c\u4e00\u4e2a\u662f\u5bf9\u5e94\u7684 service unit\u3002\u76f8\u6bd4\u4e8e\u5728 crontab \u4e2d\u6dfb\u52a0\u4e00\u884c\u914d\u7f6e\uff0c\u6570\u5341\u884c\u7684\u914d\u7f6e\u6587\u4ef6\u4e0d\u5f97\u4e0d\u8bf4\u590d\u6742\u3002</li> <li>\u6ca1\u6709 cron \u7684\u90ae\u4ef6\u901a\u77e5\u529f\u80fd\u3002\u4f46\u662f service \u7684\u8f93\u51fa\u53ef\u4ee5\u8bb0\u5f55\u5230\u65e5\u5fd7\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>journalctl</code> \u67e5\u770b\uff1b\u4e5f\u53ef\u4ee5\u4e3a service \u6307\u5b9a <code>StandardOutput=</code> \u548c <code>StandardError=</code> \u624b\u52a8\u91cd\u5b9a\u5411\u8f93\u51fa\u3002</li> </ul> <p>\u53e6\u5916\uff0c\u7b2c\u4e09\u65b9\u5f00\u53d1\u7684 systemd-cron \u9879\u76ee\u63d0\u4f9b\u4e86\u4e00\u4e2a cron \u7684\u66ff\u4ee3\u65b9\u6848\uff0c\u5b83\u4f7f\u7528 systemd \u7684 generator \u63a5\u53e3\u5c06 crontab \u7ffb\u8bd1\u6210 systemd timer \u548c service\uff0c\u7136\u540e\u7531 systemd \u8d1f\u8d23\u8fd9\u4e9b timer \u548c service \u7684\u89e6\u53d1\u548c\u8fd0\u884c\u3002</p>"},{"location":"ops/service/#create-timer","title":"\u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1","text":"<p>\u5982\u4e0a\u6240\u8ff0\uff0c\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u5305\u542b\u4e24\u4e2a\u6587\u4ef6\uff0c\u4e00\u4e2a\u662f timer unit\uff0c\u4e00\u4e2a\u662f\u5bf9\u5e94\u7684 service unit\u3002\u4e0b\u9762\u4ee5 certbot \u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u4f8b\uff0c\u8bf4\u660e\u5982\u4f55\u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a service\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f <code>Type=oneshot</code>\uff0c\u5e76\u4e14\u4e0d\u80fd\u4f7f\u7528 <code>RemainAfterExit=yes</code>\uff08\u4e00\u822c\u5c06\u5176\u5ffd\u7565\u5373\u53ef\uff0c\u5b83\u7684\u9ed8\u8ba4\u503c\u662f no\uff09\u3002</p> /lib/systemd/system/certbot.service<pre><code>[Unit]\nDescription=Certbot\nDocumentation=file:///usr/share/doc/python-certbot-doc/html/index.html\nDocumentation=https://certbot.eff.org/docs\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/certbot -q renew\nPrivateTmp=true\n</code></pre> <p>\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a timer\uff0c\u6307\u5b9a\u89e6\u53d1\u65f6\u95f4\uff0c\u5e76\u6309\u9700\u542f\u7528 <code>Persistent=</code>\u3002</p> /lib/systemd/system/certbot.timer<pre><code>[Unit]\nDescription=Run certbot twice daily\n\n[Timer]\nOnCalendar=*-*-* 00,12:00:00\nRandomizedDelaySec=43200\nPersistent=true\n\n[Install]\nWantedBy=timers.target\n</code></pre> <p>\u6b64\u65f6 <code>certbot.timer</code> \u4f1a\u81ea\u52a8\u89e6\u53d1\u540c\u540d\u7684 service\uff0c\u4e5f\u5c31\u662f <code>certbot.service</code>\u3002</p> <p>\u5728\u7f16\u8f91\u5b8c\u4e24\u4e2a\u6587\u4ef6\u4e4b\u540e\uff0c\u9700\u8981\u8fd0\u884c <code>systemctl daemon-reload</code> \u4f7f systemd \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>systemctl start certbot.timer</code> \u542f\u52a8\u5b9a\u65f6\u5668\uff0c\u6216\u8005\u4f7f\u7528 <code>systemctl enable certbot.timer</code> \u8ba9\u5176\u5f00\u673a\u542f\u52a8\u3002</p>"},{"location":"ops/service/#log","title":"\u65e5\u5fd7\u7ba1\u7406","text":""},{"location":"ops/service/#systemd-journald","title":"Systemd-journald","text":"<p>Journald \u662f systemd \u5957\u4ef6\u4e2d\u8d1f\u8d23\u7ba1\u7406\u65e5\u5fd7\u7684\u90e8\u5206\u3002\u4e0e\u4f20\u7edf\u7684 <code>/var/log/*.log</code> \u6587\u4ef6\u4e0d\u540c\uff0cjournald \u80fd\u591f\u5904\u7406\u7ed3\u6784\u5316\u6570\u636e\uff08\u4f8b\u5982 KV\uff09\uff0c\u5e76\u4e14\u5c06\u65e5\u5fd7\u4ee5\u4e8c\u8fdb\u5236\u5f62\u5f0f\u4fdd\u5b58\u3002\u56e0\u6b64 systemd-journald \u7684\u65e5\u5fd7\u4e0d\u80fd\u7b80\u5355\u901a\u8fc7\u6587\u672c\u67e5\u770b\u5668\uff08<code>less</code>\u3001<code>vim</code> \u7b49\uff09\u67e5\u770b\uff0c\u9700\u8981\u901a\u8fc7 <code>journalctl</code> \u7ba1\u7406\u3002</p> <p>\u4e00\u4e9b\u5e38\u7528\u7684\u9009\u9879\u548c\u53c2\u6570\uff1a</p> \u9009\u9879 \u8bf4\u660e <code>-u [unit]</code> \u53ea\u663e\u793a\u6307\u5b9a unit \u7684\u65e5\u5fd7 <code>-e</code> \u663e\u793a\u6700\u65b0\u7684\u65e5\u5fd7\uff08\u81ea\u52a8\u5c06 less \u8df3\u8f6c\u5230\u672b\u5c3e\uff09 <code>-f</code> \u5b9e\u65f6\u67e5\u770b\u65e5\u5fd7\uff08\u7c7b\u4f3c <code>tail -f</code>\uff09 <code>-x</code> \u4e3a\u4e8b\u4ef6\u663e\u793a\u989d\u5916\u7684\u89e3\u91ca\u5185\u5bb9\uff0c\u5982\u670d\u52a1\u542f\u52a8\u3001\u505c\u6b62\u7b49 <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cjournald \u4f1a\u5c06\u65e5\u5fd7\u5b58\u50a8\u5728 <code>/var/log/journal</code> \u76ee\u5f55\u4e0b\uff0c\u5982\u679c\u8fd9\u4e2a\u76ee\u5f55\u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u5219\u4f1a\u4f7f\u7528 <code>/run/log/journal</code>\u3002\u7531\u4e8e <code>/run</code> \u76ee\u5f55\u4f7f\u7528 tmpfs\uff0c\u82e5\u914d\u7f6e\u4e0d\u5f53\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5185\u5b58\u5360\u7528\u8fc7\u9ad8\uff0c\u4e14\u91cd\u542f\u540e\u65e5\u5fd7\u4e22\u5931\u3002</p> <p>Journald \u7684\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>/etc/systemd/journald.conf</code>\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>journald.conf(5)</code> \u67e5\u770b\u6240\u6709\u7684\u914d\u7f6e\u9879\uff0cDebian \u4e5f\u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u5185\u4ee5\u6ce8\u91ca\u7684\u5f62\u5f0f\u63d0\u4f9b\u6240\u6709\u914d\u7f6e\u7684\u9ed8\u8ba4\u503c\u3002\u4e00\u4e9b\u5e38\u89c1\u7684\u914d\u7f6e\u9879\u6709\uff1a</p> \u914d\u7f6e\u9879 \u8bf4\u660e Storage= \u6307\u5b9a\u65e5\u5fd7\u5b58\u50a8\u65b9\u5f0f\uff0c\u53ef\u4ee5\u662f <code>auto</code>\u3001<code>volatile</code>\u3001<code>persistent</code> \u548c <code>none</code> SystemMaxUse=SystemKeepFree= \u6307\u5b9a\u7cfb\u7edf\u65e5\u5fd7\uff08<code>/var/log/journal</code>\uff09\u7684\u6700\u5927\u5360\u7528\u7a7a\u95f4\u6216\u4fdd\u8bc1\u78c1\u76d8\u7684\u7a7a\u4f59\u7a7a\u95f4 RuntimeMaxUse=RuntimeKeepFree= \u6307\u5b9a\u8fd0\u884c\u65f6\u65e5\u5fd7\uff08<code>/run/log/journal</code>\uff09\u7684\u6700\u5927\u5360\u7528\u7a7a\u95f4\u6216\u4fdd\u8bc1\u78c1\u76d8\u7684\u7a7a\u4f59\u7a7a\u95f4 MaxRetentionSec=MaxFileSec= \u6307\u5b9a\u65e5\u5fd7\u5185\u5bb9\u548c\u65e5\u5fd7\u6587\u4ef6\u7684\u6700\u5927\u4fdd\u5b58\u65f6\u95f4 <p>\u907f\u514d\u8986\u76d6\u7531\u5305\u7ba1\u7406\u5668\u7ba1\u7406\u7684\u6587\u4ef6</p> <p>\u81ea systemd v249 \u8d77\uff08Ubuntu 22.04\uff0cDebian 12 Bookworm\uff09\uff0c\u6240\u6709 <code>/etc/systemd/*.conf</code> \u6587\u4ef6\u5747\u652f\u6301 <code>*.conf.d</code> \u76ee\u5f55\uff0c\u5373\u53ef\u4ee5\u521b\u5efa <code>/etc/systemd/journald.conf.d/</code> \u76ee\u5f55\uff0c\u5e76\u5728\u5176\u4e2d\u521b\u5efa\u6587\u4ef6\u6765\u8986\u76d6\u9ed8\u8ba4\u914d\u7f6e\uff0c\u800c\u65e0\u9700\u4fee\u6539 <code>*.conf</code> \u6587\u4ef6\u672c\u8eab\uff0c\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u907f\u514d\u5728\u8f6f\u4ef6\u5305\u66f4\u65b0\u6216\u7cfb\u7edf\u5347\u7ea7\u65f6\u5904\u7406\u914d\u7f6e\u6587\u4ef6\u7684\u4fee\u6539\u51b2\u7a81\u3002</p> <p>\u4f8b\u5982\uff0c\u8981\u9650\u5236\u78c1\u76d8\u5360\u7528\uff08<code>/var/log/journal</code>\uff09\u4e3a 1G\uff0c\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6587\u4ef6\uff0c\u7136\u540e\u91cd\u542f <code>systemd-journald</code> \u670d\u52a1\uff1a</p> /etc/systemd/journald.conf.d/override.conf<pre><code>[Journal]\nSystemMaxUse=1G\n</code></pre> <p>\u5982\u679c\u4f60\u9700\u8981\u624b\u52a8\u6e05\u7406\u65e5\u5fd7\uff0c\u91ca\u653e\u78c1\u76d8\u7a7a\u95f4\u7684\u8bdd\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>journalctl --vacuum-size=100M</code> \u6765\u6e05\u7406\u65e5\u5fd7\uff0cjournald \u4f1a\u5220\u9664\u65e5\u5fd7\uff0c\u76f4\u5230\u78c1\u76d8\u5360\u7528\u5c0f\u4e8e 100M\u3002\u53e6\u5916\u6709\u4e24\u4e2a\u7c7b\u4f3c\u7684\u53c2\u6570 <code>--vacuum-time=</code> \u548c <code>--vacuum-files=10</code> \u4e5f\u53ef\u53c2\u8003\u3002</p>"},{"location":"ops/service/#logrotate","title":"logrotate","text":"<p>\u6309\u7167 Unix \u7684\u201c\u4e00\u4e2a\u7a0b\u5e8f\u53ea\u505a\u4e00\u4ef6\u4e8b\u201d\u7684\u8bbe\u8ba1\u601d\u60f3\uff0c\u4e00\u822c\u7684\u7a0b\u5e8f\u53ea\u7ba1\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230\u6307\u5b9a\u5730\u65b9\uff0c\u56e0\u6b64\u6709\u4e86 logrotate \u8fd9\u4e2a\u5de5\u5177\u6765\u8d1f\u8d23\u65e5\u5fd7\u7684\u201c\u6eda\u52a8\u201d\uff08rotate\uff09\uff0c\u5373\u91cd\u547d\u540d\u3001\u538b\u7f29\u3001\u5220\u9664\u7b49\u64cd\u4f5c\u3002</p> <p>logrotate \u7684\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>/etc/logrotate.conf</code>\uff0c\u800c\u6bcf\u4e2a\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u5219\u4f4d\u4e8e <code>/etc/logrotate.d/</code> \u76ee\u5f55\u4e0b\u3002\u4ee5 Telegraf \u4e3a\u4f8b\uff0c\u5176\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> /etc/logrotate.d/telegraf<pre><code>/var/log/telegraf/telegraf.log\n{\n    rotate 6\n    daily\n    missingok\n    dateext\n    copytruncate\n    notifempty\n    compress\n}\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u7684\u5f00\u5934\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u6587\u4ef6\uff08\u6bcf\u884c\u4e00\u4e2a\uff0c\u53ef\u4ee5\u4f7f\u7528 shell \u7684\u901a\u914d\u7b26\uff09\uff0c\u7136\u540e\u662f\u4e00\u7cfb\u5217\u7684\u914d\u7f6e\u9879\u3002\u5e38\u89c1\u7684\u914d\u7f6e\u9879\u6709\uff1a</p> rotate &lt;n&gt; <p>\u4fdd\u7559\u7684\u989d\u5916\u65e5\u5fd7\u6587\u4ef6\u6570\u91cf\u3002\u4f8b\u5982 <code>rotate 6</code> \u4f1a\u4fdd\u7559 <code>example.log</code>\u3001<code>example.log.1</code> \u76f4\u5230 <code>example.log.6</code>\uff0c\u800c <code>example.log.7</code> \u5219\u4f1a\u76f4\u63a5\u5220\u9664\u3002</p> daily / weekly / monthly / yearly <p>rotate \u7684\u9891\u7387\uff0c\u4e5f\u8bb8\u4f60\u5e76\u4e0d\u9700\u8981\u4f7f\u7528\u540e\u4e24\u8005\u3002</p> missingok / notifempty <p>\u7279\u6b8a\u60c5\u51b5\u7684\u5904\u7406\u65b9\u5f0f\uff08\u89c1\u8fd9\u4e24\u4e2a\u9009\u9879\u7684\u5b57\u9762\u542b\u4e49\uff09\u3002</p> dateext / dateformat <p>\u4f7f\u7528\u65e5\u671f\u4f5c\u4e3a\u540e\u7f00\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 <code>.1</code>\u3001<code>.2</code> \u7b49\u3002\u53e6\u6709 <code>dateyesterday</code> \u9009\u9879\uff0c\u5373\u4f7f\u7528\u6628\u5929\u7684\u65e5\u671f\u6765\u547d\u540d\uff0c\u4fdd\u8bc1\u6587\u4ef6\u540d\u4e2d\u7684\u65e5\u671f\u548c\u6587\u4ef6\u5185\u5bb9\u5c3d\u53ef\u80fd\u4e00\u81f4\u3002</p> copytruncate <p>\u5c06\u6587\u4ef6\u5185\u5bb9\u590d\u5236\u5230\u65b0\u6587\u4ef6\uff0c\u7136\u540e\u6e05\u7a7a\u539f\u6587\u4ef6\u3002\u7a0b\u5e8f\u9700\u8981\u4ee5 <code>O_APPEND</code> \u7684\u65b9\u5f0f\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u9020\u6210\u9519\u4e71\u3002</p> <p>\u9002\u7528\u4e8e\u4e0d\u652f\u6301\u901a\u8fc7 <code>SIGHUP</code> \u7b49\u65b9\u5f0f\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\u7684\u7a0b\u5e8f\u3002\u5bf9\u4e8e\u652f\u6301\u201c\u91cd\u8f7d\u65e5\u5fd7\u6587\u4ef6\u201d\u7684\u7a0b\u5e8f\uff0c\u4e0d\u63a8\u8350\u4f7f\u7528\u8fd9\u4e2a\u9009\u9879\u3002</p> create &lt;mode&gt; &lt;owner&gt; &lt;group&gt; <p>\u521b\u5efa\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6\u65f6\u7684\u6743\u9650\u548c\u6240\u6709\u8005\u3002\u5982\u679c\u7a0b\u5e8f\u53ef\u4ee5\u81ea\u5df1\u521b\u5efa\u65e5\u5fd7\u6587\u4ef6\uff0c\u90a3\u4e48\u53ef\u4ee5\u5ffd\u7565\u3002</p> compresscompresscmduncompresscmdcompressextcompressoptions <p>\u538b\u7f29\u65e7\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u4ee5\u53ca\u538b\u7f29\u53c2\u6570\uff08\u9ed8\u8ba4\u4f7f\u7528 <code>gzip</code> / <code>gunzip</code> / <code>.gz</code> / <code>-9</code>\uff09\u3002\u5176\u4e2d <code>compress</code> \u662f\u5f00\u5173\uff0c\u9ed8\u8ba4\u884c\u4e3a\u662f <code>nocompress</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f7f\u7528 Zstd \u538b\u7f29\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>compresscmd /usr/bin/zstd\nuncompresscmd /usr/bin/unzstd\ncompressext .zst\ncompressoptions -13 -T0\n</code></pre> delaycompress <p>\u4e0d\u538b\u7f29\u521a rotate \u51fa\u6765\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u5373\u4fdd\u7559 <code>example.log</code> \u548c <code>example.log.1</code>\uff0c\u538b\u7f29 <code>.2</code> \u5f00\u59cb\u7684\u65e5\u5fd7\u6587\u4ef6\u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u9009\u9879\uff0c\u90a3\u4e48 <code>example.log.1</code> \u4f1a\u88ab\u538b\u7f29</p> prerotate / postrotate <p>\u5728 rotate \u4e4b\u524d/\u4e4b\u540e\u6267\u884c\u7684\u547d\u4ee4\uff0c\u547d\u4ee4\u5757\u9700\u8981\u4ee5 <code>endscript</code> \u7ed3\u675f\u3002\u4e0e Makefile / Dockerfile \u7b49\u8bed\u6cd5\u7c7b\u4f3c\uff0c\u6bcf\u884c\u4e3a\u5355\u72ec\u7684\u4e00\u4e2a\u547d\u4ee4\uff0c\u56e0\u6b64\u5982\u679c\u8981\u5c06 <code>if</code> \u7b49 shell \u8bed\u6cd5\u5199\u6210\u591a\u884c\uff0c\u9700\u8981\u5728\u9664\u4e86\u6700\u540e\u4e00\u884c\u4ee5\u5916\u7684\u6bcf\u4e00\u884c\u672b\u5c3e\u4f7f\u7528\u53cd\u659c\u6760\uff0c\u907f\u514d\u88ab\u89e3\u91ca\u6210\u591a\u6761\u547d\u4ee4\u3002</p> <p>\u4f8b\u5982\uff0cNginx \u8f6f\u4ef6\u5305\u63d0\u4f9b\u7684\u914d\u7f6e\u5c31\u4f1a\u5728 rotate \u4e4b\u540e\u91cd\u8f7d Nginx\uff1a</p> /etc/logrotate.d/nginx<pre><code>postrotate\n    invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1\nendscript\n</code></pre> <p>\u4fee\u6539\u4e86 logrotate \u7684\u914d\u7f6e\u6587\u4ef6\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>logrotate -d /etc/logrotate.conf</code> \u6765\u6d4b\u8bd5\u914d\u7f6e\u6587\u4ef6\u7684\u6b63\u786e\u6027\uff0c\u800c\u4e0d\u4f1a\u771f\u6b63\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002</p> <p>\u540c\u65f6\u7531\u4e8e logrotate \u4e0d\u5b58\u5728\u5b88\u62a4\u8fdb\u7a0b\uff0c\u800c\u662f\u901a\u8fc7 systemd timer \u6765\u5b9a\u671f\u6267\u884c\u7684\uff0c\u56e0\u6b64\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u4e4b\u540e\u4e0d\u9700\u8981\u91cd\u542f\u4efb\u4f55\u670d\u52a1\u3002</p>"},{"location":"ops/network-service/","title":"\u7f51\u7edc\u670d\u52a1\u5b9e\u8df5","text":"<p>\u672c\u90e8\u5206\u4ecb\u7ecd\u5728 Linux \u670d\u52a1\u5668\u4e0a\u8fdb\u884c\u7684\u4e00\u4e9b\u7f51\u7edc\u670d\u52a1\u5b9e\u8df5\u3002</p>"},{"location":"ops/network-service/intranet/","title":"\u96a7\u9053\u7ec4\u7f51","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u5728\u7f51\u7edc\u4e2d\uff0c\u96a7\u9053\u662f\u4e00\u79cd\u5c06\u6570\u636e\u5305\u4ece\u4e00\u4e2a\u7f51\u7edc\u8282\u70b9\u5c01\u88c5\u5e76\u4f20\u8f93\u5230\u53e6\u4e00\u4e2a\u7f51\u7edc\u8282\u70b9\u7684\u6280\u672f\u3002\u5b83\u53ef\u4ee5\u7528\u4e8e\u5728\u4e24\u4e2a\u4e0d\u540c\u7684\u7f51\u7edc\u4e4b\u95f4\u5efa\u7acb\u865a\u62df\u8fde\u63a5\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u7ed5\u8fc7\u9632\u706b\u5899\u6216\u5176\u4ed6\u7f51\u7edc\u9650\u5236\u3002</p> <p>\u5728\u96a7\u9053\u4e2d\uff0c\u6570\u636e\u5305\u4f1a\u88ab\u5c01\u88c5\u5728\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5305\u4e2d\uff0c\u5e76\u4f7f\u7528\u96a7\u9053\u534f\u8bae\u8fdb\u884c\u4f20\u8f93\u3002</p> <p>\u5728\u865a\u62df\u4e13\u7528\u7f51\u7edc\uff08VPN\uff09\u4e2d\uff0c\u96a7\u9053\u7528\u4e8e\u5c06\u7528\u6237\u8bbe\u5907\u4e0e VPN \u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u52a0\u5bc6\u5e76\u5c01\u88c5\u3002\u8fd9\u4f7f\u5f97\u7528\u6237\u8bbe\u5907\u53ef\u4ee5\u5b89\u5168\u5730\u8fde\u63a5\u5230 VPN \u670d\u52a1\u5668\uff0c\u5e76\u901a\u8fc7 VPN \u670d\u52a1\u5668\u8bbf\u95ee\u53d7\u9650\u7684\u7f51\u7edc\u8d44\u6e90\uff0c\u901a\u5e38\u662f\u5185\u7f51\u73af\u5883\uff08IntraNet\uff09\u4e0b\u7684\u5404\u79cd\u670d\u52a1\u3002</p> <p>\u5982\u4eca\u7565\u663e\u9648\u65e7\u7684 PPTP\u3001SSTP\u3001L2TP \u534f\u8bae\u4e0b\u9762\u4e0d\u518d\u63d0\u53ca\u3002\u4e00\u4e9b\u9ad8\u6821\u548c\u4f01\u4e1a\u4f7f\u7528\u7684\u6df1\u4fe1\u670d EasyConnect \u7531\u4e8e\u670d\u52a1\u7aef\u5e76\u672a\u653e\u51fa\uff0c\u4e14\u5176\u4ecd\u5728\u4f7f\u7528\u8fc7\u65f6\u7684 Java applet \u5b9e\u73b0 SSL VPN\uff0c\u56e0\u6b64\u7565\u8fc7\u3002</p>"},{"location":"ops/network-service/intranet/#ipsec","title":"IPsec","text":"<p>\u6807\u51c6\u5316\u7a0b\u5ea6\u9ad8\uff0c\u652f\u6301\u5e7f\u6cdb</p>"},{"location":"ops/network-service/intranet/#gre-over-ipsec","title":"GRE over IPsec","text":""},{"location":"ops/network-service/intranet/#ikev2","title":"IKEv2","text":"<p>IKEv2 \u662f\u4e00\u79cd\u5b89\u5168\u6027\u9ad8\u3001\u6613\u4e8e\u914d\u7f6e\u7684 VPN \u534f\u8bae\uff0c\u7531 IPsec \u8d1f\u8d23\u6570\u636e\u7684\u4f20\u8f93\u5b89\u5168\uff0c\u57fa\u4e8e UDP \u534f\u8bae\u3002\u5927\u90e8\u5206\u7cfb\u7edf\u90fd\u5185\u5efa\u4e86\u5bf9 IKEv2 \u534f\u8bae\u7684\u652f\u6301\u3002</p>"},{"location":"ops/network-service/intranet/#strongswan","title":"\u5b89\u88c5 strongSwan","text":"<p>\u5728 Linux \u4e0a\u7684\u5f00\u6e90 IKEv2/IPsec \u5b9e\u73b0\u6709 strongSwan\u3001Libreswan\uff0c\u548c\u5df2\u7ecf\u505c\u6b62\u66f4\u65b0\u7684 Openswan\u3002\u672c\u6587\u4f7f\u7528 strongSwan\u3002</p> <p>\u5927\u591a\u6570\u73b0\u4ee3 Linux \u53d1\u884c\u7248\u90fd\u53ef\u4ee5\u76f4\u63a5\u4ece\u5b98\u65b9\u4ed3\u5e93\u4e2d\u5b89\u88c5 strongSwan\u3002\u4f8b\u5982\uff0c\u5728\u57fa\u4e8e Debian \u7684\u7cfb\u7edf\uff08\u5982 Ubuntu\uff09\u4e0a\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>sudo apt update\nsudo apt install strongswan\n</code></pre> <p>strongSwan \u5f53\u524d\u63d0\u4f9b\u591a\u79cd daemon\uff1a</p> <ul> <li><code>strongswan-starter.service</code> \u6765\u81ea <code>strongswan-starter</code></li> <li><code>strongswan.service</code> \u6765\u81ea <code>charon-systemd</code></li> </ul> <p>TODO</p> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5982 yangzhaofengsteven/strongswan \u7b49 docker \u955c\u50cf\u3002</p>"},{"location":"ops/network-service/intranet/#_2","title":"\u914d\u7f6e\u8bc1\u4e66\u548c\u8def\u7531","text":""},{"location":"ops/network-service/intranet/#anyconnect","title":"AnyConnect","text":"<p>AnyConnect \u662f\u7531\u601d\u79d1\u5f00\u53d1\u7684\u4e13\u7528 VPN \u534f\u8bae\uff0c\u7531 TLS \u8d1f\u8d23\u6570\u636e\u7684\u4f20\u8f93\u5b89\u5168\u3002\u5176\u5ba2\u6237\u7aef\u6613\u4e8e\u4f7f\u7528\u3001\u5e76\u4e14\u8de8\u5e73\u53f0\uff0c\u8be5\u534f\u8bae\u8f83\u4e3a\u6d41\u884c\u3002</p> <p>\u7136\u800c AnyConnect \u4f5c\u4e3a Cisco \u4e13\u6709\u534f\u8bae\uff0c\u6211\u4eec\u4e00\u822c\u4f7f\u7528\u517c\u5bb9 AnyConnect \u534f\u8bae\u7684\u670d\u52a1\u7aef openconnect/ocserv\u3002</p>"},{"location":"ops/network-service/intranet/#ocserv","title":"\u5b89\u88c5 ocserv","text":"<p>yangzhaofengsteven/ocserv docker \u955c\u50cf</p>"},{"location":"ops/network-service/intranet/#openvpn","title":"OpenVPN","text":"<p>OpenVPN \u662f\u4e00\u6b3e\u5f00\u6e90\u7684 VPN \u534f\u8bae\uff0c\u4f7f\u7528 TLS \u8fdb\u884c\u8ba4\u8bc1\u3002\u76f8\u6bd4\u5176\u4ed6\u534f\u8bae\uff0c\u5176\u670d\u52a1\u7aef\u6027\u80fd\u5f00\u9500\u8f83\u5927\u3002</p>"},{"location":"ops/network-service/intranet/#wireguard","title":"WireGuard","text":"<p>WireGuard \u662f\u4e00\u79cd\u73b0\u4ee3\u7684 VPN \u534f\u8bae\uff0c\u901f\u5ea6\u5feb\u3001\u914d\u7f6e\u7b80\u5355\u3001\u5b89\u5168\u6027\u826f\u597d\uff0c\u57fa\u4e8e UDP \u534f\u8bae\u3002</p>"},{"location":"ops/network-service/intranet/#wireguard_1","title":"\u5b89\u88c5 WireGuard","text":"<p>\u5927\u591a\u6570\u73b0\u4ee3 Linux \u53d1\u884c\u7248\u90fd\u53ef\u4ee5\u76f4\u63a5\u4ece\u5b98\u65b9\u4ed3\u5e93\u4e2d\u5b89\u88c5 WireGuard\u3002\u4f8b\u5982\uff0c\u5728\u57fa\u4e8e Debian \u7684\u7cfb\u7edf\uff08\u5982 Ubuntu\uff09\u4e0a\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>sudo apt update\nsudo apt install wireguard\n</code></pre> <p>\u5728 Red Hat \u6216 Fedora \u7cfb\u5217\u7684\u7cfb\u7edf\u4e0a\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>dnf</code>\uff1a</p> <pre><code>sudo dnf install wireguard-tools\n</code></pre>"},{"location":"ops/network-service/intranet/#_3","title":"\u751f\u6210\u5bc6\u94a5\u5bf9","text":"<p>\u6bcf\u4e2a WireGuard \u63a5\u53e3\u90fd\u9700\u8981\u4e00\u4e2a\u79c1\u94a5\u548c\u516c\u94a5\u3002<code>wg genkey</code> \u751f\u6210\u4e00\u4e2a\u79c1\u94a5\uff0c<code>wg pubkey</code> \u6839\u636e\u8f93\u5165\u7684\u79c1\u94a5\u8f93\u51fa\u516c\u94a5\u3002</p> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u751f\u6210\u5bc6\u94a5\u5bf9\uff1a</p> <pre><code>wg genkey | tee privatekey | wg pubkey &gt; publickey\n</code></pre> <p>\u8fd9\u5c06\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u751f\u6210\u4e24\u4e2a\u6587\u4ef6\uff1a<code>privatekey</code> \u548c <code>publickey</code>\u3002</p>"},{"location":"ops/network-service/intranet/#_4","title":"\u521b\u5efa\u914d\u7f6e\u6587\u4ef6","text":"<p>\u8fd9\u91cc\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684\u573a\u666f\u4e3a\u4f8b\uff0c\u4e24\u53f0\u673a\u5668 A \u548c B \u8fdb\u884c\u7ec4\u7f51\u3002\u5176\u4e2d A \u6709\u516c\u7f51 IP\uff0c\u5bf9\u5e94\u57df\u540d <code>example.com</code>\u3002</p> <p>A \u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>[Interface]\nAddress = 10.0.0.1/24\nListenPort = 51820\nPrivateKey = &lt;A \u7684\u79c1\u94a5&gt;\n\n[Peer]\nPublicKey = &lt;B \u7684\u516c\u94a5&gt;\nAllowedIPs = 10.0.0.4/32\n</code></pre> <p>B \u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>[Interface]\nAddress = 10.0.0.4/24\nPrivateKey = &lt;B \u7684\u79c1\u94a5&gt;\n\n[Peer]\nPublicKey = &lt;A \u7684\u516c\u94a5&gt;\nEndpoint = example.com:51820\nAllowedIPs = 10.0.11.0/24\nPersistentKeepalive = 25\n</code></pre> <p>\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5bc6\u94a5\u7684\u66ff\u6362\u6210\u5bc6\u94a5\u7684\u5185\u5bb9\uff0c\u800c\u4e0d\u662f\u5bc6\u94a5\u6587\u4ef6\u7684\u8def\u5f84\u3002</p> <p>\u8bbe\u5907 A \u7684 VPN \u5185\u90e8 IP \u5730\u5740\u8bbe\u7f6e\u4e3a <code>10.0.0.1</code>\uff0c\u8bbe\u5907 B \u7684 VPN \u5185\u90e8 IP \u5730\u5740\u8bbe\u7f6e\u4e3a <code>10.0.0.4</code>\uff0c\u5b50\u7f51\u63a9\u7801\u4e3a 24 \u4f4d\u3002</p> <p><code>PersistentKeepalive = 25</code> \u4ee3\u8868\u6bcf 25 \u79d2\u53d1\u9001\u4e00\u4e2a\u65e0\u5b9e\u8d28\u6570\u636e\u7684\u5fc3\u8df3\u5305\uff0c\u7528\u4e8e\u5728 NAT \u6216\u9632\u706b\u5899\u73af\u5883\u4e2d\u4fdd\u6301\u8fde\u63a5\u6d3b\u8dc3\u3002</p> <p><code>AllowedIPs</code> \u6307\u5b9a\u4e86\u53ef\u4ee5\u901a\u8fc7 VPN \u53d1\u9001\u5230\u54ea\u4e9b IP \u5730\u5740\u7684\u6570\u636e\u3002\u4f8b\u5982 <code>10.0.0.1/32</code> \u8868\u793a\u53ea\u6709\u76ee\u6807\u4e3a <code>10.0.0.1</code> \u7684\u6570\u636e\u5305\u53ef\u4ee5\u901a\u8fc7 VPN \u53d1\u9001\u7ed9\u5bf9\u65b9\u3002</p> <p>\u914d\u7f6e\u6587\u4ef6\u9700\u8981\u5199\u5728 <code>/etc/wireguard/&lt;\u914d\u7f6e\u540d&gt;.conf</code> \u4e2d\u3002\u4f8b\u5982\uff1a<code>/etc/wireguard/wg0.conf</code>\u3002</p>"},{"location":"ops/network-service/intranet/#wireguard_2","title":"\u542f\u52a8 WireGuard \u63a5\u53e3","text":"<p>\u4f7f\u7528 <code>wg-quick</code> \u5de5\u5177\u542f\u52a8 WireGuard \u63a5\u53e3\uff1a</p> <pre><code>sudo wg-quick up wg0\n</code></pre> <p>\u5176\u4e2d <code>wg0</code> \u662f\u914d\u7f6e\u6587\u4ef6\u7684\u540d\u79f0\uff0c\u4e0d\u5305\u62ec <code>.conf</code> \u540e\u7f00\u3002</p>"},{"location":"ops/network-service/intranet/#_5","title":"\u68c0\u67e5\u63a5\u53e3\u72b6\u6001","text":"<p>\u53ef\u4ee5\u4f7f\u7528 <code>wg</code> \u547d\u4ee4\u67e5\u770b\u5f53\u524d\u7684 WireGuard \u72b6\u6001\uff1a</p> <pre><code>sudo wg\n</code></pre>"},{"location":"ops/network-service/intranet/#wireguard_3","title":"\u505c\u6b62 WireGuard \u63a5\u53e3","text":"<p>\u5f53\u4e0d\u518d\u9700\u8981\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u505c\u6b62\u63a5\u53e3\uff1a</p> <pre><code>sudo wg-quick down wg0\n</code></pre>"},{"location":"ops/network-service/network-file/","title":"\u7f51\u7edc\u6587\u4ef6\u5171\u4eab","text":""},{"location":"ops/storage/","title":"\u5b58\u50a8\u7cfb\u7edf","text":"<p>\u672c\u90e8\u5206\u4ecb\u7ecd\u7ef4\u62a4 Linux \u670d\u52a1\u5668\u5b58\u50a8\u7cfb\u7edf\u7684\u6709\u5173\u5185\u5bb9\u3002</p>"},{"location":"ops/storage/filesystem/","title":"\u5206\u533a\u4e0e\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p>"},{"location":"ops/storage/filesystem/#concepts","title":"\u76f8\u5173\u6982\u5ff5","text":"\u5757\u8bbe\u5907 <p>\u5e38\u89c1\u7684\u78c1\u76d8\u8bbe\u5907\u7684\u8bfb\u5199\u5747\u4ee5\u5757\uff08\u800c\u4e0d\u662f\u5b57\u8282\uff09\u4e3a\u5355\u4f4d\uff0c\u56e0\u6b64\u5728 Linux \u4e2d\uff0c\u8bbe\u5907\u6587\u4ef6\u5206\u4e3a\u5757\u8bbe\u5907\u548c\u5b57\u7b26\u8bbe\u5907\u4e24\u79cd\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>lsblk</code> \u547d\u4ee4\u67e5\u770b\u7cfb\u7edf\u4e2d\u7684\u5757\u8bbe\u5907\u3002\u4e00\u4e2a\u684c\u9762\u7cfb\u7edf\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nnvme0n1     259:0    0  1.9T  0 disk \n\u251c\u2500nvme0n1p1 259:1    0  260M  0 part \n\u251c\u2500nvme0n1p2 259:2    0   56G  0 part [SWAP]\n\u2514\u2500nvme0n1p3 259:3    0  1.8T  0 part /var/lib/docker/btrfs\n                                     /var\n                                     /tmp\n                                     /opt\n                                     /home\n                                     /\n</code></pre> \u5206\u533a\u8868 <p>\u4e00\u4e2a\u5757\u8bbe\u5907\u4e0a\u53ef\u4ee5\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5206\u533a\uff0c\u800c\u5206\u533a\u8868\u5219\u8bb0\u5f55\u4e86\u5206\u533a\u7684\u4fe1\u606f\uff0c\u5e38\u89c1\u7684\u5206\u533a\u8868\u6709 MBR \u548c GPT \u4e24\u79cd\u683c\u5f0f\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>fdisk</code> \u67e5\u770b\u5757\u8bbe\u5907\u7684\u5206\u533a\u8868\uff0c\u4f8b\u5982\uff1a</p> <pre><code>$ sudo fdisk -l /dev/nvme0n1\nDisk /dev/nvme0n1: 1.86 TiB, 2048408248320 bytes, 4000797360 sectors\nDisk model: INTEL SSDPEKNU020TZ                     \nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: BAF03C52-854E-41AD-9C42-6DD5C0E9F156\n\nDevice             Start        End    Sectors  Size Type\n/dev/nvme0n1p1      2048     534527     532480  260M EFI System\n/dev/nvme0n1p2    534528  117975039  117440512   56G Linux swap\n/dev/nvme0n1p3 117975040 4000796671 3882821632  1.8T Linux filesystem\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u5757\u8bbe\u5907\u4f7f\u7528\u4e86 GPT \u5206\u533a\u8868\uff0c\u6709\u4e09\u4e2a\u5206\u533a\u3002</p> \u6587\u4ef6\u7cfb\u7edf <p>\u6bcf\u4e2a\u5206\u533a\u9700\u8981\u88ab\u683c\u5f0f\u5316\u6210\u67d0\u79cd\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c\u624d\u80fd\u5b58\u50a8\u6587\u4ef6\u3002</p>"},{"location":"ops/storage/filesystem/#loop","title":"\u672c\u5730\u56de\u73af","text":"<p>Linux \u652f\u6301\u300c\u672c\u5730\u56de\u73af\u8bbe\u5907\u300d\uff0c\u652f\u6301\u6302\u8f7d\u4e00\u4e2a\u6587\u4ef6\u4f5c\u4e3a\u5757\u8bbe\u5907\u4f7f\u7528\uff0c\u7c7b\u4f3c\u4e8e\u300c\u865a\u62df\u5149\u9a71\u300d\u7c7b\u8f6f\u4ef6\u3002 \u56e0\u6b64\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u5730\u56de\u73af\u7684\u65b9\u5f0f\uff0c\u5728\u4e0d\u8d2d\u4e70\u65b0\u786c\u4ef6\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u4e00\u4e9b\u78c1\u76d8\u76f8\u5173\u7684\u5b9e\u9a8c\u3002</p> <p>\u672c\u5730\u56de\u73af\u4e0e\u5bb9\u5668</p> <p>Linux \u76ee\u524d\u4e0d\u652f\u6301\u8bbe\u5907\u547d\u540d\u7a7a\u95f4\uff08\u9694\u79bb\uff09\uff0c\u56e0\u6b64\u5982\u679c\u9700\u8981\u5728\u5bb9\u5668\u73af\u5883\u5185\u5bf9\u672c\u5730\u56de\u73af\u8fdb\u884c\u6302\u8f7d\u7b49\u64cd\u4f5c\uff0c\u9700\u8981\u7279\u6743\u5bb9\u5668\uff0c\u5e76\u4e14\u4e3a root \u6743\u9650\u3002 Linux \u5185\u6838\u5f00\u53d1\u4e2d\u66fe\u6709\u8fc7\u5141\u8bb8\u975e\u7279\u6743\u7528\u6237\u6302\u8f7d\u672c\u5730\u56de\u73af\u7684\u8ba8\u8bba\uff08loopfs LWN\uff09\uff0c \u4f46\u662f\u7531\u4e8e\u5b89\u5168\u6027\u95ee\u9898\uff08\u5185\u6838\u6587\u4ef6\u7cfb\u7edf\u5f00\u53d1\u65f6\u5047\u8bbe\u6302\u8f7d\u7684\u5185\u5bb9\u4e0d\u4f1a\u88ab\u6076\u610f\u6784\u9020\uff0c\u800c\u63d0\u4f9b\u76f8\u5173\u652f\u6301\u4f1a\u7834\u574f\u8fd9\u6837\u7684\u5047\u8bbe\uff09\uff0c\u672a\u8fdb\u5165\u4e3b\u7ebf\u3002</p> <p>\u8fd9\u4e5f\u662f Vlab \u4e0d\u652f\u6301\u672c\u5730\u56de\u73af\u7684\u539f\u56e0\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>mount</code> \u547d\u4ee4\u6302\u8f7d\u6587\u4ef6\u5230\u672c\u5730\u56de\u73af\u3002\u6700\u5e38\u89c1\u7684\u7528\u9014\u662f\u6302\u8f7d\u4e00\u4e2a ISO \u6587\u4ef6\uff1a</p> <pre><code>$ sudo mount -o loop ./debian-12.4.0-amd64-DVD-1.iso /media/iso\n$ cd /media/iso\n$ ls\nboot/  debian@  doc/  firmware/  install.amd/  md5sum.txt  pool/        README.mirrors.html  README.source\ncss/   dists/   EFI/  install/   isolinux/     pics/       README.html  README.mirrors.txt   README.txt\n$ cd\n$ sudo umount /media/iso\n</code></pre> <p>\u4f46\u662f\u6709\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u6302\u8f7d\u6d4b\u8bd5\u78c1\u76d8\u955c\u50cf\u4e2d\u7684\u67d0\u4e2a\u5206\u533a\uff0c\u6b64\u65f6\u4f7f\u7528 <code>mount</code> \u5c31\u4f1a\u9ebb\u70e6\u5f88\u591a\u2014\u2014\u9700\u8981\u8ba1\u7b97\u5bf9\u5e94\u7684\u504f\u79fb\u91cf\u3002 \u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528 <code>kpartx</code> \u547d\u4ee4\uff0c\u5b83\u4f1a\u81ea\u52a8\u8bc6\u522b\u78c1\u76d8\u955c\u50cf\u4e2d\u7684\u5206\u533a\uff0c\u5e76\u521b\u5efa\u5bf9\u5e94\u7684\u56de\u73af\u8bbe\u5907\uff1a</p> <pre><code>$ fdisk -l ./root.img\nDisk ./root.img: 5 GiB, 5368709120 bytes, 10485760 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: 9E89351F-1674-4BA6-9FA3-D063E7C028E0\n\nDevice       Start      End Sectors  Size Type\n./root.img1   2048   499711  497664  243M EFI System\n./root.img2 499712 10483711 9984000  4.8G Linux filesystem\n$ sudo kpartx -av ./root.img\nadd map loop0p1 (254:0): 0 497664 linear 7:0 2048\nadd map loop0p2 (254:1): 0 9984000 linear 7:0 499712\n$ ls -l /dev/mapper/loop0p*\nlrwxrwxrwx 1 root root 7 Feb 10 17:22 /dev/mapper/loop0p1 -&gt; ../dm-0\nlrwxrwxrwx 1 root root 7 Feb 10 17:22 /dev/mapper/loop0p2 -&gt; ../dm-1\n$ sudo mount /dev/mapper/loop0p2 /media/root\n$ ls /media/root\n...\n$ sudo umount /media/root\n$ sudo kpartx -dv ./root.img\ndel devmap : loop0p1\ndel devmap : loop0p2\nloop deleted : /dev/loop0\n</code></pre> <p>\u7cfb\u7edf\u7684\u672c\u5730\u56de\u73af\u4fe1\u606f\u53ef\u4ee5\u4f7f\u7528 <code>losetup</code> \u547d\u4ee4\u67e5\u770b\u3002\u8be5\u547d\u4ee4\u4e5f\u53ef\u4ee5\u7ba1\u7406\u672c\u5730\u56de\u73af\u8bbe\u5907\uff1a</p> <pre><code>$ sudo kpartx -av ./root.img\n...\n$ sudo losetup -a\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ sudo losetup -D\n$ sudo losetup -a  # \u6b63\u5728\u4f7f\u7528\u7684\u8bbe\u5907\u4e0d\u4f1a\u88ab\u7acb\u523b\u5220\u9664\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ sudo losetup --partscan --find ./root2.img  # partscan \u7528\u4e8e\u81ea\u52a8\u8bc6\u522b\u5206\u533a\uff0cfind \u7528\u4e8e\u81ea\u52a8\u5206\u914d\u672c\u5730\u56de\u73af\u8bbe\u5907\n$ # \u4e5f\u53ef\u4ee5\u81ea\u5df1\u6307\u5b9a\u672c\u5730\u56de\u73af\u8bbe\u5907\u8def\u5f84\n$ sudo losetup -a\n/dev/loop1: [0028]:18789360 (/home/username/tmp/root2.img)\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ ls -lha /dev/loop1*  # \u8be5\u955c\u50cf\u4e2d\u5305\u542b\u7684\u4e24\u4e2a\u5206\u533a\u81ea\u52a8\u8bc6\u522b\u4e3a\u4e86 loop1p1 \u548c loop1p2\nbrw-rw---- 1 root disk   7, 1 Feb 10 17:30 /dev/loop1\nbrw-rw---- 1 root disk 259, 4 Feb 10 17:30 /dev/loop1p1\nbrw-rw---- 1 root disk 259, 5 Feb 10 17:30 /dev/loop1p2\n$ sudo losetup -d /dev/loop1\n$ sudo losetup -a\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ sudo kpax -dv ./root.img  # \u6e05\u7406\u73b0\u573a\n$ sudo losetup -a\n</code></pre>"},{"location":"ops/storage/filesystem/#partition","title":"\u5206\u533a\u8868","text":"<p>\u4ee5\u4e0b\u4ecb\u7ecd MBR \u4e0e GPT \u5206\u533a\u8868\u3002</p> <p>MBR\uff08Master Boot Record\uff09\u5206\u533a\u8868\u662f\u65e9\u671f\u7684\u5206\u533a\u8868\u683c\u5f0f\uff0c\u5728\u5b58\u50a8\u5206\u533a\u4fe1\u606f\u7684\u540c\u65f6\uff0c\u8fd8\u8d1f\u8d23\u7cfb\u7edf\u7684\u542f\u52a8\u3002 MBR \u4fe1\u606f\u5b58\u50a8\u5728\u78c1\u76d8\u7684\u7b2c\u4e00\u4e2a\u6247\u533a<sup>1</sup>\uff08512 \u5b57\u8282<sup>2</sup>\uff09\uff0c\u5176\u4e2d\u7528\u4e8e\u5f15\u5bfc\u7684\u4ee3\u7801\u4f4d\u4e8e\u6700\u5f00\u5934\uff0c\u5360\u636e 440 \u5b57\u8282\uff08BIOS \u5728\u542f\u52a8\u4f1a\u52a0\u8f7d\u4ee3\u7801\uff0c\u5e76\u4e14\u8df3\u8f6c\uff09\uff1b \u63d0\u4f9b\u7ed9\u5206\u533a\u4fe1\u606f\u7684\u7a7a\u95f4\u53ea\u6709 64 \u4e2a\u5b57\u8282\u3002\u7531\u4e8e\u6bcf\u4e2a\u5206\u533a\u9700\u8981 16 \u5b57\u8282\u7684\u4fe1\u606f\uff0c\u56e0\u6b64 MBR \u5206\u533a\u8868\u6700\u591a\u652f\u6301 4 \u4e2a\u4e3b\u5206\u533a\u3002 \u4e3a\u4e86\u8ba9\u78c1\u76d8\u652f\u6301\u66f4\u591a\u5206\u533a\uff0c\u51fa\u73b0\u4e86\u6269\u5c55\u5206\u533a\u7684\u6982\u5ff5\u3002 \u6269\u5c55\u5206\u533a\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u4e3b\u5206\u533a\uff0c\u53ef\u4ee5\u5212\u5206\u4e3a\u591a\u4e2a\u903b\u8f91\u5206\u533a\u3002\u53d7\u5230\u8bbe\u8ba1\u9650\u5236\uff0cMBR \u4ec5\u652f\u6301\u6700\u5927 2 TiB \u7684\u78c1\u76d8\u3002</p> <p>\u800c GPT\uff08GUID Partition Table\uff09\u5206\u533a\u8868\u662f\u65b0\u4e00\u4ee3\u7684\u5206\u533a\u8868\u683c\u5f0f\uff0c\u4e0d\u518d\u5b58\u50a8\u5f15\u5bfc\u4fe1\u606f\uff0c\u5e76\u4e14\u652f\u6301\u66f4\u591a\u7684\u5206\u533a\u3001\u66f4\u5927\u7684\u78c1\u76d8\u3002 \u76ee\u524d\u9664\u975e\u6781\u5176\u8001\u65e7\u7684\u7cfb\u7edf\uff0c\u90fd\u4f7f\u7528 GPT \u5206\u533a\u8868\u3002GPT \u5206\u533a\u8868\u5728\u6700\u5f00\u5934\u5b58\u50a8\u4e86\u4e00\u4efd\u300c\u4fdd\u62a4\u6027 MBR\u300d\uff08Protective MBR\uff09\uff0c\u7528\u4e8e\u9632\u6b62\u4e0d\u8ba4\u8bc6 GPT \u7684\u65e7\u7cfb\u7edf\u548c\u8f6f\u4ef6\u5bf9\u78c1\u76d8\u8bef\u64cd\u4f5c\uff0c \u540c\u65f6\u5206\u533a\u8868\u4fe1\u606f\u5728\u78c1\u76d8\u6700\u540e\u6709\u4e00\u4efd\u5907\u4efd\uff0c\u4ee5\u51cf\u5c0f\u635f\u574f\u98ce\u9669\u3002</p> <p>\u90a3 GPT \u7684\u78c1\u76d8\u600e\u4e48\u5f00\u673a\u5462\uff1f</p> <p>\u5bf9\u4e8e\u4f7f\u7528\u4f20\u7edf BIOS \u7684\u673a\u5668\uff0cGPT \u5f00\u5934\u7684\u4fdd\u62a4\u6027 MBR \u4ecd\u7136\u53ef\u4ee5\u5b58\u50a8\u5f15\u5bfc\u4ee3\u7801\u3002\u4e0d\u8fc7\uff0c\u76ee\u524d\u7684\u4e3b\u6d41\u662f\u4f7f\u7528 UEFI\uff0c\u4e0d\u518d\u9700\u8981\u5728\u6247\u533a\u91cc\u5b58\u50a8\u5f15\u5bfc\u4ee3\u7801\uff0c \u800c\u662f\u6709\u4e00\u4e2a\u4e13\u95e8\u7684 EFI \u7cfb\u7edf\u5206\u533a\uff08\u5fc5\u987b\u683c\u5f0f\u5316\u4e3a FAT32\uff09\uff0c\u7528\u6765\u5b58\u50a8\u5f15\u5bfc\u7a0b\u5e8f\u4e0e\u5176\u4ed6\u4fe1\u606f\u3002</p> <p>\u4ee5\u4e0b\u5c55\u793a\u4e00\u4e2a EFI \u7cfb\u7edf\u5206\u533a\u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo mount /dev/disk/by-uuid/0E62-46C6 /efi\n$ mount | grep efi\n...\n/dev/nvme0n1p1 on /efi type vfat (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro)\n$ sudo tree /efi\n/efi/\n\u251c\u2500\u2500 $RECYCLE.BIN\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 desktop.ini\n\u251c\u2500\u2500 BOOT\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 BOOT.SDI\n\u251c\u2500\u2500 EFI\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 arch\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 fw\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 fwupdx64.efi\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Boot\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 bootx64.efi\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 LenovoBT.EFI\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 License.txt\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 ReadMe.txt\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 GRUB\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 grubx64.efi\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 Linux\n\u2514\u2500\u2500 System Volume Information\n    \u251c\u2500\u2500 IndexerVolumeGuid\n    \u2514\u2500\u2500 WPSettings.dat\n\n10 directories, 10 files\n</code></pre> <p>\u8fd9\u91cc <code>efi</code> \u540e\u7f00\u7684\u6587\u4ef6\u5c31\u662f UEFI \u4f1a\u9009\u62e9\u7684\u542f\u52a8\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u4e00\u822c\u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u6309\u4e0b F12 \u6216\u8005\u5176\u4ed6\u5feb\u6377\u952e\u9009\u62e9\u542f\u52a8\u7684\u8bbe\u5907\u6216 EFI \u6587\u4ef6\u3002</p>"},{"location":"ops/storage/filesystem/#partition-exp","title":"\u5b9e\u9a8c\u64cd\u4f5c\u5c55\u793a","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8bf8\u5982 <code>fdisk</code>, <code>parted</code> \u7b49\u5de5\u5177\u5bf9\u5206\u533a\u8868\u8fdb\u884c\u64cd\u4f5c\u3002\u5bf9\u4e8e\u56fe\u5f62\u754c\u9762\u7528\u6237\uff0c<code>gparted</code> \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u7a7a\u6587\u4ef6\uff1a</p> <pre><code>truncate -s 8G test.img\n</code></pre> <p>\u7a00\u758f\u6587\u4ef6</p> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u300c\u7a00\u758f\u6587\u4ef6\u300d\uff08Sparse file\uff09\u3002\u5c3d\u7ba1\u6587\u4ef6\u5927\u5c0f\u662f 8G\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u53ea\u5360\u7528\u4e86\u5f88\u5c11\u7684\u78c1\u76d8\u7a7a\u95f4\u3002\u53ef\u4ee5\u4ee5\u6b64\u9a8c\u8bc1\uff1a</p> <pre><code>$ du -h test.img\n0   test.img\n$ du -h --apparent-size test.img\n8G  test.img\n</code></pre> <p>\u4e4b\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5c\u8fd9\u4e2a\u6587\u4ef6\uff0c\u800c\u4e0d\u7528\u62c5\u5fc3\u7834\u574f\u771f\u5b9e\u7684\u78c1\u76d8\u3002</p> <pre><code>fdisk test.img\n# \u6216\u8005\nparted test.img\n</code></pre> <p>\u4ee5\u4e0b\u7684\u4f8b\u5b50\u4f1a\u521b\u5efa\u4e00\u4e2a 256M \u7684 EFI \u5206\u533a\uff0c\u4e00\u4e2a 1G \u7684 swap \u5206\u533a\uff0c\u5269\u4e0b\u7684\u7a7a\u95f4\u4f5c\u4e3a\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u5206\u533a\u3002</p> fdisk \u64cd\u4f5c\u793a\u4f8b <p>fdisk \u9ed8\u8ba4\u4f7f\u7528 MBR \u5206\u533a\u8868\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528 GPT \u5206\u533a\u8868\uff0c\u9700\u8981\u4f7f\u7528 <code>g</code> \u547d\u4ee4\u3002 \u5728\u521b\u5efa\u5206\u533a\u65f6\uff0c\u6309\u56de\u8f66\u4f7f\u7528\u9ed8\u8ba4\u53c2\u6570\u3002\u8bbe\u7f6e\u5206\u533a\u672b\u5c3e\u4f4d\u7f6e\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>+</code> \u8868\u793a\u76f8\u5bf9\u4e8e\u5f53\u524d\u4f4d\u7f6e\u7684\u504f\u79fb\u91cf\uff08\u5373\u5206\u533a\u5927\u5c0f\uff09\uff0c\u6216\u8005\u4f7f\u7528 <code>-</code> \u8868\u793a\u76f8\u5bf9\u4e8e\u78c1\u76d8\u672b\u5c3e\u7684\u504f\u79fb\u91cf\uff08\u5373\u5728\u5c3e\u90e8\u7559\u51fa\u591a\u5c11\u7a7a\u95f4\uff09\u3002</p> <p>\u6700\u540e\u4f7f\u7528 <code>w</code> \u547d\u4ee4\u5199\u5165\u5206\u533a\u8868\u3002\u5982\u679c\u4e0d\u60f3\u5b9e\u9645\u5199\u5165\u5230\u78c1\u76d8\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>q</code> \u9000\u51fa\u800c\u4e0d\u4fdd\u5b58\u3002 \u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u4f7f\u7528 <code>m</code> \u547d\u4ee4\u67e5\u770b\u5e2e\u52a9\u3002</p> <pre><code>$ fdisk test.img\nWelcome to fdisk (util-linux 2.39.3).\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\nDevice does not contain a recognized partition table.\nCreated a new DOS (MBR) disklabel with disk identifier 0xb7358160.\n\nCommand (m for help): g\nCreated a new GPT disklabel (GUID: E19C12C2-CAB9-4A9A-88D5-2F389F7B4452).\n\nCommand (m for help): n\nPartition number (1-128, default 1): \nFirst sector (2048-16777182, default 2048): \nLast sector, +/-sectors or +/-size{K,M,G,T,P} (2048-16777182, default 16775167): +256M\n\nCreated a new partition 1 of type 'Linux filesystem' and of size 256 MiB.\n\nCommand (m for help): n\nPartition number (2-128, default 2): \nFirst sector (526336-16777182, default 526336): \nLast sector, +/-sectors or +/-size{K,M,G,T,P} (526336-16777182, default 16775167): +1G\n\nCreated a new partition 2 of type 'Linux filesystem' and of size 1 GiB.\n\nCommand (m for help): n\nPartition number (3-128, default 3): \nFirst sector (2623488-16777182, default 2623488): \nLast sector, +/-sectors or +/-size{K,M,G,T,P} (2623488-16777182, default 16775167): \n\nCreated a new partition 3 of type 'Linux filesystem' and of size 6.7 GiB.\n\nCommand (m for help): t\nPartition number (1-3, default 3): 1\nPartition type or alias (type L to list all): L\n\uff08\u7701\u7565\uff09\nPartition type or alias (type L to list all): 1\n\nChanged type of partition 'Linux filesystem' to 'EFI System'.\n\nCommand (m for help): t\nPartition number (1-3, default 3): 2\nPartition type or alias (type L to list all): 19\n\nChanged type of partition 'Linux filesystem' to 'Linux swap'.\n\nCommand (m for help): p\nDisk test.img: 8 GiB, 8589934592 bytes, 16777216 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: E19C12C2-CAB9-4A9A-88D5-2F389F7B4452\n\nDevice       Start      End  Sectors  Size Type\ntest.img1     2048   526335   524288  256M EFI System\ntest.img2   526336  2623487  2097152    1G Linux swap\ntest.img3  2623488 16775167 14151680  6.7G Linux filesystem\n\nCommand (m for help): w\nThe partition table has been altered.\nSyncing disks.\n</code></pre> parted \u64cd\u4f5c\u793a\u4f8b <p>\u8fd9\u91cc\u4e0d\u63a8\u8350\u4ea4\u4e92\u5f0f\u4f7f\u7528 <code>parted</code>\uff0c\u56e0\u4e3a\u5176\u4ea4\u4e92\u4e0d\u5982 <code>fdisk</code> \u76f4\u89c2\uff0c\u5e76\u4e14\u6240\u6709\u64cd\u4f5c\u5747\u4e3a\u7acb\u523b\u5199\u5165\u3002\u4f46\u662f <code>parted</code> \u5728\u811a\u672c\u4e2d\u4f7f\u7528\u66f4\u52a0\u65b9\u4fbf\u3002 parted \u811a\u672c\u7684\u4f8b\u5b50\u53ef\u4ee5\u53c2\u8003 101strap \u811a\u672c\u3002</p> <pre><code>$ parted -a optimal test.img  # \u4f7f\u7528 optimal \u53c2\u6570\uff0c\u5728\u521b\u5efa\u65b0\u5206\u533a\u65f6\u4f7f\u7528\u6700\u4f73\u5bf9\u9f50\nWARNING: You are not superuser.  Watch out for permissions.\nGNU Parted 3.6\nUsing /home/taoky/tmp/201/test.img\nWelcome to GNU Parted! Type 'help' to view a list of commands.\n(parted) mklabel gpt\n(parted) mkpart efi 0% 256M\n(parted) mkpart swap 256M 1289M\n(parted) mkpart rootfs 1289M 100%\n(parted) set 1 esp\nNew state?  [on]/off?\n(parted) set 2 swap\nNew state?  [on]/off?\n(parted) print\nModel:  (file)\nDisk /home/taoky/tmp/201/test.img: 8590MB\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags: \n\nNumber  Start   End     Size    File system  Name    Flags\n1      1049kB  256MB   255MB                efi     boot, esp\n2      256MB   1289MB  1033MB               swap    swap\n3      1289MB  8589MB  7300MB               rootfs\n\n(parted) quit\n</code></pre> <p>\u5728\u521b\u5efa\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>file</code> \u548c <code>fdisk</code> \u5de5\u5177\u9a8c\u8bc1\u5206\u533a\u8868\u7684\u7c7b\u578b\uff1a</p> <pre><code>$ file test.img  # MBR \u53ea\u6709\u4e00\u4e2a\u5206\u533a\uff0c\u5e76\u4e14\u5206\u533a ID \u4e3a 0xee\uff0c\u4ee3\u8868\u8be5\u78c1\u76d8\u955c\u50cf\u4f7f\u7528 GPT\ntest.img: DOS/MBR boot sector; partition 1 : ID=0xee, start-CHS (0x0,0,2), end-CHS (0x3ff,255,63), startsector 1, 16777215 sectors, extended partition table (last)\n$ fdisk -l test.img\nDisk test.img: 8 GiB, 8589934592 bytes, 16777216 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: E19C12C2-CAB9-4A9A-88D5-2F389F7B4452\n\nDevice       Start      End  Sectors  Size Type\ntest.img1     2048   526335   524288  256M EFI System\ntest.img2   526336  2623487  2097152    1G Linux swap\ntest.img3  2623488 16775167 14151680  6.7G Linux filesystem\n</code></pre> <p>\u5982\u679c\u5bf9 GPT \u7684\u7ec6\u8282\u611f\u5174\u8da3\uff0c\u53ef\u4ee5\u4f7f\u7528\u5341\u516d\u8fdb\u5236\u7f16\u8f91\u5668\u67e5\u770b\u955c\u50cf\u5185\u5bb9\uff0c\u5e76\u4e0e GPT \u6807\u51c6\u5bf9\u7167\u3002</p> \u5206\u533a\u5bf9\u9f50 <p>\u89c2\u5bdf fdisk \u7684\u8f93\u51fa\u53ef\u4ee5\u53d1\u73b0\u4e00\u4e9b\u6709\u8da3\u7684\u5730\u65b9\uff1a\u67e5\u627e\u8d44\u6599\u53ef\u4ee5\u77e5\u9053\uff0cGPT \u5206\u533a\u8868\u672c\u8eab\u53ea\u9700\u8981 34 \u4e2a\u6247\u533a\uff0c\u4f46\u662f\u4e0a\u6587\u4e2d\u9996\u4e2a\u5206\u533a\u5374\u4ece\u7b2c 2048 \u4e2a\u6247\u533a\u5f00\u59cb\u3002 \u8fd9\u662f\u57fa\u4e8e\u5c06\u5206\u533a\u4e0e\u7269\u7406\u8bbe\u5907\u7684\u6247\u533a/\u8bbf\u95ee\u8fb9\u754c\u300c\u5bf9\u9f50\u300d\u7684\u8003\u8651\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\u6211\u4eec\u4e00\u822c\u91c7\u53d6 4K\uff088 \u4e2a\u6247\u533a\uff09\u5bf9\u9f50\uff0c\u56e0\u6b64\u8d77\u59cb\u4f4d\u7f6e\u9700\u8981\u4e3a 4K\uff088 \u4e2a\u6247\u533a\uff09\u7684\u6574\u6570\u500d\u3002 2048 \u4e2a\u6247\u533a\u5373 1M\uff0c\u662f\u73b0\u4ee3\u7248\u672c fdisk \u7684\u9ed8\u8ba4\u5bf9\u9f50\u7c92\u5ea6\uff0c\u53ef\u4ee5\u5e94\u5bf9\u672a\u6765\u7684\u5bf9\u9f50\u9700\u6c42\uff0c\u56e0\u6b64\u662f\u4e00\u4e2a\u5408\u7406\u4e14\u88ab\u666e\u904d\u4f7f\u7528\u7684\u9009\u62e9\u3002</p> <p><code>/dev/disk</code></p> <p>\u5728 Linux \u4e2d\uff0c\u786c\u76d8\u8bbe\u5907\u7684\u8bbe\u5907\u6587\u4ef6\u540d\u4e0d\u662f\u56fa\u5b9a\u7684\uff0c\u5982\u679c\u673a\u5668\u6709\u591a\u4e2a\u786c\u76d8\uff0c\u5c31\u53ef\u80fd\u53d1\u751f\u91cd\u542f\u524d\u540d\u4e3a <code>sda</code> \u7684\u8bbe\u5907\u91cd\u542f\u4e4b\u540e\u53d8\u6210\u4e86 <code>sdb</code>  \u7684\u4e8b\u60c5\u3002Linux \u7684\u7528\u6237\u6001\u8bbe\u5907\u7ba1\u7406\u5668 udev \u4f1a\u5728 <code>/dev/disk</code> \u4e0b\u6839\u636e\u4e0d\u540c\u5206\u7c7b\u65b9\u5f0f\uff0c\u63d0\u4f9b\u786c\u76d8/\u5206\u533a\u5230\u5b9e\u9645\u8bbe\u5907\u7684\u8f6f\u94fe\u63a5\u3002 \u5176\u547d\u540d\u4e0d\u4f1a\u5728\u91cd\u542f\u540e\u53d8\u5316\u3002\u4e00\u4e2a\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>$ tree /dev/disk/\n/dev/disk/\n\u251c\u2500\u2500 by-diskseq\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 1 -&gt; ../../nvme0n1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 1-part1 -&gt; ../../nvme0n1p1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 1-part2 -&gt; ../../nvme0n1p2\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 1-part3 -&gt; ../../nvme0n1p3\n\u251c\u2500\u2500 by-id\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-eui.0000000001000000e4d25c8003505301 -&gt; ../../nvme0n1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-eui.0000000001000000e4d25c8003505301-part1 -&gt; ../../nvme0n1p1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-eui.0000000001000000e4d25c8003505301-part2 -&gt; ../../nvme0n1p2\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-eui.0000000001000000e4d25c8003505301-part3 -&gt; ../../nvme0n1p3\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C -&gt; ../../nvme0n1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C_1 -&gt; ../../nvme0n1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C_1-part1 -&gt; ../../nvme0n1p1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C_1-part2 -&gt; ../../nvme0n1p2\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C_1-part3 -&gt; ../../nvme0n1p3\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C-part1 -&gt; ../../nvme0n1p1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C-part2 -&gt; ../../nvme0n1p2\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 nvme-INTEL_SSDPEKNU020TZ_PHKA119600MK2P0C-part3 -&gt; ../../nvme0n1p3\n\u251c\u2500\u2500 by-label\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 SYSTEM -&gt; ../../nvme0n1p1\n\u251c\u2500\u2500 by-partlabel\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 EFI\\x20system\\x20partition -&gt; ../../nvme0n1p1\n\u251c\u2500\u2500 by-partuuid\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 370b0fef-f3fc-4378-a083-c520fc25ccc4 -&gt; ../../nvme0n1p1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 4f2efc48-47e2-f145-828d-af8b385073fc -&gt; ../../nvme0n1p3\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 dd06687c-6b2a-5847-ae83-5c30c21f26cf -&gt; ../../nvme0n1p2\n\u251c\u2500\u2500 by-path\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pci-0000:02:00.0-nvme-1 -&gt; ../../nvme0n1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pci-0000:02:00.0-nvme-1-part1 -&gt; ../../nvme0n1p1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 pci-0000:02:00.0-nvme-1-part2 -&gt; ../../nvme0n1p2\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 pci-0000:02:00.0-nvme-1-part3 -&gt; ../../nvme0n1p3\n\u2514\u2500\u2500 by-uuid\n    \u251c\u2500\u2500 0E62-46C6 -&gt; ../../nvme0n1p1\n    \u251c\u2500\u2500 6c80c677-34e3-4380-8a0e-667a3d7f29e7 -&gt; ../../nvme0n1p2\n    \u2514\u2500\u2500 f744de26-960b-4f60-ba3c-818d5b38c926 -&gt; ../../nvme0n1p3\n\n8 directories, 28 files\n</code></pre> <p>\u5176\u4e2d\u5e38\u89c1\u7684\u76ee\u5f55\u6709\u4ee5\u4e0b\u51e0\u9879\uff1a</p> by-label <p>\u7edd\u5927\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\u90fd\u5141\u8bb8\u7528\u6237\u4e3a\u5176\u8bbe\u7f6e\u300c\u6807\u7b7e\u300d\u3002Windows \u7528\u6237\u53ef\u80fd\u4f1a\u5f88\u719f\u6089\u8fd9\u4e2a\u7279\u6027\uff0c \u56e0\u4e3a\u5728\u300c\u6b64\u7535\u8111\u300d\u4e2d\u663e\u793a\u3001\u8bbe\u7f6e\u7684\u5206\u533a\u540d\u79f0\u5c31\u662f\u8fd9\u91cc\u7684 label\u3002</p> by-partlabel <p>\u8fd9\u4e2a\u300c\u6807\u7b7e\u300d\u5b58\u50a8\u5728 GPT \u5206\u533a\u8868\u4e2d\uff08\u800c\u975e\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff09\uff0c\u4e0d\u968f\u7740\u6587\u4ef6\u7cfb\u7edf\u7684\u6539\u53d8\u800c\u53d8\u5316\u3002</p> by-uuid <p>\u7531\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u7684\u552f\u4e00\u6807\u8bc6\u7b26\u4fe1\u606f\u3002\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u8fd9\u91cc EFI \u5206\u533a\u7531\u4e8e\u662f FAT32\uff0c\u56e0\u6b64\u5b83\u7684 UUID \u76f8\u6bd4\u5176\u4ed6\u7684\u77ed\u5f97\u591a\u3002</p> by-partuuid <p>\u7531 GPT \u5206\u533a\u8868\u63d0\u4f9b\u7684\u552f\u4e00\u6807\u8bc6\u7b26\u4fe1\u606f\u3002</p> by-id <p>\u6839\u636e\u8bbe\u5907\u7684\u5e8f\u5217\u53f7\u7b49\u4fe1\u606f\u63d0\u4f9b\u7684\u8f6f\u94fe\u63a5\uff0c\u5206\u533a\u5219\u4ee5 -partN \u7684\u5f62\u5f0f\u63d0\u4f9b\u3002</p> by-path <p>\u6839\u636e\u7cfb\u7edf sysfs \u63d0\u4f9b\u7684\u4fe1\u606f\u521b\u5efa\u7684\u8f6f\u94fe\u63a5\uff0c\u4f8b\u5982\u8fd9\u91cc\u7684 <code>pci-0000:02:00.0-nvme-1</code> \u5bf9\u5e94\u4e86\uff1a</p> <pre><code>$ pwd\n/sys/block\n$ ls -lha\ntotal 0\ndrwxr-xr-x  2 root root 0 Feb 29 15:58 ./\ndr-xr-xr-x 13 root root 0 Feb 29 15:58 ../\nlrwxrwxrwx  1 root root 0 Feb 27 18:24 nvme0n1 -&gt; ../devices/pci0000:00/0000:00:06.0/0000:02:00.0/nvme/nvme0/nvme0n1/\n</code></pre> <p>\u5373\u4f7f\u5bf9\u4e8e\u5355\u786c\u76d8\u7684\u7528\u6237\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4e5f\u53ef\u80fd\u4f1a\u5728\u4e00\u4e9b\u5730\u65b9\u4f7f\u7528\u5230\uff08\u4f8b\u5982\u914d\u7f6e GRUB \u542f\u52a8\u5668\u7684\u65f6\u5019\uff09\u3002 \u5e76\u4e14\u6709\u5fc5\u8981\u5c0f\u5fc3\u6587\u4ef6\u7cfb\u7edf\u7684 label/uuid \u4e0e GPT \u5206\u533a\u8868\u7684 label/uuid \u7684\u533a\u522b\uff1a \u4f8b\u5982\u683c\u5f0f\u5316\u4e3a\u65b0\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c\u6587\u4ef6\u7cfb\u7edf\u7684\u4fe1\u606f\u4f1a\u88ab\u91cd\u7f6e\uff1b\u800c\u5728\u865a\u62df\u5316\u573a\u666f\u8fdb\u884c\u5206\u533a\u6269\u5bb9\u540e\uff0cGPT \u5206\u533a\u8868\u4e2d\u5bf9\u5e94\u7684\u5206\u533a\u4fe1\u606f\u53ef\u80fd\u4f1a\u88ab\u91cd\u7f6e\u3002</p>"},{"location":"ops/storage/filesystem/#filesystem","title":"\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u4e0b\u8868\u7ed9\u51fa\u4e86\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u5728\u67d0\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u4e00\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u7b2c\u4e09\u65b9\u8f6f\u4ef6\u7684\u65b9\u5f0f\u5b9e\u73b0\u652f\u6301\uff0c\u4f46\u662f\u53ef\u80fd\u5b58\u5728\u989d\u5916\u7684\u6027\u80fd\u6216\u53ef\u9760\u6027\u95ee\u9898\u3002</p> \u6587\u4ef6\u7cfb\u7edf Linux macOS Windows \u7279\u70b9\u4e0e\u5907\u6ce8 FAT32 (VFAT) \u4ec5\u9002\u7528\u4e8e EFI \u5206\u533a\u548c\u90e8\u5206\u60c5\u51b5\u4e0b\u7684 <code>/boot</code>\uff0c\u6216\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u4ea4\u6362\u6587\u4ef6\u7684\u573a\u5408\u3002\u4e0d\u652f\u6301\u5927\u4e8e 4 GiB \u7684\u6587\u4ef6\u3002 exFAT \u5e94\u4ec5\u7528\u4e8e\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u4ea4\u6362\u6587\u4ef6\u3002\u4e0d\u652f\u6301\u65e5\u5fd7\u3002 ext4 Linux \u4e0a\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 XFS \u9002\u7528\u4e8e\u5927\u6587\u4ef6\u3001\u5927\u5bb9\u91cf\u7684\u573a\u5408\u3002\u65e0\u6cd5\u968f\u610f\u7f29\u5c0f<sup>3</sup>\u3002 ReiserFS  (deprecated) \u9002\u7528\u4e8e\u5b58\u50a8\u5927\u91cf\u5c0f\u6587\u4ef6\u7684\u573a\u5408\u3002\u7531\u4e8e\u5185\u6838\u4e3b\u7ebf\u5df2\u7ecf\u8003\u8651\u79fb\u9664\u652f\u6301\uff0c\u5982\u6709\u5b58\u50a8\u5927\u91cf\u5c0f\u6587\u4ef6\u9700\u6c42\uff0c\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u65b9\u6848\u66ff\u4ee3\u3002 Btrfs \u5185\u7f6e\u4e8e Linux \u5185\u6838\u7684\u65b0\u4e00\u4ee3\u7684 CoW \u6587\u4ef6\u7cfb\u7edf\uff0c\u652f\u6301\u5feb\u7167\u3001\u900f\u660e\u538b\u7f29\u7b49\u9ad8\u7ea7\u529f\u80fd\u3002RAID 5/6 \u652f\u6301\u4e0d\u7a33\u5b9a\uff0c\u4e5f\u6709\u5bf9\u6574\u4f53\u7a33\u5b9a\u6027\u7684\u4e89\u8bae\u3002 ZFS \uff08\u9700\u8981 kernel module\uff09 \u8d77\u6e90\u4e8e Solaris \u7684 CoW \u6587\u4ef6\u7cfb\u7edf\uff0c\u9002\u7528\u4e8e\u5b58\u50a8\u5927\u91cf\u6587\u4ef6\u3001\u9700\u8981\u9ad8\u7ea7\u529f\u80fd\u7684\u573a\u5408\u3002\u9700\u8981\u989d\u5916\u7684\u5185\u5b58\u548c CPU \u8d44\u6e90\u3002 NTFS  (Linux 5.15+) \u53ea\u8bfb Windows \u4e0a\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 HFS+ \u53ea\u8bfb \u53ea\u8bfb\uff0cBootcamp macOS \u8f83\u65e9\u671f\u7248\u672c\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 APFS macOS \u8f83\u65b0\u7248\u672c\u7684 CoW \u6587\u4ef6\u7cfb\u7edf\u3002 <p>@taoky: \u5173\u4e8e ReiserFS</p> <p>ReiserFS \u5176\u5b9e\u6709\u4e00\u4e2a\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\u4e0d\u80fd\u6709\u6548\u66ff\u4ee3\u7684\u4f18\u52bf\uff1a\u5b83\u662f\u76ee\u524d\u4e3b\u7ebf\u4e2d\u552f\u4e00\u4e00\u4e2a\u80fd\u591f\u53ea\u4f7f\u7528\u51e0\u4e2a GB \u7684\u7a7a\u95f4\u5c31\u80fd\u5b58\u50a8\u4e0a\u5343\u4e07\u4e2a\u6587\u4ef6\u5143\u6570\u636e\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 \uff08\u4f8b\u5982\uff0c\u5bf9\u4e8e\u4e00\u767e\u4e5d\u5341\u4e07\u4e2a\u53ea\u6709\u51e0\u4e2a\u5b57\u8282\u7684\u6587\u4ef6\uff0cReiserfs \u53ea\u9700\u8981 325MB\uff0c\u800c\u5bf9\u6bd4\u4e4b\u4e0b\uff0c\u5373\u4f7f\u662f\u300c\u9488\u5bf9\u5c0f\u6587\u4ef6\u4f18\u5316\u300d\u7684 Btrfs \u4e5f\u9700\u8981\u63a5\u8fd1 1GB\u3002\uff09 \u8fd9\u4e2a\u573a\u666f\u5728\u955c\u50cf\u7ad9\u4f7f\u7528 rsync-huai \u7684\u65f6\u5019\u5c31\u975e\u5e38\u6709\u7528\u3002 @shankerwangmiao \u7684 patch \u4f7f\u5f97 rsync \u670d\u52a1\u5668\u53ef\u4ee5\u5206\u79bb\u5143\u6570\u636e\u548c\u6587\u4ef6\u5b9e\u9645\u7684\u6570\u636e\u2014\u2014\u6b64\u65f6\u5143\u6570\u636e\u5c31\u53ef\u4ee5\u5b58\u50a8\u5728 SSD \u6216\u8005\u5185\u5b58\u76d8\u4e0a\uff0c \u5b9e\u9645\u7684\u6587\u4ef6\u5b58\u50a8\u5728 HDD \u4e0a\u3002\u7531\u4e8e rsync \u603b\u662f\u9700\u8981\u626b\u4e00\u904d\u6587\u4ef6\u6765\u6784\u5efa\u540c\u6b65\u5217\u8868\uff0c\u56e0\u6b64\u8fd9\u4e48\u505a\u53ef\u4ee5\u5927\u5927\u63d0\u5347\u6027\u80fd\u3002</p> <p>\u5982\u679c Hans Reiser \u6ca1\u6709\u72af\u4e0b\u6740\u59bb\u4e4b\u7f6a\u7684\u8bdd\uff0cReiserFS\uff08\u6216\u8005\u540e\u7ee7\u8005 Reiser4\uff09\u5f88\u53ef\u80fd\u4f1a\u6210\u4e3a ext4 \u7684\u5f3a\u6709\u529b\u7ade\u4e89\u8005\u3002\u4f46\u662f\u5f88\u53ef\u60dc\uff0c\u5386\u53f2\u662f\u4e0d\u80fd\u505a\u300c\u5982\u679c\u300d\u7684\u3002 \u867d\u7136\u6211\u6709\u65f6\u5019\u4f1a\u60f3\uff0c\u5982\u679c\u6211\u5728 LKML \u4e2d\u8ba8\u8bba\u662f\u5426\u5e94\u8be5\u79fb\u9664 ReiserFS \u7684\u65f6\u5019\uff0c\u56de\u590d\u8fd9\u6837\u4e00\u4e2a use case\uff0c\u4f1a\u4e0d\u4f1a\u6709\u4e0d\u540c\u7684\u7ed3\u679c\uff1f \u5373\u4f7f ReiserFS \u76ee\u524d\u8fd8\u6ca1\u6709\u89e3\u51b3 2038 \u95ee\u9898\uff0c\u4e4b\u540e\u4e5f\u603b\u80fd\u6709\u529e\u6cd5\u89e3\u51b3\u2014\u2014\u5927\u4e0d\u4e86\u91cd\u65b0\u683c\u5f0f\u5316\u4e00\u6b21\u3002</p> <p>\u53ea\u662f\uff0c\u5bf9\u8fc7\u53bb\u7684\u4e8b\u60c5\u505a\u5047\u8bbe\u662f\u6ca1\u6709\u610f\u4e49\u7684\u3002\u81f3\u4e8e rsync-huai\uff0c\u53ef\u80fd\u5f97\u505a\u4e00\u4e2a\u57fa\u4e8e\u6570\u636e\u5e93\u7684\u7248\u672c\uff0c\u4e0d\u8fc7\u4ec0\u4e48\u65f6\u5019\u80fd\u591f\u5b8c\u6210\u5c31\u4e0d\u77e5\u9053\u4e86\u3002</p> <p>\u4ee5\u4e0b\u5c06\u5173\u6ce8\u5728 Linux \u670d\u52a1\u5668\u7aef\u5e38\u89c1\u7684\u573a\u666f\u3002\u8868\u683c\u4e2d\u6307\u5411 ArchWiki \u7684\u94fe\u63a5\u4e5f\u53ef\u80fd\u6709\u6240\u5e2e\u52a9\u3002</p>"},{"location":"ops/storage/filesystem/#ext4","title":"ext4","text":"<p>ext4 \u662f\u5305\u62ec Debian \u548c Ubuntu \u5728\u5185\u7684\u4f17\u591a\u53d1\u884c\u7248\u4e3a\u7cfb\u7edf\u5206\u533a\uff08\u6839\u6587\u4ef6\u7cfb\u7edf\uff09\u9ed8\u8ba4\u91c7\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\u3002 \u5982\u679c\u6ca1\u6709\u7279\u6b8a\u7684\u9700\u6c42\uff0cext4 \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\uff1b\u5373\u4f7f\u6709\u5176\u4ed6\u9700\u6c42\uff0c\u4e5f\u5efa\u8bae\u5bf9\u7cfb\u7edf\u5206\u533a\u4f7f\u7528 ext4\u3002 ext4 \u6700\u5e38\u89c1\u7684\u95ee\u9898\u4e4b\u4e00\u662f inode \u7684\u6570\u91cf\u9650\u5236\u3002</p> <p>inode</p> <p>inode \u662f Unix \u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u6982\u5ff5\uff0c\u5176\u5305\u542b\u4e86\u6587\u4ef6\uff08\u6587\u4ef6\u7cfb\u7edf\u5bf9\u8c61\uff09\u7684\u5143\u6570\u636e\uff08\u5982\u6743\u9650\u3001\u5927\u5c0f\u3001\u65f6\u95f4\u7b49\uff09\uff0c\u6bcf\u4e2a\u6587\u4ef6\u5bf9\u5e94\u4e00\u4e2a inode\uff0c\u6709\u4e00\u4e2a\u5728\u6587\u4ef6\u7cfb\u7edf\u4e0a\u552f\u4e00\u7684 inode \u53f7\u7801\u3002 \u53ef\u4ee5\u4f7f\u7528 <code>stat</code> \u6216 <code>ls -i</code> \u67e5\u770b\u6587\u4ef6\u7684 inode \u4fe1\u606f\u3002</p> <pre><code>$ stat test\n  File: test\n  Size: 0           Blocks: 0          IO Block: 4096   regular empty file\nDevice: 0,28    Inode: 54475724    Links: 1\nAccess: (0644/-rw-r--r--)  Uid: ( 1000/   username)   Gid: ( 1000/   username)\nAccess: 2024-02-11 00:23:27.743633975 +0800\nModify: 2024-02-11 00:23:27.743633975 +0800\nChange: 2024-02-11 00:23:27.743633975 +0800\n Birth: 2024-02-11 00:23:27.743633975 +0800\n</code></pre> <p>\u8fd9\u91cc test \u6587\u4ef6\u7684 inode \u53f7\u7801\u5219\u4e3a 54475724\u3002</p> <p>\u5728\u521b\u5efa ext4 \u6587\u4ef6\u7cfb\u7edf\u65f6\uff0c\u4f1a\u56fa\u5b9a\u540d\u4e3a \"bytes-per-inode\" \u7684\u53c2\u6570\uff0c\u7528\u4e8e\u63a7\u5236\u603b\u7684 inode \u6570\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u786c\u76d8\u4e0a\u6bcf\u6709 16KB \u7684\u7a7a\u95f4\uff0c\u5c31\u4f1a\u4fdd\u7559\u4e00\u4e2a inode\u3002 \u8be5\u53c2\u6570\u65e0\u6cd5\u5728\u6587\u4ef6\u7cfb\u7edf\u521b\u5efa\u540e\u66f4\u6539\u3002 \u56e0\u6b64\uff0c\u5982\u679c\u521b\u5efa\u4e86\u5927\u91cf\u5c0f\u6587\u4ef6\uff0c\u53ef\u80fd\u4f1a\u53d1\u73b0\u78c1\u76d8\u7a7a\u95f4\u5e76\u6ca1\u6709\u7528\u5b8c\uff0c\u4f46\u662f\u5df2\u7ecf\u65e0\u6cd5\u518d\u521b\u5efa\u65b0\u6587\u4ef6\u4e86\u3002 \u6b64\u65f6\u5982\u679c\u6269\u5145\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684\u5bb9\u91cf\uff0c\u90a3\u4e48 inode \u7684\u6570\u91cf\u4e5f\u4f1a\u6309\u6bd4\u4f8b\u589e\u52a0\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0cext4 \u9ed8\u8ba4\u7684 5% \u4fdd\u7559\u7a7a\u95f4\u4e5f\u662f\u5e38\u4f1a\u9047\u5230\u7684\u95ee\u9898\u3002\u8fd9\u4e00\u90e8\u5206\u4fdd\u7559\u7a7a\u95f4\u4ec5\u5141\u8bb8 root \u7528\u6237\u4f7f\u7528\uff0c\u4ee5\u5728\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u65f6\u4ecd\u4fdd\u8bc1 root \u6743\u9650\u7684\u8fdb\u7a0b\u80fd\u591f\u6b63\u5e38\u8fd0\u884c\u3002 \u4f46\u662f\u5bf9\u4e8e\u73b0\u4ee3\u7684\u5927\u5bb9\u91cf\u78c1\u76d8\u6765\u8bf4\uff0c\u8fd9\u4e00\u90e8\u5206\u7a7a\u95f4\u53ef\u80fd\u4f1a\u6d6a\u8d39\u5f88\u591a\u3002\u53ef\u4ee5\u4f7f\u7528 <code>tune2fs</code> \u547d\u4ee4\u8c03\u6574\u8fd9\u4e00\u53c2\u6570\uff1a</p> <pre><code>sudo tune2fs -m 1 /dev/sda1  # \u5c06\u4fdd\u7559\u7a7a\u95f4\u8c03\u6574\u4e3a 1%\n</code></pre>"},{"location":"ops/storage/filesystem/#xfs","title":"XFS","text":"<p>ArchWiki: XFS is a high-performance journaling file system created by Silicon Graphics, Inc. XFS is particularly proficient at parallel IO due to its allocation group based design. This enables extreme scalability of IO threads, filesystem bandwidth, file and filesystem size when spanning multiple storage devices.</p> <p>\u5bf9\u4e8e\u955c\u50cf\u7ad9\u573a\u666f\uff0cXFS \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u9879\uff0c\u81f3\u5c11\u4e0d\u9700\u8981\u53bb\u62c5\u5fc3 inode \u4f1a\u4e0d\u4f1a\u7528\u5b8c\u7684\u95ee\u9898\u3002</p> <p>\u4ee5\u4e0b\u4ecb\u7ecd XFS \u7684\u7279\u8272\u529f\u80fd\uff1a\u57fa\u4e8e\u9879\u76ee\uff08Project\uff09\u7684\u914d\u989d\uff08Quota\uff09\u3002 \u8be5\u529f\u80fd\u53ef\u4ee5\u5b9e\u73b0\u6587\u4ef6\u5939\u5927\u5c0f\u7edf\u8ba1\uff0c\u4e00\u4e2a\u4f7f\u7528\u573a\u666f\u662f\uff1a\u4e86\u89e3\u6bcf\u4e2a\u6587\u4ef6\u5939\u5360\u7528\u4e86\u591a\u5c11\u7a7a\u95f4\uff0c\u800c\u4e0d\u9700\u8981\u7f13\u6162\u5730\u904d\u5386\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002 ext4 \u5728\u8f83\u65b0\u7684\u7248\u672c\u4e2d\u4e5f\u6dfb\u52a0\u4e86\u7c7b\u4f3c\u7684\u529f\u80fd\uff08\u4e4b\u524d\u4ec5\u652f\u6301\u57fa\u4e8e\u7528\u6237\u6216\u7ec4\u7684\u914d\u989d\uff09\u3002</p> <pre><code>$ sudo truncate -s 8G xfs.img\n$ sudo mkfs.xfs xfs.img\nmeta-data=xfs.img                isize=512    agcount=4, agsize=524288 blks\n         =                       sectsz=512   attr=2, projid32bit=1\n         =                       crc=1        finobt=1, sparse=1, rmapbt=1\n         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=1\ndata     =                       bsize=4096   blocks=2097152, imaxpct=25\n         =                       sunit=0      swidth=0 blks\nnaming   =version 2              bsize=4096   ascii-ci=0, ftype=1\nlog      =internal log           bsize=4096   blocks=16384, version=2\n         =                       sectsz=512   sunit=0 blks, lazy-count=1\nrealtime =none                   extsz=4096   blocks=0, rtextents=0\n$ sudo mount -o prjquota xfs.img /media/xfs  # \u9700\u8981\u5728\u6302\u8f7d\u65f6\u542f\u7528\u9879\u76ee\u914d\u989d\u529f\u80fd\n$ sudo mkdir /media/xfs/a /media/xfs/b /media/xfs/c\n</code></pre> <p>XFS \u7684\u9879\u76ee\u914d\u989d\u529f\u80fd\u914d\u7f6e\u4f4d\u4e8e <code>/etc/projects</code> \u4e0e <code>/etc/projid</code> \u6587\u4ef6\u4e2d\u3002 \u5176\u4e2d <code>/etc/projects</code> \u5b58\u50a8\u8def\u5f84\u4e0e\u9879\u76ee ID \u7684\u6620\u5c04\uff0c\u800c <code>/etc/projid</code> \u5b58\u50a8\u9879\u76ee ID \u4e0e\u9879\u76ee\u540d\u79f0\u7684\u6620\u5c04\u3002</p> <p>\u5bf9\u4e8e\u4e0a\u9762\u521b\u5efa\u7684\u4e09\u4e2a\u6587\u4ef6\u5939\uff0c\u6211\u4eec\u53ef\u4ee5\u7f16\u8f91\u4e0a\u8ff0\u4e24\u4e2a\u6587\u4ef6\uff0c\u5206\u522b\u521b\u5efa\u914d\u989d\uff1a</p> <pre><code>$ cat /etc/projects\n1:/media/xfs/a\n2:/media/xfs/b\n3:/media/xfs/c\n$ cat /etc/projid\na:1\nb:2\nc:3\n</code></pre> <p>\u7136\u540e\u521d\u59cb\u5316\u9879\u76ee\uff08\u5982\u679c\u6587\u4ef6\u5939\u4e2d\u5df2\u7ecf\u6709\u5927\u91cf\u6587\u4ef6\uff0c\u90a3\u4e48\u9700\u8981\u4e00\u6bb5\u65f6\u95f4\u521d\u59cb\u5316\uff09\uff1a</p> <pre><code>$ sudo xfs_quota -x -c 'project -s a'\nSetting up project a (path /media/xfs/a)...\nProcessed 1 (/etc/projects and cmdline) paths for project a with recursion depth infinite (-1).\n$ sudo xfs_quota -x -c 'project -s b'\nSetting up project b (path /media/xfs/b)...\nProcessed 1 (/etc/projects and cmdline) paths for project b with recursion depth infinite (-1).\n$ sudo xfs_quota -x -c 'project -s c'\nSetting up project c (path /media/xfs/c)...\nProcessed 1 (/etc/projects and cmdline) paths for project c with recursion depth infinite (-1).\n</code></pre> <p>\u4e4b\u540e\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5411\u8fd9\u4e9b\u6587\u4ef6\u5939\u4e2d\u5199\u5165\u6587\u4ef6\uff0c\u7136\u540e\u4f7f\u7528 <code>xfs_quota</code> \u547d\u4ee4\u67e5\u770b\u914d\u989d\u4f7f\u7528\u60c5\u51b5\u3002</p> <pre><code>$ sudo cp /etc/os-release /media/xfs/a/\n$ sudo xfs_quota -c 'df -h'\nFilesystem     Size   Used  Avail Use% Pathname\n/dev/loop4     7.9G 187.9M   7.8G   2% /media/xfs\n/dev/loop4     7.9G     4K   7.8G   0% /media/xfs/a\n/dev/loop4     7.9G      0   7.8G   0% /media/xfs/b\n/dev/loop4     7.9G      0   7.8G   0% /media/xfs/c\n/dev/nvme0n1p3\n               1.8T   1.4T 400.9G  78% /\n/dev/nvme0n1p3\n               1.8T   1.4T 400.9G  78% /home\n/dev/nvme0n1p3\n               1.8T   1.4T 400.9G  78% /opt\n/dev/nvme0n1p3\n               1.8T   1.4T 400.9G  78% /tmp\n/dev/nvme0n1p3\n               1.8T   1.4T 400.9G  78% /var\n/dev/nvme0n1p3\n               1.8T   1.4T 400.9G  78% /var/lib/docker/btrfs\n</code></pre> <p><code>xfs_quota</code> \u7684 <code>df</code> \u4e5f\u4f1a\u8f93\u51fa\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\u7684\u7a7a\u95f4\u4f7f\u7528\u60c5\u51b5\uff0c\u5ffd\u7565\u5373\u53ef\u3002</p>"},{"location":"ops/storage/filesystem/#btrfs","title":"Btrfs","text":"<p>\u5c3d\u7ba1\u5728\u6211\u4eec\u7684\u5b9e\u8df5\u4e2d\uff0c\u6211\u4eec\u4e0d\u592a\u5efa\u8bae\u4f7f\u7528 Btrfs\u2014\u2014\u9ad8\u7ea7\u7279\u6027\u7528\u4e0d\u4e0a\uff0c\u800c\u8bb8\u591a\u5e74\u524d\u5728\u955c\u50cf\u7ad9\u4e0a\u7684\u6d4b\u8bd5\u8868\u660e Btrfs \u5728\u957f\u65f6\u95f4\u8fd0\u884c\u540e\u5b58\u5728\u4e25\u91cd\u7684\u6027\u80fd\u95ee\u9898\u3002 \u4f46\u662f\u5728\u8bb8\u591a\u5e74\u7684\u5f00\u53d1\u540e\uff0cBtrfs \u7684\u7a33\u5b9a\u6027\u6709\u4e86\u5f88\u5927\u7684\u63d0\u5347\uff0c\u5e76\u4e14\u4e00\u90e8\u5206\u7279\u6027\u5728\u67d0\u4e9b\u573a\u5408\u4e0b\u5f88\u6709\u7528\uff0c\u56e0\u6b64\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e9b\u76f8\u5173\u7684\u4ecb\u7ecd\u3002</p>"},{"location":"ops/storage/filesystem/#btrfs-subvolume","title":"Subvolume","text":"<p>Subvolume \u662f Btrfs \u7684\u4e00\u4e2a\u91cd\u8981\u6982\u5ff5\uff0c\u53ef\u4ee5\u770b\u4f5c\u662f Btrfs \u7684\u300c\u5b50\u6587\u4ef6\u7cfb\u7edf\u300d\u3002\u4e0e\u76ee\u5f55\u4e0d\u540c\uff0cSubvolume \u662f\u72ec\u7acb\u7684\uff0c\u53ef\u4ee5\u6709\u81ea\u5df1\u7684\u6302\u8f7d\u70b9\u3002 \u540c\u65f6 subvolume \u5171\u4eab\u540c\u4e00\u4e2a Btrfs \u6587\u4ef6\u7cfb\u7edf\u7684\u7a7a\u95f4\uff0c\u4e0d\u9700\u8981\u624b\u52a8\u5206\u914d\u7a7a\u95f4\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6765\u8bd5\u4e00\u8bd5\uff1a</p> <pre><code>$ truncate -s 8G btrfs.img\n$ sudo mkfs.btrfs btrfs.img\n\uff08\u8f93\u51fa\u7701\u7565\uff09\n$ sudo mount btrfs.img /media/btrfs\n$ sudo btrfs filesystem show /media/btrfs  # \u53ef\u4ee5\u4f7f\u7528 btrfs \u5de5\u5177\u7ba1\u7406 Btrfs \u6587\u4ef6\u7cfb\u7edf\nLabel: none  uuid: 5cdcf4bb-8020-45f9-8dfd-95e04a2a2bc1\n    Total devices 1 FS bytes used 144.00KiB\n    devid    1 size 8.00GiB used 536.00MiB path /dev/loop0\n\n$ # btrfs \u5de5\u5177\u4e5f\u53ef\u4ee5\u7ba1\u7406\u79bb\u7ebf\u7684 btrfs \u5757\u8bbe\u5907\n$ # \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e9b subvolume\n$ sudo btrfs subvolume create /media/btrfs/subvol1\nCreate subvolume '/media/btrfs/subvol1'\n$ sudo btrfs subvolume create /media/btrfs/subvol2\nCreate subvolume '/media/btrfs/subvol2'\n$ sudo btrfs subvolume create /media/btrfs/subvol3\nCreate subvolume '/media/btrfs/subvol3'\n$ sudo btrfs subvolume list /media/btrfs\nID 256 gen 8 top level 5 path subvol1\nID 257 gen 8 top level 5 path subvol2\nID 258 gen 8 top level 5 path subvol3\n$ ls -lh /media/btrfs  # \u770b\u8d77\u6765\u548c\u666e\u901a\u76ee\u5f55\u6ca1\u4ec0\u4e48\u533a\u522b\ntotal 0\ndrwxr-xr-x 1 root root 0 Feb 11 14:50 subvol1/\ndrwxr-xr-x 1 root root 0 Feb 11 14:50 subvol2/\ndrwxr-xr-x 1 root root 0 Feb 11 14:50 subvol3/\n$ sudo umount /media/btrfs\n$ sudo mount -o subvol=subvol1 btrfs.img /media/btrfs1  # \u6302\u8f7d subvol1\n$ sudo mount -o subvol=subvol2 btrfs.img /media/btrfs2  # \u6302\u8f7d subvol2\n$ mount | grep btrfs.img\n/path/to/btrfs.img on /media/btrfs1 type btrfs (rw,relatime,ssd,discard=async,space_cache=v2,subvolid=256,subvol=/subvol1)\n/path/to/btrfs.img on /media/btrfs2 type btrfs (rw,relatime,ssd,discard=async,space_cache=v2,subvolid=257,subvol=/subvol2)\n$ sudo umount /media/btrfs1\n$ sudo umount /media/btrfs2\n</code></pre> <p>\u5168\u5c40\u6302\u8f7d\u53c2\u6570</p> <p>\u5927\u90e8\u5206 Btrfs \u7684\u6302\u8f7d\u53c2\u6570\uff08\u4f8b\u5982\u900f\u660e\u538b\u7f29\uff09\u53ea\u9002\u7528\u4e8e\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u5728\u9996\u4e2a subvolume \u4e0a\u6302\u8f7d\u65f6\uff0c\u8fd9\u4e9b\u53c2\u6570\u4f1a\u88ab\u5e94\u7528\u5230\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002 \u540e\u7eed\u6302\u8f7d\u4f7f\u7528\u7684\u53c2\u6570\u4f1a\u88ab\u5ffd\u7565\u3002</p> <p>\u5728 Btrfs \u6302\u8f7d\u53c2\u6570\u4e2d\uff0c<code>subvol=&lt;path&gt;</code> \u548c <code>subvolid=&lt;id&gt;</code> \u7528\u6765\u6807\u8bc6\u9700\u8981\u6302\u8f7d\u7684 subvolume\u3002\u5982\u679c\u4e24\u4e2a\u53c2\u6570\u90fd\u4e0d\u6307\u5b9a\uff0c\u5219\u4f1a\u6302\u8f7d\u9ed8\u8ba4 subvolume\u3002</p> <pre><code>$ sudo mount btrfs.img /media/btrfs # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs subvolume create /media/btrfs/subvol1/nestedvol1  # \u521b\u5efa\u5d4c\u5957\u7684 subvolume\nCreate subvolume '/media/btrfs/subvol1/nestedvol1'\n$ # \u5c06 subvolume \u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\n$ sudo btrfs subvolume set-default /media/btrfs/subvol1/nestedvol1\n$ sudo btrfs subvolume get-default /media/btrfs\nID 259 gen 11 top level 256 path subvol1/nestedvol1\n$ sudo umount /media/btrfs\n$ # \u91cd\u65b0\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\uff0c\u53ef\u4ee5\u770b\u5230\u6302\u8f7d\u7684 subvolume \u5df2\u7ecf\u6539\u53d8\n$ sudo mount btrfs.img /media/btrfs  \n$ sudo btrfs subvolume show /media/btrfs\nsubvol1/nestedvol1\n    Name:           nestedvol1\n\uff08\u4ee5\u4e0b\u8f93\u51fa\u7701\u7565\uff09\n$ sudo umount /media/btrfs\n$ # \u91cd\u65b0\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\uff0c\u6307\u5b9a\u6302\u8f7d\u6839 subvolume\uff08ID=5\uff09\n$ sudo mount -o subvolid=5 btrfs.img /media/btrfs\n$ sudo btrfs subvolume show /media/btrfs\n/\n    Name:           &lt;FS_TREE&gt;\n\uff08\u4ee5\u4e0b\u8f93\u51fa\u7701\u7565\uff09\n$ sudo umount /media/btrfs\n</code></pre>"},{"location":"ops/storage/filesystem/#btrfs-snapshot","title":"\u5feb\u7167","text":"<p>\u5728 subvolume \u7684\u57fa\u7840\u4e0a\uff0cBtrfs \u652f\u6301\u4e86\u5feb\u7167\u529f\u80fd\u3002\u8fd9\u91cc\u7684\u5feb\u7167\u53ef\u80fd\u4e0e\u6211\u4eec\u719f\u6089\u7684\u300c\u5feb\u7167\u300d\uff08\u4f8b\u5982\u865a\u62df\u673a\u8f6f\u4ef6\u7684\u5feb\u7167\u529f\u80fd\uff09\u6709\u6240\u4e0d\u540c\uff0c\u5b83\u672c\u8d28\u4e0a\u5c31\u662f\u548c\u5176\u4ed6 subvolume \u5171\u4eab\u6570\u636e\u7684 subvolume\u3002\u8ba9\u6211\u4eec\u8bd5\u4e00\u8bd5\u5427\uff1a</p> <pre><code>$ sudo mount -o subvolid=5 btrfs.img /media/btrfs  # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ echo \"test1\" &gt; /media/btrfs/subvol1/test  # \u53ef\u80fd\u9700\u8981 root \u6743\u9650\n$ sudo btrfs subvolume snapshot /media/btrfs/subvol1 /media/btrfs/snap1  # \u521b\u5efa\u5feb\u7167\nCreate a snapshot of '/media/btrfs/subvol1/' in '/media/btrfs/snap1'\n$ # \u6b64\u65f6 snap1 \u548c subvol1 \u5171\u4eab\u6570\u636e\u2014\u2014\u5b58\u50a8\u7684\u662f\u76ee\u524d subvol1 \u7684\u5185\u5bb9\n$ cat /media/btrfs/snap1/test\ntest1\n$ echo \"test2\" &gt; /media/btrfs/subvol1/test  # \u4fee\u6539 subvol1\n$ cat /media/btrfs/snap1/test  # snap1 \u4e0d\u53d7\u5f71\u54cd\ntest1\n$ echo \"test3\" &gt; /media/btrfs/snap1/test  # \u4fee\u6539 snap1\n$ cat /media/btrfs/subvol1/test  # subvol1 \u4e0d\u53d7\u5f71\u54cd\ntest2\n$ sudo btrfs subvolume delete /media/btrfs/snap1  # \u5220\u9664\u5feb\u7167\nDelete subvolume 259 (no-commit): '/media/btrfs/snap1'\n$ sudo umount /media/btrfs\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u300c\u5feb\u7167\u300d\u7684\u5185\u5bb9\uff0c\u5728 CoW \u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4fee\u6539\u5171\u4eab\u7684\u5185\u5bb9\u4f1a\u88ab\u590d\u5236\uff0c\u800c\u672a\u4fee\u6539\u7684\u5185\u5bb9\u4f1a\u88ab\u5171\u4eab\u3002 \u4e0d\u8fc7\u5f88\u591a\u65f6\u5019\u6211\u4eec\u4e0d\u5e0c\u671b\u5feb\u7167\u53ef\u5199\uff0c\u5728\u521b\u5efa\u5feb\u7167\u65f6\u53ef\u4ee5\u52a0\u4e0a <code>-r</code> \u53c2\u6570\u3002</p> <p>\u548c <code>cp</code> \u547d\u4ee4\u7c7b\u4f3c\u5730\uff0c\u5f53\u5feb\u7167\u7684\u76ee\u6807\u8def\u5f84\u662f\u4e00\u4e2a\u76ee\u5f55\u65f6\uff0cBtrfs \u5de5\u5177\u5c06\u5728\u8be5\u76ee\u5f55\u4e0b\u4e00\u4e2a\u521b\u5efa\u540c\u540d\u7684 subvolume\u3002</p> <pre><code>$ sudo mount -o subvolid=5 btrfs.img /media/btrfs  # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo mkdir /media/btrfs/snapshots  # \u521b\u5efa snapshots \u76ee\u5f55\n$ sudo btrfs subvolume snapshot -r /media/btrfs/subvol1 /media/btrfs/snapshots  # \u521b\u5efa\u53ea\u8bfb\u5feb\u7167\nCreate a readonly snapshot of '/media/btrfs/subvol1/' in '/media/btrfs/snapshots/subvol1'\n$ sudo btrfs property get /media/btrfs/snapshots/subvol1  # \u9a8c\u8bc1\u53ea\u8bfb\u5c5e\u6027\nro=true\n$ sudo mkdir /media/btrfs/recovered  # \u521b\u5efa recovered \u76ee\u5f55\n$ sudo btrfs subvolume snapshot /media/btrfs/snapshots/subvol1 /media/btrfs/recovered  # \u8fd8\u539f\u5feb\u7167\nCreate a snapshot of '/media/btrfs/snapshots/subvol1' in '/media/btrfs/recovered/subvol1'\n$ sudo btrfs property set /media/btrfs/recovered/subvol1 ro false  # \u5c06\u8fd8\u539f\u7684 subvolume \u8bbe\u7f6e\u4e3a\u53ef\u5199\n$ echo \"test4\" &gt; /media/btrfs/recovered/subvol1  # \u4fee\u6539\u8fd8\u539f\u7684 subvol1\n$ sudo umount /media/btrfs\n</code></pre> <p>\u5d4c\u5957 subvolume</p> <p>\u867d\u7136\u5d4c\u5957 subvolume \u5728\u76ee\u5f55\u6811\u4e2d\u770b\u4e0a\u53bb\u662f\u4e0a\u7ea7 subvolume \u7684\u4e00\u90e8\u5206\uff0c\u4f46\u5b83\u5e76\u4e0d\u662f\u4e0a\u7ea7 subvolume \u7684\u6587\u4ef6\uff0c\u56e0\u6b64\u4e0d\u4f1a\u88ab\u5305\u62ec\u5728\u5feb\u7167\u4e2d\uff0c\u53ea\u4f1a\u4fdd\u7559\u4f5c\u4e3a\u6302\u8f7d\u70b9\u7684\u7a7a\u76ee\u5f55\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5b9a\u65f6\u6267\u884c\u5feb\u7167\uff0c\u4ee5\u4fbf\u5728\u6587\u4ef6\u88ab\u8bef\u64cd\u4f5c\u65f6\u80fd\u591f\u6062\u590d\u3002\u4f8b\u5982 snapper \u7b49\u8f6f\u4ef6\u53ef\u4ee5\u5728\u540e\u53f0\u81ea\u52a8\u6267\u884c\u5feb\u7167\u4efb\u52a1\u3002</p>"},{"location":"ops/storage/filesystem/#btrfs-send","title":"\u4f20\u8f93","text":"<p>Btrfs \u652f\u6301\u6587\u4ef6\u7cfb\u7edf\u5c42\u9762\u7684\u6d41\u5f0f\u53d1\u9001\u548c\u63a5\u6536\uff0c\u5141\u8bb8\u4ee5\u5b57\u8282\u6d41\u7684\u5f62\u5f0f\u5c06\u4e00\u4e2a\u53ea\u8bfb subvolume\uff08\u4ee5\u4e0b\u7b80\u79f0\u5feb\u7167\uff09\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u53e6\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e0a\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u6837\uff1a</p> <pre><code>$ sudo mount -o subvolid=5 btrfs.img /media/btrfs  # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs subvolume snapshot -r /media/btrfs/subvol1 /media/btrfs/snap2  # \u521b\u5efa\u53ea\u8bfb\u5feb\u7167\nCreate a readonly snapshot of '/media/btrfs/subvol1' in '/media/btrfs/snap2'\n$ # \u521b\u5efa\u5e76\u6302\u8f7d\u65b0\u6587\u4ef6\u7cfb\u7edf\n$ truncate -s 8G btrfs-alt.img\n$ sudo mkfs.btrfs btrfs-alt.img\n\uff08\u8f93\u51fa\u7701\u7565\uff09\n$ sudo mount btrfs-alt.img /media/btrfs-alt\n$ # \u5c06 snap2 \u53d1\u9001\u5230\u65b0\u7684\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs send /media/btrfs/snap2 | sudo btrfs receive /media/btrfs-alt/subvol1\nAt subvol /media/btrfs/snap2\nAt subvol subvol1\n$ sudo btrfs subvolume ls /media/btrfs-alt\nID 256 gen 11 top level 5 path subvol1\n$ sudo umount /media/btrfs\n$ sudo umount /media/btrfs-alt\n</code></pre> <p>\u901a\u8fc7\u7ba1\u9053\u4f20\u8f93\uff0cBtrfs \u7684\u6d41\u5f0f\u4f20\u8f93\u529f\u80fd\u5927\u5927\u7b80\u5316\u4e86\u4e0d\u540c\u78c1\u76d8\u3001\u6587\u4ef6\u7cfb\u7edf\u751a\u81f3\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u6587\u4ef6\u7cfb\u7edf\u5907\u4efd\u548c\u8fc1\u79fb\u3002</p> <pre><code>$ sudo mount -o subvolid=5 btrfs.img /media/btrfs  # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs subvolume snapshot -r /media/btrfs/subvol1 /media/btrfs/snap3\nCreate a readonly snapshot of '/media/btrfs/subvol1' in '/media/btrfs/snap3'\n$ # \u5907\u4efd\u5230\u5176\u5b83\u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd9\u91cc\u4ee5 NFS \u4e3a\u4f8b\n$ sudo btrfs send /media/btrfs/snap3 -f /mnt/nfs/btrfs/subvol1  # \u5c06\u5feb\u7167\u5bfc\u51fa\u4e3a\u6587\u4ef6\nAt subvol /media/btrfs/snap3\n$ sudo btrfs receive /media/btrfs/snap1 -f /mnt/nfs/btrfs/subvol1  # \u5728\u53e6\u4e00\u53f0\u5171\u4eab\u5b58\u50a8\u7684\u670d\u52a1\u5668\u4e0a\u8fd8\u539f\nAt subvol snap1\n$ # \u901a\u8fc7 SSH \u538b\u7f29\u4f20\u8f93\u5230\u53e6\u4e00\u53f0\u670d\u52a1\u5668\uff0c\u9700\u8981\u5b89\u88c5 lz4\n$ sudo btrfs send /media/btrfs/snap3 | lz4 | ssh another-server \"lz4 -d | sudo btrfs receive /media/btrfs/snap1\"\nAt subvol /media/btrfs/snap3\nAt subvol snap1\n$ sudo umount /media/btrfs\n</code></pre> <p>Btrfs \u8fd8\u652f\u6301\u589e\u91cf\u5907\u4efd/\u4f20\u8f93\u3002\u589e\u91cf\u4f20\u8f93\u9700\u8981\u4fdd\u8bc1\u5728\u76ee\u6807\u8def\u5f84\u4e0b\u5b58\u5728\u4e0e\u6e90\u6587\u4ef6\u7cfb\u7edf\u4e0a\u540c\u540d\u4e14\u5185\u5bb9\u5b8c\u5168\u4e00\u81f4\u7684\u5feb\u7167\uff0cBtrfs \u53ef\u4ee5\u81ea\u52a8\u8ba1\u7b97\u5e76\u4f20\u8f93\u4e24\u4e2a\u5feb\u7167\u7684\u5dee\u5f02\u90e8\u5206\u3002</p> <pre><code>$ sudo mount -o subvolid=5 btrfs.img /media/btrfs  # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo mount btrfs-alt.img /media/btrfs-alt  # \u6302\u8f7d\u53e6\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs subvolume snapshot -r /media/btrfs/subvol1 /media/btrfs/snap4  # \u521b\u5efa\u53ea\u8bfb\u5feb\u7167\n$ # \u5c06 snap4 \u53d1\u9001\u5230\u53e6\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs send /media/btrfs/snap4 | sudo btrfs receive /media/btrfs-alt\nAt subvol /media/btrfs/snap4\nAt subvol snap4\n$ echo \"test5\" &gt; /media/btrfs/subvol1  # \u4fee\u6539 subvol1\n$ sudo btrfs subvolume snapshot -r /media/btrfs/subvol1 /media/btrfs/snap4  # \u521b\u5efa\u65b0\u7684\u53ea\u8bfb\u5feb\u7167\n$ # \u67e5\u770b snap5 \u76f8\u5bf9\u4e8e snap4 \u7684\u53d8\u5316\n$ sudo btrfs send /media/btrfs/snap5 -p /media/btrfs/snap4 | sudo btrfs receive --dump\n$ # \u5c06 snap5 \u589e\u91cf\u53d1\u9001\u5230\u53e6\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ sudo btrfs send /media/btrfs/snap5 -p /media/btrfs/snap4 | sudo btrfs receive /media/btrfs-alt\nAt subvol /media/btrfs/snap5\nAt subvol snap5\n$ sudo umount /media/btrfs\n$ sudo umount /media/btrfs-alt\n</code></pre> <p>\u7f51\u7edc\u5b89\u5168\u98ce\u9669</p> <p>Btrfs \u5de5\u5177\u76ee\u524d\u4e0d\u4f1a\u5145\u5206\u9a8c\u8bc1\u589e\u91cf\u4f20\u8f93\u6d41\u7684\u53ef\u9760\u6027\uff0c\u653b\u51fb\u8005\u53ef\u4ee5\u901a\u8fc7\u7cbe\u5fc3\u6784\u9020 Btrfs \u6d41\u4f7f\u5f97\u521b\u5efa\u7684\u5feb\u7167\u4e2d\u5305\u62ec\u76ee\u6807\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u4efb\u610f\u6587\u4ef6\u3002 \u5728\u901a\u8fc7\u7f51\u7edc\u63a5\u6536 Btrfs \u6d41\u65f6\uff0c\u5e94\u8be5\u9996\u5148\u786e\u4fdd\u4f20\u8f93\u6765\u6e90\u548c\u4f20\u8f93\u94fe\u8def\u7684\u5b89\u5168\u6027\u3001\u53ef\u9760\u6027\uff0c\u9632\u8303\u6f5c\u5728\u7684\u7f51\u7edc\u5b89\u5168\u653b\u51fb\u98ce\u9669\u3002</p>"},{"location":"ops/storage/filesystem/#btrfs-compression","title":"\u900f\u660e\u538b\u7f29","text":"<p>Btrfs \u652f\u6301\u900f\u660e\u538b\u7f29\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f1a\u81ea\u52a8\u538b\u7f29\u6587\u4ef6\uff0c\u800c\u4e0a\u5c42\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u5173\u5fc3\u8fd9\u4e00\u8fc7\u7a0b\u3002 \u8fd9\u4e5f\u662f\u8bb8\u591a Btrfs \u7528\u6237\u4f1a\u5f00\u542f\u7684\u6302\u8f7d\u9009\u9879\u3002 Zstd \u538b\u7f29\u7b97\u6cd5\u517c\u987e\u4e86\u6027\u80fd\u4e0e\u538b\u7f29\u6548\u7387\uff0c\u662f\u8bb8\u591a\u7528\u6237\u7684\u9009\u62e9\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u542f\u7528\u4e86 Btrfs \u900f\u660e\u538b\u7f29\uff08<code>compress=zstd:3</code>\uff09\u7684\u684c\u9762\u7528\u6237\uff0c\u5728 <code>/home</code> \u8fd9\u4e2a subvolume \u4e0b\u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo compsize /home\nProcessed 4429337 files, 5827189 regular extents (6428918 refs), 2327200 inline.\nType       Perc     Disk Usage   Uncompressed Referenced  \nTOTAL       78%     1017G         1.2T         1.3T       \nnone       100%      911G         911G         918G       \nzstd        27%      105G         384G         413G       \nprealloc   100%      643M         643M         1.0G\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u900f\u660e\u538b\u7f29\u7279\u6027\u4e3a\u8be5\u7528\u6237\u8282\u7701\u4e86 200G \u7684\u78c1\u76d8\u7a7a\u95f4\u3002</p>"},{"location":"ops/storage/filesystem/#btrfs-faq","title":"\u5e38\u89c1\u95ee\u9898","text":"Balance <p>\u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898\u662f\uff1a\u660e\u660e\u8fd8\u6709\u5269\u4f59\u7a7a\u95f4\uff0c\u4f46\u662f\u5df2\u7ecf\u65e0\u6cd5\u5199\u5165\u6570\u636e\u4e86\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u8fd9\u662f\u56e0\u4e3a Btrfs \u5185\u90e8\u5b58\u50a8\u5206\u4e3a\u6570\u636e\uff08Data\uff09\u548c\u5143\u6570\u636e\uff08Metadata\uff09\u7b49\u90e8\u5206\uff0c\u5f53\u4e24\u8005\u4efb\u4e00\u5df2\u6ee1\uff0c\u5e76\u4e14\u6ca1\u6709\u672a\u5206\u914d\uff08Unallocated\uff09\u7684\u7a7a\u95f4\uff0c\u90a3\u4e48\u5c31\u65e0\u6cd5\u518d\u5199\u5165\u6570\u636e\u4e86\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u6267\u884c <code>btrfs filesystem usage</code> \u5224\u65ad\uff1a</p> <pre><code>$ sudo btrfs filesystem usage /\nOverall:\n    Device size:           1.81TiB\n    Device allocated:          1.66TiB\n    Device unallocated:      156.45GiB\n    Device missing:          0.00B\n    Device slack:            0.00B\n    Used:              1.39TiB\n    Free (estimated):        414.79GiB  (min: 336.57GiB)\n    Free (statfs, df):       414.79GiB\n    Data ratio:               1.00\n    Metadata ratio:           2.00\n    Global reserve:      512.00MiB  (used: 0.00B)\n    Multiple profiles:              no\n\nData,single: Size:1.62TiB, Used:1.37TiB (84.43%)\n/dev/nvme0n1p3     1.62TiB\n\nMetadata,DUP: Size:18.00GiB, Used:11.54GiB (64.13%)\n/dev/nvme0n1p3    36.00GiB\n\nSystem,DUP: Size:8.00MiB, Used:208.00KiB (2.54%)\n/dev/nvme0n1p3    16.00MiB\n\nUnallocated:\n/dev/nvme0n1p3   156.45GiB\n</code></pre> <p>\u9664\u4e86\u76f4\u63a5\u5220\u9664\u6587\u4ef6\u4ee5\u5916\uff0c\u4f7f\u7528 <code>truncate</code> \u5c06\u5927\u6587\u4ef6\u7684\u5927\u5c0f\u622a\u65ad\u4e3a 0 \u53ef\u4ee5\u5728\u4e0d\u6dfb\u52a0 metadata \u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\u91ca\u653e\u7a7a\u95f4\u3002 \u5982\u679c metadata \u5df2\u6ee1\uff0c\u4f46\u662f data \u4ecd\u6709\u7a7a\u95f4\uff0c\u53ef\u4ee5\u4f7f\u7528 balance \u529f\u80fd\u91cd\u65b0\u5206\u914d\u7a7a\u95f4\uff1a</p> <pre><code>$ sudo btrfs balance start /mountpoint -dusage=0\n</code></pre> <p><code>-dusage=0</code> \u4ee3\u8868\u5c06 data \u4e2d\u6ca1\u6709\u4f7f\u7528\uff08\u4f7f\u7528\u7387\u4e3a 0%\uff09\u7684\u7a7a\u95f4\u91ca\u653e\u3002\u89c6\u60c5\u51b5\uff0c\u6709\u53ef\u80fd\u9700\u8981\u589e\u5927 <code>-dusage</code> \u53c2\u6570\u7684\u503c\u3002 \u5982\u679c\u5728 balance \u65f6\u63d0\u793a\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u95f4\uff0c\u90a3\u4e48\u53ef\u80fd\u4e0d\u5f97\u4e0d\u9700\u8981\u4e34\u65f6\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u78c1\u76d8\uff08\u6bd4\u5982\u4e00\u4e2a U \u76d8\uff0c\u6216\u8005\u5982\u679c\u80fd\u591f\u627f\u62c5 \u6570\u636e\u4e22\u5931\u7684\u98ce\u9669\uff0c\u4e00\u4e2a\u5185\u5b58\u76d8\uff09\uff0c\u6dfb\u52a0\u8bbe\u5907\u540e\u518d\u6267\u884c balance\uff0c\u7136\u540e\u518d\u79fb\u9664\u8bbe\u5907\u3002</p> Check <p>Btrfs \u7684\u6587\u4ef6\u7cfb\u7edf\u68c0\u67e5\u5de5\u5177 <code>btrfs-check</code> \u4e0d\u662f\u4f20\u7edf\u6587\u4ef6\u7cfb\u7edf fsck \u7684\u5e73\u66ff\u3002 \u5bf9\u51fa\u73b0\u95ee\u9898\u7684 Btrfs \u5206\u533a\u4f7f\u7528 <code>btrfs-check</code> \u7684 <code>--repair</code> \u9009\u9879\u5f88\u53ef\u80fd\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u3002</p> <p>\u4e00\u822c\u6765\u8bb2\uff0c\u5efa\u8bae\u8bbe\u7f6e\u5b9a\u65f6 scrub \u4efb\u52a1\uff0c\u4ee5\u68c0\u67e5 checksum \u4e0e\u5b9e\u9645\u5185\u5bb9\u662f\u5426\u4e00\u81f4\u3002Scrub \u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u6267\u884c\uff0c\u4f46\u662f\u4e0d\u68c0\u67e5\u7ed3\u6784\u662f\u5426\u6b63\u786e\u3002</p> \u5173\u95ed CoW <p>\u5bf9\u4e8e\u90e8\u5206\u5e94\u7528\u573a\u666f\uff08\u4f8b\u5982\u6570\u636e\u5e93\u3001\u865a\u62df\u673a\u955c\u50cf\uff09\uff0cBtrfs \u7684 CoW \u7279\u6027\u53ef\u80fd\u4f1a\u5e26\u6765\u6027\u80fd\u95ee\u9898\u3002\u53ef\u4ee5\u5bf9\u6587\u4ef6\u4f7f\u7528 <code>chattr +C</code> \u547d\u4ee4\u5173\u95ed CoW \u7279\u6027\u3002</p>"},{"location":"ops/storage/filesystem/#zfs","title":"ZFS","text":"<p>\u53c2\u89c1 ZFS\u3002</p> <ol> <li> <p>\u5f53\u7136\u4e86\uff0c\u300c\u6247\u533a\u300d\u7684\u6982\u5ff5\u5728\u73b0\u4ee3\u78c1\u76d8\uff0c\u7279\u522b\u662f\u56fa\u6001\u786c\u76d8\u4e0a\u5df2\u7ecf\u4e0d\u518d\u51c6\u786e\uff0c\u4f46\u662f\u8fd9\u91cc\u4ecd\u7136\u4f7f\u7528\u8fd9\u4e2a\u4e60\u60ef\u6027\u7684\u672f\u8bed\u3002\u00a0\u21a9</p> </li> <li> <p>\u6247\u533a\u7684\u5927\u5c0f\uff08\u7279\u522b\u662f\u73b0\u4ee3\u78c1\u76d8\u5728\u5b9e\u9645\u7269\u7406\u4e0a\uff09\u4e0d\u4e00\u5b9a\u662f 512 \u5b57\u8282\uff0c\u4f46\u5728\u5b9e\u9645\u521b\u5efa\u5206\u533a\u65f6\uff0c\u4e00\u822c\u90fd\u662f\u4ee5 512 \u5b57\u8282\u4e3a\u5355\u4f4d\u3002\u00a0\u21a9</p> </li> <li> <p>xfs_growfs(8): A filesystem with only 1 AG cannot be shrunk further, and a filesystem cannot be shrunk to the point where it would only have 1 AG.\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/intro/","title":"\u57fa\u7840\u77e5\u8bc6\u7b80\u4ecb","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>\u670d\u52a1\u5668\u9700\u8981\u4f7f\u7528\u7684\u5b58\u50a8\u65b9\u6848\u4e0e\u4e2a\u4eba\u8ba1\u7b97\u673a\u7684\u5dee\u5f02\u8f83\u5927\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u670d\u52a1\u5668\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u76d8\u4f4d\uff0c\u4e0d\u540c\u670d\u52a1\u5668\u7684\u76d8\u4f4d\u4f7f\u7528\u7684\u63a5\u53e3\u3001\u78c1\u76d8\u7684\u5c3a\u5bf8\u53ef\u80fd\u4e0d\u540c\u3002</li> <li>\u670d\u52a1\u5668\u4e00\u822c\u63d0\u4f9b RAID \u5361\uff0c\u53ef\u4ee5\u5728\u786c\u4ef6\u5c42\u9762\u5b9e\u73b0 RAID \u529f\u80fd\uff0c\u5927\u90e8\u5206 RAID \u5361\u4e5f\u5141\u8bb8\u7ba1\u7406\u5458\u8bbe\u7f6e\u76f4\u901a\u5230\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u73b0 RAID \u529f\u80fd\u3002</li> <li>\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e0d\u540c\uff0c\u53ef\u80fd\u9700\u8981\u8003\u8651\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5dee\u5f02\uff0c\u5e76\u4e14\u9009\u62e9\u5408\u9002\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</li> <li>\u7531\u4e8e\u78c1\u76d8\u6570\u91cf\u591a\uff0c\u78c1\u76d8\u6545\u969c\u7684\u6982\u7387\u4e5f\u4f1a\u589e\u52a0\uff0c\u56e0\u6b64\u9700\u8981\u80fd\u591f\u53ca\u65f6\u53d1\u73b0\u6545\u969c\uff0c\u5e76\u91c7\u53d6\u76f8\u5e94\u7684\u63aa\u65bd\u3002</li> <li>\u2026\u2026\u2026\u2026</li> </ul> <p>\u672c\u90e8\u5206\u4f1a\u5bf9\u8fd0\u7ef4\u9700\u8981\u4e86\u89e3\u7684\u57fa\u7840\u77e5\u8bc6\u8fdb\u884c\u4ecb\u7ecd\u3002</p>"},{"location":"ops/storage/intro/#glossary","title":"\u672f\u8bed","text":"<ul> <li>\u6240\u6709\u7684\u6570\u636e\u6700\u7ec8\u90fd\u5b58\u5728\u4e00\u5757\u6216\u591a\u5757\u7269\u7406\u78c1\u76d8\u4e0a\u3002\u5728\u6570\u5341\u5e74\u524d\uff0c\u8f6f\u76d8\u548c\u5149\u76d8\u7b49\u4e5f\u662f\u5e38\u89c1\u7684\u5b58\u50a8\u4ecb\u8d28\uff0c\u4f46\u662f\u73b0\u5728\u5df2\u7ecf\u5f88\u5c11\u89c1\u4e86\u3002     \u78c1\u76d8\u5411\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u5757\u8bbe\u5907\u7684\u62bd\u8c61\uff0c\u5757\u8bbe\u5907\u662f\u4e00\u79cd\u5177\u6709\u56fa\u5b9a\u5927\u5c0f\uff0c\u53ef\u4ee5\u4ee5\u201c\u6247\u533a\u201d\u4e3a\u5355\u4f4d\u8fdb\u884c\u968f\u673a\u8bfb\u5199\u7684\u8bbe\u5907\u3002</li> <li>\u73b0\u4ee3\u7684\u78c1\u76d8\u652f\u6301\u5206\u533a\uff0c\u901a\u8fc7\u5728\u78c1\u76d8\u4e0a\u5212\u5206\u51fa\u4e92\u4e0d\u91cd\u53e0\u7684\u533a\u57df\uff0c\u53ef\u4ee5\u5c06\u78c1\u76d8\u7684\u5bb9\u91cf\u5212\u5206\u4e3a\u591a\u4e2a\u5c0f\u5757\uff0c\u7528\u4e8e\u4e0d\u540c\u7684\u7528\u9014\u3002</li> <li>\u6587\u4ef6\u7cfb\u7edf\u662f\u4e00\u79cd\u7528\u4e8e\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5b83\u63d0\u4f9b\u4e86\u6587\u4ef6\u548c\u76ee\u5f55\u7684\u6982\u5ff5\uff0c\u4ee5\u53ca\u5bf9\u6587\u4ef6\u7684\u8bfb\u5199\u3001\u5220\u9664\u7b49\u64cd\u4f5c\u3002     \u4e00\u4e2a\u5206\u533a\u4e0a\u53ea\u80fd\u6709\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u4f46\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u8de8\u8d8a\u591a\u4e2a\u5206\u533a\u3002</li> <li> <p>\u5377\u6cdb\u6307\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u53ca\u5176\u5e95\u5c42\u7684\u5b58\u50a8\u533a\u57df\uff0c\u5b83\u53ef\u4ee5\u662f\u4e00\u4e2a\u5206\u533a\uff0c\u4e5f\u53ef\u4ee5\u662f\u591a\u4e2a\u5206\u533a\u7684\u7ec4\u5408\u3002     \u4f8b\u5982\uff0cLVM \u7b49\u903b\u8f91\u5377\u7ba1\u7406\u65b9\u6848\u5c06\u78c1\u76d8\u5206\u533a\u518d\u6b21\u7ec4\u5408\u8d77\u6765\uff0c\u6210\u4e3a\u4e00\u4e2a\u989d\u5916\u7684\u62bd\u8c61\u5c42\u6b21\u3002     \u4e3a\u4e86\u4e0e\u903b\u8f91\u5377\u533a\u5206\uff0c\u6709\u65f6\u5019\u4e5f\u4f1a\u5c06\u76f4\u63a5\u5b58\u5728\u4e8e\u4e00\u4e2a\u78c1\u76d8\u5206\u533a\u4e0a\u7684\u6587\u4ef6\u7cfb\u7edf\u79f0\u4e3a\u7269\u7406\u5377\u3002     \u8fd9\u4e24\u79cd\u6982\u5ff5\u5728\u4f7f\u7528\u4e0a\u6ca1\u6709\u533a\u522b\uff0c\u4ec5\u5728\u63a2\u8ba8\u8ba1\u7b97\u673a\u5b58\u50a8\u65b9\u6848\u65f6\u65b9\u4fbf\u6307\u4ee3\u3002</p> <p>\u7279\u522b\u5730\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u4e0d\u652f\u6301\u5206\u533a\u7684\u53e4\u8463\u8bbe\u5907\uff08\u8f6f\u76d8\uff09\uff0c\u5377\u4e5f\u53ef\u4ee5\u6307\u6574\u4e2a\u8bbe\u5907\u548c\u5176\u4e2d\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>Windows \u4f1a\u5c06\u6240\u6709\u7684\u6587\u4ef6\u7cfb\u7edf\u90fd\u79f0\u4f5c\u201c\u5377\u201d\u3002</p> </li> </ul>"},{"location":"ops/storage/intro/#disks","title":"\u78c1\u76d8","text":""},{"location":"ops/storage/intro/#disk-type","title":"\u78c1\u76d8\u7c7b\u578b\u7b80\u4ecb","text":"<p>\u5728\u670d\u52a1\u5668\u4e0a\u6700\u5e38\u89c1\u7684\u4e3a\u673a\u68b0\u786c\u76d8\uff08HDD\uff09\u548c\u56fa\u6001\u786c\u76d8\uff08SSD\uff09\u3002\u673a\u68b0\u786c\u76d8\u4f7f\u7528\u78c1\u76d8\u7247\u548c\u673a\u68b0\u81c2\u8fdb\u884c\u6570\u636e\u8bfb\u5199\uff0c\u56fa\u6001\u786c\u76d8\u4f7f\u7528\u95ea\u5b58\u82af\u7247\u8fdb\u884c\u6570\u636e\u8bfb\u5199\u3002 \u9664\u6b64\u4ee5\u5916\uff0c\u8fd8\u53ef\u80fd\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u5b58\u50a8\u8bbe\u5907\uff0c\u4f8b\u5982\u78c1\u5e26\u3001Intel Optane \u7b49\uff0c\u8fd9\u91cc\u4e0d\u505a\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u4e00\u822c\u6765\u8bb2\uff0c\u5355\u5757\u673a\u68b0\u786c\u76d8\u7684\u6027\u80fd\u53d6\u51b3\u4e8e RPM\uff08\u8f6c\u901f\uff09\u3002\u5728\u4f30\u7b97\u65f6\u53ef\u4ee5\u8ba4\u4e3a\u987a\u5e8f\u8bfb\u5199\u5e26\u5bbd\u5728 100 MB/s \u5de6\u53f3\uff0c4K \u968f\u673a\u8bfb\u5199\u5e26\u5bbd\u5728 1 MB/s \u5de6\u53f3\uff0cIOPS<sup>1</sup> \u5728 100 \u5de6\u53f3\u3002 \u800c\u5355\u5757\u56fa\u6001\u786c\u76d8\u7684\u987a\u5e8f\u8bfb\u5199\u5e26\u5bbd\u5728 500 MB/s (SATA) \u6216 1500 MB/s (NVMe) \u4ee5\u4e0a\uff0c4K \u968f\u673a\u8bfb\u5199\u5e26\u5bbd\u5728 50 MB/s \u5de6\u53f3\uff0cIOPS \u5728 10000 \u5de6\u53f3\u3002 \u5bf9\u4e8e\u4f01\u4e1a\u7ea7\u786c\u76d8\uff0c\u8fd9\u4e9b\u6027\u80fd\u6307\u6807\u53ef\u80fd\u4f1a\u66f4\u9ad8\u3002</p> <p>\u786c\u76d8\u7684\u4f7f\u7528\u5bff\u547d\u7684\u4e00\u9879\u91cd\u8981\u53c2\u6570\u662f MTBF\uff08Mean Time Between Failures\uff0c\u5e73\u5747\u6545\u969c\u95f4\u9694\u65f6\u95f4\uff09\u3002 \u7531\u4e8e\u673a\u68b0\u786c\u76d8\u5305\u542b\u8fd0\u52a8\u7684\u90e8\u4ef6\uff0c\u673a\u68b0\u786c\u76d8\u7684 MTBF \u4e00\u822c\u4f1a\u6bd4\u56fa\u6001\u786c\u76d8\u4f4e\uff0c\u5927\u81f4\u5728 10 \u4e07\u5c0f\u65f6\u5230 100 \u4e07\u5c0f\u65f6\u3002 \u5c3d\u7ba1\u770b\u8d77\u6765\u5f88\u957f\uff0c\u4f46\u662f\u7531\u4e8e\u5b9e\u9645\u4f7f\u7528\u4e2d\u7684\u632f\u52a8\u3001\u6e29\u5ea6\u3001\u8bfb\u5199\u6b21\u6570\u7b49\u56e0\u7d20\uff0c\u786c\u76d8\u7684\u5b9e\u9645\u5bff\u547d\u53ef\u80fd\u4f1a\u8fdc\u8fdc\u4f4e\u4e8e MTBF\u3002 \u800c\u5bf9\u4e8e SSD \u6765\u8bf4\uff0c\u4e00\u9879\u66f4\u52a0\u91cd\u8981\u7684\u53c2\u6570\u662f TBW\uff08Total Bytes Written\uff0c\u603b\u5199\u5165\u5b57\u8282\u6570\uff09\uff0c\u5b83\u8868\u793a\u4e86\u95ea\u5b58\u82af\u7247\u53ef\u4ee5\u627f\u53d7\u7684\u603b\u5199\u5165\u91cf\uff0c\u4e00\u822c\u5728\u51e0\u5341\u5230\u6570\u5343 TB\uff1b \u8bfb\u53d6\u64cd\u4f5c\u5bf9 SSD \u7684\u635f\u8017\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002</p> <p>\u53e6\u4e00\u9879\u4e0e\u53ef\u9760\u6027\u6709\u5173\u7684\u91cd\u8981\u53c2\u6570\u662f Non-recoverable Read Error Rate\uff08\u4e0d\u53ef\u6062\u590d\u8bfb\u9519\u8bef\u7387\uff09\uff0c\u5b83\u8868\u793a\u4e86\u786c\u76d8\u5728\u8bfb\u53d6\u6570\u636e\u65f6\u51fa\u73b0\u9519\u8bef\u7684\u6982\u7387\u3002 \u5bf9\u4e8e\u673a\u68b0\u786c\u76d8\u6765\u8bb2\uff0c\u8fd9\u4e2a\u503c\u4e00\u822c\u4e3a 10^14 \u5230 10^15\uff0c\u5373\u5e73\u5747\u6bcf\u8bfb\u53d6 10^14\uff0812.5 TB\uff09\u5230 10^15\uff08125 TB\uff09\u4f4d\u7684\u6570\u636e\u4e2d\u4f1a\u6709\u4e00\u4f4d\u51fa\u73b0\u9519\u8bef \uff08\u8fd9\u4e0d\u4ee3\u8868\u8bfb\u53d6\u4e86 12.5/125 TB \u4e4b\u540e\u5c31\u4e00\u5b9a\u4f1a\u9047\u5230\u4e00\u6b21\u9519\u8bef\uff09\u3002 \u800c\u5bf9\u4e8e\u56fa\u6001\u786c\u76d8\uff0c\u4e00\u822c\u4e3a 10^16 \u5230 10^17\u3002 \u5982\u679c\u5728\u91cd\u5efa RAID \u65f6\u9047\u5230\u4e0d\u53ef\u6062\u590d\u9519\u8bef\uff08\u4e5f\u88ab\u79f0\u4e3a URE\uff09\u5e76\u4e14\u6ca1\u6709\u989d\u5916\u7684 parity\uff0c\u90a3\u4e48\u91cd\u5efa\u64cd\u4f5c\u4f1a\u5931\u8d25\u2014\u2014\u5373\u4f7f\u5728\u6700\u597d\u7684\u60c5\u51b5\u4e0b\uff0c\u4e5f\u4f1a\u4e22\u5931\u90e8\u5206\u6570\u636e\u3002</p> <p>\u5bf9\u5177\u4f53\u7684\u786c\u76d8\u578b\u53f7\uff0c\u5efa\u8bae\u9605\u8bfb\u5382\u5546\u7684\u6587\u6863\uff08\u4f8b\u5982 datasheet \u7b49\uff09\uff0c\u4ee5\u83b7\u53d6\u51c6\u786e\u7684\u4fe1\u606f\u3002</p> <p>Zoned storage\uff0c\u4e0e\u53e0\u74e6\uff08SMR\uff09\u76d8</p> <p>Zoned storage \u662f\u4e00\u79cd\u65b0\u578b\u7684\u786c\u76d8\u5b58\u50a8\u6280\u672f\uff0c\u5b83\u5c06\u786c\u76d8\u5206\u4e3a\u591a\u4e2a\u533a\u57df\uff0c\u6bcf\u4e2a\u533a\u57df\u7684\u5199\u5165\u65b9\u5f0f\u4e0d\u540c\uff0c \u901a\u8fc7\u66b4\u9732\u66f4\u591a\u7684\u4fe1\u606f\u7ed9 OS \u4f7f\u5f97\u9488\u5bf9\u6027\u7684\u4f18\u5316\u5f97\u4ee5\u8fdb\u884c\uff0c\u4ee5\u63d0\u5347\u786c\u76d8\u7684\u5bb9\u91cf\u548c\u6027\u80fd\u3002 \u6211\u4eec\u5e38\u8bf4\u7684\u300c\u53e0\u74e6\u76d8\u300d\u5c31\u662f\u4e00\u79cd zoned storage\u3002\u53e0\u74e6\u76d8\u901a\u8fc7\u91cd\u53e0\u78c1\u9053\u7684\u65b9\u5f0f\uff08\u7c7b\u4f3c\u4e8e\u5c4b\u9876\u4e0a\u74e6\u7247\u6392\u5217\u4e00\u822c\uff09\u6765\u589e\u52a0\u5b58\u50a8\u5bc6\u5ea6\u3002 \u5176\u5199\u5165\u548c\u56fa\u6001\u786c\u76d8\u7684\u95ea\u5b58\u6709\u4e00\u4e9b\u76f8\u4f3c\uff1a\u9700\u8981\u5148\u8bfb\u53d6\u4e34\u8fd1\u78c1\u9053\u7684\u6570\u636e\uff0c\u7136\u540e\u64e6\u9664\u6574\u4e2a\u533a\u5757\uff0c\u518d\u91cd\u5199\uff0c\u4f1a\u5f88\u5927\u7a0b\u5ea6\u5f71\u54cd\u5199\u5165\u6027\u80fd\u3002 \u56e0\u6b64\u53e0\u74e6\u76d8\u5185\u90e8\u901a\u5e38\u5212\u5206\u4e3a\u591a\u4e2a\u5199\u5165\u533a\u57df\uff0c\u4ee5\u51cf\u5c0f\u5199\u5165\u6027\u80fd\u7684\u5f71\u54cd\u3002</p> <p>\u4f46\u662f\u4f60\u5728\u5e02\u9762\u4e0a\u53ef\u4ee5\u4e70\u5230\u7684\u53e0\u74e6\u76d8\u51e0\u4e4e\u90fd\u6ca1\u6709\u66b4\u9732 zoned storage \u7684\u63a5\u53e3\u7ed9\u64cd\u4f5c\u7cfb\u7edf\uff08\u8fd9\u4e9b\u76d8\u4e5f\u88ab\u79f0\u4e3a Device-Managed SMR\uff09\uff0c \u56e0\u6b64\u5728\u7cfb\u7edf\u5199\u5165\u65f6\u4ecd\u4f1a\u5c06\u5176\u89c6\u4e3a\u666e\u901a\u786c\u76d8\u3002 \u8fd9\u5bfc\u81f4\u4e86\u53e0\u74e6\u76d8\u7684\u6027\u80fd\u8fdc\u4e0d\u53ca\u4f20\u7edf\u7684\u975e\u91cd\u53e0\u78c1\u9053\u7684\u786c\u76d8\u3002\u786c\u76d8\u5382\u5546\u53ef\u80fd\u4e0d\u4f1a\u6807\u6ce8\u76f8\u5173\u4fe1\u606f\uff0c\u56e0\u6b64\u5728\u8d2d\u4e70\u786c\u76d8\u65f6\u9700\u8981\u7279\u522b\u6ce8\u610f\u3002</p>"},{"location":"ops/storage/intro/#disk-size","title":"\u78c1\u76d8\u89c4\u683c\u4e0e\u5c3a\u5bf8","text":"<p>\u5173\u4e8e\u78c1\u76d8\u89c4\u683c\uff0c\u5728\u670d\u52a1\u5668\u5b89\u88c5\u65f6\u6211\u4eec\u4e3b\u8981\u5173\u5fc3\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u78c1\u76d8\u7684\u5c3a\u5bf8\uff082.5 \u82f1\u5bf8\u30013.5 \u82f1\u5bf8\uff09<ul> <li>\u90e8\u5206\u624b\u518c\u4f1a\u5c06 2.5 \u82f1\u5bf8\u7684\u78c1\u76d8\u79f0\u4e3a SFF\uff08Small Form Factor\uff09\uff0c3.5 \u82f1\u5bf8\u7684\u78c1\u76d8\u79f0\u4e3a LFF\uff08Large Form Factor\uff09\u3002</li> </ul> </li> <li>\u78c1\u76d8\u7684\u63a5\u53e3\u4e0e\u534f\u8bae\uff08SAS\u3001SATA\u3001NVMe\u3001M.2\u3001U.2\uff09</li> <li>\u662f\u5426\u4e0e\u670d\u52a1\u5668\u914d\u7f6e\u517c\u5bb9\uff1a<ul> <li>\u90e8\u5206\u670d\u52a1\u5668\u4f1a\u6709\u786c\u76d8\u767d\u540d\u5355\uff0c\u53ea\u6709\u767d\u540d\u5355\u4e2d\u7684\u786c\u76d8\u624d\u80fd\u8bc6\u522b\u3002</li> <li>\u4f7f\u7528\u7684\u786c\u4ef6 RAID \u65b9\u6848\u53ef\u80fd\u4f1a\u5bf9\u786c\u76d8\u63a5\u53e3\u6709\u8981\u6c42\uff0c\u4f8b\u5982 SATA \u548c SAS \u63a5\u53e3\u7684\u786c\u76d8\u4e0d\u80fd\u6df7\u7528\u3002</li> </ul> </li> </ul> <p>\u4ed4\u7ec6\u9605\u8bfb\u5e76\u786e\u8ba4\u5382\u5546\u6587\u6863</p> <p>\u4e00\u4e2a\u73b0\u5b9e\u4e2d\u53d1\u751f\u8fc7\u7684\u4f8b\u5b50\u662f\uff1a\u5c06\u9519\u8bef\u7684\u786c\u76d8\u6258\u67b6\u5b89\u88c5\u81f3\u670d\u52a1\u5668\u76d8\u4f4d\uff0c\u5bfc\u81f4\u6258\u67b6\u5361\u4f4f\u65e0\u6cd5\u53d6\u51fa\uff0c\u6700\u540e\u8d39\u4e86\u8fd1\u534a\u4e2a\u5c0f\u65f6\uff0c\u751a\u81f3\u7528\u4e0a\u4e86\u87ba\u4e1d\u5200\u4f5c\u4e3a\u6760\u6746\uff0c\u624d\u5c06\u5176\u677e\u52a8\uff0c\u53d6\u51fa\u786c\u76d8\u3002</p> <p>\u78c1\u76d8\u9700\u8981\u5e26\u4e0a\u6258\u67b6\u624d\u80fd\u5b89\u88c5\u5230\u670d\u52a1\u5668\u4e2d\u3002\u6258\u67b6\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u56fa\u5b9a\u4f4f\u78c1\u76d8\uff0c\u5e76\u4e14\u65b9\u4fbf\u5b89\u88c5\u548c\u53d6\u51fa\u3002\u6258\u67b6\u7684\u5c3a\u5bf8\u4e0e\u78c1\u76d8\u7684\u5c3a\u5bf8\u6709\u5173\uff0c3.5 \u82f1\u5bf8\u78c1\u76d8\u7684\u6258\u67b6\u4e00\u822c\u9700\u8981\u5b89\u88c5\u8f6c\u63a5\u677f\u624d\u80fd\u5b89\u88c5 2.5 \u82f1\u5bf8\u7684\u78c1\u76d8\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u6258\u67b6\u9884\u7559\u4e86 2.5 \u82f1\u5bf8\u78c1\u76d8\u7684\u87ba\u4e1d\u5b54\u4f4d\u3002\u540c\u65f6\uff0c\u6258\u67b6\u4e5f\u4e00\u822c\u6709 LED \u706f\uff0c\u5728\u78c1\u76d8\u6545\u969c\u65f6\u4f1a\u4eae\u9ec4\u706f\u6216\u7ea2\u706f\uff0c\u4e5f\u4e00\u822c\u80fd\u591f\u4f7f\u7528\u670d\u52a1\u5668\u7684\u7ba1\u7406\u5de5\u5177\u63a7\u5236\u706f\u95ea\u70c1\u6765\u5b9a\u4f4d\u78c1\u76d8\u3002</p>"},{"location":"ops/storage/intro/#disk-interface","title":"\u78c1\u76d8\u63a5\u53e3\u4e0e\u534f\u8bae","text":"<p>\u673a\u68b0\u786c\u76d8\u4f7f\u7528 SATA\uff08Serial ATA\uff09\u6216 SAS\uff08Serial Attached SCSI\uff09\u63a5\u53e3\u8fde\u63a5\uff0c\u4e00\u4e9b\u56fa\u6001\u786c\u76d8\u4e5f\u4f1a\u4f7f\u7528 SATA \u63a5\u53e3\u3002SATA \u662f\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e0a\u6700\u5e38\u89c1\u7684\u786c\u76d8\u8fde\u63a5\u65b9\u5f0f\uff0c\u800c SAS \u7684\u63a5\u53e3\u5e26\u5bbd\u66f4\u9ad8\uff08\u867d\u7136\u673a\u68b0\u786c\u76d8\u5b9e\u9645\u7684\u4f20\u8f93\u901f\u5ea6\u901a\u5e38\u65e0\u6cd5\u8dd1\u6ee1 SATA \u7684\u5e26\u5bbd\uff09\uff0c\u652f\u6301\u66f4\u591a\u529f\u80fd\uff0c\u5e76\u4e14\u5411\u4e0b\u517c\u5bb9 SATA\uff0c\u56e0\u6b64\u5728\u670d\u52a1\u5668\u4e0a\u66f4\u5e38\u89c1\u3002</p> <p>SATA \u4e0e SAS \u7684\u8be6\u7ec6\u5bf9\u6bd4\u53ef\u53c2\u8003\u82f1\u6587 Wikipedia \u4e2d SAS \u7684 \"Comparison with SATA\" \u4e00\u8282\u3002</p> <p>\u968f\u7740\u56fa\u6001\u786c\u76d8\u7684\u666e\u53ca\uff0cPCIe \u63a5\u53e3\u7684\u56fa\u6001\u786c\u76d8\u4e5f\u8d8a\u6765\u8d8a\u591a\u89c1\u3002PCIe \u63a5\u53e3\u7684\u56fa\u6001\u786c\u76d8\u901a\u5e38\u4f7f\u7528 NVMe \u534f\u8bae\uff0c\u56e0\u6b64\u4e5f\u88ab\u79f0\u4e3a NVMe SSD\u3002NVMe SSD \u5e38\u89c1\u7684\u63a5\u53e3\u5f62\u6001\u6709 U.2\u3001M.2 \u548c AIC\uff08PCIe Add-in Card\uff0c\u5373\u6269\u5c55\u5361\uff09\u3002</p> <ul> <li> <p>M.2 \u63a5\u53e3\u7684\u5c3a\u5bf8\u6700\u5c0f\uff0c\u5728\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e0a\u4e5f\u66f4\u5e38\u89c1\uff0c\u751a\u81f3\u53ef\u4ee5\u653e\u5165\u786c\u76d8\u76d2\u4e2d\u4f5c\u4e3a\u5c0f\u5de7\u8f7b\u4fbf\u7684\u79fb\u52a8\u786c\u76d8\u4f7f\u7528\u3002</p> <ul> <li>\u5e38\u89c1\u7684 M.2 \u63a5\u53e3\u6709 B-key \u548c M-key \u4e24\u79cd\uff0c\u4e3b\u6d41\u7684 NVMe SSD \u901a\u5e38\u4f7f\u7528 M-key \u63a5\u53e3\uff0c\u800c SATA SSD \u901a\u5e38\u4f7f\u7528 B-key \u6216 B+M\uff08\u4e24\u4e2a\u7f3a\u53e3\uff09\u3002\u4e00\u4e2a M.2 \u63a5\u53e3\u662f\u5426\u652f\u6301 NVMe \u6216 SATA \u534f\u8bae\u53d6\u51b3\u4e8e\u4e3b\u677f\u6216\u63a7\u5236\u5668\uff0c\u56e0\u6b64\u5177\u4f53\u60c5\u51b5\u9700\u8981\u53c2\u8003\u4ea7\u54c1\u7684\u8bf4\u660e\u4e66\u3002<ul> <li>\u4f5c\u4e3a\u53c2\u8003\uff0c2023 \u5e74\u4ee5\u6765\u5e02\u9762\u4e0a\u5df2\u7ecf\u89c1\u4e0d\u5230\u53ea\u652f\u6301 SATA \u800c\u4e0d\u652f\u6301 NVme \u7684 M.2 \u63a5\u53e3\u4e86\uff0c\u5c3d\u7ba1 M.2 SATA \u7684 SSD \u4ecd\u7136\u6709\u5356\u3002</li> </ul> </li> <li>\u9664\u4e86\u63a5\u53e3\u7684\u5f62\u72b6\uff0cM.2 \u63a5\u53e3\u7684\u957f\u5bbd\u4e5f\u6709\u4e00\u7cfb\u5217\u9009\u9879\uff0c\u4f8b\u5982 2230\u30012242\u30012280\u300122110 \u7b49\uff0c\u5373\u5bbd\u5ea6\u4e3a 22 mm\uff0c\u957f\u5ea6\u5206\u522b\u4e3a 30\u300142\u300180\u3001110 mm \u7b49\u3002\u4e2a\u4eba\u7535\u8111\u4e00\u822c\u91c7\u7528 2280 \u7684\u5c3a\u5bf8\uff0c\u800c\u670d\u52a1\u5668\uff08\u548c\u4e00\u4e9b\u9ad8\u7aef\u53f0\u5f0f\u673a\u4e3b\u677f\uff09\u4e0a\u53ef\u80fd\u4f1a\u4f7f\u7528 22110 \u7684\u5c3a\u5bf8\u3002\u8fd9\u4e9b\u5c3a\u5bf8\u4e0d\u5f71\u54cd\u63a5\u53e3\u7684\u7535\u6c14\u7279\u6027\uff0c\u53ea\u662f\u4e3a\u4e86\u9002\u5e94\u4e0d\u540c\u7684\u7a7a\u95f4\u548c\u6563\u70ed\u9700\u6c42\u3002</li> </ul> </li> <li> <p>U.2 \u63a5\u53e3\u5f62\u72b6\u4e0e SAS \u7c7b\u4f3c\uff0c\u4f46\u662f\u4e0d\u517c\u5bb9 SAS\uff08\u6bd5\u7adf\u5e95\u5c42\u534f\u8bae\u90fd\u4e0d\u4e00\u6837\uff09\uff0c\u4e14 2.5 \u82f1\u5bf8\u548c 15 mm \u4ee5\u4e0a\u539a\u5ea6\u7684\u5916\u5f62\u76f8\u6bd4 M.2 \u4e5f\u5177\u6709\u66f4\u597d\u7684\u6563\u70ed\u80fd\u529b\uff0c\u662f\u670d\u52a1\u5668\u4e0a\u7684\u5e38\u89c1\u5f62\u6001\u3002</p> </li> <li>AIC \u5c31\u662f\u4e00\u5757 PCIe \u6269\u5c55\u5361\uff0c\u53ef\u4ee5\u63d2\u5165 PCIe \u63d2\u69fd\u4e2d\u4f7f\u7528\u3002</li> </ul> \u56fe\u7247\uff1aM.2 SSD <p> M.2 2280 SSD </p> \u56fe\u7247\uff1aU.2 SSD <p> U.2 SSD </p> \u56fe\u7247\uff1aAIC SSD <p> PCIe \u63d2\u5361\u5f0f SSD </p>"},{"location":"ops/storage/intro/#smart","title":"S.M.A.R.T.","text":"<p>\u78c1\u76d8\u7684 S.M.A.R.T.\uff08Self-Monitoring, Analysis and Reporting Technology\uff0c\u4ee5\u4e0b\u7b80\u79f0\u4e3a SMART\uff09\u529f\u80fd\u53ef\u4ee5\u8bb0\u5f55\u78c1\u76d8\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5e76\u4e14\u5728\u78c1\u76d8\u51fa\u73b0\u6545\u969c\u524d\u63d0\u4f9b\u9884\u8b66\u3002SMART \u53ef\u4ee5\u8bb0\u5f55\u78c1\u76d8\u7684\u6e29\u5ea6\u3001\u8bfb\u5199\u9519\u8bef\u7387\u3001\u78c1\u76d8\u65cb\u8f6c\u901f\u5ea6\u3001\u78c1\u76d8\u7684\u5bff\u547d\u7b49\u4fe1\u606f\u3002</p> <p>Linux \u7cfb\u7edf\u4e0a\u53ef\u4ee5\u5b89\u88c5 <code>smartmontools</code> \u5305\u6765\u67e5\u770b\u78c1\u76d8\u7684 SMART \u4fe1\u606f\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u53ef\u7528\u7684\u78c1\u76d8\u4e0e\u5176 SMART \u72b6\u6001\uff1a</p> <pre><code>$ sudo smartctl --scan\n/dev/nvme0 -d nvme # /dev/nvme0, NVMe device\n$ sudo smartctl -a /dev/nvme0\n\uff08\u5185\u5bb9\u7701\u7565\uff09\n</code></pre> <p>\u6709\u5173 SMART \u6307\u6807\u89e3\u91ca\u4e0e\u76d1\u63a7\u7684\u5185\u5bb9\u5c06\u4f1a\u5728 RAID \u4e2d\u4ecb\u7ecd\u3002</p>"},{"location":"ops/storage/intro/#trim","title":"Trim (Discard/Unmap)","text":"<p>SSD \u7684\u95ea\u5b58\u5b58\u50a8\u7684\u7279\u70b9\u662f\uff1a\u4e0d\u652f\u6301\u4efb\u610f\u7684\u968f\u673a\u5199\uff0c\u4fee\u6539\u6570\u636e\u53ea\u80fd\u901a\u8fc7\u6e05\u7a7a\u533a\u5757\u4e4b\u540e\u91cd\u65b0\u5199\u5165\u6765\u5b9e\u73b0\u3002\u5e76\u4e14\u533a\u5757\u80fd\u591f\u7ecf\u53d7\u7684\u5199\u5165\u6b21\u6570\u662f\u6709\u9650\u7684\u3002 SSD \u4e2d\u7684\u56fa\u4ef6\u4f1a\u8fdb\u884c\u533a\u5757\u7ba1\u7406\uff0c\u4ee5\u5c06\u5199\u5165\u5e26\u6765\u7684\u78e8\u635f\u5206\u6563\u5230\u6240\u6709\u533a\u5757\u4e2d\u3002\u4f46\u662f\uff0c\u56fa\u4ef6\u5e76\u4e0d\u6e05\u695a\u6587\u4ef6\u7cfb\u7edf\u7684\u60c5\u51b5\uff0c\u56e0\u6b64\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5220\u9664\u67d0\u4e2a\u6587\u4ef6\u4e4b\u540e\uff0c SSD \u56fa\u4ef6\u4f1a\u4ecd\u7136\u8ba4\u4e3a\u5bf9\u5e94\u7684\u533a\u5757\u5b58\u50a8\u4e86\u6570\u636e\uff0c\u4e0d\u80fd\u91ca\u653e\u3002Trim \u64cd\u4f5c\u7531\u64cd\u4f5c\u7cfb\u7edf\u53d1\u51fa\uff0c\u544a\u8bc9\u56fa\u4ef6\u54ea\u4e9b\u533a\u5757\u53ef\u4ee5\u91ca\u653e\uff0c\u4ee5\u63d0\u5347\u6027\u80fd\uff0c\u5ef6\u957f SSD \u4f7f\u7528\u5bff\u547d\u3002\u4e00\u4e9b\u7279\u6b8a\u7684\u5b58\u50a8\u8bbe\u5907\u4e5f\u4f1a\u652f\u6301 trim \u64cd\u4f5c\uff0c\u4f8b\u5982\u865a\u62df\u673a\u78c1\u76d8\uff08<code>virtio-scsi</code>\uff09\u3001\u90e8\u5206\u4f01\u4e1a\u7ea7\u7684 SAN \u7b49\u3002</p> \u5173\u6ce8\u5b58\u50a8\u7684\u53ef\u7528\u7a7a\u95f4\u6bd4\u4f8b <p>\u4e0d\u5efa\u8bae\u5c06\u5b58\u50a8\u7684\u53ef\u7528\u7a7a\u95f4\u5168\u90e8\u6216\u63a5\u8fd1\u5168\u90e8\u8017\u5c3d\uff0c\u8fd9\u662f\u56e0\u4e3a\uff1a</p> <ul> <li>\u673a\u68b0\u786c\u76d8\uff1a\u53ef\u7528\u7a7a\u95f4\u4e0d\u8db3\u65f6\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u5b58\u50a8\u6570\u636e\uff0c\u4f1a\u4e0d\u5f97\u4e0d\u4ea7\u751f\u5927\u91cf\u78c1\u76d8\u788e\u7247\uff0c\u800c\u673a\u68b0\u786c\u76d8\u7684\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5f88\u5dee\uff1b</li> <li>\u56fa\u6001\u786c\u76d8\uff1a\u53ef\u7528\u7a7a\u95f4\u4e0d\u8db3\u4f1a\u5bfc\u81f4\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u533a\u5757\u6539\u5199\u5185\u5bb9\uff0c\u56e0\u6b64\u53ef\u80fd\u4e0d\u5f97\u4e0d\u5927\u91cf\u91cd\u590d\u64e6\u5199\u5df2\u6709\u7684\u533a\u5757\uff0c\u52a0\u901f\u78e8\u635f\u3002</li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u786e\u4fdd <code>fstrim.timer</code> \u5904\u4e8e\u542f\u7528\u72b6\u6001\u5373\u53ef\u3002\u4e00\u4e9b\u6587\u4ef6\u7cfb\u7edf\u4e5f\u652f\u6301\u8c03\u6574 trim/discard \u53c2\u6570\uff08\u7acb\u5373 discard \u6216\u5468\u671f\u6027 discard\uff0c \u4e00\u822c\u63a8\u8350\u540e\u8005\uff09\u3002</p>"},{"location":"ops/storage/intro/#raid","title":"RAID","text":"<p>RAID\uff08Redundant Array of Inexpensive Disks\uff09\u662f\u4e00\u79cd\u5c06\u591a\u4e2a\u78c1\u76d8\u7ec4\u5408\u5728\u4e00\u8d77\u5b9e\u73b0\u6570\u636e\u5197\u4f59\u548c\u6027\u80fd\u63d0\u5347\u7684\u6280\u672f\u3002\u4e0d\u540c\u7684\u78c1\u76d8\u7ec4\u5408\u65b9\u5f0f\u79f0\u4e3a\u201cRAID \u7ea7\u522b\uff08RAID Level\uff09\u201d\uff0c\u5e38\u89c1\u7684\u6709 RAID 0\u3001RAID 1\u3001RAID 5\u3001RAID 6\u3001RAID 10 \u7b49\u3002</p> RAID 0 <p>\u4e5f\u79f0\u4f5c\u6761\u5e26\u5316\uff08Striped\uff09\uff0c\u5c06\u6570\u636e\u5206\u5757\u5b58\u50a8\u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u53ef\u4ee5\u5145\u5206\u5229\u7528\u6240\u6709\u5bb9\u91cf\uff0c\u83b7\u5f97\u53e0\u52a0\u7684\u987a\u5e8f\u8bfb\u5199\u6027\u80fd\uff08\u4f46\u968f\u673a\u8bfb\u5199\u6027\u80fd\u4e00\u822c\uff09\uff0c\u4f46\u6ca1\u6709\u5197\u4f59\uff0c\u4efb\u4f55\u4e00\u5757\u78c1\u76d8\u635f\u574f\u90fd\u4f1a\u5bfc\u81f4\u6574\u4e2a\u9635\u5217\u7684\u6570\u636e\u4e22\u5931\uff0c\u9002\u5408\u9700\u8981\u9ad8\u6027\u80fd\u8bfb\u5199\u4f46\u4e0d\u9700\u8981\u6570\u636e\u5b89\u5168\u6027\u7684\u573a\u666f\u3002</p> RAID 1 <p>\u4e5f\u79f0\u4f5c\u955c\u50cf\uff08Mirrored\uff09\uff0c\u5c06\u6570\u636e\u5b8c\u5168\u590d\u5236\u5230\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u63d0\u4f9b\u4e86\u7edd\u5bf9\u5197\u4f59\uff0c\u6574\u4e2a\u9635\u5217\u4e2d\u53ea\u9700\u8981\u6709\u4e00\u5757\u76d8\u5b58\u6d3b\uff0c\u6570\u636e\u5c31\u4e0d\u4f1a\u4e22\u5931\u3002\u4ee3\u4ef7\u662f\u6574\u4e2a\u9635\u5217\u7684\u5bb9\u91cf\u7b49\u5355\u5757\u78c1\u76d8\u7684\u5bb9\u91cf\uff0c\u7a7a\u95f4\u5229\u7528\u7387\u4f4e\u4e0b\uff0c\u9002\u5408\u9700\u8981\u9ad8\u53ef\u9760\u6027\u800c\u4e14\u4e0d\u7f3a\u94b1\u7684\u573a\u666f\u3002\u540c\u65f6\u7531\u4e8e\u6bcf\u5757\u76d8\u4e0a\u7684\u6570\u636e\u5b8c\u5168\u4e00\u81f4\uff0cRAID 1 \u7684\u8bfb\u53d6\u6027\u80fd\u53ef\u4ee5\u53e0\u52a0\uff08\u751a\u81f3\u5305\u62ec\u968f\u673a\u8bfb\u53d6\uff09\uff0c\u4f46\u5199\u5165\u6027\u80fd\u4e0d\u4f1a\u63d0\u5347\u3002</p> RAID 5 <p>\u5c06\u6570\u636e\u548c\u4e00\u4efd\u6821\u9a8c\u4fe1\u606f\u5206\u5757\u5b58\u50a8\u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u53ef\u4ee5\u5141\u8bb8\u9635\u5217\u4e2d\u4efb\u4f55\u4e00\u5757\u78c1\u76d8\u635f\u574f\uff0c\u517c\u987e\u5197\u4f59\u6027\u548c\u5bb9\u91cf\u5229\u7528\u7387\u3002\u91cd\u5efa\u671f\u95f4\u7684\u6027\u80fd\u4f1a\u4e25\u91cd\u4e0b\u964d\uff0c\u5e76\u4e14\u4e00\u65e6\u5728\u91cd\u5efa\u5b8c\u6210\u524d\u53c8\u574f\u4e86\u4e00\u5757\u76d8\uff0c\u90a3\u4e48\u4f60\u5c31\u5bc4\u4e86\u3002</p> <p>\u4e0d\u8981\u4e3a\u5927\u5bb9\u91cf\u673a\u68b0\u786c\u76d8\u9635\u5217\u7ec4 RAID 5</p> <p>\u5426\u5219\u574f\u4e86\u4e00\u5757\u76d8\u540e\u91cd\u5efa\u7684\u65f6\u5019\u5c31\u7b49\u6b7b\u5427\u3002</p> <p>\u4e0b\u9762\u7684\u601d\u8003\u9898\u4e5f\u4f1a\u6d89\u53ca\u5230\u8fd9\u4e2a\u95ee\u9898\u3002</p> RAID 6 <p>\u5c06\u6570\u636e\u548c\u4e24\u4efd\u6821\u9a8c\u4fe1\u606f\u5206\u5757\u5b58\u50a8\u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u6bd4 RAID 5 \u591a\u4e86\u4e00\u4efd\u6821\u9a8c\u4fe1\u606f\uff0c\u53ef\u4ee5\u5bb9\u7eb3\u4e24\u5757\u78c1\u76d8\u635f\u574f\uff0c\u9002\u5408\u5927\u5bb9\u91cf\u6216\u8005\u78c1\u76d8\u8f83\u591a\u7684\u9635\u5217\u3002\u5c3d\u7ba1\u5141\u8bb8\u4e24\u5757\u76d8\u635f\u574f\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u5efa\u8bae\u5728\u7b2c\u4e00\u5757\u76d8\u635f\u574f\u540e\u7acb\u5373\u66f4\u6362\u5e76\u91cd\u5efa\uff0c\u4e0d\u8981\u7b49\u5230\u66f4\u5371\u9669\u7684\u65f6\u5019\u3002</p> RAID 10, 50, 60 <p>\u5c06\u4e0d\u540c\u7ea7\u522b\u7684 RAID \u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u517c\u987e\u6027\u80fd\u548c\u5197\u4f59\uff0c\u5404\u53d6\u6240\u957f\uff0c\u5bf9\u4e8e 10 \u5757\u76d8\u4ee5\u4e0a\u7684\u9635\u5217\u662f\u66f4\u52a0\u5e38\u89c1\u7684\u9009\u62e9\u3002\u4f8b\u5982 RAID 10 = RAID 1 + RAID 0\uff0c\u901a\u5e38\u5c06\u6bcf\u4e24\u5757\u76d8\u7ec4\u6210 RAID 1\uff0c\u518d\u5c06\u8fd9\u4e9b RAID 1 \u7684\u7ec4\u5408\u62fc\u6210\u4e00\u4e2a\u5927 RAID 0\u3002</p> <p>\u78c1\u76d8\u9635\u5217\u4e0d\u662f\u5907\u4efd</p> <p>RAID \u4e0d\u662f\u5907\u4efd\uff0c\u5b83\u53ef\u4ee5\u5b9e\u73b0\u5728\u67d0\u5757\u78c1\u76d8\u6545\u969c\u65f6\u4fdd\u8bc1\u7cfb\u7edf\u7ee7\u7eed\u8fd0\u884c\uff0c\u4f46\u662f\u4e0d\u80fd\u5728\u6570\u636e\u8bef\u5220\u9664\u3001\u81ea\u7136\u707e\u5bb3\u3001\u4eba\u4e3a\u7834\u574f\u7b49\u60c5\u51b5\u4e0b\u4fdd\u62a4\u6570\u636e\u3002</p> <p></p> <p>\u56fe\u7247\u6765\u81ea\u91d1\u67aa\u9c7c\u4e4b\u591c\uff1a\u5b9e\u9a8c\u7269\u7406\u5783\u573e\u4f6c\u4e4b\u4e50\u2014\u2014PB \u7ea7\u78c1\u76d8\u9635\u5217\u6f14\u8fdb</p>"},{"location":"ops/storage/intro/#raid-compare","title":"RAID \u7b49\u7ea7\u6bd4\u8f83","text":"\u7b49\u7ea7 \u5bb9\u91cf \u5197\u4f59 \u8bfb\u5199\u6027\u80fd \u9002\u7528\u573a\u666f RAID 0 \u5168\u90e8\u53e0\u52a0 \u65e0\uff0c\u6302\u4e00\u5757\u76d8\u5c31\u5bc4\u4e86 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u9ad8\uff0c\u968f\u673a\u8bfb\u5199\u6027\u80fd\u4e00\u822c\uff08\u7565\u597d\u4e8e\u5355\u5757\u76d8\uff09 \u4e34\u65f6\u6570\u636e\u3001\u7f13\u5b58 RAID 1 \u5355\u5757\u76d8 \u6700\u9ad8\uff0c\u53ea\u8981\u6709\u4e00\u5757\u76d8\u5b58\u6d3b\u5c31\u884c \u53e0\u52a0\u7684\u8bfb\u6027\u80fd\uff0c\u4f46\u662f\u53ea\u6709\u5355\u5757\u76d8\u7684\u5199\u6027\u80fd \u91cd\u8981\u6570\u636e RAID 5 N-1 \u5757\u76d8 \u53ef\u4ee5\u574f\u4e00\u5757\u76d8 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u9ad8\uff0c\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5dee\uff1b\u91cd\u5efa\u671f\u95f4\u5f88\u5dee \u517c\u987e\u5bb9\u91cf\u548c\u5b89\u5168\u6027 RAID 6 N-2 \u5757\u76d8 \u53ef\u4ee5\u574f\u4e24\u5757\u76d8 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u9ad8\uff0c\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5dee\uff1b\u91cd\u5efa\u671f\u95f4\u66f4\u5dee \u6bd4 RAID 5 \u66f4\u7a33\u4e00\u70b9 RAID 10 \u6bcf\u7ec4 RAID 1 \u5bb9\u91cf\u53e0\u52a0 \u6bcf\u7ec4 RAID 1 \u5185\u53ea\u9700\u8981\u5b58\u6d3b\u4e00\u5757\u76d8 \u987a\u5e8f\u548c\u968f\u673a\u6027\u80fd\u90fd\u4e0d\u9519\uff0c\u5e76\u4e14\u91cd\u5efa\u671f\u95f4\u8fd8\u51d1\u5408 \u517c\u987e\u6027\u80fd\u548c\u5b89\u5168\u6027 RAID 60 \uff08\u81ea\u884c\u8ba1\u7b97\uff09 \u6bcf\u7ec4 RAID 6 \u5185\u53ef\u4ee5\u574f\u4e24\u5757\u76d8 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u4e0d\u9519\uff0c\u5e76\u4e14\u91cd\u5efa\u671f\u95f4\u66f4\u51d1\u5408\u4e86 \u76d8\u5f88\u591a\uff0c\u5e76\u4e14\u517c\u987e\u5bb9\u91cf\u548c\u5b89\u5168\u6027 <p>RAID 4 \u548c RAID 50 \u5728\u8fd9\u91cc\u4e0d\u4f5c\u8ba8\u8bba\uff0c\u56e0\u4e3a\u5b83\u4eec\u6ca1\u4eba\u7528\u3002</p> <p>\u601d\u8003\u9898</p> <ol> <li>\u4e3a\u4ec0\u4e48 RAID 5 \u548c RAID 6 \u7684\u91cd\u5efa\u671f\u95f4\u6027\u80fd\u4f1a\u5f88\u5dee\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u5c06\u5927\u91cf\u7684\u78c1\u76d8\u7ec4\u5408\u6210\u5355\u4e2a RAID 6 \u4e0d\u662f\u4e00\u4e2a\u597d\u4e3b\u610f\uff1f\u4e3a\u4ec0\u4e48 RAID 50 \u6ca1\u4eba\u7528\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u8bf4 RAID 5/6 \u6709\u5f88\u9ad8\u7684\u5199\u60e9\u7f5a\uff08Write penalty\uff09\uff1f</li> <li> <p>\u5728\u8be5\u5e16\u5b50\u4e2d\uff0c\u53d1\u5e16\u4eba\u8bf4\u81ea\u5df1\u7ec4\u4e86 14TB * 12 \u7684 RAID 5\u3002     \u5047\u8bbe\u8fd9 12 \u5757\u76d8\u662f\u673a\u68b0\u786c\u76d8\uff0c\u4e0d\u53ef\u6062\u590d\u8bfb\u9519\u8bef\u7387\u4e3a 10^14\uff0c\u5982\u679c\u4ec5\u8003\u8651 URE\uff0c\u90a3\u4e48\u5f53\u635f\u574f\u4e86\u4e00\u5757\u76d8\u91cd\u5efa\u65f6\uff0c\u91cd\u5efa\u6210\u529f\u7684\u6982\u7387\u662f\u591a\u5c11\uff1f     \u5982\u679c\u4e0d\u53ef\u6062\u590d\u8bfb\u9519\u8bef\u7387\u4e3a 10^15 \u5462\uff1f</p> <p>\u63d0\u793a\uff1a\u5047\u8bbe\u4e3a\u4e8c\u9879\u5206\u5e03\uff0c\u524d\u8005\u7ed3\u679c\u63a5\u8fd1\u4e8e 0\uff08\u51e0\u4e4e\u4e0d\u53ef\u80fd\u6210\u529f\uff09\uff0c\u540e\u8005\u7ed3\u679c\u63a5\u8fd1\u4e8e 0.25\uff08\u51f6\u591a\u5409\u5c11\uff09\u3002</p> </li> </ol>"},{"location":"ops/storage/intro/#raid-implementation","title":"RAID \u5b9e\u73b0\u65b9\u5f0f","text":"<p>RAID \u53ef\u4ee5\u5728\u786c\u4ef6\u5c42\u9762\u5b9e\u73b0\uff0c\u4e5f\u53ef\u4ee5\u5728\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u901a\u8fc7\u8f6f\u4ef6\u5b9e\u73b0\u3002</p> <p>\u786c\u4ef6\uff1a</p> <ul> <li>LSI MegaRAID \u7cfb\u5217\u662f\u6700\u5e38\u89c1\u7684\u786c\u4ef6 RAID \u5361</li> <li>HPE Smart Array \u7cfb\u5217</li> <li>\u4e00\u4e9b\u4e13\u7528\u7684\u5b58\u50a8\u670d\u52a1\u5668\uff0c\u5982 HPE MSA\u3001Dell EMC PowerVault \u7b49\u5b58\u50a8\u7f51\u7edc\uff08SAN\uff09\u8bbe\u5907</li> <li>Intel RST \u548c Intel VMD\uff0c\u662f\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e0a\u5e38\u89c1\u7684\u786c\u4ef6 RAID \u65b9\u6848\uff08\u4f46\u662f\u975e\u5e38\u96be\u7528\uff09</li> </ul> <p>Windows\uff1a</p> <ul> <li>\u8f83\u65e9\u7684\u201c\u52a8\u6001\u78c1\u76d8\u201d\u529f\u80fd\u652f\u6301 RAID 0\u30011\u30015 \u7b49\u7ea7\u522b\uff0c\u5e76\u4e14\u662f\u5728\u5206\u533a\u5c42\u9762\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u540c\u4e00\u4e2a\u786c\u76d8\u7ec4\u4e0a\u53ef\u4ee5\u540c\u65f6\u5b58\u5728\u591a\u4e2a\u91c7\u7528\u4e0d\u540c RAID \u7ea7\u522b\u7684\u5377\uff08\u6587\u4ef6\u7cfb\u7edf\uff09</li> <li>\u8f83\u65b0\u7684 Windows \u5f00\u59cb\u652f\u6301 Storage Spaces\uff0c\u53ef\u4ee5\u5b9e\u73b0\u66f4\u591a RAID \u7ea7\u522b\uff0c\u4ee5\u53ca\u201c\u955c\u50cf\u52a0\u901f\u201d\u3001\u201c\u81ea\u52a8\u70ed\u8fc1\u79fb\u201d\u7b49\u529f\u80fd\uff0c\u4f46\u662f\u6bd4\u52a8\u6001\u78c1\u76d8\u66f4\u52a0\u96be\u7528\uff0c\u91cd\u5efa\u4e5f\u66f4\u590d\u6742</li> </ul> <p>Linux\uff1a</p> <ul> <li>mdadm \u662f Linux \u4e0a\u6700\u5e38\u89c1\u7684\u8f6f\u4ef6 RAID \u5b9e\u73b0\u65b9\u5f0f\u4e4b\u4e00</li> <li>Linux \u5e38\u7528\u7684\u903b\u8f91\u5377\u7ba1\u7406\u5de5\u5177 LVM \u4e5f\u652f\u6301 RAID \u529f\u80fd</li> <li>\u4e00\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\uff0c\u5982 ZFS \u548c Btrfs\uff0c\u4e5f\u652f\u6301 RAID \u529f\u80fd</li> </ul> <p>\u670d\u52a1\u5668\u4e00\u822c\u90fd\u914d\u5907\u4e86\u786c\u4ef6 RAID \u5361\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u8f6f\u4ef6 RAID\uff0c\u9700\u8981\u8bbe\u7f6e RAID \u5361\u6216\u5bf9\u5e94\u78c1\u76d8\u5230 HBA \u6a21\u5f0f\uff08\u4e5f\u53eb JBOD/Non-RAID/\u76f4\u901a \u6a21\u5f0f\uff09\u3002 \u4e00\u90e8\u5206\u4f4e\u7aef RAID \u5361\u4e0d\u63d0\u4f9b\u76f8\u5173\u529f\u80fd\u7684\u652f\u6301\uff0c\u5c3d\u7ba1\u53ef\u4ee5\u901a\u8fc7\u4e3a\u6bcf\u5757\u78c1\u76d8\u521b\u5efa\u5355\u72ec\u7684 RAID 0 \u9635\u5217\u5b9e\u73b0\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u3002</p>"},{"location":"ops/storage/intro/#benchmark","title":"\u6027\u80fd\u6d4b\u8bd5","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>fio</code> \u6d4b\u8bd5\u78c1\u76d8\u7684\u6027\u80fd\uff0c\u5176\u652f\u6301\u5728\u6587\u4ef6\u7cfb\u7edf\u6216\u8005\u5757\u8bbe\u5907\u4e0a\u4f7f\u7528\u4e0d\u540c\u7684 I/O \u8bbf\u95ee\u6a21\u5f0f\u8fdb\u884c\u6d4b\u8bd5\u3002</p> <p>\u4f7f\u7528 dd \u6d4b\u901f\u7684\u4e0d\u8db3</p> <p>\u4ee5\u4e0b\u662f\u4f7f\u7528 dd \u547d\u4ee4\u6d4b\u8bd5\u4e00\u5757\u5e0c\u6377 4TB \u673a\u68b0\u786c\u76d8\u7684\u4f8b\u5b50\uff1a</p> <pre><code># \u6d4b\u8bd5\u5199\n$ dd if=/dev/zero of=test.img bs=1M count=1000 oflag=direct\n1000+0 records in\n1000+0 records out\n1048576000 bytes (1.0 GB, 1000 MiB) copied, 11.3336 s, 92.5 MB/s\n# \u6d4b\u8bd5\u8bfb\n$ dd if=/dev/sda1 of=/dev/null bs=1M count=1000 iflag=direct\n1000+0 records in\n1000+0 records out\n1048576000 bytes (1.0 GB, 1000 MiB) copied, 6.68942 s, 157 MB/s\n</code></pre> <p>\u867d\u7136\u53ef\u4ee5\u4f7f\u7528 dd \u547d\u4ee4\u7b80\u6613\u5730\u6d4b\u901f\uff0c\u4f46\u662f dd \u547d\u4ee4\u6709\u4e00\u4e9b\u7f3a\u70b9\uff1a</p> <ul> <li>dd \u53ea\u80fd\u6d4b\u8bd5\u987a\u5e8f\u8bfb\u5199\u7684\u60c5\u51b5\uff0c\u65e0\u6cd5\u6d4b\u8bd5\u968f\u673a\u8bfb\u5199\u3002</li> <li>dd \u4f7f\u7528\u975e\u5e38\u4f4e\u7684 I/O \u961f\u5217\u6df1\u5ea6\uff0c\u65e0\u6cd5\u5145\u5206\u6d4b\u8bd5\u8bbe\u5907\u7684\u5e76\u53d1\u6027\u80fd\uff0c\u8fd9\u5bf9\u4e8e\u56fa\u6001\u786c\u76d8\u5c24\u4e3a\u660e\u663e\u3002</li> <li>dd \u547d\u4ee4\u4e2d\u4f7f\u7528\u7684\u7279\u6b8a\u8bbe\u5907 <code>/dev/urandom</code>\u3001<code>/dev/random</code> \u672c\u8eab\u6027\u80fd\u6709\u9650\uff0c\u53ef\u80fd\u4f1a\u6210\u4e3a\u6d4b\u8bd5\u7684\u74f6\u9888\u3002\uff08\u6bd4\u5982\u6d4b\u8bd5 <code>dd if=/dev/random of=/dev/null bs=1M count=1000</code> \u53ef\u80fd\u53ea\u6709 500MB/s \u7684\u901f\u5ea6\uff09</li> </ul> <p>\u56e0\u6b64\u8981\u5bf9\u78c1\u76d8\u8fdb\u884c\u66f4\u52a0\u5168\u9762\u7684\u6027\u80fd\u6d4b\u8bd5\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 fio \u8fd9\u6b3e\u66f4\u52a0\u4e13\u4e1a\u7684\u5de5\u5177\u3002</p> <p>\u4f7f\u7528 fio \u8fdb\u884c\u6d4b\u8bd5\u9700\u8981\u786e\u5b9a\u4ee5\u4e0b\u57fa\u7840\u53c2\u6570\uff0c\u8fd9\u4e9b\u53c2\u6570\u63cf\u8ff0\u4e86 I/O \u8d1f\u8f7d\u662f\u4ec0\u4e48\u6837\u7684\uff1a</p> <ul> <li><code>--rw</code>\uff1aI/O \u8bbf\u95ee\u7684\u6a21\u5f0f\uff0c\u4f8b\u5982 <code>read</code>, <code>write</code>\uff08\u987a\u5e8f\u8bfb\u5199\uff09, <code>randread</code>, <code>randwrite</code>\uff08\u968f\u673a\u8bfb\u5199\uff09, <code>randrw</code>\uff08\u968f\u673a\u6df7\u5408\u8bfb\u5199\uff09\u7b49\u3002</li> <li><code>--bs</code>\uff1a\u6bcf\u6b21 I/O \u64cd\u4f5c\u7684\u5757\u5927\u5c0f\uff0c\u9ed8\u8ba4\u4e3a 4KB\u3002bs \u5bf9\u6027\u80fd\u5f71\u54cd\u5f88\u5927\uff0c\u7535\u5546\u5e73\u53f0\u786c\u76d8\u6807\u79f0\u7684\u901f\u5ea6\u901a\u5e38\u90fd\u662f 1MB \u5927\u5757\u987a\u5e8f\u8bfb\u5199\u7684\u901f\u5ea6\uff08\u4ee3\u8868\u4e86\u62f7\u8d1d\u5927\u6587\u4ef6\u65f6\u7684\u901f\u5ea6\uff09\uff0c\u800c\u66f4\u52a0\u5f71\u54cd\u5b9e\u9645\u4f7f\u7528\u4f53\u9a8c\u7684 4k \u7684\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5219\u8981\u5f31\u5f97\u591a\u3002</li> <li> <p><code>--size</code>\uff1a\u6d4b\u8bd5\u6587\u4ef6\u7684\u5927\u5c0f\u3002\u652f\u6301 k/m/g/t/p \u540e\u7f00\uff08\u5b57\u8282 B \u53ef\u4ee5\u7701\u7565\uff09\uff0c\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u3002\u4f7f\u7528 1024 \u500d\u7387\uff0c\u8981\u4f7f\u7528 1000 \u500d\u7387\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>kib</code>, <code>mib</code> \u7b49\u3002</p> <p>SI \u4e0e IEC \u5355\u4f4d</p> <p>SI \u5355\u4f4d\u662f\u56fd\u9645\u5355\u4f4d\u5236\u4e2d\u7684\u5355\u4f4d\uff0c\u91c7\u7528 10 \u8fdb\u5236\uff08\u5373 1 KB = 1000 B\uff09\uff1bIEC \u5355\u4f4d\u662f\u56fd\u9645\u7535\u5de5\u59d4\u5458\u4f1a\u7684\u5355\u4f4d\uff0c\u91c7\u7528\u4e8c\u8fdb\u5236\u548c\u5e26\u6709 i \u7684\u5355\u4f4d\uff08\u5373 1 KiB = 1024 B\uff09\u3002</p> <p>fio \u51fa\u4e8e\u5bf9\u65e7\u811a\u672c\u7684\u517c\u5bb9\u6027\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4ea4\u6362\u4e86 SI \u548c IEC \u5355\u4f4d\u7684\u542b\u4e49\uff0c\u5373\u4e0d\u5e26 i \u7684\u4f7f\u7528 1024 \u500d\u7387\uff0c\u800c\u5e26 i \u7684\u91c7\u7528 1000 \u500d\u7387\u3002\u8fd9\u5728 fio \u6587\u6863\u4e2d\u6709\u8bf4\u660e\uff08\u53c2\u6570 <code>kb_base</code>\uff09\u3002</p> </li> <li> <p><code>--ioengine</code>\uff1a\u4f7f\u7528\u7684 I/O \u5f15\u64ce\u3002\u9ed8\u8ba4\u4e3a <code>psync</code>\uff08\u4f7f\u7528 pread/pwrite \u7cfb\u7edf\u8c03\u7528\uff09\u3002\u5728 Linux \u4e0a\u63a8\u8350\u9009\u62e9 <code>libaio</code> \u6765\u4f7f\u7528\u7cfb\u7edf\u7684\u5f02\u6b65 I/O \u63a5\u53e3\uff0c\u6b64\u65f6\u5efa\u8bae\u6dfb\u52a0 <code>--direct=1</code> \u53c2\u6570\u4f7f\u7528\u975e\u7f13\u51b2 I/O\uff0c\u56e0\u4e3a Linux \u4e0a\u7f13\u51b2 I/O \u4e0d\u662f\u5f02\u6b65\u7684\u3002</p> </li> <li><code>--iodepth</code>: \u5e76\u53d1\uff08\u5904\u4e8e\u672a\u5b8c\u6210\u72b6\u6001\u7684\uff09I/O \u64cd\u4f5c\u7684\u6570\u91cf\uff0c\u901a\u5e38\u548c\u5f02\u6b65 I/O \u5f15\u64ce\u7ed3\u5408\u4f7f\u7528\u3002\u589e\u52a0 <code>iodepth</code> \u53ef\u4ee5\u663e\u8457\u63d0\u9ad8\u541e\u5410\u91cf\u3002</li> <li><code>--numjobs</code>\uff1afork \u82e5\u5e72\u8fdb\u7a0b\u6267\u884c\u76f8\u540c\u7684 I/O \u4efb\u52a1\uff0c\u7528\u4e8e\u8fdb\u884c\u5e76\u53d1\u6d4b\u8bd5\u3002\u6b64\u65f6\u5efa\u8bae\u6dfb\u52a0 <code>--group_reporting</code> \u53c2\u6570\uff0c\u8fd9\u6837\u6240\u6709\u8fdb\u7a0b\u7684\u6570\u636e\u4f1a\u88ab\u7d2f\u52a0\u5230\u4e00\u8d77\u3002</li> </ul> <p>\u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u7684\u53c2\u6570\u5f71\u54cd fio \u5982\u4f55\u8fd0\u884c\uff1a</p> <ul> <li><code>--filename</code>\uff1a\u6d4b\u8bd5\u7684\u6587\u4ef6\u540d\u6216\u8005\u5757\u8bbe\u5907\u540d\u3002fio \u9ed8\u8ba4\u4e3a\u6bcf\u4e2a\u4efb\u52a1\u751f\u6210\u5355\u72ec\u6d4b\u8bd5\u6587\u4ef6\uff0c\u4f7f\u7528\u8be5\u9009\u9879\u4f7f\u6240\u6709\u4efb\u52a1\u4f7f\u7528\u76f8\u540c\u6587\u4ef6\u3002\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528<code>--directory</code>\u6307\u5b9a\u6d4b\u8bd5\u6587\u4ef6\u7684\u76ee\u5f55\uff08\u9ed8\u8ba4\u4e3a\u5f53\u524d\u76ee\u5f55\uff09\u3002</li> <li><code>--name</code>\uff1a\u4efb\u52a1\u7684\u540d\u79f0\u3002fio \u53ef\u4ee5\u540c\u65f6\u8fd0\u884c\u591a\u4e2a\u6d4b\u8bd5\u4efb\u52a1\uff0c\u6bcf\u4e2a\u4efb\u52a1\u90fd\u6709\u4e00\u4e2a\u540d\u79f0\u3002\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u6bcf\u9047\u5230\u4e00\u4e2a <code>--name</code> \u4f1a\u5b9a\u4e49\u4e00\u4e2a\u65b0\u4efb\u52a1\uff0c\u540e\u9762\u8ddf\u968f\u8be5\u4efb\u52a1\u7684\u53c2\u6570\u3002</li> <li><code>--stonewall</code>\uff1a\u7b49\u5f85\u524d\u4e00\u4e2a\u4efb\u52a1\u5b8c\u6210\u624d\u5f00\u59cb\u8fd9\u4e00\u4e2a\u4efb\u52a1\uff0cfio \u9ed8\u8ba4\u6240\u6709\u4efb\u52a1\u662f\u540c\u65f6\u6267\u884c\u7684\u3002</li> <li><code>--runtime</code>\uff1a\u6d4b\u8bd5\u7684\u6700\u5927\u65f6\u95f4\u957f\u5ea6\uff08\u65e0\u5355\u4f4d\u5219\u4e3a\u79d2\uff09\u3002\u53ef\u4ee5\u6dfb\u52a0 <code>--time_based</code> \u53c2\u6570\u9632\u6b62\u4efb\u52a1\u5b8c\u6210\u800c\u63d0\u524d\u7ed3\u675f</li> <li><code>--readonly</code>\uff1a\u68c0\u67e5\u5f53\u524d\u4efb\u52a1\u662f\u5426\u4e3a\u53ea\u8bfb\u4efb\u52a1\uff0c\u9632\u6b62\u8bef\u64cd\u4f5c\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u3002</li> <li><code>--loops</code>: \u591a\u6b21\u6d4b\u8bd5\u53d6\u5e73\u5747\u503c\u3002</li> </ul> <p>\u4ee5\u4e0b\u662f\u4e00\u4e9b\u4f8b\u5b50\uff0c\u4e00\u90e8\u5206\u5728\u7f16\u5199\u5176\u4ed6\u5185\u5bb9\u65f6\u4f7f\u7528\u5230\u4e86\uff1a</p> <p>\u5bf9\u6b63\u5728\u8fd0\u884c\u7684\u5757\u8bbe\u5907\u64cd\u4f5c\u65f6\u9700\u8981\u5c0f\u5fc3</p> <p>\u5bf9\u5df2\u7ecf\u6709\u6570\u636e\u7684\u5757\u8bbe\u5907\u8fdb\u884c\u5199\u5165\u64cd\u4f5c\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\uff0c\u5728\u6d4b\u8bd5\u65f6\u8bf7\u52a0\u4e0a <code>--readonly</code> \u53c2\u6570\u3002</p> \u4f7f\u7528 fio \u6d4b\u8bd5\u5757\u8bbe\u5907\uff08<code>/dev/mapper/vg201--test-lvdata</code>\uff09\u968f\u673a\u8bfb\u5ef6\u8fdf\u7684\u4f8b\u5b50 <p>\u672c\u90e8\u5206\u7f16\u5199\u65f6\u53c2\u8003\u4e86 Oracle \u7684\u6587\u6863\u3002</p> <p>\u4e00\u4e2a\u53ea\u8bfb\u60c5\u51b5\u4e0b\u6d4b\u8bd5 10s <code>/dev/mapper/vg201--test-lvdata</code> \u7684 4K \u968f\u673a\u8bfb\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>$ sudo fio --filename=/dev/mapper/vg201--test-lvdata \\\n    --direct=1 --rw=randread --bs=4k \\\n    --ioengine=libaio --iodepth=1 --numjobs=1 \\\n    --time_based --group_reporting --name=readlatency-test-job \\\n    --runtime=10 --eta-newline=1 --readonly\nreadlatency-test-job: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1\nfio-3.36\nStarting 1 process\nfio: file /dev/mapper/vg201--test-lvdata exceeds 32-bit tausworthe random generator.\nfio: Switching to tausworthe64. Use the random_generator= option to get rid of this warning.\nJobs: 1 (f=1): [r(1)][30.0%][r=233MiB/s][r=59.6k IOPS][eta 00m:07s]\nJobs: 1 (f=1): [r(1)][50.0%][r=218MiB/s][r=55.9k IOPS][eta 00m:05s] \nJobs: 1 (f=1): [r(1)][70.0%][r=226MiB/s][r=57.8k IOPS][eta 00m:03s] \nJobs: 1 (f=1): [r(1)][90.0%][r=219MiB/s][r=56.1k IOPS][eta 00m:01s] \nJobs: 1 (f=1): [r(1)][100.0%][r=220MiB/s][r=56.2k IOPS][eta 00m:00s]\nreadlatency-test-job: (groupid=0, jobs=1): err= 0: pid=1334208: Sat Feb 17 23:46:54 2024\nread: IOPS=56.0k, BW=219MiB/s (229MB/s)(2186MiB/10001msec)\n    slat (nsec): min=1143, max=870047, avg=2109.53, stdev=1843.07\n    clat (nsec): min=211, max=26562k, avg=14946.90, stdev=60736.24\n    lat (usec): min=10, max=26564, avg=17.06, stdev=60.82\n    clat percentiles (usec):\n    |  1.00th=[   10],  5.00th=[   12], 10.00th=[   12], 20.00th=[   13],\n    | 30.00th=[   13], 40.00th=[   13], 50.00th=[   13], 60.00th=[   13],\n    | 70.00th=[   14], 80.00th=[   15], 90.00th=[   22], 95.00th=[   23],\n    | 99.00th=[   52], 99.50th=[   76], 99.90th=[  174], 99.95th=[  243],\n    | 99.99th=[  465]\nbw (  KiB/s): min=185288, max=249304, per=100.00%, avg=223874.11, stdev=13053.14, samples=19\niops        : min=46322, max=62326, avg=55968.53, stdev=3263.28, samples=19\nlat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%\nlat (usec)   : 2=0.01%, 4=0.01%, 10=1.43%, 20=87.06%, 50=10.48%\nlat (usec)   : 100=0.75%, 250=0.24%, 500=0.03%, 750=0.01%, 1000=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%\ncpu          : usr=7.91%, sys=18.76%, ctx=560581, majf=0, minf=23\nIO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    issued rwts: total=559688,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=1\n\nRun status group 0 (all jobs):\nREAD: bw=219MiB/s (229MB/s), 219MiB/s-219MiB/s (229MB/s-229MB/s), io=2186MiB (2292MB), run=10001-10001msec\n</code></pre> \u5411 <code>./test</code> \u968f\u673a\u8bfb\u5199\uff0c\u6a21\u62df I/O \u538b\u529b <pre><code>sudo fio --filename=./test \\\n  --filesize=2G --direct=1 --rw=randrw \\\n  --bs=4k --ioengine=libaio --iodepth=256 \\\n  --runtime=120 --numjobs=4 --time_based \\\n  --group_reporting --name=job_name --eta-newline=1\n</code></pre> \u6a21\u62df Crystal DiskMark \u6d4b\u8bd5\u78c1\u76d8\u6027\u80fd <p>\u672c\u90e8\u5206\u6765\u81ea Raspberry Pi 4 B Review and Benchmark - What\u2019s improved over Pi 3 B+\u3002</p> <pre><code>sudo fio --loops=5 --size=500m --filename=fiotest.tmp --stonewall --ioengine=libaio --direct=1 \\\n    --name=SeqRead --bs=1m --rw=read \\\n    --name=SeqWrite --bs=1m --rw=write \\\n    --name=512Kread --bs=512k --rw=randread \\\n    --name=512Kwrite --bs=512k --rw=randwrite \\\n    --name=4KQD32read --bs=4k --iodepth=32 --rw=randread \\\n    --name=4KQD32write --bs=4k --iodepth=32 --rw=randwrite \\\n    --name=4Kread --bs=4k --rw=randread \\\n    --name=4Kwrite --bs=4k --rw=randwrite\n</code></pre> <p>\u7531\u4e8e\u6027\u80fd\u6d4b\u8bd5\u7684\u53c2\u6570\u901a\u5e38\u4f1a\u5f88\u957f\uff0cfio \u8fd8\u652f\u6301\u5c06\u53c2\u6570\u653e\u7f6e\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u4fbf\u4e8e\u4fee\u6539\u548c\u91cd\u590d\u4f7f\u7528\u3002</p> <p>fio \u7684\u914d\u7f6e\u6587\u4ef6\u88ab\u79f0\u4e3a job \u6587\u4ef6\uff0c\u5b9a\u4e49\u4e86\u4e00\u7ec4\u9700\u8981\u6a21\u62df\u7684 I/O \u8d1f\u8f7d\u3002fio \u652f\u6301\u8f93\u5165\u591a\u4e2a job \u6587\u4ef6\uff0c\u6bcf\u4e2a job \u6587\u4ef6\u4f1a\u4f9d\u6b21\u8fd0\u884c\u3002\u800c job \u6587\u4ef6\u5185\u7684\u4efb\u52a1\u9ed8\u8ba4\u662f\u5e76\u884c\u8fd0\u884c\u7684\uff0c\u53ef\u4ee5\u4f7f\u7528<code>stonewall</code>\u53c2\u6570\u6765\u4fdd\u8bc1\u4e32\u884c\u3002</p> <p>Job \u6587\u4ef6\u4f7f\u7528 ini \u683c\u5f0f\uff0c\u901a\u5e38\u5305\u62ec\u4e00\u4e2a global \u8282\u5b9a\u4e49\u5171\u4eab\u53c2\u6570\u548c\u82e5\u5e72\u4e2a job \u8282\u5b9a\u4e49\u6bcf\u4e2a I/O \u4efb\u52a1\u7684\u53c2\u6570\uff08\u53ef\u4ee5\u8986\u76d6 global \u8282\u7684\u53c2\u6570\uff09\u3002</p> \u6a21\u62df Crystal DiskMark \u6d4b\u8bd5\u78c1\u76d8\u6027\u80fd job \u6587\u4ef6 <p><pre><code>[global]\nioengine=libaio\ndirect=1\nsize=4g\nruntime=60\nloops=3\n\n[Read SEQ1M Q8T1]\nbs=1m\niodepth=8\nrw=read\n\n[Read SEQ1M Q1T1]\nstonewall\nbs=1m\nrw=read\n\n[Read RND4K Q32T1]\nstonewall\nbs=4k\niodepth=32\nrw=randread\n\n[Read RND4K Q1T1]\nstonewall\nbs=4k\niodepth=1\nrw=randread\n\n[Write SEQ1M Q8T1]\nbs=1m\niodepth=8\nrw=write\n\n[Write SEQ1M Q1T1]\nstonewall\nbs=1m\nrw=write\n\n[Write RND4K Q32T1]\nstonewall\nbs=4k\niodepth=32\nrw=randwrite\n\n[Write RND4K Q1T1]\nstonewall\nbs=4k\niodepth=1\nrw=randwrite\n</code></pre> \u4fdd\u5b58\u4e3a<code>fio_CrystalDiskMark.ini</code>\uff0c\u7136\u540e\u8fd0\u884c <pre><code>fio --filename=xxx fio_CrystalDiskMark.ini\n</code></pre></p> <p>fio \u8f93\u51fa\u5185\u5bb9\u6bd4\u8f83\u4e30\u5bcc\uff0c\u9664\u4e86\u5e26\u5bbd BW \u5916\uff0c\u8fd8\u53ef\u4ee5\u5173\u6ce8 IOPS\u3001\u63d0\u4ea4\u5ef6\u8fdf (slat)\u3001\u5b8c\u6210\u5ef6\u8fdf (clat)\u3001\u4ee5\u53ca iodepth \u5206\u5e03\u7b49\u3002\u8f93\u51fa\u5185\u5bb9\u5177\u4f53\u542b\u4e49\u53ef\u4ee5\u53c2\u8003 man \u624b\u518c OUTPUT \u8282\u3002</p>"},{"location":"ops/storage/intro/#filesystem","title":"\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u5728 Linux \u4e0a\uff0cext4 \u662f\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u4f46\u662f\u5bf9\u4e8e\u67d0\u4e9b\u9700\u6c42\uff0cext4 \u53ef\u80fd\u65e0\u6cd5\u6ee1\u8db3\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u9700\u8981\u652f\u6301\u5b58\u50a8\u5927\u91cf\u6587\u4ef6\uff0c\u6570\u91cf\u751a\u81f3\u53ef\u80fd\u8d85\u8fc7 ext4 \u7684\u9650\u5236</li> <li>\u9700\u8981\u652f\u6301\u5feb\u7167\u3001\u900f\u660e\u538b\u7f29\u3001\u6570\u636e\u6821\u9a8c\u7b49\u9ad8\u7ea7\u529f\u80fd</li> </ul> <p>\u5728\u300c\u5206\u533a\u4e0e\u6587\u4ef6\u7cfb\u7edf\u300d\u90e8\u5206\u4f1a\u5bf9\u6587\u4ef6\u7cfb\u7edf\u7684\u9009\u62e9\u8fdb\u884c\u4ecb\u7ecd\u3002 \u672c\u90e8\u5206\u4e3b\u8981\u4ecb\u7ecd\u4e0e\u6587\u4ef6\u7cfb\u7edf\u3001\u6302\u8f7d\u7b49\u6709\u5173\u7684\u901a\u7528\u5185\u5bb9\u3002</p>"},{"location":"ops/storage/intro/#fstab","title":"<code>/etc/fstab</code>","text":"<p><code>/etc/fstab</code> \u662f Linux \u7cfb\u7edf\u4e2d\u7528\u4e8e\u914d\u7f6e\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u7684\u6587\u4ef6\u3002 \u5728\u542f\u52a8\u65f6\uff0c\u7cfb\u7edf\u4f1a\u6839\u636e <code>/etc/fstab</code> \u4e2d\u7684\u914d\u7f6e\u81ea\u52a8\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u3002 \u5982\u679c\u914d\u7f6e\u4e0d\u5f53\uff0c\u90a3\u4e48\u5f00\u673a\u65f6\u5c31\u53ef\u80fd\u4f1a\u51fa\u73b0\u6302\u8f7d\u5931\u8d25\uff0c\u4ece\u800c\u8fdb\u5165\u7d27\u6025\u6a21\u5f0f\u7684\u60c5\u51b5\u3002</p> <p>\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a\u5728 QEMU \u865a\u62df\u673a\u4e2d\u7684 Linux \u7cfb\u7edf\u7684 <code>/etc/fstab</code> \u7684\u4f8b\u5b50\uff1a</p> <pre><code># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;\nUUID=6cf8f654-9a14-4703-be4e-c5a059c9f7f8 /               ext4    errors=remount-ro 0       1\n/dev/sr0        /media/cdrom0   udf,iso9660 user,noauto     0       0\nsharing /mnt/sharing    virtiofs    defaults,nofail 0   0\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u7b2c\u4e00\u90e8\u5206\u5b9a\u4f4d\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u7269\u7406\u78c1\u76d8\u6765\u8bf4\uff0c\u4f7f\u7528 UUID \u662f\u6bd4\u8f83\u597d\u7684\u9009\u62e9\uff0c\u8be6\u60c5\u53ef\u53c2\u8003\u5206\u533a\u4e0e\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5bf9 <code>/dev/disk</code> \u7684\u4ecb\u7ecd\u3002<code>/dev/sda1</code> \u8fd9\u6837\u7684\u8bbe\u5907\u540d\u867d\u7136\u4e5f\u53ef\u4ee5\u4f7f\u7528\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u51fa\u73b0\u610f\u6599\u4e4b\u5916\u7684\u95ee\u9898\u3002 \u5bf9\u7279\u6b8a\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd9\u91cc\u7684\u5185\u5bb9\u7531\u5bf9\u5e94\u7684\u5b9e\u73b0\u51b3\u5b9a\uff0c\u4f8b\u5982 <code>tmpfs</code> \u7684\u8bdd\uff0c\u8fd9\u91cc\u53ef\u80fd\u5c31\u662f <code>none</code> \u6216\u8005 <code>tmpfs</code>\uff1b \u4f8b\u5b50\u4e2d\u7684 <code>virtiofs</code> \u662f QEMU \u7684\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\uff0c\u7528\u4e8e\u4e0e\u5bbf\u4e3b\u673a\u5171\u4eab\u6587\u4ef6\uff0c \u7531\u4e8e\u8bbe\u7f6e\u4e2d\u7684 <code>target</code> \u662f <code>sharing</code>\uff0c\u56e0\u6b64\u8fd9\u91cc\u7684\u8bbe\u5907\u540d\u662f <code>sharing</code>\u3002</p> <p>\u540e\u9762\u5219\u662f\u6302\u8f7d\u70b9\u3001\u6587\u4ef6\u7cfb\u7edf\u4e0e\u6302\u8f7d\u9009\u9879\u3002\u6302\u8f7d\u9009\u9879\u4e2d\u5927\u90e8\u5206\u4f1a\u63d0\u4f9b\u7ed9\u6587\u4ef6\u7cfb\u7edf\uff08\u4f8b\u5982\u8fd9\u91cc\u7684 <code>errors=remount-ro</code>\uff09\uff0c\u4f46\u662f\u6709\u4e00\u4e9b\u662f\u901a\u7528\u7684\u8bbe\u7f6e\u3002 \u4f8b\u5982 <code>noauto</code> \u9009\u9879\u8868\u793a\u542f\u52a8\u65f6\u4e0d\u6302\u8f7d\uff0c<code>nofail</code> \u8868\u793a\u5373\u4f7f\u6302\u8f7d\u5931\u8d25\u4e5f\u4e0d\u5f71\u54cd\u542f\u52a8\u3002 \u4e00\u4e2a\u5728 fstab(5) \u4e2d\u6ca1\u6709\u63d0\u53ca\u7684\u91cd\u8981\u9009\u9879\u662f <code>_netdev</code>\uff0c\u5b83\u8868\u793a\u8fd9\u4e2a\u6302\u8f7d\u70b9\u9700\u8981\u7f51\u7edc\u8fde\u63a5\uff0c systemd \u4f1a\u914d\u7f6e\u542f\u52a8\u65f6\u5728\u7f51\u7edc\u914d\u7f6e\u597d\u4e4b\u540e\u624d\u6302\u8f7d\u3002 \u8fd9\u4e2a\u9009\u9879\u5728\u6302\u8f7d\u57fa\u4e8e\u7f51\u7edc\u7684\u5b58\u50a8\u65f6\u975e\u5e38\u6709\u7528\u3002</p> <p>\"dump\" \u53ef\u4ee5\u5ffd\u7565\uff080 \u5373\u53ef\uff09\uff0c\u800c \"pass\" \u6807\u8bb0\u4e86\u6587\u4ef6\u7cfb\u7edf\u68c0\u67e5\uff08fsck\uff09\u7684\u987a\u5e8f\uff1a0 \u4e0d\u68c0\u67e5\uff0c\u6839\u5206\u533a\u5e94\u8be5\u4e3a 1\uff0c\u5176\u4ed6\u5206\u533a\u4e3a 2\u3002</p> <p>\u5728\u4fee\u6539\u914d\u7f6e\u540e\uff0c\u5982\u679c\u7cfb\u7edf\u4f7f\u7528\u4e86 systemd\uff0c\u5e94\u5f53\u4f7f\u7528 <code>systemctl daemon-reload</code> \u6765\u8ba9 systemd \u91cd\u65b0\u52a0\u8f7d\u6240\u6709\u7684 mount \u5355\u5143\u3002 \u5426\u5219 <code>mount -a</code> \u4e4b\u540e\uff0csystemd \u53ef\u80fd\u4f1a\u300c\u597d\u5fc3\u300d\u5730\u5e2e\u4f60\u6539\u56de\u6765\u3002</p>"},{"location":"ops/storage/intro/#supplement","title":"\u8865\u5145\u9605\u8bfb","text":"<p>\u5bf9 Linux \u865a\u62df\u673a\u4e0a\u7684\u6c38\u4e45\u6027\u78c1\u76d8\u6027\u80fd\u8fdb\u884c\u57fa\u51c6\u6d4b\u8bd5\uff1aGCE \u5173\u4e8e\u4f7f\u7528 fio \u8fdb\u884c\u78c1\u76d8\u6027\u80fd\u6d4b\u8bd5\u7684\u6587\u6863\u3002</p> <ol> <li> <p>IOPS \u4e3a\u6bcf\u79d2\u7684 I/O \u64cd\u4f5c\u6570\uff0c\u53ef\u4ee5\u7b80\u5355\u8ba4\u4e3a\u662f\u547d\u4ee4\u64cd\u4f5c\u5ef6\u8fdf\u7684\u5012\u6570\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/lvm/","title":"LVM","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>\u672c\u6587\u5c06\u4ecb\u7ecd\u5e38\u89c1 LVM \u7279\u6027\u7684\u4f7f\u7528\u4e0e\u7ef4\u62a4\u3002</p> <p>LVM\uff08Logical Volume Manager\uff09\u662f Linux \u4e0b\u7684\u903b\u8f91\u5377\u7ba1\u7406\u5668\uff0c\u57fa\u4e8e\u5185\u6838\u7684 device mapper\uff08dm\uff09\u529f\u80fd\u3002 \u76f8\u6bd4\u4e8e\u76f4\u63a5\u5728\u521b\u5efa\u5206\u533a\u8868\u540e\u4f7f\u7528\u5206\u533a\uff0cLVM \u63d0\u4f9b\u4e86\u66f4\u52a0\u7075\u6d3b\u7684\u5b58\u50a8\u7ba1\u7406\u65b9\u5f0f\uff1a</p> <ul> <li>LVM \u53ef\u4ee5\u7ba1\u7406\u591a\u4e2a\u786c\u76d8\uff08\u7269\u7406\u5377\uff09\u4e0a\u7684\u5b58\u50a8\u7a7a\u95f4</li> <li>LVM \u4e2d\u7684\u903b\u8f91\u5377\u53ef\u4ee5\u8de8\u8d8a\u591a\u4e2a\u7269\u7406\u5377\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e0d\u9700\u8981\u5173\u5fc3\u7269\u7406\u5377\u7684\u4f4d\u7f6e</li> <li>LVM \u7684\u903b\u8f91\u5377\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\u5927\u5c0f\uff0c\u800c\u4e0d\u9700\u8981\u79fb\u52a8\u5206\u533a\u7684\u4f4d\u7f6e\u2014\u2014\u79fb\u52a8\u5206\u533a\u7684\u8d77\u59cb\u4f4d\u7f6e\u662f\u4e00\u4e2a\u5371\u9669\u4e14\u8017\u65f6\u7684\u64cd\u4f5c</li> </ul> <p>\u4e00\u4e9b Linux \u53d1\u884c\u7248\u7684\u5b89\u88c5\u7a0b\u5e8f\u9ed8\u8ba4\u4f7f\u7528 LVM \u6765\u7ba1\u7406\u78c1\u76d8\uff0c\u4f8b\u5982 Fedora\u3001CentOS \u7b49\u3002\u5982\u679c\u9700\u8981\u5b9e\u9645\u4f7f\u7528 LVM\uff0c\u4e5f\u63a8\u8350\u9605\u8bfb\u6765\u81ea\u7ea2\u5e3d RHEL \u7684 LVM \u7ba1\u7406\u6307\u5357<sup>1</sup>\u3002</p> <p>\u672c\u90e8\u5206\u65e0\u6cd5\u6db5\u76d6\u5168\u90e8\u5185\u5bb9</p> <p>LVM \u5305\u542b\u4e86\u5f88\u591a\u529f\u80fd\uff0c\u5728\u672c\u4efd\u6587\u6863\u4e2d\u4e0d\u53ef\u80fd\u9762\u9762\u4ff1\u5230\uff0c\u56e0\u6b64\u6211\u4eec\u4ec5\u4ecb\u7ecd\u5728 LUG \u4e0e Vlab \u9879\u76ee\u4e2d\u4f7f\u7528\u8fc7\u7684\u529f\u80fd\u3002</p>"},{"location":"ops/storage/lvm/#basic","title":"\u57fa\u7840\u6982\u5ff5","text":"<p>LVM \u4e2d\u6709\u4e09\u4e2a\u57fa\u672c\u6982\u5ff5\uff1a</p> <ul> <li>\u7269\u7406\u5377\uff08Physical Volume\uff0cPV\uff09\uff1a\u901a\u5e38\u662f\u4e00\u5757\u786c\u76d8\uff08\u5206\u533a\uff09</li> <li>\u5377\u7ec4\uff08Volume Group\uff0cVG\uff09\uff1a\u7531\u4e00\u4e2a\u6216\u591a\u4e2a\u7269\u7406\u5377\u7ec4\u6210</li> <li>\u903b\u8f91\u5377\uff08Logical Volume\uff0cLV\uff09\uff1a\u5728\u5377\u7ec4\u91cc\u5206\u914d\u7684\u903b\u8f91\u5b58\u50a8\u7a7a\u95f4\u3002\u79f0\u4e4b\u4e3a\u300c\u903b\u8f91\u300d\uff0c\u662f\u56e0\u4e3a\u5b83\u53ef\u4ee5\u8de8\u8d8a\u591a\u4e2a\u7269\u7406\u5377\uff0c\u4e5f\u4e0d\u4e00\u5b9a\u662f\u8fde\u7eed\u7684</li> </ul> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e09\u4e2a 1GB \u7684\u6587\u4ef6\u4f5c\u4e3a\u7269\u7406\u5377\uff0c\u5e76\u4e14\u52a0\u5165\u5230\u4e00\u4e2a\u5377\u7ec4\u4e2d\uff1a</p> <p>\u907f\u514d\u5728\u7269\u7406\u78c1\u76d8\u4e0a\u521b\u5efa\u65e0\u5206\u533a\u8868\u7684\u6587\u4ef6\u7cfb\u7edf/\u7269\u7406\u5377</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u5c3d\u7ba1\u6ca1\u6709\u4ec0\u4e48\u963b\u6b62\u8fd9\u4e48\u505a\uff0c\u4f46\u662f\u4e0d\u521b\u5efa\u5206\u533a\u8868\u3001\u76f4\u63a5\u5c06\u6574\u4e2a\u78c1\u76d8\u683c\u5f0f\u5316\u4e3a\u67d0\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u6216\u8005\u52a0\u5165 LVM \u4e2d\u662f\u4e0d\u5efa\u8bae\u7684\u3002 \u8fd9\u4f1a\u7ed9\u5176\u4ed6\u4eba\u5e26\u6765\u56f0\u60d1\uff0c\u5e76\u4e14\u5982\u679c\u672a\u6765\u6709\u5728\u5bf9\u5e94\u78c1\u76d8\u4e0a\u542f\u52a8\u7cfb\u7edf\u7b49\u9700\u8981\u591a\u5206\u533a\u7684\u9700\u6c42\uff0c\u4f1a\u5e26\u6765\u5f88\u591a\u9ebb\u70e6\uff08\u53ef\u80fd\u53ea\u80fd\u5907\u4efd\u6570\u636e\u540e\u4ece\u5934\u518d\u6765\uff09\u3002</p> <p>\u76f4\u63a5\u5bf9\u7269\u7406\u78c1\u76d8\u8bbe\u5907\u683c\u5f0f\u5316\u4e3a\u6587\u4ef6\u7cfb\u7edf\u4e5f\u662f\u64cd\u4f5c\u65f6\u5e38\u89c1\u7684\u8f93\u5165\u9519\u8bef\uff1a</p> <pre><code>$ mkfs.ext4 /dev/sdz  # \u9519\u8bef \u274c\n$ mkfs.ext4 /dev/sdz1 # \u6b63\u786e \u2705\n</code></pre> <p>\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u64cd\u4f5c\uff0c\u6211\u4eec\u5047\u8bbe pv[1-3].img \u76f8\u5f53\u4e8e\u6bcf\u5757\u786c\u76d8\u4e0a\u4f7f\u7528\u5168\u90e8\u7a7a\u95f4\u7684\u5206\u533a\u3002</p> <pre><code>$ truncate -s 1G pv1.img pv2.img pv3.img\n$ sudo losetup -f --show pv1.img\n/dev/loop0\n$ sudo losetup -f --show pv2.img\n/dev/loop1\n$ sudo losetup -f --show pv3.img\n/dev/loop2\n$ sudo pvcreate /dev/loop0 /dev/loop1 /dev/loop2  # \u521b\u5efa\u7269\u7406\u5377\n  Physical volume \"/dev/loop0\" successfully created.\n  Physical volume \"/dev/loop1\" successfully created.\n  Physical volume \"/dev/loop2\" successfully created.\n$ sudo vgcreate vg201-test /dev/loop0 /dev/loop1 /dev/loop2  # \u521b\u5efa\u5377\u7ec4\n  Volume group \"vg201-test\" successfully created\n$ sudo pvs  # \u67e5\u770b\u7269\u7406\u5377\u4fe1\u606f\n  PV         VG         Fmt  Attr PSize    PFree   \n  /dev/loop0 vg201-test lvm2 a--  1020.00m 1020.00m\n  /dev/loop1 vg201-test lvm2 a--  1020.00m 1020.00m\n  /dev/loop2 vg201-test lvm2 a--  1020.00m 1020.00m\n$ sudo vgs  # \u67e5\u770b\u5377\u7ec4\u4fe1\u606f\n  VG         #PV #LV #SN Attr   VSize  VFree \n  vg201-test   3   0   0 wz--n- &lt;2.99g &lt;2.99g\n$ sudo lvcreate -n lvol0 -L 2.5G vg201-test  # \u521b\u5efa\u4e00\u4e2a 2.5G \u7684\u903b\u8f91\u5377\n  Logical volume \"lvol0\" created.\n$ sudo lvs  # \u67e5\u770b\u903b\u8f91\u5377\u4fe1\u606f\n  LV    VG         Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvol0 vg201-test -wi-a----- 2.50g\n$ ls -lh /dev/mapper/\ntotal 0\ncrw------- 1 root root 10, 236 Feb 11 13:30 control\nlrwxrwxrwx 1 root root       7 Feb 12 00:09 vg201--test-lvol0 -&gt; ../dm-0\n$ # /dev/mapper/vg201--test-lvol0 \u5c31\u662f\u6211\u4eec\u521b\u5efa\u7684\u903b\u8f91\u5377\uff08\u5757\u8bbe\u5907\uff09\uff0c\u53ef\u4ee5\u5728\u4e0a\u9762\u521b\u5efa\u6587\u4ef6\u7cfb\u7edf\u3002\n$ # \u5bf9\u5e94\u7684\u8bbe\u5907\u6587\u4ef6\u4e5f\u53ef\u4ee5\u5728 /dev/vg201-test/ \u91cc\u9762\u627e\u5230\n$ sudo lvchange -an vg201-test/lvol0  # \u53d6\u6d88\u6fc0\u6d3b (disactivate) \u521a\u624d\u521b\u5efa\u7684\u903b\u8f91\u5377\n$ sudo lvs\n  LV    VG         Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvol0 vg201-test -wi------- 2.50g \n$ sudo losetup -D  # \u5378\u8f7d\u672c\u5730\u56de\u73af\n</code></pre> <p>\u4e4b\u540e\u518d\u6b21\u6302\u8f7d\uff1a</p> <pre><code>$ sudo losetup -f --show pv1.img\n/dev/loop0\n$ sudo losetup -f --show pv2.img\n/dev/loop1\n$ sudo losetup -f --show pv3.img\n/dev/loop2\n$ sudo pvs  # \u53ef\u4ee5\u770b\u5230\u7269\u7406\u5377\u88ab\u81ea\u52a8\u8bc6\u522b\u4e86\n  PV         VG         Fmt  Attr PSize    PFree  \n  /dev/loop0 vg201-test lvm2 a--  1020.00m      0 \n  /dev/loop1 vg201-test lvm2 a--  1020.00m      0 \n  /dev/loop2 vg201-test lvm2 a--  1020.00m 500.00m\n$ sudo lvchange -ay vg201-test/lvol0  # \u6fc0\u6d3b LV\n$ sudo lvs\n  LV    VG         Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvol0 vg201-test -wi-a----- 2.50g\n</code></pre> <p>\u7b49\u7b49\uff0c\u600e\u4e48\u6bcf\u5757\u76d8\u5c11\u4e86\u51e0 MB \u7a7a\u95f4\uff1f</p> <p>\u5176\u5b9e\u5927\u6982\u53ef\u4ee5\u731c\u5230\uff0c\u8fd9\u4e9b\u7a7a\u95f4\u7559\u7ed9\u4e86 LVM \u7684\u5143\u6570\u636e\u3002LVM \u7684\u5143\u6570\u636e\u4e3a\u7eaf\u6587\u672c\u683c\u5f0f\uff0c\u53ef\u4ee5\u5b58\u50a8\u76f8\u5bf9\u590d\u6742\u7684\u4fe1\u606f\uff0c\u4f46\u662f\u4e5f\u5e26\u6765\u4e86\u4e0b\u8ff0\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ul> <li>LVM \u7684\u5143\u6570\u636e\u683c\u5f0f\u6ca1\u6709\u4e66\u9762\u7684\u6807\u51c6\uff0c\u56e0\u6b64\u5176\u4ed6\u8f6f\u4ef6\u5728\u89e3\u6790 LVM \u5143\u6570\u636e\u65f6\u53ef\u80fd\u4f1a\u51fa\u73b0\u95ee\u9898\u3002\u79d1\u5927\u955c\u50cf\u7ad9\u7684\u673a\u5668\u5c31\u9047\u5230\u8fc7 GRUB \u89e3\u6790 LVM \u5143\u6570\u636e\u4ee3\u7801\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u65e0\u6cd5\u6b63\u786e\u914d\u7f6e\u542f\u52a8\u5668\u3002 \u8fd9\u4e2a\u95ee\u9898\u76f4\u5230\u73b0\u5728\u90fd\u6ca1\u6709\u88ab GRUB \u4fee\u590d\uff0c\u56e0\u6b64\u53ea\u80fd\u81ea\u884c\u7f16\u8bd1\u624b\u52a8\u4fee\u590d\u540e\u7684\u7248\u672c\uff0c\u5e76\u4e14\u56fa\u5b9a GRUB \u7248\u672c\u3002</li> <li>LVM \u7684\u7eaf\u6587\u672c\u683c\u5f0f\u5bfc\u81f4\u5143\u6570\u636e\u672c\u8eab\u8f83\u5927\uff0c\u5982\u679c\u9884\u5206\u914d\u7684\u5143\u6570\u636e\u7a7a\u95f4\u4e0d\u8db3\uff0c\u5e76\u4e14\u5377\u7ec4\u4e2d\u6709\u5927\u91cf\u903b\u8f91\u5377\uff08\u9ed8\u8ba4\u503c + \u4e0a\u5343\u4e2a LV \u5c31\u4f1a\u51fa\u73b0\u95ee\u9898\uff09\uff0c\u90a3\u4e48\u6700\u540e\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u518d\u521b\u5efa/\u6269\u5bb9\u903b\u8f91\u5377\uff0c\u5e76\u4e14\u53ea\u80fd\u901a\u8fc7\u6dfb\u52a0\u65b0\u7684\u7269\u7406\u5377\uff0c\u7136\u540e\u7531\u8be5\u5377\u5b58\u50a8\u5143\u6570\u636e\u6765\u89e3\u51b3\u95ee\u9898\u3002Vlab \u9879\u76ee\u66fe\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u95ee\u9898\u3002</li> </ul> <p>\u8fd9\u91cc\u521b\u5efa\u7684\u903b\u8f91\u5377\u6a2a\u8de8\u4e86\u4e09\u5757\u76d8\uff0c\u6240\u4ee5 LVM \u9ed8\u8ba4\u662f RAID 0\uff1f</p> <p>\u8fd9\u662f\u4e0d\u6b63\u786e\u7684\u3002\u8fd9\u91cc\u903b\u8f91\u5377\u7684\u6570\u636e\u5e03\u5c40\u4e0e RAID 0 \u4e0d\u540c\u3002RAID 0 \u8003\u8651\u7684\u662f\u6027\u80fd\uff0c\u56e0\u6b64\u6570\u636e\u7c7b\u4f3c\u4e8e\u8fd9\u4e48\u5b58\u50a8\uff1a</p> Disk 1 Disk 2 Disk 3 0 1 2 3 4 5 6 7 8 ... ... ... <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u5e94\u7528\u7a0b\u5e8f\u987a\u5e8f\u8bfb\u5199\u65f6\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u591a\u5757\u76d8\u7684\u5e76\u884c\u8bfb\u5199\u80fd\u529b\u3002\u4f46\u662f LVM \u7c7b\u4f3c\u4e8e\u8fd9\u6837\uff1a</p> Disk 1 Disk 2 Disk 3 0 100000 200000 1 100001 200001 2 100002 200002 ... ... ... <p>\u6bcf\u5757\u76d8\u662f\u987a\u5e8f\u586b\u5145\u7684\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u66f4\u52a0\u7075\u6d3b\u5730\u7ba1\u7406\u7a7a\u95f4\uff0c\u4f46\u662f\u6027\u80fd\u4e0d\u5982 RAID 0\u3002</p> <p>LVM \u4e5f\u63d0\u4f9b\u4e86\u521b\u5efa RAID 0 \u903b\u8f91\u5377\u7684\u529f\u80fd\uff0c\u88ab\u79f0\u4e3a\u300c\u6761\u5e26\u5316\u300d\uff08Striped\uff09\u5377\uff0c\u4e0a\u9762\u9ed8\u8ba4\u751f\u6210\u7684\u88ab\u79f0\u4e3a\u300c\u7ebf\u6027\u300d\uff08Linear\uff09\u5377\u3002</p>"},{"location":"ops/storage/lvm/#raid","title":"\u521b\u5efa RAID","text":"<p>\u4e0d\u5efa\u8bae\u4f7f\u7528 LVM \u6784\u5efa RAID</p> <p>\u76f8\u6bd4\u4e8e mdadm\uff0cLVM \u4e0e RAID \u76f8\u5173\u7684\u6982\u5ff5\u4e0e\u63d0\u4f9b\u7684\u5de5\u5177\u66f4\u52a0\u590d\u6742\uff0c\u5e76\u4e14\u8fd9\u79cd\u590d\u6742\u6027\u5728\u5f88\u591a\u573a\u666f\u4e0b\u6ca1\u6709\u6536\u76ca\u3002 \u66f4\u52a0\u5e38\u89c1\u7684\u6a21\u5f0f\u662f\uff0c\u4f7f\u7528 mdadm \u6784\u5efa RAID\uff0c\u7136\u540e\u4f7f\u7528 LVM \u7ba1\u7406\u6784\u5efa\u597d\u7684 RAID \u4e0a\u7684\u903b\u8f91\u5377\u3002</p> <p>LVM \u4e0e mdadm \u4f7f\u7528\u7684\u90fd\u662f\u5185\u6838\u7684 md \u6a21\u5757\u3002\u5373\u4f7f\u6700\u7ec8\u4f7f\u7528 LVM \u6784\u5efa RAID\uff0c\u4e5f\u5efa\u8bae\u7b80\u5355\u9605\u8bfb\u540e\u4e00\u8282\u5173\u4e8e mdadm \u7684\u5185\u5bb9\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u5bf9\u4e8e\u591a\u76d8\u573a\u666f\uff0c\u4e0a\u9762\u7684\u4f8b\u5b50\u663e\u7136\u662f\u4e0d\u6ee1\u8db3\u9700\u6c42\u7684\uff1a\u521b\u5efa\u51fa\u7684\u903b\u8f91\u5377\u4ecd\u7136\u662f\u6709\u4e00\u5757\u76d8\u574f\u6389\u5c31\u4f1a\u6545\u969c\u7684\u72b6\u6001\u3002 \u4ee5\u4e0b\u5c55\u793a\u4e86 RAID0, 1, 5 \u7684\u521b\u5efa\u65b9\u5f0f\uff1a</p> <pre><code>$ sudo lvremove vg201-test/lvol0  # \u5220\u9664\u521a\u624d\u7684 LV\uff0c\u817e\u51fa\u4e00\u4e9b\u7a7a\u95f4\nDo you really want to remove active logical volume vg201-test/lvol0? [y/n]: y\n  Logical volume \"lvol0\" successfully removed.\n$ # RAID 0 (striped)\u3002--stripes \u53c2\u6570\u6307\u5b9a\u4e86\u6761\u5e26\u7684\u6570\u91cf\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u548c\u76d8\u6570\u91cf\u4e00\u81f4\n$ sudo lvcreate -n lvraid0 -L 0.5G --type striped --stripes 3 vg201-test\n  Using default stripesize 64.00 KiB.\n  Logical volume \"lvraid0\" created.\n$ # RAID 1\u3002--mirrors \u53c2\u6570\u6307\u5b9a\u4e86\u526f\u672c\u6570\u91cf\uff08\u4e0d\u542b\u672c\u4f53\uff09\uff0c\u6240\u4ee5\u662f\u76d8\u6570\u91cf\u51cf\u4e00\n$ sudo lvcreate -n lvraid1 -L 0.5G --type raid1 --mirrors 2 vg201-test\n  Logical volume \"lvraid1\" created.\n$ # \u56e0\u4e3a\u53ea\u6709 3 \u5757\u76d8\uff0c\u8fd9\u91cc\u5c55\u793a RAID 5\u3002--stripes \u53c2\u6570\u4e0d\u5305\u542b\u989d\u5916\u7684\u9a8c\u8bc1\u76d8\u3002\n$ sudo lvcreate -n lvraid5 -L 0.2G --type raid5 --stripes 2 vg201-test\n  Using default stripesize 64.00 KiB.\n  Rounding up size to full physical extent 208.00 MiB\n  Logical volume \"lvraid5\" created.\n$ sudo lvs\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvraid0 vg201-test -wi-a----- 516.00m                                                    \n  lvraid1 vg201-test rwi-a-r--- 512.00m                                    100.00          \n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00\n</code></pre> <p>\u4e0d\u8981\u4f7f\u7528 <code>--type mirror</code></p> <p><code>mirror</code> \u548c <code>raid1</code> \u662f\u4e24\u4e2a\u4e0d\u540c\u7684 type\u3002\u9664\u975e\u6709\u7279\u6b8a\u9700\u8981\uff0c\u5426\u5219\u5e94\u8be5\u4f7f\u7528 <code>--type raid1</code> \u521b\u5efa RAID 1 \u9635\u5217\u3002 \u53ef\u4ee5\u4f7f\u7528 <code>lvconvert</code> \u5c06 mirror \u8f6c\u6362\u4e3a raid1\u3002</p> <p>\u76f8\u5173\u8ba8\u8bba\u53ef\u67e5\u770b In what case(s) will <code>--type mirror</code> continue to be a good choice / is not deprecated?\u3002</p> <p>\u5728\u540e\u6587\u7684\u7f3a\u76d8\u6d4b\u8bd5\u4e2d\uff0c<code>mirror</code> \u7684\u884c\u4e3a\u4e5f\u4e0e\u9884\u671f\u4e0d\u540c\u2014\u2014LVM \u9ed8\u8ba4\u4f1a\u62d2\u7edd\u6302\u8f7d\uff0c\u5982\u679c\u5f3a\u884c\u6302\u8f7d\uff0c\u4f1a\u76f4\u63a5\u5c06\u7f3a\u5931\u7684\u76d8\u4e22\u6389\u3002</p> <p>Extent \u662f\u591a\u5927</p> <p>\u6709\u65f6\u5728\u8f93\u5165\u9519\u8bef\u7684\u53c2\u6570\u4e4b\u540e\uff0c\u4f1a\u51fa\u73b0 extent \u4e0d\u8db3\u7684\u63d0\u793a\uff0c\u7c7b\u4f3c\u4e8e\u8fd9\u6837\uff1a</p> <pre><code>$ # --mirrors \u53c2\u6570\u591a\u4e86\u4e00\uff0c\u7a7a\u95f4\u4e0d\u591f\n$ sudo lvcreate -n lvraid1 -L 0.5G --type raid1 --mirrors 3 vg201-test\n  Insufficient suitable allocatable extents for logical volume lvraid1: 516 more required\n</code></pre> <p>\u4f46\u662f \"extent\" \u662f\u591a\u5927\u5462\uff1f\u5728 LVM \u4e2d\uff0c\u6709\u4e24\u79cd extent: PE\uff08Physical Extent\uff09\u548c LE\uff08Logical Extent\uff09\uff0c \u5bf9\u5e94\u7269\u7406\u5377\u548c\u903b\u8f91\u5377\u7684\u5927\u5c0f\u53c2\u6570\u3002\u8fd9\u91cc\u6307\u7684\u662f PE\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>pvdisplay</code> \u6216 <code>vgdisplay</code> \u67e5\u770b\u3002</p> <pre><code>$ sudo vgdisplay\n  --- Volume group ---\n  VG Name               vg201-test\n  System ID             \n  Format                lvm2\n  Metadata Areas        3\n  Metadata Sequence No  11\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                2\n  Open LV               0\n  Max PV                0\n  Cur PV                3\n  Act PV                3\n  VG Size               &lt;2.99 GiB\n  PE Size               4.00 MiB\n  Total PE              765\n  Alloc PE / Size       514 / &lt;2.01 GiB\n  Free  PE / Size       251 / 1004.00 MiB\n  VG UUID               Ybsskf-2giI-Q5PU-LCof-Irr9-EDud-nlB0Ms\n$ sudo pvdisplay\n  --- Physical volume ---\n  PV Name               /dev/loop0\n  VG Name               vg201-test\n  PV Size               1.00 GiB / not usable 4.00 MiB\n  Allocatable           yes \n  PE Size               4.00 MiB\n  Total PE              255\n  Free PE               84\n  Allocated PE          171\n  PV UUID               DBn9ke-9UfO-tZJA-ymSh-GQtP-jMq8-tSm62B\n\n  --- Physical volume ---\n  PV Name               /dev/loop1\n  VG Name               vg201-test\n  PV Size               1.00 GiB / not usable 4.00 MiB\n  Allocatable           yes \n  PE Size               4.00 MiB\n  Total PE              255\n  Free PE               84\n  Allocated PE          171\n  PV UUID               aut3hf-J6Tl-O5Gq-0TIw-bneD-mfzr-8wMJJx\n\n  --- Physical volume ---\n  PV Name               /dev/loop2\n  VG Name               vg201-test\n  PV Size               1.00 GiB / not usable 4.00 MiB\n  Allocatable           yes \n  PE Size               4.00 MiB\n  Total PE              255\n  Free PE               83\n  Allocated PE          172\n  PV UUID               AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 PE \u662f 4M\uff0c\u56e0\u6b64\u7f3a\u5c11 516 \u4e2a extent \u6307\u7f3a\u5c11 516 * 4M ~= 2G \u7a7a\u95f4\u3002 \u8fd9\u91cc\u662f\u56e0\u4e3a PV \u6570\u91cf\u4e0d\u8db3\uff0c\u6240\u4ee5\u65e0\u6cd5\u627e\u5230\u80fd\u591f\u5b58\u50a8\u7b2c\u56db\u4efd\u526f\u672c\u7684\u78c1\u76d8\u3002</p> <p><code>lvs</code> \u652f\u6301\u6307\u5b9a\u53c2\u6570\u67e5\u770b LV \u7684\u5176\u4ed6\u4fe1\u606f\uff0c\u8fd9\u91cc\u6211\u4eec\u67e5\u770b\u903b\u8f91\u5377\u5b9e\u9645\u4f7f\u7528\u7684\u7269\u7406\u5377\uff1a</p> <pre><code>$ sudo lvs -a -o +devices vg201-test\n  LV                 VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices                                                    \n  lvraid0            vg201-test -wi-a----- 516.00m                                                     /dev/loop0(0),/dev/loop1(0),/dev/loop2(0)                  \n  lvraid1            vg201-test rwi-a-r--- 512.00m                                    100.00           lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0] vg201-test iwi-aor--- 512.00m                                                     /dev/loop0(44)                                             \n  [lvraid1_rimage_1] vg201-test iwi-aor--- 512.00m                                                     /dev/loop1(44)                                             \n  [lvraid1_rimage_2] vg201-test iwi-aor--- 512.00m                                                     /dev/loop2(44)                                             \n  [lvraid1_rmeta_0]  vg201-test ewi-aor---   4.00m                                                     /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]  vg201-test ewi-aor---   4.00m                                                     /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]  vg201-test ewi-aor---   4.00m                                                     /dev/loop2(43)                                             \n  lvraid5            vg201-test rwi-a-r--- 208.00m                                    100.00           lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0] vg201-test iwi-aor--- 104.00m                                                     /dev/loop0(173)                                            \n  [lvraid5_rimage_1] vg201-test iwi-aor--- 104.00m                                                     /dev/loop1(173)                                            \n  [lvraid5_rimage_2] vg201-test iwi-aor--- 104.00m                                                     /dev/loop2(173)                                            \n  [lvraid5_rmeta_0]  vg201-test ewi-aor---   4.00m                                                     /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]  vg201-test ewi-aor---   4.00m                                                     /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]  vg201-test ewi-aor---   4.00m                                                     /dev/loop2(172)\n</code></pre> rimage, rmeta\uff08\u4e0e mimage, mlog\uff09 <p>\u53ef\u4ee5\u89c2\u5bdf\u5230\uff0c\u5217\u8868\u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u9690\u85cf\u7684\u903b\u8f91\u5377\uff0c\u5b83\u4eec\u662f\u521b\u5efa RAID 1/5/6 \u7684\u4ea7\u7269\uff1a</p> <ul> <li>rimage: \"RAID image\"\uff0c\u4ee3\u8868\u4e86\u5b9e\u9645\u5b58\u50a8\u6570\u636e\uff08\u4ee5\u53ca\u6821\u9a8c\u4fe1\u606f\uff09\u7684\u903b\u8f91\u5377</li> <li>rmeta: \u5b58\u50a8\u4e86 RAID \u7684\u5143\u6570\u636e\u4fe1\u606f</li> </ul> <p>\u5982\u679c\u5728\u521b\u5efa RAID 1 \u65f6\u9009\u62e9\u4e86 <code>--type mirror</code>\uff0c\u90a3\u4e48\u5bf9\u5e94\u521b\u5efa\u7684\u662f mimage \u548c mlog\uff1a</p> <ul> <li>mimage: \"mirrored image\"\uff0c\u6570\u636e\u5199\u5165\u65f6\uff0c\u4f1a\u5411\u6bcf\u4e2a\u5173\u8054\u7684 mimage \u5199\u5165\u6570\u636e</li> <li>mlog: \u5b58\u50a8\u4e86 RAID 1 \u7684\u76d8\u4e4b\u95f4\u7684\u540c\u6b65\u72b6\u6001\u4fe1\u606f</li> </ul>"},{"location":"ops/storage/lvm/#raid-maintain","title":"RAID \u7ef4\u62a4","text":""},{"location":"ops/storage/lvm/#raid-rebuild","title":"RAID \u72b6\u6001\u4e0e\u91cd\u5efa","text":"<p>\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c<code>lvs</code> \u8fd4\u56de\u7684 RAID 1/5/6 \u8bbe\u5907\u7684 \"Cpy%Sync\" \u5e94\u8be5\u662f 100.00\uff0c\u8868\u793a\u6570\u636e\u5df2\u7ecf\u540c\u6b65\u5230\u6240\u6709\u76d8\u4e0a\u3002 \u5e76\u4e14 <code>health_status</code> \u5c5e\u6027\u5e94\u8be5\u4e3a\u7a7a\u3002\u8fd9\u91cc\u6a21\u62df\u5f3a\u5236\u5220\u9664\u4e00\u5757\u76d8\u7684\u60c5\u51b5\uff1a</p> <pre><code>$ sudo vgchange -an vg201-test\n  0 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo losetup -D\n$ # \u63a5\u4e0b\u6765\u53ea\u6302\u8f7d\u4e24\u5757\u76d8\n$ sudo losetup -f --show pv1.img\n/dev/loop0\n$ sudo losetup -f --show pv2.img\n/dev/loop1\n$ sudo pvs\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  PV         VG         Fmt  Attr PSize    PFree  \n  /dev/loop0 vg201-test lvm2 a--  1020.00m 228.00m\n  /dev/loop1 vg201-test lvm2 a--  1020.00m 228.00m\n  [unknown]  vg201-test lvm2 a-m  1020.00m 224.00m\n$ sudo vgchange -ay vg201-test\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  Refusing activation of partial LV vg201-test/lvraid0.  Use '--activationmode partial' to override.\n  2 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo lvs -a -o name,copy_percent,health_status,devices vg201-test\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  LV                 Cpy%Sync Health          Devices                                                    \n  lvraid0                     partial         /dev/loop0(0),/dev/loop1(0),[unknown](0)                   \n  lvraid1            100.00   partial         lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0]                          /dev/loop0(44)                                             \n  [lvraid1_rimage_1]                          /dev/loop1(44)                                             \n  [lvraid1_rimage_2]          partial         [unknown](44)                                              \n  [lvraid1_rmeta_0]                           /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]                           /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]           partial         [unknown](43)                                              \n  lvraid5            100.00   partial         lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0]                          /dev/loop0(173)                                            \n  [lvraid5_rimage_1]                          /dev/loop1(173)                                            \n  [lvraid5_rimage_2]          partial         [unknown](173)                                             \n  [lvraid5_rmeta_0]                           /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]                           /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]           partial         [unknown](172)\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\uff1a</p> <ul> <li>RAID 0 \u7531\u4e8e\u7f3a\u5c11\u4e00\u5757\u76d8\uff0cLVM \u4f1a\u62d2\u7edd\u6fc0\u6d3b</li> <li>RAID 1/5 \u53ef\u4ee5\u6fc0\u6d3b\uff0c\u4f46\u662f health_status \u4e3a partial\uff0c\u8868\u793a\u5bf9\u5e94\u9635\u5217\u5904\u4e8e\u4e0d\u5b8c\u6574\u7684\u72b6\u6001</li> </ul> <p>\u5047\u8bbe\u6211\u4eec\u6dfb\u52a0\u4e00\u5757\u65b0\u76d8\uff0c\u5e76\u5220\u9664\u65e7\u76d8\uff0c\u8fdb\u884c RAID 1/5 \u7684\u91cd\u5efa\uff1a</p> <pre><code>$ truncate -s 1G pv4.img\n$ sudo losetup /dev/loop3 pv4.img\n$ sudo pvcreate /dev/loop3\n  Physical volume \"/dev/loop3\" successfully created.\n$ sudo vgextend vg201-test /dev/loop3\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  Volume group \"vg201-test\" successfully extended\n$ sudo lvconvert --repair vg201-test/lvraid1\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to [unknown]).\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\nAttempt to replace failed RAID images (requires full device resync)? [y/n]: y\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  Faulty devices in vg201-test/lvraid1 successfully replaced.\n$ sudo lvconvert --repair vg201-test/lvraid5\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to [unknown]).\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\nAttempt to replace failed RAID images (requires full device resync)? [y/n]: y\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  Faulty devices in vg201-test/lvraid5 successfully replaced.\n$ sudo lvs -a -o name,copy_percent,health_status,devices vg201-test\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to [unknown]).\n  LV                 Cpy%Sync Health          Devices                                                    \n  lvraid0                     partial         /dev/loop0(0),/dev/loop1(0),[unknown](0)                   \n  lvraid1            100.00                   lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0]                          /dev/loop0(44)                                             \n  [lvraid1_rimage_1]                          /dev/loop1(44)                                             \n  [lvraid1_rimage_2]                          /dev/loop3(1)                                              \n  [lvraid1_rmeta_0]                           /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]                           /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]                           /dev/loop3(0)                                              \n  lvraid5            100.00                   lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0]                          /dev/loop0(173)                                            \n  [lvraid5_rimage_1]                          /dev/loop1(173)                                            \n  [lvraid5_rimage_2]                          /dev/loop3(130)                                            \n  [lvraid5_rmeta_0]                           /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]                           /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]                           /dev/loop3(129)\n</code></pre> <p>\u4e0b\u9762\u5c55\u793a\u5c06\u539f\u59cb\u7684 <code>/dev/loop2</code> \u6062\u590d\u56de vg201-test \u7684\u8fc7\u7a0b\uff0c\u4ee5\u300c\u6062\u590d\u300d\u6700\u540e\u7684 RAID 0\u3002 \u901a\u8fc7\u4f7f\u7528 <code>vgextend</code> \u7684 <code>--restoremissing</code> \u53c2\u6570\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u91cd\u65b0\u521d\u59cb\u5316 <code>/dev/loop2</code>\uff0c\u800c\u662f\u76f4\u63a5\u5c06\u5176\u52a0\u5165\u5230\u5377\u7ec4\u4e2d\u3002 \u53ea\u5728\u786e\u5b9a\u539f\u59cb\u7684 PV \u6ca1\u6709\u88ab\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\u624d\u80fd\u5982\u6b64\u64cd\u4f5c\u3002</p> <pre><code>$ sudo losetup /dev/loop2 pv3.img\n$ sudo pvs\n  WARNING: ignoring metadata seqno 37 on /dev/loop2 for seqno 43 on /dev/loop0 for VG vg201-test.\n  WARNING: Inconsistent metadata found for VG vg201-test.\n  See vgck --updatemetadata to correct inconsistency.\n  WARNING: VG vg201-test was previously updated while PV /dev/loop2 was missing.\n  WARNING: VG vg201-test was missing PV /dev/loop2 AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  PV         VG         Fmt  Attr PSize    PFree  \n  /dev/loop0 vg201-test lvm2 a--  1020.00m 224.00m\n  /dev/loop1 vg201-test lvm2 a--  1020.00m 224.00m\n  /dev/loop2 vg201-test lvm2 a-m  1020.00m 848.00m\n  /dev/loop3 vg201-test lvm2 a--  1020.00m 396.00m\n$ sudo vgextend vg201-test /dev/loop2 --restoremissing\n  WARNING: ignoring metadata seqno 37 on /dev/loop2 for seqno 43 on /dev/loop0 for VG vg201-test.\n  WARNING: Inconsistent metadata found for VG vg201-test.\n  See vgck --updatemetadata to correct inconsistency.\n  WARNING: VG vg201-test was previously updated while PV /dev/loop2 was missing.\n  WARNING: VG vg201-test was missing PV /dev/loop2 AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test was previously updated while PV /dev/loop2 was missing.\n  WARNING: updating old metadata to 44 on /dev/loop2 for VG vg201-test.\n  Volume group \"vg201-test\" successfully extended\n$ sudo lvs -a -o name,copy_percent,health_status,devices vg201-test\n  LV                 Cpy%Sync Health          Devices                                                    \n  lvraid0                                     /dev/loop0(0),/dev/loop1(0),/dev/loop2(0)                  \n  lvraid1            100.00                   lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0]                          /dev/loop0(44)                                             \n  [lvraid1_rimage_1]                          /dev/loop1(44)                                             \n  [lvraid1_rimage_2]                          /dev/loop3(1)                                              \n  [lvraid1_rmeta_0]                           /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]                           /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]                           /dev/loop3(0)                                              \n  lvraid5            100.00                   lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0]                          /dev/loop0(173)                                            \n  [lvraid5_rimage_1]                          /dev/loop1(173)                                            \n  [lvraid5_rimage_2]                          /dev/loop3(130)                                            \n  [lvraid5_rmeta_0]                           /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]                           /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]                           /dev/loop3(129)\n</code></pre>"},{"location":"ops/storage/lvm/#raid-scrub","title":"\u5b8c\u6574\u6027\u68c0\u67e5","text":"<p>\u5373\u4f7f\u6b63\u5e38\u8fd0\u884c\uff0cRAID \u4e5f\u65e0\u6cd5\u9632\u6b62\u9635\u5217\u4e2d\u7684\u67d0\u5757\u786c\u76d8\u56e0\u4e3a\u67d0\u79cd\u539f\u56e0\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\uff08\u4f8b\u5982\u6bd4\u7279\u7ffb\u8f6c\uff09\uff0c \u56e0\u6b64\u5b9a\u671f\u8fdb\u884c\u5b8c\u6574\u6027\u68c0\u67e5\uff08Scrub\uff09\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u4ee5\u4e0b\u5c55\u793a\u4e00\u4e2a\u6ca1\u6709\u5b9a\u671f scrub \u7684\u53cd\u4f8b\uff1a</p> <p>\u6709\u4e00\u4e2a\u4e09\u5757\u76d8\u7684 RAID1\uff0c\u56e0\u4e3a\u67d0\u4e9b\u795e\u5947\u7684\u8bef\u64cd\u4f5c\uff0c\u5176\u4e2d\u4e00\u5757\u76d8\u7684\u72b6\u6001\u4e00\u76f4\u662f 2018 \u5e74\u7684\uff0c\u53e6\u4e24\u5757\u662f\u6b63\u786e\u7684 RAID1\uff0c\u7136\u540e\u8fd9\u7ec4\u76d8\u88ab\u632a\u5230\u4e86\u65b0\u673a\u5668\uff0c\u88ab\u91cd\u65b0\u52a0\u6210\u4e86\u4e00\u4e2a\u4e09\u76d8\u7684 RAID1\uff0c\u8f6f RAID \u8f6f\u4ef6 somehow \u6ca1\u6709\u505a\u68c0\u67e5\u5c31\u8dd1\u4e86\u8d77\u6765\uff0c\u4e8e\u662f\u8bfb\u6587\u4ef6\u65f6\u6709 1/3 \u6982\u7387\u8bfb\u53d6\u5230\u65e7\u76d8\uff0c\u4e5f\u5c31\u662f ls \u4e00\u4e0b\u53ef\u80fd\u770b\u5230\u65e7\u6587\u4ef6\u4e5f\u53ef\u80fd\u770b\u5230\u65b0\u6587\u4ef6\uff0c\u53ef\u80fd\u8fd9\u6837\u7528\u4e86\u5f88\u957f\u4e00\u6bb5\u65f6\u95f4\u4e00\u76f4\u6ca1\u53d1\u73b0\uff0c\u6628\u5929\u91cd\u542f\u4e4b\u540e\u7a81\u7136\u53d1\u73b0 glibc \u56de\u5230\u4e86 2018 \u5e74</p> <p>\u53e6\u4e00\u4e2a\u6ca1\u6709 scrub \u6570\u636e\uff0c\u6700\u7ec8\u5bfc\u81f4\u6587\u4ef6\u4e22\u5931\u7684\u4f8b\u5b50\u662f Linus Tech Tips\uff08YouTube/Bilibili, 05:15\uff09\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u5411 <code>pv4.img</code> \u4e2d\u95f4\u5199\u5165 1M \u7684\u968f\u673a\u6570\u636e\uff0c\u5e76\u5c55\u793a LVM \u7684\u68c0\u67e5\u4e0e\u4fee\u590d\u529f\u80fd\u3002</p> <pre><code>$ sudo dd if=/dev/urandom of=/dev/loop3 bs=1M count=1 oseek=100\n1+0 records in\n1+0 records out\n1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00402655 s, 260 MB/s\n$ sudo lvs -o devices vg201-test\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvraid0 vg201-test -wi------- 516.00m                                                    \n  lvraid1 vg201-test rwi-a-r--- 512.00m                                    100.00          \n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00\n$ sudo lvchange --syncaction check vg201-test/lvraid1\n$ sudo dmesg\n\uff08\u7701\u7565\uff09\n[1655658.162616] md: mdX: data-check done.\n[1655663.533169] md: data-check of RAID array mdX\n$ sudo lvs -o +raid_sync_action,raid_mismatch_count\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert SyncAction Mismatches\n  lvraid0 vg201-test -wi------- 516.00m                                                                          \n  lvraid1 vg201-test rwi-a-r-m- 512.00m                                    100.00           idle             2048\n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00           idle                0\n$ # \u56e0\u4e3a\u6211\u4eec\u7684 RAID 1 \u6709\u4e09\u5757\u76d8\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u300c\u4e0d\u4e00\u81f4\u300d\u8fd8\u53ef\u4ee5\u4fee\u590d\u3002\n$ sudo lvchange --syncaction repair vg201-test/lvraid1\n$ sudo dmesg\n\uff08\u7701\u7565\uff09\n[1655787.490037] md: requested-resync of RAID array mdX\n[1655789.691174] md: mdX: requested-resync done.\n$ sudo lvs -o +raid_sync_action,raid_mismatch_count\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert SyncAction Mismatches\n  lvraid0 vg201-test -wi------- 516.00m                                                                          \n  lvraid1 vg201-test rwi-a-r--- 512.00m                                    100.00           idle                0\n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00           idle                0\n</code></pre> <p>dm-integrity</p> <p>LVM \u652f\u6301\u5728\u8bbe\u7f6e RAID \u65f6\u6dfb\u52a0 integrity \u529f\u80fd\uff08<code>--raidintegrity</code>\uff09\uff0c\u8fd9\u9879\u529f\u80fd\u4e3a\u6570\u636e\u6dfb\u52a0\u4e86\u6821\u9a8c\u548c\uff0c LVM \u5728\u53d1\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u65f6\u4f1a\u5728\u5185\u6838\u65e5\u5fd7\u4e2d\u62a5\u544a\uff0c\u5e76\u5728\u53ef\u4ee5\u4fee\u590d\u7684\u60c5\u51b5\u4e0b\u81ea\u52a8\u4fee\u590d\u3002</p> <p>\u8fd9\u9879\u529f\u80fd\u4e0d\u662f scrub \u7684\u66ff\u4ee3\u54c1\u3002</p>"},{"location":"ops/storage/lvm/#resize","title":"\u6269\u5bb9/\u7f29\u5c0f\u64cd\u4f5c","text":"<p>LVM \u652f\u6301\u5728\u7ebf\u6269\u5bb9/\u7f29\u5c0f\u903b\u8f91\u5377\uff0c\u6709\u4e09\u4e2a\u76f8\u5173\u547d\u4ee4\uff1a<code>lvextend</code>\uff08\u6269\u5927\uff09\u3001<code>lvreduce</code>\uff08\u7f29\u5c0f\uff09\u3001<code>lvresize</code>\uff08\u901a\u7528\uff09\u3002 \u8ba9\u6211\u4eec\u5148\u5728 lvraid0 \u4e0a\u521b\u5efa\u4e00\u4e2a ext4 \u6587\u4ef6\u7cfb\u7edf\u5e76\u6302\u8f7d\uff0c\u6a21\u62df\u5728\u7ebf\u573a\u666f\uff1a</p> <pre><code>$ sudo mkfs.ext4 /dev/vg201-test/lvraid0\nmke2fs 1.47.0 (5-Feb-2023)\nDiscarding device blocks: done                            \nCreating filesystem with 132096 4k blocks and 33040 inodes\nFilesystem UUID: 49e73c33-1ea2-43fa-8609-586389a11b98\nSuperblock backups stored on blocks: \n    32768, 98304\n\nAllocating group tables: done                            \nWriting inode tables: done                            \nCreating journal (4096 blocks): done\nWriting superblocks and filesystem accounting information: done\n$ sudo mount /dev/vg201-test/lvraid0 /somewhere/you/like\n$ df -h /somewhere/you/like\nFilesystem                       Size  Used Avail Use% Mounted on\n/dev/mapper/vg201--test-lvraid0  492M  152K  455M   1% /somewhere/you/like\n</code></pre> <p>\u4e0b\u9762\u5c55\u793a <code>lvextend</code> \u548c <code>lvreduce</code>\u3002<code>lvresize</code> \u7684\u64cd\u4f5c\u53ef\u4ee5\u81ea\u884c\u67e5\u9605\u3002</p> <pre><code>$ sudo lvextend --size +100M /dev/vg201-test/lvraid0\n  Using stripesize of last segment 64.00 KiB\n  Rounding size (154 extents) up to stripe boundary size for segment (156 extents).\n  Size of logical volume vg201-test/lvraid0 changed from 516.00 MiB (129 extents) to 624.00 MiB (156 extents).\n  Logical volume vg201-test/lvraid0 successfully resized.\n</code></pre> <p>\u6b64\u65f6 <code>lvraid0</code> \u8fd9\u4e2a LV \u5df2\u7ecf\u589e\u5927\u4e86 100M\uff0c\u4f46\u662f\u6587\u4ef6\u7cfb\u7edf\u5e76\u6ca1\u6709\u611f\u77e5\u5230\u8fd9\u4e2a\u53d8\u5316\uff1a</p> <pre><code>$ df -h /somewhere/you/like\nFilesystem                       Size  Used Avail Use% Mounted on\n/dev/mapper/vg201--test-lvraid0  492M  152K  455M   1% /somewhere/you/like\n</code></pre> <p>\u56e0\u6b64\u6211\u4eec\u9700\u8981\u7528\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u7684\u5de5\u5177\u6269\u5bb9\u3002ext4 \u652f\u6301\u4f7f\u7528 <code>resize2fs</code> \u5728\u7ebf\u6269\u5bb9/\u7f29\u5c0f\uff1a</p> <pre><code>$ sudo resize2fs /dev/vg201-test/lvraid0\nresize2fs 1.47.0 (5-Feb-2023)\nFilesystem at /dev/vg201-test/lvraid0 is mounted on /somewhere/you/like; on-line resizing required\nold_desc_blocks = 1, new_desc_blocks = 1\nThe filesystem on /dev/vg201-test/lvraid0 is now 159744 (4k) blocks long.\n\n$ df -h /somewhere/you/like\nFilesystem                       Size  Used Avail Use% Mounted on\n/dev/mapper/vg201--test-lvraid0  600M  152K  563M   1% /somewhere/you/like\n</code></pre> <p>\u7f29\u5c0f\u64cd\u4f5c\u7684\u987a\u5e8f\u521a\u597d\u76f8\u53cd\uff1a\u9700\u8981\u5148\u7f29\u5c0f\u6587\u4ef6\u7cfb\u7edf\uff0c\u518d\u7f29\u5c0f LV\u3002 \u5426\u5219\u6587\u4ef6\u7cfb\u7edf\u88ab\u7f29\u5c0f\u7684\u90e8\u5206\u4f1a\u4e22\u5931\uff0c\u5bfc\u81f4\u6587\u4ef6\u7cfb\u7edf\u635f\u574f\u3002 \u7531\u4e8e ext4 \u6587\u4ef6\u7cfb\u7edf\u4e0d\u652f\u6301\u5728\u7ebf\u7f29\u5c0f\uff0c\u56e0\u6b64\u64cd\u4f5c\u524d\u5fc5\u987b\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u3002 \u8fd9\u91cc\u6211\u4eec\u628a\u6587\u4ef6\u7cfb\u7edf\u7f29\u5230\u6700\u5c0f\uff0c\u7136\u540e\u7f29\u5c0f LV\uff0c\u6700\u540e\u518d\u6269\u5927\u6587\u4ef6\u7cfb\u7edf\uff1a</p> <pre><code>$ sudo umount /somewhere/you/like\n$ sudo resize2fs -M /dev/vg201-test/lvraid0\nresize2fs 1.47.0 (5-Feb-2023)\nPlease run 'e2fsck -f /dev/vg201-test/lvraid0' first.\n\n$ # \u5728\u7f29\u5c0f\u524d\uff0c\u4fdd\u9669\u8d77\u89c1\uff0c\u9700\u8981\u5148\u68c0\u67e5\u6587\u4ef6\u7cfb\u7edf\u7684\u5b8c\u6574\u6027\n$ sudo e2fsck -f /dev/vg201-test/lvraid0\ne2fsck 1.47.0 (5-Feb-2023)\nPass 1: Checking inodes, blocks, and sizes\nPass 2: Checking directory structure\nPass 3: Checking directory connectivity\nPass 4: Checking reference counts\nPass 5: Checking group summary information\n/dev/vg201-test/lvraid0: 12/33040 files (0.0% non-contiguous), 6407/159744 blocks\n$ sudo resize2fs -M /dev/vg201-test/lvraid0\nresize2fs 1.47.0 (5-Feb-2023)\nResizing the filesystem on /dev/vg201-test/lvraid0 to 6420 (4k) blocks.\nThe filesystem on /dev/vg201-test/lvraid0 is now 6420 (4k) blocks long.\n\n$ # \u73b0\u5728\u7f29\u5c0f LV\n$ sudo lvreduce --size -100M /dev/vg201-test/lvraid0\n  Rounding size (131 extents) up to stripe boundary size for segment (132 extents).\n  File system ext4 found on vg201-test/lvraid0.\n  File system size (&lt;25.08 MiB) is smaller than the requested size (528.00 MiB).\n  File system reduce is not needed, skipping.\n  Size of logical volume vg201-test/lvraid0 changed from 624.00 MiB (156 extents) to 528.00 MiB (132 extents).\n  Logical volume vg201-test/lvraid0 successfully resized.\n$ sudo resize2fs /dev/vg201-test/lvraid0\nresize2fs 1.47.0 (5-Feb-2023)\nResizing the filesystem on /dev/vg201-test/lvraid0 to 135168 (4k) blocks.\nThe filesystem on /dev/vg201-test/lvraid0 is now 135168 (4k) blocks long.\n\n$ sudo mount /dev/vg201-test/lvraid0 /somewhere/you/like\n$ df -h /somewhere/you/like\nFilesystem                       Size  Used Avail Use% Mounted on\n/dev/mapper/vg201--test-lvraid0  504M  152K  471M   1% /somewhere/you/like\n</code></pre> <p>\u5bf9\u4e8e\u652f\u6301\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c<code>lvreduce</code> \u4f1a\u68c0\u67e5\u6587\u4ef6\u7cfb\u7edf\u7684\u5927\u5c0f\uff0c\u907f\u514d\u6570\u636e\u635f\u574f\u3002\u4f46\u5728\u64cd\u4f5c\u65f6\u4ecd\u7136\u9700\u8981\u8c28\u614e\u3002</p>"},{"location":"ops/storage/lvm/#lvmcache","title":"SSD \u7f13\u5b58","text":"<p>LVM \u652f\u6301\u5c06 SSD \u4f5c\u4e3a HDD \u7684\u7f13\u5b58\uff0c\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002\u4ee5\u4e0b\u4ecb\u7ecd\u57fa\u4e8e dm-cache \u7684\u8bfb\u5199\u7f13\u5b58\u3002</p> <p>dm-writecache</p> <p>\u672c\u90e8\u5206\u4e0d\u4ecb\u7ecd\u4ee5\u4f18\u5316\u5199\u5165\u4e3a\u76ee\u7684\u7684 dm-writecache\u2014\u2014\u6211\u4eec\u6ca1\u6709\u76f8\u5173\u7684\u4f7f\u7528\u573a\u666f\u3002</p> <p>\u7f13\u5b58\u65b9\u6848</p> <p>\u76ee\u524d\u5185\u6838\u81ea\u5e26\u8fd9\u4e9b\u7f13\u5b58\u65b9\u6848\uff1a</p> <ul> <li>bcache\uff1a\u9700\u8981\u5c06 SSD \u548c HDD \u5bf9\u5e94\u7684\u5757\u8bbe\u5907\u5206\u533a\u4f7f\u7528 <code>make-bcache</code> \u521d\u59cb\u5316\u540e\uff0c \u5728 bcache \u66b4\u9732\u7684 <code>/dev/bcache0</code> \u4e0a\u8fdb\u884c\u64cd\u4f5c\u3002</li> <li>lvmcache\uff1a\u9700\u8981\u5728 LVM \u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u64cd\u4f5c\u3002\u57fa\u4e8e\u5185\u6838\u7684 dm-cache\u3002</li> </ul> <p>\u6b64\u5916\uff0c\u5728 Linux 6.7\uff082024 \u5e74 1 \u6708\uff09\u4e4b\u540e\uff0c\u5185\u6838\u5408\u5e76\u4e86 bcachefs \u652f\u6301\uff0c\u5b83\u540c\u6837\u4e5f\u5305\u542b\u4e86 SSD \u7f13\u5b58\u7684\u529f\u80fd\u3002 \u4f46\u662f bcachefs \u7684\u7a33\u5b9a\u6027\u4ecd\u7136\u9700\u8981\u81f3\u5c11\u6570\u5e74\u7684\u65f6\u95f4\u6765\u9a8c\u8bc1\u3002ZFS \u540c\u6837\u4e5f\u5305\u542b\u7f13\u5b58\u529f\u80fd\uff08ARC \u4e0e L2ARC\uff09\uff0c\u5c06\u5728 ZFS \u4e2d\u4ecb\u7ecd\u3002</p> <p>\u4e0d\u8fc7\uff0c\u968f\u7740 SSD \u5355\u4f4d\u7a7a\u95f4\u6210\u672c\u9010\u6e10\u964d\u4f4e\uff0cSSD \u7f13\u5b58\u7684\u610f\u4e49\u4e5f\u5728\u9010\u6e10\u51cf\u5c0f\u3002 \u751a\u81f3\u4e5f\u6709\u9884\u6d4b\u8868\u660e\uff0c\u5230 2026 \u5e74\u540e SSD \u7684\u6210\u672c\u751a\u81f3\u4f1a\u4f4e\u4e8e HDD\u3002\u5185\u6838\u4e2d <code>dm-cache</code> \u7684\u5f00\u53d1\u4e5f\u4e0d\u6d3b\u8dc3\u3002</p> <p>\u5728\u8003\u8651\u7f13\u5b58\u65b9\u6848\u7684\u9009\u62e9\u65f6\uff0c\u9700\u8981\u8003\u8651\u5404\u79cd\u56e0\u7d20\uff0c\u4e0b\u6587\u4f1a\u505a\u4e00\u4e9b\u7b80\u5355\u7684\u4ecb\u7ecd\u3002</p> <p>\u9996\u5148\u5220\u9664\u4e0a\u9762\u521b\u5efa\u7684 LV \u4e0e PV\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5927\u7684 image \u548c\u4e00\u4e2a\u5c0f\u7684 image \u4f5c\u4e3a HDD \u4e0e SSD\uff1a</p> <pre><code>$ sudo lvremove vg201-test/lvraid0 vg201-test/lvraid1 vg201-test/lvraid5\n  Logical volume \"lvraid0\" successfully removed.\nDo you really want to remove active logical volume vg201-test/lvraid1? [y/n]: y\n  Logical volume \"lvraid1\" successfully removed.\nDo you really want to remove active logical volume vg201-test/lvraid5? [y/n]: y\n  Logical volume \"lvraid5\" successfully removed.\n$ sudo vgremove vg201-test\n  Volume group \"vg201-test\" successfully removed\n$ sudo losetup -D\n$ rm pv*.img\n$ truncate -s 100G hdd.img\n$ truncate -s 10G ssd.img\n$ sudo losetup -f --show hdd.img\n/dev/loop0\n$ sudo losetup -f --show ssd.img\n/dev/loop1\n$ sudo pvcreate /dev/loop0 /dev/loop1\n  Physical volume \"/dev/loop0\" successfully created.\n  Physical volume \"/dev/loop1\" successfully created.\n$ sudo vgcreate vg201-test /dev/loop0 /dev/loop1\n  Volume group \"vg201-test\" successfully created\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa\u5b58\u50a8\uff08\u540e\u5907\uff09\u6570\u636e\u7684 LV\uff0c\u8fd9\u4e2a LV \u53ea\u5e94\u8be5\u5728 HDD \u4e0a\uff1a</p> <pre><code>$ sudo lvcreate -n lvdata -l 100%FREE vg201-test /dev/loop0\n  Logical volume \"lvdata\" created.\n$ sudo lvs -o +devices vg201-test\n  LV     VG         Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices      \n  lvdata vg201-test -wi-a----- &lt;100.00g                                                     /dev/loop0(0)\n</code></pre> <p>@taoky: \u53e6\u4e00\u79cd\u505a\u6cd5</p> <p>\u5728\u914d\u7f6e mirrors4 \u670d\u52a1\u5668\u7684\u7f13\u5b58\u65f6\uff0c\u6211\u4eec\u7684\u6587\u6863\u4e2d\u7684\u505a\u6cd5\u662f\u628a SSD \u548c HDD \u5206\u522b\u5f00 VG\uff0c\u5728\u540e\u9762\u521b\u5efa\u597d\u4e4b\u540e\u518d <code>vgmerge</code>\u3002</p> <p>\u8fd9\u4e48\u505a\u5176\u5b9e\u662f\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u53ea\u8981 <code>lvcreate</code> \u7684\u65f6\u5019\u6e05\u9192\u4e00\u4e9b\u5c31\u884c\u3002 \u51b5\u4e14\u7f13\u5b58\u76d8\u548c\u540e\u5907\u8bbe\u5907\u5fc5\u987b\u5728\u540c\u4e00\u4e2a VG \u91cc\u5934\u3002</p> <p>\u4e4b\u540e\u6211\u4eec\u9700\u8981\u521b\u5efa\u7f13\u5b58\u76f8\u5173\u7684 LV\u3002LVM \u652f\u6301\u4e24\u79cd\u65b9\u5f0f\uff1a<code>cachevol</code> \u548c <code>cachepool</code>\uff1a</p> <ul> <li><code>cachevol</code> \u5728\u4e00\u4e2a LV \u4e2d\u5305\u542b\u4e86\u7f13\u5b58\u7684\u6570\u636e\u548c\u5143\u6570\u636e</li> <li><code>cachepool</code> \u5c06\u7f13\u5b58\u7684\u6570\u636e\u548c\u5143\u6570\u636e\u5206\u5f00\u5b58\u50a8\uff08\u56e0\u6b64\u53ef\u4ee5\u5c06\u6570\u636e\u548c\u5143\u6570\u636e\u653e\u5230\u4e0d\u540c\u7684\u8bbe\u5907\u4e0a\uff09</li> </ul> <p>\u8bb8\u591a\u6559\u7a0b\u4e2d\u90fd\u4f7f\u7528 <code>cachepool</code>\uff0c\u4f46\u662f\u5f88\u591a\u65f6\u5019\u662f\u6ca1\u6709\u5fc5\u8981\u7684\u3002</p> <p>\u4e0b\u9762\u5148\u5c55\u793a <code>cachevol</code> \u7684\u64cd\u4f5c\uff08\u53ea\u9700\u4e24\u6b65\uff1a\u521b\u5efa\u7f13\u5b58\u76d8\uff0c\u7136\u540e <code>lvconvert</code> \u914d\u7f6e\u7f13\u5b58\u5373\u53ef\uff09\uff1a</p> <pre><code>$ sudo lvcreate -n lvdata_cache -l 100%FREE vg201-test /dev/loop1\n  Logical volume \"lvdata_cache\" created.\n$ sudo lvconvert --type cache --cachevol lvdata_cache vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  Logical volume vg201-test/lvdata is now cached.\n$ sudo lvs -a -o +devices vg201-test\n  LV                  VG         Attr       LSize    Pool                Origin         Data%  Meta%  Move Log Cpy%Sync Convert Devices        \n  lvdata              vg201-test Cwi-a-C--- &lt;100.00g [lvdata_cache_cvol] [lvdata_corig] 0.01   11.07           0.00             lvdata_corig(0)\n  [lvdata_cache_cvol] vg201-test Cwi-aoC---  &lt;10.00g                                                                            /dev/loop1(0)  \n  [lvdata_corig]      vg201-test owi-aoC--- &lt;100.00g                                                                            /dev/loop0(0)\n</code></pre> <p><code>lvs</code> \u4e5f\u53ef\u4ee5\u8f93\u51fa\u4e00\u4e9b\u7f13\u5b58\u76f8\u5173\u7684\u914d\u7f6e\u548c\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <pre><code>$ sudo lvs -o devices,cache_policy,cachemode,cache_settings,cache_total_blocks,cache_used_blocks,cache_dirty_blocks,cache_read_hits,cache_read_misses,cache_write_hits,cache_write_misses\n  Devices         CachePolicy CacheMode    CacheSettings CacheTotalBlocks CacheUsedBlocks  CacheDirtyBlocks CacheReadHits    CacheReadMisses  CacheWriteHits   CacheWriteMisses\n  lvdata_corig(0) smq         writethrough                         163584               15                0                5               51                0                0\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u7f13\u5b58\u7684\u6a21\u5f0f\u662f writethrough\uff0c\u7b56\u7565\u662f smq\uff0c\u4ee5\u53ca\u7f13\u5b58\u7684\u8bfb\u5199\u547d\u4e2d\u7387\u4e0e\u810f\u5757\u6570\u91cf\u3002</p> <p>resize</p> <p>\u76f4\u5230\u76f8\u5bf9\u65b0\uff08&gt;= 2.03.12\uff0c\u53d1\u5e03\u4e8e 2021/05/08\uff09\u7684 LVM \u5de5\u5177\u4e4b\u524d\uff0c\u88ab\u7f13\u5b58\u7684 LV \u4e0d\u80fd\u88ab resize\u3002\u56e0\u6b64 resize \u4e4b\u524d\u5fc5\u987b\u5148\u64a4\u4e0b\u7f13\u5b58\uff0cresize \u7ed3\u675f\u540e\u518d\u5b89\u56de\u53bb\u3002</p> <p>\u56e0\u6b64 Debian Bookworm \u7684 LVM \u5de5\u5177\u652f\u6301\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7684 resize\uff0c\u800c Bullseye \u4e0d\u652f\u6301\u3002</p> <p><code>cachevol</code> \u65e0\u6cd5\u4fee\u590d</p> <p>\u76ee\u524d <code>lvconvert --repair</code> \u4e0d\u652f\u6301\u4fee\u590d cachevol\uff0c\u5c1d\u8bd5\u8fd9\u4e48\u505a\u4f1a\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>$ sudo lvconvert --repair vg201-test/lvdata_cache_cvol\n  WARNING: Command on LV vg201-test/lvdata_cache_cvol does not accept LV type linear.\n  Command not permitted on LV vg201-test/lvdata_cache_cvol.\n</code></pre> <p>lvmcache \u7684\u7f13\u5b58\u6a21\u5f0f\u3001\u7b56\u7565\u4e0e\u90e8\u5206\u672f\u8bed</p> <p>lvmcache \u652f\u6301\u4e09\u79cd\u7f13\u5b58\u6a21\u5f0f\uff1a</p> <ul> <li>passthrough: \u7f13\u5b58\u65e0\u6548\u3002\u6b64\u65f6\u6240\u6709\u8bfb\u5199\u90fd\u5230\u540e\u5907\u8bbe\u5907\u3002\u540c\u65f6\u5199\u547d\u4e2d\u4f1a\u89e6\u53d1\u5bf9\u5e94\u7684\u5757\u7f13\u5b58\u5931\u6548\u3002</li> <li>writethrough: \u5199\u5165\u64cd\u4f5c\u5728\u7f13\u5b58\u548c\u540e\u5907\u8bbe\u5907\u4e0a\u90fd\u8fdb\u884c\uff0c\u5728\u4e24\u8005\u5747\u5199\u5165\u5b8c\u6210\u540e\u624d\u89c6\u4f5c\u5199\u5165\u751f\u6548\u3002</li> <li>writeback: \u5199\u5165\u64cd\u4f5c\u5148\u5728\u7f13\u5b58\u4e0a\u8fdb\u884c\uff0c\u5bf9\u5e94\u7684\u5757\u6807\u8bb0\u4e3a\u810f\u5757\uff08Dirty Block\uff09\uff0c\u63a8\u8fdf\u5728\u540e\u5907\u8bbe\u5907\u4e0a\u7684\u5199\u5165\u3002 \u9664\u975e\u88ab\u7f13\u5b58\u7684\u6570\u636e\u5b8c\u5168\u65e0\u5173\u7d27\u8981\uff0c\u6216\u8005\u6709\u591a\u5757 SSD \u8fdb\u884c\u7f13\u5b58\uff0c\u5426\u5219\u4e0d\u8981\u4f7f\u7528 writeback\u3002\u6587\u4ef6\u7cfb\u7edf\u6838\u5fc3\u5143\u6570\u636e\u7684\u635f\u574f\u53ef\u80fd\u76f4\u63a5\u5bfc\u81f4\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u65e0\u6cd5\u8bfb\u53d6\u3002</li> </ul> <p>\u5728\u7b56\u7565\u4e00\u680f\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 \"smq\"\u3002\u4e8b\u5b9e\u4e0a\uff0clvmcache \u552f\u4e00\u652f\u6301\u7684\u6709\u6548\u7684\u73b0\u4ee3\u7b56\u7565\u5c31\u662f smq\uff08Stochastic Multi-Queue\uff09\u3002 \u53e6\u4e00\u79cd cleaner \u7b56\u7565\u7528\u4e8e\u5c06\u6240\u6709\u810f\u5757\u5199\u56de\u540e\u5907\u8bbe\u5907\u3002</p> <p>\u6b64\u5916\uff0c\u5728\u9605\u8bfb\u76f8\u5173\u8d44\u6599\u65f6\uff0c\u53ef\u80fd\u4f1a\u770b\u5230\u4e0b\u9762\u4e09\u4e2a\u672f\u8bed\uff1a</p> <ul> <li>Migration\uff1a\u5c06\u4e00\u5757\u6570\u636e\u4ece\u4e00\u4e2a\u8bbe\u5907\u590d\u5236\u5230\u53e6\u4e00\u4e2a\u8bbe\u5907</li> <li>Promotion\uff1a\u5c06\u4e00\u5757\u6570\u636e\u4ece\u540e\u5907\u8bbe\u5907\u590d\u5236\u5230\u7f13\u5b58\u8bbe\u5907</li> <li>Demotion\uff1a\u5c06\u4e00\u5757\u6570\u636e\u4ece\u7f13\u5b58\u8bbe\u5907\u590d\u5236\u5230\u540e\u5907\u8bbe\u5907</li> </ul> <p>@taoky: \u5173\u4e8e\u7f13\u5b58\u6a21\u5f0f</p> <p>\u5206\u4eab\u4e00\u4e2a\u7b11\u8bdd\uff0c\u6700\u5f00\u59cb @iBug \u914d\u7684\u7f13\u5b58\u6a21\u5f0f\u9009\u4e86 passthrough\uff0c\u7406\u7531\u662f\uff1a</p> <p>\u8fd9\u91cc\u7684\u7f13\u5b58\u6a21\u5f0f\u91c7\u7528 passthrough\uff0c\u5373\u5199\u5165\u52a8\u4f5c\u7ed5\u8fc7\u7f13\u5b58\u76f4\u63a5\u5199\u56de\u539f\u8bbe\u5907\uff08\u5f53\u7136\u5566\uff0c\u5199\u5165\u90fd\u662f\u7531\u4ece\u4e0a\u6e38\u540c\u6b65\u4ea7\u751f\u7684\uff09\uff0c\u53e6\u5916\u4e24\u79cd writeback \u548c writethrough \u90fd\u4f1a\u5199\u5165\u7f13\u5b58\uff0c\u4e0d\u662f\u6211\u4eec\u60f3\u8981\u7684\u3002</p> <p>\uff08\u5f53\u7136\uff0c\u8fd9\u662f\u9519\u7684\uff09</p> <p>\u53e6\u5916\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c<code>lvmcache</code> \u505a\u4e86\u8fd9\u4e48\u4e00\u4e2a\u5047\u8bbe\uff1a\u5199\u5165\u7684\u5185\u5bb9\u5f88\u5feb\u5c31\u4f1a\u88ab\u8bfb\u53d6\u3002\u4f46\u662f\u8fd9\u4e2a\u5047\u8bbe\u771f\u7684\u603b\u662f\u6210\u7acb\u5417\uff1f writearound \u7684\u505a\u6cd5\u662f\u5199\u5165\u7684\u5185\u5bb9\u4f1a\u7ed5\u8fc7\u7f13\u5b58\uff0c\u5f53\u7136 lvmcache \u6ca1\u6709\u5b9e\u73b0\u8fd9\u4e2a\u6a21\u5f0f\u3002</p> <code>dm-cache-policy-smq.c</code> \u4e2d\u5b9e\u73b0\u7684 SMQ \u7b56\u7565\u7b97\u6cd5 <p>\u6838\u5fc3\u7684\u7ed3\u6784\u4f53\u662f <code>smq_policy</code>\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e09\u4e2a SMQ \u961f\u5217\uff1a\u70ed\u70b9\uff08hotspot\uff09\u961f\u5217\u3001clean \u961f\u5217\u548c dirty \u961f\u5217\u3002 \u6bcf\u4e2a SMQ \u961f\u5217\u4e2d\u5305\u542b 64 \u4e2a LRU \u961f\u5217\u3002\u8fd9 64 \u4e2a\u961f\u5217\u6784\u6210\u4e0d\u540c\u7684\u7b49\u7ea7\uff0c\u5b58\u50a8\u7531\u70ed\u5230\u51b7\u7684\u5185\u5bb9\u3002</p> <p>\u5982\u679c\u4e0d\u5173\u5fc3\u6570\u636e\u5377\u548c\u5143\u6570\u636e\u5377\u7684\u7ec6\u8282\uff0c\u521b\u5efa <code>cachepool</code> \u7684\u4f53\u9a8c\u4e5f\u7c7b\u4f3c\u3002\u5148\u628a\u4e0a\u9762\u7684 uncache \u6389\uff1a</p> <pre><code>$ sudo lvconvert --uncache vg201-test/lvdata\n  Logical volume \"lvdata_cache\" successfully removed.\n  Logical volume vg201-test/lvdata is not cached and vg201-test/lvdata_cache is removed.\n</code></pre> <p>\u7136\u540e\u521b\u5efa cache-pool \u7c7b\u578b\u7684 LV\uff0c\u5e76\u4e14\u9644\u52a0\u5230\u540e\u5907\u8bbe\u5907\u4e0a\uff1a</p> <pre><code>$ sudo lvcreate --type cache-pool -n lvdata_cache -l 100%FREE vg201-test /dev/loop1\n  Logical volume \"lvdata_cache\" created.\n$ sudo lvs -a\n  LV                   VG         Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata               vg201-test -wi-a----- &lt;100.00g                                                    \n  lvdata_cache         vg201-test Cwi---C---    9.97g                                                    \n  [lvdata_cache_cdata] vg201-test Cwi-------    9.97g                                                    \n  [lvdata_cache_cmeta] vg201-test ewi-------   12.00m                                                    \n  [lvol0_pmspare]      vg201-test ewi-------   12.00m\n$ sudo lvconvert --type cache --cachepool lvdata_cache vg201-test/lvdata\nDo you want wipe existing metadata of cache pool vg201-test/lvdata_cache? [y/n]: y\n  Logical volume vg201-test/lvdata is now cached.\n$ sudo lvs -a\n  LV                         VG         Attr       LSize    Pool                 Origin         Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata                     vg201-test Cwi-a-C--- &lt;100.00g [lvdata_cache_cpool] [lvdata_corig] 0.01   11.07           0.00            \n  [lvdata_cache_cpool]       vg201-test Cwi---C---    9.97g                                     0.01   11.07           0.00            \n  [lvdata_cache_cpool_cdata] vg201-test Cwi-ao----    9.97g                                                                            \n  [lvdata_cache_cpool_cmeta] vg201-test ewi-ao----   12.00m                                                                            \n  [lvdata_corig]             vg201-test owi-aoC--- &lt;100.00g                                                                            \n  [lvol0_pmspare]            vg201-test ewi-------   12.00m\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\uff0c\u5728 <code>lvcreate --type cache-pool</code> \u7684\u65f6\u5019\uff0cLVM \u4f1a\u81ea\u52a8\u521b\u5efa\u4e24\u4e2a LV\uff1a<code>lvdata_cache_cdata</code> \u548c <code>lvdata_cache_cmeta</code>\u3002 \u4f46\u662f\u66f4\u8001\u4e00\u4e9b\u7684\u6559\u7a0b\u4e2d\u4f1a\u4ecb\u7ecd\u5206\u522b\u624b\u5de5\u521b\u5efa\u7f13\u5b58\u548c\u5143\u6570\u636e LV \u7684\u5185\u5bb9\u3002\u8ba9\u6211\u4eec\u5148\u628a\u8fd9\u4e2a\u518d\u62c6\u6389\uff08uncache\uff09\uff0c\u7136\u540e\u624b\u5de5\u505a\u8fd9\u4e2a\u8fc7\u7a0b\u3002</p> <p>\u6839\u636e RHEL 6 \u7684\u6587\u6863\uff0c\u6570\u636e\u548c\u5143\u6570\u636e\u7684\u63a8\u8350\u5927\u5c0f\u6bd4\u4f8b\u662f 1000:1\uff08\u4f8b\u5982\u5982\u679c\u6709 2G \u7684\u7f13\u5b58\uff0c\u90a3\u4e48\u5c31\u9700\u8981 12M \u7684\u5143\u6570\u636e\uff09\u3002 \u8fd9\u91cc\u6211\u4eec\u7684 \"SSD\" \u6709 10G\uff0c\u56e0\u6b64\u5927\u7ea6\u9700\u8981 60M \u7684\u5143\u6570\u636e\uff0c\u53ef\u4ee5\u5148\u521b\u5efa\u5143\u6570\u636e LV\uff0c\u7136\u540e\u5269\u4e0b\u7684\u2014\u2014\u5168\u90e8\u7ed9\u6570\u636e\uff1f</p> <pre><code>$ sudo lvcreate -L 60M -n lvdata_cache_meta vg201-test /dev/loop1\n  Logical volume \"lvdata_cache_meta\" created.\n$ sudo lvcreate -l 100%FREE -n lvdata_cache_data vg201-test /dev/loop1\n  Logical volume \"lvdata_cache_data\" created.\n$ sudo lvconvert --type cache-pool --poolmetadata lvdata_cache_meta --cachemode writethrough vg201-test/lvdata_cache_data\n  WARNING: Converting vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta to cache pool's data and metadata volumes with metadata wiping.\n  THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.)\nDo you really want to convert vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta? [y/n]: y\n  Volume group \"vg201-test\" has insufficient free space (0 extents): 15 required.\n  Failed to set up spare metadata LV for pool.\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd8\u9700\u8981\u4e00\u4e9b\u7a7a\u95f4\uff0815 \u4e2a extent\uff09\uff0c\u56e0\u6b64\u4f7f\u7528 <code>lvreduce</code> \u7559\u70b9\u51fa\u6765\uff1a</p> <pre><code>$ sudo lvreduce -l -15 vg201-test/lvdata_cache_data\n  No file system found on /dev/vg201-test/lvdata_cache_data.\n  Size of logical volume vg201-test/lvdata_cache_data changed from &lt;9.94 GiB (2544 extents) to &lt;9.88 GiB (2529 extents).\n  Logical volume vg201-test/lvdata_cache_data successfully resized.\n$ sudo lvconvert --type cache-pool --poolmetadata lvdata_cache_meta --cachemode writethrough vg201-test/lvdata_cache_data\n  WARNING: Converting vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta to cache pool's data and metadata volumes with metadata wiping.\n  THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.)\nDo you really want to convert vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta? [y/n]: y\n  Converted vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta to cache pool.\n</code></pre> <p>\u4e4b\u540e\u5c31\u548c\u4e0a\u9762\u4e00\u81f4\u4e86\uff1a</p> <pre><code>$ sudo lvs -a\n  LV                        VG         Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata                    vg201-test -wi-a----- &lt;100.00g                                                    \n  lvdata_cache_data         vg201-test Cwi---C---   &lt;9.88g                                                    \n  [lvdata_cache_data_cdata] vg201-test Cwi-------   &lt;9.88g                                                    \n  [lvdata_cache_data_cmeta] vg201-test ewi-------   60.00m                                                    \n  [lvol0_pmspare]           vg201-test ewi-------   60.00m\n$ sudo lvconvert --type cache --cachepool lvdata_cache_data vg201-test/lvdata\nDo you want wipe existing metadata of cache pool vg201-test/lvdata_cache_data? [y/n]: y\n  Logical volume vg201-test/lvdata is now cached.\n</code></pre>"},{"location":"ops/storage/lvm/#lvmcache-scalability","title":"Does lvmcache scale?","text":"<p>\u73b0\u5b9e\u4e2d\u6211\u4eec\u80af\u5b9a\u4e0d\u53ef\u80fd\u53ea\u7528 10G \u7684 SSD \u6765\u505a\u7f13\u5b58\uff0c\u800c\u5728\u975e\u5bb6\u7528\u7684\u573a\u666f\u4e0b\uff0c\u9700\u8981\u7f13\u5b58\u7684\u540e\u5907\u5b58\u50a8\u4e5f\u4e0d\u53ef\u80fd\u53ea\u6709 100G \u8fd9\u4e48\u5927\u3002 \u4e0b\u9762\u8003\u8651\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u76ee\u524d mirrors \u7684\u573a\u666f\uff1a1.5T \u7684 SSD \u7a7a\u95f4\u5bf9 65T \u7684 HDD \u7a7a\u95f4\u8fdb\u884c\u7f13\u5b58\uff08\u6bd4\u4f8b\u5927\u7ea6 1:45\uff09\u3002</p> <p>\u628a\u5df2\u6709\u7684\u62c6\u6389\u4e4b\u540e\u91cd\u65b0\u521b\u5efa 1.5T\uff081536G\uff09\u548c 65T \u7684\u7a00\u758f\u6587\u4ef6\u4f5c\u4e3a SSD \u548c HDD\uff0c\u52a0\u5165 LVM\uff0c\u7136\u540e\u8ba9\u6211\u4eec\u8bd5\u8bd5 cachevol\u2026\u2026</p> <pre><code>$ sudo lvconvert --type cache --cachevol lvdata_cache vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  Cache data blocks 3219046400 and chunk size 128 exceed max chunks 1000000.\n  Use smaller cache, larger --chunksize or increase max chunks setting.\n</code></pre> <p>\uff08\u8fd9\u91cc\u663e\u793a\u7684\u5355\u4f4d\u662f\u6247\u533a\uff0c\u5373 512 \u5b57\u8282\uff09</p> <p>\u8fd9\u91cc cache \u9700\u8981\u8bb0\u5f55\u7f13\u5b58\u6570\u636e\u7684\u8bbf\u95ee\u60c5\u51b5\uff0c\u8bb0\u5f55\u7684\u5355\u4f4d\u5c31\u662f chunk\uff08\u9700\u8981\u662f 32K \u7684\u500d\u6570\uff09\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cchunk \u5927\u5c0f\u8bbe\u7f6e\u4e3a 64KB\u3002 \u5e76\u4e14 LVM \u63a8\u8350 chunk \u4e0d\u8d85\u8fc7\u4e00\u767e\u4e07\u4e2a\uff08\u8fd9\u4e5f\u662f allocation/cache_pool_max_chunks \u8bbe\u7f6e\u7684\u9ed8\u8ba4\u503c\uff09\u3002 \u6362\u53e5\u8bdd\u8bb2\uff0c\u5982\u679c\u4fdd\u6301\u9ed8\u8ba4\u8bbe\u7f6e\uff0c\u90a3\u4e48\u540e\u5907\u6570\u636e\u6700\u5927\u53ea\u80fd\u6709 64KB * 1,000,000 ~= 64GB &lt;&lt; 1.5T\uff0c\u8fd9\u663e\u7136\u662f\u4e0d\u591f\u7684\u3002</p> <p>\u76f4\u89c9\u6765\u8bb2\uff0c\u65e2\u7136 chunk \u63a8\u8350\u4e0d\u8d85\u8fc7\u4e00\u767e\u4e07\u4e2a\uff0c\u90a3\u5c31\u62c9\u9ad8 chunk size\uff1f\u4f46\u662f\u9700\u8981\u8003\u8651\u8fd9\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u5982\u679c\u8bbf\u95ee\u7684\u6a21\u5f0f\u4e0d\u90a3\u4e48\u8fde\u7eed\uff0c\u90a3\u4e48\u66f4\u5927\u7684 chunk size \u5c31\u52bf\u5fc5\u5bfc\u81f4\u66f4\u591a\u7684\u6570\u636e\u5728\u7f13\u5b58\u548c\u540e\u5907\u8bbe\u5907\u4e4b\u95f4\u6765\u56de\u4f20\u8f93\u3002\uff08\u547d\u4e2d\u7387\u964d\u4f4e\uff09</li> <li>SSD \u7684\u5199\u5165\u91cf\u662f\u6709\u9650\u5236\u7684\u3002\u4e0a\u9762\u4e00\u70b9\u4e2d\u63d0\u5230\u7684\u547d\u4e2d\u7387\u964d\u4f4e\u7684\u95ee\u9898\u4f1a\u5bfc\u81f4\u66f4\u591a\u7684\u5199\u5165\uff0c\u6700\u7ec8\u5bfc\u81f4 SSD \u7684\u5bff\u547d\u7f29\u77ed\u3002</li> </ol> <p>\u56e0\u6b64\u66f4\u597d\u7684\u9009\u62e9\u662f\u4ee5\uff08\u76f8\u5bf9\u66f4\u80fd\u63a5\u53d7\u7684\uff09\u4e00\u4e9b\u989d\u5916\u7684 overhead \u4e3a\u4ee3\u4ef7\uff0c\u589e\u52a0 chunk \u6570\u91cf\u3002\u5177\u4f53\u7684\u300c\u4ee3\u4ef7\u300d\u5728\u540e\u7eed\u521b\u5efa\u540e\uff0c\u53ef\u4ee5\u5728\u5185\u6838\u65e5\u5fd7\u91cc\u9762\u770b\u5230\uff1a</p> <pre><code>[2030783.641796] device-mapper: cache: You have created a cache device with a lot of individual cache blocks (12578624)\n                 All these mappings can consume a lot of kernel memory, and take some time to read/write.\n                 Please consider increasing the cache block size to reduce the overall cache block count.\n</code></pre> <p>\u8003\u8651\u5230\u5728\u670d\u52a1\u5668\u573a\u5408\uff0c\u5185\u5b58\u4e00\u822c\u90fd\u662f\u8db3\u591f\uff08\u751a\u81f3\u8fc7\u91cf\uff09\u7684\uff0c\u56e0\u6b64\u552f\u4e00\u53ef\u80fd\u9700\u8981\u8003\u8651\u7684\u5c31\u662f\u989d\u5916\u7684\u5ef6\u8fdf\u4e86\u3002</p> <p>@taoky: \u771f\u5b9e\u4e8b\u4ef6\u7684\u6559\u8bad</p> <p>\u6700\u5f00\u59cb\u7684\u65f6\u5019\uff0cmirrors \u7684 chunk size \u8bbe\u7f6e\u4e3a\u4e86 1M\uff0c\u7ed3\u679c\u8fc7\u4e86\u4e24\u5e74\u591a\u5c31\u53d1\u73b0 SSD \u5feb\u6302\u4e86\u3002 \u67e5\u770b\u7edf\u8ba1\u53d1\u73b0 SSD \u6bcf\u5c0f\u65f6\u8bfb\u53d6 0.1T\uff0c\u4f46\u662f\u5199 1T \u6570\u636e\u2026\u2026</p> <p>\u56e0\u4e3a\u7ecf\u5386\u8fc7 SSD \u88ab lvmcache \u78e8\u6ca1\u7684\u4e8b\u4ef6\uff0c\u6240\u4ee5\u6211\u4e2a\u4eba\u7684\u770b\u6cd5\u662f\uff0c \u5728 201 \u4e2d\uff0c\u63d0\u53ca\u8fd9\u4e00\u70b9\uff08\u4ee5\u53ca\u540e\u9762\u4f1a\u4ecb\u7ecd lvmcache \u8fd8\u6709\u5176\u4ed6\u7684\u5751\uff09\u662f\u5f88\u91cd\u8981\u7684\u2014\u2014\u6709\u4e9b\u65b9\u6848\u653e\u5927\u89c4\u6a21\u4e4b\u540e\uff0c\u5c31\u4f1a\u51fa\u73b0\u610f\u60f3\u4e0d\u5230\u7684\u95ee\u9898\u3002</p> <pre><code>$ sudo lvconvert --type cache --cachevol lvdata_cache --config allocation/cache_pool_max_chunks=25148800 vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  WARNING: Configured cache_pool_max_chunks value 25148800 is higher then recommended 1000000.\n  Logical volume vg201-test/lvdata is now cached.\n</code></pre> <p>64K \u4e5f\u662f\u76ee\u524d mirrors \u673a\u5668\u4f7f\u7528\u7684 chunk size\u3002</p> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u628a chunk size \u7565\u5fae\u8c03\u5927\u5230 128K\uff0c\u8fd9\u6837\u7684\u8bdd chunk \u5c31\u5c11\u4e00\u4e9b\uff1a</p> <pre><code>$ sudo lvconvert --type cache --cachevol lvdata_cache --chunksize 128K --config allocation/cache_pool_max_chunks=12578624 vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  WARNING: Configured cache_pool_max_chunks value 12578624 is higher then recommended 1000000.\n  Logical volume vg201-test/lvdata is now cached.\n</code></pre> <p>\u53ef\u80fd\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u6027\u80fd\u6d4b\u8bd5\u6765\u6743\u8861 chunk size \u5e26\u6765\u7684\u5f71\u54cd\u2014\u2014\u8003\u8651\u5230\u672c\u5730\u6d4b\u8bd5\u65f6\u7a00\u758f\u6587\u4ef6\u7b49\u56e0\u7d20\uff0c\u5b9e\u9645\u7684\u6027\u80fd\u6d4b\u8bd5\u53ef\u80fd\u9700\u8981\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u8fdb\u884c\u3002</p> <p>\u6b64\u5916\uff0c\u5728 <code>lvconvert</code> \u521b\u5efa\u7f13\u5b58\u65f6\uff0c\u5982\u679c SSD \u8bbe\u5907\u4e0d\u652f\u6301 TRIM\uff08\u5e38\u89c1\u7684\u573a\u666f\u662f\u5728 RAID \u5361\u540e\u9762\uff09\uff0c\u90a3\u4e48\u5176\u4f1a\u6e05\u96f6\u5bf9\u5e94\u7684\u5757\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u53ef\u80fd\u4f1a\u82b1\u8d39\u8d85\u8fc7\u534a\u4e2a\u5c0f\u65f6\u7684\u65f6\u95f4\u3002</p>"},{"location":"ops/storage/lvm/#lvmcache-dirty-issue","title":"Too dirty to use","text":"<p>lvmcache \u65b9\u6848\u7684\u4e00\u4e2a\u65e0\u6cd5\u5ffd\u89c6\u7684\u5f0a\u7aef\u662f\uff1a\u5373\u4f7f\u6a21\u5f0f\u8bbe\u7f6e\u4e3a writethrough\uff0c\u5982\u679c\u6ca1\u6709\u5e72\u51c0\u5730\u5378\u8f7d\uff0c\u90a3\u4e48\u5728\u4e0b\u6b21\u52a0\u8f7d\u540e\uff0c\u7f13\u5b58\u4e2d\u6240\u6709\u7684\u5757\u90fd\u4f1a\u88ab\u6807\u8bb0\u4e3a\u810f\u5757\u3002 \u66f4\u52a0\u81f4\u547d\u7684\u662f\uff0c\u5728\u751f\u4ea7\u8d1f\u8f7d\u4e0b\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u810f\u5757\u5199\u56de\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6781\u5176\u7f13\u6162\u7684\u95ee\u9898\uff08\u5373\u4f7f\u8bbe\u7f6e policy \u4e3a cleaner\uff09\uff0c\u4ee5\u81f3\u4e8e\u53ef\u80fd\u8fc7\u4e86\u51e0\u4e2a\u5c0f\u65f6\u90fd\u6ca1\u6709\u8fc1\u79fb\u4efb\u4f55\u4e00\u4e2a\u5757\u3002</p> \u5982\u4f55\u5b9e\u9a8c\u590d\u73b0\u300c\u6240\u6709\u5757\u88ab\u6807\u8bb0\u300d\u7684\u884c\u4e3a\uff1f <p>\u7531\u4e8e\u6ca1\u6709\u80fd\u591f\u5f3a\u5236\u5378\u8f7d\u672c\u5730\u56de\u73af\u7684\u65b9\u6cd5\uff0c\u56e0\u6b64\u8fd9\u91cc\u53ef\u4ee5\u8003\u8651\u7684\u601d\u8def\u662f\uff1a \u5728\u865a\u62df\u673a\u4e2d\u4f7f\u7528\u672c\u5730\u56de\u73af\u8bbe\u5907\u521b\u5efa lvmcache\uff0c\u5199\u5165\u5e76\u8bfb\u53d6\u4e00\u4e9b\u6570\u636e\uff08\u5355\u7eaf\u7684\u5199\u5165\u4e00\u6b21\u53ef\u80fd\u4e0d\u4f1a\u4f7f\u7528\u7f13\u5b58\u5757\u7a7a\u95f4\uff09\uff0c\u7136\u540e\u4f7f\u7528 <code>reboot -f</code> \u5f3a\u5236\u91cd\u542f\u3002</p> <p>\u5982\u679c\u4f7f\u7528\u7684\u5757\u591f\u591a\uff0c\u5e76\u4e14\u64cd\u4f5c\u53ca\u65f6\uff0c\u53ef\u80fd\u5c31\u80fd\u770b\u5230 dirty block &gt; 0 \u7684\u60c5\u51b5\uff1a</p> <pre><code>$ sudo losetup -f --show hdd.img\n/dev/loop0\n$ sudo losetup -f --show ssd.img\n/dev/loop1\n$ sudo lvs -a -o devices,cache_policy,cachemode,cache_settings,cache_total_blocks,cache_used_blocks,cache_dirty_blocks,cache_read_hits,cache_read_misses,cache_write_hits,cache_write_misses\n  Devices         CachePolicy CacheMode    CacheSettings CacheTotalBlocks CacheUsedBlocks  CacheDirtyBlocks CacheReadHits    CacheReadMisses  CacheWriteHits   CacheWriteMisses\n  lvdata_corig(0) smq         writethrough                         163584            62544             4918              120                0                0                0\n  /dev/loop1(0)                                                                                                                                                                \n  /dev/loop0(0)\n</code></pre> <p>\u53e6\u5916\u5728\u672c\u5730\u6d4b\u8bd5\u65f6\u53d1\u73b0\uff0c\u5982\u679c\u521b\u5efa cache \u4e4b\u540e\u8fc7\u77ed\u6682\u7684\u65f6\u95f4\u540e\u91cd\u542f\uff0cLVM \u8c03\u7528\u7684\u65e7\u7248\u672c\u7684 cache \u68c0\u67e5\u5de5\u5177\u53ef\u80fd\u4f1a\u8ba4\u4e3a cache LV \u7684\u7ed3\u6784\u4e0d\u6b63\u786e\uff0c \u6b64\u65f6 LVM \u65e0\u6cd5\u6302\u8f7d<sup>4</sup> cache\uff0c\u53ea\u80fd\u7528\u4e00\u4e9b trick \u6765 uncache \u6389\u8fd9\u4e2a\u574f\u6389\u7684 LV \uff08cachevol \u53ef\u80fd\u4f1a\u9ebb\u70e6\u4e00\u4e9b\uff0c\u9700\u8981\u5148\u4f7f\u7528 <code>dmsetup remove</code> \u79fb\u9664\u591a\u4f59\u7684\u5377\uff1bcachepool \u53ef\u4ee5\u76f4\u63a5 uncache\uff09\u3002 \u6216\u8005\u5c06 thin-provisioning-tools \u5347\u7ea7\u81f3 1.0.12 \u4ee5\u4e0a\u3002</p> <p>\u6765\u81ea linux-lvm \u90ae\u4ef6\u5217\u8868\u7684\u53ef\u80fd\u76f8\u5173\u7684\u6545\u969c\u62a5\u544a\u53c2\u89c1 https://lore.kernel.org/all/b9e10482-e508-63fa-5518-94cccc007e81@redhat.com/T/\u3002</p> <p>\u6700\u65b0\u7684\u5185\u6838\u53ef\u80fd\u90e8\u5206\u4fee\u590d\u4e86\u540e\u4e00\u4e2a\u95ee\u9898</p> <p>\u53c2\u89c1 https://github.com/torvalds/linux/commit/1e4ab7b4c881cf26c1c72b3f56519e03475486fb\u3002 \u6839\u636e\u8be5 commit \u7684\u63cf\u8ff0\uff0c\u5728 cleaner \u72b6\u6001\u4e0b\u5373\u4f7f IO idle \u4e3a false\uff0c\u4e5f\u4f1a\u8fdb\u884c\u810f\u5757\u8fc1\u79fb\u3002</p> <p>lvmcache \u7684\u8bbe\u8ba1</p> <p>\u4ece\u524d\u9762\u7684\u7edf\u8ba1\u6570\u636e\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u810f\u5757\u7684\u6570\u91cf\u662f\u4e00\u4e2a\u6307\u6807\u3002\u5728 lvmcache \u7684\u8bbe\u8ba1\u4e2d\uff0c\u5b58\u5728\u51fa\u73b0\u6a21\u5f0f\u4e3a writethrough \u5e76\u4e14\u5b58\u5728\u810f\u5757\u7684\u53ef\u80fd\uff0c\u6240\u4ee5\u76ee\u524d\u7a0b\u5e8f\u4e0a\u6ca1\u6709\u5b9e\u73b0\u770b\u5230 writethrough \u4e4b\u540e \u5c31\u5ffd\u7565\u810f\u5757\u7684\u95ee\u9898\u3002</p> \u6a21\u62df\u5728 IO \u538b\u529b\u4e0b\u8fc1\u79fb\u7f13\u6162\u7684\u60c5\u51b5 <p>\u683c\u5f0f\u5316\u6211\u4eec\u521a\u624d\u521b\u5efa\u7684\u6709 cache \u7684 LV\uff0c\u4f7f\u7528 <code>fio</code> \u4e0a\u70b9\u538b\u529b\uff1a</p> <pre><code>$ sudo fio --filename=./test --filesize=2G --direct=1 --rw=randrw --bs=4k --ioengine=libaio --iodepth=256 --runtime=120 --numjobs=4 --time_based --group_reporting --name=job_name --eta-newline=1\n</code></pre> <p>\u540c\u65f6\u505a\u5207\u6362 cachemode \u7684\u64cd\u4f5c\uff1a</p> <pre><code>$ sudo lvchange --cachemode writeback vg201-test/lvdata\n  WARNING: repairing a damaged cachevol is not yet possible.\n  WARNING: cache mode writethrough is suggested for safe operation.\nContinue using writeback without repair?y\n  Logical volume vg201-test/lvdata changed.\n$ sudo lvchange --cachemode writethrough vg201-test/lvdata\n  Flushing 16401 blocks for cache vg201-test/lvdata.\n  Flushing 16405 blocks for cache vg201-test/lvdata.\n  Flushing 12309 blocks for cache vg201-test/lvdata.\n  Flushing 8213 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 2411 blocks for cache vg201-test/lvdata.\n  Logical volume vg201-test/lvdata changed.\n</code></pre> <p>\u53ef\u4ee5\u6ce8\u610f\u5230\u5361\u5728\u4e86 <code>Flushing 6481 blocks</code> \u6bd4\u8f83\u957f\u7684\u65f6\u95f4\u3002\u6d4b\u8bd5\u73af\u5883\u4e3a\u7b14\u8bb0\u672c\u7535\u8111\u7684 NVMe SSD\uff0c\u5982\u679c\u662f\u5b9e\u9645\u7684 HDD + \u8f83\u5927\u8d1f\u8f7d\u7684\u8bdd\uff0c\u95ee\u9898\u4f1a\u4e25\u91cd\u5f97\u591a\u3002</p> <p>@taoky: \u5176\u4ed6\u4fe1\u606f</p> <p>\u8fd9\u53ef\u80fd\u662f\u5bf9\u4e8e\u8f83\u5927\u7f13\u5b58\u3001\u8f83\u91cd\u7684\u8d1f\u8f7d\u4e0b lvmcache \u6700\u5927\u7684\u95ee\u9898\u4e86\u3002 \u5173\u4e8e\u4e0b\u9762\u5904\u7406\u4e0d\u65b9\u4fbf\u7684\u95ee\u9898\uff0c\u6211\u5728 lvm2 \u4ed3\u5e93\u63d0\u4ea4\u4e86 issue: https://github.com/lvmteam/lvm2/issues/141\uff0c \u5e0c\u671b\u80fd\u591f\u5728 lvm \u5de5\u5177\u4e2d\u5b9e\u73b0\u7ed5\u8fc7 flush dirty block \u7684\u64cd\u4f5c\u3002</p> <p>\u4e0d\u8fc7\u6700\u4f73\u7684\u89e3\u51b3\u65b9\u6cd5\u53ef\u80fd\u8fd8\u662f\u7ed9 kernel \u4ea4\u4e2a patch\uff0c\u5982\u679c\u76ee\u524d\u72b6\u6001\u662f writethrough \u5e76\u4e14 dirty = 0 \u90a3\u4e48\u7ed9\u67d0\u4e2a struct \u8bbe\u4e00\u4e2a\u7279\u6b8a\u7684 bit\u3002\u4f46\u662f\u611f\u89c9\u4e0d\u77e5\u9053\u5982\u4f55\u4e0b\u624b\uff0c\u53ea\u80fd\u4ee5\u540e\u518d\u8bf4\u4e86\u3002</p> <p>\u6839\u636e\u6587\u6863\uff0c<code>migration_threshold</code> \u53c2\u6570\u63a7\u5236\u6bcf\u6b21\u8fc1\u79fb\u810f\u5757\u7684\u6247\u533a\u6570\u91cf\u3002\u76f8\u5173\u7684 bug report \u5efa\u8bae\u5c06\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a chunk size \u7684\u81f3\u5c11 8 \u500d\uff08\u9ed8\u8ba4\u4e3a 2048\uff0c\u5bf9\u5e94 1M\uff09\u3002 \u5728\u8c03\u8bd5\u95ee\u9898\u65f6\u53d1\u73b0\uff0c\u4fee\u6539\u8fd9\u4e2a\u503c\u53ef\u4ee5\u5b9e\u73b0\u5f3a\u5236\u8fc1\u79fb\uff08\u4f46\u662f\u8fc1\u79fb\u65f6\u6240\u6709\u76f8\u5173\u7684 IO \u64cd\u4f5c\u90fd\u4f1a\u6682\u505c\uff09\uff0c\u811a\u672c\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <pre><code># dirty hack\nsudo lvchange --cachepolicy cleaner lug/repo\nfor i in `seq 1 1500`; do sudo lvchange --cachesettings migration_threshold=2113536 lug/repo &amp;&amp; sudo lvchange --cachesettings migration_threshold=16384 lug/repo &amp;&amp; echo $i &amp;&amp; sleep 15; done;\n# \u9700\u8981\u786e\u8ba4\u6ca1\u6709\u810f\u5757\u3002\u5982\u679c\u8fd8\u6709\u7684\u8bdd\u7ee7\u7eed\u6267\u884c\uff08\u6b21\u6570\u8c03\u5c0f\u4e00\u4e9b\uff09\n# \u5982\u679c\u662f\u4ece writeback \u5207\u6362\uff0c\u9700\u8981\u5148\u628a\u6a21\u5f0f\u5207\u5230 writethrough\n# \u7136\u540e\u518d\u4fee\u6539 cachepolicy \u5230 smq\nsudo lvchange --cachepolicy smq lug/repo\n</code></pre> <p>\u5728\u6211\u4eec\u7684\u914d\u7f6e\u4e0b\uff0c\u5199\u5168\u90e8\u810f\u5757\u64cd\u4f5c\uff08\u5305\u62ec\u4e2d\u95f4\u7684 <code>sleep</code> \u64cd\u4f5c\u5728\u5185\uff09\u9700\u8981\u5927\u7ea6 10 \u4e2a\u5c0f\u65f6\u3002</p> <p>GRUB \u53ef\u80fd\u65e0\u6cd5\u5904\u7406\u81ea\u5b9a\u4e49\u7684 migration_threshold \u7b49\u5c5e\u6027</p> <p>\u53c2\u8003 patch: https://github.com/taoky/grub/commit/484b718831ab3ca034bb5ea3624a85efeb5bf2ba\u3002</p> <p>\u76f8\u5173\u7684\u5907\u6ce8\u4fe1\u606f\uff1ahttps://blog.taoky.moe/attachments/2021-04-17-tunight/show.html#21\u3002</p> <p>\u867d\u7136\u8fd9\u4e2a patch \u4e5f\u6709\u95ee\u9898\uff0c\u5e76\u4e14 GRUB \u7684\u5f00\u53d1\u975e\u5e38\u4e0d\u6d3b\u8dc3\uff0c\u6240\u4ee5\u53ef\u80fd\u4e00\u76f4\u90fd\u8981\u81ea\u5df1\u7f16\u8bd1 GRUB \u4e86\u3002</p> <p>\u6211\u4eec\u76ee\u524d\u7684\u5efa\u8bae\u662f\u5728\u8ba1\u5212\u91cd\u542f\uff08\u7ef4\u62a4\u7a97\u53e3\uff09\u524d\u624b\u52a8\u5378\u8f7d\u7f13\u5b58\uff0c\u5728\u91cd\u542f\u540e\u518d\u6302\u8f7d\uff08\u4e4b\u524d\u7ef4\u62a4\u65f6\u89c2\u5bdf\u5230\uff0c\u5373\u4f7f\u6b63\u5e38\u5173\u673a\uff0c\u4e5f\u53ef\u80fd\u51fa\u73b0\u810f\u5757\u7684\u95ee\u9898\uff09\u3002 \u53e6\u4e00\u79cd\u65b9\u5f0f\u662f\uff1a\uff08\u5728\u786e\u8ba4\u6ca1\u6709\u4e8b\u5b9e\u4e0a\u7684\u810f\u5757\u7684\u524d\u63d0\u4e0b\uff09\u624b\u52a8\u4fee\u6539 LVM \u5143\u6570\u636e\uff0c\u628a\u7f13\u5b58\u6254\u6389\u3002</p> <p>\u5c0f\u5fc3\u64cd\u4f5c</p> <p>\u5bf9\u6bcf\u6b21 LVM \u64cd\u4f5c\uff0clvm \u7684\u5de5\u5177\u90fd\u4f1a\u5728 <code>/etc/lvm/archive</code> \u5907\u4efd\u64cd\u4f5c\u524d\u7684\u5143\u6570\u636e\u4fe1\u606f\uff0c\u540c\u65f6\u5728 <code>/etc/lvm/backup</code> \u5b58\u50a8\u5f53\u524d\u7684\u5143\u6570\u636e\uff0c\u4f46\u662f\u8fd8\u662f\u5c3d\u91cf\u5c0f\u5fc3\uff0c\u4ee5\u514d\u917f\u6210\u60b2\u5267\u3002</p> \u6709 cache \u7684 VG \u5143\u6570\u636e\u4f8b\u5b50 <pre><code># Generated by LVM2 version 2.03.23(2) (2023-11-21): Sun Feb 18 00:25:36 2024\n\ncontents = \"Text Format Volume Group\"\nversion = 1\n\ndescription = \"Created *after* executing 'lvconvert --type cache --cachevol lvdata_cache --config allocation/cache_pool_max_chunks=25148800 vg201-test/lvdata'\"\n\ncreation_host = \"shimarin.taoky.moe\"    # Linux shimarin.taoky.moe 6.6.10-arch1-1 #1 SMP PREEMPT_DYNAMIC Fri, 05 Jan 2024 16:20:41 +0000 x86_64\ncreation_time = 1708187136  # Sun Feb 18 00:25:36 2024\n\nvg201-test {\n    id = \"kDKbJ2-kebs-HaIJ-4Vfj-E4OB-aCce-yEcdAy\"\n    seqno = 34\n    format = \"lvm2\"         # informational\n    status = [\"RESIZEABLE\", \"READ\", \"WRITE\"]\n    flags = []\n    extent_size = 8192      # 4 Megabytes\n    max_lv = 0\n    max_pv = 0\n    metadata_copies = 0\n\n    physical_volumes {\n\n        pv0 {\n            id = \"VfZ83M-BPwe-bIQ1-JJRO-ZBSf-ks8d-fMln8E\"\n            device = \"/dev/loop0\"   # Hint only\n\n            status = [\"ALLOCATABLE\"]\n            flags = []\n            dev_size = 139586437120 # 65 Terabytes\n            pe_start = 2048\n            pe_count = 17039359 # 65 Terabytes\n        }\n\n        pv1 {\n            id = \"8hZXeS-gZJX-OfrY-vfUm-tG1R-pw3V-6c3CBI\"\n            device = \"/dev/loop1\"   # Hint only\n\n            status = [\"ALLOCATABLE\"]\n            flags = []\n            dev_size = 3221225472   # 1.5 Terabytes\n            pe_start = 2048\n            pe_count = 393215   # 1.5 Terabytes\n        }\n    }\n\n    logical_volumes {\n\n        lvdata {\n            id = \"6BsYbX-T21Z-BgiW-pZET-a3Lf-wcSh-E5hSm2\"\n            status = [\"READ\", \"WRITE\", \"VISIBLE\"]\n            flags = []\n            creation_time = 1708181300  # 2024-02-17 22:48:20 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 17039359 # 65 Terabytes\n\n                type = \"cache+CACHE_USES_CACHEVOL\"\n                cache_pool = \"lvdata_cache_cvol\"\n                origin = \"lvdata_corig\"\n                metadata_format = 2\n                chunk_size = 128\n                cache_mode = \"writethrough\"\n                policy = \"smq\"\n                metadata_start = 0\n                metadata_len = 2170880\n                data_start = 2170880\n                data_len = 3219046400\n            }\n        }\n\n        lvdata_cache_cvol {\n            id = \"RuL2He-0xlL-J4fd-T0eD-2YTr-QASe-gsWtBV\"\n            status = [\"READ\", \"WRITE\"]\n            flags = [\"CACHE_VOL\"]\n            creation_time = 1708187133  # 2024-02-18 00:25:33 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 393215   # 1.5 Terabytes\n\n                type = \"striped\"\n                stripe_count = 1    # linear\n\n                stripes = [\n                    \"pv1\", 0\n                ]\n            }\n        }\n\n        lvdata_corig {\n            id = \"xIprwR-KD4I-f6E8-tdgp-lcjN-iUdk-rS63YR\"\n            status = [\"READ\", \"WRITE\"]\n            flags = []\n            creation_time = 1708187136  # 2024-02-18 00:25:36 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 17039359 # 65 Terabytes\n\n                type = \"striped\"\n                stripe_count = 1    # linear\n\n                stripes = [\n                    \"pv0\", 0\n                ]\n            }\n        }\n    }\n\n}\n</code></pre> \u6ca1\u6709 cache \u7684 VG \u5143\u6570\u636e\u4f8b\u5b50 <p>\u4ee5\u4e0b\u4ec5\u5c55\u793a <code>logical_volumes</code> \u90e8\u5206\uff1a</p> <pre><code># \uff08\u7701\u7565\uff09\n\nvg201-test {\n    # \uff08\u7701\u7565\uff09\n\n    logical_volumes {\n\n        lvdata {\n            id = \"6BsYbX-T21Z-BgiW-pZET-a3Lf-wcSh-E5hSm2\"\n            status = [\"READ\", \"WRITE\", \"VISIBLE\"]\n            flags = []\n            creation_time = 1708181300  # 2024-02-17 22:48:20 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 17039359 # 65 Terabytes\n\n                type = \"striped\"\n                stripe_count = 1    # linear\n\n                stripes = [\n                    \"pv0\", 0\n                ]\n            }\n        }\n\n        lvdata_cache {\n            id = \"RuL2He-0xlL-J4fd-T0eD-2YTr-QASe-gsWtBV\"\n            status = [\"READ\", \"WRITE\", \"VISIBLE\"]\n            flags = []\n            creation_time = 1708187133  # 2024-02-18 00:25:33 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 393215   # 1.5 Terabytes\n\n                type = \"striped\"\n                stripe_count = 1    # linear\n\n                stripes = [\n                    \"pv1\", 0\n                ]\n            }\n        }\n    }\n\n}\n</code></pre> <p>\u9996\u5148\u5bf9\u6bd4 archive \u548c backup \u4e2d\u7684\u5143\u6570\u636e\uff0c\u786e\u8ba4\u65e0\u8bef\u4e4b\u540e\u4f7f\u7528 <code>vgcfgrestore</code> \u6062\u590d\u5143\u6570\u636e\u3002 \u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u9700\u8981\u7f16\u8f91\u5143\u6570\u636e\u6587\u4ef6\u4ee5\u7b26\u5408\u5b9e\u9645\u60c5\u51b5\uff08\u4f8b\u5982\u5728\u521b\u5efa\u7f13\u5b58\u4e4b\u540e\u53c8\u505a\u4e86\u5176\u4ed6\u64cd\u4f5c\uff09\u3002</p> <pre><code>$ sudo vgcfgrestore -f /etc/lvm/archive/vg201-test_00084-792872325.vg vg201-test\n  Volume group vg201-test has active volume: lvdata.\n  Volume group vg201-test has active volume: lvdata_cache_cvol.\n  Volume group vg201-test has active volume: lvdata_cache_cvol.\n  Volume group vg201-test has active volume: lvdata_cache_cvol.\n  Volume group vg201-test has active volume: lvdata_corig.\n  WARNING: Found 5 active volume(s) in volume group \"vg201-test\".\n  Restoring VG with active LVs, may cause mismatch with its metadata.\nDo you really want to proceed with restore of volume group \"vg201-test\", while 5 volume(s) are active? [y/n]: y\n  Restored volume group vg201-test.\n$ sudo lvs -a\n  WARNING: Detected cache segment type does not match expected type striped for vg201-test/lvdata.\n  LV           VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata       vg201-test -wi-XX--X- &lt;65.00t                                                    \n  lvdata_cache vg201-test -wi-a-----  &lt;1.50t\n</code></pre> <p>\u5728\u91cd\u65b0 activate \u4e4b\u540e\uff0c\u72b6\u6001\u5373\u6062\u590d\u6b63\u5e38\uff1a</p> <pre><code>$ sudo vgchange -an vg201-test\n  0 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo vgchange -ay vg201-test\n  2 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo lvs -a\n  LV           VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata       vg201-test -wi-a----- &lt;65.00t                                                    \n  lvdata_cache vg201-test -wi-a-----  &lt;1.50t\n</code></pre>"},{"location":"ops/storage/lvm/#ssdcache-comparison","title":"\u7f13\u5b58\u65b9\u6848\u6bd4\u8f83","text":"<p>\u4f5c\u4e3a SSD \u7f13\u5b58\u90e8\u5206\u7684\u6700\u540e\u4e00\u5c0f\u8282\uff0c\u672c\u90e8\u5206\u4ee5\u8868\u683c\u5f62\u5f0f\u4ecb\u7ecd\u5df2\u6709\u7684 SSD \u7f13\u5b58\u65b9\u6848\uff08\u5305\u62ec\u5df2\u7ecf\u4e0d\u518d\u7ef4\u62a4\u7684\uff09\u3002 \u6211\u4eec\u5efa\u8bae\u65e0\u8bba\u9009\u62e9\u4f55\u79cd\u65b9\u6848\uff0c\u90fd\u9700\u8981\u5148\u6d4b\u8bd5\u5176\u662f\u5426\u6613\u4e8e\u4f7f\u7528\uff0c\u662f\u5426\u4f1a\u7ed9\u8fd0\u7ef4\u64cd\u4f5c\u5e26\u6765\u989d\u5916\u7684\u8d1f\u62c5\u3002</p> \u65b9\u6848 \u7f13\u5b58\u6a21\u5f0f \u7f13\u5b58\u7b97\u6cd5 \u7b80\u4ecb \u4e0a\u6b21\u7ef4\u62a4\u65f6\u95f4<sup>2</sup> lvmcache writethrough, writeback smq \u4e0e LVM \u96c6\u6210\u7684\u7f13\u5b58\u65b9\u6848\uff0c\u57fa\u4e8e\u5185\u6838\u7684 dm-cache 7 \u4e2a\u6708\u524d bcache writethrough, writeback, writearound lru, fifo, random \u5df2\u5728\u5185\u6838\u4e2d\u7684\u7a33\u5b9a cache \u65b9\u6848 2 \u4e2a\u6708\u524d ZFS ARC + L2ARC \u7c7b\u4f3c writearound ARC ZFS \u81ea\u5e26\u7684\u7f13\u5b58\u3002ARC \u4ee5\u5185\u5b58\u4e3a\u7f13\u5b58\uff1bL2ARC \u4f5c\u4e3a\u7b2c\u4e8c\u7ea7\u7f13\u5b58\uff0c\u4f7f\u7528 SSD\uff0c\u7528\u4e8e\u5728\u9ad8\u8d1f\u8f7d\u60c5\u51b5\u4e0b\u652f\u6491 IOPS\uff0c\u547d\u4e2d\u7387\u8f83\u4f4e \u968f ZFS \u5f00\u53d1 EnhanceIO readonly (writearound), writethrough, writeback lru, fifo, random \u65e9\u671f\u7684 SSD \u7f13\u5b58\u65b9\u6848 \u2620\ufe0f 9 \u5e74\u524d Flashcache writethrough, writeback, writearound fifo, lru Facebook \u5f00\u53d1\u7684\u65e9\u671f SSD \u7f13\u5b58\u65b9\u6848 \u2620\ufe0f 7 \u5e74\u524d OpenCAS writethrough, writeback, writearound, write-invalidate, write-only lru (?) SPDK \u7684\u4e00\u90e8\u5206 3 \u4e2a\u6708\u524d bcachefs writethrough, writeback, writearound lru<sup>3</sup> \u7531 bcache \u4f5c\u8005\u5f00\u53d1\u7684\u65b0 CoW \u6587\u4ef6\u7cfb\u7edf\uff0c\u5185\u7f6e SSD \u7f13\u5b58\u652f\u6301 \u6d3b\u8dc3\u5f00\u53d1"},{"location":"ops/storage/lvm/#lvm-cluster","title":"\u96c6\u7fa4\u5b58\u50a8","text":"<p>LVM \u652f\u6301\u591a\u673a\u5171\u4eab\u5b58\u50a8\u3002\u5728\u8fd9\u79cd\u573a\u666f\u4e0b\uff0c\u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u5668\u901a\u8fc7 iSCSI \u7b49\u65b9\u5f0f\u8fde\u63a5\u5230\u540c\u4e00\u53f0\u5171\u4eab\u7684\u5b58\u50a8\uff0c\u5e76\u4e14\u901a\u8fc7\u9501\u7b49\u673a\u5236\u5b9e\u73b0\u96c6\u7fa4\u5185\u90e8\u7684\u540c\u6b65\u3002 LVM \u81ea\u5e26\u7684 locking \u673a\u5236\u4e3a <code>lvmlockd</code>\uff0c\u652f\u6301 <code>dlm</code>\uff08\u9700\u8981\u914d\u7f6e dlm \u4e0e corosync \u6784\u5efa\u96c6\u7fa4\uff09\u548c <code>sanlock</code> \u4e24\u79cd\u540e\u7aef\u3002</p> <p>\u4e0d\u8fc7\u5f88\u53ef\u60dc\u7684\u662f\uff0c\u6211\u4eec\u552f\u4e00\u4f7f\u7528\u5230\u96c6\u7fa4\u5b58\u50a8\u7684\u5730\u65b9\u662f Proxmox VE \u865a\u62df\u673a\uff0c\u800c PVE \u4f7f\u7528\u7684\u662f\u53e6\u4e00\u5957\u65b9\u6848\uff1a PVE \u81ea\u5e26\u7684\u96c6\u7fa4\u7ba1\u7406\u529f\u80fd\u4f7f\u7528\u4e86 <code>corosync</code> \u7ef4\u62a4\u4e86\u4e00\u4e2a\u96c6\u7fa4\u5185\u90e8\u7684\u5168\u5c40\u9501\uff0c\u6240\u6709\u4f7f\u7528 PVE \u5de5\u5177\u4fee\u6539\u5b58\u50a8\u7684\u64cd\u4f5c\u90fd\u4f1a\u5148\u83b7\u53d6\u8fd9\u4e2a\u5168\u5c40\u9501\u3002 \u5e76\u4e14 PVE \u4e0d\u5b58\u5728\u591a\u53f0\u673a\u5668\u8bbf\u95ee\u540c\u4e00\u4e2a LV \u7684\u60c5\u51b5\uff0c\u56e0\u6b64\u8fd9\u4e00\u5957\u65b9\u6848\u4e0d\u4f9d\u8d56\u4e8e <code>lvmlockd</code>\u3002</p> <p>\u786e\u4fdd\u6240\u6709\u8bbf\u95ee LVM \u7684\u673a\u5668\u5728\u540c\u4e00\u4e2a PVE \u96c6\u7fa4\u4e2d</p> <p>\u5426\u5219\u5728\u96c6\u7fa4\u5916\u7684\u865a\u62df\u673a\u521b\u5efa\u7b49\u64cd\u4f5c\u4e0d\u4f1a\u6b63\u786e\u83b7\u53d6\u9501\uff0c\u5bfc\u81f4\u8986\u76d6\u5df2\u6709\u7684\u865a\u62df\u673a\u78c1\u76d8\u3002 \u76f8\u5173\u6545\u969c\u6848\u4f8b\u89c1 https://vlab.ibugone.com/servers/ct100/#%E6%95%85%E9%9A%9C\u3002</p> <p>LVM \u96c6\u7fa4\u4e0d\u652f\u6301\u7cbe\u7b80\u7f6e\u5907 LV</p> <p>\u5728\u865a\u62df\u5316\u573a\u666f\u4e0b\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u8282\u7701\u7a7a\u95f4\u7684\u505a\u6cd5\u662f\u4f7f\u7528\u7cbe\u7b80\u7f6e\u5907\uff08thin-provisioned\uff09\u7684\u5b58\u50a8\uff0c \u8fd9\u4e48\u505a\u53ef\u4ee5\u5728\u521b\u5efa LV \u65f6\u53ea\u5206\u914d\u5c11\u91cf\u7684\u7a7a\u95f4\uff0c\u7136\u540e\u5728\u9700\u8981\u7684\u65f6\u5019\u518d\u5206\u914d\u66f4\u591a\u7684\u7a7a\u95f4\u3002 \u4f46\u662f LVM \u96c6\u7fa4\u4e0d\u652f\u6301\u8fd9\u79cd\u64cd\u4f5c\uff08\u56e0\u6b64\u6bcf\u4e2a\u865a\u62df\u673a\u90fd\u8981\u5b9e\u6253\u5b9e\u5730\u5360\u7528\u5bf9\u5e94\u7684\u7a7a\u95f4\uff09\u3002 \u5982\u679c\u9700\u8981\u8282\u7ea6\u7a7a\u95f4\uff0c\u53ef\u80fd\u9700\u8981\u8003\u8651\u5176\u4ed6\u65b9\u6848\uff08\u4f8b\u5982\u90e8\u5206\u4f01\u4e1a\u7ea7 SAN \u652f\u6301\u7c7b\u4f3c\u4e8e\u300c\u865a\u62df\u5730\u5740\u300d\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5728\u9700\u8981\u7684\u65f6\u5019\u518d\u5206\u914d\u7a7a\u95f4\uff09\u3002</p> <ol> <li> <p>\u63a8\u8350\u67e5\u770b\u6700\u65b0\u7248\u672c\u7684 RHEL \u624b\u518c\u8fdb\u884c\u9605\u8bfb\uff0c\u56e0\u4e3a\u65b0\u7248\u672c\u53ef\u80fd\u5305\u542b\u4e00\u4e9b\u65b0\u7279\u6027\uff0c\u5e76\u4e14 Debian \u7684\u7248\u672c\u66f4\u65b0\u6bd4 RHEL \u66f4\u5feb\u3002\u672c\u94fe\u63a5\u6307\u5411\u76ee\u524d\u6700\u65b0\u7684 RHEL 9 \u7684 LVM \u624b\u518c\u3002\u00a0\u21a9</p> </li> <li> <p>Retrieved on 2024-02-18.\u00a0\u21a9</p> </li> <li> <p>\"Buckets containing only cached data are discarded as needed by the allocator in LRU order\" (bcachefs: Principles of Operation 2.2.4)\u00a0\u21a9</p> </li> <li> <p>Cache \u7684\u5b8c\u6574\u6027\u68c0\u67e5\u5de5\u5177 <code>cache_check</code> \u4f4d\u4e8e thin-provisioning-tools \u4e2d\u3002\u5176 1.0 \u7248\u672c\u4f7f\u7528 Rust \u91cd\u5199\u540e\u5b58\u5728\u4e00\u4e2a bug\uff0c\u4f1a\u5bfc\u81f4\u5373\u4f7f\u68c0\u67e5\u5931\u8d25\uff0cLVM \u4e5f\u4f1a\u7ee7\u7eed\u5c1d\u8bd5\u6302\u8f7d\u3002\u8be5\u95ee\u9898\u5728 1.0.12 \u88ab\u4fee\u590d\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/network/","title":"\u7f51\u7edc\u5b58\u50a8\u7cfb\u7edf","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>\u672c\u6587\u4ecb\u7ecd\u5728\u670d\u52a1\u5668\u4e0a\u5e38\u89c1\u7684\u7f51\u7edc\u5b58\u50a8\u65b9\u6848\uff0c\u5305\u62ec NFS \u4e0e iSCSI\u3002</p>"},{"location":"ops/storage/network/#nfs","title":"NFS","text":"<p>NFS \u662f\u975e\u5e38\u5e38\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u7ea7\u522b\u7684\u7f51\u7edc\u5b58\u50a8\u534f\u8bae\uff0c\u5141\u8bb8\u670d\u52a1\u5668\u66b4\u9732\u6587\u4ef6\u7cfb\u7edf\u7ed9\u591a\u4e2a\u5ba2\u6237\u7aef\u3002 \u76ee\u524d NFS \u6709\u4e24\u4e2a\u4e3b\u8981\u7684\u7248\u672c\uff1aNFSv3 \u548c NFSv4\u3002\u7b80\u5355\u6765\u8bb2\uff1a</p> <ul> <li>NFSv3\uff081995 \u5e74\uff09\u662f\u65e0\u72b6\u6001\u534f\u8bae\uff0c\u652f\u6301 TCP \u4e0e UDP\uff082049\uff0c111 \u4ee5\u53ca\u5176\u4ed6\u52a8\u6001\u7aef\u53e3\uff09</li> <li>NFSv4\uff082000 \u5e74\uff09\u662f\u6709\u72b6\u6001\u534f\u8bae\uff0c\u53ea\u652f\u6301 TCP\uff082049 \u7aef\u53e3\uff09\uff0c\u6027\u80fd\u66f4\u597d</li> </ul> <p>NFS \u9ed8\u8ba4\u6ca1\u6709\u57fa\u4e8e\u5bc6\u7801\u7b49\u7684\u9274\u6743\u673a\u5236\uff0c\u4ec5\u4f9d\u9760\u5ba2\u6237\u7aef IP \u5730\u5740\u6765\u9274\u6743\u3002\u5e76\u4e14\u9ed8\u8ba4\u6ca1\u6709\u52a0\u5bc6\uff0c\u56e0\u6b64\u4e3b\u8981\u7528\u4e8e\u5185\u90e8\u7f51\u7edc\u5171\u4eab\u5b58\u50a8\u3002 \u4ee5\u4e0b\u4e0d\u6d89\u53ca\u6709\u5173\u9ad8\u7ea7\u9274\u6743\u65b9\u6cd5\uff08\u5982 Kerberos\uff09\u4e0e TLS \u52a0\u5bc6\u7684\u5185\u5bb9\u3002</p> <p>NFS \u5728 Linux \u4e0a\u7684\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u5b9e\u73b0\u5747\u6709\u5185\u6838\u6001\u4e0e\u7528\u6237\u6001\u7684\u9009\u62e9\uff0c\u5982\u679c\u6ca1\u6709\u7279\u6b8a\u8003\u8651\uff0c\u5efa\u8bae\u4f7f\u7528\u5185\u6838\u6001\u5b9e\u73b0\u3002</p>"},{"location":"ops/storage/network/#nfs-server","title":"\u670d\u52a1\u7aef\u914d\u7f6e","text":"<p>\u670d\u52a1\u7aef\u9700\u8981\u5b89\u88c5 <code>nfs-kernel-server</code> \u5305\u3002\u9664\u6b64\u4e4b\u5916\uff0cNFSv3 \u652f\u6301\u8fd8\u9700\u8981\u5b89\u88c5 <code>rpcbind</code> \u5305\uff08\u5bf9\u5e94 NFSv3 \u534f\u8bae\u7684 111 \u7aef\u53e3\uff09\uff0c\u8be5\u5305\u5728\u76ee\u524d\u7684 Debian \u4e2d\u4ee5 <code>rpcbind.socket</code> \u7684\u5f62\u5f0f\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002</p> <p>NFS \u7684\u5bfc\u51fa\u914d\u7f6e\u4f4d\u4e8e <code>/etc/exports</code> \u6587\u4ef6\u4e2d\u3002\u4f8b\u5982\u4ee5\u4e0b\u7684\u914d\u7f6e\uff1a</p> <pre><code>/srv/abcde        localhost(ro,no_root_squash,async,insecure,no_subtree_check)\n</code></pre> <p>\u5c06 <code>/srv/abcde</code> \u76ee\u5f55\u300c\u5bfc\u51fa\u300d\u7ed9\u4e86\u672c\u673a\uff08localhost\uff09\uff0c\u5e76\u4e14\u8bbe\u7f6e\u4e86\u8bf8\u5982\u53ea\u8bfb\u7b49\u9009\u9879\u3002 \u5728\u4fee\u6539\u914d\u7f6e\u540e\uff0c\u8fd0\u884c <code>systemctl reload nfs-server.service</code>\uff08\u7b49\u4ef7\u4e8e <code>exportfs -r</code>\uff09\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u3002</p> <p>\u5c1d\u8bd5\u914d\u7f6e\u5e76\u6302\u8f7d</p> <p>NFS \u5728\u5404\u79cd\u4e3b\u6d41\u684c\u9762/\u670d\u52a1\u5668\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u90fd\u6709\u4e0d\u9519\u7684\u652f\u6301\u3002\u8bf7\u5c1d\u8bd5\u5728\u4f60\u7684\u7cfb\u7edf\uff08\u865a\u62df\u673a\u6216 Linux \u4e3b\u673a\uff09\u4e0a\u914d\u7f6e NFS \u670d\u52a1\u7aef\uff0c \u5e76\u5728\u4e3b\u673a\u4e0a\u6302\u8f7d\u3002\u5982\u679c\u9700\u8981\u5728 Linux \u4e0a\u6302\u8f7d\uff0c\u53ef\u5148\u9605\u8bfb\u4e0b\u9762\u7684\u5ba2\u6237\u7aef\u914d\u7f6e\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cWindows \u9700\u8981\u542f\u7528 NFS \u5bf9\u5e94\u7684\u53ef\u9009\u7279\u6027\uff0c\u5e76\u4e14\u4e0d\u652f\u6301 NFSv4\u3002</p> <p>\u63a5\u4e0b\u6765\u4e3b\u8981\u4ecb\u7ecd <code>exports</code> \u6587\u4ef6\u7684\u5e38\u89c1\u914d\u7f6e\u3002\u4ee5\u4e0a\u4f8b\u5b50\u4e2d\u5bf9\u5e94\u76ee\u5f55\u88ab\u5bfc\u51fa\u5230\u4e86 <code>localhost</code>\uff0c\u4f46\u662f\u540c\u6837\u4e5f\u63a5\u53d7\u5176\u4ed6\u683c\u5f0f\uff0c\u4f8b\u5982\uff1a</p> <pre><code>/var/lib/example 10.0.0.0/25(rw,sync,no_subtree_check,no_root_squash)\n/share        *(ro,no_root_squash,async,insecure,no_subtree_check)\n/media 192.168.93.2(rw,no_subtree_check) 192.168.93.3(rw,no_subtree_check)\n</code></pre> <p>\u5206\u522b\u4ee3\u8868\u76ee\u5f55\u5bfc\u51fa\u7ed9\u4e86\u4e00\u4e2a CIDR \u7f51\u6bb5\u3001\u6240\u6709 IP\uff0c\u4ee5\u53ca\u4e24\u4e2a\u7279\u5b9a\u7684 IP\u3002</p> <p>\u4f7f\u7528 <code>exportfs -a</code> \u68c0\u67e5\u914d\u7f6e\u95ee\u9898</p> <p><code>exports</code> \u6587\u4ef6\u5982\u679c\u7f16\u8f91\u4e0d\u5f53\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5ba2\u6237\u7aef\u65e0\u6cd5\u6b63\u786e\u6302\u8f7d\uff0c\u6216\u8005\u5e26\u6765\u975e\u9884\u671f\u7684\u5b89\u5168\u98ce\u9669\u3002 \u8fd9\u662f\u5728 RHEL 9 \u624b\u518c\u4e2d\u4e3e\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>/home bob.example.com(rw)\n/home bob.example.com (rw)\n</code></pre> <p>\u7b2c\u4e00\u884c\u662f\u6b63\u786e\u7684\u914d\u7f6e\uff0c\u800c\u7b2c\u4e8c\u884c\u662f\u9519\u8bef\u7684\u914d\u7f6e\uff0c\u5b9e\u9645\u884c\u4e3a\u662f\uff1abob.example.com \u83b7\u5f97\u53ea\u8bfb\u6743\u9650\uff0c\u800c\u5176\u4ed6\u6240\u6709\u4eba\u83b7\u5f97\u8bfb\u5199\u6743\u9650\u3002 \u8fd9\u663e\u7136\u662f\u975e\u9884\u671f\u7684\u3002\u6211\u4eec\u5728\u672c\u5730\u6a21\u4eff\u7c7b\u4f3c\u7684\u95ee\u9898\uff1a</p> <pre><code>/srv/abcde        localhost (rw,no_root_squash,async,insecure,no_subtree_check)\n</code></pre> <p>\u4e4b\u540e\u6267\u884c <code>exportfs -a</code>\uff0c\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u4e86\u4e00\u4e9b\u8b66\u544a\uff0c\u63d0\u793a\u6211\u4eec\u76ee\u524d\u7684\u914d\u7f6e\u5b58\u5728\u6f5c\u5728\u7684\u95ee\u9898\uff08\u4e00\u4e9b\u914d\u7f6e\u6ca1\u6709\u663e\u5f0f\u7ed9\u51fa\uff09\uff1a</p> <pre><code>$ sudo exportfs -a\nexportfs: No options for /srv/abcde localhost: suggest localhost(sync) to avoid warning\nexportfs: /etc/exports [2]: Neither 'subtree_check' or 'no_subtree_check' specified for export \"localhost:/srv/abcde\".\nAssuming default behaviour ('no_subtree_check').\nNOTE: this default has changed since nfs-utils version 1.0.x\n\nexportfs: No host name given with /srv/abcde (rw,no_root_squash,async,insecure,no_subtree_check), suggest *(rw,no_root_squash,async,insecure,no_subtree_check) to avoid warning\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0 <code>localhost</code> \u6ca1\u6709\u5f97\u5230\u6b63\u786e\u7684\u914d\u7f6e\uff0c\u800c <code>*</code> \u5bf9\u5e94\u7684\u914d\u7f6e\u5374\u662f\u5e94\u8be5\u7ed9 <code>localhost</code> \u7684\u3002 \u5728\u4fee\u590d\uff08\u53bb\u6389\u7a7a\u683c\uff09\u540e\uff0c\u518d\u6b21\u6267\u884c <code>exportfs -a</code>\uff0c\u5c31\u4e0d\u4f1a\u6709\u8b66\u544a\u4e86\uff1a</p> <pre><code>$ sudo exportfs -a\n$\n</code></pre> <p>\u5728\u53c2\u6570\u90e8\u5206\u6709\u4e00\u4e9b\u5e38\u89c1\u7684\u9009\u9879\uff1a</p> <ul> <li><code>rw</code>/<code>ro</code>\uff1a\u8bfb\u5199/\u53ea\u8bfb</li> <li><code>sync</code>/<code>async</code>\uff1a\u540c\u6b65/\u5f02\u6b65\uff0c\u540e\u8005\u5141\u8bb8\u670d\u52a1\u5668\u5728\u5b8c\u6210\u5199\u5165\u64cd\u4f5c\u524d\u5c31\u8fd4\u56de\uff0c\u5728\u63d0\u5347\u6027\u80fd\u7684\u540c\u65f6\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u5728\u5d29\u6e83/\u65ad\u7535\u65f6\u4e22\u5931</li> <li><code>no_subtree_check</code>\uff1a\u300c\u53d6\u6d88\u5b50\u6811\u68c0\u67e5\u300d\u2014\u2014\u5982\u679c\u786e\u8ba4 NFS \u4e0d\u4f1a\u66b4\u9732\u5728\u4e0d\u53ef\u4fe1\u7684\u73af\u5883\u4e0b\uff0c\u6216\u8005\u5bfc\u51fa\u7684\u76ee\u5f55\u662f\u6587\u4ef6\u7cfb\u7edf\u7684\u6839\u76ee\u5f55\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u8fd9\u4e2a\u9009\u9879\u4ee5\u63d0\u5347\u6027\u80fd</li> <li><code>no_root_squash</code>\uff1a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5ba2\u6237\u7aef\u7684 root \u4f1a\u88ab\u6620\u5c04\u5230\u7279\u5b9a\u7528\u6237\uff08<code>nobody</code>\uff09\uff0c\u8bbe\u7f6e <code>no_root_squash</code> \u4f1a\u8ba9\u5ba2\u6237\u7aef\u7684 root \u62e5\u6709\u548c\u670d\u52a1\u5668 root \u4e00\u6837\u7684\u6587\u4ef6\u6743\u9650\uff1b\u8be5\u9009\u9879\u4e0d\u5f71\u54cd\u975e root \u7528\u6237</li> <li><code>all_squash</code>\uff1a\u5c06\u6240\u6709\u5ba2\u6237\u7aef\u7684\u7528\u6237\u6620\u5c04\u5230\u4e00\u4e2a\u7279\u5b9a\u7684\u7528\u6237\uff08<code>nobody</code>\uff09</li> <li><code>secure</code>/<code>insecure</code>\uff1a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cNFS \u670d\u52a1\u7aef\u53ea\u63a5\u53d7\u5ba2\u6237\u7aef\u4f7f\u7528 1024 \u4ee5\u4e0b\u7684\u7aef\u53e3\u8bbf\u95ee\uff0c\u8bbe\u7f6e <code>insecure</code> \u4f1a\u653e\u5bbd\u8fd9\u4e2a\u9650\u5236</li> </ul> <p>1024 \u7aef\u53e3\uff0c\u4e0e root</p> <p>\u5728\u4f20\u7edf\u4e0a\uff0c\u7c7b Unix \u64cd\u4f5c\u7cfb\u7edf\u4e2d\u53ea\u6709 root \u7528\u6237\u624d\u80fd\u4f7f\u7528 1024 \u4ee5\u4e0b\u7684\u7aef\u53e3\u3002\u56e0\u6b64\u5728\u5f88\u4e45\u4ee5\u524d\uff0c\u7a0b\u5e8f\u53ef\u4ee5\u5047\u8bbe\u6765\u81ea 1024 \u4ee5\u4e0b\u7684\u7aef\u53e3\u7684\u8bf7\u6c42/\u670d\u52a1\u662f root \u7528\u6237\u53d1\u51fa/\u6388\u6743\u7684\u3002 \u5728 NFS \u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u610f\u5473\u7740\u53ea\u6709 root \u624d\u80fd\u8bbf\u95ee NFS \u670d\u52a1\uff0c\u6ca1\u6709 root \u6743\u9650\u7684\u7528\u6237\u4e0d\u80fd\u591f\u5047\u5192\u81ea\u5df1\u4e3a NFS \u5ba2\u6237\u7aef\uff0c\u4ece\u800c\u4ee5\u5047\u7684\u7528\u6237\u6743\u9650\u8bfb\u5199\u6570\u636e\u3002 \u8fd9\u5728\u5f88\u4e45\u4ee5\u524d\u7684\u5185\u90e8\u7f51\u7edc\u4e2d\u7684\u670d\u52a1\u5668\u573a\u666f\u662f\u6709\u610f\u4e49\u7684\u3002</p> <p>\u76ee\u524d Linux \u4ecd\u7136\u4fdd\u7559\u4e86\u8fd9\u4e2a\u673a\u5236\uff0c\u4f46\u662f\u7a0b\u5e8f\u4e0d\u5e94\u8be5\u4ec5\u4ec5\u4f9d\u8d56\u4e8e\u8fd9\u4e2a\u673a\u5236\u6765\u4fdd\u8bc1\u5b89\u5168\u6027\u3002</p> \u5173\u4e8e\u300c\u5b50\u6811\u68c0\u67e5\u300d\u7684\u89e3\u91ca <p>NFS \u670d\u52a1\u5668\u4e0e\u5ba2\u6237\u7aef\u4e4b\u95f4\u4f7f\u7528\u300c\u6587\u4ef6\u53e5\u67c4\u300d\uff08file handle\uff09\u6765\u6807\u8bc6\u6587\u4ef6\u3002 \u6587\u4ef6\u53e5\u67c4\u7684\u5185\u5bb9\u542b\u4e49\u7531\u670d\u52a1\u5668\u51b3\u5b9a\u3002 \u5728 Linux \u5185\u6838\u6001 NFS \u7684\u5b9e\u73b0\u4e2d\uff0c\u6587\u4ef6\u53e5\u67c4\u7684\u7ed3\u6784\u4f53\u4e3a <code>knfsd_fh</code>\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>struct knfsd_fh {\n    unsigned int    fh_size;    /*\n                                 * Points to the current size while\n                                 * building a new file handle.\n                                 */\n    union {\n        char        fh_raw[NFS4_FHSIZE];\n        struct {\n            u8      fh_version;     /* == 1 */\n            u8      fh_auth_type;   /* deprecated */\n            u8      fh_fsid_type;\n            u8      fh_fileid_type;\n            u32     fh_fsid[]; /* flexible-array member */\n        };\n    };\n};\n</code></pre> <p>\u4f8b\u5982\u6293\u5305\u5f97\u5230\u4e00\u4e2a\u7531\u5185\u6838\u6001 NFSv4 \u670d\u52a1\u5668\u8fd4\u56de\u7684\u6587\u4ef6\u53e5\u67c4\uff08\u5341\u516d\u8fdb\u5236\uff09\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>01 00 07 01\nb0 18 06 00 00 00 00 00 6c f8 f6 54 9a 14 47 03\nbe 4e c5 a0 59 c9 f7 f8 16 2e 06 00 a5 70 74 83\n</code></pre> <p>\u4e0e union \u4e2d\u7684\u7ed3\u6784\u4f53\u5bf9\u5e94\u3002\u6839\u636e fsid \u548c fileid type \u53ef\u4ee5\u63a8\u65ad <code>fh_fsid[]</code> \u7684\u524d 24 \u4e2a\u5b57\u8282\u5b58\u50a8\u6587\u4ef6\u7cfb\u7edf\u4fe1\u606f\uff0c\u540e 8 \u4e2a\u5b57\u8282\u5b58\u50a8\u6587\u4ef6\u4fe1\u606f\u3002 inode \u7f16\u53f7\u540e\u662f generation number\uff0c\u7528\u4e8e\u68c0\u6d4b\u6587\u4ef6\u662f\u5426\u88ab\u4fee\u6539\u3002</p> <p>\u8be5\u6587\u4ef6 inode \u7f16\u53f7\u4e3a 405014\uff0c\u5373 0x62e16\uff0c\u53ef\u4ee5\u53d1\u73b0\u4ee5\u5c0f\u7aef\u5e8f\u7684\u5f62\u5f0f\u5b58\u50a8\u5728\u6700\u540e 8 \u4e2a\u5b57\u8282\u3002 \u540c\u65f6\uff0c\u88ab\u5bfc\u51fa\u76ee\u5f55\u7684 inode \u7f16\u53f7\u4e3a 399536\uff0c\u5373 0x618b0\uff1b\u6240\u5904\u7684\u6587\u4ef6\u7cfb\u7edf\u7684 UUID \u4e3a 6cf8f654-9a14-4703-be4e-c5a059c9f7f8\uff0c \u8fd9\u4e9b\u4fe1\u606f\u5b58\u50a8\u5728\u524d 24 \u4e2a\u5b57\u8282\u4e2d\u3002</p> <p>\u4e8e\u662f\u5982\u679c NFS \u5171\u4eab\uff08\u5bfc\u51fa\uff09\u7684\u76ee\u5f55\u4e0d\u662f\u6587\u4ef6\u7cfb\u7edf\u7684\u6839\u76ee\u5f55\uff0c\u90a3\u4e48\u5185\u6838\u6001\u670d\u52a1\u5668\u5c31\u9700\u8981\u5224\u65ad\u5ba2\u6237\u7aef\u8bf7\u6c42\u7684\u6587\u4ef6\u53e5\u67c4\u662f\u5426\u771f\u7684\u5728\u5171\u4eab\u7684\u76ee\u5f55\u4e0b\u3002 \u8fd9\u4e00\u9879\u68c0\u67e5\u9700\u8981\u4ece\u6587\u4ef6\u7684 inode \u4fe1\u606f\u4e0d\u505c\u5411\u4e0a\u67e5\u627e\u6765\u786e\u8ba4\u6587\u4ef6\u786e\u5b9e\u5728\u5171\u4eab\u7684\u76ee\u5f55\u4e2d\u3002 \u800c <code>no_subtree_check</code> \u4f1a\u8df3\u8fc7\u8fd9\u6837\u7684\u68c0\u67e5\u3002</p> <p>\u90e8\u5206\u53ef\u80fd\u5bf9\u51b3\u7b56\u6709\u5e2e\u52a9\u7684\u4fe1\u606f\u2014\u2014\u5728\u4f8b\u5982\u6709\u5927\u91cf\u6587\u4ef6\u91cd\u547d\u540d\u7684\u573a\u5408\uff0c\u53ef\u80fd\u4e0d\u5f97\u4e0d\u5173\u95ed\u5b50\u6811\u68c0\u67e5\uff1a</p> <ul> <li>Making Filesystems Exportable -- The Linux Kernel  documentation</li> <li>Network File System (NFS) | Ubuntu</li> <li>Linux NFS faq</li> </ul> <p>\u4ee5\u53ca\u76f8\u5173\u7684 CVE \u4e0e\u4fee\u590d\u7684 commit message\uff1a</p> <p>CVE-2021-3178:</p> <pre><code>\u5434\u5f02 reported an information leak in the NFSv3 server.  When only\na subdirectory of a filesystem volume is exported, an NFS client\nlisting the exported directory would obtain a file handle to the\nparent directory, allowing it to access files that were not meant\nto be exported.\n\nEven after this update, it is still possible for NFSv3 clients to\nguess valid file handles and access files outside an exported\nsubdirectory, unless the \"subtree_check\" export option is enabled.\nIt is recommended that you do not use that option but only export\nwhole filesystem volumes.\n</code></pre> <p>nfsd4: readdirplus shouldn't return parent of export:</p> <pre><code>nfsd4: readdirplus shouldn't return parent of export\n\nIf you export a subdirectory of a filesystem, a READDIRPLUS on the root\nof that export will return the filehandle of the parent with the \"..\"\nentry.\n\nThe filehandle is optional, so let's just not return the filehandle for\n\"..\" if we're at the root of an export.\n\nNote that once the client learns one filehandle outside of the export,\nthey can trivially access the rest of the export using further lookups.\n\nHowever, it is also not very difficult to guess filehandles outside of\nthe export.  So exporting a subdirectory of a filesystem should\nconsidered equivalent to providing access to the entire filesystem.  To\navoid confusion, we recommend only exporting entire filesystems.\n\nReported-by: Youjipeng &lt;wangzhibei1999@gmail.com&gt;\nSigned-off-by: J. Bruce Fields &lt;bfields@redhat.com&gt;\nCc: stable@vger.kernel.org\nSigned-off-by: Chuck Lever &lt;chuck.lever@oracle.com&gt;\n</code></pre> RDMA \u652f\u6301\uff08\u670d\u52a1\u7aef\uff09 <p>NFS \u652f\u6301 RDMA \u534f\u8bae\uff0c\u5728\u914d\u7f6e\u4e86\u4e13\u7528 RDMA \u5361\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5728\u6570\u636e\u4e2d\u5fc3\u5185\u90e8\u7f51\u7edc\u7684\u573a\u666f\u4e0b\u51cf\u5c0f\u7f51\u7edc\u5ef6\u8fdf\uff0c\u63d0\u5347\u6027\u80fd\u3002 \uff08\u5982\u679c\u5e0c\u671b\u672c\u5730\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u5b89\u88c5 <code>rdma-core</code> \u5305\uff0c\u5176\u5305\u542b\u4e86 Soft-RoCE \u5b9e\u73b0\uff0c\u5373\u8f6f\u4ef6\u6a21\u62df\u7684 RDMA\uff1b <code>rdmacm-utils</code> \u5305\u5305\u542b\u4e86 <code>rping</code> \u5de5\u5177\u7528\u4e8e\u6d4b\u8bd5 RDMA \u8fde\u63a5\u3002 \u5982\u4f55\u4f7f\u7528 <code>rdma link</code> \u547d\u4ee4\u521b\u5efa\u8f6f\u4ef6\u6a21\u62df\u7684 RDMA \u8bbe\u5907\u8bf7\u81ea\u884c\u641c\u7d22\uff09</p> <p>\u5728\u7cfb\u7edf\u80fd\u591f\u8bc6\u522b\u5230 RDMA \u8bbe\u5907\u7684\u60c5\u51b5\u4e0b\uff1a</p> <pre><code>$ rdma link\nlink rxe0/1 state ACTIVE physical_state LINK_UP netdev enp1s0\n</code></pre> <p>\u7f16\u8f91 <code>/etc/nfs/nfs.conf</code> \u6587\u4ef6\uff0c\u5728 <code>[nfsd]</code> \u4e00\u6bb5\u8fdb\u884c RDMA \u7684\u914d\u7f6e\uff1a</p> <pre><code>[nfsd]\n# ...\nrdma=y\nrdma-port=20049\n</code></pre> <p>\u4e4b\u540e\u91cd\u542f <code>nfs-server</code> \u670d\u52a1\u5373\u53ef\u3002\u53ef\u4ee5\u5728 <code>/proc/fs/nfsd/portlist</code> \u786e\u8ba4 NFS \u670d\u52a1\u5668\u76d1\u542c\u7684\u7aef\u53e3\u60c5\u51b5\uff1a</p> <pre><code>$ cat /proc/fs/nfsd/portlist\nrdma 20049\nrdma 20049\ntcp 2049\ntcp 2049\n</code></pre>"},{"location":"ops/storage/network/#nfs-client","title":"\u5ba2\u6237\u7aef\u914d\u7f6e","text":"<p>\u6302\u8f7d NFS\uff08\u8868\u9762\u4e0a\uff09\u662f\u4e00\u4ef6\u5f88\u7b80\u5355\u7684\u4e8b\u60c5\uff1a</p> <pre><code>$ sudo mount -t nfs localhost:/srv/abcde /mnt/nfs\n$ mount | grep nfs\nnfsd on /proc/fs/nfsd type nfsd (rw,relatime)\nlocalhost:/srv/abcde on /mnt/nfs type nfs4 (rw,relatime,vers=4.2,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp6,timeo=600,retrans=2,sec=sys,clientaddr=::1,local_lock=none,addr=::1)\n</code></pre> <p>\u6709\u7684\u65f6\u5019\u9700\u8981\u6dfb\u52a0\u53c2\u6570\uff0c\u4f8b\u5982\u4e0b\u9762\u8fd9\u4e2a\u4f7f\u7528 NFS over RDMA \u7684\u4f8b\u5b50\u4e2d\uff0c\u9700\u8981\u6307\u5b9a\u534f\u8bae\u4e0e\u7aef\u53e3\u53f7\uff1a</p> <pre><code>$ sudo mount -t nfs -o proto=rdma,port=20049 192.168.122.47:/srv/abcde /mnt/nfs\n$ mount | grep nfs\n192.168.122.47:/srv/abcde on /mnt/nfs type nfs4 (rw,relatime,vers=4.2,rsize=1048576,wsize=1048576,namlen=255,hard,proto=rdma,port=20049,timeo=600,retrans=2,sec=sys,clientaddr=192.168.122.47,local_lock=none,addr=192.168.122.47)\n</code></pre> <p>\u5982\u679c\u8981\u67e5\u770b\u67d0\u4e2a IP \u5bfc\u51fa\u7684\u76ee\u5f55\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>showmount</code>\uff1a</p> <pre><code>$ showmount -e 10.1.2.3\nExport list for 10.1.2.3:\n/mnt      10.0.0.0/8,100.0.0.0/8\n</code></pre> <p>\u4f46\u662f\u6700\u5e38\u89c1\u7684\u95ee\u9898\uff0c\u8fd8\u662f <code>hard</code> \u4e0e <code>soft</code>\uff08\u6216\u8005 Linux 5.6 \u4e4b\u540e\u65b0\u589e\u7684 <code>softerr</code>\uff09\u7684\u9009\u62e9\u3002 NFS \u5ba2\u6237\u7aef\u5728\u6bcf\u6b21\u91cd\u8bd5\u4e4b\u524d\u4f1a\u7b49\u5f85 <code>timeo</code> / 10\uff08\u9ed8\u8ba4 600 / 10 = 60\uff09\u79d2\u3002 \u5728 <code>hard</code> \u6a21\u5f0f\u4e0b\uff0c\u5982\u679c\u670d\u52a1\u5668\u6ca1\u6709\u54cd\u5e94\uff0c\u90a3\u4e48\u5ba2\u6237\u7aef\u4f1a\u6c38\u8fdc\u91cd\u8bd5\u4e0b\u53bb\uff0c\u76f4\u5230\u670d\u52a1\u5668\u6062\u590d\uff1b \u800c\u5728 <code>soft</code> \u6a21\u5f0f\u4e0b\uff0c\u5728\u7ecf\u8fc7 <code>retrans</code>\uff08\u9ed8\u8ba4\u4e3a 2\uff09\u6b21\u91cd\u8bd5\u540e\uff0c\u5ba2\u6237\u7aef\u4f1a\u653e\u5f03\uff0c\u5e76\u5411\u5e94\u7528\u7a0b\u5e8f\u8fd4\u56de\u9519\u8bef\u3002 \uff08\u4f46\u662f\u5e94\u7528\u80fd\u4e0d\u80fd\u6b63\u786e\u5904\u7406\u9519\u8bef\uff0c\u5c31\u662f\u53e6\u5916\u4e00\u56de\u4e8b\u4e86\uff09</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u51fa\u4e8e\u4fdd\u62a4\u6570\u636e\u5b8c\u6574\u6027\u7684\u8003\u8651\uff0c<code>mount</code> \u4f1a\u9009\u62e9 <code>hard</code> \u6a21\u5f0f\u3002 \u4f46\u662f\u5982\u679c\u7f51\u7edc\u6216\u8005 NFS \u670d\u52a1\u5668\u7684\u7a33\u5b9a\u6027\u4e0d\u591f\u7684\u8bdd\uff0c\u7ed3\u679c\u53ef\u80fd\u4f1a\u6bd4\u8f83\u68d8\u624b\u3002 \u8ba9\u6211\u4eec\u5728\u865a\u62df\u673a\u91cc\u8bd5\u4e00\u8bd5\uff08\u8bf7\u5148\u4fdd\u5b58\u5168\u90e8\u6570\u636e\uff01\uff09\uff1a</p> <pre><code>$ sudo mount -t nfs localhost:/srv/abcde /mnt/nfs\n$ sudo systemctl stop nfs-server\n$ echo \"test\" &gt; /mnt/nfs/testfile\n^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0 <code>echo</code> \u88ab\u963b\u585e\u4f4f\u4e86\uff0c\u5e76\u4e14\u53d1\u9001 SIGINT \u65e0\u6cd5\u6b63\u5e38\u7ec8\u6b62\u3002\u6b64\u65f6\u7684 bash \u8fdb\u7a0b\u5904\u4e8e D \u72b6\u6001\uff0c\u6808\u5982\u4e0b\uff1a</p> <pre><code>$ sudo cat /proc/4971/stack\n[&lt;0&gt;] rpc_wait_bit_killable+0xd/0x60 [sunrpc]\n[&lt;0&gt;] nfs4_run_open_task+0x152/0x1e0 [nfsv4]\n[&lt;0&gt;] nfs4_do_open+0x25b/0xc20 [nfsv4]\n[&lt;0&gt;] nfs4_atomic_open+0xf4/0x100 [nfsv4]\n[&lt;0&gt;] nfs_atomic_open+0x215/0x6a0 [nfs]\n[&lt;0&gt;] path_openat+0x6d7/0x1260\n[&lt;0&gt;] do_filp_open+0xaf/0x160\n[&lt;0&gt;] do_sys_openat2+0xaf/0x170\n[&lt;0&gt;] __x64_sys_openat+0x6a/0xa0\n[&lt;0&gt;] do_syscall_64+0x58/0xc0\n[&lt;0&gt;] entry_SYSCALL_64_after_hwframe+0x64/0xce\n</code></pre> <p>\u56e0\u4e3a\u6808\u9876\u662f killable \u7684\uff0c\u53d1\u9001 SIGKILL \u4ecd\u53ef\u6b63\u5e38\u7ec8\u6b62\u8fdb\u7a0b\uff1a</p> <pre><code>$ kill -9 4971\n$ sudo cat /proc/4971/stack\ncat: /proc/4971/stack: No such file or directory\n</code></pre> <p>\u5982\u679c\u6ca1\u6709\u8fdb\u7a0b\u5728\u4f7f\u7528\u7684\u8bdd\uff0c\u4e5f\u80fd\u2026\u2026\u6b63\u5e38\uff08\uff1f\uff09umount\uff1a</p> <pre><code>$ sudo umount /mnt/nfs\n^C\n$ mount | grep nfs\nnfsd on /proc/fs/nfsd type nfsd (rw,relatime)\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u6709\u7684\u8bdd\uff0cumount \u4f1a\u62d2\u7edd\uff0c\u5373\u4f7f\u52a0\u4e0a <code>-f</code> \u4e5f\u4e0d\u4f1a\u64cd\u4f5c\uff1a</p> <pre><code>$ sudo umount /mnt/nfs\numount.nfs4: /mnt/nfs: target is busy\n$ sudo umount -f /mnt/nfs\numount.nfs4: /mnt/nfs: target is busy\n</code></pre> <p>\u5373\u4f7f\u770b\u4f3c\u6709\u529e\u6cd5\u80fd\u4ece hard \u4e2d\u5168\u8eab\u800c\u9000\uff08\u6740\u6389\u5168\u90e8\u8bbf\u95ee\u8fdb\u7a0b\u518d umount\uff09\uff0c\u4f46\u662f\u4ecd\u7136\u9700\u8981\u5c0f\u5fc3\uff1a \u4e00\u4e2a\u4f8b\u5b50\u662f <code>home</code> \u76ee\u5f55\u5728 NFS \u4e0a\uff0c\u800c\u7528\u6237\u767b\u5f55\u65f6\u53c8\u9700\u8981\u8bfb\u53d6 <code>~/.bashrc</code> \u7b49\u6587\u4ef6\u3002 \u5982\u679c\u6b64\u65f6 NFS \u670d\u52a1\u5668\u4e0d\u53ef\u7528\uff0c\u90a3\u4e48\u6240\u6709\u7528\u6237\u767b\u5f55\u90fd\u4f1a\u5361\u4f4f\uff0c\u5982\u679c\u4e0d\u80fd\u767b\u5f55 root \u7684\u8bdd\uff0c\u5c31\u53ea\u6709\u5f3a\u5236\u91cd\u542f\u4e00\u79cd\u9009\u62e9\u4e86\u3002</p> <p>\u5982\u679c\u80fd\u591f\u767b\u5f55\uff0c\u4f46\u662f\u53d1\u73b0\u6ca1\u6709\u529e\u6cd5\u6740\u5149\u6240\u6709\u8bbf\u95ee NFS \u7684\u8fdb\u7a0b\uff08\u53ef\u80fd\u5728\u4e0d\u505c\u51fa\u73b0\u65b0\u7684\uff09\uff0c\u4e00\u79cd\u59a5\u534f\u7684\u65b9\u6cd5\u662f lazy unmount\uff1a</p> <pre><code>$ sudo umount -l /mnt/nfs\n$\n</code></pre> <p>\u6b64\u65f6 <code>/mnt/nfs</code> \u4e0d\u4f1a\u66b4\u9732\u4e3a\u6302\u8f7d\u70b9\uff0c\u4f46\u662f\u5df2\u6709\u7684\u8fdb\u7a0b\u5982\u679c\u6301\u6709\u6302\u8f7d\u70b9\u5185\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4ecd\u7136\u53ef\u4ee5\u7ee7\u7eed\u8bbf\u95ee\u3002 \u6b64\u65f6\u7684\u95ee\u9898\u6302\u8f7d\u70b9\u4e8b\u5b9e\u4e0a\u8fd8\u662f\u6ca1\u6709\u88ab\u5378\u8f7d\uff0c\u53ea\u662f\u4e4b\u540e\u65b0\u7684\u8bbf\u95ee\u4e0d\u4f1a\u518d\u6d89\u53ca NFS \u4e86\u3002 \u5728\u7528\u8fd9\u79cd\u65b9\u5f0f\u300c\u89e3\u51b3\u300d\u95ee\u9898\u4e4b\u540e\uff0c\u5efa\u8bae\u5c3d\u5feb\u91cd\u542f\u670d\u52a1\u5668\u3002</p> <p>\u6b64\u5916\uff0c<code>intr</code> \u53c2\u6570\u5728\u73b0\u5728\u80fd\u78b0\u5230\u7684\u5185\u6838\uff082.6.25+\uff09\u4e2d\uff0c\u6ca1\u6709\u4efb\u4f55\u610f\u4e49\uff0c\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u8bbe\u7f6e\u3002</p>"},{"location":"ops/storage/network/#iscsi","title":"iSCSI","text":"<p>iSCSI \u80fd\u591f\u5b9e\u73b0\u5757\u8bbe\u5907\u7ea7\u522b\u7684\u7f51\u7edc\u5b58\u50a8\u3002\u5176\u4e2d\u670d\u52a1\u7aef\u79f0\u4e3a iSCSI Target\uff0c\u5ba2\u6237\u7aef\u79f0\u4e3a iSCSI Initiator\u3002</p>"},{"location":"ops/storage/network/#iscsi-server","title":"\u670d\u52a1\u7aef\u914d\u7f6e","text":"<p>Linux \u5185\u6838\u63d0\u4f9b\u7684 iSCSI Target \u5b9e\u73b0\u662f LIO\uff08LinuxIO\uff09\uff0c\u53ef\u4ee5\u5728\u5b89\u88c5 <code>targetcli-fb</code> \u5305\u540e\u4f7f\u7528 <code>targetcli</code> \u547d\u4ee4\u884c\u5de5\u5177\u8fdb\u884c\u914d\u7f6e\u3002</p> <pre><code>$ sudo targetcli\ntargetcli shell version 2.1.53\nCopyright 2011-2013 by Datera, Inc and others.\nFor help on commands, type 'help'.\n\n/&gt; ls\no- / ..................................................................... [...]\n  o- backstores .......................................................... [...]\n  | o- block .............................................. [Storage Objects: 0]\n  | o- fileio ............................................. [Storage Objects: 0]\n  | o- pscsi .............................................. [Storage Objects: 0]\n  | o- ramdisk ............................................ [Storage Objects: 0]\n  o- iscsi ........................................................ [Targets: 0]\n  o- loopback ..................................................... [Targets: 0]\n  o- vhost ........................................................ [Targets: 0]\n  o- xen-pvscsi ................................................... [Targets: 0]\n/&gt; cd iscsi\n/iscsi&gt; ls\no- iscsi .......................................................... [Targets: 0]\n/iscsi&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0ctarget \u4e0e\u5176\u76f8\u5173\u7684 backstore \u90fd\u4ee5\u7c7b\u4f3c\u4e8e\u6587\u4ef6\u7cfb\u7edf\u7684\u6811\u72b6\u7ed3\u6784\u5c55\u793a\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f7f\u7528 <code>cd</code> \u548c <code>ls</code> \u8fdb\u884c\u5bfc\u822a\u3002 \u4e3a\u4e86\u521b\u5efa iSCSI target\uff0c\u9996\u5148\u9700\u8981\u4e3a\u5176\u521b\u5efa\u4e00\u4e2a backstore\u3002\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u662f\u4f7f\u7528 <code>fileio</code> \u5c06\u6587\u4ef6\u4f5c\u4e3a backstore\uff1a</p> <pre><code>/iscsi&gt; cd ..\n/&gt; backstores/fileio create test1 /tmp/test1.img 1G\nCreated fileio test1 with size 1073741824\n/&gt; ls backstores/fileio\no- fileio ................................................. [Storage Objects: 1]\n  o- test1 .................... [/tmp/test1.img (1.0GiB) write-back deactivated]\n    o- alua ................................................... [ALUA Groups: 1]\n      o- default_tg_pt_gp ....................... [ALUA state: Active/optimized]\n</code></pre> <p>\u548c\u521b\u5efa\u672c\u5730\u56de\u73af\u6709\u4e9b\u7c7b\u4f3c\uff0c\u4f46\u662f\u8fd9\u91cc\u7684\u6587\u4ef6\u662f\u4e13\u95e8\u4f5c\u4e3a iSCSI target\uff08\u6216\u8005\u522b\u7684 target\uff09\u7684 backstore \u800c\u5b58\u5728\u7684\u3002 \u5c06\u5757\u8bbe\u5907\u4f5c\u4e3a backstore \u4e5f\u7c7b\u4f3c\uff1a</p> <pre><code>/&gt; backstores/block create test2 /dev/loop0\nCreated block storage object test2 using /dev/loop0\n/&gt; ls backstores/\no- backstores ............................................................ [...]\n  o- block ................................................ [Storage Objects: 1]\n  | o- test2 ...................... [/dev/loop0 (1.0GiB) write-thru deactivated]\n  |   o- alua ................................................. [ALUA Groups: 1]\n  |     o- default_tg_pt_gp ..................... [ALUA state: Active/optimized]\n  o- fileio ............................................... [Storage Objects: 1]\n  | o- test1 .................. [/tmp/test1.img (1.0GiB) write-back deactivated]\n  |   o- alua ................................................. [ALUA Groups: 1]\n  |     o- default_tg_pt_gp ..................... [ALUA state: Active/optimized]\n  o- pscsi ................................................ [Storage Objects: 0]\n  o- ramdisk .............................................. [Storage Objects: 0]\n</code></pre> <p>\u4e4b\u540e\u521b\u5efa iSCSI target\u3002\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4e3a\u8fd9\u4e2a target\u300c\u8d77\u4e00\u4e2a\u540d\u5b57\u300d\uff0c\u8fd9\u4e2a\u540d\u5b57\u88ab\u79f0\u4e3a iqn\uff08iSCSI Qualified Name\uff09\u3002 iqn \u7684\u683c\u5f0f\u5f62\u5982 <code>iqn.yyyy-mm.com.example:some-storage-target</code>\uff0c\u5176\u4e2d <code>yyyy-mm</code> \u662f\u65e5\u671f\uff0c<code>com.example</code> \u662f\u53cd\u8fc7\u6765\u7684\u57df\u540d\uff08reversed domain name\uff09\uff0c\u800c <code>:</code> \u540e\u9762\u7684\u90e8\u5206\u662f target \u7684\u540d\u5b57\u3002\u670d\u52a1\u5668\u548c\u5ba2\u6237\u7aef\u90fd\u6709\u81ea\u5df1\u7684 iqn\u3002</p> <pre><code>/&gt; iscsi/ create iqn.2024-03.org.example.201:test-target\nCreated target iqn.2024-03.org.example.201:test-target.\nCreated TPG 1.\nGlobal pref auto_add_default_portal=true\nCreated default portal listening on all IPs (0.0.0.0), port 3260.\n/&gt; ls iscsi/\no- iscsi .......................................................... [Targets: 1]\n  o- iqn.2024-03.org.example.201:test-target ......................... [TPGs: 1]\n    o- tpg1 ............................................. [no-gen-acls, no-auth]\n      o- acls ........................................................ [ACLs: 0]\n      o- luns ........................................................ [LUNs: 0]\n      o- portals .................................................. [Portals: 1]\n        o- 0.0.0.0:3260 ................................................... [OK]\n</code></pre> <p>\u4e4b\u540e\u5728 <code>luns</code> \u4e0b\u7ed1\u5b9a backstore \u5230 target \u4e0a\u3002 LUN\uff08Logical Unit Number\uff09\u662f SCSI \u534f\u8bae\u4e2d\u6807\u8bb0\uff08\u903b\u8f91\uff09\u5b58\u50a8\u8bbe\u5907\u7684\u7f16\u53f7\u3002</p> <pre><code>/&gt; iscsi/iqn.2024-03.org.example.201:test-target/tpg1/luns create /backstores/fileio/test1\nCreated LUN 0.\n/&gt; ls iscsi/\no- iscsi .......................................................... [Targets: 1]\n  o- iqn.2024-03.org.example.201:test-target ......................... [TPGs: 1]\n    o- tpg1 ............................................. [no-gen-acls, no-auth]\n      o- acls ........................................................ [ACLs: 0]\n      o- luns ........................................................ [LUNs: 1]\n      | o- lun0 ............. [fileio/test1 (/tmp/test1.img) (default_tg_pt_gp)]\n      o- portals .................................................. [Portals: 1]\n        o- 0.0.0.0:3260 ................................................... [OK]\n</code></pre> <p>\u4e00\u4e2a\u5728\u6240\u6709\u5730\u5740\u7684 3260 \u7aef\u53e3\u76d1\u542c\u7684 iSCSI target \u5c31\u521b\u5efa\u597d\u4e86\u3002 <code>portals</code> \u53ef\u4ee5\u9650\u5236\u8fde\u63a5\u7684 IP \u5730\u5740\uff0c\u5982\u6709\u9700\u8981\u53ef\u81ea\u884c\u67e5\u8be2\u4f7f\u7528\u65b9\u6cd5\u3002</p> <p>\u5173\u4e8e portal</p> <p>\u4e00\u4e9b SAN \u65b9\u6848\u4f1a\u63d0\u4f9b\u591a\u4e2a portal\uff0c\u5bf9\u5e94\u4e0d\u540c\u7684\u7f51\u53e3\u3002\u5728\u96c6\u7fa4\u573a\u666f\u4e0b\u8ba9\u4e0d\u540c\u7684\u8282\u70b9\u8fde\u63a5\u5230\u4e0d\u540c\u7684 portal\uff0c\u4ee5\u6b64\u63d0\u5347\u6027\u80fd\u3002</p> <p>\u5982\u679c\u9700\u8981\u5b9e\u9645\u767b\u5f55\uff08\u8bf8\u5982\u6309\u7167\u4e0b\u9762\u7684\u5ba2\u6237\u7aef\u914d\u7f6e\uff09\uff0c\u8fd8\u9700\u8981\u5c06\u5ba2\u6237\u7aef\u7684 iqn \u4e5f\u8bb0\u5f55\u5728 <code>acls</code> \u4e2d\uff1a</p> <pre><code>/&gt; iscsi/iqn.2024-03.org.example.201:test-target/tpg1/acls create iqn.1993-08.org.debian:01:a6a4d4f7356f\nCreated Node ACL for iqn.1993-08.org.debian:01:a6a4d4f7356f\nCreated mapped LUN 0.\n</code></pre>"},{"location":"ops/storage/network/#iscsi-client","title":"\u5ba2\u6237\u7aef\u914d\u7f6e","text":"<p>\u4f7f\u7528 <code>iscsiadm</code> \u53ef\u4ee5\u914d\u7f6e iSCSI initiator\uff08\u9700\u8981\u5b89\u88c5 <code>open-iscsi</code>\uff09\u3002 \u64cd\u4f5c\u7684\u7b2c\u4e00\u6b65\u662f\u300c\u53d1\u73b0\u300diSCSI target\uff1a</p> <pre><code>$ sudo iscsiadm -m discovery -t sendtargets --portal 127.0.0.1\n127.0.0.1:3260,1 iqn.2024-03.org.example.201:test-target\n$ sudo iscsiadm -m node  # \u5217\u51fa\u53d1\u73b0\u7684 target\n127.0.0.1:3260,1 iqn.2024-03.org.example.201:test-target\n</code></pre> <p>\u7b2c\u4e8c\u6b65\u662f\u300c\u767b\u5f55\u300d\u3002\u4f46\u662f\u76f4\u63a5\u767b\u5f55\u4f1a\u5403\u5230\u95ed\u95e8\u7fb9\uff1a</p> <pre><code>$ sudo iscsiadm -m node --targetname iqn.2024-03.org.example.201:test-target --portal 127.0.0.1:3260 --login\nLogging in to [iface: default, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260]\niscsiadm: Could not login to [iface: default, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260].\niscsiadm: initiator reported error (24 - iSCSI login failed due to authorization failure)\niscsiadm: Could not log into all portals\n</code></pre> <p>\u6211\u4eec\u9700\u8981\u8ba9\u670d\u52a1\u7aef\u6388\u6743\u5ba2\u6237\u7aef\u7684 iqn\uff0c\u5bf9\u5e94\u6587\u4ef6\u5728 <code>/etc/iscsi/initiatorname.iscsi</code>\u3002</p> <pre><code>$ sudo cat /etc/iscsi/initiatorname.iscsi\n## DO NOT EDIT OR REMOVE THIS FILE!\n## If you remove this file, the iSCSI daemon will not start.\n## If you change the InitiatorName, existing access control lists\n## may reject this initiator.  The InitiatorName must be unique\n## for each iSCSI initiator.  Do NOT duplicate iSCSI InitiatorNames.\nInitiatorName=iqn.1993-08.org.debian:01:a6a4d4f7356f\n</code></pre> <p>\uff08\u6ce8\u610f\u4e0d\u8981\u6284\u8fd9\u91cc\u7684 iqn\uff01\uff09</p> <p>\u5728\u670d\u52a1\u7aef\u6388\u6743\u540e\u5c31\u53ef\u4ee5\u767b\u5f55\u4e86\uff1a</p> <pre><code>$ sudo iscsiadm -m node --targetname iqn.2024-03.org.example.201:test-target --portal 127.0.0.1:3260 --login\nLogging in to [iface: default, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260]\nLogin to [iface: default, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260] successful.\n</code></pre> <p>\u65b0\u8bbe\u5907\u53ef\u4ee5\u901a\u8fc7\u591a\u79cd\u65b9\u5f0f\u786e\u8ba4\uff1a</p> <pre><code>$ # session \u4ee3\u8868\u4e86 initiator \u548c target \u7684\u4e00\u4e2a\u8fde\u63a5\n$ # \u4e0b\u9762\u7684\u547d\u4ee4\u5217\u51fa\u4e86\u6240\u6709 session \u7684\u4fe1\u606f\uff0c\u5e76\u4e14\u7528 -P 3 \u4f7f\u5f97\u8f93\u51fa\u66f4\u8be6\u7ec6\n$ sudo iscsiadm -m session -P 3\niSCSI Transport Class version 2.0-870\nversion 2.1.8\nTarget: iqn.2024-03.org.example.201:test-target (non-flash)\n\uff08\u7565\uff09\n            Attached scsi disk sda      State: running\n$ # \u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u8bbe\u5907\u4e3a sda\uff0c\u4e5f\u53ef\u4ee5\u7528 lsblk \u786e\u8ba4\n$ lsblk\nNAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsda      8:0    0     1G  0 disk \nsr0     11:0    1 932.3M  0 rom  \nvda    254:0    0    50G  0 disk \n\u2514\u2500vda1 254:1    0    50G  0 part /\n</code></pre> <p>\u5982\u679c\u4e3a\u4e86\u7ef4\u62a4\u76ee\u7684\u9700\u8981 logout\uff1a</p> <pre><code>$ sudo iscsiadm -m node --targetname iqn.2024-03.org.example.201:test-target --logout all\nLogging out of session [sid: 2, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260]\nLogout of [sid: 2, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260] successful\n</code></pre> <p>\u6709\u65f6\u5019\uff0c\u670d\u52a1\u7aef\u4f1a\u6dfb\u52a0\u65b0\u7684 LUN\uff0c\u6b64\u65f6\u6ca1\u6709\u5fc5\u8981\u65ad\u5f00\u8fde\u63a5\u518d\u91cd\u8fde\uff08\u4f1a\u5bfc\u81f4\u670d\u52a1\u4e2d\u65ad\uff09\u3002 \u5ba2\u6237\u7aef\u53ef\u4ee5\u4f7f\u7528 <code>iscsiadm</code> \u7684 <code>--rescan</code> \u9009\u9879\u6765\u91cd\u65b0\u626b\u63cf\u8bbe\u5907\uff1a</p> <pre><code>$ sudo iscsiadm -m session --rescan\nRescanning session [sid: 4, target: iqn.2024-03.org.example.201:test-target, portal: 127.0.0.1,3260]\n$ lsblk\nNAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS\nsda      8:0    0     1G  0 disk \nsdb      8:16   0     1G  0 disk \nsr0     11:0    1 932.3M  0 rom  \nvda    254:0    0    50G  0 disk \n\u2514\u2500vda1 254:1    0    50G  0 part \n$ # \u591a\u51fa\u4e86\u65b0\u6dfb\u52a0\u7684 sdb\n</code></pre> <p>\u53e6\u4e00\u70b9\u9700\u8981\u6ce8\u610f\u7684\u662f\u5f00\u673a\u65f6\u7684\u914d\u7f6e\uff0c\u867d\u7136 <code>iscsid.service</code> \u4f1a\u5728\u5f00\u673a\u65f6\u81ea\u52a8\u542f\u7528\uff0c\u4f46\u662f\u767b\u5f55\u64cd\u4f5c\u9ed8\u8ba4\u4e0d\u662f\u81ea\u52a8\u7684\u3002 \u8fd9\u4e00\u70b9\u53ef\u4ee5\u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u786e\u8ba4\uff1a</p> <pre><code>$ cat /etc/iscsi/iscsid.conf | grep node.startup\n# node.startup = automatic\nnode.startup = manual\n$ sudo cat /etc/iscsi/nodes/iqn.2024-03.org.example.201\\:test-target/127.0.0.1\\,3260\\,1/default | grep startup\nnode.startup = manual\nnode.conn[0].startup = manual\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u4fee\u6539\u76f8\u5173\u914d\u7f6e\uff08\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff09\uff1a</p> <pre><code>iscsiadm -m node -T iqn.2024-03.org.example.201:test-target -p 127.0.0.1 -o update -n node.startup -v automatic\niscsiadm -m node -T iqn.2024-03.org.example.201:test-target -p 127.0.0.1 -o update -n node.conn[0].startup -v automatic\n</code></pre> <p><code>open-iscsi.service</code> \u5728\u5f00\u673a\u65f6\u4f1a\u81ea\u52a8\u767b\u5f55\u6240\u6709\u914d\u7f6e\u597d\u7684 target\u3002</p>"},{"location":"ops/storage/raid/","title":"RAID","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>\u672c\u6587\u4ecb\u7ecd\u5e38\u89c1\u7684 RAID \u65b9\u6848\u7684\u4f7f\u7528\u4e0e\u7ef4\u62a4\u3002 \u76f4\u63a5\u4f7f\u7528 LVM \u521b\u5efa RAID \u7684\u65b9\u6cd5\u8bf7\u53c2\u8003 LVM\uff1b \u4f7f\u7528 ZFS \u521b\u5efa RAID \u7684\u65b9\u6cd5\u8bf7\u53c2\u8003 ZFS\u3002</p> <p>\u672c\u90e8\u5206\u4e0d\u6d89\u53ca FakeRAID\uff08\u4f8b\u5982 Intel Rapid Storage Technology\uff09\u3002 \u5efa\u8bae\u9605\u8bfb\u4ee5\u4e0b\u5185\u5bb9\u524d\uff0c\u5148\u9605\u8bfb LVM \u4e2d\u4e0e RAID \u76f8\u5173\u7684\u90e8\u5206\u3002</p>"},{"location":"ops/storage/raid/#mdadm","title":"mdadm","text":"<p>mdadm \u662f Linux \u4e0a\u6700\u5e38\u7528\u7684\u8f6f\u4ef6 RAID \u65b9\u6848\u3002 \u5728\u4e0b\u9762\u7684\u6b65\u9aa4\u4e2d\uff0c\u4e0e LVM \u4e00\u7ae0\u7c7b\u4f3c\uff0c\u6211\u4eec\u4f7f\u7528\u672c\u5730\u56de\u73af\u521b\u5efa\u4e09\u4e2a\u5757\u8bbe\u5907\u3002 \u540c\u6837\u5730\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u5f3a\u70c8\u5efa\u8bae\u5148\u5206\u533a\u518d\u521b\u5efa RAID\u3002</p> <pre><code>$ truncate -s 1G md0.img md1.img md2.img\n$ sudo losetup -f --show md0.img\n/dev/loop0\n$ sudo losetup -f --show md1.img\n/dev/loop1\n$ sudo losetup -f --show md2.img\n/dev/loop2\n</code></pre>"},{"location":"ops/storage/raid/#mdadm-create","title":"\u521b\u5efa RAID","text":"<p>\u6211\u4eec\u5148\u4ee5 RAID 0 \u4e3a\u4f8b\uff0c\u521b\u5efa\u4e00\u4e2a\u8de8 3 \u5757\u76d8\u7684 RAID 0\u3002</p> <pre><code>$ sudo mdadm --create /dev/md0 --level=0 --raid-devices=3 /dev/loop0 /dev/loop1 /dev/loop2\nmdadm: Defaulting to version 1.2 metadata\nmdadm: array /dev/md0 started.\n</code></pre> <p>\u5f97\u5230\u7684 <code>/dev/md0</code> \u5c31\u662f\u521b\u5efa\u5b8c\u6210\u7684 RAID \u5757\u8bbe\u5907\uff0c\u5b83\u7684\u5927\u5c0f\u662f\u7ea6 3G\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>mdadm --detail</code> \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\u3002</p> <pre><code>$ sudo mdadm --detail /dev/md0\n/dev/md0:\n           Version : 1.2\n     Creation Time : Wed Feb 21 00:54:02 2024\n        Raid Level : raid0\n        Array Size : 3139584 (2.99 GiB 3.21 GB)\n      Raid Devices : 3\n     Total Devices : 3\n       Persistence : Superblock is persistent\n\n       Update Time : Wed Feb 21 00:54:02 2024\n             State : clean \n    Active Devices : 3\n   Working Devices : 3\n    Failed Devices : 0\n     Spare Devices : 0\n\n            Layout : -unknown-\n        Chunk Size : 512K\n\nConsistency Policy : none\n\n              Name : hostname:0  (local to host hostname)\n              UUID : 119661ca:ff0a76b7:28909e39:18af76dc\n            Events : 0\n\n    Number   Major   Minor   RaidDevice State\n       0       7        0        0      active sync   /dev/loop0\n       1       7        1        1      active sync   /dev/loop1\n       2       7        2        2      active sync   /dev/loop2\n</code></pre> <p>\u5bf9\u5e94\u7684\u72b6\u6001\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>/proc/mdstat</code> \u67e5\u770b\uff1a</p> <pre><code>$ cat /proc/mdstat\nPersonalities : [raid6] [raid5] [raid4] [raid1] [raid0] \nmd0 : active raid0 loop2[2] loop1[1] loop0[0]\n      3139584 blocks super 1.2 512k chunks\n\nunused devices: &lt;none&gt;\n</code></pre> <p>\u4f7f\u7528 <code>--stop</code> \u9009\u9879\u505c\u6b62 RAID\uff1a</p> <pre><code>$ sudo mdadm --stop /dev/md0\nmdadm: stopped /dev/md0\n$ ls -lha /dev/md0\nls: cannot access '/dev/md0': No such file or directory\n</code></pre> <p>\u5728 stop \u4e4b\u540e\uff0c\u5982\u679c\u9700\u8981\u518d\u6062\u590d\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>--assemble</code> \u9009\u9879\uff1a</p> <pre><code>$ sudo mdadm --assemble /dev/md0 /dev/loop0 /dev/loop1 /dev/loop2\nmdadm: /dev/md0 has been started with 3 drives.\n$ # \u6216\u8005\u4f7f\u7528 --scan \u53c2\u6570\uff1a\n$ sudo mdadm --assemble --scan\nmdadm: /dev/md/0 has been started with 3 drives.\n</code></pre> <p>\u5c06\u8fd9\u4e2a RAID 0 \u62c6\u6389\uff0c\u7136\u540e\u8bd5\u8bd5\u7ec4\u5efa RAID 1\u3001RAID 5\uff1a</p> <pre><code>$ # RAID 1\n$ sudo mdadm --stop /dev/md0\nmdadm: stopped /dev/md0\n$ sudo mdadm --misc --zero-superblock /dev/loop0 /dev/loop1 /dev/loop2\n$ sudo mdadm --create /dev/md0 --level=1 --raid-devices=3 /dev/loop0 /dev/loop1 /dev/loop2\nmdadm: Note: this array has metadata at the start and\n    may not be suitable as a boot device.  If you plan to\n    store '/boot' on this device please ensure that\n    your boot-loader understands md/v1.x metadata, or use\n    --metadata=0.90\nContinue creating array? y\nmdadm: Defaulting to version 1.2 metadata\nmdadm: array /dev/md0 started.\n$ # RAID 5\n$ sudo mdadm --stop /dev/md0\nmdadm: stopped /dev/md0\n$ sudo mdadm --misc --zero-superblock /dev/loop0 /dev/loop1 /dev/loop2\n$ sudo mdadm --create /dev/md0 --level=5 --raid-devices=3 /dev/loop0 /dev/loop1 /dev/loop2\nmdadm: Defaulting to version 1.2 metadata\nmdadm: array /dev/md0 started.\n</code></pre> <p>\u5982\u679c\u5728\u91cd\u65b0\u521b\u5efa mdadm \u9635\u5217\u4e4b\u524d\u4e0d\u6e05\u7a7a superblock\uff0c\u4f1a\u8f93\u51fa\u7c7b\u4f3c\u4ee5\u4e0b\u7684\u8b66\u544a\u4fe1\u606f\uff1a</p> <pre><code>mdadm: /dev/loop0 appears to be part of a raid array:\n       level=raid0 devices=3 ctime=Wed Feb 21 00:54:02 2024\nmdadm: /dev/loop1 appears to be part of a raid array:\n       level=raid0 devices=3 ctime=Wed Feb 21 00:54:02 2024\nmdadm: /dev/loop2 appears to be part of a raid array:\n       level=raid0 devices=3 ctime=Wed Feb 21 00:54:02 2024\n</code></pre> <p>\u6b64\u5916\uff0c\u5c3d\u7ba1\u8fd9\u91cc\u4e0d\u5c55\u793a RAID10 \u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u4f46\u662f mdadm \u7684 RAID10 \u6d89\u53ca\u5230 near, far \u548c offset \u4e09\u79cd\u5e03\u5c40\u7684\u9009\u62e9\u3002 \u8be6\u7ec6\u7684\u4ecb\u7ecd\u53ef\u53c2\u8003 md(4) \u7684 \"About the RAID10 Layout Examples\" \u90e8\u5206\u3002</p> <p>\u6709\u5173 raid456 \u7684\u6027\u80fd\u4e89\u8bae</p> <p>\u5185\u6838 md \u7684 raid456 \u6a21\u5757\u4e2d\u5b9a\u4e49\u4e86\u4e00\u4e2a\u56fa\u5b9a\u5927\u5c0f\u7684 4K \"stripe\"\uff0c\u6240\u6709\u7684\u5757 IO \u64cd\u4f5c\u90fd\u4f1a\u88ab\u5148\u88ab\u5206\u6210 4K \u7684\u5757\uff0c commit \u5230\u8bbe\u5907\u4e0a\u540e\u518d\u5408\u5e76\u64cd\u4f5c\u3002\u5e76\u4e14\u76ee\u524d\u5408\u5e76\u64cd\u4f5c\u65e0\u6cd5\u6b63\u786e\u5904\u7406 trim \u6307\u4ee4\uff0c\u8fd9\u5c31\u5bfc\u81f4\u4e86\u5bf9 raid4/5/6 \u8fdb\u884c trim \u7684\u65f6\u5019\uff0c\u5168\u76d8 trim \u4f1a\u88ab\u62c6\u5206\u6210\u5927\u91cf\u7684 4k trim\uff0c\u4ece\u800c\u5bfc\u81f4 trim \u5361\u4f4f\u3002\u5728\u8fdb\u884c\u5176\u4ed6\u64cd\u4f5c\u65f6\uff0c\u4e5f\u53ef\u80fd\u53d1\u73b0\u6027\u80fd\u4e0d\u53ca\u9884\u671f\u3002</p> <p>\u76f8\u5173\u90ae\u4ef6\u8ba8\u8bba\uff1a</p> <ul> <li>https://lore.kernel.org/linux-block/ED5B1993-9D44-4B9C-A7DF-72BD2375A216@gmail.com/T/</li> <li>https://lore.kernel.org/all/5EAED86C53DED2479E3E145969315A2385841062@UMECHPA7B.easf.csd.disa.mil/T/</li> <li>https://lore.kernel.org/all/20220207152735.27381-1-vverma@digitalocean.com/</li> </ul> <p>\u611f\u8c22 @shankerwangmiao \u63d0\u4f9b\u7684\u76f8\u5173\u4fe1\u606f\u3002</p>"},{"location":"ops/storage/raid/#mdadm-rebuild","title":"\u91cd\u5efa\u64cd\u4f5c","text":"<p>\u4e0e LVM \u4e00\u7ae0\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u5c55\u793a\u5728\u4e00\u5757\u76d8\u4e22\u5931\uff08\u635f\u574f\uff09\u60c5\u51b5\u4e0b\u7684\u64cd\u4f5c\uff1a</p> <pre><code>$ sudo mdadm --stop /dev/md0\nmdadm: stopped /dev/md0\n$ sudo losetup -D\n$ sudo losetup -f --show md0.img\n/dev/loop0\n$ sudo losetup -f --show md1.img\n/dev/loop1\n$ # \u6b64\u65f6 /dev/md0 \u5df2\u7ecf\u81ea\u52a8\u6784\u5efa\uff0c\u5e76\u4e14\u5904\u4e8e\u4e22\u5931\u4e00\u5757\u76d8\u7684\u72b6\u6001\n$ sudo mdadm --detail /dev/md0\n/dev/md0:\n           Version : 1.2\n     Creation Time : Thu Feb 22 13:05:14 2024\n        Raid Level : raid5\n        Array Size : 2093056 (2044.00 MiB 2143.29 MB)\n     Used Dev Size : 1046528 (1022.00 MiB 1071.64 MB)\n      Raid Devices : 3\n     Total Devices : 2\n       Persistence : Superblock is persistent\n\n       Update Time : Thu Feb 22 13:05:19 2024\n             State : clean, degraded \n    Active Devices : 2\n   Working Devices : 2\n    Failed Devices : 0\n     Spare Devices : 0\n\n            Layout : left-symmetric\n        Chunk Size : 512K\n\nConsistency Policy : resync\n\n              Name : hostname:0  (local to host hostname)\n              UUID : 3e4455f5:65e4251c:b21c1c81:13b44a8b\n            Events : 18\n\n    Number   Major   Minor   RaidDevice State\n       0       7        0        0      active sync   /dev/loop0\n       1       7        1        1      active sync   /dev/loop1\n       -       0        0        2      removed\n$ # \u6dfb\u52a0\u65b0\u7684\u76d8\n$ truncate -s 1G md3.img\n$ sudo losetup /dev/loop3 md3.img\n$ sudo mdadm --add /dev/md0 /dev/loop3\n$ sudo mdadm --detail /dev/md0\n/dev/md0:\n           Version : 1.2\n     Creation Time : Thu Feb 22 13:05:14 2024\n        Raid Level : raid5\n        Array Size : 2093056 (2044.00 MiB 2143.29 MB)\n     Used Dev Size : 1046528 (1022.00 MiB 1071.64 MB)\n      Raid Devices : 3\n     Total Devices : 3\n       Persistence : Superblock is persistent\n\n       Update Time : Thu Feb 22 13:52:32 2024\n             State : clean, degraded, recovering \n    Active Devices : 2\n   Working Devices : 3\n    Failed Devices : 0\n     Spare Devices : 1\n\n            Layout : left-symmetric\n        Chunk Size : 512K\n\nConsistency Policy : resync\n\n    Rebuild Status : 35% complete\n\n              Name : hostname:0  (local to host hostname)\n              UUID : 3e4455f5:65e4251c:b21c1c81:13b44a8b\n            Events : 26\n\n    Number   Major   Minor   RaidDevice State\n       0       7        0        0      active sync   /dev/loop0\n       1       7        1        1      active sync   /dev/loop1\n       3       7        3        2      spare rebuilding   /dev/loop3\n</code></pre> <p>\u6dfb\u52a0\u65b0\u76d8\u540e\uff0c\u53ef\u4ee5\u770b\u5230\u91cd\u5efa\u64cd\u4f5c\u4f1a\u81ea\u52a8\u5f00\u59cb\u3002</p>"},{"location":"ops/storage/raid/#mdadm-scrub","title":"\u5b8c\u6574\u6027\u68c0\u67e5","text":"<p>\u8fd9\u91cc\u5c55\u793a\u4e09\u76d8 RAID 1 \u4e0b\u8fdb\u884c\u68c0\u67e5\u4e0e\u4fee\u590d\u7684\u573a\u666f\uff1a</p> <pre><code>$ sudo mdadm --stop /dev/md0\nmdadm: stopped /dev/md0\n$ sudo mdadm --misc --zero-superblock /dev/loop0 /dev/loop1 /dev/loop3\n$ sudo mdadm --create /dev/md0 --level=1 --raid-devices=3 /dev/loop0 /dev/loop1 /dev/loop3\nmdadm: Note: this array has metadata at the start and\n    may not be suitable as a boot device.  If you plan to\n    store '/boot' on this device please ensure that\n    your boot-loader understands md/v1.x metadata, or use\n    --metadata=0.90\nContinue creating array? y\nmdadm: Defaulting to version 1.2 metadata\nmdadm: array /dev/md0 started.\n$ # \u5411\u5176\u4e2d\u4e00\u5757\u76d8\u5199\u5165\u5783\u573e\u6570\u636e\n$ sudo dd if=/dev/urandom of=/dev/loop0 bs=1M count=1 oseek=100\n1+0 records in\n1+0 records out\n1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00406889 s, 258 MB/s\n$ sudo bash -c 'echo check &gt; /sys/block/md0/md/sync_action'\n$ # \u5728 /proc/mdstat \u4e2d\u53ef\u4ee5\u770b\u5230\u68c0\u67e5\u7684\u8fdb\u5ea6\n$ cat /proc/mdstat\nPersonalities : [raid6] [raid5] [raid4] [raid1] [raid0] \nmd0 : active raid1 loop3[2] loop1[1] loop0[0]\n      1046528 blocks super 1.2 [3/3] [UUU]\n      [===================&gt;.]  check = 95.3% (998016/1046528) finish=0.0min speed=249504K/sec\n\nunused devices: &lt;none&gt;\n$ # \u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u76d8\u5f88\u5c0f\uff0c\u6240\u4ee5\u68c0\u67e5\u5f88\u5feb\u5c31\u7ed3\u675f\u4e86\n$ cat /sys/block/md0/md/mismatch_cnt  # \u83b7\u53d6\u4e0d\u4e00\u81f4\u7684\u5757\u6570\n4096\n$ # \u7531\u4e8e\u6211\u4eec\u6709\u8db3\u591f\u591a\u7684\u526f\u672c\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u590d\n$ sudo bash -c 'echo repair &gt; /sys/block/md0/md/sync_action'\n$ # \u5728 /proc/mdstat \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u4fee\u590d\u7684\u8fdb\u5ea6\n$ cat /proc/mdstat\nPersonalities : [raid6] [raid5] [raid4] [raid1] [raid0] \nmd0 : active raid1 loop3[2] loop1[1] loop0[0]\n      1046528 blocks super 1.2 [3/3] [UUU]\n      [===========&gt;.........]  resync = 57.4% (601984/1046528) finish=0.0min speed=300992K/sec\n\nunused devices: &lt;none&gt;\n$ # \u4fee\u590d\u5b8c\u6210\u540e\uff0cmismatch_cnt \u4e2d\u4ecd\u7136\u8bb0\u5f55\u7684\u662f\u4e0d\u4e00\u81f4\u7684\u6570\u91cf\n$ # \u518d\u6267\u884c\u4e00\u6b21 check \u540e mismatch_cnt \u503c\u4f1a\u53d8\u4e3a 0\n</code></pre>"},{"location":"ops/storage/raid/#hardware-raid","title":"\u786c\u4ef6 RAID \u65b9\u6848","text":"<p>\u4e0d\u540c\u7684\u670d\u52a1\u5668\u53ef\u80fd\u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u786c\u4ef6 RAID \u65b9\u6848\uff0c\u76ee\u524d\u6700\u5e38\u89c1\u7684\u662f MegaRAID \u65b9\u6848\u3002 \u5728\u670d\u52a1\u5668\u542f\u52a8\u65f6\uff0c\u6309\u4e0b\u6307\u5b9a\u7684\u6309\u952e\uff0c\u53ef\u4ee5\u8fdb\u5165 RAID \u5361\u7684\u8bbe\u7f6e\u754c\u9762\u8fdb\u884c\u64cd\u4f5c\u3002</p> \u56fe\u7247\uff1a\u53ef\u80fd\u4f1a\u770b\u5230\u7684\u754c\u9762 <p> MegaRAID \u5728\u5f00\u673a\u65f6\u53ef\u4ee5\u9009\u62e9\u8fdb\u5165\u7684\u8bbe\u7f6e\u9875\u9762 </p> <p>\u540c\u65f6\uff0c\u786c\u4ef6 RAID \u5382\u5546\u4e00\u822c\u4f1a\u63d0\u4f9b\u79c1\u6709\u7684\u5de5\u5177\u8fdb\u884c\u7ba1\u7406\uff0c\u4f8b\u5982 MegaRAID \u53ef\u4ee5\u4f7f\u7528 <code>megacli</code> \u6216 <code>storcli</code>\uff0c HPE \u7684 Smart Array \u53ef\u4ee5\u4f7f\u7528 <code>ssacli</code> \u7b49\u3002 \u8fd9\u4e9b\u8f6f\u4ef6 Linux \u53d1\u884c\u7248\u4e0d\u81ea\u5e26\uff0c\u9700\u8981\u81ea\u884c\u4e0b\u8f7d\u5b89\u88c5\u3002</p> <p>\u4ee5\u4e0b\u4ecb\u7ecd MegaRAID \u76f8\u5173\u7684\u4e00\u4e9b\u64cd\u4f5c\u3002</p> <p>@taoky: \u786c\u4ef6 RAID\uff0cmd/LVM\uff0c\u8fd8\u662f ZFS\uff1f</p> <p>\u9009\u62e9\u4f55\u79cd\u65b9\u6848\uff0c\u9700\u8981\u5728\u7cfb\u7edf\u90e8\u7f72\u524d\u786e\u5b9a\u597d\uff0c\u5426\u5219\u540e\u7eed\u5207\u6362\u7684\u4ee3\u4ef7\u6781\u9ad8\u3002 \u5728\u7ea6\u5341\u5e74\u524d\uff0c\u786c\u4ef6 RAID \u662f\u5f88\u5408\u7406\u7684\u65b9\u6848\uff0c\u56e0\u4e3a\u80fd\u591f\u8282\u7701 CPU \u8ba1\u7b97\u8d44\u6e90\uff0c\u6027\u80fd\u8db3\u591f\u597d\uff0c\u914d\u7f6e\u7b80\u5355\uff0c\u800c\u4e14\u670d\u52a1\u5668\u4e00\u822c\u90fd\u4f1a\u5e26\u4e2a\u5361\u3002 \u4f46\u5728\u4eca\u5929\uff0c\u786c\u4ef6 RAID \u65b9\u6848\uff08\u4ee5\u53ca\u5757\u8bbe\u5907\u7ea7\u522b\u7684\u8f6f\u4ef6 RAID \u65b9\u6848\uff09\u53ef\u80fd\u4e0d\u603b\u662f\u6700\u4f73\u9009\u62e9\u4e86\uff1a</p> <ul> <li>CPU \u6027\u80fd\u63d0\u5347\uff0c\u4f7f\u5f97\u8f6f\u4ef6 RAID \u7684\u8ba1\u7b97\u5f00\u9500\u4e0d\u518d\u662f\u74f6\u9888</li> <li>\u8f6f\u4ef6 RAID \u65b9\u6848\u7684\u76d1\u63a7\u4e0e\u8fd0\u7ef4\u64cd\u4f5c\u66f4\u65b9\u4fbf<ul> <li>\u8003\u8651\u5230\u5382\u5546\u6df7\u4e71\u7684\u6587\u6863\u7ba1\u7406\uff0c\u6211\u6562\u80af\u5b9a\u5927\u591a\u6570\u914d\u7f6e\u786c\u4ef6 RAID \u7684\u8fd0\u7ef4\u90fd\u4e0d\u592a\u6e05\u695a\u5982\u4f55\u4f7f\u7528 MegaCLI/StorCLI \u6765\u76d1\u63a7\u786c\u76d8\u7684\u72b6\u6001</li> <li>\u5982\u679c\u6ca1\u6709\u4eba\u53bb\u673a\u623f\uff08\u6216\u8005\u53bb\u673a\u623f\u7684\u4eba don't care\uff09\uff0c\u90a3\u4e48\u7ed3\u679c\u5c31\u662f\uff1aRAID 6\uff08\u6216\u8005 RAID 10\uff09\u574f\u4e86\u4e00\u5757\u76d8 =&gt; \u6ca1\u4eba\u77e5\u9053 =&gt; \u53c8\u574f\u4e86\u4e00\u76d8 =&gt; \u8fd8\u662f\u6ca1\u4eba\u77e5\u9053\uff08\u53ef\u80fd\u4f1a\u53d1\u73b0\u670d\u52a1\u5668\u53d8\u6162\u4e86\uff09 =&gt; \u53c8\u574f\u76d8\u4e86 =&gt; \u670d\u52a1\u6302\u4e86\uff0cBoom\uff0c\u53ea\u80fd\u6c2a\u91d1\uff08\u53bb\u6570\u636e\u6062\u590d\uff09\u4e86\uff01</li> <li>\u800c\u67e5\u770b\u8f6f\u4ef6 RAID \u7684\u72b6\u6001\u5c31\u65b9\u4fbf\u5f97\u591a</li> </ul> </li> <li>\u4e0d\u53d7\u5236\u4e8e\u95ed\u6e90\u3001\u65e0\u6cd5\u8c03\u8bd5\u7684\u56fa\u4ef6<ul> <li>\u6211\u4eec\u66fe\u7ecf\u9047\u5230\u8fc7\u5728\u67d0\u53f0\u65e7\u670d\u52a1\u5668\u4e0a\uff0c\u786c\u4ef6 RAID \u5361\u56fa\u4ef6\u591a\u6b21\u5d29\u6e83\u7684\u95ee\u9898\uff0c\u6b64\u65f6\u6574\u4e2a\u9635\u5217\uff08\u5305\u62ec\u7cfb\u7edf\u76d8\uff09\u90fd\u4f1a\u6389\u7ebf</li> <li>\u5e76\u4e14\u6ca1\u6709\u4eba\u77e5\u9053\u4e3a\u4ec0\u4e48\u2014\u2014\u5f00\u653e\u7684\u8f6f\u4ef6 RAID \u65b9\u6848\u81f3\u5c11\u8fd8\u6709\u8c03\u8bd5\u7684\u673a\u4f1a</li> <li>\u5546\u4e1a SAN \u65b9\u6848\u4e5f\u6709\u7c7b\u4f3c\u7684\u95ee\u9898\u2014\u2014\u6211\u4eec\u4e5f\u9047\u5230\u8fc7 SAN \u7684\u7ba1\u7406\u53e3\u542f\u52a8\u4e00\u4f1a\u4e4b\u540e\u5c31\u76f4\u63a5\u574f\u6389\u7684\u60c5\u51b5\uff0c\u800c\u4e14\u65e0\u6cd5\u5904\u7406\uff08\u540c\u6837\uff0c\u6ca1\u6709\u4eba\u77e5\u9053\u4e3a\u4ec0\u4e48\uff09</li> </ul> </li> <li>\u6587\u4ef6\u7cfb\u7edf\u6bd4\u5757\u8bbe\u5907\uff08\u548c\u9635\u5217\u5361\uff09\u66f4\u61c2\u6570\u636e<ul> <li>ZFS/Btrfs \u7684\u91cd\u5efa\u64cd\u4f5c\u53ea\u4f1a\u6d89\u53ca\u5230\u5b9e\u9645\u7684\u6570\u636e\u5757\uff0c\u800c\u4e0d\u4f1a\u6d89\u53ca\u5230\u6574\u4e2a\u8bbe\u5907\uff0c\u51cf\u5c11\u91cd\u5efa\u65f6\u95f4\u4e0e\u98ce\u9669</li> <li>ZFS/Btrfs \u7684 checksum \u4f1a\u5728\u8bfb\u53d6\u65f6\u68c0\u67e5\u6570\u636e\u7684\u5b8c\u6574\u6027\uff0c\u5e2e\u52a9\u5904\u7406 bit rot \u95ee\u9898\uff08LVM \u7684 dm-integrity \u4e5f\u6709\u7c7b\u4f3c\u7684\u529f\u80fd\uff09</li> </ul> </li> </ul> <p>\u6240\u4ee5\u76ee\u524d\u7684\u7ed3\u8bba\u662f\uff1a\u5982\u679c\u9700\u8981\u5b58\u50a8\u5927\u91cf\u7684\u6570\u636e\uff0c\u90a3\u4e48 ZFS \u7edd\u5bf9\u503c\u5f97\u4e00\u8bd5\uff08\u81f3\u4e8e Btrfs\uff0c\u53ef\u80fd\u9700\u8981\u81f3\u5c11\u7b49\u5b83\u7684 RAID 5/6 \u5b9e\u73b0\u7a33\u5b9a\u4e0b\u6765\u518d\u8bf4\u4e86\uff09\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u5982\u679c\u4f60\u5728\u4f7f\u7528 Windows Server\uff0c\u90a3\u4e48\u786c\u4ef6 RAID\u2026\u2026\u5927\u6982\u4ecd\u7136\u8fd8\u662f\u4e00\u4e2a\u633a\u4e0d\u9519\u7684\u9009\u62e9\uff1f \u5982\u679c\u613f\u610f\u5403\u8783\u87f9\u7684\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u8bd5\u8bd5 ReFS\u2026\u2026</p>"},{"location":"ops/storage/raid/#get-megaraid-tools","title":"\u83b7\u53d6\u7ba1\u7406\u8f6f\u4ef6","text":"<p>MegaCLI \u662f\u65e9\u671f\u7684 MegaRAID \u7ba1\u7406\u5de5\u5177\uff0c\u4e4b\u540e\u88ab StorCLI \u53d6\u4ee3\uff0c\u4f46\u662f\u67d0\u4e9b\u578b\u53f7\u7684\u65e7\u9635\u5217\u4ec5\u652f\u6301 MegaCLI\u3002 \u7531\u4e8e\u535a\u901a\u7684\u6587\u6863\u7ba1\u7406\u6df7\u4e71\uff0c\u627e\u5230\u9700\u8981\u7684\u7ba1\u7406\u8f6f\u4ef6\u5e76\u4e0d\u662f\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\u60c5\u3002 \u8fd9\u91cc\u63d0\u4f9b\u4e86\u4e00\u4e9b\u94fe\u63a5\uff1a</p> <p>\u5c3d\u53ef\u80fd\u4ece\u5b98\u65b9\u6765\u6e90\u83b7\u53d6\u8fd9\u4e9b\u5de5\u5177</p> <p>\u5373\u4f7f\u4f1a\u9ebb\u70e6\u4e00\u4e9b\uff0c\u5728\u4e0b\u8f7d\u524d\u786e\u8ba4\u6765\u6e90\u7ad9\u70b9\uff08\u5728\u8fd9\u91cc\u662f\u535a\u901a\uff09\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002 \u4ece\u4e0d\u660e\u7f51\u7ad9\u4e0b\u8f7d\u5de5\u5177\u5b58\u5728\u5f88\u5927\u7684\u4f9b\u5e94\u94fe\u653b\u51fb\u7684\u98ce\u9669\u3002</p> <ul> <li>\u7528\u6237\u624b\u518c\uff1ahttps://docs.broadcom.com/docs/12353236</li> <li>MegaCLI \u4e0b\u8f7d\uff1ahttps://docs.broadcom.com/docs-and-downloads/raid-controllers/raid-controllers-common-files/8-07-14_MegaCLI.zip\uff08SHA256 <code>d9b152ae3dab76a334b9251702dba3311ceed91b58aaf52d916eb4ba1c2ab6e9</code>\uff09</li> <li>StorCLI \u4e0b\u8f7d\uff1ahttps://docs.broadcom.com/docs/1232743397</li> </ul> <p>\u538b\u7f29\u5305\u4e2d\u5305\u542b\u7684\u662f rpm \u5305\uff0c\u5728\u975e rpm \u7cfb\u7684\u53d1\u884c\u7248\u4e0a\u53ef\u4ee5\u4f7f\u7528 <code>rpm2cpio</code> \u89e3\u538b\u540e\u624b\u52a8\u300c\u5b89\u88c5\u300d\uff1a</p> <pre><code>$ rpm2cpio MegaCli-8.07.14-1.noarch.rpm | cpio -div\n./opt/MegaRAID/MegaCli/MegaCli\n./opt/MegaRAID/MegaCli/MegaCli64\n./opt/MegaRAID/MegaCli/libstorelibir-2.so.14.07-0\n11194 blocks\n</code></pre> <p>\u5c06\u89e3\u538b\u51fa\u7684\u6587\u4ef6\uff08\u4e00\u822c\u90fd\u5728 <code>opt</code> \u91cc\u9762\uff09\u653e\u5230\u5408\u9002\u7684\u4f4d\u7f6e\u3002 \u5982\u679c\u5728\u8fd0\u884c\u65f6\u7f3a\u5c11\u5e93\uff08\u4f8b\u5982 <code>libncurses.so.5</code>\uff09\uff0c\u5b89\u88c5\u5bf9\u5e94\u7684\u5305\u5373\u53ef\u3002</p> <p>MegaCLI \u4e0e StorCLI \u7684\u64cd\u4f5c\u6709\u8bb8\u591a\u4e0d\u540c\uff0c\u4e0b\u9762\u4e3b\u8981\u5c55\u793a StorCLI \u7684\u64cd\u4f5c\u3002 MegaCLI \u7684\u76f8\u4f3c\u547d\u4ee4\u4f1a\u6298\u53e0\u7ed9\u51fa\uff08\u4ee5\u4e0b\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e24\u8005\u5c55\u793a\u7684\u662f\u4e0d\u540c\u7684\u9635\u5217\uff09\u3002</p> <p>\u4f7f\u7528\u65f6\u52a0\u4e0a <code>-NoLog</code> (MegaCLI) / <code>nolog</code> (StorCLI) \u53c2\u6570</p> <p>MegaRAID \u7684\u8fd9\u4e24\u4e2a\u5de5\u5177\u9ed8\u8ba4\u6bcf\u6b21\u6267\u884c\u90fd\u4f1a\u5728\u5f53\u524d\u5de5\u4f5c\u76ee\u5f55\u521b\u5efa\u65e5\u5fd7\u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>-NoLog</code> \u6216 <code>nolog</code> \u53c2\u6570\u7981\u7528\u3002</p> <p>StorCLI \u7684 JSON \u652f\u6301</p> <p>StorCLI \u652f\u6301\u8f93\u51fa JSON \u683c\u5f0f\u7684\u4fe1\u606f\uff0c\u8fd9\u5bf9\u7a0b\u5e8f\u5316\u89e3\u6790 RAID \u9635\u5217\u72b6\u6001\u5f88\u6709\u5e2e\u52a9\u3002 \u5728\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0 <code>J</code> \u5373\u53ef\uff0c\u5982\uff1a</p> <pre><code>$ sudo ./storcli64 /c0 show all nolog J\n{\n\"Controllers\":[\n{\n  \"Command Status\" : {\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n</code></pre>"},{"location":"ops/storage/raid/#megaraid-basics","title":"\u57fa\u7840\u6982\u5ff5","text":"<p>MegaRAID \u652f\u6301\u7ba1\u7406\u591a\u4e2a RAID \u63a7\u5236\u5668\uff08Adapter/Controller\uff09\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u53ef\u4ee5\u8fde\u63a5\u4e00\u4e2a\u6216\u591a\u4e2a\u673a\u67dc\uff08Enclosure\uff09\uff0c \u673a\u67dc\u4e2d\u6709\u7269\u7406\u78c1\u76d8\uff08Physical Drive, PD\uff09\uff0c\u8fd9\u4e9b\u78c1\u76d8\u53ef\u4ee5\u7ec4\u6210\u865a\u62df\u78c1\u76d8\uff08Virtual Drive, VD \u6216 Logical Drive, LD\uff09\u3002</p> <p>\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u63a7\u5236\u5668\uff0c\u4ee5\u53ca\u5176\u63a7\u5236\u7684\u673a\u67dc\u3001\u7269\u7406/\u865a\u62df\u78c1\u76d8\u7684\u76f8\u5173\u4fe1\u606f\uff1a</p> <pre><code>$ sudo ./storcli64 /c0 show all nolog  # /c0 \u8868\u793a\u63a7\u5236\u5668 0\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 /call \u8868\u793a\u6240\u6709\u63a7\u5236\u5668\nGenerating detailed summary of the adapter, it may take a while to complete.\n\nCLI Version = 007.1513.0000.0000 Apr 01, 2021\nOperating system = Linux 5.10.0-21-amd64\nController = 0\nStatus = Success\nDescription = None\n\uff08\u4ee5\u4e0b\u7701\u7565\uff1b\u4e0a\u9762\u7684\u90e8\u5206\u6bcf\u6b21 storcli \u6b63\u786e\u6267\u884c\u65f6\u90fd\u4f1a\u8f93\u51fa\uff0c\u6240\u4ee5\u4e0b\u9762\u4e5f\u4f1a\u7701\u7565\uff09\n$ sudo ./storcli64 /c0 /eall show all nolog  # \u4e5f\u53ef\u4ee5\u4f7f\u7528 /e252 \u8868\u793a\u673a\u67dc 252\n...\nEnclosure /c0/e252  :\n===================\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n$ sudo ./storcli64 /c0 /e252 /sall show all nolog\n...\nDrive /c0/e252/s0 :\n=================\n\n--------------------------------------------------------------------------------\nEID:Slt DID State DG     Size Intf Med SED PI SeSz Model                Sp Type \n--------------------------------------------------------------------------------\n252:0     8 Onln   0 9.094 TB SATA HDD N   N  512B HGST HUH721010ALE600 U  -    \n--------------------------------------------------------------------------------\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n$ sudo ./storcli64 /c0 /vall show all nolog\n...\n/c0/v0 :\n======\n\n--------------------------------------------------------------\nDG/VD TYPE  State Access Consist Cache Cac sCC      Size Name \n--------------------------------------------------------------\n0/0   RAID6 Optl  RW     Yes     NRWTC -   ON  36.380 TB      \n--------------------------------------------------------------\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n</code></pre> MegaCLI alternative <pre><code>$ sudo ./MegaCli64 -AdpallInfo -a0 -NoLog  # \u4f7f\u7528 -aALL \u8868\u793a\u6240\u6709\u63a7\u5236\u5668\n\nAdapter #0\n\n==============================================================================\n                    Versions\n                ================\nProduct Name    : PERC 6/i Integrated\nSerial No       : 1122334455667788\nFW Package Build: 6.3.3.0002\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n$ sudo ./MegaCli64 -EncInfo -a0 -NoLog\n\nNumber of enclosures on adapter 0 -- 1\n\nEnclosure 0:\nDevice ID                     : 32\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n$ sudo ./MegaCli64 -PDList -a0 -NoLog\n\nAdapter #0\n\nEnclosure Device ID: 32\nSlot Number: 2\nDrive's position: DiskGroup: 1, Span: 0, Arm: 0\nEnclosure position: N/A\nDevice Id: 2\nWWN: \nSequence Number: 2\nMedia Error Count: 0\nOther Error Count: 50107\nPredictive Failure Count: 0\nLast Predictive Failure Event Seq Number: 0\nPD Type: SATA\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n$ sudo ./MegaCli64 -LDInfo -Lall -a0 -NoLog\n\n\nAdapter 0 -- Virtual Drive Information:\nVirtual Drive: 0 (Target Id: 0)\nName                :sys\nRAID Level          : Primary-1, Secondary-0, RAID Level Qualifier-0\nSize                : 931.0 GB\nSector Size         : 512\nMirror Data         : 931.0 GB\nState               : Degraded\nStrip Size          : 64 KB\nNumber Of Drives    : 2\nSpan Depth          : 1\nDefault Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache if Bad BBU\nCurrent Cache Policy: WriteBack, ReadAheadNone, Direct, No Write Cache if Bad BBU\nDefault Access Policy: Read/Write\nCurrent Access Policy: Read/Write\nDisk Cache Policy   : Disk's Default\nEncryption Type     : None\nIs VD Cached: No\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n</code></pre>"},{"location":"ops/storage/raid/#megaraid-maintenance","title":"\u7ef4\u62a4\u64cd\u4f5c","text":""},{"location":"ops/storage/raid/#megaraid-battery","title":"\u7535\u6c60\u72b6\u6001","text":"<p>MegaRAID \u63a7\u5236\u5668\u4e00\u822c\u4f1a\u6709\u4e00\u4e2a\u7535\u6c60\uff08Battery Backup Unit, BBU\uff09\u7528\u4e8e\u4fdd\u62a4\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u3002 \u5f53\u610f\u5916\u65ad\u7535\u7684\u60c5\u51b5\u53d1\u751f\u65f6\uff0c\u7535\u6c60\u4f1a\u652f\u6491\u63a7\u5236\u5668\u5c06\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\uff0c\u4ee5\u907f\u514d\u6570\u636e\u4e22\u5931\u3002 \u5728\u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u5982\u679c\u7535\u6c60\u635f\u574f\uff0c\u90a3\u4e48\u63a7\u5236\u5668\u4e0d\u4f1a\u4f7f\u7528\u7f13\u5b58\uff08WriteBack\uff09\u6a21\u5f0f\uff0c\u800c\u662f\u4f7f\u7528\u76f4\u5199\uff08WriteThrough\uff09\u6a21\u5f0f\uff0c\u9020\u6210\u5199\u5165\u6027\u80fd\u4e0b\u964d\u3002 \u5728\u67d0\u4e9b\u63a7\u5236\u5668\u4e0a\uff0c\u8fd9\u9879\u529f\u80fd\u662f\u7531\u79f0\u4e4b\u4e3a CacheVault \u7684\u6280\u672f\u5b9e\u73b0\u7684\u3002</p> <pre><code>$ sudo ./storcli64 /c0 /bbu show all\n...\nDetailed Status :\n===============\n\n--------------------------------------\nCtrl Status Property ErrMsg     ErrCd \n--------------------------------------\n   0 Failed -        use /cx/cv   255 \n--------------------------------------\n$ # \u8fd9\u91cc\u63d0\u793a\u4f7f\u7528 /cx/cv \u67e5\u770b CacheVault \u7684\u72b6\u6001\n$ sudo ./storcli64 /c0 /cv show all\n...\nCachevault_Info :\n===============\n\n--------------------\nProperty    Value   \n--------------------\nType        CVPM02  \nTemperature 20 C    \nState       Optimal \n--------------------\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n</code></pre> MegaCLI alternative <pre><code>$ sudo ./MegaCli64 -AdpBbuCmd -a0 -NoLog\n\nBBU status for Adapter: 0\n\nBatteryType: BBU\nVoltage: 3991 mV\nCurrent: 0 mA\nTemperature: 22 C\nBattery State: Optimal\n\uff08\u4ee5\u4e0b\u7701\u7565\uff09\n</code></pre> <p>MegaCLI \u53ef\u80fd\u4e0d\u652f\u6301 CacheVault\u3002</p> <p>RAID 5/6 write hole \u95ee\u9898</p> <p>\u5728\u8ba8\u8bba RAID 5/6 \u7684\u53ef\u9760\u6027\uff0c\u4ee5\u53ca\u4e3a\u4ec0\u4e48 btrfs \u4e00\u76f4\u6ca1\u6709\u7a33\u5b9a\u7684 RAID 5/6 \u652f\u6301\u65f6\uff0c\u7ecf\u5e38\u4f1a\u63d0\u5230 write hole \u95ee\u9898\u3002 \u5728 RAID 5/6 \u9635\u5217\u4e2d\uff0c\u5728\u6bcf\u5757\u76d8\u5199\u5165\u7684\u6570\u636e\u90fd\u9700\u8981\u4fdd\u6301\u4e00\u81f4\u6027\uff08\u5305\u62ec parity\uff09\uff0c\u4f46\u662f\u9635\u5217\u7684\u5199\u5165\u64cd\u4f5c\u4e0d\u662f\u300c\u539f\u5b50\u300d\u7684\u3002 \u8fd9\u610f\u5473\u7740\u6bcf\u6b21\u5199\u5165\u65f6\uff0c\u9635\u5217\u5728\u4e8b\u5b9e\u4e0a\u6709\u4e00\u5c0f\u6bb5\u65f6\u95f4\u662f\u4e0d\u4e00\u81f4\u7684\u3002 \u5982\u679c\u7a81\u7136\u65ad\u7535\uff0c\u5c31\u53ef\u80fd\u4ea7\u751f\u4e0d\u4e00\u81f4\u3002\u5982\u679c\u8fd9\u79cd\u4e0d\u4e00\u81f4\u51fa\u73b0\u5728 parity \u4e2d\uff0c\u8fd9\u6837\u7684\u9519\u8bef\u4e0d\u53ef\u80fd\u88ab\u6587\u4ef6\u7cfb\u7edf\u68c0\u6d4b\u5230\uff0c \u90a3\u4e48\u5c31\u53ef\u80fd\u5728\u672a\u6765\u91cd\u5efa\u65f6\u6062\u590d\u51fa\u9519\u8bef\u7684\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e\u786c\u4ef6 RAID\uff0c\u8bbe\u7f6e\u7535\u6c60\u4e00\u822c\u5373\u53ef\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002\u4f46\u662f\u5bf9\u4e8e\u8f6f\u4ef6 RAID \u6765\u8bf4\u5c31\u9ebb\u70e6\u4e00\u4e9b\u4e86\u3002Linux \u7684 md \u652f\u6301\u4e24\u79cd\u65b9\u6cd5\uff1a \u8bbe\u7f6e\u4e00\u4e2a\u989d\u5916\u7684\u8bbe\u5907\u7528\u6765\u505a dirty stripe journal\uff0c\u6216\u8005\u5bf9\u4e8e RAID 5\uff0c\u5728 RAID \u5143\u6570\u636e\u4e2d\u5b58\u50a8 partial parity log\u3002</p> <p>ZFS \u7684 raidz1/2/3 \u4e0d\u53d7 write hole \u5f71\u54cd\u3002</p>"},{"location":"ops/storage/raid/#megaraid-scrub","title":"\u5b8c\u6574\u6027\u68c0\u67e5","text":"<p>\u4e0b\u9762\u7684\u90e8\u5206\u5185\u5bb9\u6ca1\u6709\u547d\u4ee4\u8f93\u51fa\u5c55\u793a</p> <p>\u7531\u4e8e\u6ca1\u6709\u6d4b\u8bd5\u6761\u4ef6\uff0c\u56e0\u6b64\u4e0b\u9762\u7684\u90e8\u5206\u9700\u8981\u5bf9\u78c1\u76d8\u72b6\u6001\u4f5c\u4fee\u6539\u7684\u5185\u5bb9\u4ec5\u4f5c\u793a\u4f8b\u3002</p> <p>MegaRAID \u9635\u5217\u5361\u9ed8\u8ba4\u5b9a\u671f\u8fdb\u884c\u5b8c\u6574\u6027\u68c0\u67e5\uff08Consistency Check\uff09\u4e0e Patrol Read\uff1b \u524d\u8005\u68c0\u67e5\u9635\u5217\u4e2d\u7684\u6570\u636e\u662f\u5426\u4e00\u81f4\uff0c\u540e\u8005\u68c0\u67e5\u7269\u7406\u78c1\u76d8\u662f\u5426\u6709\u574f\u9053\u7b49\u95ee\u9898\u3002 \u53ef\u4ee5\u67e5\u770b\u9635\u5217\u7684\u5b8c\u6574\u6027\u68c0\u67e5\u4e0e Patrol Read \u72b6\u6001\uff1a</p> <pre><code>$ sudo ./storcli64 /c0 show cc nolog\n...\nController Properties :\n=====================\n\n-----------------------------------------------\nCtrl_Prop                 Value                \n-----------------------------------------------\nCC Operation Mode         Concurrent           \nCC Execution Delay        168 hours            \nCC Next Starttime         02/17/2024, 03:00:00 \nCC Current State          Active               \nCC Number of iterations   110                  \nCC Number of VD completed 0                    \nCC Excluded VDs           None                 \n-----------------------------------------------\n$ sudo ./storcli64 /c0 show patrolRead nolog\n...\nController Properties :\n=====================\n\n---------------------------------------------\nCtrl_Prop               Value                \n---------------------------------------------\nPR Mode                 Auto                 \nPR Execution Delay      168 hours            \nPR iterations completed 18                   \nPR Next Start time      09/17/2022, 03:00:00 \nPR on SSD               Disabled             \nPR Current State        Active 0             \nPR Excluded VDs         None                 \nPR MaxConcurrentPd      255                  \n---------------------------------------------\n</code></pre> <p>\u68c0\u67e5\u9635\u5217\u5361\u7684\u65f6\u95f4</p> <p>\u9635\u5217\u5361\u7684\u65f6\u95f4\u53ef\u80fd\u4e0e\u7cfb\u7edf\u65f6\u95f4\u4e0d\u4e00\u81f4\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>/cx show time</code> (StorCLI) / <code>-AdpGetTime -ax</code> (MegaCLI) \u67e5\u770b\u3002</p> MegaCLI alternative <pre><code>$ sudo ./MegaCli64 -AdpCcSched -Info -a0 -NoLog\n\nAdapter #0\n\nOperation Mode: Disabled\nExecution Delay: 168\nNext start time: 09/02/2023, 03:00:00\nCurrent State: Stopped\nNumber of iterations: 0\nNumber of VD completed: 0\nExcluded VDs          : None\nExit Code: 0x00\n$ sudo ./MegaCli64 -AdpPR -Info -a0 -NoLog\n\nAdapter 0: Patrol Read Information:\n\nPatrol Read Mode: Auto\nPatrol Read Execution Delay: 168 hours\nNumber of iterations completed: 591 \nNext start time: 02/26/2024, 21:00:00\nCurrent State: Stopped\nPatrol Read on SSD Devices: Disabled\n\nExit Code: 0x00\n</code></pre>"},{"location":"ops/storage/raid/#megaraid-rebuild","title":"\u91cd\u5efa\u64cd\u4f5c","text":"<p>\u5728\u66ff\u6362\u574f\u76d8\u540e\uff0c\u9635\u5217\u5361\u4f1a\u81ea\u52a8\u5f00\u59cb\u91cd\u5efa\u64cd\u4f5c\u3002 \u5982\u679c\u5728\u6709\u76d8\u635f\u574f\u65f6\u6709\u70ed\u5907\u76d8\uff08Spare\uff09\uff0c\u90a3\u4e48\u9635\u5217\u5361\u4f1a\u81ea\u52a8\u5c06\u70ed\u5907\u76d8\u52a0\u5165\u9635\u5217\u5e76\u5f00\u59cb\u91cd\u5efa\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u9635\u5217\u5361\u4f1a\u5728\u91cd\u5efa\u65f6\u9650\u5236 IO \u6027\u80fd\uff0c\u8fd9\u4e2a\u6307\u6807\u53ef\u4ee5\u901a\u8fc7 <code>rebuildrate</code> \u53c2\u6570\u8c03\u6574\uff08\u9ed8\u8ba4\u4e3a 30%\uff09\uff1a</p> <pre><code>$ sudo ./storcli64 /c0 show rebuildrate nolog\n...\nController Properties :\n=====================\n\n------------------\nCtrl_Prop   Value \n------------------\nRebuildrate 30%   \n------------------\n$ sudo ./storcli64 /c0 set rebuildrate=60 nolog\n...\nController Properties :\n=====================\n\n------------------\nCtrl_Prop   Value \n------------------\nRebuildrate 60%   \n------------------\n</code></pre> MegaCLI alternative <pre><code>$ sudo ./MegaCli64 -AdpGetProp RebuildRate -a0 -NoLog\n\nAdapter 0: Rebuild Rate = 30%\n\nExit Code: 0x00\n$ sudo ./MegaCli64 -AdpSetProp RebuildRate -60 -a0 -NoLog\n\nAdapter 0: Set rebuild rate to 60% success.\n\nExit Code: 0x00\n</code></pre> <p>\u5728\u91cd\u5efa\u65f6\uff0c\u4e5f\u53ef\u4ee5\u67e5\u770b\u91cd\u5efa\u7684\u8fdb\u5ea6\uff1a</p> <pre><code>sudo ./storcli64 /c0 /sx show rebuild nolog\n</code></pre> MegaCLI alternative <pre><code>$ sudo ./MegaCli64 -PDRbld -ShowProg -PhysDrv [252:7] -a0 -NoLog\n\nRebuild Progress on Device at Enclosure 252, Slot 7 Completed 8% in 39 Minutes.\n\nExit Code: 0x00\n</code></pre>"},{"location":"ops/storage/raid/#megaraid-ident","title":"\u78c1\u76d8\u8bc6\u522b","text":"<p>\u5728\u78c1\u76d8\u635f\u574f\u7684\u65f6\u5019\uff0c\u6258\u67b6\u4e0a\u7684 LED \u706f\u4e00\u822c\u4f1a\u4eae\u7ea2\u6216\u9ec4\u706f\uff0c\u4fbf\u4e8e\u641c\u7d22\u3002 \u4f46\u662f\u6709\u7684\u65f6\u5019\u6211\u4eec\u6709\u627e\u5230\u67d0\u5757\u786c\u76d8\u7684\u9700\u6c42\uff08\u5373\u4f7f\u5b83\u8fd8\u6ca1\u6709\u88ab\u9635\u5217\u5361\u8bc6\u522b\u4e3a\u635f\u574f\uff09\u3002 MegaRAID \u7684\u5de5\u5177\u53ef\u4ee5\u63a7\u5236\u786c\u76d8\u7684 LED \u706f\uff0c\u4fbf\u4e8e\u627e\u5230\u5bf9\u5e94\u7684\u786c\u76d8\u3002</p> <pre><code># \u5f00\u59cb\u95ea\u70c1\u5bf9\u5e94\u786c\u76d8\u7684 LED \u706f\nsudo ./storcli64 /c0 /e252 /s0 locate start nolog\n# \u505c\u6b62\u95ea\u70c1\nsudo ./storcli64 /c0 /e252 /s0 locate stop nolog\n</code></pre> MegaCLI alternative <pre><code># \u5f00\u59cb\u95ea\u70c1\nsudo ./MegaCli64 -PdLocate -start -physdrv[252:0] -a0 -NoLog\n# \u505c\u6b62\u95ea\u70c1\nsudo ./MegaCli64 -PdLocate -stop -physdrv[252:0] -a0 -NoLog\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u8ba9\u9635\u5217\u5361\u53d1\u51fa\u58f0\u97f3\u2026\u2026</p> <p>\u53ef\u4ee5\u914d\u7f6e\u9635\u5217\u5361\u5728\u9635\u5217\u51fa\u73b0\u5f02\u5e38\u60c5\u51b5\u65f6\u53d1\u51fa\u58f0\u97f3\uff0c\u8fd9\u53ef\u4ee5\u5e2e\u52a9\u5728\u673a\u623f\u7684\u7cfb\u7edf\u7ba1\u7406\u5458\u53d1\u73b0\u5f02\u5e38\u60c5\u51b5\u3002 \u53ef\u4ee5\u4f7f\u7528 <code>show alarm</code> (StorCLI) / <code>-AdpGetProp AlarmDsply</code> (MegaCLI) \u663e\u793a\u5f53\u524d\u7684\u914d\u7f6e\u60c5\u51b5\u3002</p> <pre><code>$ sudo ./storcli64 /c0 show alarm nolog\n...\nController Properties :\n=====================\n\n----------------\nCtrl_Prop Value \n----------------\nAlarm     ON    \n----------------\n</code></pre>"},{"location":"ops/storage/raid/#raid-fs","title":"RAID \u4e0e\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u5728 RAID \u9635\u5217\u4e2d\uff0c\"chunk\" \u6307\u6bcf\u5757\u76d8\u4e0a\u7684\u6570\u636e\u5757\u5927\u5c0f\uff0c\u4f8b\u5982\u4ee5\u4e0b RAID 0 \u7684\u5e03\u5c40\u8868\uff1a</p> Disk 0 Disk 1 0 1 2 3 ... ... <p>\u5176\u4e2d\u7684 0, 1, 2, 3 \u7b49\u6bcf\u4e00\u9879\u90fd\u662f\u4e00\u4e2a chunk\u3002Chunk \u901a\u5e38\u6bd4\u6247\u533a\uff08512B \u6216 4KB\uff09\u5927\u5f97\u591a\uff0c\u4f8b\u5982 64KB \u6216 128KB\u3002 \u6bcf\u884c\u7684 chunk \u5c31\u7ec4\u6210\u6761\u5e26\uff08stripe\uff09\u3002 \u6587\u4ef6\u7cfb\u7edf\u5728\u683c\u5f0f\u5316\u65f6\uff0c\u4e5f\u53ef\u4ee5\u63d0\u4f9b RAID \u76f8\u5173\u7684\u4fe1\u606f\uff0c\u5e2e\u52a9\u5408\u7406\u5e03\u5c40\u6570\u636e\u3002</p> <p>\u5bf9\u4e8e ext4 \u6587\u4ef6\u7cfb\u7edf\uff0c<code>mkfs.ext4 -E</code> \u4e2d\u7684 <code>stride</code> \u4e0e <code>stripe_width</code> \u53c2\u6570\u53ef\u4ee5\u7528\u6765\u63d0\u4f9b RAID \u9635\u5217\u7684\u4fe1\u606f\uff1a</p> <ul> <li><code>stride</code> \u662f chunk \u9664\u4ee5 block size\uff08\u4e00\u822c\u4e3a 4k\uff09\u7684\u7ed3\u679c\uff0c\u5373\u5728\u79fb\u52a8\u5230\u4e0b\u4e00\u5757\u76d8\u4e4b\u524d\u4f1a\u5904\u7406\u7684 block \u7684\u6570\u91cf</li> <li><code>stripe_width</code> \u662f stripe \u7684\u5757\u6570\uff08stride * \u5b9e\u9645\u6570\u636e\u76d8\u6570\uff0c\u4e0d\u5305\u542b parity \u76d8\uff09</li> </ul> <p>\u800c\u5bf9\u4e8e XFS \u6587\u4ef6\u7cfb\u7edf\uff0c\u5176\u80fd\u591f\u81ea\u52a8\u8bc6\u522b\u8f6f\u4ef6 RAID \u7684\u4fe1\u606f\u3002\u5728\u4f7f\u7528\u786c\u4ef6 RAID \u7684\u60c5\u51b5\u4e0b\uff0c\u5219\u9700\u8981\u5728 <code>mkfs.xfs -d</code> \u7684\u65f6\u5019 \u8003\u8651 <code>sunit</code> \u4e0e <code>swidth</code> \u53c2\u6570\uff1a</p> <ul> <li><code>sunit</code> \u662f chunk \u9664\u4ee5\u6247\u533a\uff08512B\uff09\u7684\u7ed3\u679c</li> <li><code>swidth</code> \u5219\u662f <code>sunit</code> \u4e58\u4ee5\u5b9e\u9645\u6570\u636e\u76d8\u6570</li> </ul>"},{"location":"ops/storage/raid/#monitor","title":"\u76d1\u63a7","text":""},{"location":"ops/storage/raid/#smart","title":"SMART \u4fe1\u606f","text":"<p>\u9605\u8bfb SMART \u4fe1\u606f\u53ef\u4ee5\u5e2e\u52a9\u4e86\u89e3\u786c\u76d8\u7684\u5065\u5eb7\u72b6\u6001\u3002\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u5982\u679c\u4f7f\u7528\u786c\u4ef6 RAID\uff0c\u4f7f\u7528 <code>smartctl</code> \u9700\u8981\u6dfb\u52a0\u989d\u5916\u7684\u53c2\u6570\u6765\u4ece RAID \u63a7\u5236\u5668\u83b7\u53d6\u771f\u5b9e\u7684\u78c1\u76d8\u4fe1\u606f\uff0c\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo smartctl --scan\n/dev/sda -d scsi # /dev/sda, SCSI device\n/dev/sdb -d scsi # /dev/sdb, SCSI device\n/dev/sdc -d scsi # /dev/sdc, SCSI device\n/dev/sdd -d scsi # /dev/sdd, SCSI device\n/dev/bus/4 -d megaraid,8 # /dev/bus/4 [megaraid_disk_08], SCSI device\n/dev/bus/4 -d megaraid,9 # /dev/bus/4 [megaraid_disk_09], SCSI device\n/dev/bus/4 -d megaraid,10 # /dev/bus/4 [megaraid_disk_10], SCSI device\n/dev/bus/4 -d megaraid,11 # /dev/bus/4 [megaraid_disk_11], SCSI device\n/dev/bus/4 -d megaraid,12 # /dev/bus/4 [megaraid_disk_12], SCSI device\n/dev/bus/4 -d megaraid,13 # /dev/bus/4 [megaraid_disk_13], SCSI device\n/dev/bus/4 -d megaraid,14 # /dev/bus/4 [megaraid_disk_14], SCSI device\n/dev/bus/4 -d megaraid,15 # /dev/bus/4 [megaraid_disk_15], SCSI device\n/dev/bus/0 -d megaraid,8 # /dev/bus/0 [megaraid_disk_08], SCSI device\n/dev/bus/0 -d megaraid,9 # /dev/bus/0 [megaraid_disk_09], SCSI device\n/dev/bus/0 -d megaraid,10 # /dev/bus/0 [megaraid_disk_10], SCSI device\n/dev/bus/0 -d megaraid,11 # /dev/bus/0 [megaraid_disk_11], SCSI device\n/dev/bus/0 -d megaraid,12 # /dev/bus/0 [megaraid_disk_12], SCSI device\n/dev/bus/0 -d megaraid,13 # /dev/bus/0 [megaraid_disk_13], SCSI device\n$ sudo smartctl -a /dev/sdd  # \u76f4\u63a5\u67e5\u8be2\u53ea\u80fd\u770b\u5230\u6ca1\u6709\u610f\u4e49\u7684\u63a7\u5236\u5668\u4fe1\u606f\nsmartctl 7.2 2020-12-30 r5155 [x86_64-linux-5.10.0-21-amd64] (local build)\nCopyright (C) 2002-20, Bruce Allen, Christian Franke, www.smartmontools.org\n\n=== START OF INFORMATION SECTION ===\nVendor:               AVAGO\nProduct:              MR9361-8i\nRevision:             4.68\nCompliance:           SPC-3\nUser Capacity:        1,919,816,826,880 bytes [1.91 TB]\nLogical block size:   512 bytes\nPhysical block size:  4096 bytes\nLogical Unit id:      0x600605b00f17786026223e2d33c1767b\nSerial number:        007b76c1332d3e22266078170fb00506\nDevice type:          disk\nLocal Time is:        Sun Feb 11 18:40:45 2024 CST\nSMART support is:     Unavailable - device lacks SMART capability.\n\n=== START OF READ SMART DATA SECTION ===\nCurrent Drive Temperature:     0 C\nDrive Trip Temperature:        0 C\n\nError Counter logging not supported\n\nDevice does not support Self Test logging\n$ sudo smartctl -a /dev/bus/4 -d megaraid,8  # \u6dfb\u52a0\u53c2\u6570\u53ef\u4ee5\u770b\u5230\u771f\u5b9e\u7684\u78c1\u76d8\u4fe1\u606f\n\uff08\u5185\u5bb9\u7701\u7565\uff09\n</code></pre> <p><code>smartctl -a</code> \u7684\u8f93\u51fa\u4e3b\u8981\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff1ainformation section \u548c smart data section\u3002</p> <p>Information section \u5c55\u793a\u786c\u76d8\u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5305\u62ec\u578b\u53f7\u3001\u5e8f\u5217\u53f7\u3001\u5bb9\u91cf\u3001\u56fa\u4ef6\u7248\u672c\u7b49\u3002</p> \u4e00\u5757 NVMe SSD \u7684\u4fe1\u606f\u793a\u4f8b <pre><code>=== START OF INFORMATION SECTION ===\nModel Number:                       INTEL SSDPEKNU020TZ\nSerial Number:                      PHKA119600MK2P0D\nFirmware Version:                   002C\nPCI Vendor/Subsystem ID:            0x8086\nIEEE OUI Identifier:                0x5cd2e4\nController ID:                      1\nNVMe Version:                       1.4\nNumber of Namespaces:               1\nNamespace 1 Size/Capacity:          2,048,408,248,320 [2.04 TB]\nNamespace 1 Formatted LBA Size:     512\nLocal Time is:                      Mon Feb 26 21:59:27 2024 CST\nFirmware Updates (0x14):            2 Slots, no Reset required\nOptional Admin Commands (0x0017):   Security Format Frmw_DL Self_Test\nOptional NVM Commands (0x005f):     Comp Wr_Unc DS_Mngmt Wr_Zero Sav/Sel_Feat Timestmp\nLog Page Attributes (0x0f):         S/H_per_NS Cmd_Eff_Lg Ext_Get_Lg Telmtry_Lg\nMaximum Data Transfer Size:         64 Pages\nWarning  Comp. Temp. Threshold:     77 Celsius\nCritical Comp. Temp. Threshold:     80 Celsius\n\nSupported Power States\nSt Op     Max   Active     Idle   RL RT WL WT  Ent_Lat  Ex_Lat\n0 +     5.50W       -        -    0  0  0  0        0       0\n1 +     3.60W       -        -    1  1  1  1        0       0\n2 +     2.60W       -        -    2  2  2  2        0       0\n3 -   0.0250W       -        -    3  3  3  3     5000    5000\n4 -   0.0040W       -        -    4  4  4  4     3000   11999\n\nSupported LBA Sizes (NSID 0x1)\nId Fmt  Data  Metadt  Rel_Perf\n0 +     512       0         0\n</code></pre> \u4e00\u5757 SATA SSD \u7684\u4fe1\u606f\u793a\u4f8b <pre><code>=== START OF INFORMATION SECTION ===\nModel Family:     Intel S4510/S4610/S4500/S4600 Series SSDs\nDevice Model:     INTEL SSDSC2KB019T8\nSerial Number:    PHYF8314006P1P9DGM\nLU WWN Device Id: 5 5cd2e4 14fa8880b\nFirmware Version: XCV10165\nUser Capacity:    1,920,383,410,176 bytes [1.92 TB]\nSector Sizes:     512 bytes logical, 4096 bytes physical\nRotation Rate:    Solid State Device\nForm Factor:      2.5 inches\nTRIM Command:     Available, deterministic, zeroed\nDevice is:        In smartctl database [for details use: -P show]\nATA Version is:   ACS-3 T13/2161-D revision 5\nSATA Version is:  SATA 3.2, 6.0 Gb/s (current: 6.0 Gb/s)\nLocal Time is:    Mon Feb 26 22:13:57 2024 CST\nSMART support is: Available - device has SMART capability.\nSMART support is: Enabled\n</code></pre> \u4e00\u5757 SATA HDD \u7684\u4fe1\u606f\u793a\u4f8b <pre><code>=== START OF INFORMATION SECTION ===\nModel Family:     Hitachi Ultrastar A7K2000\nDevice Model:     Hitachi HUA722020ALA330\nSerial Number:    JK11A4B8KKLUDX\nLU WWN Device Id: 5 000cca 222f24777\nFirmware Version: JKAOA3EA\nUser Capacity:    2,000,398,934,016 bytes [2.00 TB]\nSector Size:      512 bytes logical/physical\nRotation Rate:    7200 rpm\nForm Factor:      3.5 inches\nDevice is:        In smartctl database [for details use: -P show]\nATA Version is:   ATA8-ACS T13/1699-D revision 4\nSATA Version is:  SATA 2.6, 3.0 Gb/s\nLocal Time is:    Mon Feb 26 22:15:41 2024 CST\nSMART support is: Available - device has SMART capability.\nSMART support is: Enabled\n</code></pre> \u4e00\u5757 SAS HDD \u7684\u4fe1\u606f\u793a\u4f8b <pre><code>=== START OF INFORMATION SECTION ===\nVendor:               WDC\nProduct:              WUH721818AL5206\nRevision:             C240\nCompliance:           SPC-5\nUser Capacity:        18,000,207,937,536 bytes [18.0 TB]\nLogical block size:   512 bytes\nPhysical block size:  4096 bytes\nLU is fully provisioned\nRotation Rate:        7200 rpm\nForm Factor:          3.5 inches\nLogical Unit id:      0x5000cca2a909e560\nSerial number:        3JG5ER6G\nDevice type:          disk\nTransport protocol:   SAS (SPL-4)\nLocal Time is:        Mon Feb 26 22:21:06 2024 CST\nSMART support is:     Available - device has SMART capability.\nSMART support is:     Enabled\nTemperature Warning:  Enabled\n</code></pre> <p>\u68c0\u67e5\u786c\u76d8\u7684\u56fa\u4ef6\u7248\u672c</p> <p>\u6570\u636e\u4e2d\u5fc3\u76d8\u7684 SSD \u8fd1\u5e74\u6765\u6709\u591a\u8d77\u56e0\u4e3a\u56fa\u4ef6\u95ee\u9898\u5bfc\u81f4\u4f7f\u7528\u65f6\u95f4\u8fc7\u957f\uff08\u51e0\u4e07\u5c0f\u65f6\uff09\u540e\u76d8\u574f\u6389\u7684\u65b0\u95fb\uff1a</p> <ul> <li>Time to Patch: HPE SSDs Will Fail After 32,768 Hours</li> <li>SSD drives' 40,000-hour \"death bug\" continues to catch enterprises unawares</li> </ul> <p>\u5bf9\u4e8e\u670d\u52a1\u5668\u573a\u666f\uff0c\u8fd9\u7c7b\u4e8b\u4ef6\u4e00\u65e6\u53d1\u751f\uff0c\u540e\u679c\u6781\u5176\u4e25\u91cd\uff0c\u56e0\u4e3a\u914d\u7f6e\u65b0\u670d\u52a1\u5668\u65f6\uff0c\u5f88\u591a\u65f6\u5019\u4f7f\u7528\u7684\u76d8\u578b\u53f7\u662f\u4e00\u6837\u7684\uff0c\u5bfc\u81f4\u5f00\u673a\u65f6\u95f4\u4e5f\u662f\u4e00\u6837\u7684\uff0c \u56e0\u6b64\u51fa\u73b0\u95ee\u9898\u4e4b\u540e\uff0c\u6240\u6709\u76d8\u90fd\u4f1a\u5728\u77ed\u65f6\u95f4\u5185\u574f\u6389\uff0cRAID \u7684\u5197\u4f59\u518d\u9ad8\u4e5f\u65e0\u529b\u56de\u5929\u3002</p> <p>\u5373\u4f7f\u662f\u9762\u5411\u4e2a\u4eba\u7528\u6237\u7684\u4ea7\u54c1\uff0c\u4e5f\u51fa\u73b0\u8fc7\u56fa\u4ef6\u95ee\u9898\u5bfc\u81f4 SSD \u5728\u77ed\u65f6\u95f4\u5185\u635f\u574f\u7684\u60c5\u51b5\u3002 \u56e0\u6b64\u68c0\u67e5\u56fa\u4ef6\u7248\u672c\uff08\u4ee5\u53ca\u5173\u6ce8\u76f8\u5173\u4fe1\u606f\uff09\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002<code>smartctl</code> \u63d0\u4f9b\u7684\u4fe1\u606f\u4e2d\u5305\u542b\u4e86\u56fa\u4ef6\u7248\u672c\uff0c\u53ef\u4ee5\u7528\u4f5c\u641c\u7d22\u3001\u81ea\u67e5\u7684\u53c2\u8003\u3002</p> <p>\u4e00\u90e8\u5206\u5382\u5546\u63d0\u4f9b\u4e86 fwupd \u652f\u6301\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fdb\u884c\u56fa\u4ef6\u7248\u672c\u7684\u68c0\u67e5\u4e0e\u5347\u7ea7\uff1b\u800c\u53e6\u4e00\u4e9b\u5c31\u9700\u8981\u81ea\u5df1\u53bb\u641c\u7d22\u76f8\u5173\u5de5\u5177\u8fdb\u884c\u5347\u7ea7\u3002 \u6211\u4eec\u7684\u6587\u6863\u8bb0\u5f55\u4e86\u5728\u4e24\u5757\u76d8\u9047\u5230\u56fa\u4ef6\u5bfc\u81f4\u7684\u635f\u574f\u540e\u5347\u7ea7 Intel SSD \u56fa\u4ef6\uff08XCV10100 -&gt; XCV10110\uff09\u7684\u60e8\u75db\u7ecf\u5386\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u53c2\u8003\u3002</p> <p>Smart data section \u5219\u5c55\u793a\u4e86\u786c\u76d8\u7684 SMART \u4fe1\u606f\u3002\u5176\u4e2d\u81ea\u68c0\u4fe1\u606f\u4e0e\u9519\u8bef\u8bb0\u5f55\u5747\u4f1a\u663e\u793a\uff0c\u5176\u4ed6\u7684\u90e8\u5206\u89c6\u786c\u76d8\u7c7b\u578b\u800c\u5b9a\u3002</p> \u4e00\u5757 NVMe SSD \u7684 SMART \u6570\u636e\u793a\u4f8b <pre><code>=== START OF SMART DATA SECTION ===\nSMART overall-health self-assessment test result: PASSED\n\nSMART/Health Information (NVMe Log 0x02)\nCritical Warning:                   0x00\nTemperature:                        38 Celsius\nAvailable Spare:                    100%\nAvailable Spare Threshold:          10%\nPercentage Used:                    2%\nData Units Read:                    84,073,721 [43.0 TB]\nData Units Written:                 61,243,095 [31.3 TB]\nHost Read Commands:                 447,275,235\nHost Write Commands:                1,184,078,579\nController Busy Time:               9,203\nPower Cycles:                       77\nPower On Hours:                     14,101\nUnsafe Shutdowns:                   25\nMedia and Data Integrity Errors:    0\nError Information Log Entries:      0\nWarning  Comp. Temperature Time:    0\nCritical Comp. Temperature Time:    0\n\nError Information (NVMe Log 0x01, 16 of 256 entries)\nNo Errors Logged\n\nRead Self-test Log failed: Invalid Field in Command (0x002)\n</code></pre> <p>\u5bf9\u4e8e NVMe SSD \u6765\u8bf4\uff0c\u5173\u6ce8\u7684\u91cd\u70b9\u662f\uff1a</p> <ul> <li>\u5199\u5165\u91cf\u4e0e\u5bff\u547d\uff1aAvailable Spare\u3001Percentage Used\u3001Data Units Written</li> <li>\u51fa\u73b0\u9519\u8bef\u7684\u6b21\u6570\uff1aMedia and Data Integrity Errors</li> </ul> \u4e00\u5757 SATA SSD \u7684 SMART \u6570\u636e\u793a\u4f8b <pre><code>=== START OF READ SMART DATA SECTION ===\nSMART overall-health self-assessment test result: PASSED\n\nGeneral SMART Values:\nOffline data collection status:  (0x00) Offline data collection activity\n                    was never started.\n                    Auto Offline Data Collection: Disabled.\nSelf-test execution status:      (   0) The previous self-test routine completed\n                    without error or no self-test has ever \n                    been run.\nTotal time to complete Offline \ndata collection:        (    0) seconds.\nOffline data collection\ncapabilities:            (0x79) SMART execute Offline immediate.\n                    No Auto Offline data collection support.\n                    Suspend Offline collection upon new\n                    command.\n                    Offline surface scan supported.\n                    Self-test supported.\n                    Conveyance Self-test supported.\n                    Selective Self-test supported.\nSMART capabilities:            (0x0003) Saves SMART data before entering\n                    power-saving mode.\n                    Supports SMART auto save timer.\nError logging capability:        (0x01) Error logging supported.\n                    General Purpose Logging supported.\nShort self-test routine \nrecommended polling time:    (   1) minutes.\nExtended self-test routine\nrecommended polling time:    (   2) minutes.\nConveyance self-test routine\nrecommended polling time:    (   2) minutes.\nSCT capabilities:          (0x003d) SCT Status supported.\n                    SCT Error Recovery Control supported.\n                    SCT Feature Control supported.\n                    SCT Data Table supported.\n\nSMART Attributes Data Structure revision number: 1\nVendor Specific SMART Attributes with Thresholds:\nID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE\n5 Reallocated_Sector_Ct   0x0032   100   100   000    Old_age   Always       -       0\n9 Power_On_Hours          0x0032   100   100   000    Old_age   Always       -       41492\n12 Power_Cycle_Count       0x0032   100   100   000    Old_age   Always       -       22\n170 Available_Reservd_Space 0x0033   100   100   010    Pre-fail  Always       -       0\n171 Program_Fail_Count      0x0032   100   100   000    Old_age   Always       -       0\n172 Erase_Fail_Count        0x0032   100   100   000    Old_age   Always       -       0\n174 Unsafe_Shutdown_Count   0x0032   100   100   000    Old_age   Always       -       18\n175 Power_Loss_Cap_Test     0x0033   100   100   010    Pre-fail  Always       -       2561 (22 65535)\n183 SATA_Downshift_Count    0x0032   100   100   000    Old_age   Always       -       0\n184 End-to-End_Error_Count  0x0033   100   100   090    Pre-fail  Always       -       0\n187 Uncorrectable_Error_Cnt 0x0032   100   100   000    Old_age   Always       -       0\n190 Drive_Temperature       0x0022   079   073   000    Old_age   Always       -       21 (Min/Max 19/27)\n192 Unsafe_Shutdown_Count   0x0032   100   100   000    Old_age   Always       -       18\n194 Temperature_Celsius     0x0022   100   100   000    Old_age   Always       -       21\n197 Pending_Sector_Count    0x0012   100   100   000    Old_age   Always       -       0\n199 CRC_Error_Count         0x003e   100   100   000    Old_age   Always       -       0\n225 Host_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       1627966\n226 Workld_Media_Wear_Indic 0x0032   100   100   000    Old_age   Always       -       1177\n227 Workld_Host_Reads_Perc  0x0032   100   100   000    Old_age   Always       -       20\n228 Workload_Minutes        0x0032   100   100   000    Old_age   Always       -       2489558\n232 Available_Reservd_Space 0x0033   100   100   010    Pre-fail  Always       -       0\n233 Media_Wearout_Indicator 0x0032   099   099   000    Old_age   Always       -       0\n234 Thermal_Throttle_Status 0x0032   100   100   000    Old_age   Always       -       0/0\n235 Power_Loss_Cap_Test     0x0033   100   100   010    Pre-fail  Always       -       2561 (22 65535)\n241 Host_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       1627966\n242 Host_Reads_32MiB        0x0032   100   100   000    Old_age   Always       -       407022\n243 NAND_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       8173747\n\nSMART Error Log Version: 1\nNo Errors Logged\n\nSMART Self-test log structure revision number 1\nNo self-tests have been logged.  [To run self-tests, use: smartctl -t]\n\nSMART Selective self-test log data structure revision number 1\nSPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS\n    1        0        0  Not_testing\n    2        0        0  Not_testing\n    3        0        0  Not_testing\n    4        0        0  Not_testing\n    5        0        0  Not_testing\nSelective self-test flags (0x0):\nAfter scanning selected spans, do NOT read-scan remainder of disk.\nIf Selective self-test is pending on power-up, resume after 0 minute delay.\n</code></pre> <p>\u8fd9\u91cc\u4e3b\u8981\u5173\u6ce8 attributes \u8868\u4e2d\u7684\u503c\u3002Attributes \u5206\u4e3a\u4e24\u7c7b\uff0c\"Pre-fail\" \u4ee3\u8868\u5176\u5f02\u5e38\u9884\u793a\u7740\u786c\u76d8\u4f1a\u5728\u4e0d\u4e45\u7684\u5c06\u6765\u51fa\u73b0\u95ee\u9898\uff0c\"Old_age\" \u5219\u8868\u793a\u786c\u76d8\u968f\u65f6\u95f4\u8001\u5316\u7684\u6307\u6807\u3002 Value \u4e3a 100\uff08\u6709\u4e9b\u786c\u76d8\u7684\u8d77\u59cb\u503c\u4f1a\u66f4\u9ad8\uff09\u901a\u5e38\u8868\u793a\u6700\u4f73\u6307\u6807\uff0c\u968f\u7740\u4f7f\u7528\u9010\u6e10\u964d\u4f4e\u3002Worst \u5219\u8bb0\u5f55\u5386\u53f2\u6700\u5dee\uff08\u6700\u4f4e\uff09\u503c\uff0c\u5982\u679c\u503c\u4f4e\u4e8e\u9608\u503c\uff08Threshold\uff09\uff0c\u5219\u4ee3\u8868\u786c\u76d8\u51fa\u73b0\u4e86\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8e SSD \u6765\u8bf4\uff0c\u9664\u4e86 Pre-fail \u4ee5\u5916\uff0c\u9700\u8981\u989d\u5916\u5173\u6ce8\u4e0e wearout\uff08\u78e8\u635f\uff09\u6709\u5173\u7684\u6307\u6807\u3002</p> \u4e00\u5757 SATA HDD \u7684 SMART \u6570\u636e\u793a\u4f8b <pre><code>=== START OF READ SMART DATA SECTION ===\nSMART Status not supported: ATA return descriptor not supported by controller firmware\nSMART overall-health self-assessment test result: PASSED\nWarning: This result is based on an Attribute check.\n\nGeneral SMART Values:\nOffline data collection status:  (0x82) Offline data collection activity\n                    was completed without error.\n                    Auto Offline Data Collection: Enabled.\nSelf-test execution status:      (   0) The previous self-test routine completed\n                    without error or no self-test has ever \n                    been run.\nTotal time to complete Offline \ndata collection:        (21007) seconds.\nOffline data collection\ncapabilities:            (0x5b) SMART execute Offline immediate.\n                    Auto Offline data collection on/off support.\n                    Suspend Offline collection upon new\n                    command.\n                    Offline surface scan supported.\n                    Self-test supported.\n                    No Conveyance Self-test supported.\n                    Selective Self-test supported.\nSMART capabilities:            (0x0003) Saves SMART data before entering\n                    power-saving mode.\n                    Supports SMART auto save timer.\nError logging capability:        (0x01) Error logging supported.\n                    General Purpose Logging supported.\nShort self-test routine \nrecommended polling time:    (   1) minutes.\nExtended self-test routine\nrecommended polling time:    ( 350) minutes.\nSCT capabilities:          (0x003d) SCT Status supported.\n                    SCT Error Recovery Control supported.\n                    SCT Feature Control supported.\n                    SCT Data Table supported.\n\nSMART Attributes Data Structure revision number: 16\nVendor Specific SMART Attributes with Thresholds:\nID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE\n1 Raw_Read_Error_Rate     0x000b   100   100   016    Pre-fail  Always       -       0\n2 Throughput_Performance  0x0005   133   133   054    Pre-fail  Offline      -       102\n3 Spin_Up_Time            0x0007   119   119   024    Pre-fail  Always       -       604 (Average 610)\n4 Start_Stop_Count        0x0012   100   100   000    Old_age   Always       -       104\n5 Reallocated_Sector_Ct   0x0033   100   100   005    Pre-fail  Always       -       0\n7 Seek_Error_Rate         0x000b   100   100   067    Pre-fail  Always       -       0\n8 Seek_Time_Performance   0x0005   121   121   020    Pre-fail  Offline      -       35\n9 Power_On_Hours          0x0012   084   084   000    Old_age   Always       -       113016\n10 Spin_Retry_Count        0x0013   100   100   060    Pre-fail  Always       -       0\n12 Power_Cycle_Count       0x0032   100   100   000    Old_age   Always       -       104\n192 Power-Off_Retract_Count 0x0032   100   100   000    Old_age   Always       -       129\n193 Load_Cycle_Count        0x0012   100   100   000    Old_age   Always       -       129\n194 Temperature_Celsius     0x0002   181   181   000    Old_age   Always       -       33 (Min/Max 17/56)\n196 Reallocated_Event_Count 0x0032   100   100   000    Old_age   Always       -       0\n197 Current_Pending_Sector  0x0022   100   100   000    Old_age   Always       -       0\n198 Offline_Uncorrectable   0x0008   100   100   000    Old_age   Offline      -       0\n199 UDMA_CRC_Error_Count    0x000a   200   200   000    Old_age   Always       -       1\n\nSMART Error Log Version: 0\nNo Errors Logged\n\nSMART Self-test log structure revision number 1\nNo self-tests have been logged.  [To run self-tests, use: smartctl -t]\n\nSMART Selective self-test log data structure revision number 1\nSPAN  MIN_LBA  MAX_LBA  CURRENT_TEST_STATUS\n    1        0        0  Not_testing\n    2        0        0  Not_testing\n    3        0        0  Not_testing\n    4        0        0  Not_testing\n    5        0        0  Not_testing\nSelective self-test flags (0x0):\nAfter scanning selected spans, do NOT read-scan remainder of disk.\nIf Selective self-test is pending on power-up, resume after 0 minute delay.\n</code></pre> <p>\u9605\u8bfb attributes \u7684\u65b9\u6cd5\u53c2\u89c1\u4e0a\u9762\u7684 SATA SSD \u7684\u793a\u4f8b\u3002</p> \u4e00\u5757 SAS HDD \u7684 SMART \u6570\u636e\u793a\u4f8b <pre><code>=== START OF READ SMART DATA SECTION ===\nSMART Health Status: OK\n\nGrown defects during certification &lt;not available&gt;\nTotal blocks reassigned during format &lt;not available&gt;\nTotal new blocks reassigned &lt;not available&gt;\nPower on minutes since format &lt;not available&gt;\nCurrent Drive Temperature:     26 C\nDrive Trip Temperature:        85 C\n\nAccumulated power on time, hours:minutes 3632:21\nManufactured in week 44 of year 2021\nSpecified cycle count over device lifetime:  50000\nAccumulated start-stop cycles:  6\nSpecified load-unload count over device lifetime:  600000\nAccumulated load-unload cycles:  155\nElements in grown defect list: 0\n\nError counter log:\n        Errors Corrected by           Total   Correction     Gigabytes    Total\n            ECC          rereads/    errors   algorithm      processed    uncorrected\n        fast | delayed   rewrites  corrected  invocations   [10^9 bytes]  errors\nread:          0        0         0         0          3       1235.896           0\nwrite:         0        0         0         0         30        595.461           0\nverify:        0        0         0         0         28          0.000           0\n\nNon-medium error count:        0\n\nNo Self-tests have been logged\n</code></pre> <p>\u5b89\u88c5 smartmontools \u4e4b\u540e\uff0c\u53ef\u4ee5\u542f\u7528 smartd \u670d\u52a1\uff08smartd.service \u6216 smartmontools.service\uff09\u3002 \u8be5\u670d\u52a1\u4f1a\u6bcf\u9694\u4e00\u6bb5\u65f6\u95f4\u68c0\u67e5\u786c\u76d8\u7684 SMART \u4fe1\u606f\uff0c\u5e76\u5728\u53d1\u73b0\u95ee\u9898\u65f6\u53d1\u9001\u90ae\u4ef6\u901a\u77e5\u7ba1\u7406\u5458\uff08\u5728\u6b63\u786e\u914d\u7f6e\u7684\u60c5\u51b5\u4e0b\uff09\u3002 \u9ed8\u8ba4 Debian \u63d0\u4f9b\u7684 <code>/etc/smartd.conf</code> \u7684\u6709\u6548\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>DEVICESCAN -d removable -n standby -m root -M exec /usr/share/smartmontools/smartd-runner\n</code></pre> <p><code>/usr/share/smartmontools/smartd-runner</code> \u4f1a\u8c03\u7528 <code>/etc/smartmontools/run.d/</code> \u4e0b\u7684\u6587\u4ef6\uff0c \u5176\u4e2d\u9ed8\u8ba4\u63d0\u4f9b\u7684 <code>10mail</code> \u4f1a\u4f7f\u7528\u7cfb\u7edf\u7684 <code>mail</code> \u547d\u4ee4\u53d1\u9001\u90ae\u4ef6\u3002</p> \u90ae\u4ef6\u6837\u4f8b <pre><code>This message was generated by the smartd daemon running on:\n\n   host name:  example\n   DNS domain: vm.example.org\n\nThe following warning/error was logged by the smartd daemon:\n\nDevice: /dev/sdh [SAT], FAILED SMART self-check. BACK UP DATA NOW!\n\nDevice info:\nINTEL SSDSC2KB019T8, S/N:PHYF830400R01P9DGM, WWN:5-5cd2e4-14fa2d6ae, FW:XCV10165, 1.92 TB\n\nFor details see host's SYSLOG.\n\nYou can also use the smartctl utility for further investigation.\nThe original message about this issue was sent at Fri Jan 12 02:51:00 2024 CST\nAnother message will be sent in 24 hours if the problem persists.\n</code></pre> <p>\u5728\u914d\u7f6e\u4e2d\u6dfb\u52a0 <code>-M test</code> \u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u53d1\u9001\u6d4b\u8bd5\u90ae\u4ef6\u3002\u66f4\u591a\u914d\u7f6e\u8be6\u60c5\u8bf7\u53c2\u8003 <code>smartd.conf(5)</code>\u3002</p>"},{"location":"ops/storage/raid/#raid-info","title":"RAID \u4fe1\u606f","text":"<p>Linux \u7cfb\u7edf\u4e0b\u7684\u8f6f\u4ef6 RAID \u65b9\u6848\u4e00\u822c\u90fd\u4f1a\u63d0\u4f9b\u4f7f\u7528\u90ae\u4ef6\u901a\u77e5\u7ba1\u7406\u5458\u5f02\u5e38\u60c5\u51b5\u7684\u529f\u80fd\u3002 mdadm \u4e0e ZFS \u65b9\u6848\u5747\u652f\u6301\u90ae\u4ef6\u901a\u77e5\u3002\u800c LVM \u4e0d\u5305\u542b\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u9700\u8981\u7cfb\u7edf\u7ba1\u7406\u5458\u989d\u5916\u8bbe\u7f6e\u5b9a\u65f6\u4efb\u52a1\u6765\u68c0\u67e5\u3002</p> <p>\u9664\u4e86\u5728\u5f02\u5e38\u60c5\u51b5\u4e0b\u53d1\u9001\u90ae\u4ef6\u901a\u77e5\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u76f8\u5173\u7684\u6307\u6807\u76d1\u63a7\u5de5\u5177\u6765\u76d1\u63a7 RAID \u4ee5\u53ca\u786c\u76d8 SMART \u7b49\u4fe1\u606f\u3002 \u4ee5 telegraf \u4e3a\u4f8b\uff0c\u81ea\u5e26\u7684\u4e0e\u5065\u5eb7\u5ea6\u76f8\u5173\u7684\u63d2\u4ef6\u5305\u62ec mdstat (mdadm) \u4e0e smart\u3002 \u7f16\u5199\u81ea\u5df1\u7684\u76d1\u63a7\u63d2\u4ef6\u4e5f\u5f88\u65b9\u4fbf\u3002</p> <p>USTCLUG \u76ee\u524d\u7684\u65b9\u6848</p> <p>\u6211\u4eec\u7684 RAID \u76ee\u524d\u4e3b\u8981\u6709 ZFS (zpool) \u4e0e\u786c\u4ef6 RAID \u4e24\u79cd\u3002\u524d\u8005\u6211\u4eec\u4f7f\u7528\u7684\u65b9\u6848\u662f https://github.com/iwvelando/telegraf-exec-zpool-status\uff0c \u800c\u540e\u8005\u662f @taoky \u7f16\u5199\u7684 raid-telegraf\u3002</p> <p>\u53ef\u7528\u4e8e\u5bfc\u5165\u7684 Grafana.com Dashboard \u5206\u4eab\u9875\u9762\uff0cGrafana Dashboard JSON\uff0c\u4ee5\u53ca\u53c2\u8003\u6548\u679c\u3002</p>"},{"location":"ops/storage/raid/#emergency-rescue","title":"\u7d27\u6025\u6551\u63f4","text":"<p>\u6570\u636e\u65e0\u4ef7\uff0c\u8c28\u614e\u64cd\u4f5c\uff01</p> <p>\u5982\u679c\u4e0d\u6ee1\u8db3\u4ee5\u4e0b\u4efb\u4e00\u6761\u4ef6\uff0c\u8bf7\u54a8\u8be2\u4e13\u4e1a\u7684\u6570\u636e\u6062\u590d\u516c\u53f8\uff0c\u4e0d\u8981\u8f7b\u6613\u5c1d\u8bd5\u81ea\u884c\u64cd\u4f5c\uff1a</p> <ul> <li>\u6570\u636e\u7684\u4ef7\u503c\u4e0d\u9ad8\uff0c\u53ef\u4ee5\u627f\u53d7\u4e22\u5931\u7684\u98ce\u9669</li> <li>\u6709\u8db3\u591f\u7684\u65f6\u95f4\u3001\u7cbe\u529b\uff0c\u4ee5\u53ca\u8d2d\u7f6e\u4e34\u65f6\u5b58\u50a8\u7684\u786c\u76d8\u7684\u9884\u7b97</li> <li>\u6709\u8db3\u591f\u7684\u76d8\u80fd\u88ab\u8bc6\u522b\uff0c\u5e76\u80fd\u591f\u8bfb\u53d6\u5927\u90e8\u5206\u7684\u5185\u5bb9</li> </ul> <p>\u4e5f\u53ef\u9605\u8bfb Hackergame 2021 \u9898\u76ee\u300c\u9635\u5217\u6062\u590d\u5927\u5e08\u300d\u7684\u5b98\u65b9\u9898\u89e3</p> <p>\u76f8\u5173\u5185\u5bb9\u57fa\u4e8e\u771f\u5b9e\u7684\u4e8b\u4ef6\u6539\u7f16\u3002\u8be5\u9898\u76ee\u8981\u6c42\u9009\u624b\u4ece\u5b8c\u6574\u672a\u635f\u574f\u4f46\u914d\u7f6e\u672a\u77e5\u7684 RAID \u76d8\u7ec4\u4e2d\u6062\u590d\u6570\u636e\u3002 \u9898\u76ee\u63cf\u8ff0\u4e0e\u9898\u89e3\u53c2\u89c1 https://github.com/USTC-Hackergame/hackergame2021-writeups/tree/master/official/%E9%98%B5%E5%88%97%E6%81%A2%E5%A4%8D%E5%A4%A7%E5%B8%88\u3002</p> <p>\u5c3d\u7ba1\u6ca1\u6709\u4eba\u4f1a\u60f3\u7ecf\u5386\u8fd9\u6837\u7684\u4e8b\u60c5\uff0c\u4f46\u662f\u8fd9\u79cd\u4e8b\u60c5\u786e\u5b9e\u6709\u53ef\u80fd\u4f1a\u53d1\u751f\uff0c\u7279\u522b\u662f\u5728\u7f3a\u5c11\u7ecf\u9a8c\uff0c\u6216\u76d1\u63a7\u8bbe\u65bd\u4e0d\u5b8c\u5584\u7684\u60c5\u51b5\u4e0b\u3002 \u4e0d\u8fc7\u4e00\u6761\u53ef\u80fd\u4e0d\u7b97\u90a3\u4e48\u7cdf\u7cd5\u7684\u7ecf\u9a8c\u662f\uff1a\u5728\u9635\u5217\u56e0\u4e3a\u786c\u76d8\u95ee\u9898\u4e0b\u7ebf\u7684\u65f6\u5019\uff0c\u6700\u540e\u4e00\u5757\u62a5\u544a\u635f\u574f\u7684\u786c\u76d8\u5f88\u591a\u65f6\u5019\u4ecd\u7136\u53ef\u4ee5\u8bfb\u53d6\u5927\u90e8\u5206\u5185\u5bb9\uff0c \u4e0d\u8fc7\u5728\u6b64\u4e4b\u524d\u7684\u574f\u76d8\u53ef\u80fd\u5c31\u6ca1\u90a3\u4e48\u597d\u8fd0\u4e86\u2014\u2014\u63d2\u5728\u7535\u8111\u4e0a\u5982\u679c\u53d1\u51fa\u4e86\u602a\u58f0\u97f3\uff0c\u90a3\u4e48\u591a\u534a\u662f\u771f\u7684\u574f\u4e86\u3002</p> <p>\u90a3\u4e48\u9996\u5148\u6211\u4eec\u9700\u8981\u83b7\u53d6\u6240\u6709\u8fd8\u80fd\u8bfb\u53d6\u7684\u786c\u76d8\uff0cdump \u51fa\u5bf9\u5e94\u7684\u5757\u8bbe\u5907\u5168\u90e8\u7684\u5185\u5bb9\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u5f88\u6f2b\u957f\uff0c\u800c\u4e14\u9700\u8981\u5927\u91cf\u7684\u5b58\u50a8\u7a7a\u95f4\u3002 \u5927\u90e8\u5206\u4eba\u53ef\u80fd\u4f1a\u9996\u5148\u8003\u8651\u4f7f\u7528 <code>dd</code> \u6765\u505a\u8fd9\u4e2a\u4e8b\u60c5\uff0c\u4f46\u662f\u5728\u8fd9\u79cd\u573a\u5408\u4e0b\uff0c<code>dd</code> \u4e0d\u662f\u975e\u5e38\u53ef\u9760\u2014\u2014\u5982\u679c\u9047\u5230\u4e86 I/O \u9519\u8bef\uff0c\u90a3\u4e48 <code>dd</code> \u9ed8\u8ba4\u7684\u884c\u4e3a\u662f \u76f4\u63a5\u9000\u51fa\uff0c\u5373\u4f7f\u6dfb\u52a0\u4e86 <code>conv=noerror</code> \u9009\u9879\uff0c\u5176\u586b\u5145\u7684\u884c\u4e3a\u4e5f\u662f\u4e0d\u53ef\u63a7\u7684\u3002\u56e0\u6b64\uff0c\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528 ddrescue \u8fdb\u884c\u5e94\u6025\u7684\u8bfb\u53d6\u5168\u90e8\u5757\u8bbe\u5907\u5185\u5bb9\u7684\u5de5\u4f5c\uff08\u53c2\u8003\u64cd\u4f5c\uff09\u3002</p> <p>\u5728\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c\u5f97\u5230\u7684\u6587\u4ef6\u5efa\u8bae\u8bbe\u7f6e\u53ea\u8bfb\u6216\u989d\u5916\u5907\u4efd\uff0c\u907f\u514d\u540e\u7eed\u64cd\u4f5c\u51fa\u73b0\u610f\u5916\u3002</p> <p>\u5982\u679c\u4f7f\u7528\u7684\u662f\u8f6f\u4ef6 RAID\uff0c\u90a3\u4e48\u5143\u6570\u636e\u4e00\u822c\u4f4d\u4e8e\u786c\u76d8/\u5206\u533a\u7684\u5f00\u5934\uff0c\u5982\u679c\u5e78\u8fd0\u7684\u8bdd\uff0c\u4f7f\u7528\u672c\u5730\u56de\u73af\u6302\u8f7d\u4e3a\u5757\u8bbe\u5907\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5bf9\u5e94\u7684 RAID \u5de5\u5177\u6302\u8f7d\u4e86\uff1b \u4f46\u5982\u679c\u662f\u786c\u4ef6 RAID \u7684\u8bdd\uff0c\u5c31\u6ca1\u6709\u8fd9\u4e48\u5e78\u8fd0\u4e86\u2014\u2014\u786c\u4ef6 RAID \u7684\u5143\u6570\u636e\u4e00\u822c\u4f4d\u4e8e\u786c\u76d8\u672b\u5c3e\uff0c\u4f7f\u7528\u7684\u683c\u5f0f\u4e3a DDF\uff08Disk Data Format\uff09\u3002\u5e76\u4e14\uff0c\u6ca1\u6709\u901a\u7528\u7684\u5de5\u5177\u53ef\u4ee5\u89e3\u6790 DDF \u683c\u5f0f\u7684\u5143\u6570\u636e<sup>1</sup>\uff0c\u56e0\u6b64\u9700\u8981\u81ea\u884c\u5224\u65ad RAID \u7684\u914d\u7f6e\uff0c\u4ee5\u53ca\u6bcf\u5757\u76d8\u5728\u5176\u4e2d\u7684\u4f4d\u7f6e\uff0c\u53ef\u80fd\u9700\u8981\u5728\u4e4b\u540e\u7684\u6302\u8f7d\u4e2d\u591a\u6b21\u8bd5\u9519\u540e\u624d\u80fd\u627e\u5230\u6b63\u786e\u7684\u914d\u7f6e\u3002</p> <p>\u5bf9\u4e8e RAID 0 \u7c7b\u578b\u7684\u914d\u7f6e\uff08\u5305\u62ec RAID 10/01\uff09\uff0c<code>mdadm</code> \u5de5\u5177\u652f\u6301\u62fc\u63a5\u591a\u4e2a\uff08\u6ca1\u6709 mdadm superblock \u7684\uff09\u5757\u8bbe\u5907\u7684\u5185\u5bb9\u7ec4\u6210 RAID\uff0c\u53c2\u8003\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>sudo mdadm --build --assume-clean -c 128 --level=0 --raid-devices=8 --size=195364584 /dev/md0 /dev/mapper/disk1 /dev/mapper/disk2 /dev/mapper/disk3 /dev/mapper/disk4 /dev/mapper/disk5 /dev/mapper/disk6 /dev/mapper/disk7 /dev/mapper/disk8\n</code></pre> <p>\u5982\u679c\u662f RAID 5/6\uff0c<code>mdadm</code> \u4e0d\u652f\u6301\u76f4\u63a5\u62fc\u63a5\uff0c\u9700\u8981\u4f7f\u7528 assemble \u64cd\u4f5c\uff0c\u4f46\u662f\u5bf9\u5e94\u7684\u64cd\u4f5c\u4f1a\u8986\u76d6\u6389\u6bcf\u5757\u76d8\u5f00\u5934\u7684\u4e00\u90e8\u5206<sup>2</sup>\u3002 \u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u7f16\u5199\u4f7f\u7528 fuse \u7684\u811a\u672c\u6302\u8f7d\uff0c\u66f4\u52a0\u7075\u6d3b\u4f46\u662f\u6027\u80fd\u8f83\u5dee\uff0c\u811a\u672c\u5185\u5bb9\u53ef\u53c2\u7167\u300c\u9635\u5217\u6062\u590d\u5927\u5e08\u300d\u7684\u5b98\u65b9\u9898\u89e3\u7684\u540e\u534a\u90e8\u5206\u3002</p> <p>\u5728\u6b64\u6b21\u5b9e\u9645\u7684\u4e8b\u4ef6\u4e2d\uff0c\u6700\u7ec8\u6210\u529f\u6302\u8f7d\u4e86\u6587\u4ef6\u7cfb\u7edf\u3002\u5bf9\u6587\u4ef6\u68c0\u67e5\u540e\u53d1\u73b0\u6709\u90e8\u5206\u6587\u4ef6\u635f\u574f\uff0c\u4f46\u662f\u8fd9\u4e9b\u6587\u4ef6\u90fd\u4e0d\u91cd\u8981\uff0c\u6700\u7ec8\u6210\u529f\u6062\u590d\u4e86\u6240\u6709\u91cd\u8981\u6570\u636e\u3002</p>"},{"location":"ops/storage/raid/#supplement","title":"\u8865\u5145\u9605\u8bfb","text":"<ul> <li>MegaCli wrapper for LSI MegaRAID for Debian/Ubuntu/RHEL/CentOS\uff1a\u4e00\u4e2a\u670d\u52a1\u5668\u8fd0\u7ef4\u7684 MegaCLI \u811a\u672c\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e00\u4e9b\u53ef\u4f9b\u53c2\u8003\u7684\u64cd\u4f5c\u4e0e\u63a8\u8350\u8bbe\u7f6e</li> <li>Linux Raid Wiki\uff1aLinux-raid \u90ae\u4ef6\u5217\u8868\u7684\u793e\u533a\u6210\u5458\u7ef4\u62a4\u7684 wiki\uff0c\u5305\u542b\u4e86\u5927\u91cf\u6709\u7528\u7684\u4fe1\u606f</li> </ul> <ol> <li> <p>mdadm \u5de5\u5177\u53ef\u80fd\u652f\u6301 DDF\uff0c\u4f46\u662f\u5728\u6211\u4eec\u81ea\u884c\u6570\u636e\u6062\u590d\u7684\u8fc7\u7a0b\u4e2d\u6ca1\u6709\u6210\u529f\u64cd\u4f5c\uff0c\u53ef\u80fd\u662f\u786c\u4ef6\u5382\u5546\u7684 DDF \u683c\u5f0f\u4e0e mdadm \u5b9e\u73b0\u4e0d\u7b26\u3002\u00a0\u21a9</p> </li> <li> <p>\u901a\u8fc7\u4f7f\u7528 dmsetup \u53ef\u4ee5\u5b9e\u73b0\u7c7b\u4f3c\u4e8e CoW \u7684\u64cd\u4f5c\uff1a\u5728\u53ea\u8bfb\u7684 image \u4e0a\u6dfb\u52a0\u4e00\u5c42 CoW \u7684 overlay\uff0c\u76f8\u5173\u811a\u672c\u53ef\u4ee5\u53c2\u8003 https://gist.github.com/coderjo/c8de3ecc31f1d6450254b5e97ea2c595\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/zfs/","title":"ZFS","text":"<p>\u672c\u6587\u521d\u7a3f\u7f16\u5199\u4e2d</p> <p>ZFS\uff08Zettabyte File System\uff09\u867d\u7136\u540d\u53eb\u201cFS\u201d\uff0c\u4f46\u662f\u96c6\u6210\u4e86\u4e00\u7cfb\u5217\u5b58\u50a8\u7ba1\u7406\u529f\u80fd\uff0c\u5305\u62ec\u6587\u4ef6\u7cfb\u7edf\u3001\u5377\u7ba1\u7406\u3001\u5feb\u7167\u3001\u6570\u636e\u5b8c\u6574\u6027\u68c0\u67e5\u548c\u4fee\u590d\u7b49\uff0c\u5e38\u88ab\u79f0\u4f5c\u201c\u5355\u673a\u6700\u5f3a\u5b58\u50a8\u65b9\u6848\u201d\u3002</p> <p>\u867d\u7136 ZFS \u6ca1\u6709\u7279\u6b8a\u7684\u7cfb\u7edf\u8981\u6c42\uff0c\u4f46\u662f\u6211\u4eec\u63a8\u8350\u5728\u5177\u6709\u8f83\u597d\u914d\u7f6e\u7684\u670d\u52a1\u5668\u4e0a\u4f7f\u7528 ZFS\uff0c\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd\u548c\u7a33\u5b9a\u6027\u3002</p> <ul> <li>\u56fa\u6001\u786c\u76d8\uff0c\u6216\u8005\u591a\u5757\u89c4\u683c\u76f8\u540c\u7684\u5927\u5bb9\u91cf\u673a\u68b0\u786c\u76d8\uff08\u63a8\u8350 4 \u5757\u6216\u66f4\u591a\uff09\uff0c\u5c3d\u91cf\u907f\u514d\u7528\u5355\u5757\u673a\u68b0\u786c\u76d8\u3002</li> <li>\u5982\u679c\u9884\u671f\u9700\u8981\u627f\u8f7d\u8f83\u91cd\u7684\u8bfb\u5199\u8d1f\u8f7d\uff0c\u63a8\u8350\u4f7f\u7528\u5927\u5bb9\u91cf\u5185\u5b58\u7528\u4e8e\u7f13\u5b58\uff08ZFS \u5b98\u65b9\u63a8\u8350\u6bcf 1 TB \u5b58\u50a8\u5bb9\u91cf\u914d\u7f6e 1 GB \u5185\u5b58\uff09\u3002<ul> <li>\u5982\u679c\u6253\u7b97\u542f\u7528 ZFS \u7684\u53bb\u91cd\uff08deduplication\uff09\u529f\u80fd\uff0c\u63a8\u8350\u4e3a\u6bcf TB \u5b58\u50a8\u5bb9\u91cf\u914d\u5907\u81f3\u5c11 5 GB \u5185\u5b58\uff08\u4f46\u662f\u5b98\u65b9\u63a8\u8350\u7684\u6bd4\u4f8b\u662f 30 GB\uff09\u3002</li> </ul> </li> <li>\u5982\u679c\u9884\u671f\u7684\u70ed\u6570\u636e\u91cf\u8d85\u51fa\u4e86\u5185\u5b58\u5bb9\u91cf\uff0c\u63a8\u8350\u4f7f\u7528 SSD \u4f5c\u4e3a L2ARC \u7f13\u5b58\uff0c\u4f46\u7528\u4e8e\u7f13\u5b58\u7684 SSD \u5bb9\u91cf\u4e0d\u5b9c\u8d85\u8fc7\u5185\u5b58\u7684 10 \u500d\u3002</li> <li>\u591a\u6838\u5fc3 CPU\uff0c\u4ee5\u4fbf\u5904\u7406 ZFS \u7684\u6570\u636e\u5b8c\u6574\u6027\u68c0\u67e5\u548c\u900f\u660e\u538b\u7f29\u7b49\u4efb\u52a1\u3002</li> </ul> <p>\u5982\u679c\u53ea\u662f\u4e3a\u4e86\u5c06 ZFS \u7684\u9ad8\u7ea7\u529f\u80fd\u7528\u4e8e\u4e2a\u4eba\u5b58\u50a8\uff0c\u5982 NAS \u7b49\uff0c\u90a3\u4e48\u4f60\u5927\u53ef\u5ffd\u7565\u4ee5\u4e0a\u6240\u6709\u63a8\u8350\uff0c\u5728 Intel J3455 \u548c 4 GB \u5185\u5b58\u7684\u5c0f\u4e3b\u673a\u4e0a\u5c31\u53ef\u4ee5\u8f7b\u677e\u8fd0\u884c ZFS\uff0c\u4f8b\u5982 QNAP \u7684\u4e2a\u4eba NAS \u8bbe\u5907\u5c31\u5df2\u7ecf\u9ed8\u8ba4\u91c7\u7528 ZFS \u4e86\u3002</p>"},{"location":"ops/storage/zfs/#kernel-module","title":"\u5185\u6838\u6a21\u5757","text":"<p>\u5c3d\u7ba1 OpenZFS \u4e5f\u662f\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\uff0c\u4f46\u662f\u7531\u4e8e\u5f00\u6e90\u534f\u8bae\u4e0d\u517c\u5bb9\uff08OpenZFS \u91c7\u7528 CDDL\uff0cLinux \u5185\u6838\u91c7\u7528 GPL\uff09\uff0c\u56e0\u6b64 OpenZFS \u65e0\u6cd5\u76f4\u63a5\u96c6\u6210\u5230 Linux \u5185\u6838\u4e2d\u3002</p> <ul> <li> <p>Debian \u5c06 ZFS \u7684\u4ee3\u7801\u4ee5 DKMS \u6a21\u5757\u7684\u5f62\u5f0f\u6253\u5305\uff08\u5305\u540d <code>zfs-dkms</code>\uff09\uff0c\u4ee5\u4fbf\u5728\u66f4\u65b0\u5185\u6838\u4e4b\u540e\u81ea\u52a8\u7f16\u8bd1\u548c\u5b89\u88c5\u3002</p> <p>Debian backports</p> <p>\u53d7\u9650\u4e8e Debian \u7684\u7a33\u5b9a\u6027\u653f\u7b56\uff0cstable \u7684\u8f6f\u4ef6\u6e90\u4e2d\u7684 ZFS \u7248\u672c\u53ef\u80fd\u8f83\u8001\u3002\u5982\u679c\u9700\u8981\u4f7f\u7528\u8f83\u65b0\u7684 ZFS \u7248\u672c\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 Debian \u7684 backports \u4ed3\u5e93\uff08<code>apt install -t bookworm-backports zfs-dkms</code>\uff09\u3002</p> </li> <li> <p>Ubuntu \u81ea 20.04 LTS \u8d77\u63d0\u4f9b\u9884\u7f16\u8bd1\u597d\u7684 <code>zfs.ko</code>\uff08\u8f6f\u4ef6\u5305 <code>linux-modules-$(uname -r)</code>\uff09\uff0c\u56e0\u6b64\u65e0\u9700\u518d\u5b89\u88c5 <code>zfs-dkms</code>\u3002Ubuntu 18.04 LTS \u53ca\u4e4b\u524d\u7684\u7248\u672c\u4ecd\u7136\u9700\u8981\u5b89\u88c5 <code>zfs-dkms</code>\u3002</p> </li> </ul> <p>\u4e0d\u8bba\u662f Debian \u8fd8\u662f Ubuntu\uff0c\u90fd\u9700\u8981\u5b89\u88c5 <code>zfsutils-linux</code> \u8f6f\u4ef6\u5305\uff0c\u4ee5\u4fbf\u4f7f\u7528 ZFS \u7684\u547d\u4ee4\u884c\u5de5\u5177\u3002</p>"},{"location":"ops/storage/zfs/#concepts","title":"\u57fa\u7840\u6982\u5ff5","text":"<p>\u4e0e LVM \u548c\u5176\u4ed6\u5377\u7ba1\u7406\u5de5\u5177\u7c7b\u4f3c\uff0cZFS \u4e5f\u5c06\u5b58\u50a8\u8bbe\u5907\u7ec4\u7ec7\u6210\u591a\u7ea7\u7ed3\u6784\uff1a</p> <ul> <li>vdev\uff08Virtual Device\uff09\u662f ZFS \u5bf9\u201c\u786c\u76d8\u7ec4\u201d\u7684\u62bd\u8c61\u3002\u4e00\u4e2a vdev \u53ef\u4ee5\u662f\u5355\u5757\u786c\u76d8\u3001mirror\uff08\u7c7b\u4f3c RAID 1 \u786c\u76d8\u7ec4\uff09\u6216 RAID-Z\u3001RAID-Z2\u3001RAID-Z3\uff08\u7c7b\u4f3c RAID 5\u30016\u30017 \u786c\u76d8\u7ec4\uff09\u7b49\u3002</li> <li>pool \u662f ZFS \u7684\u5b58\u50a8\u6c60\uff0c\u7531\u4e00\u4e2a\u6216\u591a\u4e2a vdev \u7ec4\u6210\uff0c\u7c7b\u4f3c LVM \u7684 VG\uff08Volume Group\uff09\u6982\u5ff5\u3002</li> <li> <p>ZFS \u7684\u6587\u4ef6\u7cfb\u7edf\u548c Zvol\uff08ZFS Volume\uff09\u90fd\u662f\u5728 pool \u4e0a\u521b\u5efa\u7684\uff0c\u7c7b\u4f3c LVM \u7684 LV\uff08Logical Volume\uff09\u6982\u5ff5\u3002</p> <p>\u4e0e LVM \u7565\u6709\u533a\u522b\u7684\u5730\u65b9\u662f\uff0cZFS \u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u76f4\u63a5\u521b\u5efa\u5728 pool \u4e0a\u7684\uff0c\u800c\u65e0\u9700\u50cf LVM \u4e00\u6837\u5148\u521b\u5efa LV\uff0c\u518d\u5c06\u5176\u683c\u5f0f\u5316\u4e3a\u67d0\u79cd\u6587\u4ef6\u7cfb\u7edf\u3002ZFS \u7684\u6587\u4ef6\u7cfb\u7edf\u5c31\u662f ZFS\u3002</p> </li> </ul>"},{"location":"ops/storage/zfs/#create-pool","title":"\u521b\u5efa pool","text":"<p>\u540c\u6837\u4e0e LVM \u4e0d\u540c\u7684\u662f\uff0cZFS \u63a8\u8350\u4f7f\u7528\u6574\u5757\u786c\u76d8\u6216\u5c3d\u53ef\u80fd\u6574\u5757\u7684\u786c\u76d8\u6765\u521b\u5efa pool\uff0c\u4ee5\u4fdd\u8bc1\u7a33\u5b9a\u7684\u6027\u80fd\u3002\u4f5c\u4e3a\u4e00\u9879\u9002\u914d\u64cd\u4f5c\uff0c\u5982\u679c\u5c06\u6574\u5757\u786c\u76d8\u7528\u4e8e\u521b\u5efa zpool\uff0cZFS \u4f1a\u81ea\u52a8\u5bf9\u5176\u8fdb\u884c\u5206\u533a\uff0c\u4ee5\u4fbf\u5728\u786c\u76d8\u6545\u969c\u65f6\u80fd\u591f\u66f4\u597d\u5730\u8bc6\u522b\u548c\u5904\u7406\u3002</p> <p>\u4ee5\u4e0b\u5047\u8bbe disk[1-3].img \u662f\u4e09\u5757\u5927\u5c0f\u76f8\u540c\u7684\u786c\u76d8\u3002</p> <pre><code>$ truncate -s 1G disk1.img disk2.img disk3.img\n$ sudo losetup -f --show disk1.img\n/dev/loop0\n$ sudo losetup -f --show disk2.img\n/dev/loop1\n$ sudo losetup -f --show disk3.img\n/dev/loop2\n$ sudo zpool create tank /dev/loop0 /dev/loop1 /dev/loop2\n$\n</code></pre> <p>\u5173\u4e8e zpool</p> <p><code>ashift</code> \u53c2\u6570\u662f ZFS \u5bf9\u201c\u78c1\u76d8\u6247\u533a\u5927\u5c0f\u201d\u7684\u7406\u89e3\uff0c\u4e14\u5728\u521b\u5efa pool \u540e\u65e0\u6cd5\u66f4\u6539\u3002 \u4e3a\u4e86\u786e\u4fdd\u6700\u4f73\u7684\u6027\u80fd\uff0c<code>ashift</code> \u53c2\u6570\u5e94\u5f53\u4e0e\u786c\u76d8\u7684\u771f\u5b9e\u6247\u533a\u5927\u5c0f\u76f8\u5339\u914d\uff0c\u65e2\u4e0d\u5b9c\u8fc7\u5927\u4e5f\u4e0d\u5b9c\u8fc7\u5c0f\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5728\u521b\u5efa zpool \u7684\u65f6\u5019\uff0cZFS \u4f1a\u81ea\u52a8\u68c0\u6d4b\u786c\u76d8\u7684\u6247\u533a\u5927\u5c0f\uff08<code>ioctl(BLKPBSZGET)</code>\uff09\u5e76\u8bbe\u7f6e\u5408\u9002\u7684 <code>ashift</code> \u53c2\u6570\u3002 \u5bf9\u4e8e\u56fa\u6001\u786c\u76d8\uff0c\u5efa\u8bae\u67e5\u9605\u786c\u76d8\u7684\u89c4\u683c\uff0c\u7136\u540e\u624b\u52a8\u6307\u5b9a <code>zpool create -o ashift=...</code>\u3002</p> <p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8bf7\u4e0d\u8981\u5c06 ZFS \u7528\u4e8e\u4efb\u4f55\u865a\u62df\u786c\u76d8\u6216\u8f6f\u4ef6/\u786c\u4ef6 RAID \u9635\u5217\u4e0a\u3002 \u53ea\u6709\u5f53 ZFS \u76f4\u63a5\u7ba1\u7406\u6bcf\u5757\u786c\u76d8\u65f6\uff0c\u624d\u80fd\u83b7\u5f97\u6700\u4f73\u7684\u6027\u80fd\u548c ZFS \u63d0\u4f9b\u7684\u6570\u636e\u5b8c\u6574\u6027\u4fdd\u8bc1\u3002 \u5982\u679c\u4f60\u7684\u9635\u5217\u5361\u4e0d\u652f\u6301\u76f4\u901a\uff0c\u53ef\u4ee5\u8003\u8651\u4e3a\u6bcf\u5757\u76d8\u5efa\u7acb\u4e00\u4e2a\u5355\u76d8\u9635\u5217\u3002</p> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u5982\u679c\u4f60\u4f7f\u7528 <code>sda</code>\u3001<code>nvme0n1</code> \u7b49\u8bbe\u5907\u540d\u6765\u521b\u5efa pool\uff0cZFS \u4f1a\u81ea\u52a8\u5bf9\u5176\u8fdb\u884c\u5206\u533a\uff0c\u7136\u540e\u4f7f\u7528 <code>sda1</code>\u3001<code>nvme0n1p1</code> \u7b49\u5206\u533a\u540d\u6765\u521b\u5efa pool\uff0c\u5e76\u5728\u6bcf\u4e2a\u76d8\u7684\u672b\u5c3e\u521b\u5efa\u4e00\u4e2a 8 MB \u7684\u5206\u533a\uff08<code>sda9</code>\u3001<code>nvme0n1p9</code>\uff09\u3002\u5206\u533a\u7684\u76ee\u7684\u53ef\u80fd\u51fa\u4e8e\u67d0\u4e9b\u5386\u53f2\u539f\u56e0\uff0c\u76ee\u524d\u65e0\u4ece\u8003\u8bc1\uff0c\u4e14\u8fd9\u4e2a\u7f16\u53f7\u4e3a 9 \u7684\u5206\u533a\u662f\u6ca1\u6709\u4efb\u4f55\u7528\u9014\u7684\u3002</p> <p>\u5728\u521b\u5efa\u597d pool \u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>zpool status</code> \u548c <code>zpool list</code> \u67e5\u770b pool \u7684\u72b6\u6001\u548c\u4f7f\u7528\u60c5\u51b5\u3002</p> <pre><code>$ zpool status\n  pool: tank\n state: ONLINE\nconfig:\n\n        NAME        STATE     READ WRITE CKSUM\n        tank        ONLINE       0     0     0\n          loop0     ONLINE       0     0     0\n          loop1     ONLINE       0     0     0\n          loop2     ONLINE       0     0     0\n\nerrors: No known data errors\n$ zpool list\nNAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT\ntank   2.81G   112K  2.81G        -         -     0%     0%  1.00x    ONLINE  -\n</code></pre> <p>Tip</p> <p>\u5728 ZFS \u4e2d\uff0c\u7edd\u5927\u591a\u6570\u8bf8\u5982\u67e5\u8be2\u72b6\u6001\u7b49\u53ea\u8bfb\u7684\u547d\u4ee4\u90fd\u4e0d\u9700\u8981 <code>sudo</code>\u3002</p> <p>\u5728\u521b\u5efa\u597d zpool <code>tank</code> \u540e\uff0cZFS \u4e5f\u81ea\u52a8\u521b\u5efa\u4e86\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf <code>tank</code> \u5e76\u6302\u8f7d\u5728\u4e86 <code>/tank</code> \u76ee\u5f55\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002</p> <p>\u53c2\u6570\u8c03\u8282</p> <p>\u5bf9\u4e8e\u65b0\u5efa\u7684 ZFS pool\uff0c\u6211\u4eec\u63a8\u8350\u8c03\u6574\u4e00\u4e9b\u53c2\u6570\u4ee5\u83b7\u5f97\u6700\u4f73\u7684\u6027\u80fd\u3002\u5177\u4f53\u53c2\u89c1\u4e0b\u9762\u7684\u53c2\u6570\u8c03\u8282\u3002</p>"},{"location":"ops/storage/zfs/#tuning","title":"\u53c2\u6570\u8c03\u8282","text":""},{"location":"ops/storage/zfs/#tuning-zpool","title":"Zpool","text":"<p>Zpool \u5c42\u9762\u7684\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7 <code>zpool set</code> \u547d\u4ee4\u8fdb\u884c\u8c03\u6574\uff0c\u4ee5\u4e0b\u662f\u4e00\u4e9b\u63a8\u8350\u4fee\u6539\u7684\u53c2\u6570\uff1a</p> <ul> <li> <p><code>autotrim=on</code>\uff1a\u5982\u679c\u4f60\u4f7f\u7528\u786c\u76d8\u662f SSD\uff0c\u542f\u7528\u6b64\u9009\u9879\u540e ZFS \u4f1a\u81ea\u52a8\u4e3a\u5df2\u5220\u9664\u7684\u6570\u636e\u5757\u5411\u786c\u76d8\u53d1\u9001 TRIM \u6307\u4ee4\u3002\u4f8b\u5982\uff1a</p> <pre><code>zpool set autotrim=on tank\n</code></pre> </li> </ul>"},{"location":"ops/storage/zfs/#tuning-zfs","title":"ZFS \u6587\u4ef6\u7cfb\u7edf","text":"<p>ZFS\uff08\u6587\u4ef6\u7cfb\u7edf\uff09\u5c42\u9762\u7684\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7 <code>zfs set</code> \u547d\u4ee4\u8fdb\u884c\u8c03\u6574\uff0c\u8bed\u6cd5\u4e0e <code>zpool set</code> \u7c7b\u4f3c\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u63a8\u8350\u4fee\u6539\u7684\u53c2\u6570\uff1a</p> <ul> <li> <p><code>xattr=sa</code>\uff1a\u5c06\u6587\u4ef6\u7684\u6269\u5c55\u5c5e\u6027\uff08\u5982 POSIX ACL \u548c SELinux \u6807\u7b7e\u7b49\uff09\u5b58\u50a8\u5728 dnode \u4e2d\uff08\u7c7b\u4f3c\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\u7684 inode\uff09\uff0c\u800c\u4e0d\u662f\u72ec\u7acb\u7684\u201c\u6587\u4ef6\u201d\u4e2d\u3002\u5bf9\u4e8e\u7ecf\u5e38\u4f7f\u7528\u6269\u5c55\u5c5e\u6027\u7684\u5e94\u7528\u573a\u666f\uff08\u5982 Samba\uff09\uff0c\u4f7f\u7528 <code>xattr=sa</code> \u53ef\u4ee5\u51cf\u5c11\u78c1\u76d8 I/O\uff0c\u63d0\u9ad8\u6027\u80fd\u3002</p> <p>\u5982\u679c\u4f60\u7684\u4f7f\u7528\u573a\u666f\u4e0d\u9700\u8981\u6269\u5c55\u5c5e\u6027\uff08\u5982\u955c\u50cf\u7ad9\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>xattr=off</code> \u5173\u95ed\u6269\u5c55\u5c5e\u6027\u529f\u80fd\uff0c\u8fdb\u4e00\u6b65\u51cf\u5c11\u78c1\u76d8 I/O\u3002</p> <p>\u8be5\u9009\u9879\u7684\u9ed8\u8ba4\u503c\u4e3a <code>xattr=on</code>\uff0c\u5373\u6269\u5c55\u5c5e\u6027\u5b58\u50a8\u5728\u989d\u5916\u7684\u6570\u636e\u5757\u4e2d\u3002\u8fd9\u662f\u4e3a\u4e86\u4fdd\u6301\u4e0e FreeBSD / Solaris \u7b49\u7cfb\u7edf\u4e2d\u7684 ZFS \u5b9e\u73b0\u7684\u517c\u5bb9\u6027\u3002\u9664\u975e\u4f60\u9884\u8ba1\u9700\u8981\u5c06 ZFS pool \u642c\u5230\u8fd9\u4e9b\u7cfb\u7edf\u4e0a\u4f7f\u7528\uff0c\u5426\u5219\u6211\u4eec\u63a8\u8350\u4f7f\u7528 <code>xattr=sa</code> \u6216 <code>xattr=off</code>\u3002</p> </li> <li> <p><code>compression=on</code> \u6216 <code>compression=zstd</code>\uff1a\u542f\u7528 ZFS \u7684\u900f\u660e\u538b\u7f29\u529f\u80fd\u3002\u5bf9\u4e8e\u5927\u591a\u6570\u6570\u636e\uff0c\u538b\u7f29\u540e\u7684\u6570\u636e\u91cf\u4f1a\u663e\u8457\u51cf\u5c0f\uff0c\u4ece\u800c\u51cf\u5c11\u78c1\u76d8 I/O\u3002</p> <p>\u4e00\u822c\u5efa\u8bae\u542f\u7528\u900f\u660e\u538b\u7f29\u529f\u80fd\uff0c\u9664\u975e\u4f60\u7684 CPU \u6027\u80fd\u8f83\u5dee\uff08\u4f8b\u5982 10 \u5e74\u524d\u7684\u670d\u52a1\u5668\uff09\u6216\u8005\u9884\u671f\u7684\u6570\u636e\u91cf\u4e0d\u4f1a\u56e0\u538b\u7f29\u800c\u51cf\u5c0f\uff08\u4f8b\u5982\u5f52\u6863\u5b58\u50a8\u5df2\u7ecf\u538b\u7f29\u8fc7\u7684\u6570\u636e\uff09\u3002</p> <p>\u538b\u7f29\u7b97\u6cd5</p> <p>\u622a\u81f3 2024 \u5e74\uff0cZFS \u9ed8\u8ba4\u4f7f\u7528 LZ4 \u7b97\u6cd5\u8fdb\u884c\u538b\u7f29\uff0c\u8fd9\u662f\u4e00\u79cd\u901f\u5ea6\u8f83\u5feb\u7684\u5355\u7ebf\u7a0b\u7b97\u6cd5\u3002\u5982\u679c\u4f60\u7684 CPU \u4e0d\u662f\u4e0a\u53e4\u7ea7\u522b\u7684\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 Zstd\uff0c\u8fd9\u662f\u4e00\u79cd\u66f4\u52a0\u73b0\u4ee3\u5316\u7684\u538b\u7f29\u7b97\u6cd5\uff0c\u652f\u6301\u591a\u7ebf\u7a0b\u548c\u66f4\u9ad8\u7684\u538b\u7f29\u6bd4\u3002</p> </li> </ul>"},{"location":"ops/storage/zfs/#tuning-zfs-ko","title":"ZFS \u5185\u6838\u6a21\u5757\u53c2\u6570","text":"<p>ZFS \u7684\u5185\u6838\u6a21\u5757\u5177\u6709\u975e\u5e38\u591a\u7684\u53ef\u8c03\u8282\u53c2\u6570\uff0c\u5176\u4e2d\u5927\u90e8\u5206\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7\u8bfb\u5199 <code>/sys/module/zfs/parameters</code> \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u8fdb\u884c\u8c03\u8282\u3002ZFS \u7684\u5185\u6838\u6a21\u5757\u53c2\u6570\u4ece\u751f\u6548\u65f6\u95f4\u4e0a\u53ef\u4ee5\u5206\u4e3a\u4e09\u7c7b\uff1a</p> <ul> <li>\u4ec5\u52a0\u8f7d\u65f6\u751f\u6548\uff1a\u8fd9\u7c7b\u53c2\u6570\u5728\u52a0\u8f7d\u6a21\u5757\u65f6\u5c31\u5df2\u7ecf\u786e\u5b9a\uff0c\u65e0\u6cd5\u5728\u8fd0\u884c\u65f6\u4fee\u6539\u3002\u5982\u679c\u9700\u8981\u4f7f\u7528\u975e\u9ed8\u8ba4\u503c\u7684\u8bdd\uff0c\u9700\u8981\u5728\u52a0\u8f7d\u6a21\u5757\u7684\u65f6\u5019\u5c31\u6307\u5b9a\u3002\u4e00\u822c\u901a\u8fc7\u5728 <code>/etc/modprobe.d</code> \u4e2d\u521b\u5efa <code>.conf</code> \u6587\u4ef6\u6765\u6307\u5b9a\u3002</li> <li>import \u65f6\u751f\u6548\uff1a\u8fd9\u7c7b\u53c2\u6570\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u901a\u8fc7\u8bfb\u5199 sysfs \u8fdb\u884c\u8c03\u8282\uff0c\u4f46\u65b0\u7684\u503c\u53ea\u6709\u5728\u4e0b\u6b21\u5bfc\u5165 pool \u65f6\u624d\u4f1a\u751f\u6548\u3002\u5982\u679c\u9700\u8981\u5bf9\u4f7f\u7528\u4e2d\u7684 pool \u4fee\u6539\u8fd9\u4e9b\u53c2\u6570\uff0c\u9700\u8981\u5148 <code>zpool export</code> \u518d <code>zpool import</code>\u3002</li> <li>\u7acb\u5373\u751f\u6548\uff1a\u8fd9\u7c7b\u53c2\u6570\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u901a\u8fc7\u8bfb\u5199 sysfs \u8fdb\u884c\u8c03\u8282\uff0c\u4e14\u7acb\u5373\u751f\u6548\u3002</li> </ul> <p>\u6700\u5e38\u8c03\u8282\u7684 ZFS \u6a21\u5757\u53c2\u6570\u5176\u5b9e\u53ea\u6709\u4e00\u4e2a\uff0c\u90a3\u5c31\u662f <code>zfs_arc_max</code>\uff0c\u5373 ZFS \u4f7f\u7528\u7cfb\u7edf\u5185\u5b58\u4f5c\u4e3a ARC \u7684\u6700\u5927\u503c\uff0c\u8be6\u60c5\u8bf7\u89c1\u4e0b\u9762\u7684\u7ae0\u8282\u3002</p>"},{"location":"ops/storage/zfs/#arc","title":"\u5173\u4e8e ARC","text":"<p>ZFS ARC \u7684\u5168\u79f0\u662f Adaptive Replacement Cache\uff0c\u662f ZFS \u7528\u4e8e\u7f13\u5b58\u78c1\u76d8\u6570\u636e\u7684\u4e00\u7ea7\u7f13\u5b58\u3002ZFS \u7684\u7f13\u5b58\u7b97\u6cd5\u975e\u5e38\u667a\u80fd\uff0c\u4f1a\u5c06\u53ef\u7528\u7684\u7f13\u5b58\u5bb9\u91cf\u5206\u4e3a MFU\uff08Most Frequently Used\uff09\u548c MRU\uff08Most Recently Used\uff09\u4e24\u90e8\u5206\uff0c\u5e76\u6839\u636e\u8d1f\u8f7d\u60c5\u51b5\u81ea\u52a8\u8c03\u6574\u4e24\u90e8\u5206\u7684\u5927\u5c0f\u3002</p> <p>\u7531\u4e8e ZFS \u7684\u591a\u7ea7 metadata \u7b49\u590d\u6742\u7684\u8bbe\u8ba1\uff0cZFS \u9700\u8981\u4f7f\u7528\u4e00\u5b9a\u7684\u5185\u5b58\u4f5c\u4e3a ARC \u624d\u80fd\u4fdd\u8bc1\u78c1\u76d8\u7684\u6b63\u5e38\u8bfb\u5199\u64cd\u4f5c\uff0c\u800c\u4e0d\u50cf\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\uff08\u5982 ext4\uff0cXFS \u7b49\uff09\u4ec5\u9700\u5728\u5185\u5b58\u4e2d\u7ef4\u62a4\u5c11\u91cf\u7684 metadata \u5373\u53ef\u6b63\u5e38\u8fd0\u8f6c\u3002ZFS ARC \u5141\u8bb8\u4f7f\u7528\u7684\u6700\u5927\u5185\u5b58\u91cf\u53ef\u4ee5\u901a\u8fc7 <code>zfs_arc_max</code> \u53c2\u6570\u8c03\u8282\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cZFS \u4f1a\u4f7f\u7528\u7cfb\u7edf\u5185\u5b58\u7684\u4e00\u534a\u4f5c\u4e3a ARC\uff0c\u4f46\u662f\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u662f\u4e13\u7528\u4e8e\u5b58\u50a8\u548c\u6587\u4ef6\u670d\u52a1\u7684\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u8fd9\u4e2a\u503c\u8c03\u5927\u4e00\u4e9b\u3002\u4f8b\u5982\uff1a</p> <pre><code># Set ARC memory limit to 4 GiB\necho 4294967296 &gt; /sys/module/zfs/parameters/zfs_arc_max\n</code></pre> <p>\u5982\u679c\u4f60\u7684\u7cfb\u7edf\u4e2d\u6709\u5176\u4ed6\u5927\u91cf\u5360\u7528\u5185\u5b58\u7684\u7a0b\u5e8f\uff0c\u6211\u4eec\u63a8\u8350\u4f60\u540c\u65f6\u8bbe\u7f6e\u4e00\u4e2a\u5408\u9002\u7684 <code>zfs_arc_min</code> \u53c2\u6570\uff08\u5176\u9ed8\u8ba4\u503c\u4e3a\u96f6\uff09\uff0c\u4ee5\u4fdd\u8bc1 ZFS \u80fd\u591f\u7ef4\u6301\u4e00\u5b9a\u7684\u6027\u80fd\u3002</p> <p>\u5728 Linux \u4e0b\uff0c\u53d7\u9650\u4e8e kernel \u7684\u8bbe\u8ba1 (1)\uff0cARC \u5360\u7528\u7684\u5185\u5b58\u4f1a\u5728 htop / free \u7b49\u7a0b\u5e8f\u4e2d\u663e\u793a\u4e3a used \u800c\u4e0d\u662f cached\uff0c\u4f46\u662f\u5176\u884c\u4e3a\u548c cached \u662f\u4e00\u81f4\u7684\uff0c\u5373\u5728\u7cfb\u7edf\u5185\u5b58\u538b\u529b\u5347\u9ad8\u65f6\u4f1a\u81ea\u52a8\u91ca\u653e\uff0c\u4ee5\u4f9b\u5176\u4ed6\u7a0b\u5e8f\u4f7f\u7528\u3002</p> <ol> <li>\u5728 FreeBSD \u4e2d\uff0cZFS ARC \u5360\u7528\u7684\u5185\u5b58\u4f1a\u6b63\u786e\u5730\u663e\u793a\u4e3a cached\u3002</li> </ol> <p>\u5f3a\u5236\u91ca\u653e ARC</p> <p>\u4e0e cached \u5185\u5b58\u4e00\u6837\uff0c\u5728 <code>echo 3 &gt; /proc/sys/vm/drop_caches</code> \u65f6\uff0cZFS ARC \u4f1a\u4e00\u540c\u91ca\u653e\u3002\u6ce8\u610f\u8fd9\u4f1a\u77ed\u6682\u5730\u589e\u52a0\u78c1\u76d8\u7684\u8bfb\u53d6\u538b\u529b\u3002</p> <p>ARC \u7684\u7edf\u8ba1\u4fe1\u606f\uff08\u5982\u5185\u5b58\u4f7f\u7528\u91cf\u3001MRU / MFU \u914d\u6bd4\u3001\u547d\u4e2d\u7387\u7b49\uff09\u53ef\u4ee5\u901a\u8fc7 <code>/proc/spl/kstat/zfs/arcstats</code> \u67e5\u770b\uff0c\u5e76\u4e14 ZFS \u4e5f\u63d0\u4f9b\u4e86 <code>arc_summary</code> \u547d\u4ee4\u5c06\u8be5\u63a5\u53e3\u7684\u6570\u636e\u4ee5\u66f4\u6613\u8bfb\u7684\u65b9\u5f0f\u8f93\u51fa\u3002\u7531\u4e8e <code>arc_summary</code> \u8f93\u51fa\u91cf\u8f83\u5927\uff0c\u5efa\u8bae\u4f7f\u7528 less \u7b49\u5206\u9875\u5de5\u5177\u67e5\u770b\u3002\u4f8b\u5982\uff1a</p> <pre><code>arc_summary | less\n</code></pre>"},{"location":"ops/storage/zfs/#debugging","title":"\u8c03\u8bd5","text":"<p>ZFS \u63d0\u4f9b\u4e86\u8c03\u8bd5\u5de5\u5177 <code>zdb</code>\uff0c\u53ef\u4ee5\u7528\u4e8e\u67e5\u770b pool \u548c\u6587\u4ef6\u7cfb\u7edf\u7684\u5185\u90e8\u7ed3\u6784\u3002 \u5728\u9047\u5230\u65e0\u6cd5\u89e3\u91ca\u7684\u95ee\u9898\u65f6\uff0c\u4f7f\u7528 <code>zdb</code> \u53ef\u80fd\u53ef\u4ee5\u5e2e\u52a9\u8c03\u8bd5\u95ee\u9898\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff1a</p> <ul> <li><code>zdb</code> \u4e0d\u5173\u5fc3 pool \u6216\u8005\u6587\u4ef6\u7cfb\u7edf\u662f\u5426\u6302\u8f7d\uff0c\u5b83\u90fd\u4f1a\u76f4\u63a5\u8bbf\u95ee\u5757\u8bbe\u5907\u3002\u56e0\u6b64\u5728\u6b63\u5728\u4f7f\u7528\u7684 pool \u6216\u8005\u6587\u4ef6\u7cfb\u7edf\u4e0a\u4f7f\u7528 <code>zdb</code> \u53ef\u80fd\u4f1a\u5f97\u5230\u4e0d\u4e00\u81f4\u7684\u7ed3\u679c\uff1b</li> <li><code>zdb</code> \u7684\u8f93\u51fa\u683c\u5f0f\u6ca1\u6709\u6587\u6863\u8bf4\u660e\uff0c\u56e0\u4e3a\u5176\u5047\u8bbe\u4f7f\u7528\u8005\u4e86\u89e3 ZFS \u7684\u5185\u90e8\u7ed3\u6784\uff1b</li> <li><code>zdb</code> \u652f\u6301\u5199\u5165\u5185\u5bb9\uff0c\u4f46\u662f\u5728\u4e0d\u4e86\u89e3 ZFS \u5185\u90e8\u7ed3\u6784\u7684\u60c5\u51b5\u4e0b\uff0c\u5efa\u8bae\u4ec5\u4f7f\u7528 <code>zdb</code> \u8bfb\u53d6 pool \u548c\u6587\u4ef6\u7cfb\u7edf\u7684\u7ed3\u6784\u5185\u5bb9\u3002</li> </ul> <p>\u4ee5\u4e0b\u63d0\u4f9b\u4e86\u4e00\u4e2a\u4f7f\u7528 <code>zdb</code> \u8c03\u8bd5\u51fa\u751f\u4ea7\u73af\u5883\u300c\u672a\u89e3\u4e4b\u8c1c\u300d\u7684\u4f8b\u5b50\uff1a</p> \u6848\u4f8b\uff1a\u4f7f\u7528 <code>zdb</code> \u5e2e\u52a9\u627e\u51fa\u6587\u4ef6\u7cfb\u7edf\u4f7f\u7528\u7a7a\u95f4\u5f02\u5e38\u7684\u539f\u56e0 <p>\u4e00\u53f0\u4f7f\u7528 ZFS \u7684\u670d\u52a1\u5668\u5c06 <code>/var/log</code> \u6302\u8f7d\u5728\u4e86 ZFS \u6587\u4ef6\u7cfb\u7edf\u4e2d\uff1a</p> <pre><code>NAME                                 USED  AVAIL  REFER  MOUNTPOINT\npool1/log                           2.88G   181G  2.88G  /var/log\n</code></pre> <p>\u4f46\u662f\u7cfb\u7edf\u7ba1\u7406\u5458\u53d1\u73b0 <code>/var/log</code> \u7684\u4f7f\u7528\u7a7a\u95f4\u4f1a\u5f02\u5e38\u589e\u5927\uff0c\u76f4\u5230\u5927\u90e8\u5206\u7a7a\u95f4\u90fd\u88ab\u5360\u7528\uff1a</p> <pre><code>NAME                                 USED  AVAIL     REFER  MOUNTPOINT\npool1/log                            173G  3.43G      173G  /var/log\n</code></pre> <p>\u4f46\u662f\u5b9e\u9645\u7684 log \u5927\u5c0f\u53ea\u6709\u4e0d\u5230 3G\uff1a</p> <pre><code>$ sudo du -sh .\n2.9G  .\n</code></pre> <p>\u540c\u65f6\u6ca1\u6709\u5feb\u7167\uff0c\u901a\u8fc7 <code>lsof</code> \u68c0\u67e5\u4e5f\u6ca1\u6709\u8fdb\u7a0b\u5360\u7528\u5728 <code>/var/log</code> \u4e0b\u5df2\u7ecf\u88ab\u5220\u9664\u7684\u6587\u4ef6\u3002 \u91cd\u542f\u540e\u6587\u4ef6\u7cfb\u7edf\u7684\u4f7f\u7528\u7a7a\u95f4\u53c8\u6062\u590d\u5230\u4e86\u6b63\u5e38\u7684\u5927\u5c0f\u3002\u6ca1\u6709\u4eba\u80fd\u591f\u89e3\u91ca\u539f\u56e0\u3002</p> <p>\u5728\u65f6\u9694\u534a\u5e74\u53c8\u4e00\u6b21\u56e0\u6b64\u91cd\u542f\u540e\uff0c\u7cfb\u7edf\u7ba1\u7406\u5458\u51b3\u5b9a\u4f7f\u7528 <code>zdb</code> \u6765\u67e5\u770b\u6587\u4ef6\u7cfb\u7edf\u7684\u5185\u90e8\u7ed3\u6784\uff1a</p> <pre><code>$ sudo zdb -dddd pool1/log &gt; zdb-log.txt\n</code></pre> <p>\u68c0\u67e5\u8f93\u51fa\uff0c\u53d1\u73b0\u4e00\u4e2a\u7279\u522b\u5927\u7684\u6587\u4ef6\uff1a</p> <pre><code>Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  type\n  6426    4   128K   128K   170G     512  1.02T  100.00  ZFS plain file\n                                           168   bonus  System attributes\ndnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED \ndnode maxblkid: 8554489\nuid     0\ngid     4\natime   Thu Aug 17 19:22:48 2023\nmtime   Sun Feb 18 16:05:29 2024\nctime   Sun Feb 18 16:05:29 2024\ncrtime  Thu Aug 17 06:25:01 2023\ngen 30893491\nmode    100640\nsize    1121254014464\nparent  7279\nlinks   0\npflags  40800000004\n</code></pre> <p>\"6426\" \u8fd9\u4e2a\u5bf9\u8c61\u4e5f\u51fa\u73b0\u5728\u4e86 ZFS delete queue \u4e2d\uff1a</p> <pre><code>Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  type\n     3    1   128K     6K      0     512     6K  100.00  ZFS delete queue\ndnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED \ndnode maxblkid: 0\nmicrozap: 6144 bytes, 1 entries\n\n    191a = 6426 \n</code></pre> <p>\u770b\u8d77\u6765\u662f\u8fd9\u4e2a\u6587\u4ef6\u4e0d\u505c\u589e\u5927\uff0c\u4f46\u662f ZFS \u6ca1\u6709\u5220\u9664\u3002\u68c0\u67e5 6426 \u7684 parent 7279\uff1a</p> <pre><code>Object  lvl   iblk   dblk  dsize  dnsize  lsize   %full  type\n  7279    1   128K  2.50K     8K     512  2.50K  100.00  ZFS directory\n                                           168   bonus  System attributes\ndnode flags: USED_BYTES USERUSED_ACCOUNTED USEROBJUSED_ACCOUNTED \ndnode maxblkid: 0\nuid     0\ngid     0\natime   Mon Jun 24 01:32:06 2019\nmtime   Fri Mar  8 06:25:02 2024\nctime   Fri Mar  8 06:25:02 2024\ncrtime  Tue Feb 27 21:11:06 2018\ngen 4369970\nmode    40755\nsize    33\nparent  4\nlinks   2\npflags  40800000144\nmicrozap: 2560 bytes, 31 entries\n\n    pacct.6.gz = 3908 (type: Regular File)\n    pacct.17.gz = 1994 (type: Regular File)\n    pacct.16.gz = 275 (type: Regular File)\n    pacct.7.gz = 3518 (type: Regular File)\n    pacct.5.gz = 473 (type: Regular File)\n    pacct.14.gz = 1554 (type: Regular File)\n    pacct.15.gz = 651 (type: Regular File)\n    pacct.4.gz = 109 (type: Regular File)\n    pacct.29.gz = 468 (type: Regular File)\n    pacct.11.gz = 1863 (type: Regular File)\n    pacct.10.gz = 2129 (type: Regular File)\n    pacct.1.gz = 1294 (type: Regular File)\n    pacct.28.gz = 3648 (type: Regular File)\n    pacct.3.gz = 1864 (type: Regular File)\n    pacct.12.gz = 3516 (type: Regular File)\n    pacct.13.gz = 2128 (type: Regular File)\n    pacct.2.gz = 2955 (type: Regular File)\n    pacct.22.gz = 649 (type: Regular File)\n    pacct.23.gz = 3649 (type: Regular File)\n    pacct.8.gz = 3400 (type: Regular File)\n    pacct.19.gz = 535 (type: Regular File)\n    pacct = 796 (type: Regular File)\n    pacct.21.gz = 534 (type: Regular File)\n    pacct.0 = 904 (type: Regular File)\n    pacct.20.gz = 3725 (type: Regular File)\n    pacct.18.gz = 3515 (type: Regular File)\n    pacct.9.gz = 1293 (type: Regular File)\n    pacct.24.gz = 3905 (type: Regular File)\n    pacct.25.gz = 903 (type: Regular File)\n    pacct.27.gz = 1552 (type: Regular File)\n    pacct.26.gz = 1176 (type: Regular File)\n</code></pre> <p>\u53d1\u73b0\u8be5\u76ee\u5f55\u4e3a <code>/var/log/account</code>\uff0c\u8c03\u67e5\u540e\u53d1\u73b0\u5176\u4e2d\u7684\u6587\u4ef6\u5728\u542f\u7528 process accounting \u540e\u4f1a\u7531\u5185\u6838\u5199\u5165\u3002 \u56e0\u6b64\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48 <code>lsof</code> \u6ca1\u6709\u663e\u793a\u4efb\u4f55\u8fdb\u7a0b\u5360\u7528\u5bf9\u5e94\u6587\u4ef6\u3002\u5728\u5173\u95ed process accounting \u540e\uff0cdelete queue \u6e05\u7a7a\u4e86\u3002</p> <p>\u8be5\u95ee\u9898\u5df2\u7ecf\u5c1d\u8bd5\u5411 ZFS \u53cd\u9988\uff1ahttps://github.com/openzfs/zfs/issues/15998\u3002 \u5728\u6536\u5230 issue \u56de\u590d\u4e4b\u540e\u68c0\u67e5\u4e86 Debian \u7684 acct \u7684 cron daily \u811a\u672c\uff0c\u53d1\u73b0\u5176\u4f7f\u7528\u4e86 <code>invoke-rc.d</code> \u91cd\u542f\u670d\u52a1\u3002 \u4f46\u662f <code>/usr/sbin/policy-rc.d</code> \u5728\u591a\u5e74\u524d\u88ab\u8bbe\u7f6e\u4e3a <code>exit 101</code>\uff0c\u56e0\u6b64 <code>invoke-rc.d</code> \u65e0\u6cd5\u542f\u52a8\u670d\u52a1\uff0c \u5bfc\u81f4\u4e86 process accounting \u670d\u52a1\u4e00\u76f4\u672a\u88ab\u91cd\u542f\uff0c\u5185\u6838\u4ecd\u7136\u5728\u5199\u5165\u6587\u4ef6\u3002</p>"},{"location":"ops/virtualization/","title":"\u865a\u62df\u5316\u6280\u672f","text":"<p>\u672c\u90e8\u5206\u4ecb\u7ecd\u4e0e\u5bb9\u5668\uff08Docker\uff0cLXC\uff09\u4e0e\u865a\u62df\u673a\uff08QEMU\uff0cKVM\uff09\u7b49\u865a\u62df\u5316\u6280\u672f\u76f8\u5173\u7684\u5185\u5bb9\u3002</p>"},{"location":"ops/virtualization/container/","title":"\u5bb9\u5668","text":"<p>\u672c\u6587\u521d\u7a3f\u7f16\u5199\u4e2d</p> <p>\u5bb9\u5668\u662f\u8fd1\u5341\u51e0\u5e74\u6765\u5174\u8d77\u7684\u4e00\u79cd\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u5316\u6280\u672f\uff0c\u5728 Linux \u5185\u6838\u652f\u6301\u7684\u57fa\u7840\u4e0a\u5b9e\u73b0\u4e86\u5171\u4eab\u5185\u6838\u7684\u865a\u62df\u5316\uff0c\u8ba9\u5e94\u7528\u7684\u90e8\u7f72\u4e0e\u7ba1\u7406\u53d8\u5f97\u66f4\u52a0\u7b80\u5355\u3002</p> <p>\u672c\u90e8\u5206\u5047\u8bbe\u8bfb\u8005\u4e86\u89e3\u57fa\u672c\u7684 Docker \u4f7f\u7528\u3002</p>"},{"location":"ops/virtualization/container/#kernel-support","title":"\u5bb9\u5668\u6280\u672f\u7684\u5185\u6838\u652f\u6301","text":""},{"location":"ops/virtualization/container/#namespace","title":"\u547d\u540d\u7a7a\u95f4","text":"<p>Linux \u5185\u6838\u7684\u547d\u540d\u7a7a\u95f4\u529f\u80fd\u662f\u5bb9\u5668\u6280\u672f\u7684\u91cd\u8981\u57fa\u7840\u3002\u547d\u540d\u7a7a\u95f4\u53ef\u4ee5\u63a7\u5236\u8fdb\u7a0b\u6240\u80fd\u770b\u5230\u7684\u7cfb\u7edf\u8d44\u6e90\uff0c\u5305\u62ec\u5176\u4ed6\u8fdb\u7a0b\u3001\u7f51\u7edc\u3001\u6587\u4ef6\u7cfb\u7edf\u3001\u7528\u6237\u7b49\u3002\u53ef\u4ee5\u9605\u8bfb namespaces(7) \u4e86\u89e3\u76f8\u5173\u7684\u4fe1\u606f\u3002</p> <p>\u53ef\u4ee5\u5728 procfs \u770b\u5230\u67d0\u4e2a\u8fdb\u7a0b\u6240\u5904\u7684\u547d\u540d\u7a7a\u95f4\uff1a</p> <pre><code>$ ls -lh /proc/self/ns/\ntotal 0\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 cgroup -&gt; 'cgroup:[4026531835]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 ipc -&gt; 'ipc:[4026531839]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 mnt -&gt; 'mnt:[4026531841]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 net -&gt; 'net:[4026531840]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 pid -&gt; 'pid:[4026531836]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 pid_for_children -&gt; 'pid:[4026531836]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 time -&gt; 'time:[4026531834]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 time_for_children -&gt; 'time:[4026531834]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 user -&gt; 'user:[4026531837]'\nlrwxrwxrwx 1 username username 0 Mar 24 21:04 uts -&gt; 'uts:[4026531838]'\n</code></pre> <p>\u4f7f\u7528 <code>nsenter</code> \u547d\u4ee4\u53ef\u4ee5\u8fdb\u5165\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\uff1a</p> <pre><code>$ sudo docker run -it --rm --name test ustclug/ubuntu:22.04\nroot@9213a075a2f4:/#\n...\n$ # \u5f00\u542f\u53e6\u4e00\u4e2a\u7ec8\u7aef\n$ sudo docker top test\nUID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD\nroot                117426              117406              0                   21:09               pts/0               00:00:00            bash\n$ sudo nsenter --target 117426 --uts bash # \u8fdb\u5165 UTS \u547d\u540d\u7a7a\u95f4\n[root@9213a075a2f4 example]# # \u53ef\u4ee5\u770b\u5230 hostname \u5df2\u7ecf\u6539\u53d8\n</code></pre> <p>ustclug Docker image</p> <p>\u672c\u9875\u7684\u5bb9\u5668\u793a\u4f8b\u4f7f\u7528\u4e86 ustclug/mirrorimage \u751f\u6210\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u9ed8\u8ba4\u914d\u7f6e\u4e86\u79d1\u5927\u955c\u50cf\u7ad9\uff0c\u5e2e\u52a9\u51cf\u5c11 <code>apt</code> \u7b49\u64cd\u4f5c\u4e4b\u524d\u8fd8\u8981\u8dd1 <code>sed</code> \u7684\u9ebb\u70e6\u3002</p> <p>\u90a3\u4e48 PID \u547d\u540d\u7a7a\u95f4\u4e5f\u662f\u540c\u7406\u5417\uff1f</p> <pre><code>$ sudo nsenter --target 117426 --pid bash\n# ps aux\nfatal library error, lookup self\n# echo $$\n417\n# ls -lh /proc/$$/\nls: cannot access '/proc/417/': No such file or directory\n# # \u5982\u679c\u4f7f\u7528 htop\uff0c\u4ecd\u7136\u53ef\u4ee5\u770b\u5230\u5b8c\u6574\u7684\u8fdb\u7a0b\u5217\u8868\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u8fd9\u91cc\u6302\u8f7d\u7684 procfs \u662f\u5bf9\u5e94\u6574\u4e2a\u7cfb\u7edf\u7684\uff0c\u56e0\u6b64\u5373\u4f7f\u8fdb\u5165\u4e86\u65b0\u7684 PID \u547d\u540d\u7a7a\u95f4\uff0c \u5728 mount \u547d\u540d\u7a7a\u95f4\u4e0d\u53d8\u7684\u60c5\u51b5\u4e0b\uff0c<code>/proc</code> \u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u4ecd\u7136\u662f\u5bbf\u4e3b\u673a\u7684\u3002 \u56e0\u6b64\u9700\u8981\u540c\u65f6\u8fdb\u5165 mount \u547d\u540d\u7a7a\u95f4\uff1a</p> <pre><code>$ sudo nsenter --target 117426 --pid --mount bash\n# ps aux\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0   4624  3712 pts/0    Ss+  13:09   0:00 bash\nroot         434  0.0  0.0   4624  3712 ?        S    13:32   0:00 bash\nroot         437  0.0  0.0   7060  2944 ?        R+   13:32   0:00 ps aux\n</code></pre> <p>\u56e0\u6b64\u4e00\u822c\u6765\u8bb2\uff0c\u6211\u4eec\u4f1a\u5e0c\u671b\u540c\u65f6\u8fdb\u5165\u8fdb\u7a0b\u6240\u5c5e\u6240\u6709\u7684\u547d\u540d\u7a7a\u95f4\uff0c\u4ee5\u907f\u514d\u53ef\u80fd\u7684\u4e0d\u4e00\u81f4\u6027\u95ee\u9898\u3002\u53ef\u4ee5\u901a\u8fc7 <code>-a</code> \u53c2\u6570\u5b9e\u73b0\u3002</p> <p>\u53e6\u4e00\u4e2a\u4e0e\u547d\u540d\u7a7a\u95f4\u6709\u5173\u7684\u5b9e\u7528\u547d\u4ee4\u662f <code>unshare</code>\uff0c\u53d6\u81ea\u540c\u540d\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u53ef\u4ee5\u521b\u5efa\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u3002\u5bf9\u4e8e\u4e0a\u9762\u5c55\u793a PID \u547d\u540d\u7a7a\u95f4\u7684\u4f8b\u5b50\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>unshare</code> \u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 PID \u547d\u540d\u7a7a\u95f4\uff08\u4e0e mount \u547d\u540d\u7a7a\u95f4\uff09\uff0c\u5e76\u4e14\u6302\u8f7d\u65b0\u7684 <code>/proc</code>\uff1a</p> <pre><code>$ sudo unshare --pid --fork --mount-proc bash\n# ps aux\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0  10876  4568 pts/17   S    21:42   0:00 bash\nroot           2  0.0  0.0  14020  4464 pts/17   R+   21:42   0:00 ps aux\n</code></pre> <p>\u53e6\u5916\uff0c\u6709\u4e00\u79cd\u7528\u6237\u547d\u540d\u7a7a\u95f4\uff0c\u5141\u8bb8\u975e root \u7528\u6237\u521b\u5efa\u65b0\u7684\u7528\u6237\u547d\u540d\u7a7a\u95f4\uff08\u8fd9\u4e5f\u662f rootless \u5bb9\u5668\u7684\u57fa\u7840\uff09\uff0c\u8ba9\u6211\u4eec\u7b80\u5355\u8bd5\u4e00\u8bd5\uff1a</p> <pre><code>$ unshare --user --pid --fork --mount-proc bash\n$ ps aux\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nnobody         1  0.0  0.0  10876  4312 pts/16   S    21:44   0:00 bash\nnobody         2  0.0  0.0  14020  4276 pts/16   R+   21:44   0:00 ps aux\n$ exit\n$ # \u751a\u81f3\u53ef\u4ee5\u4fee\u6539\u6620\u5c04\uff0c\u5b9e\u73b0\u300c\u5047\u7684\u300droot\n$ unshare --user --pid --fork --map-root-user --mount-proc bash\n# ps aux\nUSER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot           1  0.0  0.0  10876  4468 pts/16   S    21:46   0:00 bash\nroot           2  0.0  0.0  14020  4416 pts/16   R+   21:46   0:00 ps aux\n</code></pre> <p>\u547d\u540d\u7a7a\u95f4\u7684\u9b54\u6cd5</p> <p>\u5728\u4e86\u89e3\u547d\u540d\u7a7a\u95f4\u7684\u57fa\u7840\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed5\u8fc7\u5bb9\u5668\u8fd0\u884c\u65f6\u7684\u4e00\u4e9b\u9650\u5236\uff0c\u76f4\u63a5\u64cd\u4f5c\u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u4f5c\u4e3a\u5176\u4e2d\u4e00\u4e2a\u300c\u82b1\u5f0f\u64cd\u4f5c\u300d\u7684\u4f8b\u5b50\uff0c\u53ef\u4ee5\u9605\u8bfb\u8fd9\u7bc7 USENIX ATC 2018 \u7684\u8bba\u6587\uff1aCntr: Lightweight OS Containers\uff08\u4ee5\u53ca\u76ee\u524d\u4ecd\u7136\u5728\u7ef4\u62a4\u7684\u4ee3\u7801\u4ed3\u5e93\uff09\u3002\u8fd9\u7bc7\u5de5\u4f5c\u5b9e\u73b0\u4e86\u5728\u4e0d\u5305\u542b\u8c03\u8bd5\u5de5\u5177\u7684\u5bb9\u5668\u4e2d\u4f7f\u7528\u5305\u542b\u8c03\u8bd5\u5de5\u5177\u7684\u955c\u50cf\uff08\u6216\u8005 host \u7684\u8c03\u8bd5\u5de5\u5177\uff09\u8fdb\u884c\u8c03\u8bd5\u7684\u529f\u80fd\u3002</p>"},{"location":"ops/virtualization/container/#cgroups","title":"Cgroups","text":"<p>Cgroups\uff08cgroups(7)\uff09\u662f Linux \u5185\u6838\u63d0\u4f9b\u7684\u9650\u5236\u4e0e\u7edf\u8ba1\u8fdb\u7a0b\u8d44\u6e90\u4f7f\u7528\u7684\u673a\u5236\u3002 Cgroups \u4ee5\u6587\u4ef6\u7cfb\u7edf\u7684\u5f62\u5f0f\u66b4\u9732\u7ed9\u7528\u6237\u6001\uff0c\u4e00\u822c\u6302\u8f7d\u5728 <code>/sys/fs/cgroup/</code>\u3002 \u76f8\u6bd4\u4e8e\u4f20\u7edf\u7684 <code>setrlimit</code> \u7b49\u7cfb\u7edf\u8c03\u7528\uff0ccgroups \u80fd\u591f\u6709\u6548\u5730\u7ba1\u7406\u4e00\u7ec4\u8fdb\u7a0b\uff08\u4ee5\u53ca\u5b83\u4eec\u65b0\u5efa\u7684\u5b50\u8fdb\u7a0b\uff09\u7684\u8d44\u6e90\u4f7f\u7528\u3002</p> <p>\u5728\u4f7f\u7528 systemd \u7684\u7cfb\u7edf\u4e2d\uff0ccgroups \u7531 systemd \u8d1f\u8d23\u7ba1\u7406\u3002 \u4ed4\u7ec6\u89c2\u5bdf <code>systemctl status</code> \u7684\u8f93\u51fa\uff0c\u53ef\u4ee5\u53d1\u73b0\u5176\u5c31\u5c55\u793a\u4e86\u4e00\u9897 cgroup \u6811\uff08\u6ce8\u610f\u770b <code>init.scope</code> \u4e0a\u4e00\u884c\uff09\uff1a</p> <pre><code>$ systemctl status\n\u25cf example\n    State: running\n    Units: 271 loaded (incl. loaded aliases)\n     Jobs: 0 queued\n   Failed: 0 units\n    Since: Sun 2023-06-11 15:42:13 CST; 9 months 14 days ago\n  systemd: 252.19-1~deb12u1\n   CGroup: /\n           \u251c\u2500init.scope\n           \u2502 \u2514\u25001 /lib/systemd/systemd --system --deserialize=34\n           \u251c\u2500system.slice\n           \u2502 \u251c\u2500caddy.service\n           \u2502 \u2502 \u2514\u25002398446 /usr/bin/caddy run --environ --config /etc/caddy/Caddyfile\n           \u2502 \u251c\u2500containerd.service\n           \u2502 \u2502 \u2514\u25003923123 /usr/bin/containerd\n           \u2502 \u251c\u2500cron.service\n           \u2502 \u2502 \u2514\u2500649 /usr/sbin/cron -f\n           \u2502 \u251c\u2500dbus.service\n           \u2502 \u2502 \u2514\u2500650 /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only\n           \u2502 \u251c\u2500docker.service\n           \u2502 \u2502 \u2514\u25003926029 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n\uff08\u7701\u7565\uff09\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>systemd-cgtop</code> \u5b9e\u65f6\u67e5\u770b cgroup \u7684\u4f7f\u7528\u60c5\u51b5\u3002</p> <p>Cgroups \u6709 v1 \u4e0e v2 \u4e24\u4e2a\u7248\u672c\u3002 \u8f83\u65b0\u7684\u53d1\u884c\u7248\u9ed8\u8ba4\u4ec5\u652f\u6301 cgroups v2\uff0c\u7a0d\u8001\u4e00\u4e9b\u7684\u4f1a\u4f7f\u7528 systemd \u7684 \"unified_cgroup_hierarchy\" \u7279\u6027\uff0c\u5c06 cgroups v1 \u4e0e v2 \u5408\u5e76\u66b4\u9732\u7ed9\u7528\u6237\u3002\u76ee\u524d\u5927\u90e8\u5206\u8f6f\u4ef6\u90fd\u5df2\u7ecf\u652f\u6301 cgroups v2\uff0c\u56e0\u6b64\u4e0b\u6587\u8ba8\u8bba cgroups \u65f6\uff0c\u9ed8\u8ba4\u4e3a v2\u3002</p> <p>\u53ef\u4ee5\u624b\u5de5\u901a\u8fc7\u8bfb\u5199\u6587\u4ef6\u63a7\u5236 cgroups\uff1a</p> <pre><code>$ sleep 1d &amp;\n[1] 1910225\n$ sudo -i\n# cd /sys/fs/cgroup\n# mkdir test\n# cd test\n# echo 1910225 &gt; cgroup.procs\n# cat cgroup.procs\n1910225\n</code></pre> <p>\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u5c06\u521a\u521a\u521b\u5efa\u7684 <code>sleep 1d</code> \u7684\u8fdb\u7a0b\u79fb\u52a8\u5230\u4e86 <code>test</code> cgroup \u4e2d\u3002 \uff08\u6ce8\u610f cgroup \u6811\u5305\u542b\u4e86\u7cfb\u7edf\u7684\u6240\u6709\u8fdb\u7a0b\uff0c\u56e0\u6b64\u5199\u5165\u5230 <code>cgroup.procs</code> \u7684\u5b9e\u9645\u8bed\u4e49\u662f\u79fb\u52a8\u8fdb\u7a0b\u6240\u5c5e\u7684 cgroup\uff09\u3002</p> <p>\u7531\u4e8e <code>test</code> \u521b\u5efa\u5728\u6839\u4e0b\u9762\uff0c\u56e0\u6b64\u5176\u5305\u542b\u4e86\u6240\u6709\u7684\u300c\u63a7\u5236\u5668\u300d\uff08Controller\uff09\u3002 \u4e0d\u540c\u7684\u63a7\u5236\u5668\u5bf9\u5e94\u4e0d\u540c\u7684\u7cfb\u7edf\u8d44\u6e90\uff0c\u4f8b\u5982\u5185\u5b58\u3001CPU\u3001IO \u7b49\u3002 \u53ef\u4ee5\u901a\u8fc7 <code>ls</code> \u786e\u8ba4\uff1a</p> <pre><code># ls\ncgroup.controllers  cpu.max.burst            cpu.weight.nice       hugetlb.2MB.rsvd.max  memory.low       memory.zswap.current\ncgroup.events       cpu.pressure             hugetlb.1GB.current       io.bfq.weight     memory.max       memory.zswap.max\ncgroup.freeze       cpuset.cpus          hugetlb.1GB.events    io.latency        memory.min       misc.current\ncgroup.kill     cpuset.cpus.effective        hugetlb.1GB.events.local  io.low        memory.numa_stat     misc.events\ncgroup.max.depth    cpuset.cpus.exclusive        hugetlb.1GB.max       io.max        memory.oom.group     misc.max\ncgroup.max.descendants  cpuset.cpus.exclusive.effective  hugetlb.1GB.numa_stat     io.pressure       memory.peak          pids.current\ncgroup.pressure     cpuset.cpus.partition        hugetlb.1GB.rsvd.current  io.prio.class     memory.pressure      pids.events\ncgroup.procs        cpuset.mems          hugetlb.1GB.rsvd.max      io.stat       memory.reclaim       pids.max\ncgroup.stat     cpuset.mems.effective        hugetlb.2MB.current       io.weight         memory.stat          pids.peak\ncgroup.subtree_control  cpu.stat             hugetlb.2MB.events    irq.pressure      memory.swap.current  rdma.current\ncgroup.threads      cpu.stat.local           hugetlb.2MB.events.local  memory.current    memory.swap.events   rdma.max\ncgroup.type     cpu.uclamp.max           hugetlb.2MB.max       memory.events     memory.swap.high\ncpu.idle        cpu.uclamp.min           hugetlb.2MB.numa_stat     memory.events.local   memory.swap.max\ncpu.max         cpu.weight           hugetlb.2MB.rsvd.current  memory.high       memory.swap.peak\n</code></pre> <p>\u63a7\u5236\u5668\u53ef\u4ee5\u901a\u8fc7 <code>cgroup.subtree_control</code> \u63a7\u5236\u662f\u5426\u542f\u7528\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6839\u636e cgroup v2 \u7684 \"no internal processes\" \u89c4\u5219\uff0c \u9664\u6839\u8282\u70b9\u4ee5\u5916\uff0c\u5176\u4ed6\u7684 cgroup \u4e0d\u80fd\u540c\u65f6\u672c\u8eab\u65e2\u5305\u542b\u8fdb\u7a0b\uff0c\u53c8\u8bbe\u7f6e\u4e86 <code>subtree_control</code>\u3002</p> <p>\u5c1d\u8bd5\u64cd\u4f5c <code>subtree_control</code></p> <p>\u8bf7\u6839\u636e cgroups \u624b\u518c\u4ee5\u53ca\u4e0a\u6587\u7684\u8bf4\u660e\uff0c\u5728 <code>test</code> cgroup \u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 cgroup\uff0c\u5e76\u4e14\u4f7f\u5176\u4ec5\u5305\u542b\u5185\u5b58\u63a7\u5236\u5668\u3002 \u60f3\u4e00\u60f3\uff1a\u4e0a\u9762\u7684 <code>sleep</code> \u8fdb\u7a0b\u5e94\u8be5\u600e\u4e48\u64cd\u4f5c\uff1f</p> <p>\u5b9e\u9a8c\u5b8c\u6210\u540e\uff0c\u6740\u6389 <code>sleep</code> \u8fdb\u7a0b\uff0c\u5e76\u4e14\u4f7f\u7528 <code>rmdir</code> \u5220\u9664 <code>test</code> cgroup\uff1a</p> <pre><code># cd /sys/fs/cgroup\n# kill 1910225\n# rmdir /sys/fs/cgroup/test\n</code></pre> <p>\u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 <code>rm -r</code></p> <p>\u601d\u8003\u8fd9\u4e2a\u95ee\u9898\uff1a <code>/sys/fs/cgroup/test</code> \u5e76\u975e\u6211\u4eec\u4f20\u7edf\u610f\u4e49\u4e0a\u7684\u300c\u7a7a\u76ee\u5f55\u300d\uff0c\u4e3a\u4ec0\u4e48\u8fd9\u91cc\u8981\u7528 <code>rmdir</code>\uff0c\u800c\u4e0d\u662f\u7528 <code>rm -r</code> \u9012\u5f52\u5220\u9664\uff1f</p> <p>Cgroups \u6709\u547d\u4ee4\u884c\u5de5\u5177\u53ef\u4ee5\u5e2e\u52a9\u7ba1\u7406\uff0c\u5b89\u88c5 <code>cgroup-tools</code> \u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>cgcreate</code>\u3001<code>cgexec</code> \u7b49\u547d\u4ee4\uff1a</p> <pre><code>$ sudo cgcreate -g memory:test  # \u521b\u5efa\u4e00\u4e2a\u540d\u4e3a test \u7684 cgroup\n$ sudo cgset -r memory.max=16777216 test  # \u9650\u5236\u4f7f\u7528 16 MiB \u5185\u5b58\n$ sudo cgexec -g memory:test python3  # \u5728 test \u4e0b\u8fd0\u884c python3\nPython 3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; a = [0] * 4000000  # \u5c1d\u8bd5\u5360\u7528\u81f3\u5c11 32 MB \u5185\u5b58\nKilled\n$ sudo cgdelete memory:test  # \u6e05\u7406\u73b0\u573a\n</code></pre> <p>\u89c2\u5bdf\u8fd9\u4e9b\u547d\u4ee4\u7684\u884c\u4e3a</p> <p>\u8bf7\u4f7f\u7528\u7cfb\u7edf\u8c03\u7528\u5206\u6790\u5de5\u5177 <code>strace</code> \u89c2\u5bdf <code>cgcreate</code>\u3001<code>cgset</code>\u3001<code>cgexec</code>\u3001<code>cgdelete</code> \u7684\u6587\u4ef6\u7cfb\u7edf\u64cd\u4f5c\u3002</p> <p>\u5177\u4f53\u7684\u63a7\u5236\u5668\u4f7f\u7528\u65b9\u6cd5\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"ops/virtualization/container/#seccomp","title":"Seccomp","text":"<p>Seccomp \u662f Linux \u5185\u6838\u63d0\u4f9b\u7684\u9650\u5236\u8fdb\u7a0b\u7cfb\u7edf\u8c03\u7528\u7684\u673a\u5236\u3002 \u5982\u679c\u6ca1\u6709 seccomp\uff0c\u5373\u4f7f\u4f7f\u7528\u4e0a\u9762\u63d0\u5230\u7684\u547d\u540d\u7a7a\u95f4\u3001cgroups\uff0c\u5bb9\u5668\u5185\u7684\u8fdb\u7a0b\u4ecd\u7136\u53ef\u4ee5\u6267\u884c\u4efb\u610f\u7684\u7cfb\u7edf\u8c03\u7528\uff1a root \u6743\u9650\u7684\u8fdb\u7a0b\u53ef\u4ee5\u968f\u610f\u8fdb\u884c\u8bf8\u5982\u5173\u673a\u3001\u64cd\u4f5c\u5185\u6838\u6a21\u5757\u7b49\u5371\u9669\u64cd\u4f5c\uff0c\u8fd9\u901a\u5e38\u662f\u975e\u9884\u671f\u7684\uff1b \u5373\u4f7f\u901a\u8fc7\u7528\u6237\u673a\u5236\u9650\u5236\u4e86\u6743\u9650\uff0c\u66b4\u9732\u6240\u6709\u7684\u7cfb\u7edf\u8c03\u7528\u4ecd\u7136\u5927\u5e45\u5ea6\u589e\u52a0\u4e86\u653b\u51fb\u9762\u3002</p> <p>\u4ece\u7a0b\u5e8f\u5458\u7684\u89d2\u5ea6\uff0c\u53ef\u4ee5\u4f7f\u7528 libseccomp \u5e93\u7b80\u5316 seccomp \u7684\u4f7f\u7528\u3002</p> <p>\u6267\u884c Python 3 \u89e3\u91ca\u5668\u6700\u5c11\u9700\u8981\u591a\u5c11\u7cfb\u7edf\u8c03\u7528\uff1f</p> <p>\u4f7f\u7528 libseccomp \u7f16\u5199\u7a0b\u5e8f\uff0c\u8bbe\u7f6e\u7cfb\u7edf\u8c03\u7528\u767d\u540d\u5355\u9650\u5236\u3002 \u5c1d\u8bd5\u627e\u51fa\u6700\u5c0f\u7684\u7cfb\u7edf\u8c03\u7528\u96c6\u5408\uff0c\u5e76\u4e14\u4e86\u89e3\u5176\u4e2d\u7684\u6bcf\u4e2a\u7cfb\u7edf\u8c03\u7528\u7684\u4f5c\u7528\u3002</p>"},{"location":"ops/virtualization/container/#overlayfs","title":"Overlay \u6587\u4ef6\u7cfb\u7edf","text":"<p>Overlay \u6587\u4ef6\u7cfb\u7edf\uff08OverlayFS\uff09\u4e0d\u662f\u5bb9\u5668\u6240\u5fc5\u9700\u7684\u2014\u2014\u6bd4\u5982\u8bf4\uff0c\u4e00\u4e9b\u5bb9\u5668\u8fd0\u884c\u65f6\u652f\u6301\u50cf chroot \u4e00\u6837\uff0c\u76f4\u63a5\u4ece\u4e00\u4e2a rootfs \u76ee\u5f55\u542f\u52a8\u5bb9\u5668\uff08\u4f8b\u5982 systemd-nspawn\uff09\u3002 \u4f46\u662f\u5bf9\u4e8e Docker \u8fd9\u6837\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u5176 image \u7684\u5206\u5c42\u7ed3\u6784\u4f7f\u5f97 OverlayFS \u6210\u4e3a\u4e86\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6280\u672f\u3002 \u5c3d\u7ba1\u5bf9\u4e8e Docker \u6765\u8bf4\uff0c\u5176\u4e5f\u652f\u6301\u5176\u4ed6\u7684\u5199\u65f6\u590d\u5236\u7684\u5b58\u50a8\u9a71\u52a8\uff0c\u4f8b\u5982 Btrfs \u548c ZFS\uff0c\u4f46\u662f OverlayFS \u4ecd\u7136\u662f\u6700\u5e38\u89c1\u7684\u9009\u62e9\u2014\u2014\u56e0\u4e3a\u5b83\u4e0d\u9700\u8981\u7279\u6b8a\u7684\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\u3002</p> <p>\u6302\u8f7d OverlayFS \u9700\u8981\u4e09\u4e2a\u76ee\u5f55\uff1a</p> <ul> <li>lowerdir: \u53ea\u8bfb\u7684\u5e95\u5c42\u76ee\u5f55\uff08\u652f\u6301\u591a\u4e2a\uff09</li> <li>upperdir: \u53ef\u8bfb\u5199\u7684\u4e0a\u5c42\u76ee\u5f55</li> <li>workdir: \u9700\u8981\u4e3a\u4e0e\u4e0a\u5c42\u76ee\u5f55\u5904\u4e8e\u540c\u4e00\u6587\u4ef6\u7cfb\u7edf\u7684\u76ee\u5f55\uff0c\u7528\u4e8e\u5904\u7406\u6587\u4ef6\u7cfb\u7edf\u7684\u539f\u5b50\u64cd\u4f5c</li> </ul> <p>\u6700\u7ec8\u5408\u6210\u7684\u6587\u4ef6\u7cfb\u7edf\u4f1a\u5c06 lowerdir \u4e0e upperdir \u5408\u5e76\uff0c\u5bf9\u4e8e\u76f8\u540c\u7684\u6587\u4ef6\uff0cupperdir \u4f18\u5148\u3002 \u8ba9\u6211\u4eec\u8bd5\u4e00\u8bd5\uff1a</p> <pre><code>$ mkdir lower upper work merged\n$ echo \"lower\" &gt; lower/lower\n$ echo \"upper\" &gt; upper/upper\n$ mkdir lower/dir upper/dir\n$ echo \"lower1\" &gt; lower/dir/file1\n$ echo \"upper1\" &gt; upper/dir/file1\n$ echo \"lower2\" &gt; lower/dir/file2\n$ echo \"upper2\" &gt; upper/dir/file2\n$ echo \"lower4\" &gt; lower/dir/file4\n$ echo \"upper3\" &gt; upper/dir/file3\n$ sudo mount -t overlay overlay -o lowerdir=lower,upperdir=upper,workdir=work merged\n$ tree merged\nmerged/\n\u251c\u2500\u2500 dir\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 file1\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 file2\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 file3\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 file4\n\u251c\u2500\u2500 lower\n\u2514\u2500\u2500 upper\n\n2 directories, 6 files\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 merged \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u662f\u5408\u5e76\u540e\u7684\u7ed3\u679c\uff0c\u540c\u65f6\u5b58\u5728 lower \u548c upper \u76ee\u5f55\u7684\u6587\u4ef6\u3002</p> <pre><code>$ cat merged/lower\nlower\n$ cat merged/dir/file1\nupper1\n$ cat merged/dir/file2\nupper2\n$ cat merged/dir/file3\nupper3\n$ cat merged/dir/file4\nlower4\n</code></pre> <p>\u4e0a\u9762\u53ea\u6709 upper \u4e0d\u5b58\u5728\u7684 dir/file4 \u662f lower \u7684\u5185\u5bb9\uff0c\u56e0\u6b64\u53ef\u4ee5\u5370\u8bc1 upper \u4f18\u5148\u3002</p> <pre><code>$ echo \"merged\" &gt; merged/merged\n$ echo \"modified-lower\" &gt; merged/lower\n$ cat upper/merged\nmerged\n$ cat upper/lower\nmodified-lower\n$ cat lower/merged\ncat: lower/merged: No such file or directory\n$ cat lower/lower\nlower\n</code></pre> <p>\u53ef\u4ee5\u663e\u7136\u53d1\u73b0\u5199\u5165\u64cd\u4f5c\u4f1a\u88ab\u5e94\u7528\u5230 upperdir \u4e2d\u3002</p> <p>\u4f20\u7edf\u4e0a\uff0cOverlayFS \u6700\u5e38\u89c1\u7684\u7528\u9014\u662f\u5728 LiveCD/LiveUSB \u4e0a\u4f7f\u7528\uff1a\u5728\u53ea\u8bfb\u7684\u5e95\u5c42\u6587\u4ef6\u7cfb\u7edf\u4e0a\uff0c\u6302\u8f7d\u4e00\u4e2a\u53ef\u5199\u7684\u4e0a\u5c42\u6587\u4ef6\u7cfb\u7edf\uff0c\u7528\u4e8e\u4fdd\u5b58\u7528\u6237\u7684\u6570\u636e\u3002 \u800c\u5728\u5bb9\u5668\uff08\u7279\u522b\u662f Docker\uff09\u4e0a\uff0c\u7531\u4e8e\u5bb9\u5668\u955c\u50cf\u7684\u5206\u5c42\u8bbe\u8ba1\uff0cOverlayFS \u5c31\u6210\u4e3a\u4e86\u4e00\u4e2a\u975e\u5e38\u597d\u7684\u9009\u62e9\u3002 \u5047\u8bbe\u67d0\u4e2a\u5bb9\u5668\u955c\u50cf\u6709\u4e09\u5c42\uff0c\u6bcf\u4e00\u5c42\u90fd\u505a\u4e86\u4e00\u4e9b\u4fee\u6539\u3002\u7531\u4e8e OverlayFS \u652f\u6301\u591a\u4e2a lowerdir\uff0c \u6240\u4ee5\u6700\u540e\u5408\u6210\u51fa\u6765\u7684 image \u5c31\u662f\u7b2c\u4e00\u5c42\u57fa\u5e95 + \u7b2c\u4e8c\u5c42\u7684\u53d8\u5316\u4f5c\u4e3a lowerdir\uff0c\u7b2c\u4e09\u5c42\u4f5c\u4e3a upperdir\uff0c \u8fd9\u4e5f\u53ef\u4ee5\u4ece <code>docker image inspect</code> \u7684\u7ed3\u679c\u5370\u8bc1\uff1a</p> <pre><code>$ sudo docker image inspect 201test\n\uff08\u7701\u7565\uff09\n        \"GraphDriver\": {\n            \"Data\": {\n                \"LowerDir\": \"/var/lib/docker/overlay2/9d15ee29579c96414c51ea2e693d2fe764da2e704a005e2d398025bf8c2b85b6/diff:/var/lib/docker/overlay2/38eb305239012877d40fc4f06620d0293d7632f188b986a0ff7f30a57b6feb32/diff\",\n                \"MergedDir\": \"/var/lib/docker/overlay2/a66d2956c278d83a86454659dba3b2f75b99b41ddb39c5227b02afde898efe55/merged\",\n                \"UpperDir\": \"/var/lib/docker/overlay2/a66d2956c278d83a86454659dba3b2f75b99b41ddb39c5227b02afde898efe55/diff\",\n                \"WorkDir\": \"/var/lib/docker/overlay2/a66d2956c278d83a86454659dba3b2f75b99b41ddb39c5227b02afde898efe55/work\"\n            },\n            \"Name\": \"overlay2\"\n        },\n\uff08\u7701\u7565\uff09\n</code></pre> <p>\uff08\u5f53\u7136\uff0c\u8fd9\u91cc\u5bb9\u5668\u955c\u50cf\u4e0d\u4f1a\uff0c\u4e5f\u6ca1\u6709\u5fc5\u8981\u6302\u8f7d\uff0c\u56e0\u6b64\u5982\u679c\u5c1d\u8bd5\u8bbf\u95ee merged \u76ee\u5f55\uff0c\u4f1a\u53d1\u73b0\u4e0d\u5b58\u5728\uff09</p> <p>\u4f7f\u7528\u5bb9\u5668\u955c\u50cf\u542f\u52a8\u7684\u5bb9\u5668\u5219\u5c06\u955c\u50cf\u4f5c\u4e3a lowerdir\uff0c\u5728\u5bb9\u5668\u91cc\u9762\u7684\u5199\u5165\u64cd\u4f5c\u5219\u4f1a\u88ab\u4fdd\u5b58\u5728 upperdir \u4e2d\u3002</p> <pre><code>$ sudo docker run -it --rm --name test 201test\nroot@1522be2f7d29:/# echo 'test' &gt; /test\nroot@1522be2f7d29:/# # \u5207\u6362\u5230\u53e6\u4e00\u4e2a\u7ec8\u7aef\n$ sudo docker inspect test\n\uff08\u7701\u7565\uff09\n\"GraphDriver\": {\n            \"Data\": {\n                \"LowerDir\": \"/var/lib/docker/overlay2/34e8198226f478c89021fd9a00a31570cdda57d4fcea66a0bb8506cf7b81dff5-init/diff:/var/lib/docker/overlay2/a66d2956c278d83a86454659dba3b2f75b99b41ddb39c5227b02afde898efe55/diff:/var/lib/docker/overlay2/9d15ee29579c96414c51ea2e693d2fe764da2e704a005e2d398025bf8c2b85b6/diff:/var/lib/docker/overlay2/38eb305239012877d40fc4f06620d0293d7632f188b986a0ff7f30a57b6feb32/diff\",\n                \"MergedDir\": \"/var/lib/docker/overlay2/34e8198226f478c89021fd9a00a31570cdda57d4fcea66a0bb8506cf7b81dff5/merged\",\n                \"UpperDir\": \"/var/lib/docker/overlay2/34e8198226f478c89021fd9a00a31570cdda57d4fcea66a0bb8506cf7b81dff5/diff\",\n                \"WorkDir\": \"/var/lib/docker/overlay2/34e8198226f478c89021fd9a00a31570cdda57d4fcea66a0bb8506cf7b81dff5/work\"\n            },\n            \"Name\": \"overlay2\"\n        },\n\uff08\u7701\u7565\uff09\n$ sudo ls /var/lib/docker/overlay2/34e8198226f478c89021fd9a00a31570cdda57d4fcea66a0bb8506cf7b81dff5/diff/\ntest\n</code></pre> <p>\u89e3\u91ca Dockerfile \u7f16\u5199\u4e2d\u7684\u5b9e\u8df5</p> <p>\u4ece OverlayFS \u7684\u89d2\u5ea6\uff0c\u89e3\u91ca\u4ee5\u4e0b Dockerfile \u5b58\u5728\u7684\u95ee\u9898\uff1a</p> <pre><code># \u4ee5\u4e0a\u90e8\u5206\u7701\u7565\nRUN wget -O /tmp/example.tar.gz https://example.com/example.tar.gz\nRUN tar -zxvf /tmp/example.tar.gz -C /tmp\nRUN make &amp;&amp; make install\nRUN rm -rf /tmp/*\n</code></pre>"},{"location":"ops/virtualization/container/#docker","title":"Docker","text":""},{"location":"ops/virtualization/container/#docker-basic","title":"\u57fa\u7840\u6982\u5ff5\u590d\u4e60","text":"<p>Docker \u662f\u4f17\u591a\u5bb9\u5668\u8fd0\u884c\u65f6\u4e2d\u7684\u4e00\u79cd\uff08\u4e5f\u662f\u6700\u6d41\u884c\u7684\u4e00\u79cd\uff09\u3002\u7528\u6237\u53ef\u4ee5\u4ece registry \u83b7\u53d6 image\uff0c \u83b7\u5f97\u7684 image \u53ef\u4ee5\u76f4\u63a5\u521b\u5efa container \u8fd0\u884c\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Dockerfile \u6765\u5b9a\u5236 image\u3002 \u9664\u6b64\u4e4b\u5916\uff0cDocker \u4e5f\u63d0\u4f9b\u4e86\u4e0e\u5b58\u50a8\uff08volume\uff09\u3001\u7f51\u7edc\uff08network\uff09\u7b49\u76f8\u5173\u7684\u529f\u80fd\u3002 Docker \u7684\u8bbe\u8ba1\u4e3b\u8981\u8003\u8651\u4e86\u5f00\u53d1\u4e0e\u90e8\u7f72\u7684\u4fbf\u5229\u6027\u3002</p> <p>Docker \u91c7\u53d6 C-S \u67b6\u6784\uff0cserver daemon\uff08dockerd\uff09\u66b4\u9732\u4e00\u4e2a UNIX socket\uff08<code>/run/docker.sock</code>\uff09\uff0c \u7528\u6237\u901a\u8fc7 <code>docker</code> \u8fd9\u4e2a CLI \u5de5\u5177\uff0c\u6216\u8005\u81ea\u884c\u7f16\u5199\u7a0b\u5e8f\u4e0e\u5176\u901a\u4fe1\u3002 \u8fd9\u4e2a daemon \u7684\u5bb9\u5668\u64cd\u4f5c\u5219\u662f\u4e0e containerd \u8fdb\u884c\u4ea4\u4e92\u3002</p> <p>Podman</p> <p>\u5bf9\u6bd4 Docker \u7684 C-S \u67b6\u6784\uff0c\u7ea2\u5e3d\u4e3b\u63a8\u7684 Podman \u5219\u4e0d\u518d\u4f9d\u8d56\u4e8e daemon \u8fdb\u884c\u5bb9\u5668\u7ba1\u7406\u3002</p> <p>\u6700\u7b80\u5355\u7684\u521b\u5efa\u5bb9\u5668\u7684\u65b9\u6cd5\u662f\uff1a</p> <pre><code>sudo docker run -it --rm --name test ubuntu:22.04\n</code></pre> <p>\u52a0\u5165 docker \u7528\u6237\u7ec4\u7b49\u4ef7\u4e8e\u63d0\u4f9b root \u6743\u9650</p> <p>\u5728\u9ed8\u8ba4\u5b89\u88c5\u4e0b\uff0cDocker socket \u53ea\u6709\u4f4d\u4e8e docker \u7528\u6237\u7ec4\u7684\u7528\u6237\u624d\u80fd\u8bbf\u95ee\uff0c\u5bf9\u5e94\u7684 server daemon \u7a0b\u5e8f\u4ee5 root \u6743\u9650\u8fd0\u884c\u3002 \u5c06\u7528\u6237\u52a0\u5165 docker \u7528\u6237\u7ec4\u5373\u6388\u6743\u4e86\u5bf9\u5e94\u7684\u7528\u6237\u4e0e Docker \u7684 UNIX socket\uff0c\u6216\u8005\u8bf4\u4e0e dockerd \u670d\u52a1\u7aef\uff0c\u4efb\u610f\u901a\u4fe1\u7684\u6743\u9650\u3002 \u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u7279\u6743\u5bb9\u5668\u3001\u4efb\u610f\u6302\u8f7d\u5bbf\u4e3b\u673a\u76ee\u5f55\u7b49\u64cd\u4f5c\u6765\u5b9e\u9645\u505a\u548c root \u4e00\u6a21\u4e00\u6837\u7684\u4e8b\u60c5\u3002</p> <p>2023 \u5e74\u7684 Hackergame \u6709\u4e00\u9053\u76f8\u5173\u7684\u9898\u76ee\uff1aDocker for Everyone\u3002</p> <p>\u57fa\u4e8e\u76f8\u540c\u7684\u7406\u7531\uff0c\u5982\u679c\u9700\u8981\u8de8\u673a\u5668\u64cd\u4f5c Docker\uff0c\u4e5f\u4e0d\u5e94\u8be5\u7528 <code>-H tcp://</code> \u7684\u65b9\u5f0f\u5f00\u542f\u8fdc\u7a0b\u8bbf\u95ee\u3002 \u8bf7\u9605\u8bfb https://docs.docker.com/engine/security/protect-access/ \u4e86\u89e3\u5b89\u5168\u914d\u7f6e\u8fdc\u7a0b\u8bbf\u95ee Docker \u7684\u65b9\u6cd5\u3002</p> <p>\u4ee5\u4e0b\u6240\u6709\u5757\u4ee3\u7801\u793a\u4f8b\u4e2d\u5747\u4f1a\u4f7f\u7528 <code>sudo</code>\u3002</p> <p>\u4fdd\u6301\u73af\u5883\u6574\u6d01\uff1a\u7ed9\u5bb9\u5668\u8d77\u540d\uff0c\u5e76\u4e14\u4e3a\u4e34\u65f6\u4f7f\u7528\u7684\u5bb9\u5668\u52a0\u4e0a <code>--rm</code></p> <p>\u4e00\u4e2a\u975e\u5e38\u5e38\u89c1\u7684\u95ee\u9898\u662f\uff0c\u5f88\u591a\u4eba\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\u76f4\u63a5\u8fd9\u4e48\u505a\uff1a</p> <pre><code>sudo docker run -it ubuntu:22.04\n</code></pre> <p>\u7136\u540e\u505a\u4e86\u4e00\u4e9b\u64cd\u4f5c\u4e4b\u540e\u5c31\u76f4\u63a5\u9000\u51fa\u4e86\u3002\u8fd9\u4e48\u505a\u7684\u540e\u679c\uff0c\u5c31\u662f\u5728 <code>docker ps -a</code> \u7684\u65f6\u5019\uff0c\u53d1\u73b0\u4e00\u5927\u5806\u5df2\u7ecf\u5904\u4e8e\u9000\u51fa\u72b6\u6001\u7684\u5bb9\u5668\u3002</p> <p>\u52a0\u4e0a <code>--name</code> \u53c2\u6570\u547d\u540d\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4e4b\u540e\u5224\u65ad\u5bb9\u5668\u7684\u7528\u9014\uff1b\u52a0\u4e0a <code>--rm</code> \u53c2\u6570\u5219\u4f1a\u5728\u5bb9\u5668\u9000\u51fa\u540e\u81ea\u52a8\u5220\u9664\u5bb9\u5668\u3002</p> <p>\u53e6\u5916\u521b\u5efa\u5bb9\u5668\u65f6\u975e\u5e38\u5e38\u89c1\u7684\u9700\u6c42\uff1a</p> <ul> <li><code>-e KEY=VALUE</code>/<code>--env KEY=VALUE</code>\uff1a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf</li> <li><code>-v HOST_PATH:CONTAINER_PATH</code>\uff1a\u6302\u8f7d\u5bbf\u4e3b\u673a\u76ee\u5f55<ul> <li>\u76f8\u5bf9\u8def\u5f84\u9700\u8981\u81ea\u884c\u52a0\u4e0a <code>$(pwd)</code>\uff0c\u50cf\u8fd9\u6837\uff1a<code>-v $(pwd)/data:/data</code></li> </ul> </li> <li><code>-p HOST_PORT:CONTAINER_PORT</code>\uff1a\u6620\u5c04\u7aef\u53e3</li> <li><code>--restart=always</code>/<code>--restart=unless-stopped</code>\uff1a\u8bbe\u7f6e\u5bb9\u5668\u542f\u52a8\u3001\u91cd\u542f\u7b56\u7565\uff08\u53ef\u4ee5\u4f7f\u7528 <code>docker update</code> \u4fee\u6539\uff09</li> <li><code>--memory=512m --memory-swap=512m</code>\uff1a\u9650\u5236\u5bb9\u5668\u5185\u5b58\u4f7f\u7528</li> </ul> <p>\u6620\u5c04\u7aef\u53e3\u7684\u5b89\u5168\u6027</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cDocker \u4f1a\u81ea\u884c\u7ef4\u62a4 iptables \u89c4\u5219\uff0c\u5e76\u4e14\u8fd9\u6837\u7684\u89c4\u5219\u4e0d\u53d7 ufw \u7b49\u5de5\u5177\u7684\u7ba1\u7406\u3002 \u8fd9\u4f1a\u5bfc\u81f4\u66b4\u9732\u7684\u7aef\u53e3\u7ed5\u8fc7\u4e86\u7cfb\u7edf\u7684\u9632\u706b\u5899\u3002</p> <p>\u5982\u679c\u4e0d\u9700\u8981\u5176\u4ed6\u673a\u5668\u8bbf\u95ee\uff0c\u4f7f\u7528 <code>-p 127.0.0.1:xxxx:xxxx</code>\uff0c\u800c\u975e <code>-p xxxx:xxxx</code>\u3002 \u4f5c\u4e3a\u4e00\u4e2a\u771f\u5b9e\u7684\u6848\u4f8b\uff0c\u67d0\u670d\u52a1\u5668\u8fd9\u6837\u542f\u52a8\u4e86\u4e00\u4e2a MongoDB \u6570\u636e\u5e93\u5bb9\u5668\uff1a</p> <pre><code>sudo docker run -p 27017:27017 -tid --name mongo mongo:3.6\n</code></pre> <p>\u8fc7\u4e86\u51e0\u4e2a\u6708\uff0c\u53d1\u73b0\u7a0b\u5e8f\u529f\u80fd\u4e0d\u6b63\u5e38\uff0c\u518d\u4e00\u770b\u624d\u53d1\u73b0\u6570\u636e\u88ab\u52a0\u5bc6\u52d2\u7d22\u4e86\u2014\u2014\u4e07\u5e78\u7684\u662f\u91cc\u9762\u6ca1\u6709\u91cd\u8981\u7684\u5185\u5bb9\u3002</p> <p>\u4ee5\u53ca\u5e38\u89c1\u7684\u5bb9\u5668\u7ba1\u7406\u547d\u4ee4\uff1a</p> <ul> <li><code>docker ps</code>\uff1a\u67e5\u770b\u5bb9\u5668</li> <li><code>docker exec -it CONTAINER COMMAND</code>\uff1a\u5728\u5bb9\u5668\u5185\u6267\u884c\u547d\u4ee4</li> <li><code>docker inspect CONTAINER</code>\uff1a\u67e5\u770b\u5bb9\u5668\u8be6\u7ec6\u4fe1\u606f</li> </ul> <p>\u4e0e\u67e5\u770b\u3001\u6e05\u7406 Docker \u78c1\u76d8\u5360\u7528\u7b49\u64cd\u4f5c\uff1a</p> <ul> <li><code>docker system df</code>\uff1a\u67e5\u770b\u955c\u50cf\u3001\u5bb9\u5668\u3001volume \u4e0e\u6784\u5efa\u7f13\u5b58\u7684\u78c1\u76d8\u5360\u7528</li> <li><code>docker system prune --volumes --all</code>\uff1a\u6e05\u7406\u4e0d\u518d\u4f7f\u7528\u7684\u955c\u50cf\u3001\u5bb9\u5668\u3001volume\u3001network \u4e0e\u5168\u90e8\u6784\u5efa\u7f13\u5b58</li> </ul>"},{"location":"ops/virtualization/container/#docker-import-export","title":"\u5bfc\u5165\u4e0e\u5bfc\u51fa","text":"<p>Docker \u652f\u6301\u5bfc\u51fa\u5bb9\u5668\u4e0e\u955c\u50cf\uff0c\u5e76\u4ee5\u955c\u50cf\u7684\u5f62\u5f0f\u5bfc\u5165\uff0c\u683c\u5f0f\u5747\u4e3a tar\u3002\u53ef\u4ee5\u901a\u8fc7\u7ba1\u9053\u7684\u65b9\u5f0f\u5b9e\u73b0\u538b\u7f29\uff1a</p> <pre><code>$ # \u955c\u50cf\u5bfc\u5165/\u5bfc\u51fa\n$ sudo docker image save hello-world:latest | zstd -o hello-world.tar.zst\n/*stdin*\\            : 15.11%   (  26.0 KiB =&gt;   3.93 KiB, hello-world.tar.zst)\n$ sudo docker image rm hello-world:latest\n$ zstd -d -c hello-world.tar.zst | sudo docker image load\ne07ee1baac5f: Loading layer [==================================================&gt;]  14.85kB/14.85kB\nLoaded image: hello-world:latest\n$ # \u5bb9\u5668\u5bfc\u51fa\uff0c\u5e76\u4ee5\u955c\u50cf\u5f62\u5f0f\u5bfc\u5165\n$ sudo docker run -it --name test ustclug/debian:12 touch /test\n$ sudo docker container export test | zstd -o test.tar.zst\n/*stdin*\\            : 33.93%   (   116 MiB =&gt;   39.2 MiB, test.tar.zst)\n$ sudo docker rm test\n$ zstd -d -c test.tar.zst | sudo docker import - test\nsha256:21a35d8f910941f4913ada5f3600c04234d13860fe498ac5cb301ba1801aa82c\n$ sudo docker run -it --rm test ls /test\n/test\n</code></pre> <p>\u5176\u4e2d\u955c\u50cf\u5bfc\u51fa\uff08save\uff09\u540e\u4ecd\u7136\u6709\u5c42\u7ea7\u7ed3\u6784\uff0c\u4f46\u662f\u5bb9\u5668\u5bfc\u51fa\uff08export\uff09\u540e\u5219\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</p> <p>\u4e5f\u6709\u4e00\u4e9b\u5de5\u5177\uff0c\u4f8b\u5982 dive\uff0c\u53ef\u4ee5\u65b9\u4fbf\u5730\u67e5\u770b\u955c\u50cf\u6bcf\u4e00\u5c42\u7684\u5185\u5bb9\u3002</p>"},{"location":"ops/virtualization/container/#docker-multi-stage","title":"\u591a\u9636\u6bb5\u6784\u5efa","text":"<p>\u5728\u5236\u4f5c\u5bb9\u5668\u955c\u50cf\u7684\u65f6\u5019\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u573a\u666f\u662f\uff1a\u7f16\u8bd1\u8f6f\u4ef6\u548c\u5b9e\u9645\u8fd0\u884c\u7684\u73af\u5883\u662f\u4e0d\u540c\u7684\u3002 \u5982\u679c\u5c06\u4e24\u8005\u5199\u5728\u4e0d\u540c\u7684 Dockerfile \u4e2d\uff0c\u5b9e\u9645\u64cd\u4f5c\u4f1a\u5f88\u9ebb\u70e6\uff08\u9700\u8981\u5148\u6784\u5efa\u7f16\u8bd1\u5bb9\u5668\u3001\u8fd0\u884c\u5bb9\u5668\u3001\u518d\u6784\u5efa\u8fd0\u884c\u73af\u5883\u5bb9\u5668\uff09\uff1b \u5982\u679c\u5199\u5728\u540c\u4e00\u4e2a Dockerfile \u91cc\u9762\uff0c\u5e76\u4e14\u9700\u8981\u6e05\u7406\u6389\u5b9e\u9645\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u6587\u4ef6\uff0c\u4e5f\u4f1a\u975e\u5e38\u975e\u5e38\u9ebb\u70e6\uff1a</p> <pre><code># \u90a3\u4e48\u53ef\u80fd\u53ea\u80fd\u8fd9\u4e48\u5199\uff0c\u5426\u5219\u7f16\u8bd1\u73af\u5883\u4ecd\u7136\u4f1a\u6b8b\u7559\u5728\u955c\u50cf\u4e2d\nRUN apt install -y some-dev-package another-dev-package ... &amp;&amp; \\\n    wget https://example.com/some-source.tar.gz &amp;&amp; \\\n    tar -zxvf some-source.tar.gz &amp;&amp; \\\n    ./configure --some-option &amp;&amp; make &amp;&amp; make install &amp;&amp; \\\n    rm -rf /some-source.tar.gz /some-source &amp;&amp; \\\n    apt remove -y some-dev-package another-dev-package ... &amp;&amp; \\\n</code></pre> <p>Dockerfile \u5bf9\u591a\u9636\u6bb5\uff08multi-stage\uff09\u7684\u652f\u6301\u5f88\u597d\u5730\u89e3\u51b3\u4e86\u8fd9\u4e2a\u95ee\u9898\uff0c\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>FROM alpine:3.15 AS builder\nRUN apk add --no-cache build-base\nWORKDIR /tmp\nADD example.c .\nRUN gcc -o example example.c\n\nFROM alpine:3.15\nCOPY --from=builder /tmp/example /usr/local/bin/example\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\uff0c\u8fd9\u4e2a Dockerfile \u6709\u591a\u4e2a <code>FROM</code> \u4ee3\u8868\u4e86\u591a\u4e2a\u9636\u6bb5\u3002 \u7b2c\u4e00\u9636\u6bb5\u7684 <code>FROM</code> \u540e\u9762\u52a0\u4e0a\u4e86 <code>AS builder</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u7b2c\u4e8c\u9636\u6bb5\u4f7f\u7528 <code>COPY --from=builder</code> \u4ece\u7b2c\u4e00\u9636\u6bb5\u62f7\u8d1d\u6587\u4ef6\u3002</p>"},{"location":"ops/virtualization/container/#docker-gui","title":"\u8fd0\u884c\u56fe\u5f62\u5e94\u7528","text":"<p>\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u56fe\u5f62\u7a0b\u5e8f\u4e5f\u662f\u76f8\u5f53\u5e38\u89c1\u7684\u9700\u6c42\u3002 \u4ee5\u4e0b\u7b80\u5355\u4ecb\u7ecd\u5728 Docker \u4e2d\u8fd0\u884c X11 \u56fe\u5f62\u5e94\u7528\uff08\u5373 X \u5ba2\u6237\u7aef\uff09\u7684\u65b9\u6cd5\uff0c\u5047\u8bbe\u4e3b\u673a\u73af\u5883\u5df2\u7ecf\u914d\u7f6e\u597d\u4e86 X \u670d\u52a1\u5668\u3002</p> <p>X \u5ba2\u6237\u7aef\u4e0e\u670d\u52a1\u5668</p> <p>X \u670d\u52a1\u5668\u8d1f\u8d23\u663e\u793a\u56fe\u5f62\u754c\u9762\uff0c\u800c\u5177\u4f53\u7684\u56fe\u5f62\u754c\u9762\u7a0b\u5e8f\uff0c\u5373 X \u5ba2\u6237\u7aef\uff0c\u5219\u9700\u8981\u8fde\u63a5\u5230 X \u670d\u52a1\u5668\u624d\u80fd\u7ed8\u5236\u51fa\u81ea\u5df1\u7684\u7a97\u53e3\u3002</p> <p>\u5982\u679c\u4f60\u6b63\u5728\u4f7f\u7528 Linux \u4f5c\u4e3a\u684c\u9762\u73af\u5883\uff0c\u90a3\u4e48\u8981\u4e48\u6574\u4e2a\u684c\u9762\u73af\u5883\u5c31\u7531 X \u670d\u52a1\u5668\u6e32\u67d3\uff0c\u8981\u4e48\u5728 Wayland \u4e0b Xwayland \u4f1a\u4f5c\u4e3a X \u670d\u52a1\u5668\u63d0\u4f9b\u517c\u5bb9\u3002\u5982\u679c\u6b63\u5728\u4f7f\u7528 Windows \u6216 macOS\uff0c\u5219\u9700\u8981\u5404\u81ea\u5b89\u88c5 X \u670d\u52a1\u5668\u5b9e\u73b0\u3002</p> <p>\u5bf9\u4e8e SSH \u8fde\u63a5\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>ssh -X</code>\uff08\u6216 <code>ssh -Y</code> (1)\uff09\u4e3a\u8fdc\u7a0b\u7684\u670d\u52a1\u5668\u4e0a\u7684 X \u5ba2\u6237\u7aef\u66b4\u9732\u81ea\u5df1\u7684 X \u670d\u52a1\u5668\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u5047\u8bbe\u4e86 X \u670d\u52a1\u5668 socket \u662f\u4e00\u4e2a\u672c\u5730\u7684 UNIX socket \u6587\u4ef6\uff0c\u4f46\u662f\u8fd9\u5bf9 SSH X forwarding \u7684\u573a\u666f\u6765\u8bf4\u5e76\u4e0d\u9002\u7528\uff08SSH \u4f1a\u4f7f\u7528 TCP \u8f6c\u53d1 X \u7aef\u53e3\uff09\u3002\u5bf9\u5e94\u7684\uff0c\u5982\u679c\u6b63\u5728\u4f7f\u7528 SSH \u6d4b\u8bd5\u4e0b\u9762\u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u5728\u4f20\u9012\u73af\u5883\u53d8\u91cf\u4e0e <code>$HOME/.Xauthority</code> \u6587\u4ef6\u7684\u540c\u65f6\uff0c\u8fd8\u9700\u8981\u8bbe\u7f6e\u5bb9\u5668\u4e0e\u4e3b\u673a\u4f7f\u7528\u76f8\u540c\u7684\u7f51\u7edc\uff08<code>--network host</code>\uff09\u3002</p> <ol> <li>\u5f53\u4f7f\u7528 <code>-X</code> \u65f6\uff0c\u670d\u52a1\u7aef\u4f1a\u5047\u8bbe\u5ba2\u6237\u7aef\u662f\u4e0d\u53ef\u4fe1\u4efb\u7684\uff0c\u56e0\u6b64\u4f1a\u9650\u5236\u4e00\u4e9b\u64cd\u4f5c\uff1b<code>-Y</code> \u9009\u9879\u5219\u4f1a\u653e\u5bbd\u8fd9\u4e9b\u9650\u5236\u3002\u8be6\u89c1 ssh_config(5) \u5bf9 <code>ForwardX11Trusted</code> \u7684\u4ecb\u7ecd\u3002</li> </ol> <p>X \u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u670d\u52a1\u5668\uff0c\u9996\u5148\u9700\u8981\u77e5\u9053 X \u670d\u52a1\u5668\u7684\u5730\u5740\u3002\u8fd9\u662f\u7531 <code>DISPLAY</code> \u73af\u5883\u53d8\u91cf\u6307\u5b9a\u7684\uff0c\u4e00\u822c\u662f <code>:0</code>\uff0c\u4ee3\u8868\u8fde\u63a5\u5230 <code>/tmp/.X11-unix/X0</code> \u8fd9\u4e2a UNIX socket\u3002 \u6b64\u5916\uff0c\u7531\u4e8e X \u7684\u534f\u8bae\u8bbe\u8ba1\u662f\u300c\u7f51\u7edc\u900f\u660e\u300d\u7684\uff0c\u56e0\u6b64 X \u670d\u52a1\u5668\u7406\u8bba\u4e0a\u4e5f\u53ef\u4ee5\u4ee5 TCP \u7684\u65b9\u5f0f\u66b4\u9732\u51fa\u6765\uff08\u4f46\u662f\u4e0d\u5efa\u8bae\u8fd9\u4e48\u505a\uff09\uff0c\u5ba2\u6237\u7aef\u901a\u8fc7\u7c7b\u4f3c\u4e8e <code>DISPLAY=host:port</code> \u7684\u65b9\u5f0f\u8fde\u63a5\u3002</p> <p>\u56e0\u6b64\uff0c\u9996\u5148\u9700\u8981\u4f20\u9012 <code>DISPLAY</code> \u73af\u5883\u53d8\u91cf\uff0c\u5e76\u4e14\u5c06 <code>/tmp/.X11-unix</code> \u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff1a</p> <pre><code>sudo docker run -it --rm -e \"DISPLAY=$DISPLAY\" -v /tmp/.X11-unix:/tmp/.X11-unix ustclug/debian:12\n</code></pre> <p>\u4e3a\u4e86\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u5728\u5bb9\u5668\u91cc\u5b89\u88c5 <code>x11-apps</code>\uff0c\u7136\u540e\u8fd0\u884c <code>xeyes</code>\u3002\u5982\u679c\u914d\u7f6e\u6b63\u786e\uff0c\u53ef\u4ee5\u770b\u5230\u4e00\u53cc\u773c\u775b\u5728\u8ddf\u968f\u9f20\u6807\u3002 \u4f46\u662f\u4e0a\u9762\u7684\u914d\u7f6e\u662f\u4e0d\u591f\u7684\uff1a</p> <pre><code>root@6f640b929f0e:/# xeyes\nAuthorization required, but no authorization protocol specified\n\nError: Can't open display: :0\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a X \u670d\u52a1\u5668\u9700\u8981\u8ba4\u8bc1\u4fe1\u606f\u624d\u80fd\u591f\u8fde\u63a5\uff0c\u5bf9\u5e94\u7684\u8ba4\u8bc1\u4fe1\u606f\u5c31\u5728\u540d\u4e3a \"Xauthority\" \u7684\u6587\u4ef6\u4e2d\uff0c\u5bf9\u5e94 <code>XAUTHORITY</code> \u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code>$ echo $XAUTHORITY  # \u4e00\u4e2a\u4f8b\u5b50\uff0c\u5b9e\u9645\u503c\u4f1a\u6839\u636e\u73af\u5883\u4e0d\u540c\u800c\u4e0d\u540c\n/run/user/1000/.mutter-Xwaylandauth.5S15L2\n</code></pre> <p>\u5982\u679c\u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u4e0d\u5b58\u5728\uff0c\u90a3\u4e48\u5c31\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u503c\uff1a\u5f53\u524d\u7528\u6237\u7684\u5bb6\u76ee\u5f55\u4e0b\u7684 <code>.Xauthority</code> \u6587\u4ef6\u3002</p> <p>\u907f\u514d\u76f4\u63a5\u5173\u95ed\u8ba4\u8bc1\u7684\u505a\u6cd5</p> <p>\u5982\u679c\u9605\u8bfb\u7f51\u7edc\u4e0a\u7684\u4e00\u4e9b\u6559\u7a0b\uff0c\u5b83\u4eec\u53ef\u80fd\u4f1a\u5efa\u8bae\u76f4\u63a5\u5173\u95ed X \u670d\u52a1\u5668\u7684\u8ba4\u8bc1\uff0c\u5c31\u50cf\u8fd9\u6837\uff1a</p> <pre><code>xhost +\n</code></pre> <p>\u8fd9\u5728\u5b89\u5168\u6027\u4e0a\u662f\u975e\u5e38\u7cdf\u7cd5\u7684\u505a\u6cd5\uff0c\u56e0\u4e3a\u8fd9\u6837\u7684\u8bdd\u5c31\u4f1a\u5141\u8bb8\u6240\u6709\u80fd\u8bbf\u95ee\u5230 X \u670d\u52a1\u5668\u7684\u4eba/\u7a0b\u5e8f\u8fde\u63a5\u3002</p> <p>\u6240\u4ee5\u4e5f\u9700\u8981\u5c06\u8fd9\u4e00\u5bf9\u73af\u5883\u53d8\u91cf\u548c\u6587\u4ef6\u585e\u8fdb\u6765\uff1a</p> <pre><code>sudo docker run -it --rm -e \"DISPLAY=$DISPLAY\" -e \"XAUTHORITY=$XAUTHORITY\" -v /tmp/.X11-unix:/tmp/.X11-unix -v $XAUTHORITY:$XAUTHORITY ustclug/debian:12\n</code></pre> <p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u57fa\u672c\u7684\u56fe\u5f62\u5e94\u7528\u4e86\u3002 \u4e0d\u8fc7\uff0c\u5982\u679c\u5b9e\u9645\u9700\u6c42\u662f\u5728\u7c7b\u4f3c\u6c99\u76d2\u7684\u73af\u5883\u4e2d\u8fd0\u884c\u56fe\u5f62\u5e94\u7528\uff0c\u6709\u4e00\u4e9b\u66f4\u5408\u9002\u7684\u9009\u62e9\uff0c\u4f8b\u5982 bubblewrap \u4ee5\u53ca\u57fa\u4e8e\u6b64\u7684 Flatpak \u7b49\u3002</p> GPU <p>\uff08\u4ee5\u4e0b\u5185\u5bb9\u4e0d\u5b8c\u5168\u9002\u7528\u4e8e\u4f7f\u7528 NVIDIA \u4e13\u6709\u9a71\u52a8\u7684 NVIDIA GPU\uff09</p> <p>\u5728 Linux \u4e0b\uff0cGPU \u8bbe\u5907\u6587\u4ef6\u4f4d\u4e8e <code>/dev/dri</code> \u76ee\u5f55\u4e0b\u3002\u6bcf\u5f20\u663e\u5361\u4f1a\u66b4\u9732\u4e24\u4e2a\u8bbe\u5907\u6587\u4ef6\uff0c\u5176\u4e2d <code>cardX</code> \u4ee3\u8868\u4e86\u5b8c\u6574\u7684 GPU \u8bbe\u5907\uff08\u6709\u5199\u5165\u6743\u9650\u76f8\u5f53\u4e8e\u6709\u63a7\u5236 GPU \u7684\u5b8c\u6574\u6743\u9650\uff09\uff0c\u800c <code>renderDXXX</code> \u4ee3\u8868\u4e86 GPU \u7684\u6e32\u67d3\u8bbe\u5907\u3002\u5bf9\u4e8e\u9700\u8981 GPU \u52a0\u901f\u6e32\u67d3\u7684\u573a\u666f\uff0c\u4e3a\u5176\u6302\u8f7d <code>/dev/dri/renderDXXX</code> \u8bbe\u5907\u5373\u53ef\u3002</p> <p>\u4e0e\u6b64\u540c\u65f6\uff0c\u5bb9\u5668\u5185\u8fd8\u9700\u8981\u5b89\u88c5\u5bf9\u5e94\u7684 GPU \u7528\u6237\u6001\u9a71\u52a8\u3002\u5bf9\u4e8e\u5f00\u6e90\u9a71\u52a8\u6765\u8bf4\uff0c\u5b89\u88c5 Mesa \u5373\u53ef\u3002</p>"},{"location":"ops/virtualization/container/#registry","title":"Registry","text":"<p>Registry \u662f\u5b58\u50a8\u4e0e\u5206\u53d1\u5bb9\u5668\u955c\u50cf\u7684\u670d\u52a1\u3002\u5728\u5927\u90e8\u5206\u65f6\u5019\uff0c\u6211\u4eec\u4f7f\u7528\u7684 registry \u662f Docker Hub\u3002</p> <p>\u533a\u5206 Docker \u548c Docker Hub</p> <p>Docker \u662f\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u800c Docker Hub \u662f\u4e00\u4e2a registry \u670d\u52a1\u3002\u9664\u4e86 Docker Hub \u4ee5\u5916\uff0c\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684 registry \u670d\u52a1\uff0c \u8fd9\u4e9b\u670d\u52a1\u63d0\u4f9b\u7684\u5bb9\u5668\u955c\u50cf\u4e5f\u53ef\u4ee5\u6b63\u5e38\u5728 Docker \u4e2d\u4f7f\u7528\u3002</p> <p>\u955c\u50cf\u540d\u79f0\u7684\u683c\u5f0f\u662f <code>registry.example.com:username/image:tag</code>\uff0c\u5176\u4e2d\u5728 Docker \u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a registry\uff0c\u9ed8\u8ba4\u4f1a\u4f7f\u7528 Docker Hub\uff1b\u800c\u5982\u679c\u6ca1\u6709\u6307\u5b9a username\uff0c\u5219\u9ed8\u8ba4\u4f1a\u6307\u5b9a\u4e3a <code>library</code>\uff0c\u5176\u4ee3\u8868 Docker Hub \u4e2d\u7684\u300c\u5b98\u65b9\u300d\u955c\u50cf\u3002</p> <p>Registry \u670d\u52a1\u5927\u591a\u5141\u8bb8\u7528\u6237\u4e0a\u4f20\u81ea\u5df1\u7684\u5bb9\u5668\u955c\u50cf\u3002\u5728\u5bf9\u5e94\u7684\u670d\u52a1\u6ce8\u518c\u5e10\u53f7\uff0c\u4f7f\u7528 <code>docker login</code> \u767b\u5f55\u4e4b\u540e\uff0c\u9700\u8981\u5148\u4f7f\u7528 <code>docker tag</code> \u4e3a\u81ea\u5df1\u7684\u955c\u50cf\u6253\u4e0a\u5bf9\u5e94\u7684\u6807\u7b7e\uff1a</p> <pre><code>sudo docker tag example:latest registry.example.com:username/example:latest\n</code></pre> <p>\u7136\u540e\u518d <code>docker push</code>\uff1a</p> <pre><code>sudo docker push registry.example.com:username/example:latest\n</code></pre> <p>\u9664\u4e86 Docker Hub \u4ee5\u5916\uff0c\u53e6\u4e00\u4e2a\u6bd4\u8f83\u5e38\u89c1\u7684 registry \u670d\u52a1\u662f GitHub Container Registry (ghcr)\u3002\u5b83\u4e0e GitHub \u7684\u5176\u4ed6\u529f\u80fd\uff0c\u5982 Actions \u6709\u66f4\u597d\u7684\u96c6\u6210\uff08\u4f8b\u5982\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>${{ secrets.GITHUB_TOKEN }}</code> \u6765\u767b\u5f55\u5230 ghcr\uff09\u3002\u8c37\u6b4c\u548c\u7ea2\u5e3d\u4e5f\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684 registry \u670d\u52a1\u3002</p>"},{"location":"ops/virtualization/container/#volume","title":"Volume","text":"<p>Volume \u662f Docker \u63d0\u4f9b\u7684\u4e00\u79cd\u6301\u4e45\u5316\u5b58\u50a8\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u7528\u4e8e\u4fdd\u5b58\u6570\u636e\u3001\u914d\u7f6e\u7b49\u3002 \u4e0a\u9762\u4ecb\u7ecd\u4e86\u4f7f\u7528 <code>-v HOST_PATH:CONTAINER_PATH</code> \u7684\u65b9\u5f0f\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\uff0c\u4e0d\u8fc7\u5982\u679c\u5c06\u53c2\u6570\u5199\u6210 <code>-v VOLUME_NAME:CONTAINER_PATH</code> \u7684\u5f62\u5f0f\uff0c\u90a3\u4e48 Docker \u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u4ee5\u6b64\u547d\u540d\u7684 volume\uff0c\u5e76\u4e14\u5c06\u5176\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u3002</p> <pre><code>$ sudo docker run -it --rm -v myvolume:/myvolume ustclug/debian:12\nroot@c273ee70fe7a:/# touch /myvolume/a\nroot@c273ee70fe7a:/# ls /myvolume/\na\n</code></pre> <p>Volume \u5728\u8fd9\u91cc\u4e0d\u4f1a\u56e0\u4e3a\u5bb9\u5668\u9500\u6bc1\u88ab\u5220\u9664\uff1a</p> <pre><code>root@c273ee70fe7a:/#\n$ # \u539f\u6765\u7684\u5bb9\u5668\u6ca1\u4e86\uff0c\u6302\u8f7d\u76f8\u540c\u7684 volume \u5f00\u4e2a\u65b0\u7684\n$ sudo docker run -it --rm -v myvolume:/myvolume ustclug/debian:12\nroot@38e2da3a59f7:/# ls /myvolume/\na\n</code></pre> <p>\u53ef\u4ee5\u67e5\u770b Docker \u7ba1\u7406\u7684\u6240\u6709 volume\uff0c\u5b83\u4eec\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u5b9e\u9645\u4f4d\u7f6e\uff1a</p> <pre><code>$ sudo docker volume ls\nDRIVER    VOLUME NAME\nlocal     2aa17ad1c2ee9bf3b2933d241a5196bdaff5e144abcfbf4c1d161198f0f35912\n\uff08\u7701\u7565\uff09\nlocal     myvolume\n\uff08\u7701\u7565\uff09\n$ sudo docker inspect myvolume\n[\n    {\n        \"CreatedAt\": \"2024-04-14T22:54:12+08:00\",\n        \"Driver\": \"local\",\n        \"Labels\": null,\n        \"Mountpoint\": \"/var/lib/docker/volumes/myvolume/_data\",\n        \"Name\": \"myvolume\",\n        \"Options\": null,\n        \"Scope\": \"local\"\n    }\n]\n</code></pre> <p>\u6b64\u5916\uff0c\u5728\u4e0a\u9762\u5217\u51fa\u7684 volume \u91cc\u9762\uff0c\u6709\u4e00\u4e9b\u6ca1\u6709\u540d\u5b57\uff0c\u663e\u793a\u4e3a\u54c8\u5e0c\u503c\u7684 volume\u3002\u8fd9\u4e9b\u88ab\u79f0\u4e3a\u300c\u533f\u540d volume\u300d\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u5728\u521b\u5efa\u5bb9\u5668\u7684\u65f6\u5019\u4e0d\u6307\u5b9a volume \u540d\u5b57\uff0c\u90a3\u4e48 Docker \u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u533f\u540d volume\uff1a</p> <pre><code>$ sudo docker run -it --rm --name test -v /myvolume ustclug/debian:12\nroot@ec434eb92714:/# # \u6253\u5f00\u53e6\u4e00\u4e2a\u7ec8\u7aef\n$ sudo docker inspect test\n\uff08\u7701\u7565\uff09\n        \"Mounts\": [\n            {\n                \"Type\": \"volume\",\n                \"Name\": \"e97304e5a0d8a981b4f0c62b776f6fcaed8d8a6a7263d8e8b7b2f1ea60018976\",\n                \"Source\": \"/var/lib/docker/volumes/e97304e5a0d8a981b4f0c62b776f6fcaed8d8a6a7263d8e8b7b2f1ea60018976/_data\",\n                \"Destination\": \"/myvolume\",\n                \"Driver\": \"local\",\n                \"Mode\": \"\",\n                \"RW\": true,\n                \"Propagation\": \"\"\n            }\n        ],\n</code></pre> <p>\u5982\u679c\u5728 <code>docker run</code> \u65f6\u6dfb\u52a0\u4e86 <code>--rm</code> \u53c2\u6570\uff0c\u90a3\u4e48\u533f\u540d volume \u4f1a\u5728\u5bb9\u5668\u9500\u6bc1\u65f6\u88ab\u5220\u9664\u3002 \u53cd\u4e4b\uff0c\u624b\u52a8 <code>docker rm</code> \u4e00\u4e2a\u5bb9\u5668\u65f6\uff0c\u5b83\u5bf9\u5e94\u7684\u533f\u540d volume \u4e0d\u4f1a\u88ab\u5220\u9664\u3002</p> <p>\u540c\u65f6\uff0cDockerfile \u4e2d\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>VOLUME</code> \u6307\u4ee4\u58f0\u660e volume\u3002\u5982\u679c\u7528\u6237\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u6ca1\u6709\u6307\u5b9a volume\uff0c\u90a3\u4e48 Docker \u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u533f\u540d volume\u3002 \u4e00\u4e2a\u4f8b\u5b50\u662f <code>mariadb</code> \u5bb9\u5668\u955c\u50cf\uff1a</p> <pre><code>VOLUME [/var/lib/mysql]  # Layer 18\n</code></pre>"},{"location":"ops/virtualization/container/#docker-network","title":"\u7f51\u7edc","text":"<p>Docker \u7684\u7f51\u7edc\u9694\u79bb\u57fa\u4e8e Linux \u7684\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u7b49\u7279\u6027\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cDocker \u4f1a\u521b\u5efa\u4e09\u79cd\u7f51\u7edc\uff1a</p> <pre><code>$ sudo docker network ls\nNETWORK ID     NAME                   DRIVER    SCOPE\n47bf1753e571   bridge                 bridge    local\na490cc0dc175   host                   host      local\n4ad7868e3a47   none                   null      local\n</code></pre> <p>\u5176\u4e2d <code>bridge</code> \u4e3a\u5bb9\u5668\u9ed8\u8ba4\u4f7f\u7528\u7684\u7f51\u7edc\uff0c<code>host</code> \u4e3a\u5bb9\u5668\u4e0e\u5bbf\u4e3b\u673a\u5171\u4eab\u7f51\u7edc\uff0c<code>none</code> \u5219\u662f\u4e0d\u4f7f\u7528\u7f51\u7edc\uff08\u53ea\u4fdd\u7559\u672c\u5730\u56de\u73af\uff09\u3002 \u53ef\u4ee5\u4f7f\u7528 <code>--network</code> \u53c2\u6570\u6307\u5b9a\u5bb9\u5668\u4f7f\u7528\u7684\u7f51\u7edc\u3002</p>"},{"location":"ops/virtualization/container/#docker-bridge","title":"Bridge \u4ecb\u7ecd","text":"<p>\u5728\u8ba1\u7b97\u673a\u7f51\u7edc\u4e2d\uff0c\u7f51\u6865\uff08bridge\uff09\u8d1f\u8d23\u8fde\u63a5\u4e24\u4e2a\u7f51\u7edc\uff0c\u63d0\u4f9b\u5728\u7f51\u7edc\u4e4b\u95f4\u8fc7\u6ee4\u4e0e\u8f6c\u53d1\u6570\u636e\u5305\u7b49\u529f\u80fd\u3002 \u800c\u5728 Docker \u4e2d\uff0cbridge \u7f51\u7edc\u4e5f\u53ef\u4ee5\u770b\u4f5c\u662f\u8fde\u63a5\u5bb9\u5668\u7f51\u7edc\u548c\u4e3b\u673a\u7f51\u7edc\u4e4b\u95f4\u7684\u6865\u3002 \u8fde\u63a5\u5230\u76f8\u540c bridge \u7684\u5bb9\u5668\u4e4b\u95f4\u53ef\u4ee5\u4e92\u76f8\u901a\u4fe1\u3002</p> <p>bridge \u5728 Linux \u4e0a\u7684\u5b9e\u73b0</p> <p>\u9996\u5148\uff0cDocker \u4f1a\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u7684 <code>docker0</code> \u7f51\u7edc\u8bbe\u5907\u4f5c\u4e3a\u7f51\u6865\uff0c\u8fd9\u4e2a\u8bbe\u5907\u9ed8\u8ba4\u5bf9\u5e94\u4e86 IP \u6bb5 <code>172.17.0.1/16</code>\uff0c \u521b\u5efa\u7684\u5bb9\u5668\u4f1a\u88ab\u5206\u914d\u5230\u8fd9\u4e2a\u7f51\u6bb5\u4e2d\u7684\u4e00\u4e2a IP \u5730\u5740\u3002\u8def\u7531\u8868\u4e5f\u4f1a\u5c06\u5bf9\u8fd9\u4e2a\u7f51\u6bb5\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230 <code>docker0</code> \u8bbe\u5907\u4e0a\uff1a</p> <pre><code>$ ip a show docker0\n20: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:e0:cb:d8:81 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.1/16 brd 172.17.0.255 scope global docker0\n        valid_lft forever preferred_lft forever\n    inet6 fe80::42:e0ff:fecb:d881/64 scope link proto kernel_ll \n        valid_lft forever preferred_lft forever\n$ ip route get 172.17.0.2\n172.17.0.2 dev docker0 src 172.17.0.1 uid 1000 \n    cache\n</code></pre> <p>\u5728\u9ed8\u8ba4\u7f51\u7edc\u914d\u7f6e\u4e0b\uff0c\u5982\u679c\u521b\u5efa\u4e86\u5bb9\u5668\uff0c\u53ef\u4ee5\u53d1\u73b0\u589e\u52a0\u4e86\u5bf9\u5e94\u6570\u91cf\u7684 <code>veth</code>\uff08\u865a\u62df\u4ee5\u592a\u7f51\uff09\u8bbe\u5907\uff1a</p> <pre><code>$ # \u5f00\u542f\u4e86\u4e24\u4e2a\u5bb9\u5668\u7684\u60c5\u51b5\u4e0b\n$ ip a\n\uff08\u7701\u7565\uff09\n7: veth5669cd1@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default \n    link/ether 96:2b:10:03:cc:36 brd ff:ff:ff:ff:ff:ff link-netnsid 1\n    inet6 fe80::942b:10ff:fe03:cc36/64 scope link \n        valid_lft forever preferred_lft forever\n9: veth9219d7b@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default \n    link/ether d2:b8:23:74:49:2a brd ff:ff:ff:ff:ff:ff link-netnsid 2\n    inet6 fe80::d0b8:23ff:fe74:492a/64 scope link \n        valid_lft forever preferred_lft forever\n</code></pre> <p><code>veth</code> \u8bbe\u5907\u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u6839\u865a\u62df\u7684\u7f51\u7ebf\uff0c\u4e00\u7aef\u8fde\u63a5\u5230\u5bb9\u5668\u5185\u90e8\uff08\u5bb9\u5668\u5185\u90e8\u5b89\u88c5 <code>iproute2</code> \u4e4b\u540e\u53ef\u4ee5 <code>ip a</code> \u770b\u5230 eth0 \u8fd9\u4e2a\u8bbe\u5907\uff09\uff0c\u53e6\u4e00\u7aef\u8fde\u63a5\u5230 <code>docker0</code> \u7f51\u6865\u3002 \u4f46\u662f\u4ec5\u4ec5\u6709\u8bbe\u5907\u662f\u4e0d\u591f\u7684\uff0cDocker \u8fd8\u9700\u8981\u914d\u7f6e\u4e3b\u673a\u7684 iptables \u89c4\u5219\uff0c\u5426\u5219\u5c3d\u7ba1\u5bb9\u5668\u4e0e\u4e3b\u673a\u4e4b\u95f4\u80fd\u591f\u6b63\u5e38\u901a\u4fe1\uff0c\u5bb9\u5668\u65e0\u6cd5\u901a\u8fc7\u4e3b\u673a\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u3002 \u6362\u53e5\u8bdd\u8bb2\uff0c\u6211\u4eec\u9700\u8981\u4e3b\u673a\u4e3a\u5bb9\u5668\u626e\u6f14\u300c\u8def\u7531\u5668\u300d\u7684\u89d2\u8272\u8fdb\u884c NAT\u3002</p> <p>\u67e5\u770b iptables \u7684 <code>nat</code> \u8868\uff1a</p> <pre><code>$ sudo iptables -t nat -S\n-P PREROUTING ACCEPT\n-P INPUT ACCEPT\n-P OUTPUT ACCEPT\n-P POSTROUTING ACCEPT\n-N DOCKER\n-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER\n-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER\n-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE\n-A DOCKER -i docker0 -j RETURN\n</code></pre> <p>\u5bf9\u4e8e\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u7684\u6570\u636e\u5305\uff0c\u4f1a\u7ecf\u8fc7 <code>POSTROUTING</code> \u94fe\u7684 <code>MASQUERADE</code> \u89c4\u5219\uff0c\u5c06\u6e90\u5730\u5740\u66ff\u6362\u4e3a\u4e3b\u673a\u7684\u5730\u5740\u3002 \u540c\u65f6\uff0cDocker \u4e5f\u4f1a\u63a7\u5236 iptables \u5904\u7406\u7aef\u53e3\u6620\u5c04\u7b49\u89c4\u5219\uff0c\u4f8b\u5982\u5982\u679c\u542f\u52a8\u8fd9\u6837\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>sudo docker run -it --rm -p 8080:80 nginx\n</code></pre> <p>\u90a3\u4e48 <code>DOCKER</code> \u548c <code>POSTROUTING</code> \u94fe\u5c31\u4f1a\u53d8\u6210\u8fd9\u6837\uff1a</p> <pre><code>$ sudo iptables -t nat -S\n-P PREROUTING ACCEPT\n-P INPUT ACCEPT\n-P OUTPUT ACCEPT\n-P POSTROUTING ACCEPT\n-N DOCKER\n-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER\n-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER\n-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE\n-A POSTROUTING -s 172.17.0.4/32 -d 172.17.0.4/32 -p tcp -m tcp --dport 80 -j MASQUERADE\n-A DOCKER -i docker0 -j RETURN\n-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.17.0.4:80\n</code></pre> <p>\u5bf9\u4e8e\u5916\u90e8\u5230\u672c\u673a\u7684\u8bbf\u95ee\uff0c<code>PREROUTING</code> \u94fe\u5728\u8df3\u8f6c\u5230 <code>DOCKER</code> \u94fe\u4e4b\u540e\uff0c\u5bf9\u4e8e\u672a\u8fdb\u5165 <code>docker0</code> \u7684 TCP \u6570\u636e\u5305\uff0c\u4f1a\u6839\u636e <code>DNAT</code> \u89c4\u5219\u5c06\u7aef\u53e3 <code>8080</code> \u7684\u6570\u636e\u5305\u7684\u76ee\u7684\u5730\u5740\u4fee\u6539\u4e3a\u5230\u8be5\u5bb9\u5668\u5185\u90e8\u7684 <code>80</code> \u7aef\u53e3\u3002</p> <p>\u7279\u522b\u5730\uff0c\u5230\u672c\u5730\u56de\u73af 8080 \u7aef\u53e3\u7684\u8fde\u63a5\uff0c\u4f1a\u7531\u7528\u6237\u6001\u7684 <code>docker-proxy</code> \u7a0b\u5e8f\u8d1f\u8d23\u300c\u8f6c\u53d1\u300d\u5230\u5bb9\u5668\u5bf9\u5e94\u7684\u7aef\u53e3\u4e0a\u3002 \u5bf9\u8be5\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u9605\u8bfb https://github.com/moby/moby/issues/11185\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>docker network create</code> \u521b\u5efa\u81ea\u5df1\u7684\u7f51\u7edc\u3002\u5bf9\u4e8e\u65b0\u7684 bridge \u7c7b\u578b\u7684\u7f51\u7edc\uff0c\u5728\u4e3b\u673a\u4e0a\u4e5f\u4f1a\u521b\u5efa\u65b0\u7684\u4ee5 <code>br-</code> \u5f00\u5934\u7684\u7f51\u6865\u8bbe\u5907\u3002\u5982\u679c\u4f7f\u7528 docker compose \u7ba1\u7406\u5bb9\u5668\u670d\u52a1\uff0c\u90a3\u4e48\u5176\u4e5f\u4f1a\u4e3a\u5bf9\u5e94\u7684\u670d\u52a1\u81ea\u52a8\u521b\u5efa bridge \u7c7b\u578b\u7684\u7f51\u7edc\u3002\u6709\u5173\u7528\u6237\u521b\u5efa\u7684 bridge \u7f51\u7edc\u76f8\u6bd4\u4e8e\u9ed8\u8ba4\u7f51\u7edc\u7684\u4f18\u52bf\uff08\u4f8b\u5982\u540c\u7f51\u7edc\u5bb9\u5668\u95f4\u81ea\u52a8\u7684 DNS \u89e3\u6790\u652f\u6301\uff09\uff0c\u53ef\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1aBridge network driver\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cDocker \u521b\u5efa\u7684\u7f51\u7edc\u4f1a\u5206\u914d\u5f88\u5927\u7684 IP \u6bb5\u3002 \u5728\u521b\u5efa\u4e86\u5f88\u591a\u7f51\u7edc\u4e4b\u540e\uff0c\u53ef\u80fd\u4f1a\u53d1\u73b0\u5185\u7f51 IP \u5730\u5740\u90fd\u88ab Docker \u5360\u7528\u4e86\u3002\u6211\u4eec\u5efa\u8bae\u4fee\u6539 <code>/etc/docker/daemon.json</code>\uff0c\u5c06 <code>default-address-pools</code> \u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u8f83\u5c0f\u7684 IP \u6bb5\uff1a</p> <pre><code>{\n    \"default-address-pools\": [\n        {\n            \"base\": \"172.17.1.0/24\",\n            \"size\": 28\n        },\n        {\n            \"base\": \"172.17.2.0/23\",\n            \"size\": 28\n        }\n    ],\n}\n</code></pre> <p>\u6b64\u5916\uff0c\u9ed8\u8ba4 <code>docker0</code> \u7684\u5730\u5740\u6bb5\u4e5f\u53ef\u4ee5\u4fee\u6539\uff0c\u5bf9\u5e94 <code>bip</code> \u9009\u9879\uff1a</p> <pre><code>{\n    \"bip\": \"172.17.0.1/24\"\n}\n</code></pre>"},{"location":"ops/virtualization/container/#docker-firewall","title":"\u9632\u706b\u5899\u914d\u7f6e","text":"<p>\u5728 Linux \u4e0a\uff0c\u9632\u706b\u5899\u529f\u80fd\u4e00\u822c\u7684\u5b9e\u73b0\u65b9\u5f0f\u662f\u5728 iptables \u7684 filter \u8868\u4e2d\u6dfb\u52a0\u89c4\u5219\u3002 \u800c\u7531\u4e8e Docker \u81ea\u8eab\u652f\u6301\u4e3a\u5bb9\u5668\u914d\u7f6e\u4e0d\u540c\u7684\u7f51\u7edc\uff0c\u56e0\u6b64\u4e5f\u9700\u8981\u64cd\u4f5c filter \u8868\u6765\u4fdd\u8bc1\u5bb9\u5668\u4e4b\u95f4\u7684\u7f51\u7edc\u9694\u79bb\u3002 Docker \u4f1a\u5728 filter \u8868\u7684 <code>FORWARD</code> \u94fe\u4e2d\u6dfb\u52a0\u8fd9\u6837\u7684\u89c4\u5219\uff1a</p> <pre><code>-A FORWARD -j DOCKER-USER\n-A FORWARD -j DOCKER-ISOLATION-STAGE-1\n-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -o docker0 -j DOCKER\n-A FORWARD -i docker0 ! -o docker0 -j ACCEPT\n-A FORWARD -i docker0 -o docker0 -j ACCEPT\n</code></pre> <p>\u8fd9\u4e9b\u89c4\u5219\u5728 <code>FORWARD</code> \u94fe\u6700\u524d\u9762\u2014\u2014\u5373\u4f7f\u81ea\u884c\u6dfb\u52a0\u4e86\u89c4\u5219\uff0cDocker \u670d\u52a1\u91cd\u542f\u4e4b\u540e\u5b83\u4e5f\u4f1a\u5728\u6700\u524d\u9762\u91cd\u65b0\u6dfb\u52a0\u3002</p> <p>\u5176\u4e2d <code>DOCKER-USER</code> \u94fe\u5141\u8bb8\u7528\u6237\u81ea\u5b9a\u4e49\u89c4\u5219\uff0c\u5176\u4ed6\u4ee5 <code>DOCKER</code> \u5f00\u5934\u7684\u94fe\u5219\u7531 Docker \u81ea\u884c\u7ba1\u7406\u3002 \u5728\u6709\u7aef\u53e3\u6620\u5c04\u7684\u60c5\u51b5\u4e0b\uff0c<code>DOCKER</code> \u94fe\u4f1a\u76f4\u63a5\u5141\u8bb8\u5bf9\u5e94\u7684\u6570\u636e\u5305\uff0c\u4e0d\u7ecf\u8fc7\u4e4b\u540e\u7684\u89c4\u5219\uff1a</p> <pre><code>-A DOCKER -d 172.17.0.4/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT\n</code></pre> <p>\u800c\u4f8b\u5982\u5728 Ubuntu/Debian \u4e0a\u6bd4\u8f83\u5e38\u89c1\u7684 ufw \u5de5\u5177\uff0c\u5b83\u7684\u89c4\u5219\u4f1a\u5728 Docker \u7684\u89c4\u5219\u540e\u9762\u3002 \u4e00\u4e2a\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>-A FORWARD -j DOCKER-USER\n-A FORWARD -j DOCKER-ISOLATION-STAGE-1\n-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -o docker0 -j DOCKER\n-A FORWARD -i docker0 ! -o docker0 -j ACCEPT\n-A FORWARD -i docker0 -o docker0 -j ACCEPT\n-A FORWARD -o br-3e32bdc5bc2a -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n-A FORWARD -o br-3e32bdc5bc2a -j DOCKER\n-A FORWARD -i br-3e32bdc5bc2a ! -o br-3e32bdc5bc2a -j ACCEPT\n-A FORWARD -i br-3e32bdc5bc2a -o br-3e32bdc5bc2a -j ACCEPT\n-A FORWARD -j ufw-before-logging-forward\n-A FORWARD -j ufw-before-forward\n-A FORWARD -j ufw-after-forward\n-A FORWARD -j ufw-after-logging-forward\n-A FORWARD -j ufw-reject-forward\n-A FORWARD -j ufw-track-forward\n</code></pre> <p>\u4e8e\u662f\u8fd9\u5c31\u5bfc\u81f4\u4e86\u914d\u7f6e\u7684\u300c\u9632\u706b\u5899\u300d\u5bf9 Docker \u5f62\u540c\u865a\u8bbe\u7684\u95ee\u9898\u3002 \u5982\u679c\u4e0d\u5e0c\u671b\u81ea\u884c\u7ba1\u7406 <code>DOCKER-USER</code> \u94fe\uff0c\u5efa\u8bae\u5c06\u7aef\u53e3\u6620\u5c04\u8bbe\u7f6e\u4e3a\u53ea\u5411 <code>127.0.0.1</code> \u5f00\u653e\uff0c\u7136\u540e\u4f7f\u7528\u5176\u4ed6\u7684\u7a0b\u5e8f\uff08\u4f8b\u5982 Nginx\uff09\u6765\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff08\u5982\u679c\u5e0c\u671b\u8bbe\u7f6e\u4e3a\u9ed8\u8ba4\u9009\u9879\uff0c\u53ef\u4ee5\u53c2\u8003\u6587\u6863\u4e2d Setting the default bind address for containers \u4e00\u8282\u3002\uff09\uff1b\u6216\u8005\u914d\u7f6e\u8ba9\u5bb9\u5668\u76f4\u63a5\u4f7f\u7528 host \u7f51\u7edc\u3002</p>"},{"location":"ops/virtualization/container/#ipv6","title":"IPv6","text":"<p>Docker \u9ed8\u8ba4\u672a\u5f00\u542f IPv6\uff0c\u5e76\u4e14\u5728\u6bd4\u8f83\u8001\u7684\u7248\u672c\u4e2d\uff0c\u914d\u7f6e IPv6 \u4f1a\u6bd4\u8f83\u9ebb\u70e6\u3002 \u4e00\u4e2a\u91cd\u8981\u7684\u539f\u56e0\u662f\uff1aDocker \u5bf9 IPv4 \u7684\u7b56\u7565\u662f\u914d\u7f6e NAT \u7f51\u7edc\uff0c\u4f46\u5728 IPv6 \u7684\u8bbe\u8ba1\u4e2d\uff0cNAT \u4e0d\u662f\u5f88\u300c\u539f\u6559\u65e8\u4e3b\u4e49\u300d\uff08\u6bd5\u7adf IPv6 \u7684\u5730\u5740\u591a\u5f97\u7528\u4e0d\u5b8c\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u6709\u72b6\u6001\u7684 NAT \u5462\uff1f\uff09\u3002\u8fd9\u5c31\u5bfc\u81f4\u4e86\u5728\u4e4b\u524d\uff0cDocker \u4e2d\u914d\u7f6e\u53ef\u7528\u7684 IPv6 \u5c31\u9700\u8981\uff1a</p> <ul> <li>\u8981\u4e48\u6bcf\u4e2a\u5bb9\u5668\u4e00\u4e2a\u516c\u7f51 IPv6 \u5730\u5740\uff08\u5426\u5219\u5bb9\u5668\u65e0\u6cd5\u8fde\u63a5\u5916\u90e8\u7684 IPv6 \u7f51\u7edc\uff09\u3002\u8981\u8fd9\u4e48\u505a\u7684\u524d\u63d0\u662f\u5f97\u77e5\u9053\u81ea\u5df1\u80fd\u63a7\u5236\u7684 IPv6 \u6bb5\uff0c\u5e76\u4e14\u5bb9\u5668\u6253\u5f00\u7684\u6240\u6709\u7aef\u53e3\u90fd\u4f1a\u66b4\u9732\u5728\u516c\u7f51\u4e0a\u3002</li> <li>\u4f7f\u7528\u7b2c\u4e09\u65b9\u7684\u65b9\u6848\u5e2e\u5fd9\u505a IPv6 NAT\uff0c\u540c\u65f6\u7ed9\u5bb9\u5668\u5206\u914d IPv6 \u7684 ULA\uff08Unique Local Address\uff09\u5730\u5740\u6bb5\uff08\u76ee\u524d\u53ef\u4ee5\u5206\u914d fd00::/8 \u5185\u7684\u5730\u5740\u6bb5\uff09\u3002</li> </ul> <p>\u4e0d\u8fc7\u597d\u6d88\u606f\u662f\uff0c\u76ee\u524d Docker \u6dfb\u52a0\u4e86\u5bf9 IPv6 NAT \u7684\u5b9e\u9a8c\u6027\u652f\u6301\uff0c\u5c3d\u7ba1\u9ed8\u8ba4\u7684 bridge \u7f51\u7edc\u7684 IPv6 \u652f\u6301\u4ecd\u7136\u4e0d\u662f\u9ed8\u8ba4\u6253\u5f00\u7684\u3002 \u53c2\u8003\u5bf9\u5e94\u7684\u6587\u6863<sup>1</sup>\uff0c\u4e00\u4e2a\u914d\u7f6e daemon.json \u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>{\n    \"ipv6\": true,\n    \"fixed-cidr-v6\": \"fd00::/80\",\n    \"experimental\": true,\n    \"ip6tables\": true\n}\n</code></pre> <p>\u8fd9\u6837\u65b0\u5efa\u7684\u5bb9\u5668\u5c31\u80fd\u5f97\u5230\u4e00\u4e2a\u5728 fd00::/80 \u5185\u7684 IPv6 \u5730\u5740\uff0c\u5e76\u4e14\u987a\u5229\u8bbf\u95ee\u5916\u90e8\u7684 IPv6 \u7f51\u7edc\u4e86\uff1a</p> <pre><code>root@14354a8c5349:/# ip a\n1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n52: eth0@if53: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default \n    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 172.17.0.3/24 brd 172.17.0.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fd00::242:ac11:3/80 scope global nodad \n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:acff:fe11:3/64 scope link \n       valid_lft forever preferred_lft forever\nroot@14354a8c5349:/# ping6 mirrors.ustc.edu.cn\nPING mirrors.ustc.edu.cn(2001:da8:d800:95::110 (2001:da8:d800:95::110)) 56 data bytes\n64 bytes from 2001:da8:d800:95::110 (2001:da8:d800:95::110): icmp_seq=1 ttl=62 time=2.42 ms\n</code></pre>"},{"location":"ops/virtualization/container/#vlan","title":"VLAN","text":"<p>VLAN\uff08\u865a\u62df\u5c40\u57df\u7f51\uff09\u7528\u4e8e\u5c06\u4e00\u4e2a\u7269\u7406\u5c40\u57df\u7f51\u5212\u5206\u4e3a\u591a\u4e2a\u903b\u8f91\u4e0a\u7684\u5c40\u57df\u7f51\uff0c\u4ee5\u5b9e\u73b0\u7f51\u7edc\u9694\u79bb\u3002Docker \u652f\u6301 <code>macvlan</code> \u548c <code>ipvlan</code> \u4e24\u79cd VLAN \u9a71\u52a8\uff0c\u524d\u8005\u5141\u8bb8\u6bcf\u4e2a\u5bb9\u5668\u62e5\u6709\u81ea\u5df1\u7684 MAC \u5730\u5740\uff0c\u540e\u8005\u5219\u5141\u8bb8\u6bcf\u4e2a\u5bb9\u5668\u62e5\u6709\u81ea\u5df1\u7684 IP \u5730\u5740\uff08MAC \u5730\u5740\u5171\u4eab\uff09\u3002\u8fd9\u4e2a\u529f\u80fd\u9002\u7528\u4e8e\u9700\u8981\u5c06\u591a\u4e2a\u5bb9\u5668\u76f4\u63a5\u5728\u67d0\u4e2a\u7279\u5b9a\u7f51\u7edc\u5185\u63d0\u4f9b\u670d\u52a1\u7684\u573a\u666f\u2014\u2014\u4e00\u79cd\u573a\u666f\u662f\uff0c\u5185\u7f51\u4f7f\u7528 tinc \u4e92\u8054\uff0c\u5e0c\u671b\u80fd\u591f\u4f7f\u7528\u5185\u7f51\u7684 IP \u5730\u5740\u8fde\u63a5\u5185\u90e8\u670d\u52a1\uff0c\u800c\u8fd9\u4e9b\u670d\u52a1\u53c8\u5728 Docker \u5bb9\u5668\u4e2d\u3002\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528 Docker \u7684 VLAN \u529f\u80fd\uff0c\u5e76\u4e14\u4e3a\u5bb9\u5668\u5206\u914d\u4e0d\u540c\u7684\u5185\u7f51 IP \u5730\u5740\uff0c\u5b9e\u73b0\u5185\u7f51\u901a\u8fc7\u5bf9\u5e94\u7684 IP \u5373\u53ef\u76f4\u63a5\u8bbf\u95ee\u5230\u5bb9\u5668\u670d\u52a1\u7684\u9700\u6c42\u3002</p> <p>Bridge \u4e0e macvlan</p> <p>\u5982\u679c\u4f60\u66fe\u7ecf\u6709\u8fc7\u4f7f\u7528\u7c7b\u4f3c\u4e8e VMware \u865a\u62df\u673a\u8f6f\u4ef6\u7684\u7ecf\u9a8c\uff0c\u53ef\u80fd\u4f1a\u53d1\u73b0\uff1a\u8f6f\u4ef6\u4e2d\u7684 NAT \u66f4\u50cf\u662f Docker \u91cc\u9762\u7684 bridge\uff0c\u800c\u300c\u6865\u63a5\u300d\u5219\u66f4\u50cf\u662f\u8fd9\u91cc\u4ecb\u7ecd\u7684 macvlan\u3002</p> <p>Linux \u4e0b\u7684 bridge \u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u865a\u62df\u7684\u4ea4\u6362\u673a\uff1a\u5728\u521b\u5efa bridge \u4e4b\u540e\uff0c\u53ef\u4ee5\u4e3a\u8fd9\u4e2a bridge \u6dfb\u52a0\u5176\u4ed6\u7684\u8bbe\u5907\u4f5c\u4e3a \"slave\"\uff08\u8bbe\u7f6e\u5176\u4ed6\u8bbe\u5907\u7684 \"master\" \u4e3a\u8fd9\u4e2a bridge\uff09\uff0c\u7136\u540e bridge \u5c31\u50cf\u4ea4\u6362\u673a\u4e00\u6837\u8f6c\u53d1\u6570\u636e\u5305\u3002\u540c\u65f6\uff0cbridge \u4e5f\u652f\u6301\u8bbe\u7f6e\u4e00\u4e2a IP \u5730\u5740\uff0c\u76f8\u5f53\u4e8e\u5728\u4e3b\u673a\u4e00\u7aef\u6709\u4e00\u4e2a\u81ea\u5df1\u7684 \"slave\"\u3002Docker \u9ed8\u8ba4\u7684 bridge \u7f51\u7edc\u6a21\u5f0f\u5219\u662f\u5229\u7528\u4e86\u8fd9\u4e00\u70b9\uff1abridge \u7684 IP \u4e3a\u5bb9\u5668\u7684\u7f51\u5173\uff0c\u4e3b\u673a\u4e00\u7aef\u7684 veth \u8bbe\u5907\u7684 master \u662f Docker \u521b\u5efa\u7684 bridge \u8bbe\u5907\u3002\u8fd9\u4e2a bridge \u4e0d\u5bf9\u5e94\u5230\u5177\u4f53\u7684\u7269\u7406\u8bbe\u5907\uff08Docker \u672a\u63d0\u4f9b\u76f8\u5173\u7684\u914d\u7f6e\u65b9\u5f0f\uff09\u3002</p> <p>\u800c\u865a\u62df\u673a\u8f6f\u4ef6\u7684\u6865\u63a5\u5219\u9700\u8981\u6307\u5b9a\u4e00\u4e2a\u7269\u7406\u8bbe\u5907\uff0c\u8fd9\u4e2a\u8bbe\u5907\u4f1a\u52a0\u5165\u865a\u62df\u7684\u4ea4\u6362\u673a\u91cc\u9762\uff0c\u865a\u62df\u673a\u4e5f\u4f1a\u8fde\u63a5\u5230\u8fd9\u4e2a\u4ea4\u6362\u673a\u4e0a\u3002\u4ece\u5916\u90e8\u6765\u770b\uff0c\u8fd9\u79cd\u6a21\u5f0f\u548c macvlan \u7684\u6548\u679c\u662f\u4e00\u6837\u7684\uff1a\u6709\u591a\u4e2a\u4e0d\u540c\u7684 MAC \u5730\u5740\u7684\u8bbe\u5907\u8fde\u63a5\u5230\u540c\u4e00\u4e2a\u7269\u7406\u7f51\u7edc\u4e0a\uff0c\u4f46\u662f\u5177\u4f53\u5b9e\u73b0\u662f\u4e0d\u540c\u7684\u3002</p> <p>Macvlan \u4e0e IPvlan \u529f\u80fd\u4e5f\u652f\u6301\u5bf9\u63a5\u57fa\u4e8e IEEE 802.1Q \u7684 VLAN \u914d\u7f6e\uff0c\u4f46\u662f\u8fd9\u91cc\u4e0d\u505a\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>"},{"location":"ops/virtualization/container/#macvlan","title":"Macvlan","text":"<p>\u7531\u4e8e\u6bcf\u4e2a\u5bb9\u5668\u90fd\u6709\u4e0d\u540c\u4e8e\u5bf9\u5e94\u7f51\u7edc\u8bbe\u5907\u7684 MAC \u5730\u5740\uff0c\u56e0\u6b64 macvlan \u6a21\u5f0f\u8981\u6c42\u7f51\u7edc\u8bbe\u5907\u652f\u6301\u6df7\u6742\u6a21\u5f0f\uff08promiscuous mode\uff09\uff0c\u5373\u5904\u7406\u6240\u6709\u7ecf\u8fc7\u7684\u6570\u636e\u5305\uff0c\u5373\u4f7f\u6570\u636e\u5305\u7684 MAC \u5730\u5740\u4e0d\u662f\u81ea\u5df1\u7684\u3002</p> <p>\u4ee5\u4e0b\u4ee5\u4e00\u53f0 Linux \u865a\u62df\u673a\u4e3a\u4f8b\uff0c\u5bf9\u5e94\u7684\u300c\u7269\u7406\u300d\u7f51\u7edc\u8bbe\u5907\u4e3a <code>enp1s0</code>\uff1a</p> <pre><code>$ ip a show enp1s0\n2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    link/ether 52:54:00:d3:7d:6f brd ff:ff:ff:ff:ff:ff\n    inet 192.168.122.247/24 brd 192.168.122.255 scope global dynamic noprefixroute enp1s0\n       valid_lft 3577sec preferred_lft 3577sec\n    inet6 fe80::5054:ff:fed3:7d6f/64 scope link noprefixroute \n       valid_lft forever preferred_lft forever\n</code></pre> <p>\u6211\u4eec\u521b\u5efa\u4e00\u4e2a macvlan \u7f51\u7edc\uff0c\u5e76\u4e14\u542f\u52a8\u591a\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ sudo docker network create -d macvlan --subnet=192.168.122.0/25 --gateway=192.168.122.1 -o parent=enp1s0 macvlan_test\n047c9f91cb1a6962d45a916f60c612b0174be5425dcf75d55da1b964037d518f\n$ sudo docker run -it --network macvlan_test --name ct1 -d --ip 192.168.122.10 ustclug/debian:12\n83570467e991dea9fe9f221d7e4e6256f37d193a000b23777a4d37429cdd5e47\n$ sudo docker run -it --network macvlan_test --name ct2 -d --ip 192.168.122.11 ustclug/debian:12\nea0ef56a73d940dad0b860099e2d8fe26ddcba1d424824e3f45bf4f492dd54f1\n</code></pre> <p>\u7531\u4e8e macvlan \u7684\u5b9e\u73b0\u539f\u56e0\uff0c\u8fd9\u4e24\u4e2a IP \u5728\u4e3b\u673a\u4e0a\u65e0\u6cd5 ping \u901a\uff0c\u4f46\u662f\u5bb9\u5668\u4e4b\u95f4\uff0c\u4ee5\u53ca\u4e0e\u865a\u62df\u673a\u5904\u5728\u540c\u4e00\u4e2a\u5b50\u7f51\u7684\u5176\u4ed6\u8bbe\u5907\u4e4b\u95f4\u53ef\u4ee5\u901a\u4fe1\u3002</p> <pre><code>$ # \u8be5\u865a\u62df\u673a\n$ ping 192.168.122.10\nPING 192.168.122.10 (192.168.122.10) 56(84) bytes of data.\nFrom 192.168.122.247 icmp_seq=1 Destination Host Unreachable\n...\n$ # ct1 \u5185\u90e8\u2014\u2014\u9700\u8981\u5148\u5b89\u88c5 iputils-ping\n$ sudo docker exec -it ct1 ping 192.168.122.11\nPING 192.168.122.11 (192.168.122.11) 56(84) bytes of data.\n64 bytes from 192.168.122.11: icmp_seq=1 ttl=64 time=0.095 ms\n...\n$ # \u540c\u5b50\u7f51\u5176\u4ed6\u8bbe\u5907\uff08\u4f8b\u5982\u5bbf\u4e3b\u673a\uff09\n$ ping 192.168.122.10\nPING 192.168.122.10 (192.168.122.10) 56(84) bytes of data.\n64 bytes from 192.168.122.10: icmp_seq=1 ttl=64 time=0.284 ms\n...\n</code></pre> <p>\u540c\u65f6\uff0c\u4e5f\u53ef\u4ee5\u9a8c\u8bc1\u5b83\u4eec\u7684 MAC \u5730\u5740\u4e0d\u540c\uff1a</p> <pre><code>$ sudo arping 192.168.122.10\nARPING 192.168.122.10 from 192.168.122.1 virbr0\nUnicast reply from 192.168.122.10 [02:42:C0:A8:7A:0A]  1.091ms\n...\n$ sudo arping 192.168.122.11\nARPING 192.168.122.11 from 192.168.122.1 virbr0\nUnicast reply from 192.168.122.11 [02:42:C0:A8:7A:0B]  0.979ms\n...\n</code></pre> <p>\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u5728\u4e3b\u673a\u4e0a\u6dfb\u52a0\u4e00\u4e2a\uff08\u548c\u5bb9\u5668\u7684 macvlan \u4e00\u6837\u7684\uff09\u65b0\u7684 macvlan \u63a5\u53e3\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e92\u76f8\u901a\u4fe1\u4e86\uff1a</p> <pre><code>$ sudo ip link add macvlan-enp1s0 link enp1s0 type macvlan mode bridge\n$ sudo ip addr add 192.168.122.9/25 dev macvlan-enp1s0\n$ sudo ip link set macvlan-enp1s0 up\n$ ping 192.168.122.10\nPING 192.168.122.10 (192.168.122.10) 56(84) bytes of data.\n64 bytes from 192.168.122.10: icmp_seq=1 ttl=64 time=0.172 ms\n</code></pre>"},{"location":"ops/virtualization/container/#ipvlan","title":"IPvlan","text":"<p>\u8fd9\u91cc\u4e3b\u8981\u5173\u6ce8 IPvlan \u7684 L2 \u6a21\u5f0f\uff08\u4e5f\u662f IPvlan \u7684\u9ed8\u8ba4\u6a21\u5f0f\uff09\uff0cL3 \u6a21\u5f0f\u4e0e\u4e0a\u6587\u7684\u573a\u666f\u4e0d\u540c\uff0c\u66f4\u52a0\u5173\u6ce8\u7f51\u7edc\u7684\u9694\u79bb\uff0c\u548c bridge \u7f51\u7edc\u7c7b\u4f3c\uff08\u4e3b\u673a\u5916\u90e8\u7f51\u7edc\u65e0\u6cd5\u8bbf\u95ee\u5230\u5176\u4e2d\u7684\u5bb9\u5668\uff09\u3002 \u540c\u65f6\u7531\u4e8e\u4e0d\u9700\u8981\u989d\u5916\u7684 MAC \u5730\u5740\uff0cIPvlan \u53ef\u4ee5\u907f\u514d\u6df7\u6742\u6a21\u5f0f\u7684\u5f00\u542f\u3002</p> <p>\u548c macvlan \u975e\u5e38\u76f8\u4f3c\uff0c\u4ecd\u7136\u662f\u521b\u5efa\u7f51\u7edc\u4e0e\u5bb9\u5668\uff1a</p> <pre><code>$ # \u5728\u6267\u884c\u547d\u4ee4\u4e4b\u524d\uff0c\u9700\u8981\u5148\u6e05\u9664\u4e0a\u6587\u7684 macvlan \u7f51\u7edc\uff0c\u5426\u5219\u7f51\u6bb5\u4f1a\u51b2\u7a81\uff0c\u65e0\u6cd5\u521b\u5efa\n$ # \u6e05\u7406\u4e4b\u540e\u5c31\u53ef\u4ee5\uff1a\n$ sudo docker network create -d ipvlan --subnet=192.168.122.0/25 --gateway=192.168.122.1 -o parent=enp1s0 ipvlan_test\n1d7118ac1a4520b08d4420260700550bb1bcf2ff2badf6f2aeae830b7119502c\n$ # \u4e0b\u9762\u7684\u5185\u5bb9\u548c macvlan \u662f\u51e0\u4e4e\u4e00\u81f4\u7684\uff0c\u7701\u7565\n</code></pre> <p>\u4e3b\u673a\u65e0\u6cd5\u8fde\u901a\u5bb9\u5668 IP \u7684\u95ee\u9898\u4ecd\u7136\u5b58\u5728\uff0c\u89e3\u51b3\u65b9\u6cd5\u4e5f\u51e0\u4e4e\u4e00\u81f4\uff1a</p> <pre><code>$ sudo ip link add ipvlan-enp1s0 link enp1s0 type ipvlan mode l2\n$ # \u540e\u9762\u7701\u7565\u2026\u2026\n$ ping 192.168.122.10\nPING 192.168.122.10 (192.168.122.10) 56(84) bytes of data.\n64 bytes from 192.168.122.10: icmp_seq=1 ttl=64 time=0.154 ms\n</code></pre> <p>\u540c\u65f6\uff0c\u5bb9\u5668\u4e0e\u4e3b\u673a\u5171\u4eab\u76f8\u540c\u7684 MAC \u5730\u5740\uff1a</p> <pre><code>$ sudo arping 192.168.122.10\nARPING 192.168.122.10 from 192.168.122.1 virbr0\nUnicast reply from 192.168.122.10 [52:54:00:D3:7D:6F]  0.687ms\n...\n$ sudo arping 192.168.122.11\nARPING 192.168.122.11 from 192.168.122.1 virbr0\nUnicast reply from 192.168.122.11 [52:54:00:D3:7D:6F]  0.721ms\n...\n$ sudo arping 192.168.122.247  # \u865a\u62df\u673a\u4e3b\u673a\nARPING 192.168.122.247 from 192.168.122.1 virbr0\nUnicast reply from 192.168.122.247 [52:54:00:D3:7D:6F]  0.852ms\n...\n</code></pre>"},{"location":"ops/virtualization/container/#docker-compose","title":"Docker Compose","text":"<p>Docker compose \u662f Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\u7ec4\u6210\u7684\u670d\u52a1\u7684\u5de5\u5177\uff1a\u7528\u6237\u7f16\u5199 YAML \u63cf\u8ff0\u5982\u4f55\u542f\u52a8\u5bb9\u5668\uff0c\u7136\u540e\u4f7f\u7528 <code>docker-compose</code> \u547d\u4ee4\u542f\u52a8\u3001\u505c\u6b62\u3001\u5220\u9664\u670d\u52a1\u3002</p> <p>\u4f5c\u4e3a\u4e00\u4e2a\u76f4\u89c2\u7684\u4f8b\u5b50\uff0c\u5bf9\u4e8e\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u8fd9\u6837\u9700\u8981\u5927\u91cf\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u4e0e\u6302\u8f7d\u70b9\u7684\u7684\u5355\u5bb9\u5668\u542f\u52a8\u547d\u4ee4\uff1a</p> <pre><code>docker run -it --rm -e \"DISPLAY=$DISPLAY\" \\\n                    -e \"XAUTHORITY=$XAUTHORITY\" \\\n                    -v /tmp/.X11-unix:/tmp/.X11-unix \\\n                    -v \"$XAUTHORITY:$XAUTHORITY\" \\\n                    -v /dev/dri/renderD128:/dev/dri/renderD128 \\\n                    -v /run/user/1000/pipewire-0:/run/pipewire/pipewire-0 \\\n                    -v /run/user/1000/pulse:/run/pulse/native \\\n                    local/example-desktop-1\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\u8fd9\u6837\u5199\u4e0d\u76f4\u89c2\uff0c\u5e76\u4e14\u5bb9\u6613\u51fa\u9519\uff08\u5bf9\u4e8e\u8fd9\u91cc\u7684\u4f8b\u5b50\uff0c\u628a <code>-e</code> \u548c <code>-v</code> \u5199\u53cd\u4e86 Docker \u542f\u52a8\u5bb9\u5668\u4e0d\u4f1a\u62a5\u9519\uff09\u3002\u800c\u4f7f\u7528 Docker compose\uff0c\u5c31\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u53c2\u6570\u5199\u5165\u4e00\u4e2a <code>docker-compose.yml</code> \u6587\u4ef6\uff1a</p> <pre><code>version: \"2\"\nservices:\n  desktop:\n    image: local/example-desktop-1\n    environment:\n      - DISPLAY=$DISPLAY\n      - XAUTHORITY=$XAUTHORITY\n    volumes:\n      - /tmp/.X11-unix:/tmp/.X11-unix\n      - $XAUTHORITY:$XAUTHORITY\n      - /dev/dri/renderD128:/dev/dri/renderD128\n      - /run/user/1000/pipewire-0:/run/pipewire/pipewire-0\n      - /run/user/1000/pulse:/run/pulse/native\n</code></pre> <p>\u7136\u540e\u8dd1\u4e00\u4e0b <code>docker compose up</code>\uff0c\u5bb9\u5668\u5c31\u53ef\u4ee5\u542f\u52a8\u3002\u76f8\u6bd4\u4e8e\u4e0a\u8ff0\u7684\u547d\u4ee4\u6765\u8bb2\u76f4\u89c2\u5f97\u591a\u4e86\u3002</p>"},{"location":"ops/virtualization/container/#compose-version","title":"\u7248\u672c","text":"<p>Docker compose \u6709 v1 \u548c v2 \u4e24\u4e2a\u7248\u672c\uff0c\u800c\u5176\u914d\u7f6e\u6587\u4ef6\uff08Compose file\uff09\u5219\u6709 version 1\uff08\u4e0d\u518d\u4f7f\u7528\uff09\u3001version 2\u3001version 3\uff0c\u4ee5\u53ca\u6700\u65b0\u7684 Compose Specification \u56db\u79cd\u7248\u672c\uff0c\u5bb9\u6613\u9020\u6210\u6df7\u4e71\u3002</p> <p>Docker compose \u7684 v1 \u7248\u672c\uff08\u57fa\u4e8e Python\uff09\u5df2\u7ecf\u4e8e 2021 \u5e74 5 \u6708\u505c\u6b62\u7ef4\u62a4\u3002\u5982\u679c\u4f60\u662f\u4ece Debian \u7684\u5b98\u65b9\u6e90\u5b89\u88c5\u7684 <code>docker-compose</code> \u5305\uff0c\u90a3\u4e48\u5c31\u662f v1 \u7248\u672c\u7684 compose\uff1a</p> <pre><code>$ docker-compose --version\ndocker-compose version 1.29.2, build unknown\ndocker-py version: 5.0.3\nCPython version: 3.11.2\nOpenSSL version: OpenSSL 3.0.11 19 Sep 2023\n</code></pre> <p>\u4ece Docker \u6e90\uff08docker-ce\uff09\u5b89\u88c5\u7684 <code>docker-compose-plugin</code> \u5219\u662f v2 \u7248\u672c\u7684\uff08\u57fa\u4e8e Go \u8bed\u8a00\uff09\u3002v2 \u7248\u672c\u7684 compose \u6b64\u65f6\u4f5c\u4e3a Docker \u7684\u63d2\u4ef6\uff0c\u63a8\u8350\u7684\u8fd0\u884c\u65b9\u5f0f\u662f <code>docker compose</code>\uff08\u4e0d\u542b\u6a2a\u7ebf\uff09\uff1a</p> <pre><code>$ docker compose version\nDocker Compose version v2.24.5\n</code></pre> <p>\u4ece v1 \u8fc1\u79fb\u5230 v2 \u7684\u7ec6\u8282\u95ee\u9898\u53c2\u89c1 Migrate to Compose V2\uff08\u4e3b\u8981\u662f\u5bb9\u5668\u540d\u79f0\u4e0e\u73af\u5883\u53d8\u91cf\u5904\u7406\u4e0a\u5b58\u5728\u5dee\u5f02\uff09\u3002</p> <p>\u7279\u522b\u5730\uff0cUbuntu \u5728\u5b98\u65b9\u6e90\u4e2d\u6253\u5305\u4e86 <code>docker-compose-v2</code> \u8fd9\u4e2a\u5305\u3002</p> <p>\u5bf9\u4e8e compose \u6587\u4ef6\uff0c\u65e9\u671f version 2 \u4e0e version 3 \u7684\u5171\u5b58\u5bfc\u81f4\u4e86\u4e00\u4e9b\u6df7\u4e71\uff0c\u56e0\u4e3a\u540e\u8005\u662f\u4e3a\u4e86\u4e0e Docker Swarm\uff08\u96c6\u7fa4\u7ba1\u7406\uff09\u517c\u5bb9\u800c\u8bbe\u8ba1\u7684\uff0c\u4e22\u5f03\u4e86\u4e00\u4e9b\u6709\u610f\u4e49\u7684\u529f\u80fd\u3002</p> <p>\u907f\u514d\u5728\u975e swarm \u96c6\u7fa4\u573a\u5408\u4f7f\u7528 version 3 compose \u6587\u4ef6\u683c\u5f0f</p> <p>Version 3 \u683c\u5f0f\u4ee4\u4eba\u8bdf\u75c5\u4e00\u70b9\u7684\u662f\u5176\u629b\u5f03\u4e86\u5bf9\u8d44\u6e90\u9650\u5236\u7684\u652f\u6301\u3002\u6700\u4e3a\u7cdf\u7cd5\u7684\u662f\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u8d44\u6e90\u9650\u5236\uff0cdocker-compose \u4e0d\u4f1a\u8f93\u51fa\u8b66\u544a\uff0c\u800c\u662f\u76f4\u63a5\u5ffd\u7565\uff1a</p> <p><code>cpu_shares</code>, <code>cpu_quota</code>, <code>cpuset</code>, <code>mem_limit</code>, <code>memswap_limit</code>: These have been replaced by the resources key under <code>deploy</code>. <code>deploy</code> configuration only takes effect when using <code>docker stack deploy</code>, and is ignored by <code>docker-compose</code>.</p> \u6d4b\u8bd5\u7528 <code>docker-compose.yml</code> \u6587\u4ef6 <pre><code>version: '3.8'\nservices:\n  python-app:\n    image: python:3.10-slim\n    command: python -c \"print('Init'); a = [0] * 4000000; print('Array created')\"\n    mem_limit: 16m\n    memswap_limit: 16m\n    environment:\n      - PYTHONUNBUFFERED=1\n</code></pre> <p>\u5982\u679c\u8fd0\u884c\u7684 compose \u73af\u5883\u652f\u6301 Compose Specification\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5bb9\u5668\u4e0d\u4f1a\u8f93\u51fa Array created\uff08\u5728\u5206\u914d\u5185\u5b58\u65f6\u5373\u88ab\u6740\u6b7b\uff09\u3002</p> <p>\u5982\u679c\u4e0d\u77e5\u9053\u8fd9\u4e00\u70b9\uff0c\u90a3\u4e48\u5c31\u53ea\u4f1a\u5728\u5bb9\u5668\u628a\u673a\u5668\u8d44\u6e90\u8017\u5c3d\u4e4b\u540e\u624d\u80fd\u53d1\u73b0\u95ee\u9898\u3002\u5c31\u76ee\u524d\u7684\u60c5\u51b5\u800c\u8a00\uff0c\u5982\u679c\u4ecd\u7136\u6709\u4f7f\u7528\u65e7\u7248 docker-compose\uff08\u4e0d\u652f\u6301 Compose Specification \u683c\u5f0f\uff0c\u5373 1.27.0 \u4ee5\u4e0b\u7684\u7248\u672c\uff09\u7684\u9700\u6c42\uff0c\u5efa\u8bae\u4f7f\u7528 version 2 \u683c\u5f0f\u3002\u76f8\u5173\u8ba8\u8bba\u53ef\u4ee5\u53c2\u8003\uff1ahttps://github.com/docker/compose/issues/4513\u3002</p> <p>\u8003\u8651\u5230 Docker compose v1 \u5df2\u7ecf\u4e0d\u518d\u7ef4\u62a4\uff0c\u5e76\u4e14 Compose Specification \u4fdd\u6301\u4e86\u5bf9\u65e7\u7248 compose \u6587\u4ef6\u7684\u517c\u5bb9\u6027\uff0c\u56e0\u6b64\u4e0b\u6587\u4ec5\u8003\u8651\u6700\u65b0\u7684 compose v2 \u4e0e Compose Specification \u6587\u4ef6\u683c\u5f0f\u3002</p>"},{"location":"ops/virtualization/container/#compose-format-and-usage","title":"\u914d\u7f6e\u6587\u4ef6\u4e0e\u57fa\u672c\u4f7f\u7528","text":"<p>Compose Specification \u89c4\u5b9a\u4e86\u4ee5\u4e0b\u8fd9\u4e9b \"top-level\" \u5143\u7d20\uff1a</p> <ul> <li>Version \u548c name</li> <li>Services</li> <li>Network</li> <li>Volumes</li> <li>Configs</li> <li>Secrets</li> </ul> <p>\u5176\u4e2d\u524d\u56db\u9879\u662f\u6700\u5e38\u89c1\u7684\u3002\u540c\u65f6 Compose Specification \u5df2\u7ecf\u4e0d\u518d\u9700\u8981\u5199\u7248\u672c\u53f7\uff08\u5df2\u6709\u7684\u4f1a\u88ab\u5ffd\u7565\uff09\uff0c\u800c\u9879\u76ee\u540d\u79f0\u4e5f\u662f\u53ef\u9009\u7684\uff08\u9ed8\u8ba4\u4e3a\u5f53\u524d\u76ee\u5f55\u540d\uff09\uff0c\u6240\u4ee5\u4e00\u4e2a\u6700\u7b80\u5355\u7684 compose \u6587\u4ef6\u53ef\u4ee5\u53ea\u6709 <code>services</code> \u4e00\u9879\uff1a</p> <pre><code>services:\n  hello-world:\n    image: hello-world\n</code></pre> <p>\u5047\u8bbe\u5f53\u524d\u76ee\u5f55\u540d\u4e3a <code>helloworld</code>\uff0c\u8fd0\u884c <code>docker compose up</code> \u4e4b\u540e\uff0c\u53ef\u4ee5\u770b\u5230 compose \u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>helloworld-hello-world-1</code> \u7684\u5bb9\u5668\uff0c\u5e76\u4e14\u4e3a\u5bb9\u5668\u521b\u5efa <code>helloworld-hello-world-1</code> \u7684 bridge \u7f51\u7edc\u2014\u2014\u7531\u4e8e <code>hello-world</code> \u7684\u552f\u4e00\u529f\u80fd\u662f\u8f93\u51fa\u4e00\u6bb5\u6587\u5b57\uff0c\u6240\u4ee5\u5bb9\u5668\u4f1a\u7acb\u5373\u9000\u51fa\u3002</p> <p>\u5728\u6d4b\u8bd5\u5b8c\u6210\u540e\uff0c\u4f7f\u7528 <code>docker compose down</code> \u9500\u6bc1\u73af\u5883\uff08\u5426\u5219\u5bb9\u5668\u548c\u7f51\u7edc\u4f1a\u4e00\u76f4\u5b58\u5728\uff09\u3002\u63a5\u4e0b\u6765\u7684\u90e8\u5206\u4f1a\u5206\u6790\u4e00\u4e9b\u4f7f\u7528 Docker compose \u7684\u4f8b\u5b50\u3002</p>"},{"location":"ops/virtualization/container/#compose-hackergame-nc","title":"\u6848\u4f8b 1\uff1aHackergame \u7684 nc \u7c7b\u9898\u76ee Docker \u5bb9\u5668\u73af\u5883","text":"<ol> <li> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6587\u6863\u4e2d\u7684 2001:db8:1::/64 \u8fd9\u4e2a\u5730\u5740\u96b6\u5c5e\u4e8e 2001:db8::/32 \u8fd9\u4e2a\u4e13\u95e8\u7528\u4e8e\u6587\u6863\u548c\u6837\u4f8b\u4ee3\u7801\u7684\u5730\u5740\u6bb5\uff08\u7c7b\u4f3c\u4e8e example.com \u7684\u529f\u80fd\uff09\uff0c\u4e0d\u80fd\u7528\u4e8e\u5b9e\u9645\u7684\u7f51\u7edc\u914d\u7f6e\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/virtualization/qemu-kvm/","title":"QEMU/KVM","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>QEMU/KVM \u662f Linux \u670d\u52a1\u5668\u4e0a\u5e38\u7528\u7684\u865a\u62df\u5316\u65b9\u6848\u3002\u5176\u5206\u4e3a\u8fd0\u884c\u5728\u7528\u6237\u7a7a\u95f4\u7684 QEMU \u548c\u8fd0\u884c\u5728\u5185\u6838\u7a7a\u95f4\u7684 KVM \u4e24\u90e8\u5206\u3002QEMU \u8d1f\u8d23\u6a21\u62df\u786c\u4ef6\uff0cKVM \u5219\u8d1f\u8d23\u865a\u62df\u673a\u7684\u8fd0\u884c\u3002</p> <p>\u672c\u90e8\u5206\u5c06\u5bf9 QEMU \u548c KVM \u57fa\u7840\u77e5\u8bc6\u548c\u57fa\u672c\u64cd\u4f5c\u8fdb\u884c\u4ecb\u7ecd\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_1","title":"\u7ec4\u4ef6\u4ecb\u7ecd","text":""},{"location":"ops/virtualization/qemu-kvm/#qemu","title":"QEMU","text":"<p>QEMU\uff08Quick Emulator\uff09\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u865a\u62df\u5316\u8f6f\u4ef6\uff0c\u5b83\u901a\u8fc7\u52a8\u6001\u4e8c\u8fdb\u5236\u7ffb\u8bd1\u6765\u6a21\u62df CPU\uff0c\u5e76\u63d0\u4f9b\u4e00\u7cfb\u5217\u7684\u786c\u4ef6\u6a21\u578b\uff0c\u53ef\u4ee5\u6a21\u62df\u591a\u79cd\u5916\u8bbe\u786c\u4ef6\u3002QEMU \u53ef\u4ee5\u5728\u6ca1\u6709\u786c\u4ef6\u52a0\u901f\u7684\u60c5\u51b5\u4e0b\u72ec\u7acb\u8fd0\u884c\uff0c\u4f46\u8fd9\u6837\u5176\u4e2d\u7684 CPU \u90e8\u5206\u662f\u6a21\u62df\u6307\u4ee4\u7684\u6267\u884c\uff0c\u6027\u80fd\u4f4e\u4e0b\u3002</p> <p>\u6b64\u5916 QEMU \u4e5f\u53ef\u4ee5\u4ec5\u7528\u4e8e CPU \u6307\u4ee4\u548c\u7cfb\u7edf\u8c03\u7528\u7684\u7ffb\u8bd1\uff0c\u4e0d\u6a21\u62df\u786c\u4ef6\u6a21\u578b\uff0c\u8fd9\u79cd\u6a21\u5f0f\u79f0\u4e3a User Mode\u3002\u4e3b\u8981\u7528\u4e8e\u8fd0\u884c\u4e0d\u540c\u4e8e\u5bbf\u4e3b\u7cfb\u7edf CPU \u6307\u4ee4\u96c6\u7684\u7528\u6237\u6001\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#kvm","title":"KVM","text":"<p>KVM\uff08Kernel-based Virtual Machine\uff09\u662f\u4e00\u79cd\u57fa\u4e8e Linux \u5185\u6838\u7684\u5f00\u6e90\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\u3002KVM \u5c06 Linux \u8f6c\u53d8\u6210\u4e00\u4e2a\u865a\u62df\u673a\u76d1\u89c6\u5668\uff08Hypervisor\uff09\u3002\u5b83\u5229\u7528\u4e86\u73b0\u4ee3\u5904\u7406\u5668\u4e2d\u7684\u786c\u4ef6\u865a\u62df\u5316\u652f\u6301\uff08\u4f8b\u5982 Intel VT-x \u6216 AMD-V\uff09\uff0c\u4ee5\u5b9e\u73b0\u9ad8\u6027\u80fd\u7684\u865a\u62df\u5316\u3002\u5b83\u4e13\u6ce8\u4e8e\u4ee5\u6700\u5c0f\u7684\u5f00\u9500\u5728 Linux \u4e0a\u63d0\u4f9b\u5b89\u5168\u548c\u9694\u79bb\u7684\u865a\u62df\u73af\u5883\uff0c\u540c\u65f6\u7ef4\u6301\u63a5\u8fd1\u539f\u751f\u7684\u6027\u80fd\u3002\u5b83\u5411\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u4e86\u865a\u62df CPU \u548c\u5185\u5b58\u5b50\u7cfb\u7edf\u7684\u914d\u7f6e\u548c\u6267\u884c\u63a7\u5236\u76f8\u5173\u63a5\u53e3\uff0c\u4f46 KVM \u4e0d\u5305\u542b\u786c\u4ef6\u6a21\u578b\uff0c\u4e0d\u80fd\u72ec\u7acb\u6784\u6210\u865a\u62df\u673a\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#qemukvm_1","title":"QEMU/KVM","text":"<p>QEMU \u4e0e KVM \u7684\u5173\u7cfb\u662f\u4e92\u8865\u7684\u3002\u5f53\u4e8c\u8005\u7ed3\u5408\u4f7f\u7528\u65f6\uff0cQEMU \u8d1f\u8d23\u63d0\u4f9b\u8f6f\u4ef6\u6a21\u62df\u548c\u7528\u6237\u754c\u9762\uff0c\u800c KVM \u5219\u5728\u5185\u6838\u7ea7\u522b\u63d0\u4f9b\u786c\u4ef6\u52a0\u901f\u652f\u6301\u3002\u8fd9\u79cd\u914d\u5408\u4f7f\u5f97\u865a\u62df\u673a\u80fd\u591f\u4ee5\u8f83\u4f4e\u7684\u6027\u80fd\u5f00\u9500\u8fd0\u884c\uff0c\u540c\u65f6\u7528\u6237\u8fd8\u53ef\u4ee5\u4eab\u53d7\u5230 QEMU \u5728\u8bbe\u5907\u6a21\u62df\u65b9\u9762\u63d0\u4f9b\u7684\u7075\u6d3b\u6027\u3002\u5b9e\u9645\u4e0a\uff0cQEMU \u901a\u5e38\u4f5c\u4e3a\u7528\u6237\u7a7a\u95f4\u7684\u5de5\u5177\u4e0e KVM \u7684\u5185\u6838\u865a\u62df\u5316\u529f\u80fd\u914d\u5408\uff0c\u4e00\u8d77\u5f62\u6210\u4e86\u73b0\u4ee3 Linux \u73af\u5883\u4e2d\u5f3a\u5927\u7684\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_2","title":"\u5b89\u88c5\u914d\u7f6e","text":"<p>\u73b0\u5728\u5927\u591a\u6570\u53d1\u884c\u7248\u63d0\u4f9b\u7684\u5185\u6838\u90fd\u5305\u542b KVM \u76f8\u5173\u6a21\u5757\uff0c\u4e5f\u63d0\u4f9b\u4e86 QEMU \u7684\u4e8c\u8fdb\u5236\u5305\u3002\u56e0\u6b64\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0cKVM \u65e0\u9700\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u5b89\u88c5 QEMU \u7684\u4e8c\u8fdb\u5236\u5305\u5373\u53ef\u3002</p> <p>\u5982\u679c\u9700\u8981\u624b\u52a8\u8fdb\u884c\u914d\u7f6e\uff0c\u4ee5\u4e0b\u5185\u5bb9\u53ef\u4ee5\u4f5c\u4e3a\u53c2\u8003\u3002</p> KVM <p>\u4ee5 x86 \u4e3a\u4f8b\u3002</p> <ol> <li>\u786e\u4fdd\u5185\u6838\u914d\u7f6e\u4e2d\u5305\u542b\u4e86 KVM \u76f8\u5173\u6a21\u5757\u3002\u9700\u8981\u7684\u914d\u7f6e\u9879\u5305\u62ec\uff1a<ul> <li><code>CONFIG_KVM</code></li> <li><code>CONFIG_KVM_INTEL</code> \u6216 <code>CONFIG_KVM_AMD</code></li> <li>EPT \u652f\u6301\u7b49\u6a21\u5757</li> </ul> </li> <li>\u52a0\u8f7d KVM \u6a21\u5757\uff1a<code>modprobe kvm_intel</code> \u6216 <code>modprobe kvm_amd</code>\u3002</li> <li>\u6b63\u786e\u914d\u7f6e <code>/dev/kvm</code> \u5b57\u7b26\u8bbe\u5907\u7684\u6743\u9650\uff0c\u4f7f\u9700\u8981\u8fd0\u884c\u865a\u62df\u673a\u7684\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8bbe\u5907\u3002</li> </ol> QEMU <p>\u53ea\u9700\u5b89\u88c5 QEMU \u7684\u4e8c\u8fdb\u5236\u5305\u3002</p> <p>\u5982\u679c\u53d1\u884c\u7248\u4e0d\u63d0\u4f9b\u76f8\u5173\u5305\uff0c\u4e5f\u53ef\u4ee5\u4ece QEMU \u5b98\u7f51 \u4e0b\u8f7d\u6e90\u7801\u7f16\u8bd1\u5b89\u88c5\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_3","title":"\u7b2c\u4e00\u53f0\u865a\u62df\u673a","text":"<p>\u4ee5\u4e0b\u5b9e\u4f8b\u547d\u4ee4\u7528\u4e8e\u542f\u52a8\u4e00\u4e2a\u4f7f\u7528 KVM, \u5e26\u6709\u53cc\u6838 CPU\uff0c1GB \u5185\u5b58\uff0c\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>example.img</code> \u7684\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u548c\u7528\u6237\u6001\u7f51\u7edc\u7684\u865a\u62df\u673a\u3002</p> <pre><code>qemu-system-x86_64 \\\n    -enable-kvm \\\n    -m 1024 \\\n    -cpu host \\\n    -smp cores=2 \\\n    -drive file=example.img,format=raw,if=virtio \\\n    -nic user,model=virtio\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u7684\u5404\u4e2a\u53c2\u6570\u610f\u4e49\u5982\u4e0b\uff1a</p> <ul> <li><code>qemu-system-x86_64</code>: QEMU \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u540d\uff0c\u8fd9\u91cc\u8868\u793a\u8fd0\u884c x86_64 \u67b6\u6784\u7684\u7cfb\u7edf\u7ea7\u6a21\u62df\u5668\u3002</li> <li><code>-enable-kvm</code>: \u542f\u7528 KVM\u3002</li> <li><code>-m 1024</code>: \u5206\u914d 1024MB \u5185\u5b58\u3002</li> <li><code>-cpu host</code>: \u4f7f\u7528\u5bbf\u4e3b\u673a CPU \u6a21\u578b\u3002</li> <li><code>-smp cores=2</code>: \u4f7f\u7528 2 \u4e2a CPU \u6838\u5fc3\u3002</li> <li><code>-drive file=example.img,format=raw,if=virtio</code>: \u4f7f\u7528 <code>example.img</code> \u4f5c\u4e3a\u78c1\u76d8\u955c\u50cf\uff0c\u683c\u5f0f\u4e3a <code>raw</code>\uff0c\u4f7f\u7528 <code>virtio</code> \u8bbe\u5907\u6a21\u578b\u3002</li> <li><code>-nic user,model=virtio</code>: \u4f7f\u7528\u7528\u6237\u6001\u7f51\u7edc\u8bbe\u5907\uff0c\u4f7f\u7528 <code>virtio</code> \u8bbe\u5907\u6a21\u578b\u3002</li> </ul> <p>\u8fd9\u53ea\u662f\u521b\u5efa\u865a\u62df\u673a\u7684\u4e00\u4e2a\u57fa\u672c\u793a\u4f8b\uff0cQEMU \u63d0\u4f9b\u4e86\u5f88\u591a\u5176\u4ed6\u9009\u9879\uff0c\u53ef\u4ee5\u8ba9\u60a8\u5b9a\u5236\u7f51\u7edc\u3001\u56fe\u5f62\u8f93\u51fa\u3001\u8bbe\u5907\u7b49\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_4","title":"\u8be6\u7ec6\u914d\u7f6e","text":""},{"location":"ops/virtualization/qemu-kvm/#_5","title":"\u5757\u5b58\u50a8","text":""},{"location":"ops/virtualization/qemu-kvm/#_6","title":"\u5b58\u50a8\u683c\u5f0f","text":"<p>QEMU \u652f\u6301\u591a\u79cd\u5b58\u50a8\u683c\u5f0f\uff0c\u6bcf\u79cd\u683c\u5f0f\u90fd\u6709\u5176\u7279\u5b9a\u7684\u4f18\u70b9\u548c\u7528\u9014\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u6700\u5e38\u89c1\u7684 QEMU \u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff1a</p> <ol> <li>raw: \u8fd9\u662f\u6700\u7b80\u5355\u7684\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\u3002\u5b83\u662f\u672a\u7ecf\u8fc7\u4efb\u4f55\u5904\u7406\u7684\u78c1\u76d8\u955c\u50cf\uff0c\u6ca1\u6709\u4efb\u4f55\u5143\u6570\u636e\u6216\u9644\u52a0\u7279\u6027\u3002\u56e0\u4e3a\u5176\u7b80\u5355\u6027\uff0c\u5b83\u901a\u5e38\u6709\u6700\u597d\u7684\u6027\u80fd\uff0c\u5e76\u4e14\u53ef\u4ee5\u76f4\u63a5\u88ab\u8bb8\u591a\u5176\u4ed6\u5de5\u5177\u8bfb\u53d6\uff0c\u6bd4\u5982 dd\u3002\u5982\u679c\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\u7a00\u758f\u6587\u4ef6\uff0c\u90a3\u4e48 raw \u683c\u5f0f\u7684\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u53ef\u4ee5\u975e\u5e38\u5c0f\uff0c\u56e0\u4e3a\u5b83\u53ea\u4f1a\u5728\u9700\u8981\u65f6\u624d\u589e\u957f\u5230\u6240\u9700\u5927\u5c0f\u3002\u5982\u679c\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u652f\u6301 hole-punching \u64cd\u4f5c\uff0c\u90a3\u4e48 raw \u683c\u5f0f\u7684\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u53ef\u4ee5\u76f4\u63a5\u91ca\u653e\u672a\u4f7f\u7528\u7684\u7a7a\u95f4\u3002</li> <li>qcow2 (QEMU Copy-On-Write version 2): \u8fd9\u662f QEMU \u6700\u5e38\u7528\u7684\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\u3002\u5b83\u652f\u6301\u8bb8\u591a\u9ad8\u7ea7\u7279\u6027\uff0c\u5982\u5199\u65f6\u590d\u5236 (copy-on-write)\uff0c\u5feb\u7167\uff0c\u538b\u7f29\uff0c\u52a0\u5bc6\u548c\u589e\u91cf\u5907\u4efd\u3002</li> </ol> <p>\u6b64\u5916 QEMU \u8fd8\u652f\u6301\u8bb8\u591a\u5176\u4ed6\u78c1\u76d8\u683c\u5f0f\uff0c\u5982 vmdk, vdi, vhdx \u7b49\u3002\u7531\u4e8e\u8fd9\u4e9b\u683c\u5f0f\u4e0d\u662f\u5f88\u5e38\u89c1\uff0c\u8fd9\u91cc\u4e0d\u518d\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_7","title":"\u914d\u7f6e\u53c2\u6570","text":"<p>QEMU \u4e2d\u5b58\u50a8\u5206\u4e3a\u5b58\u50a8\u540e\u7aef\u548c\u5b58\u50a8\u8bbe\u5907\u4e24\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u4f7f\u7528 <code>-blockdev</code> \u548c <code>-device</code> \u53c2\u6570\u8fdb\u884c\u914d\u7f6e\u3002</p> <p><code>-blockdev</code> \u53c2\u6570\u7528\u4e8e\u914d\u7f6e\u5b58\u50a8\u540e\u7aef\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>-blockdev driver=&lt;file|raw|qcow2&gt;,node-name=&lt;name&gt;,file=&lt;path&gt;,&lt;other opts&gt;\n</code></pre> <p>\u5176\u4e2d <code>raw</code> \u548c <code>qcow2</code> driver \u901a\u5e38\u5c42\u53e0\u5728 <code>file</code> \u540e\u7aef\u4e0a\u4f7f\u7528\u3002<code>node-name</code> \u53c2\u6570\u7528\u4e8e\u6307\u5b9a\u8be5\u540e\u7aef\u7684\u540d\u79f0\uff0c\u4ee5\u4fbf\u4e8e\u540e\u9762\u5f15\u7528\u3002</p> <p><code>-device</code> \u53c2\u6570\u7528\u4e8e\u914d\u7f6e\u8bbe\u5907\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>-device virtio-blk-pci,drive=&lt;blockdev node name&gt;,&lt;other opts&gt;\n</code></pre> <p>\u5176\u4e2d <code>virtio-blk-pci</code> \u662f\u8bbe\u5907\u6a21\u578b\uff0c<code>drive</code> \u53c2\u6570\u7528\u4e8e\u6307\u5b9a\u8be5\u8bbe\u5907\u7684\u540e\u7aef\u3002\u9664\u4e86 <code>virtio-blk-pci</code>\uff0cQEMU \u8fd8\u652f\u6301\u5176\u4ed6\u8bbe\u5907\u6a21\u578b\uff0c\u5982 <code>ide</code>\uff0c<code>scsi</code> \u7b49\u3002</p> <p>\u6b64\u5916\uff0cQEMU \u8fd8\u652f\u6301 <code>-drive</code> \u53c2\u6570\u7528\u4e8e\u540c\u65f6\u914d\u7f6e\u5b58\u50a8\u540e\u7aef\u548c\u8bbe\u5907\uff0c\u5176\u5b9e\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>-drive file=example.img,format=raw,if=virtio\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u66f4\u52a0\u7b80\u6d01\uff0c\u4f46\u4e0d\u5982 <code>-blockdev</code> \u548c <code>-device</code> \u53c2\u6570\u7075\u6d3b\u3002\u5f53 <code>if</code> \u9009\u9879\u503c\u4e3a <code>none</code> \u65f6\uff0c<code>-drive</code> \u9009\u9879\u4ec5\u521b\u5efa\u540e\u7aef\uff0c\u4e0d\u521b\u5efa\u8bbe\u5907\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_8","title":"\u7f51\u7edc","text":"<p>QEMU \u652f\u6301\u591a\u79cd\u7f51\u7edc\u540e\u7aef\uff0c\u5305\u62ec <code>user</code>\uff0c<code>tap</code>\uff0c<code>bridge</code> \u7b49\u3002\u5176\u4e2d <code>user</code> \u662f\u6700\u7b80\u5355\u7684\u7f51\u7edc\u540e\u7aef\uff0c\u5b83\u4f7f\u7528\u5bbf\u4e3b\u673a\u7684 NAT \u7f51\u7edc\u8fdb\u884c\u7f51\u7edc\u8fde\u63a5\u3002<code>tap</code> \u5219\u662f\u6700\u5e38\u7528\u7684\u7f51\u7edc\u540e\u7aef\uff0c\u5b83\u4f7f\u7528\u4e3b\u673a\u4e0a\u7684 TAP \u8bbe\u5907\u8fdb\u884c\u7f51\u7edc\u8fde\u63a5\u3002<code>bridge</code> \u4e0e <code>tap</code> \u6ca1\u6709\u672c\u8d28\u533a\u522b\uff0c\u5b83\u53ea\u662f\u81ea\u52a8\u5c06\u521b\u5efa\u7684 tap \u63a5\u53e3\u63a5\u5230\u7f51\u6865\u4e0a\u3002</p> <p><code>-nic</code> \u53c2\u6570\u540c\u65f6\u914d\u7f6e\u7f51\u7edc\u540e\u7aef\u548c\u8bbe\u5907\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>-nic [tap|bridge|user|l2tpv3|vde|netmap|af-xdp|vhost-user|socket][,...][,mac=macaddr][,model=mn]\n</code></pre> <p>QEMU \u652f\u6301\u591a\u79cd\u7f51\u7edc\u8bbe\u5907\u6a21\u578b\uff0c\u5305\u62ec <code>virtio</code>\uff0c<code>e1000</code>\uff0c<code>rtl8139</code> \u7b49\u3002\u5176\u4e2d <code>virtio</code> \u662f\u6027\u80fd\u6700\u597d\u7684\u8bbe\u5907\u6a21\u578b\uff0c\u4e14\u73b0\u5728\u51e0\u4e4e\u6240\u6709 Linux \u53d1\u884c\u7248\u5747\u5305\u542b\u4e86\u5bf9\u5e94\u9a71\u52a8\uff0c\u56e0\u6b64\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u76f4\u63a5\u4f7f\u7528\u8be5\u6a21\u578b\u5373\u53ef\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_9","title":"\u5185\u5b58","text":"<p>\u672c\u8282\u5185\u5bb9\u5f85\u8865\u5145</p>"},{"location":"ops/virtualization/qemu-kvm/#cpu","title":"CPU","text":"<p>\u672c\u8282\u5185\u5bb9\u5f85\u8865\u5145</p>"},{"location":"ops/virtualization/qemu-kvm/#_10","title":"\u5b9e\u7528\u5de5\u5177","text":""},{"location":"ops/virtualization/qemu-kvm/#qemu-img","title":"qemu-img","text":"<p><code>qemu-img</code> \u662f QEMU \u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u4e8e\u521b\u5efa\u3001\u8f6c\u6362\u548c\u64cd\u4f5c\u78c1\u76d8\u955c\u50cf\u7684\u5de5\u5177\u3002\u5b83\u652f\u6301\u591a\u79cd\u78c1\u76d8\u683c\u5f0f\uff0c\u53ef\u4ee5\u65b9\u4fbf\u5730\u8fdb\u884c\u78c1\u76d8\u955c\u50cf\u7684\u521b\u5efa\u3001\u8f6c\u6362\u3001\u6269\u5bb9\u7b49\u64cd\u4f5c\u3002</p> <p><code>qemu-img</code> \u7684\u8be6\u7ec6\u7528\u6cd5\u548c\u9009\u9879\u53ef\u4ee5\u901a\u8fc7 <code>man qemu-img</code> \u6216 <code>qemu-img --help</code> \u67e5\u770b\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_11","title":"\u521b\u5efa","text":"<p><code>qemu-img create</code> \u547d\u4ee4\u7528\u4e8e\u521b\u5efa\u78c1\u76d8\u955c\u50cf\uff0c\u57fa\u672c\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>qemu-img create -f &lt;FORMAT:raw|qcow2|...&gt; -o &lt;OPTIONS&gt; &lt;IMAGE&gt; &lt;SIZE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>-o</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u683c\u5f0f\u76f8\u5173\u7684\u9009\u9879\uff0c<code>&lt;IMAGE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\uff0c<code>&lt;SIZE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u5927\u5c0f\u3002</p> <p>Tip</p> <p>\u521b\u5efa <code>qcow2</code> \u683c\u5f0f\u7684\u78c1\u76d8\u955c\u50cf\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>-o preallocation=metadata</code> \u9009\u9879\u6307\u5b9a\u9884\u5206\u914d\u5143\u6570\u636e\uff0c\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_12","title":"\u8f6c\u6362","text":"<p><code>qemu-img convert</code> \u547d\u4ee4\u7528\u4e8e\u8f6c\u6362\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c\u57fa\u672c\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>qemu-img convert -f &lt;SRC_FORMAT:raw|qcow2|...&gt; -O &lt;DST_FORMAT:raw|qcow2|...&gt; -o &lt;OPTIONS&gt; &lt;SRC_IMAGE&gt; &lt;DST_IMAGE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u6e90\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>-O</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u76ee\u6807\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>-o</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u683c\u5f0f\u76f8\u5173\u7684\u9009\u9879\uff0c<code>&lt;SRC_IMAGE&gt;</code> \u4e3a\u6e90\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\uff0c<code>&lt;DST_IMAGE&gt;</code> \u4e3a\u76ee\u6807\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_13","title":"\u6269\u7f29\u5bb9","text":"<p><code>qemu-img resize</code> \u547d\u4ee4\u7528\u4e8e\u6269\u7f29\u5bb9\u78c1\u76d8\u955c\u50cf\uff0c\u57fa\u672c\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>qemu-img resize -f &lt;FORMAT&gt; [--shrink] &lt;IMAGE&gt; [+|-]&lt;SIZE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>--shrink</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u662f\u5426\u6536\u7f29\u78c1\u76d8\u955c\u50cf\uff0c<code>&lt;IMAGE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\uff0c<code>&lt;SIZE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u5927\u5c0f\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7f29\u5c0f\u955c\u50cf\u65f6\uff0c\u8d85\u8fc7\u6307\u5b9a\u5927\u5c0f\u7684\u6570\u636e\u5c06\u88ab\u622a\u65ad\u4e22\u5f03\uff0c\u56e0\u6b64\u9700\u8981\u5728\u955c\u50cf\u5185\u90e8\u5148\u8fdb\u884c\u6587\u4ef6\u7cfb\u7edf\u5bb9\u91cf\u8c03\u6574\u548c\u5206\u533a\u8868\u8c03\u6574\u64cd\u4f5c\uff0c\u5e76\u9700\u8981\u5c0f\u5fc3\u8ba1\u7b97\u5404\u5206\u533a\u504f\u79fb\u91cf\u548c\u76ee\u6807\u955c\u50cf\u5927\u5c0f\u3002</p> <p>Tip</p> <p>\u7f29\u5bb9\u65f6\uff0c\u53ef\u4ee5\u5148\u5c06\u5185\u90e8\u6587\u4ef6\u7cfb\u7edf\u8c03\u6574\u81f3\u6700\u5c0f\u5927\u5c0f\uff0c\u7136\u540e\u8c03\u6574\u5206\u533a\u5927\u5c0f\u81f3\u76ee\u6807\u5927\u5c0f\uff0c\u63a5\u7740\u8c03\u6574\u955c\u50cf\u5927\u5c0f\uff0c\u6700\u540e\u518d\u5c06\u6587\u4ef6\u7cfb\u7edf\u6269\u5bb9\u81f3\u6700\u5927\u3002\u5728\u6b64\u8fc7\u7a0b\u4e2d\u4e5f\u9700\u8981\u5c0f\u5fc3\u8ba1\u7b97\u6d89\u53ca\u5230\u7684\u5404\u79cd\u5927\u5c0f\u548c\u504f\u79fb\u91cf\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#qemu-nbd","title":"qemu-nbd","text":"<p><code>qemu-nbd</code> \u662f QEMU \u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u4e8e\u6302\u8f7d\u78c1\u76d8\u955c\u50cf\u7684\u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u5c06\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u6620\u5c04\u4e3a\u4e00\u4e2a\u5757\u8bbe\u5907\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>mount</code> \u547d\u4ee4\u5c06\u5176\u6302\u8f7d\u5230\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6216\u8005\u5bf9\u8be5\u5757\u8bbe\u5907\u8fdb\u884c\u5176\u4ed6\u64cd\u4f5c\u3002</p> <p>\u4f7f\u7528\u524d\u9700\u8981\u5148\u52a0\u8f7d <code>nbd</code> \u5185\u6838\u6a21\u5757\uff1a</p> <pre><code>modprobe nbd\n</code></pre> <p>\u5751</p> <p><code>nbd</code> \u9ed8\u8ba4\u521b\u5efa\u5f88\u591a nbd \u8bbe\u5907\uff0c\u5360\u636e\u5927\u91cf\u8bbe\u5907\u53f7\uff0c\u5982\u679c\u4e3b\u673a\u4e0a\u672c\u6765\u5c31\u5df2\u7ecf\u6709\u5f88\u591a\u8bbe\u5907\uff0c\u5728\u52a0\u8f7d <code>nbd</code> \u6a21\u5757\u7684\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u56e0\u8bbe\u5907\u53f7\u5206\u914d\u5931\u8d25\u800c\u51fa\u9519\uff0c\u5728\u5185\u6838\u65e5\u5fd7\u4e2d\u7559\u4e0b\u4e00\u4e2a oops\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u901a\u8fc7 <code>nbds_max</code> \u53c2\u6570\u9650\u5236 <code>nbd</code> \u8bbe\u5907\u7684\u6570\u91cf\u3002</p> <pre><code>modprobe nbd nbds_max=2\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>qemu-nbd</code> \u547d\u4ee4\u6302\u8f7d\u78c1\u76d8\u955c\u50cf\uff0c\u5e38\u7528\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>qemu-nbd -c /dev/nbdX -f &lt;FORMAT:raw|qcow2|...&gt; --discard=&lt;unmap|ignore&gt; &lt;IMAGE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-c</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a nbd \u8bbe\u5907\u53f7\uff0c<code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>--discard</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u652f\u6301\u7684 TRIM/DISCARD \u64cd\u4f5c\uff0c<code>&lt;IMAGE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u3002\u5982\u679c\u9700\u8981\u53ea\u8bfb\u6302\u8f7d\uff0c\u53ef\u4ee5\u6307\u5b9a <code>-r</code> \u9009\u9879\u3002<code>qemu-nbd</code> \u7684\u5176\u4ed6\u7528\u6cd5\u548c\u9009\u9879\u53ef\u4ee5\u901a\u8fc7 <code>man qemu-nbd</code> \u6216 <code>qemu-nbd --help</code> \u67e5\u770b\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_14","title":"\u7ba1\u7406\u5de5\u5177","text":"<p>\u672c\u8282\u5185\u5bb9\u5f85\u8865\u5145</p> <p>QEMU \u76f4\u63a5\u8fd0\u884c\u53c2\u6570\u4f17\u591a\uff0c\u914d\u7f6e\u590d\u6742\uff0c\u56e0\u6b64\u4e00\u822c\u4e0d\u76f4\u63a5\u8fd0\u884c QEMU \u547d\u4ee4\uff0c\u800c\u662f\u4f7f\u7528\u4e00\u4e9b\u7ba1\u7406\u5de5\u5177\u6765\u521b\u5efa\u548c\u7ba1\u7406\u865a\u62df\u673a\uff0c\u5982 libvirt\uff0cvirt-manager, Proxmox VE \u7b49\u3002</p>"}]}