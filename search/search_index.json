{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Linux 201 \u8fdb\u9636\u6559\u7a0b","text":"<p>\u6b22\u8fce\u6765\u5230 Linux 201 \u8fdb\u9636\u6559\u7a0b\uff0c\u672c\u6559\u7a0b\u4e3b\u8981\u9762\u5411 Debian \u53ca\u5176\u884d\u751f\u53d1\u884c\u7248\uff08\u5982 Ubuntu \u7b49\uff09\u7684\u7cfb\u7edf\u8fd0\u7ef4\uff0c\u56e0\u6b64\u4e0e\u4f20\u7edf\u7684 Linux \u6559\u7a0b\u6709\u6240\u4e0d\u540c\u3002</p> <ul> <li>\u4f5c\u4e3a\u7cfb\u7edf\u7ba1\u7406\u5458\uff0c\u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\u662f\u4e00\u9879\u57fa\u672c\u6280\u80fd\uff0c\u56e0\u6b64\u672c\u6559\u7a0b\u4e0d\u4f1a\u4ecb\u7ecd\u56fe\u5f62\u754c\u9762\u5de5\u5177</li> <li>\u5404\u79cd\u8f6f\u4ef6\u5de5\u5177\u90fd\u9644\u5e26\u4e86\u5b8c\u5584\u7684 man \u624b\u518c\uff0c\u56e0\u6b64\u672c\u6559\u7a0b\u4e5f\u4e0d\u4f1a\u8be6\u7ec6\u4ecb\u7ecd\u6240\u6709\u8f6f\u4ef6\u7684\u6bcf\u4e2a\u7ec6\u8282</li> </ul>"},{"location":"advanced/","title":"\u9ad8\u7ea7\u5185\u5bb9","text":""},{"location":"advanced/cuda/","title":"CUDA \u73af\u5883\u7b80\u4ecb","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>CUDA\uff08Compute Unified Device Architecture\uff09\u662f\u7531 NVIDIA \u516c\u53f8\u63a8\u51fa\u7684\u5f00\u53d1\u5957\u4ef6\uff0c\u5b83\u5141\u8bb8\u8f6f\u4ef6\u5f00\u53d1\u4eba\u5458\u4f7f\u7528 NVIDIA \u7684 GPU\uff08\u56fe\u5f62\u5904\u7406\u5355\u5143\uff09\u8fdb\u884c\u901a\u7528\u8ba1\u7b97\u3002</p> <p>\u5305\u542b\u7684\u7ec4\u4ef6\u6709\uff1a</p> <ul> <li> <p>CUDA Runtime API\uff1aCUDA \u7f16\u7a0b\u7684\u9ad8\u7ea7 API\uff0c\u4e3a\u5f00\u53d1\u8005\u63d0\u4f9b\u4e86\u7ba1\u7406 GPU \u8bbe\u5907\u3001\u5185\u5b58\u5206\u914d\u3001\u6570\u636e\u4f20\u8f93\u548c\u6267\u884c\u8ba1\u7b97\u4efb\u52a1\u7b49\u529f\u80fd\u7684\u63a5\u53e3\u3002</p> </li> <li> <p>CUDA Driver API\uff1aCUDA \u7684\u4f4e\u7ea7 API\uff0c\u63d0\u4f9b\u4e86\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u5141\u8bb8\u5f00\u53d1\u8005\u76f4\u63a5\u4e0e CUDA \u9a71\u52a8\u7a0b\u5e8f\u4ea4\u4e92\u3002\u5bf9\u4e8e\u9700\u8981\u66f4\u7cbe\u7ec6\u7ba1\u7406\u8d44\u6e90\u548c\u6267\u884c\u6a21\u578b\u7684\u9ad8\u7ea7\u7528\u6237\u6765\u8bf4\uff0c\u8fd9\u662f\u4e00\u4e2a\u6709\u7528\u7684\u5de5\u5177\u3002</p> </li> <li> <p>CUDA Toolkit\uff1a\u4e00\u7cfb\u5217\u7f16\u8bd1\u5de5\u5177\u3001\u5e93\u548c\u6280\u672f\u6587\u6863\u3002\u5305\u62ec <code>nvcc</code>\uff08NVIDIA \u7684 CUDA \u7f16\u8bd1\u5668\uff09\u3001CUDA \u5e93\u3001CUDA \u8c03\u8bd5\u5668\u3001\u6027\u80fd\u5206\u6790\u5de5\u5177\uff08\u5982 <code>nvprof</code>\uff09\u4ee5\u53ca\u5176\u4ed6\u5f00\u53d1\u5de5\u5177\u3002</p> </li> <li> <p>CUDA Libraries\uff1a\u4e00\u7ec4\u4e3a\u52a0\u901f\u4e0d\u540c\u7c7b\u578b\u7684\u8ba1\u7b97\u4efb\u52a1\u800c\u4f18\u5316\u7684\u5e93</p> <ul> <li> <p>cuBLAS\uff1a\u57fa\u672c\u7ebf\u6027\u4ee3\u6570\u5b50\u7a0b\u5e8f\uff08<code>BLAS</code>\uff09\u7684 GPU \u52a0\u901f\u7248\u672c\u3002</p> </li> <li> <p>cuFFT\uff1a\u5728 GPU \u4e0a\u8fdb\u884c\u5feb\u901f\u5085\u91cc\u53f6\u53d8\u6362\u7684\u5e93\u3002</p> </li> <li> <p>cuRAND\uff1a\u5728 GPU \u4e0a\u751f\u6210\u968f\u673a\u6570\u7684\u5e93\u3002</p> </li> <li> <p>cuDNN\uff1a\u7528\u4e8e\u6df1\u5ea6\u795e\u7ecf\u7f51\u7edc\u7684 GPU \u52a0\u901f\u7684\u539f\u8bed\u548c\u51fd\u6570\u5e93\u3002</p> </li> <li> <p>NCCL\uff1a\u591a GPU \u548c\u591a\u8282\u70b9\u4e0a\u7684\u96c6\u5408\u901a\u4fe1\u7684\u5e93\u3002</p> </li> <li> <p>Thrust\uff1a\u7c7b\u4f3c\u4e8e C++\u6807\u51c6\u6a21\u677f\u5e93\uff08<code>STL</code>\uff09\u7684\u5e76\u884c\u7b97\u6cd5\u5e93\u3002</p> </li> </ul> </li> <li> <p>CUDA Samples\uff1a \u793a\u4f8b\u4ee3\u7801\uff0c\u6db5\u76d6\u4e86\u57fa\u672c\u7684<code>Hello World</code>\u7a0b\u5e8f\u5230\u66f4\u590d\u6742\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</p> </li> <li> <p>NVIDIA Nsight Tools\uff1a \u96c6\u6210\u5f00\u53d1\u73af\u5883\u548c\u8c03\u8bd5\u5de5\u5177\uff0c\u7528\u4e8e\u5e2e\u52a9\u5f00\u53d1\u8005\u4f18\u5316 CUDA \u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u548c\u53ef\u9760\u6027\u3002\u5305\u62ec <code>Nsight Eclipse Edition</code>\u3001<code>Nsight Visual Studio Edition</code>\u3001<code>Nsight Compute</code> \u548c <code>Nsight Systems</code>\u3002</p> </li> <li> <p>CUDA Documentation\uff1a\u5305\u62ec API \u53c2\u8003\u3001\u7f16\u7a0b\u6307\u5357\u3001\u6700\u4f73\u5b9e\u8df5\u6307\u5357\u548c\u5176\u4ed6\u6280\u672f\u8d44\u6e90\u7b49</p> </li> </ul>"},{"location":"advanced/cuda/#cuda_1","title":"\u914d\u7f6e CUDA \u73af\u5883","text":""},{"location":"advanced/cuda/#_1","title":"\u786c\u4ef6\u51c6\u5907","text":"<p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u786e\u8ba4\u663e\u5361\u662f\u5426\u652f\u6301\u652f\u6301 CUDA \u3002\u5728\u8fd9\u91cc\u53ef\u4ee5\u67e5\u770b\u652f\u6301\u7684\u5217\u8868\uff1ahttps://developer.nvidia.com/CUDA-gpus</p> <p>\u8868\u4e2d\u7684<code>Compute Capability</code>\u4ee3\u8868\u8ba1\u7b97\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u8868\u660e\u4e86 GPU \u652f\u6301\u7684 CUDA \u7279\u6027\u548c\u6307\u4ee4\u96c6\u7248\u672c\u3002</p>"},{"location":"advanced/cuda/#cuda_2","title":"\u5b89\u88c5 CUDA","text":"<p>\u867d\u7136\u5728\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0b\uff0cCUDA \u7684\u591a\u79cd\u4e0d\u540c\u7684\u5b89\u88c5\u65b9\u5f0f\uff0c\u4f46\u603b\u7684\u6765\u8bf4\uff0c\u5728 Linux \u4e0b\uff0cCUDA \u7684\u5b89\u88c5\u65b9\u5f0f\u5927\u81f4\u5206\u4e3a\uff1a</p> <ul> <li> <p>\u4f7f\u7528\u5b98\u65b9 runfile \u4e00\u952e\u5b89\u88c5</p> </li> <li> <p>\u4ece\u5b98\u7f51\u4e0b\u8f7d\u672c\u5730\u4ed3\u5e93\u7684\u5b89\u88c5\u5305\uff0c\u5e76\u7528\u5305\u7ba1\u7406\u7cfb\u7edf\u8fdb\u884c\u5b89\u88c5</p> </li> <li> <p>\u76f4\u63a5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u7684\u4ed3\u5e93\u548c\u5305\u7ba1\u7406\u7cfb\u7edf\u8fdb\u884c\u5b89\u88c5</p> </li> </ul> <p>\u5bf9\u4e8e\u524d\u4e24\u79cd\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5728\u5b98\u7f51\u4e0b\u8f7d\u9875\u9762https://developer.nvidia.com/CUDA-downloads\u9009\u62e9\u5408\u9002\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7f51\u9875\u5c06\u7ed9\u51fa\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u7684\u5b89\u88c5\u6307\u4ee4\u3002</p> <p>\u5982\u679c\u4f60\u7684\u4e3b\u673a\u5904\u4e8e\u5185\u7f51\u73af\u5883\uff0c\u4f8b\u5982\u67d0\u4e9b\u4f01\u4e1a\u4e2d\uff0c\u6216\u548c Nvidia \u670d\u52a1\u5668\u7684\u8fde\u63a5\u8f83\u6162\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u81ea\u5e26\u7684\u8f6f\u4ef6\u4ed3\u5e93\u8fdb\u884c\u5b89\u88c5\u3002\u8fd9\u91cc\u4ee5\u5e38\u7528\u7684 Ubuntu \u4e3a\u4f8b\uff1a</p>"},{"location":"advanced/cuda/#_2","title":"\u5b89\u88c5\u9884\u7f16\u8bd1\u7684\u5185\u6838\u6a21\u5757","text":"<pre><code>sudo apt install linux-modules-nvidia-${DRIVER_BRANCH}${SERVER}-${LINUX_FLAVOUR}\n</code></pre> <p><code>${DRIVER_BRANCH}</code>\u662f Nvidia \u9a71\u52a8\u7684\u7248\u672c\u53f7\uff0c\u4f8b\u5982<code>525</code>,<code>535</code>\u7b49</p> <p><code>${SERVER}</code>\u53ef\u4ee5\u662f<code>-server</code>\u6216\u4e3a\u7a7a\uff0c\u4ee3\u8868\u662f\u5426\u9009\u62e9\u4e3a\u670d\u52a1\u5668\u4f18\u5316\u7684\u7248\u672c\u3002</p> <p><code>${LINUX_FLAVOUR}</code>\u53ef\u4ee5\u662f<code>generic</code>\uff0c<code>lowlatency</code>\u7b49\u3002\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u9009\u62e9\u524d\u8005\uff0c\u9664\u975e\u5e0c\u671b\u7cfb\u7edf\u5c3d\u53ef\u80fd\u7684\u5b9e\u65f6\uff0c\u540c\u65f6\u53c8\u4e0d\u5e0c\u671b\u964d\u4f4e\u592a\u591a\u7684\u6027\u80fd\u3002</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>sudo apt install linux-modules-nvidia-525-generic\n</code></pre>"},{"location":"advanced/cuda/#_3","title":"\u5b89\u88c5\u7528\u6237\u7a7a\u95f4\u7684\u9a71\u52a8\u548c\u5e93","text":"<pre><code>sudo apt install nvidia-driver-${DRIVER_BRANCH}${SERVER}\n</code></pre> <p>\u53c2\u6570\u610f\u4e49\u540c\u4e0a</p> <p>\u4f8b\u5982\uff1a</p> <pre><code>sudo apt install nvidia-driver-525\n</code></pre>"},{"location":"advanced/cuda/#_4","title":"\u67e5\u770b\u663e\u5361\u72b6\u6001","text":"<pre><code>nvidia-smi\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u53ef\u4ee5\u5217\u4e3e\u5e76\u67e5\u770b\u663e\u5361\u7684\u8d44\u6e90\u4f7f\u7528\u7387\uff0c\u6e29\u5ea6\uff0c\u529f\u7387\u7b49\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u80fd\u591f\u67e5\u770b\u5230\u4f60\u7684\u663e\u5361\uff0c\u90a3\u4e48\u606d\u559c\u4f60\uff0c\u663e\u5361\u5df2\u7ecf\u53ef\u4ee5\u4f7f\u7528\u4e86\u3002</p> <p>Tip</p> <p><code>nvidia-smi</code>\u754c\u9762\u53f3\u4e0a\u89d2\u663e\u793a\u7684 CUDA \u7248\u672c\u662f\u6307\u5f53\u524d\u7cfb\u7edf\u4e0a\u5b89\u88c5\u7684 NVIDIA \u9a71\u52a8\u652f\u6301\u7684\u6700\u9ad8 CUDA \u7248\u672c\uff0c\u5e76\u4e0d\u662f\u5df2\u5b89\u88c5\u7684 CUDA \u7248\u672c</p>"},{"location":"advanced/cuda/#_5","title":"\u6dfb\u52a0\u73af\u5883\u53d8\u91cf\uff08\u53ef\u9009\uff09","text":"<p>\u5982\u679c\u4f60\u60f3\u8981\u65b9\u4fbf\u5730\u5728 Shell \u4e2d\u4f7f\u7528 CUDA \u6307\u4ee4\uff0c\u9700\u8981\u5c06\u53ef\u6267\u884c\u6587\u4ef6\u76ee\u5f55\u52a0\u5230<code>PATH</code>\u73af\u5883\u53d8\u91cf\u4e2d</p> <p>\u5728<code>~/.bashrc</code>\u7b49\u6587\u4ef6\u4e2d\u6dfb\u52a0\u8fd9\u4e00\u884c</p> <pre><code>export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}\n</code></pre> <p>\u4ee5\u4fbf\u6267\u884c nvcc \u7b49\u7a0b\u5e8f\u3002</p> <p>\u5982\u679c\u7f16\u8bd1\u9879\u76ee\u65f6\u627e\u4e0d\u5230 CUDA \u5e93\uff0c\u5219\u9700\u8981\u66f4\u65b0\u52a8\u6001\u94fe\u63a5\u5e93\u8def\u5f84\u3002</p> <p>\u5728<code>~/.bashrc</code>\u7b49\u6587\u4ef6\u4e2d\u6dfb\u52a0\u8fd9\u4e00\u884c</p> <pre><code>export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}\n</code></pre>"},{"location":"advanced/cuda/#cuda_3","title":"CUDA \u7f16\u7a0b\u6a21\u578b","text":""},{"location":"advanced/nmap/","title":"Nmap: \u7f51\u7edc\u63a2\u6d4b\u548c\u5b89\u5168\u68c0\u67e5\u5de5\u5177","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>Nmap\uff08Network Mapper\uff09\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u7f51\u7edc\u63a2\u6d4b\u548c\u5b89\u5168\u68c0\u67e5\u5de5\u5177\uff0c\u4e3b\u8981\u529f\u80fd\u5305\u62ec\uff0c\u4e3b\u673a\u53d1\u73b0\uff0c\u7aef\u53e3\u626b\u63cf\uff0c\u670d\u52a1\u7248\u672c\u63a2\u6d4b\uff0c\u64cd\u4f5c\u7cfb\u7edf\u68c0\u6d4b\uff0c\u811a\u672c\u626b\u63cf\u7b49\u3002</p> <p>\u8fd9\u662f\u4e00\u4efd Nmap \u4f7f\u7528\u624b\u518c\uff0c\u4f60\u53ef\u4ee5\u53c2\u8003\u672c\u6587\u5feb\u901f\u4e0a\u624b\u4f7f\u7528\u3002</p>"},{"location":"advanced/nmap/#nmap_1","title":"\u5b89\u88c5 Nmap","text":"<p>\u5728\u5927\u591a\u6570 Linux \u53d1\u884c\u7248\u4e2d\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5305\u7ba1\u7406\u5668\u5b89\u88c5 Nmap\uff1a</p>"},{"location":"advanced/nmap/#debianubuntu","title":"Debian/Ubuntu","text":"<pre><code>sudo apt-get install nmap\n</code></pre>"},{"location":"advanced/nmap/#centosfedora","title":"CentOS/Fedora","text":"<pre><code>sudo yum install nmap\n</code></pre>"},{"location":"advanced/nmap/#arch-linux","title":"Arch Linux","text":"<pre><code>sudo pacman -S nmap\n</code></pre>"},{"location":"advanced/nmap/#nmap_2","title":"Nmap \u57fa\u672c\u7528\u6cd5\u4e3e\u4f8b","text":""},{"location":"advanced/nmap/#_1","title":"\u57fa\u672c\u626b\u63cf","text":"<p>\u626b\u63cf\u7f51\u7edc\u4e2d\u7684\u4e3b\u673a\uff0c\u5f00\u653e\u7684\u7aef\u53e3\u548c\u5bf9\u5e94\u7684\u8fd0\u884c\u7684\u670d\u52a1</p> <p>Tip</p> <p>\u5728\u626b\u63cf\u4e2d\u6309\u4e0b <code>Ctrl+V</code> \u53ef\u4ee5\u663e\u793a\u8fdb\u5ea6</p> <p>\u626b\u63cf\u5355\u4e2a\u4e3b\u673a\uff1a</p> <pre><code>nmap [target]\n</code></pre> <p>\u626b\u63cf\u591a\u4e2a\u4e3b\u673a\uff1a</p> <pre><code>nmap [target1] [target2] [target3]\n</code></pre> <p>\u626b\u63cf\u6574\u4e2a\u5b50\u7f51\uff1a</p> <pre><code>nmap [subnet]/24\n</code></pre> <p>Tip</p> <p>\u5982\u679c\u4f60\u60f3\u626b\u63cf\u6574\u4e2a\u7f51\u7edc\uff0c\u4f46\u9700\u8981\u8df3\u8fc7\u67d0\u4e9b\u4e3b\u673a\uff0c\u53ef\u4ee5\u4f7f\u7528 --exclude \u9009\u9879\u3002</p> <p>\u6267\u884c SYN \u626b\u63cf\uff1a</p> <p>\uff08\u53ef\u80fd\u9700\u8981 root \u6743\u9650\uff0c\u5426\u5219\u65e0\u6cd5\u53d1\u9001\u539f\u59cb\u62a5\u6587\uff09</p> <pre><code>sudo nmap -sS [target]\n</code></pre> <p>\u6267\u884c UDP \u626b\u63cf\uff08\u53ef\u80fd\u9700\u8981\u8f83\u957f\u65f6\u95f4\uff09\uff1a</p> <pre><code>sudo nmap -sU [target]\n</code></pre>"},{"location":"advanced/nmap/#_2","title":"\u7aef\u53e3\u626b\u63cf","text":"<p>\u626b\u63cf\u7279\u5b9a\u7aef\u53e3\uff1a</p> <pre><code>nmap -p [port] [target]\n</code></pre> <p>\u626b\u63cf\u591a\u4e2a\u7aef\u53e3\uff1a</p> <pre><code>nmap -p [port1],[port2],[port3] [target]\n</code></pre> <p>\u626b\u63cf\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u7aef\u53e3\uff1a</p> <pre><code>nmap -p [start_port]-[end_port] [target]\n</code></pre>"},{"location":"advanced/nmap/#_3","title":"\u670d\u52a1\u548c\u7248\u672c\u68c0\u6d4b","text":"<p>\u68c0\u6d4b\u670d\u52a1\u7684\u7248\u672c\u4fe1\u606f\uff1a</p> <pre><code>nmap -sV [target]\n</code></pre>"},{"location":"advanced/nmap/#_4","title":"\u64cd\u4f5c\u7cfb\u7edf\u68c0\u6d4b","text":"<p>\u68c0\u6d4b\u67d0\u4e2a\u4e3b\u673a\u7684\u64cd\u4f5c\u7cfb\u7edf\uff1a</p> <pre><code>nmap -O [target]\n</code></pre> <p>Tip</p> <p>\u4f7f\u7528 -T \u9009\u9879\u53ef\u4ee5\u8bbe\u7f6e Nmap \u7684\u626b\u63cf\u901f\u5ea6\uff0c-T4 \u548c -T5 \u9009\u9879\u53ef\u4ee5\u52a0\u5feb\u626b\u63cf\u901f\u5ea6\uff0c\u4f46\u4e5f\u66f4\u5bb9\u6613\u88ab\u5165\u4fb5\u68c0\u6d4b\u7cfb\u7edf\uff08IDS\uff09\u53d1\u73b0\u3002\u5982\u679c\u60f3\u8981\u66f4\u9690\u853d\u5730\u626b\u63cf\uff0c\u53ef\u4ee5\u9009\u62e9 -T2 \u6216 -T3\u3002</p>"},{"location":"advanced/nmap/#_5","title":"\u8f93\u51fa\u683c\u5f0f","text":"<p>Nmap \u652f\u6301\u7684\u8f93\u51fa\u683c\u5f0f\u5305\u62ec\uff1a</p> <ul> <li>\u6807\u51c6\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u3002</li> <li>-oN \u8f93\u51fa\u5230\u666e\u901a\u6587\u4ef6\u3002</li> <li>-oX \u8f93\u51fa\u4e3a XML \u683c\u5f0f\u3002</li> <li>-oG \u8f93\u51fa\u4e3a grep \u53cb\u597d\u683c\u5f0f\u3002</li> <li>-oA \u8f93\u51fa\u6240\u6709\u4e0a\u8ff0\u683c\u5f0f\u3002</li> </ul> <p>\u4f8b\u5982\u60f3\u8981\u8f93\u51fa\u5230\u6587\u4ef6\uff0c\u53ef\u4ee5\u8fd9\u6837\u505a\uff1a</p> <pre><code>nmap -oN output.txt [target]\n</code></pre> <p>Tip</p> <p>\u5982\u679c\u4f60\u4e0d\u559c\u6b22\u547d\u4ee4\u884c\uff0c\u53ef\u4ee5\u4f7f\u7528 Nmap \u7684\u56fe\u5f62\u7528\u6237\u754c\u9762\u7248\u672c Zenmap\uff0c\u5b83\u63d0\u4f9b\u4e86\u7528\u6237\u53cb\u597d\u7684\u754c\u9762\u6765\u8fd0\u884c\u626b\u63cf\u548c\u5206\u6790\u7ed3\u679c\u3002</p>"},{"location":"dev/","title":"\u5f00\u53d1\u901f\u67e5\u624b\u518c","text":""},{"location":"dev/ssh/","title":"SSH \u4f7f\u7528\u6280\u5de7","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u5c3d\u7ba1 SSH \u662f\u4e00\u79cd\u5f00\u653e\u534f\u8bae\uff0c\u5b83\u7684\u4e3b\u6d41\u5b9e\u73b0 OpenSSH \u5177\u6709\u6700\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u56e0\u6b64\u672c\u6559\u7a0b\u53ea\u4ecb\u7ecd OpenSSH \u7684\u4f7f\u7528\u3002</p>"},{"location":"dev/ssh/#ssh-config","title":"\u5ba2\u6237\u7aef\u914d\u7f6e","text":"<p>SSH \u5ba2\u6237\u7aef\u4f1a\u6309\u987a\u5e8f\u5904\u7406\u4ee5\u4e0b\u914d\u7f6e\uff0c\u5148\u51fa\u73b0\u7684\u914d\u7f6e\u4f18\u5148\u7ea7\u66f4\u9ad8\uff1a</p> <ul> <li>\u547d\u4ee4\u884c\u53c2\u6570</li> <li><code>~/.ssh/config</code></li> <li><code>/etc/ssh/ssh_config</code></li> </ul> <p>OpenSSH \u7684\u6240\u6709\u914d\u7f6e\u9879\u90fd\u53ef\u4ee5\u5728 ssh_config(5) \u4e2d\u627e\u5230\uff0c\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e9b\u5e38\u7528\u7684\u914d\u7f6e\u3002</p> <p>\u5bf9\u4e8e\u7ecf\u5e38\u767b\u5f55\u7684\u4e3b\u673a\uff0c\u53ef\u4ee5\u5728 <code>~/.ssh/config</code> \u4e2d\u914d\u7f6e\u4e3b\u673a\u522b\u540d\u3001\u7528\u6237\u540d\u3001\u7aef\u53e3\u7b49\u4fe1\u606f\uff0c\u4ee5\u7b80\u5316\u767b\u5f55\u547d\u4ee4\u3002</p> <pre><code>Host example\n  Hostname example.com\n  User sshuser\n  Port 22\n</code></pre> <p>\u6ce8\u610f SSH config \u6ca1\u6709\u63d0\u4f9b\u5bc6\u7801\u914d\u7f6e\uff0c\u56e0\u4e3a\u8fd9\u662f\u4e0d\u5b89\u5168\u7684\uff0c\u8bf7\u4f7f\u7528\u5bc6\u94a5\u767b\u5f55\u3002</p>"},{"location":"dev/ssh/#public-key-authentication","title":"\u516c\u94a5\u8ba4\u8bc1","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cSSH \u4f1a\u5bfb\u627e <code>~/.ssh/id_*</code> \u4f5c\u4e3a\u79c1\u94a5\uff0c\u5176\u4e2d <code>*</code> \u90e8\u5206\u53ef\u4ee5\u662f <code>rsa</code>\u3001<code>dsa</code>\u3001<code>ecdsa</code>\u3001<code>ed25519</code> \u7b49\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>-i</code> \u53c2\u6570\u6307\u5b9a\u79c1\u94a5\u6587\u4ef6\u3002\u79c1\u94a5\u7684\u6587\u4ef6\u540d\u52a0\u4e0a <code>.pub</code> \u540e\u7f00\u5c31\u662f\u516c\u94a5\u6587\u4ef6\uff0c\u6682\u65f6\u6ca1\u6709\u65b9\u6cd5\u6307\u5b9a\u516c\u94a5\u6587\u4ef6\u7684\u8def\u5f84\u3002\u5982\u679c\u8981\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u79c1\u94a5\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>IdentityFile</code> \u9009\u9879\uff0c\u4f8b\u5982\uff1a</p> <pre><code>Host example\n  IdentityFile ~/.ssh/id_rsa\n  #CertificateFile ~/.ssh/id_rsa-cert.pub\n</code></pre> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u9664\u975e\u4e3a\u4e86\u517c\u5bb9\u4e00\u4e9b\u975e\u5e38\u53e4\u8001\uff08\u5982 10 \u5e74\u524d\u7684\uff09\u6216\u975e\u5e38\u7b80\u5355\u7684\uff08\u5982\u5d4c\u5165\u5f0f\uff09\u7cfb\u7edf\u800c\u4e0d\u5f97\u4e0d\u4f7f\u7528\u8f83\u77ed\u7684 RSA \u5bc6\u94a5\u5bf9\u7684\u65f6\u5019\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528 Ed25519 \u5bc6\u94a5\u5bf9\uff0c\u6216\u8005 ECDSA \u5bc6\u94a5\u5bf9\u3002\u8fd9\u4e24\u79cd\u57fa\u4e8e\u692d\u5706\u66f2\u7ebf\u7684\u5bc6\u7801\u5b66\u7b97\u6cd5\u6bd4 RSA \u66f4\u5b89\u5168\uff0c\u800c\u4e14\u6027\u80fd\u4e5f\u66f4\u597d\u3002\u5982\u679c\u4e0d\u5f97\u4e0d\u4f7f\u7528 RSA \u7684\u8bdd\uff0c\u8bf7\u5c3d\u53ef\u80fd\u4f7f\u7528 3072 \u4f4d\u6216\u66f4\u957f\u7684\u5bc6\u94a5\u957f\u5ea6\u3002\u5bc6\u94a5\u957f\u5ea6\u53ef\u4ee5\u5728\u4f7f\u7528 <code>ssh-keygen</code> \u751f\u6210\u5bc6\u94a5\u5bf9\u65f6\u6307\u5b9a\uff08<code>-b</code>\uff09\uff0c\u5176\u4e2d\u4e0d\u540c\u7b97\u6cd5\u652f\u6301\u4e0e\u63a8\u8350\u7684\u957f\u5ea6\u4e5f\u662f\u4e0d\u540c\u7684\uff1a</p> \u7b97\u6cd5 \u652f\u6301\u957f\u5ea6 \u63a8\u8350\u957f\u5ea6 \u8bf4\u660e RSA 1024-4096 3072 \u6216\u4ee5\u4e0a \u66fe\u7ecf\u7684\u63a8\u8350\u957f\u5ea6\u662f 2048 \u4f4d\uff0c\u4f46 2020 \u5e74\u4ee5\u540e\u8ba4\u4e3a\u8fd9\u4e2a\u957f\u5ea6\u5df2\u4e0d\u591f\u5b89\u5168 DSA\uff08\u4e0d\u63a8\u8350\uff09 1024 1024 \u7531\u4e8e\u5b89\u5168\u6027\u95ee\u9898\uff0cOpenSSH 7.0 \u4ee5\u540e\u4e0d\u518d\u9ed8\u8ba4\u652f\u6301 DSA \u5bc6\u94a5 ECDSA 256 / 384 / 521 256 / 384 / 521 \u7531\u4e8e\u692d\u5706\u66f2\u7ebf\u53c2\u6570\u9009\u62e9\u7684\u7279\u6b8a\u6027\uff0c\u53ea\u6709\u8fd9\u4e09\u79cd\u957f\u5ea6\u53ef\u9009\u3002\u6ce8\u610f\u6700\u540e\u4e00\u4e2a\u9009\u9879\u662f 521\uff0c\u4e0d\u662f 512 Ed25519 - - Ed25519 \u662f\u57fa\u4e8e Edwards \u66f2\u7ebf\u7684\u7b97\u6cd5\uff0c\u6ca1\u6709\u201c\u957f\u5ea6\u201d\u8fd9\u79cd\u53c2\u6570"},{"location":"dev/ssh/#port-forwarding","title":"\u7aef\u53e3\u8f6c\u53d1","text":"<p>SSH \u652f\u6301\u4e09\u79cd\u7aef\u53e3\u8f6c\u53d1\uff1a</p> <ul> <li> <p>\u672c\u5730\u7aef\u53e3\u8f6c\u53d1\uff08Local port forwarding\uff09\uff1a\u5728\u672c\u5730\u4e0a\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u8fdc\u7a0b\u4e3b\u673a\u7684\u6307\u5b9a\u7aef\u53e3\u3002\u4f8b\u5982\uff1a</p> <pre><code>ssh -L 8080:localhost:80 example\n</code></pre> <p>\u672c\u5730\u7aef\u53e3\u8f6c\u53d1\u9ed8\u8ba4\u76d1\u542c\u5728 localhost\u3002\u5982\u679c\u8981\u76d1\u542c\u5176\u4ed6\u5730\u5740\uff0c\u53ef\u4ee5\u6307\u5b9a\u9700\u8981\u76d1\u542c\u7684\u5730\u5740\uff0c\u4f8b\u5982\uff1a</p> <pre><code>ssh -L 0.0.0.0:8080:localhost:80 example\n</code></pre> <p>\u867d\u7136 SSH \u5ba2\u6237\u7aef\u4e5f\u6709\u4e00\u4e2a <code>GatewayPorts</code> \u9009\u9879\uff0c\u4f46\u5b83\u53ea\u5f71\u54cd\u6ca1\u6709\u6307\u5b9a\u76d1\u542c\u5730\u5740\u7684\u8bed\u6cd5\u6a21\u5f0f\uff08\u5373\u4e09\u6bb5\u5f0f <code>localport:remotehost:remoteport</code>\uff09\u3002\u6307\u5b9a\u56db\u6bb5\u5f0f\u8bed\u6cd5\u540e\uff0c<code>GatewayPorts</code> \u9009\u9879\u4e0d\u518d\u8d77\u4f5c\u7528\u3002</p> </li> <li> <p>\u8fdc\u7a0b\u7aef\u53e3\u8f6c\u53d1\uff08Remote port forwarding\uff09\uff1a\u5728\u8fdc\u7a0b\u4e3b\u673a\u4e0a\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u672c\u5730\u7684\u6307\u5b9a\u7aef\u53e3\u3002\u4f8b\u5982\uff1a</p> <pre><code>ssh -R 8080:localhost:80 example\n</code></pre> <p>\u4e0a\u9762\u547d\u4ee4\u8868\u793a\u5728\u8fdc\u7a0b\u4e3b\u673a example \u4e0a\u76d1\u542c 8080 \u7aef\u53e3\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u672c\u5730\u7684 80 \u7aef\u53e3\u3002</p> <p>\u6ce8\u610f\u8fdc\u7a0b\u7aef\u53e3\u8f6c\u53d1\u9ed8\u8ba4\u53ea\u80fd\u76d1\u542c localhost\u3002\u5982\u679c\u8981\u76d1\u542c\u5176\u4ed6\u5730\u5740\uff0c\u9700\u8981\u5728\u8fdc\u7a0b\u4e3b\u673a\u7684 <code>sshd_config</code> \u4e2d\u8bbe\u7f6e <code>GatewayPorts yes</code>\u3002\u4e0e\u53e6\u5916\u4e24\u79cd\u7aef\u53e3\u8f6c\u53d1\u4e0d\u540c\uff0c\u5ba2\u6237\u7aef\u65e0\u6cd5\u8986\u76d6\u670d\u52a1\u7aef\u7684 <code>GatewayPorts</code> \u8bbe\u5b9a\u3002</p> </li> <li> <p>\u52a8\u6001\u7aef\u53e3\u8f6c\u53d1\uff08Dynamic port forwarding\uff09\uff1a\u5728\u672c\u5730\u76d1\u542c\u4e00\u4e2a\u7aef\u53e3\u7528\u4f5c SOCKS5 \u4ee3\u7406\uff0c\u5c06\u6536\u5230\u7684\u6570\u636e\u8f6c\u53d1\u5230\u8fdc\u7a0b\u4e3b\u673a\u3002\u4f8b\u5982\uff1a</p> <pre><code>ssh -D 1080 example\n</code></pre> <p>\u7531\u4e8e SOCKS \u4ee3\u7406\u662f\u4e00\u4e2a\u901a\u7528\u7684\u4ee3\u7406\u534f\u8bae\uff0c\u56e0\u6b64\u53ef\u4ee5\u7528\u4e8e\u4efb\u4f55 TCP \u8fde\u63a5\uff0c\u4e0d\u4ec5\u4ec5\u662f HTTP\u3002</p> <p>\u4e0e LocalForward \u7c7b\u4f3c\uff0cDynamicForward \u4e5f\u53ef\u4ee5\u6307\u5b9a\u76d1\u542c\u5730\u5740\uff1a</p> <pre><code>ssh -D 0.0.0.0:1080 example\n</code></pre> <p>\u540c\u6837\u5730\uff0c<code>GatewayPorts</code> \u53ea\u5f71\u54cd\u6ca1\u6709\u6307\u5b9a\u76d1\u542c\u5730\u5740\u7684\u8bed\u6cd5\u6a21\u5f0f\uff08\u5373\u53ea\u7ed9\u51fa\u4e86\u4e00\u4e2a\u7aef\u53e3\uff09\u3002\u6307\u5b9a\u76d1\u542c\u5730\u5740\u540e\uff0c<code>GatewayPorts</code> \u9009\u9879\u4e0d\u518d\u8d77\u4f5c\u7528\u3002</p> </li> </ul> <p>\u4ee5\u4e0a\u4e09\u79cd\u7aef\u53e3\u8f6c\u53d1\u90fd\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\uff0c\u4f8b\u5982\uff1a</p> <pre><code>Host example\n  LocalForward 8080 localhost:80\n  LocalForward 8081 localhost:8081\n  RemoteForward 8080 localhost:80\n  RemoteForward 8081 localhost:8081\n  DynamicForward 1080\n  DynamicForward 1081\n</code></pre> <p><code>-L</code>\u3001<code>-R</code>\u3001<code>-D</code> \u548c\u914d\u7f6e\u6587\u4ef6\u4e2d\u5bf9\u5e94\u7684\u9009\u9879\u90fd\u53ef\u4ee5\u591a\u6b21\u51fa\u73b0\uff0c\u6307\u5b9a\u591a\u6761\u8f6c\u53d1\u89c4\u5219\uff0c\u5b83\u4eec\u4e92\u76f8\u72ec\u7acb\u3001\u4e0d\u4f1a\u8986\u76d6\uff0c\u56e0\u6b64\u5982\u679c\u91cd\u590d\u6307\u5b9a\u4e86\u540c\u4e00\u4e2a\u7aef\u53e3\uff0c\u5c31\u4f1a\u51fa\u73b0\u51b2\u7a81\u3002</p>"},{"location":"dev/ssh/#jump-host","title":"\u8df3\u677f","text":"<p>SSH \u652f\u6301\u901a\u8fc7\u8df3\u677f\u673a\u8fde\u63a5\u76ee\u6807\u4e3b\u673a\uff0c\u5373\u5148 SSH \u767b\u5f55 jump-host\uff0c\u518d\u4ece jump-host \u767b\u5f55\u76ee\u6807\u4e3b\u673a\u3002\u4e00\u4e9b\u53d7\u9650\u7684\u7f51\u7edc\u73af\u5883\u5e38\u5e38\u91c7\u7528\u8fd9\u79cd\u65b9\u6848\uff0c\u4f8b\u5982\u4e00\u4e2a\u96c6\u7fa4\u5185\u53ea\u6709\u8df3\u677f\u673a\u66b4\u9732\u5728\u516c\u7f51\u4e0a\uff0c\u800c\u5176\u4ed6\u4e3b\u673a\u90fd\u5728\u88ab\u9694\u79bb\u7684\u5185\u7f51\u4e2d\uff0c\u53ea\u80fd\u901a\u8fc7\u8df3\u677f\u673a\u8bbf\u95ee\u3002</p> <p><code>ssh</code> \u547d\u4ee4\u7684 <code>-J</code> \u9009\u9879\u53ef\u4ee5\u6307\u5b9a\u8df3\u677f\u673a\uff0c\u4f8b\u5982\uff1a</p> <pre><code>ssh -J user@jumphost.example.com user@realhost.example.com\n</code></pre> <p>\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u8bed\u53e5\u662f <code>ProxyJump user@jumphost.example.com</code>\u3002</p> <p>\u5982\u679c\u8981\u7ed9\u8df3\u677f\u673a\u8bbe\u7f6e\u66f4\u591a\u53c2\u6570\uff0c\u5982\u7aef\u53e3\u7b49\uff0c\u5219\u5fc5\u987b\u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>Host jumphost\n  HostName jumphost.example.com\n  User jumphostuser\n  Port 2333\n\nHost realhost\n  HostName realhost.example.com\n  User realhostuser\n  ProxyJump jumphost\n</code></pre>"},{"location":"dev/ssh/#connection-reuse","title":"\u9ad8\u7ea7\u529f\u80fd\uff1a\u8fde\u63a5\u590d\u7528","text":"<p>SSH \u534f\u8bae\u5141\u8bb8\u5728\u4e00\u6761\u8fde\u63a5\u5185\u8fd0\u884c\u591a\u4e2a channel\uff0c\u5176\u4e2d\u6bcf\u4e2a channel \u53ef\u4ee5\u662f\u4e00\u4e2a shell session\u3001\u7aef\u53e3\u8f6c\u53d1\u3001scp \u547d\u4ee4\u7b49\u3002OpenSSH \u652f\u6301\u8fde\u63a5\u590d\u7528\uff0c\u5373\u4e00\u4e2a SSH \u8fdb\u7a0b\u5728\u540e\u53f0\u4fdd\u6301\u8fde\u63a5\uff0c\u5176\u4ed6\u5ba2\u6237\u7aef\u5728\u8fde\u63a5\u540c\u4e00\u4e2a\u4e3b\u673a\u65f6\u53ef\u4ee5\u590d\u7528\u8fd9\u4e2a\u8fde\u63a5\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u63e1\u624b\u8ba4\u8bc1\u7b49\uff0c\u53ef\u4ee5\u663e\u8457\u51cf\u5c11\u8fde\u63a5\u65f6\u95f4\u3002\u8fd9\u5728\u9891\u7e41\u8fde\u63a5\u540c\u4e00\u4e2a\u4e3b\u673a\u65f6\u975e\u5e38\u6709\u7528\uff0c\u5c24\u5176\u662f\u5f53\u4e3b\u673a\u7684\u5ef6\u8fdf\u8f83\u5927\u3001\u5e38\u7528\u64cd\u4f5c\u6240\u9700\u7684 RTT \u8f83\u591a\u65f6\uff08\u4f8b\u5982\u4ece GitHub \u62c9\u53d6\u4ed3\u5e93\uff0c\u6216\u8005\u524d\u6587\u6240\u8ff0\u7684\u8df3\u677f\u673a\u4f7f\u7528\u65b9\u5f0f\uff09\u3002</p> <p>\u542f\u7528\u8fde\u63a5\u590d\u7528\u9700\u8981\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u540c\u65f6\u6307\u5b9a <code>ControlMaster</code>\u3001<code>ControlPath</code> \u548c <code>ControlPersist</code> \u4e09\u4e2a\u9009\u9879\uff08\u5b83\u4eec\u7684\u9ed8\u8ba4\u503c\u90fd\u662f\u7981\u7528\u6216\u8005\u5f88\u4e0d\u53cb\u597d\u7684\u503c\uff09\uff1a</p> <pre><code>Host *\n  ControlMaster auto\n  ControlPath /tmp/sshcontrol-%C\n  ControlPersist yes\n</code></pre> <p>\u5176\u4e2d <code>%C</code> \u662f <code>%l%h%p%r</code> \u7684 hash\uff0c\u56e0\u6b64\u8fde\u63a5\u4e0d\u540c\u4e3b\u673a\u7684 control socket \u4e0d\u4f1a\u51b2\u7a81\u3002\u4f46\u662f\uff0c\u5982\u679c\u4f60\u5c1d\u8bd5\u7528\u76f8\u540c\u7684\u7528\u6237\u540d\u548c\u4e0d\u540c\u7684\u516c\u94a5\u8fde\u63a5\u540c\u4e00\u4e2a\u76ee\u6807\uff08\u4f8b\u5982 <code>git@github.com</code>\uff09\uff0c\u7531\u4e8e\u6ca1\u6709\u65b0\u5efa\u8fde\u63a5\u7684\u8fc7\u7a0b\uff0c\u4f60\u6307\u5b9a\u7684\u516c\u94a5\u5e76\u4e0d\u4f1a\u751f\u6548\uff0c\u89e3\u51b3\u65b9\u6cd5\u662f\u518d\u5355\u72ec\u6307\u5b9a\u53e6\u4e00\u4e2a <code>ControlPath</code>\u3002</p>"},{"location":"dev/ssh/#sshd-config","title":"\u670d\u52a1\u7aef\u914d\u7f6e","text":"<p>\u670d\u52a1\u7aef\u7684\u914d\u7f6e\u4e0e\u5ba2\u6237\u7aef\u6709\u4e00\u4e9b\u4e0d\u540c\u70b9\uff1a</p> <ul> <li>sshd \u670d\u52a1\u7aef\u7a0b\u5e8f\u53ea\u6709\u5f88\u5c11\u91cf\u7684\u547d\u4ee4\u884c\u53c2\u6570\uff0c\u5404\u79cd\u914d\u7f6e\u90fd\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b8c\u6210\u3002\u7279\u522b\u6ce8\u610f\uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u4e0d\u5b58\u5728\uff0csshd \u4f1a\u62d2\u7edd\u542f\u52a8\u3002</li> <li>sshd \u4ec5\u6709\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6 <code>/etc/ssh/sshd_config</code>\uff0c\u5b83\u7684\u914d\u7f6e\u9879\u53ef\u4ee5\u5728 sshd_config(5) \u4e2d\u627e\u5230\u3002</li> </ul> <p>sshd \u63a5\u53d7 SIGHUP \u4fe1\u53f7\u4f5c\u4e3a\u91cd\u65b0\u8f7d\u5165\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\u3002<code>sshd -t</code> \u547d\u4ee4\u53ef\u4ee5\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\u662f\u5426\u6b63\u786e\uff0c\u8fd9\u4e5f\u662f\u5927\u591a\u6570\u53d1\u884c\u7248\u63d0\u4f9b\u7684 <code>ssh.service</code> \u4e2d\u6307\u5b9a\u7684 <code>ExecStartPre=</code> \u547d\u4ee4\u548c\u7b2c\u4e00\u6761 <code>ExecReload=</code> \u547d\u4ee4\uff0c\u5373\u5728\u5c1d\u8bd5\u542f\u52a8\u548c\u91cd\u65b0\u52a0\u8f7d\u670d\u52a1\u524d\u5148\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\u3002</p>"},{"location":"dev/ssh/#include","title":"\u62c6\u5206\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4ece OpenSSH 7.3p1 \u5f00\u59cb\uff0cssh_config \u548c sshd_config \u90fd\u652f\u6301 <code>Include</code> \u9009\u9879\uff0c\u53ef\u4ee5\u5728\u4e3b\u914d\u7f6e\u6587\u4ef6\u4e2d include \u5176\u4ed6\u6587\u4ef6\u3002\u4e0e C \u7684 <code>#include</code> \u6216 Nginx \u7684 <code>include</code> \u4e0d\u540c\uff0cSSH config \u91cc\u7684 <code>Include</code> \u4e0d\u7b49\u4ef7\u4e8e\u6587\u672c\u63d2\u5165\u66ff\u6362\uff0c\u5e76\u4e14 <code>Include</code> \u53ef\u4ee5\u51fa\u73b0\u5728 <code>Host</code> \u548c <code>Match</code> \u5757\u4e2d\u3002\u56e0\u6b64\u4e00\u4e2a\uff08\u4e0d\u592a\u5e38\u89c1\u7684\uff09\u5751\u662f\uff1a</p> \u9519\u8bef\u5199\u6cd5 <pre><code>Host example\n  HostName example.com\n  User user\n\nInclude ~/.ssh/global.conf\n</code></pre> <p>\u56e0\u4e3a SSH \u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u65f6\u662f\u4e0d\u4f1a\u770b\u7f29\u8fdb\u7684\uff0c\u56e0\u6b64\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 Include \u4ec5\u5bf9 <code>Host example</code> \u751f\u6548\u3002\u6b63\u786e\u7684\u5199\u6cd5\u662f\u5c06\u5176\u653e\u5728\u4e00\u4e2a <code>Match all</code> \u5757\uff08\u6216\u8005 <code>Host *</code>\uff09\u4e2d\uff1a</p> \u6b63\u786e\u5199\u6cd5 <pre><code>Host example\n  HostName example.com\n  User user\n\nMatch all\n  Include ~/.ssh/global.conf\n</code></pre> <p>\u66f4\u52a0\u63a8\u8350\u7684\u5199\u6cd5\u662f\u5c06 <code>Include</code> \u653e\u5728\u914d\u7f6e\u6587\u4ef6\u5f00\u5934\uff1a</p> <p>\u63a8\u8350\u5199\u6cd5</p> <pre><code>Include ~/.ssh/global.conf\n\nHost example\n  HostName example.com\n  User user\n</code></pre>"},{"location":"dev/ssh/#traps","title":"\u4e00\u4e9b\u5751\u70b9","text":"<p>\u5728 OpenSSH \u5185\u90e8\uff0c\u540c\u4e00\u4e2a\u201c\u4ee3\u53f7\u201d\u53ef\u80fd\u6307\u4ee3\u591a\u79cd\uff08\u6709\u5173\u8054\u4f46\uff09\u4e0d\u540c\u7684\u7ec6\u8282\u3002\u4f8b\u5982 <code>ssh-rsa</code> \u81f3\u5c11\u6709\u4ee5\u4e0b\u4e09\u79cd\u4e0d\u540c\u7684\u542b\u4e49\uff1a</p> <ul> <li>RSA \u5bc6\u94a5\u5bf9\u6216 RSA \u516c\u94a5\u7b97\u6cd5\uff08<code>id_rsa</code> \u548c <code>id_rsa.pub</code> \u6587\u4ef6\uff09</li> <li> <p>\u57fa\u4e8e RSA / SHA-1 \u7684 SSH \u8bc1\u4e66\u7684\u7b7e\u540d\u7b97\u6cd5\uff08<code>CASignatureAlgorithms</code>\uff09</p> <p>\u8fd9\u79cd\u7b97\u6cd5\u5df2\u7ecf\u5728 OpenSSH 8.2 \u4e2d\u88ab\u6dd8\u6c70\uff0c\u800c OpenSSH 7.2 \u8d77\u5c31\u5df2\u7ecf\u652f\u6301\u66ff\u4ee3\u7b97\u6cd5 <code>rsa-sha2-256</code> \u548c <code>rsa-sha2-512</code>\uff08\u91c7\u7528 SHA-256 \u548c SHA-512 \u54c8\u5e0c\u7b97\u6cd5\uff09\uff0c\u867d\u7136\u76f4\u5230 OpenSSH 8.2\uff0c\u4f7f\u7528 RSA CA \u79c1\u94a5\u7b7e\u51fa\u6765\u7684\u8bc1\u4e66\u624d\u9ed8\u8ba4\u91c7\u7528 <code>rsa-sha2-512</code> \u7b97\u6cd5\u3002</p> <p>\u5982\u679c\u4f60\u6b63\u5728\u4f7f\u7528\u4e00\u4e2a RSA CA\uff0c\u90a3\u4e48\u4f60\u9700\u8981\u5c06\u5df2\u6709\u7684\u8bc1\u4e66\u4f7f\u7528 OpenSSH 8.2 \u4ee5\u4e0a\u7684\u7248\u672c\u91cd\u65b0\u7b7e\u540d\u3002</p> <p>\u5982\u679c\u9700\u8981\u4e34\u65f6\u517c\u5bb9 \u2264 7.1 \u7248\u672c\u7684 OpenSSH\uff0c\u53ef\u4ee5\u5728 <code>~/.ssh/config</code> \u6216 <code>sshd_config</code> \u4e2d\u6307\u5b9a <code>CASignatureAlgorithms +ssh-rsa</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4f7f\u7528\u65e7\u7248\u672c\u7684\u8bc1\u4e66\u7b7e\u540d\u7b97\u6cd5\u4e86\u3002</p> </li> <li> <p>\u57fa\u4e8e RSA / SHA-1 \u7684\u516c\u94a5\u7b7e\u540d\u7b97\u6cd5\u5957\u4ef6\uff08<code>ssh-rsa</code>\uff09\u3002\u4e0e\u524d\u9762\u7684\u8bc1\u4e66\u4e0d\u540c\uff0c\u8fd9\u79cd\u7b7e\u540d\u7b97\u6cd5\u662f\u7528\u4e8e\u7528\u6237\u767b\u5f55\u65f6\u7684\u516c\u94a5\u9a8c\u8bc1\uff0c\u4e0d\u4f1a\u4fdd\u5b58\u5728\u6587\u4ef6\u91cc\uff0c\u800c\u662f\u5728 SSH \u534f\u8bae\u5185\u90e8\u4f7f\u7528\u3002</p> <p>\u4e0e\u524d\u4e00\u4e2a\u91c7\u7528 SHA-1 \u4f5c\u4e3a\u54c8\u5e0c\u7b97\u6cd5\u7684\u7b97\u6cd5\u5957\u4ef6\u7c7b\u4f3c\uff0cOpenSSH 8.8 \u8d77\u4e5f\u4e0d\u518d\u9ed8\u8ba4\u542f\u7528\uff0c\u4e14\u66ff\u4ee3\u7b97\u6cd5\u4e5f\u5206\u522b\u53eb\u505a <code>rsa-sha2-256</code> \u548c <code>rsa-sha2-512</code>\u3002\u597d\u6d88\u606f\u662f\uff0c\u4f60\u4e0d\u9700\u8981\u91cd\u65b0\u7b7e\u53d1\u4efb\u4f55\u8bc1\u4e66\uff0c\u53ea\u8981\u786e\u4fdd\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u7684 OpenSSH \u7248\u672c\u90fd\u4e0d\u4f4e\u4e8e 7.2 \u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u5982\u679c\u9700\u8981\u4e34\u65f6\u517c\u5bb9 \u2264 7.1 \u7248\u672c\u7684 OpenSSH\uff0c\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u9009\u9879 <code>HostkeyAlgorithms</code> \u548c <code>PubkeyAcceptedAlgorithms</code> \u542f\u7528\u3002\u8fd9\u4e24\u4e2a\u9009\u9879\u5206\u522b\u63a7\u5236\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u7684\u516c\u94a5\u7b7e\u540d\u7b97\u6cd5\u5957\u4ef6\uff0c\u5e76\u4e14\u5728\u4e24\u7aef\u90fd\u53ef\u4ee5\u6307\u5b9a\u3002</p> </li> </ul>"},{"location":"ops/","title":"\u8fd0\u7ef4\u57fa\u7840","text":""},{"location":"ops/checklist/","title":"\u8fd0\u7ef4\u68c0\u67e5\u5355","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u672c\u8282\u4e3b\u8981\u63d0\u4f9b\u5982\u5355/\u591a\u53f0 Linux \u670d\u52a1\u5668\u4f9b\u591a\u7528\u6237\u5206\u4eab\u7684\u60c5\u51b5\u4e0b\u7684\u8fd0\u7ef4\u914d\u7f6e\u548c\u68c0\u67e5\u6e05\u5355\u3002</p> <p>\u5982\u679c\u9075\u5faa\u672c\u8282\u63d0\u4f9b\u7684\u5185\u5bb9\u8fdb\u884c\u8bbe\u7f6e\u548c\u6392\u67e5\u64cd\u4f5c\uff0c\u5219\u53ef\u4ee5\u90e8\u7f72\u57fa\u672c\u53ef\u7528\u7684\u670d\u52a1\u5668\u73af\u5883\uff0c\u5e76\u4e14\u9632\u8303\u5e38\u89c1\u7684\u7f51\u7edc\u5b89\u5168\u95ee\u9898\u3002</p>"},{"location":"ops/checklist/#_2","title":"\u7cfb\u7edf\u5b89\u88c5","text":"<ul> <li>\u4f7f\u7528 PXE \u65b9\u5f0f\u6216 U \u76d8\u5b89\u88c5\u8f83\u7a33\u5b9a\u4e14\u786e\u4fdd\u9002\u5f53\u957f\u5ea6\u7684\u7ef4\u62a4\u65f6\u95f4\u7684 Linux \u53d1\u884c\u7248</li> <li>\u5b89\u88c5\u65f6\u5bf9\u6709 root \u6216\u6709 sudo \u6743\u9650\u7684\u7528\u6237\u8bbe\u7f6e\u5f3a\u5bc6\u7801</li> <li>\u5c3d\u91cf\u5728 SSD \u4e0a\u90e8\u7f72\u7cfb\u7edf rootfs\uff0c\u5e76\u4e14\u786e\u8ba4\u5206\u533a\u65b9\u6848\u5408\u7406</li> </ul>"},{"location":"ops/checklist/#_3","title":"\u8f6f\u4ef6\u5b89\u88c5","text":"<ul> <li>\u5bf9\u4e8e\u90e8\u7f72\u5728\u4e2d\u56fd\u5927\u9646\u5730\u533a\u7684\u670d\u52a1\u5668\uff0c\u4f7f\u7528\u955c\u50cf\u7ad9\u66ff\u6362\u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\u63d0\u4f9b\u7684\u6e90</li> <li>\u9664\u975e\u786e\u6709\u9700\u8981\uff0c\u4e0d\u4f7f\u7528\u9664\u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\u4e4b\u5916\u7684\u65b9\u6cd5\u5b89\u88c5\u8f6f\u4ef6\u5230 <code>/home</code> \u5916\u7684\u4f4d\u7f6e\uff1b\u5bf9\u4f7f\u7528\u975e\u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\u4e4b\u5916\u7684\u65b9\u6cd5\u5b89\u88c5\u5230 <code>/home</code> \u5916\u4f4d\u7f6e\u7684\u8f6f\u4ef6\uff0c\u7cfb\u7edf\u7ba1\u7406\u5458\u5e94\u5efa\u7acb\u53f0\u8d26</li> <li>\u5bf9\u4e8e\u5b9e\u9a8c\u5ba4\u573a\u5408\uff0c\u5728\u7cfb\u7edf\u76ee\u5f55\u5185\u8bbe\u7f6e\u6070\u5f53\u7248\u672c\u7684\u7f16\u8bd1\u548c\u5f00\u53d1\u73af\u5883\uff0c\u5e76\u5bf9\u6709\u989d\u5916\u9700\u6c42\u7684\u7528\u6237\u7684\u63d0\u4f9b\u5728\u5bb6\u76ee\u5f55\u8bbe\u7f6e\u5355\u72ec\u5de5\u5177\u94fe\u7684\u9002\u5f53\u6307\u5f15 <p>TODO: explain</p> </li> </ul>"},{"location":"ops/checklist/#_4","title":"\u8fdc\u7a0b\u7ba1\u7406","text":"<ul> <li>\u5bf9\u4e8e\u5e26\u6709 IPMI \u7b49\u5e26\u5916\u7ba1\u7406\u529f\u80fd\u7684\u670d\u52a1\u5668\uff0c\u5c06\u5176\u542f\u7528\uff0c\u5e76\u914d\u7f6e\u56fa\u5b9a IP \u5730\u5740\u548c\u5b89\u5168\u7684\u5bc6\u7801\u540e\u63a5\u5165\u7f51\u7edc <p>\u6b63\u786e\u914d\u7f6e\u7684 IPMI \u529f\u80fd\u5c06\u4e3a\u670d\u52a1\u5668\u5d29\u6e83\u7b49\u65e0\u6cd5\u6b63\u5e38\u767b\u5f55\u8fdb\u5165\u670d\u52a1\u5668\u7684\u60c5\u51b5\u4e0b\u7684\u91cd\u542f\u64cd\u4f5c\u63d0\u4f9b\u65b9\u4fbf\uff0c\u53ef\u63d0\u5347\u5982\u5047\u671f\u7b49\u60c5\u51b5\u4e0b\u7684\u670d\u52a1\u5668\u53ef\u9760\u6027\u3002</p> </li> <li>\u6b63\u786e\u8bbe\u7f6e SSH\uff0c\u5e76\u4f5c\u4e3a\u8fdc\u7a0b\u7ba1\u7406\u7684\u4e3b\u8981\u624b\u6bb5 <p>TODO: add ref to ssh &amp; explain</p> </li> </ul>"},{"location":"ops/checklist/#_5","title":"\u7cfb\u7edf\u5b89\u5168","text":"<ul> <li>\u662f\u5426\u6240\u6709\u7528\u6237\u90fd\uff08\u6216\u8005\u81f3\u5c11 root \u53ca\u6709 sudo \u6743\u9650\u7684\u7528\u6237\uff09\u5177\u6709\u5f3a\u5bc6\u7801\uff1f</li> <li>SSH \u7684\u5bc6\u7801\u767b\u5f55\u662f\u5426\u5df2\u7981\u7528\uff1f\uff08<code>PasswordAuthentication no</code>\uff09<ul> <li>\u5982\u679c\u6709\u4efb\u4f55\u539f\u56e0\u9700\u8981\u542f\u7528\u5bc6\u7801\u767b\u5f55\uff0c\u662f\u5426\u5df2\u7981\u7528 root \u7528\u6237\u7684\u5bc6\u7801\u767b\u5f55\uff1f\uff08<code>PermitRootLogin prohibit-password</code>\uff09</li> <li>\u6216\u8005\uff0c\u4ec5\u5bf9\u6709\u9700\u8981\u7684\u7528\u6237\u542f\u7528\u5bc6\u7801\u767b\u5f55\uff1f\uff08<code>Match user &lt;username&gt;</code>\u3001<code>PasswordAuthentication yes</code>\uff09</li> </ul> </li> </ul>"},{"location":"ops/checklist/#_6","title":"\u7f51\u7edc\u5b89\u5168","text":"<ul> <li>MySQL\u3001PostgreSQL\u3001Redis \u7b49\u6570\u636e\u5e93\u670d\u52a1\u662f\u5426\u53ea\u76d1\u542c\u4e86\u672c\u5730\u5730\u5740\uff1f<ul> <li>\u6216\u8005\uff0c\u5df2\u7ecf\u914d\u7f6e\u4e86\u5916\u90e8\u9632\u706b\u5899\u963b\u65ad\u76f8\u5173\u7aef\u53e3\u7684\u5165\u7ad9\u8fde\u63a5\uff1f\uff08MySQL: 3306\uff0cPostgreSQL: 5432\uff0cRedis: 6379\uff09</li> </ul> </li> </ul>"},{"location":"ops/network/","title":"\u7f51\u7edc\u7cfb\u7edf","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p>"},{"location":"ops/network/#_2","title":"\u8def\u7531","text":""},{"location":"ops/package/","title":"\u5305\u7ba1\u7406\u5668","text":"<p>Debian / Ubuntu \u4f7f\u7528\u7684\u5305\u7ba1\u7406\u7cfb\u7edf\u662f\u7531 Debian \u5f00\u53d1\u7684 Debian \u8f6f\u4ef6\u5305\u7ba1\u7406\u7cfb\u7edf\uff08dpkg\uff09\u548c\u7531 Ubuntu \u5f00\u53d1\u7684\u9ad8\u7ea7\u5305\u88c5\u5de5\u5177\uff08Advanced Packing Tool\uff0cAPT\uff09\u3002<code>dpkg</code> \u548c <code>apt</code> \u90fd\u662f\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u4f46\u662f\u53e6\u6709 aptitude \u548c synaptic \u7b49\u56fe\u5f62\u754c\u9762\u5de5\u5177\u53ef\u4ee5\u4f7f\u7528\u3002</p> <p>APT \u548c dpkg \u7684\u5206\u5de5\u5927\u81f4\u5982\u4e0b\uff1a</p> <ul> <li>dpkg \u8d1f\u8d23\u76f4\u63a5\u64cd\u4f5c\u8f6f\u4ef6\u5305\uff0c\u5982\u5b89\u88c5\u3001\u5378\u8f7d\u3001\u8fd0\u884c\u914d\u7f6e\u811a\u672c\u7b49\uff0c\u540c\u65f6\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u5904\u7406\u8f6f\u4ef6\u5305\u7684\u4f9d\u8d56\u5173\u7cfb\u3002</li> <li>APT \u8d1f\u8d23\u7ba1\u7406\u8f6f\u4ef6\u5305\uff0c\u5982\u66f4\u65b0\u548c\u7ef4\u62a4\u4ed3\u5e93\uff08\u5373\u8f6f\u4ef6\u5305\u7684\u6e90\uff09\u3001\u4e0b\u8f7d\u8f6f\u4ef6\u5305\u3001\u89e3\u51b3\u4f9d\u8d56\u5173\u7cfb\u3001\u63d0\u4f9b\u641c\u7d22\u548c\u67e5\u8be2\u529f\u80fd\u7b49\u3002APT \u5728\u5206\u6790\u8f6f\u4ef6\u5305\u4f9d\u8d56\u5e76\u4e0b\u8f7d\u8f6f\u4ef6\u5305\u540e\uff0c\u4f1a\u8c03\u7528 dpkg \u5b8c\u6210\u5269\u4e0b\u7684\u5de5\u4f5c\u3002</li> </ul>"},{"location":"ops/service/","title":"\u670d\u52a1\u4e0e\u65e5\u5fd7\u7ba1\u7406","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u73b0\u4ee3\u7684 Linux \u53d1\u884c\u7248\u90fd\u4f7f\u7528 systemd \u6765\u7ba1\u7406\u7cfb\u7edf\u670d\u52a1\uff0c\u56e0\u6b64\u672c\u6587\u4e3b\u8981\u4ecb\u7ecd systemd \u73af\u5883\u4e0b\u7684\u670d\u52a1\u4e0e\u65e5\u5fd7\u7ba1\u7406\uff0cGentoo \u7528\u6237\u8bf7\u7ed5\u9053\u3002</p> <p>\u65e9\u671f\uff082014 \u5e74\u4ee5\u524d\uff09\u8fd8\u6709 SysVinit \u548c Upstart \u7b49\uff0c\u4f46\u73b0\u5728\u5df2\u7ecf\u5f88\u5c11\u89c1\u4e86\u3002SysVinit \u8fd8\u6709\u4e00\u4e2a\u73b0\u4ee3\u5316\u7684\u66ff\u4ee3\u54c1\uff0c\u53eb\u505a OpenRC\u3002</p>"},{"location":"ops/service/#init","title":"Init","text":"<p>Init \u8fdb\u7a0b\u662f Linux \u542f\u52a8\u65f6\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u8d1f\u8d23\u542f\u52a8\u7cfb\u7edf\u7684\u5404\u79cd\u670d\u52a1\u5e76\u6700\u7ec8\u542f\u52a8 shell\u3002\u4f20\u7edf\u7684 init \u7a0b\u5e8f\u4f4d\u4e8e <code>/sbin/init</code>\uff0c\u800c\u73b0\u4ee3\u53d1\u884c\u7248\u4e2d\u5b83\u4e00\u822c\u662f\u6307\u5411 <code>/lib/systemd/systemd</code> \u7684\u8f6f\u94fe\u63a5\uff0c\u5373\u7531 systemd \u4f5c\u4e3a PID 1 \u8fd0\u884c\u3002</p> <p>PID 1 \u5728 Linux \u4e2d\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u5730\u4f4d\uff1a</p> <ul> <li>\u4e0d\u53d7 <code>SIGKILL</code> \u6216 <code>SIGSTOP</code> \u4fe1\u53f7\u5f71\u54cd\uff0c\u4e0d\u80fd\u88ab\u6740\u6b7b\u6216\u6682\u505c\u3002\u7c7b\u4f3c\u5730\uff0c\u5373\u4f7f\u6536\u5230\u4e86\u5176\u4ed6\u672a\u6ce8\u518c\u7684\u4fe1\u53f7\uff0c\u9ed8\u8ba4\u884c\u4e3a\u4e5f\u662f\u5ffd\u7565\uff0c\u800c\u4e0d\u662f\u7ed3\u675f\u8fdb\u7a0b\u6216\u6302\u8d77\u3002</li> <li>\u5f53\u5176\u4ed6\u8fdb\u7a0b\u9000\u51fa\u65f6\uff0c\u8fd9\u4e9b\u8fdb\u7a0b\u7684\u5b50\u8fdb\u7a0b\u4f1a\u7531 PID 1 \u63a5\u7ba1\uff0c\u56e0\u6b64 PID 1 \u9700\u8981\u8d1f\u8d23\u56de\u6536\uff08<code>wait(2)</code>\uff09\u8fd9\u4e9b\u50f5\u5c38\u8fdb\u7a0b\u3002</li> </ul>"},{"location":"ops/service/#systemd","title":"Systemd \u4e0e\u670d\u52a1","text":"<p>Systemd \u662f\u4e00\u5927\u5768\u8f6f\u4ef6\uff0c\u5305\u62ec\u670d\u52a1\u7ba1\u7406\uff08PID 1\uff09\u3001\u65e5\u5fd7\u7ba1\u7406\uff08systemd-journald\uff09\u3001\u7f51\u7edc\u7ba1\u7406\uff08systemd-networkd\uff09\u3001\u672c\u5730 DNS \u7f13\u5b58\uff08systemd-resolved\uff09\u3001\u65f6\u95f4\u540c\u6b65\uff08systemd-timesyncd\uff09\u7b49\uff0c\u672c\u6587\u4e3b\u8981\u5173\u5fc3\u670d\u52a1\u7ba1\u7406\u548c\u65e5\u5fd7\u7ba1\u7406\u3002</p>"},{"location":"ops/service/#unit","title":"Unit","text":"<p>\u5728 systemd \u4e2d\uff0c\u8fd0\u884c\u4e00\u4e2a\u5b8c\u6574\u7cfb\u7edf\u6240\u9700\u7684\u6bcf\u4e2a\u90e8\u4ef6\u90fd\u4f5c\u4e3a\u201c\u5355\u5143\u201d\uff08unit\uff09\u7ba1\u7406\u3002\u4e00\u4e2a unit \u53ef\u4ee5\u662f\u670d\u52a1\uff08<code>.service</code>\uff09\u3001\u6302\u8f7d\u70b9\uff08<code>.mount</code>\uff09\u3001\u8bbe\u5907\uff08<code>.device</code>\uff09\u3001\u5b9a\u65f6\u5668\uff08<code>.timer</code>\uff09\u4ee5\u81f3\u4e8e\u76ee\u6807\uff08<code>.target</code>\uff09\u7b49\uff0c\u5b8c\u6574\u7684\u5217\u8868\u53ef\u4ee5\u5728 <code>systemd.unit(5)</code> \u4e2d\u627e\u5230\u3002</p> <pre><code>graph TD\nU(unit) --&gt; A(service)\nU --&gt; B(mount)\nU --&gt; C(device)\nU --&gt; D(target)\nU --&gt; E(slice)\nU --&gt; F(scope)</code></pre> <p>Systemd unit \u7684\u914d\u7f6e\u6587\u4ef6\u4e3b\u8981\u4ece\u4ee5\u4e0b\u76ee\u5f55\u6309\u987a\u5e8f\u8f7d\u5165\uff0c\u5176\u4e2d\u540c\u540d\u7684\u6587\u4ef6\u53ea\u53d6\u627e\u5230\u7684\u7b2c\u4e00\u4e2a\uff1a</p> <ul> <li><code>/etc/systemd/system</code>\uff1a\u672c\u5730\u914d\u7f6e\u6587\u4ef6\uff0c\u4f18\u5148\u7ea7\u6700\u9ad8\uff0c\u8fd9\u4e5f\u662f\u552f\u4e00\u4e00\u4e2a\u7ba1\u7406\u5458\u53ef\u4ee5\u624b\u52a8\u4fee\u6539\u6587\u4ef6\u7684\u5730\u65b9\u3002</li> <li><code>/run/systemd/system</code>\uff1a\u8fd0\u884c\u65f6\u76ee\u5f55\uff0c\u5b58\u653e\u7531 systemd \u6216\u5176\u4ed6\u7a0b\u5e8f\u52a8\u6001\u521b\u5efa\u7684 unit\u3002\u6ce8\u610f <code>/run</code> \u76ee\u5f55\u91cd\u542f\u540e\u4f1a\u88ab\u6e05\u7a7a\u3002</li> <li><code>/usr/lib/systemd/system</code>\uff1a\u7cfb\u7edf\u914d\u7f6e\u6587\u4ef6\uff0c\u4f18\u5148\u7ea7\u6700\u4f4e\uff0c\u4e00\u822c\u7531\u53d1\u884c\u7248\uff08\u8f6f\u4ef6\u5305\u7ba1\u7406\u5668\uff09\u63d0\u4f9b\u3002</li> </ul> <p>\u5b9e\u9645\u4f1a\u641c\u7d22\u7684\u76ee\u5f55\u6bd4\u8fd9\u591a\u5f97\u591a\uff08\u53c8\u5230\u4e86\u770b man \u7684\u65f6\u5019\u4e86\uff09\uff0c\u4f46\u662f\u4e00\u822c\u53ea\u9700\u8981\u5173\u5fc3\u4e0a\u9762\u8fd9\u4e09\u4e2a\u3002</p> <p>\u5f88\u591a\u901a\u8fc7 <code>systemctl</code> \u547d\u4ee4\u6539\u53d8\u7684\u914d\u7f6e\u90fd\u4f1a\u88ab\u4fdd\u5b58\u5230 <code>/etc/systemd/system</code> \u76ee\u5f55\u4e0b\uff0c\u4f8b\u5982\uff1a</p> <ul> <li><code>systemctl enable [some-unit]</code> \u672c\u8d28\u4e0a\u662f\u5728 <code>/etc/systemd/system</code> \u76ee\u5f55\u4e0b\u521b\u5efa\u8f6f\u94fe\u63a5\u3002</li> <li><code>systemctl disable [some-unit]</code> \u5219\u662f\u5220\u9664\u4e0a\u9762\u521b\u5efa\u7684\u8f6f\u94fe\u63a5\u3002</li> <li><code>systemctl edit [some-unit]</code> \u4f1a\u63d0\u4f9b\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\uff0c\u5e76\u5728\u7f16\u8f91\u5b8c\u4e4b\u540e\u5c06\u5176\u4fdd\u5b58\u5230 <code>/etc/systemd/system/[some-unit].d/override.conf</code> \u6587\u4ef6\u4e2d\uff0c\u5b9e\u73b0\u5bf9 unit \u7684\u4fee\u6539\u3002</li> </ul> <p>\u76f8\u6bd4\u4e8e\u624b\u5de5\u4fee\u6539\u6587\u4ef6\uff0c\u4f7f\u7528 <code>systemctl</code> \u66f4\u52a0\u5b89\u5168\uff0c\u5b83\u4f1a\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u6cd5\uff0c\u800c\u4e14\u4e0d\u9700\u8981\u518d\u989d\u5916\u8fd0\u884c <code>systemctl daemon-reload</code>\u3002</p> <p>Unit \u7684\u914d\u7f6e\u6587\u4ef6\u662f\u4e00\u4e2a INI \u683c\u5f0f\u7684\u6587\u4ef6\uff0c\u901a\u5e38\u5305\u62ec\u4e00\u4e2a <code>[Unit]</code> section\uff0c\u7136\u540e\u6839\u636e unit \u7684\u7c7b\u578b\u4e0d\u540c\u6709\u4e0d\u540c\u7684 section\u3002\u4f8b\u5982\u4e00\u4e2a\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u4f1a\u6709 <code>[Service]</code> section\uff0c\u5e76\u901a\u5e38\u4f1a\u5305\u542b\u4e00\u4e2a <code>[Install]</code> section\u3002\u4ee5 cron \u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u4f8b\uff1a</p> /lib/systemd/system/cron.service<pre><code>[Unit]\nDescription=Regular background program processing daemon\nDocumentation=man:cron(8)\nAfter=remote-fs.target nss-user-lookup.target\n\n[Service]\nEnvironmentFile=-/etc/default/cron\nExecStart=/usr/sbin/cron -f -P $EXTRA_OPTS\nIgnoreSIGPIPE=false\nKillMode=process\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"ops/service/#unit-dependency","title":"\u987a\u5e8f\u4e0e\u4f9d\u8d56","text":"<p>\u76f8\u6bd4\u4e8e SysVinit\uff08\u5b8c\u5168\u987a\u5e8f\u542f\u52a8\uff09\u548c upstart\uff08\u57fa\u4e8e event \u89e6\u53d1\u7684\u65b9\u5f0f\u6709\u9650\u7684\u5e76\u884c\uff09\uff0csystemd \u7684\u6bcf\u4e2a unit \u90fd\u660e\u786e\u6307\u5b9a\u4e86\u4f9d\u8d56\u5173\u7cfb\uff0c\u5206\u6790\u4f9d\u8d56\u5173\u7cfb\u540e systemd \u5c31\u53ef\u4ee5\u6700\u5927\u5316\u5e76\u884c\u542f\u52a8\u670d\u52a1\uff0c\u8fd9\u6837\u53ef\u4ee5\u5927\u5927\u7f29\u77ed\u542f\u52a8\u65f6\u95f4\u3002</p> <p>Systemd \u4e2d\u7684 unit \u6709\u5f88\u591a\u72b6\u6001\uff0c\u5927\u81f4\u53ef\u4ee5\u5f52\u4e3a\u4ee5\u4e0b\u51e0\u7c7b\uff1a</p> <ul> <li>inactive\uff1a\u672a\u542f\u52a8</li> <li>activating\uff1a\u6b63\u5728\u542f\u52a8</li> <li>active\uff1a\u5df2\u542f\u52a8\uff08\u6210\u529f\uff09</li> <li>deactivating\uff1a\u6b63\u5728\u505c\u6b62</li> <li>failed\uff1a\u542f\u52a8\u5931\u8d25</li> </ul> <p>\u5927\u90e8\u5206\u7cfb\u7edf unit \u90fd\u4f1a\u4f7f\u7528\u4ee5\u4e0b\u51e0\u4e2a\u5b57\u6bb5\uff1a</p> <code>Wants=</code> \u548c <code>Requires=</code> <p>\u6307\u5b9a unit \u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u4f8b\u5982\u7f51\u7edc\u670d\u52a1\u901a\u5e38\u4f1a\u4f9d\u8d56 <code>network.target</code>\uff0c\u5373\u5f53\u7f51\u7edc\u5f00\u59cb\u914d\u7f6e\u65f6\u624d\u4f1a\u8fd0\u884c\u3002 \u4e24\u8005\u90fd\u5728 <code>[Unit]</code> section \u4e2d\u6307\u5b9a\uff0c\u533a\u522b\u5728\u4e8e <code>Requires=</code> \u662f\u5f3a\u4f9d\u8d56\uff0c\u5373\u5982\u679c\u88ab\u4f9d\u8d56\u7684 unit \u6ca1\u6709\u542f\u52a8\u6216\u542f\u52a8\u5931\u8d25\uff0c\u90a3\u4e48\u5f53\u524d unit \u4e5f\u4f1a\u88ab\u6807\u8bb0\u4e3a\u5931\u8d25\uff1b \u800c <code>Wants=</code> \u662f\u5f31\u4f9d\u8d56\uff0c\u5373\u5c1d\u8bd5\u542f\u52a8\u88ab\u4f9d\u8d56\u7684 unit\uff0c\u4f46\u5982\u679c\u5931\u8d25\u4e86\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5f53\u524d unit \u7684\u542f\u52a8\u3002</p> <code>WantedBy=</code> \u548c <code>RequiredBy=</code> <p>\u4e0e\u4e0a\u9762\u4e24\u4e2a\u76f8\u53cd\uff0c\u6307\u5b9a\u4e86\u5176\u4ed6 unit \u4f9d\u8d56\u5f53\u524d unit\u3002 \u8fd9\u4e24\u4e2a\u5b57\u6bb5\u5728 <code>[Install]</code> section \u4e2d\u6307\u5b9a\uff0c\u5e76\u4e14\u4ec5\u5f53\u5bf9\u5e94\u7684 unit \u88ab\u542f\u7528\uff08<code>systemctl enable</code>\uff09\u65f6\u624d\u4f1a\u751f\u6548\u3002</p> <code>Before=</code> \u548c <code>After=</code> <p>\u6307\u5b9a\u542f\u52a8\u987a\u5e8f\uff0c\u5373\u76f8\u5173\u7684 unit \u9700\u8981\u5728\u524d\u8005\u542f\u52a8\u5b8c\u6210\uff0c\u8fdb\u5165 active \u72b6\u6001\u540e\u624d\u4f1a\u5c1d\u8bd5\u542f\u52a8\u3002\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u5728 <code>[Unit]</code> section \u4e2d\u6307\u5b9a\u3002 \u4e0e Wants/Requires \u4e0d\u540c\uff0cBefore/After \u53ea\u662f\u6307\u5b9a\u542f\u52a8\u987a\u5e8f\uff0c\u4e0d\u5f71\u54cd\u4f9d\u8d56\u5173\u7cfb\u3002</p>"},{"location":"ops/service/#target","title":"Target","text":"<p>Target \u662f\u4e00\u7ec4\u670d\u52a1\uff08\u5176\u4ed6 unit\uff09\u7684\u96c6\u5408\uff0c\u901a\u8fc7 target \u8fd9\u6837\u4e00\u5c42\u62bd\u8c61\u53ef\u4ee5\u66f4\u65b9\u4fbf\u5730\u7ba1\u7406\u670d\u52a1\u7684\u542f\u52a8\u987a\u5e8f\uff0c\u7c7b\u4f3c SysVinit \u4e2d\u7684 runlevel\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u201c\u7cfb\u7edf\u542f\u52a8\u76ee\u6807\u201d\u3002 \u4f8b\u5982\u7f51\u7edc\u670d\u52a1\u5e94\u8be5 <code>Requires=network-online.target</code> \u5e76\u4e14 <code>After=network-online.target</code>\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u7f51\u7edc\u670d\u52a1\u5728\u7f51\u7edc\u8fde\u901a\u540e\u518d\u542f\u52a8\u3002</p> <p>Systemd \u5728\u5f00\u673a\u65f6\u4f1a\u5c1d\u8bd5\u542f\u52a8 default.target\uff0c\u8fd9\u4e2a target \u4e00\u822c\u662f\u6307\u5411 graphical.target \u7684\u8f6f\u94fe\u63a5\uff0c\u5373\u542f\u52a8\u56fe\u5f62\u754c\u9762\u76f8\u5173\u7684\u670d\u52a1\uff0c\u53e6\u4e00\u4e2a\u5e38\u89c1\u7684 multi-user.target \u5219\u662f\u547d\u4ee4\u884c\u6a21\u5f0f\u3002</p> systemd target SysVinit runlevel \u8bf4\u660e poweroff.target 0 \u5173\u673a rescue.target 1 \u5355\u7528\u6237\u6a21\u5f0f \uff08\u65e0\uff09 2 \uff08systemd \u4e0d\u4f7f\u7528\u8fd9\u4e2a runlevel\uff09 multi-user.target 3 \u591a\u7528\u6237\u6a21\u5f0f\uff0c\u4f46\u53ea\u6709\u547d\u4ee4\u884c \uff08\u65e0\uff09 4 \uff08systemd \u4e0d\u4f7f\u7528\u8fd9\u4e2a runlevel\uff09 graphical.target 5 \u56fe\u5f62\u754c\u9762 reboot.target 6 \u91cd\u542f emergency.target S \u7d27\u6025\u6a21\u5f0f halt.target \uff08\u65e0\uff09 \u7cfb\u7edf\u5df2\u7ecf\u505c\u6b62\uff0c\u4f46\u662f\u65e2\u4e0d\u65ad\u7535\u4e5f\u4e0d\u91cd\u542f\uff0c\u53ef\u4ee5\u770b\u5230\u5173\u673a\u65e5\u5fd7 <p>\u9ed8\u8ba4\u7684 target \u53ef\u4ee5\u901a\u8fc7 <code>systemctl set-default</code> \u547d\u4ee4\u4fee\u6539\uff0c\u6216\u8005\u5728 GRUB \u4e2d\u4e3a kernel cmdline \u6307\u5b9a <code>systemd.unit=</code>\u3002 \u4e0e\u5176\u4ed6 <code>systemctl</code> \u547d\u4ee4\u4e00\u6837\uff0c\u524d\u8005\u7684\u672c\u8d28\u662f\u521b\u5efa\u4e00\u4e2a\u8f6f\u94fe\u63a5 <code>/etc/systemd/system/default.target</code>\u3002</p>"},{"location":"ops/service/#service","title":"Service","text":"<p>Service \u4e5f\u5c31\u662f\u6211\u4eec\u6700\u5e38\u89c1\u7684\u670d\u52a1\uff0c\u5b83\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6709\u4e00\u4e2a <code>[Service]</code> section\uff0c\u5305\u62ec\u4e86\u670d\u52a1\u7684\u542f\u52a8\u547d\u4ee4\u548c\u4e00\u7cfb\u5217\u5176\u4ed6\u914d\u7f6e\u3002\u4ee5\u4e0a\u9762\u7684 cron \u670d\u52a1\u4e3a\u4f8b\uff1a</p> <ul> <li><code>[Unit]</code> \u90e8\u5206\u6307\u5b9a\u7684 <code>After=remote-fs.target nss-user-lookup.target</code> \u8868\u793a cron \u4f1a\u5728\u7cfb\u7edf\u8fbe\u5230\u8fd9\u4e24\u4e2a target \u4e4b\u540e\u624d\u542f\u52a8\uff0c\u5373\u8fdc\u7a0b\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u5b8c\u6210\u548c\u7528\u6237\u4fe1\u606f\u670d\u52a1\uff08<code>getent passwd</code> \u7b49\u547d\u4ee4\u53ef\u7528\uff09\u90fd\u5df2\u7ecf\u542f\u52a8\u3002</li> <li><code>EnvironmentFile=-/etc/default/cron</code> \u8868\u793a\u4f1a\u8bfb\u53d6 <code>/etc/default/cron</code> \u6587\u4ef6\u4e2d\u7684\u73af\u5883\u53d8\u91cf\u3002\u5f00\u5934\u7684 <code>-</code> \u8868\u793a\u5982\u679c\u8fd9\u4e2a\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u5219\u76f4\u63a5\u5ffd\u7565\u3002</li> <li> <p><code>ExecStart=/usr/sbin/cron -f -P $EXTRA_OPTS</code> \u6307\u5b9a\u4e86\u670d\u52a1\u7684\u542f\u52a8\u547d\u4ee4\uff0c\u5176\u4e2d <code>$EXTRA_OPTS</code> \u662f\u4ece\u4e0a\u9762\u7684\u6587\u4ef6\u4e2d\u8bfb\u53d6\u7684\u73af\u5883\u53d8\u91cf\u3002</p> <p>Tip</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u5efa\u8bae\u5bf9\u547d\u4ee4\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u56e0\u4e3a systemd \u542f\u52a8\u670d\u52a1\u65f6\u5e76\u4e0d\u4f1a\u4f7f\u7528\u7cfb\u7edf\u914d\u7f6e\u7684 <code>$PATH</code> \u73af\u5883\u53d8\u91cf\uff0c\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u786c\u7f16\u7801\u7684\u5217\u8868\u3002</p> </li> <li> <p><code>Restart=on-failure</code> \u8868\u793a\u670d\u52a1\u5728\u5931\u8d25\u65f6\u4f1a\u81ea\u52a8\u91cd\u542f\u3002<code>Restart=</code> \u7684\u53d6\u503c\u548c\u542b\u4e49\u53ef\u4ee5\u5728 systemd.service \u6587\u6863\u4e2d\u627e\u5230\u3002</p> </li> <li>\u6700\u540e\u7684 <code>[Install]</code> \u90e8\u5206\u6307\u5b9a\u4e86\u670d\u52a1\u7684\u542f\u52a8\u7ea7\u522b\uff0c\u5373 <code>WantedBy=multi-user.target</code> \u8868\u793a\u5728\u591a\u7528\u6237\u6a21\u5f0f\u4e0b\u542f\u52a8\u3002</li> </ul> <p>\u5176\u4ed6\u5e38\u7528\u7684\u914d\u7f6e\u8fd8\u6709\uff1a</p> <code>ExecStartPre=</code>\u3001<code>ExecStartPost=</code>\u3001<code>ExecStopPost=</code> <p>\u5728\u670d\u52a1\u542f\u52a8\u524d\u3001\u542f\u52a8\u540e\u3001\u505c\u6b62\u540e\u6267\u884c\u7684\u547d\u4ee4\u3002\u53ef\u7528\u4e8e\u68c0\u67e5\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u786e\u3001\u521b\u5efa\u4e34\u65f6\u6587\u4ef6\u3001\u6e05\u7406\u4e34\u65f6\u6587\u4ef6\u7b49\u3002\u4f8b\u5982 ssh.service \u5c31\u4f1a\u4f7f\u7528 <code>ExecStartPre=/usr/sbin/sshd -t</code> \u6765\u68c0\u67e5\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u786e\u3002</p> <code>ExecReload=</code> <p>\u6307\u5b9a\u91cd\u8f7d\u670d\u52a1\u7684\u547d\u4ee4\uff0c\u4e00\u4e2a\u5e38\u89c1\u7684\u505a\u6cd5\u662f <code>ExecReload=/bin/kill -HUP $MAINPID</code>\u3002 \u914d\u7f6e\u4e86 <code>ExecReload=</code> \u4e4b\u540e\u5373\u53ef\u4f7f\u7528 <code>systemctl reload [service]</code> \u547d\u4ee4\u6765\u5411\u670d\u52a1\u7684\u4e3b\u8fdb\u7a0b\u53d1\u9001 SIGHUP \u4fe1\u53f7\u3002\u4e00\u4e9b\u670d\u52a1\u8fd8\u6709\u81ea\u5df1\u7684 reload \u547d\u4ee4\uff0c\u4f8b\u5982 nginx \u7684 <code>ExecReload=/usr/sbin/nginx -s reload</code>\u3002</p> <code>Type=</code> <p>\u6307\u5b9a\u670d\u52a1\u7684\u7c7b\u578b\u3002\u5927\u90e8\u5206\u670d\u52a1\u90fd\u7531\u4e00\u4e2a\u5728\u540e\u53f0\u8fd0\u884c\u7684\u8fdb\u7a0b\u7ec4\u6210\uff0c\u6b64\u65f6\u53ef\u4ee5\u7701\u7565 Type \u4f7f\u7528\u9ed8\u8ba4\u503c <code>simple</code>\uff0c\u6216\u8005\u66f4\u63a8\u8350\u7684\u505a\u6cd5\u662f <code>Type=exec</code>\u3002\u5176\u4ed6\u7684\u670d\u52a1\u7c7b\u578b\u53c2\u89c1\u4e0b\u9762\u7684 Service Type \u4e00\u8282\u3002</p> <code>User=</code>\u3001<code>Group=</code> \u548c <code>SupplementaryGroups=</code> <p>\u6307\u5b9a\u8fd0\u884c\u670d\u52a1\u7684\u7528\u6237\u548c\u7ec4\uff0c\u4ee5\u53ca\u989d\u5916\u7684\u9644\u52a0\u7ec4\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u670d\u52a1\u4f1a\u4ee5 <code>root</code> \u7528\u6237\u8fd0\u884c\uff0c\u5982\u679c\u6709\u5b89\u5168\u548c\u6743\u9650\u7ba1\u7406\u7684\u9700\u6c42\uff0c\u90a3\u4e48\u4f60\u5e94\u8be5\u914d\u7f6e\u8fd9\u51e0\u9879\u8bbe\u7f6e\u3002</p> <p>Tip</p> <p>\u5982\u679c\u4f60\u6709\u989d\u5916\u7684\u5b89\u5168\u9700\u6c42\uff0c\u53ef\u4ee5\u53c2\u8003 Sandboxing \u4e00\u8282\u4f7f\u7528 systemd \u63d0\u4f9b\u7684\u9ad8\u7ea7\u9694\u79bb\u529f\u80fd\u3002</p>"},{"location":"ops/service/#service-type","title":"Service Type","text":"simple \u548c exec <p>\u662f\u6700\u5e38\u89c1\u7684\u670d\u52a1\u7c7b\u578b\uff0c\u670d\u52a1\u4e3b\u4f53\u662f\u4e00\u4e2a\u957f\u671f\u8fd0\u884c\u7684\u8fdb\u7a0b\u3002 \u4e24\u8005\u7684\u533a\u522b\u5728\u4e8e <code>simple</code> \u7c7b\u578b\u201c\u542f\u52a8\u5373\u6210\u529f\u201d\uff0c\u5373 <code>systemctl start</code> \u4f1a\u7acb\u523b\u6210\u529f\u9000\u51fa\uff1b \u800c <code>exec</code> \u7c7b\u578b\u4f1a\u786e\u4fdd <code>ExecStart=</code> \u547d\u4ee4\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff0c\u5305\u62ec <code>User=</code> \u548c <code>Group=</code> \u5b58\u5728\u3001\u6240\u6307\u5b9a\u7684\u547d\u4ee4\u5b58\u5728\u4e14\u53ef\u6267\u884c\u7b49\u3002 \u56e0\u6b64\u73b0\u4ee3\u7684\u670d\u52a1\u5e94\u8be5\u5c3d\u91cf\u4f7f\u7528 <code>Type=exec</code>\u3002</p> forking <p>\u4e00\u4e9b\u4f20\u7edf\u7684\u670d\u52a1\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u542f\u52a8\u547d\u4ee4\u4f1a fork \u51fa\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u7136\u540e\u9000\u51fa\uff0c\u5b9e\u9645\u670d\u52a1\u7531\u8fd9\u4e2a\u5b50\u8fdb\u7a0b\u63d0\u4f9b\u3002 \u8fd9\u79cd\u670d\u52a1\u9700\u8981\u914d\u7f6e <code>PIDFile=</code>\uff0c\u4ee5\u4fbf systemd \u80fd\u591f\u6b63\u786e\u8ffd\u8e2a\u670d\u52a1\u7684\u4e3b\u8fdb\u7a0b\u3002\u5f53 <code>PIDFile=</code> \u6307\u5b9a\u7684\u6587\u4ef6\u5b58\u5728\u4e14\u5305\u542b\u4e00\u4e2a\u6709\u6548\u7684 PID \u65f6\uff0csystemd \u8ba4\u4e3a\u670d\u52a1\u5df2\u7ecf\u542f\u52a8\u6210\u529f\u3002</p> oneshot <p>\u4e00\u6b21\u6027\u670d\u52a1\uff0c\u5373\u542f\u52a8\u540e\u8fd0\u884c\u4e00\u6b21 <code>ExecStart=</code> \u547d\u4ee4\uff0c\u7136\u540e\u9000\u51fa\u3002 \u8fd9\u4e2a Type \u6709\u4e24\u79cd\u4f7f\u7528\u573a\u666f\uff1a</p> <ol> <li>\u4e00\u6b21\u6027\u7684\u521d\u59cb\u5316\u6216\u8005\u6e05\u7406\u5de5\u4f5c\u3001\u6216\u8005\u6539\u53d8\u7cfb\u7edf\u72b6\u6001\u7684\u547d\u4ee4\u7b49\uff08\u5982\u4e00\u4e9b <code>ip</code> \u547d\u4ee4\uff09\uff1b</li> <li>\u548c timer \u914d\u5408\u4f7f\u7528\uff0c\u5373\u5b9a\u65f6\u4efb\u52a1\u3002</li> </ol> <p>\u5982\u679c\u4f60\u6709 Type=oneshot \u7684\u670d\u52a1\uff0c\u90a3\u4e48\u4f60\u5f88\u53ef\u80fd\u4e5f\u60f3\u914d\u7f6e <code>RemainAfterExit=yes</code>\uff0c\u8fd9\u6837\u914d\u7f6e\u7684\u547d\u4ee4\u6267\u884c\u5b8c\u6210\u540e\u4f1a\u4e00\u76f4\u4fdd\u6301 active \u72b6\u6001\u3002</p> notify \u548c dbus <p>\u7c7b\u4f3c <code>simple</code> \u548c <code>exec</code>\uff0c\u4f46\u662f\u670d\u52a1\u4f1a\u5728\u542f\u52a8\u5b8c\u6210\u540e\u4e3b\u52a8\u901a\u77e5 systemd\u3002 \u4e0e\u524d\u9762\u7684\u7c7b\u578b\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u7c7b\u670d\u52a1\u9700\u8981\u7a0b\u5e8f\u4e3b\u52a8\u652f\u6301 <code>sd_notify</code> \u6216\u8005 D-Bus \u63a5\u53e3\u3002</p>"},{"location":"ops/service/#timers","title":"\u5b9a\u65f6\u4efb\u52a1","text":"<p>Systemd \u63d0\u4f9b\u4e86 timer \u7c7b\u578b\u7684 unit\uff0c\u7528\u4e8e\u5b9a\u65f6\u6267\u884c\u4efb\u52a1\u3002\u4e00\u4e2a timer unit \u901a\u5e38\u4f1a\u5bf9\u5e94\u4e00\u4e2a service unit\uff0c\u5373\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u70b9\u6216\u8005\u65f6\u95f4\u95f4\u9694\u89e6\u53d1 service \u7684\u542f\u52a8\u3002</p> <p>\u76f8\u6bd4\u4e8e\u66f4\u5e38\u89c1\u7684\u5b9a\u65f6\u4efb\u52a1\u65b9\u6848 CRON\uff0csystemd timers \u5177\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a</p> <ul> <li> <p>\u66f4\u4e30\u5bcc\u7684\u65f6\u95f4\u8868\u8fbe\u5f0f\uff0c\u9664\u4e86\u7b49\u4ef7\u4e8e crontab \u7684 <code>OnCalendar=</code> \u65f6\u95f4\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>OnUnitActiveSec=</code>\uff08\u670d\u52a1\u542f\u52a8\u540e\uff09\u3001<code>OnBootSec=</code>\uff08\u7cfb\u7edf\u542f\u52a8\u540e\uff09\u7b49\u6307\u5b9a\u5176\u4ed6\u65f6\u95f4\u8ba1\u7b97\u65b9\u5f0f\u3002</p> <ul> <li> <p>\u4f8b\u5982\uff0c<code>systemd-tmpfiles-clean.timer</code> \u5c31\u662f\u5728\u7cfb\u7edf\u542f\u52a8\u540e 15 \u5206\u949f\u89e6\u53d1\u4e00\u6b21 <code>systemd-tmpfiles-clean.service</code>\uff0c\u7136\u540e\u6bcf\u5929\u89e6\u53d1\u4e00\u6b21\uff0c\u7528\u4e8e\u6e05\u7406\u4e34\u65f6\u6587\u4ef6\u3002</p> /lib/systemd/system/systemd-tmpfiles-clean.timer<pre><code>[Timer]\nOnBootSec=15min\nOnUnitActiveSec=1d\n</code></pre> </li> </ul> </li> <li> <p>\u66f4\u52a0\u7cbe\u786e\u7684\u65f6\u95f4\u63a7\u5236\uff0c\u901a\u8fc7 <code>AccuracySec=</code> \u53ef\u4ee5\u652f\u6301\u79d2\u7ea7\u751a\u81f3\u66f4\u7ec6\u7684\u65f6\u95f4\u7cbe\u5ea6\u3002     \u4e00\u822c\u4e0d\u63a8\u8350\u5c0f\u4e8e 1 \u5206\u949f\u7684\u65f6\u95f4\u7cbe\u5ea6\uff0c\u5426\u5219\u7cfb\u7edf\u8ba1\u65f6\u5668\u9700\u8981\u9891\u7e41\u5524\u9192\uff0c\u53ef\u80fd\u4f1a\u5f71\u54cd\u7cfb\u7edf\u6027\u80fd\u3002</p> </li> <li><code>RandomizedDelaySec=</code> \u53ef\u4ee5\u914d\u7f6e\u6bcf\u6b21\u89e6\u53d1\u65f6\u968f\u673a\u5ef6\u8fdf\u7684\u65f6\u95f4\uff0c\u907f\u514d\u5927\u91cf\u670d\u52a1\u5728\u540c\u4e00\u65f6\u95f4\u70b9\u542f\u52a8\u3002     \u8fd9\u5728\u4f7f\u7528\u540c\u4e00\u4efd\u7cfb\u7edf\u955c\u50cf\u90e8\u7f72\u5927\u91cf\u865a\u62df\u673a\u6216\u7c7b\u4f3c\u573a\u666f\u4e0b\u975e\u5e38\u6709\u7528\uff0c\u53ef\u4ee5\u907f\u514d\u5927\u91cf\u8ba1\u5212\u4efb\u52a1\u540c\u65f6\u89e6\u53d1\uff0c\u5bfc\u81f4\u7cfb\u7edf\u8d1f\u8f7d\u8fc7\u9ad8\u3002</li> <li><code>Persistent=</code> \u53ef\u4ee5\u786e\u4fdd\u5982\u679c\u56e0\u5173\u673a\u3001\u91cd\u542f\u7b49\u539f\u56e0\u9519\u8fc7\u4e86\u8bbe\u5b9a\u65f6\u95f4\uff0c\u5b9a\u65f6\u4efb\u52a1\u4f1a\u5728\u4e0b\u6b21\u7cfb\u7edf\u542f\u52a8\u540e\u4f1a\u7acb\u5373\u6267\u884c\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7 <code>systemctl enable</code> \u548c <code>systemctl disable</code> \u542f\u7528\u548c\u7981\u7528\u5b9a\u65f6\u4efb\u52a1\uff0c\u800c\u65e0\u9700\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u3002     \u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>systemctl status</code> \u67e5\u770b timer \u548c service \u7684\u72b6\u6001\uff0c\u4ee5\u53ca <code>journalctl</code> \u67e5\u770b\u65e5\u5fd7\u3002</li> <li>\u57fa\u4e8e service \u800c\u4e0d\u662f\u7b80\u5355\u8fd0\u884c\u547d\u4ee4\u7684\u4f18\u70b9\uff1a<ul> <li>\u4eab\u53d7 service \u7684\u5168\u90e8\u597d\u5904\uff0c\u5982\u4f9d\u8d56\u7ba1\u7406\u3001\u73af\u5883\u53d8\u91cf\u3001\u81ea\u52a8\u91cd\u542f\u7b49\uff0c\u4e5f\u5305\u62ec\u5b89\u5168\u4e0e\u9694\u79bb\u7b49\u9ad8\u7ea7\u529f\u80fd\u3002</li> <li>\u5229\u7528 service \u5355\u5b9e\u4f8b\u7684\u7279\u6027\uff0c\u907f\u514d\u4e00\u4e2a\u4efb\u52a1\u540c\u65f6\u8fd0\u884c\u591a\u4efd\u5b9e\u4f8b\uff0c\u5373\u5f53\u4efb\u52a1\u5df2\u7ecf\u5728\u8fd0\u884c\u800c\u6ca1\u6709\u7ed3\u675f\u65f6\uff0c\u4e0d\u4f1a\u7ee7\u7eed\u542f\u52a8\u65b0\u7684\u8fdb\u7a0b\u3002\u5728 cron \u4e2d\uff0c\u8fd9\u901a\u5e38\u9700\u8981\u501f\u52a9\u989d\u5916\u7684\u5de5\u5177\u5b9e\u73b0\uff0c\u5982 <code>flock(1)</code>\u3002</li> </ul> </li> </ul> <p>Timers \u7684\u4e3b\u8981\u7f3a\u70b9\u662f\uff1a</p> <ul> <li>\u914d\u7f6e\u6587\u4ef6\u7e41\u7410\uff0c\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u81f3\u5c11\u9700\u8981\u521b\u5efa\u4e24\u4e2a\u6587\u4ef6\uff0c\u4e00\u4e2a\u662f timer unit\uff0c\u4e00\u4e2a\u662f\u5bf9\u5e94\u7684 service unit\u3002\u76f8\u6bd4\u4e8e\u5728 crontab \u4e2d\u6dfb\u52a0\u4e00\u884c\u914d\u7f6e\uff0c\u6570\u5341\u884c\u7684\u914d\u7f6e\u6587\u4ef6\u4e0d\u5f97\u4e0d\u8bf4\u590d\u6742\u3002</li> <li>\u6ca1\u6709 cron \u7684\u90ae\u4ef6\u901a\u77e5\u529f\u80fd\u3002\u4f46\u662f service \u7684\u8f93\u51fa\u53ef\u4ee5\u8bb0\u5f55\u5230\u65e5\u5fd7\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>journalctl</code> \u67e5\u770b\uff1b\u4e5f\u53ef\u4ee5\u4e3a service \u6307\u5b9a <code>StandardOutput=</code> \u548c <code>StandardError=</code> \u624b\u52a8\u91cd\u5b9a\u5411\u8f93\u51fa\u3002</li> </ul> <p>\u53e6\u5916\uff0c\u7b2c\u4e09\u65b9\u5f00\u53d1\u7684 systemd-cron \u9879\u76ee\u63d0\u4f9b\u4e86\u4e00\u4e2a cron \u7684\u66ff\u4ee3\u65b9\u6848\uff0c\u5b83\u4f7f\u7528 systemd \u7684 generator \u63a5\u53e3\u5c06 crontab \u7ffb\u8bd1\u6210 systemd timer \u548c service\uff0c\u7136\u540e\u7531 systemd \u8d1f\u8d23\u8fd9\u4e9b timer \u548c service \u7684\u89e6\u53d1\u548c\u8fd0\u884c\u3002</p>"},{"location":"ops/service/#create-timer","title":"\u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1","text":"<p>\u5982\u4e0a\u6240\u8ff0\uff0c\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u5305\u542b\u4e24\u4e2a\u6587\u4ef6\uff0c\u4e00\u4e2a\u662f timer unit\uff0c\u4e00\u4e2a\u662f\u5bf9\u5e94\u7684 service unit\u3002\u4e0b\u9762\u4ee5 certbot \u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u4f8b\uff0c\u8bf4\u660e\u5982\u4f55\u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a service\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f <code>Type=oneshot</code>\uff0c\u5e76\u4e14\u4e0d\u80fd\u4f7f\u7528 <code>RemainAfterExit=yes</code>\uff08\u4e00\u822c\u5c06\u5176\u5ffd\u7565\u5373\u53ef\uff0c\u5b83\u7684\u9ed8\u8ba4\u503c\u662f no\uff09\u3002</p> /lib/systemd/system/certbot.service<pre><code>[Unit]\nDescription=Certbot\nDocumentation=file:///usr/share/doc/python-certbot-doc/html/index.html\nDocumentation=https://certbot.eff.org/docs\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/certbot -q renew\nPrivateTmp=true\n</code></pre> <p>\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a timer\uff0c\u6307\u5b9a\u89e6\u53d1\u65f6\u95f4\uff0c\u5e76\u6309\u9700\u542f\u7528 <code>Persistent=</code>\u3002</p> /lib/systemd/system/certbot.timer<pre><code>[Unit]\nDescription=Run certbot twice daily\n\n[Timer]\nOnCalendar=*-*-* 00,12:00:00\nRandomizedDelaySec=43200\nPersistent=true\n\n[Install]\nWantedBy=timers.target\n</code></pre> <p>\u6b64\u65f6 <code>certbot.timer</code> \u4f1a\u81ea\u52a8\u89e6\u53d1\u540c\u540d\u7684 service\uff0c\u4e5f\u5c31\u662f <code>certbot.service</code>\u3002</p> <p>\u5728\u7f16\u8f91\u5b8c\u4e24\u4e2a\u6587\u4ef6\u4e4b\u540e\uff0c\u9700\u8981\u8fd0\u884c <code>systemctl daemon-reload</code> \u4f7f systemd \u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>systemctl start certbot.timer</code> \u542f\u52a8\u5b9a\u65f6\u5668\uff0c\u6216\u8005\u4f7f\u7528 <code>systemctl enable certbot.timer</code> \u8ba9\u5176\u5f00\u673a\u542f\u52a8\u3002</p>"},{"location":"ops/service/#log","title":"\u65e5\u5fd7\u7ba1\u7406","text":""},{"location":"ops/service/#systemd-journald","title":"Systemd-journald","text":"<p>Journald \u662f systemd \u5957\u4ef6\u4e2d\u8d1f\u8d23\u7ba1\u7406\u65e5\u5fd7\u7684\u90e8\u5206\u3002\u4e0e\u4f20\u7edf\u7684 <code>/var/log/*.log</code> \u6587\u4ef6\u4e0d\u540c\uff0cjournald \u80fd\u591f\u5904\u7406\u7ed3\u6784\u5316\u6570\u636e\uff08\u4f8b\u5982 KV\uff09\uff0c\u5e76\u4e14\u5c06\u65e5\u5fd7\u4ee5\u4e8c\u8fdb\u5236\u5f62\u5f0f\u4fdd\u5b58\u3002\u56e0\u6b64 systemd-journald \u7684\u65e5\u5fd7\u4e0d\u80fd\u7b80\u5355\u901a\u8fc7\u6587\u672c\u67e5\u770b\u5668\uff08<code>less</code>\u3001<code>vim</code> \u7b49\uff09\u67e5\u770b\uff0c\u9700\u8981\u901a\u8fc7 <code>journalctl</code> \u7ba1\u7406\u3002</p> <p>\u4e00\u4e9b\u5e38\u7528\u7684\u9009\u9879\u548c\u53c2\u6570\uff1a</p> \u9009\u9879 \u8bf4\u660e <code>-u [unit]</code> \u53ea\u663e\u793a\u6307\u5b9a unit \u7684\u65e5\u5fd7 <code>-e</code> \u663e\u793a\u6700\u65b0\u7684\u65e5\u5fd7\uff08\u81ea\u52a8\u5c06 less \u8df3\u8f6c\u5230\u672b\u5c3e\uff09 <code>-f</code> \u5b9e\u65f6\u67e5\u770b\u65e5\u5fd7\uff08\u7c7b\u4f3c <code>tail -f</code>\uff09 <code>-x</code> \u4e3a\u4e8b\u4ef6\u663e\u793a\u989d\u5916\u7684\u89e3\u91ca\u5185\u5bb9\uff0c\u5982\u670d\u52a1\u542f\u52a8\u3001\u505c\u6b62\u7b49 <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cjournald \u4f1a\u5c06\u65e5\u5fd7\u5b58\u50a8\u5728 <code>/var/log/journal</code> \u76ee\u5f55\u4e0b\uff0c\u5982\u679c\u8fd9\u4e2a\u76ee\u5f55\u4e0d\u5b58\u5728\u7684\u8bdd\uff0c\u5219\u4f1a\u4f7f\u7528 <code>/run/log/journal</code>\u3002\u7531\u4e8e <code>/run</code> \u76ee\u5f55\u4f7f\u7528 tmpfs\uff0c\u82e5\u914d\u7f6e\u4e0d\u5f53\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5185\u5b58\u5360\u7528\u8fc7\u9ad8\uff0c\u4e14\u91cd\u542f\u540e\u65e5\u5fd7\u4e22\u5931\u3002</p> <p>Journald \u7684\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>/etc/systemd/journald.conf</code>\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>journald.conf(5)</code> \u67e5\u770b\u6240\u6709\u7684\u914d\u7f6e\u9879\uff0cDebian \u4e5f\u4f1a\u5728\u8fd9\u4e2a\u6587\u4ef6\u5185\u4ee5\u6ce8\u91ca\u7684\u5f62\u5f0f\u63d0\u4f9b\u6240\u6709\u914d\u7f6e\u7684\u9ed8\u8ba4\u503c\u3002\u4e00\u4e9b\u5e38\u89c1\u7684\u914d\u7f6e\u9879\u6709\uff1a</p> \u914d\u7f6e\u9879 \u8bf4\u660e Storage= \u6307\u5b9a\u65e5\u5fd7\u5b58\u50a8\u65b9\u5f0f\uff0c\u53ef\u4ee5\u662f <code>auto</code>\u3001<code>volatile</code>\u3001<code>persistent</code> \u548c <code>none</code> SystemMaxUse=SystemKeepFree= \u6307\u5b9a\u7cfb\u7edf\u65e5\u5fd7\uff08<code>/var/log/journal</code>\uff09\u7684\u6700\u5927\u5360\u7528\u7a7a\u95f4\u6216\u4fdd\u8bc1\u78c1\u76d8\u7684\u7a7a\u4f59\u7a7a\u95f4 RuntimeMaxUse=RuntimeKeepFree= \u6307\u5b9a\u8fd0\u884c\u65f6\u65e5\u5fd7\uff08<code>/run/log/journal</code>\uff09\u7684\u6700\u5927\u5360\u7528\u7a7a\u95f4\u6216\u4fdd\u8bc1\u78c1\u76d8\u7684\u7a7a\u4f59\u7a7a\u95f4 MaxRetentionSec=MaxFileSec= \u6307\u5b9a\u65e5\u5fd7\u5185\u5bb9\u548c\u65e5\u5fd7\u6587\u4ef6\u7684\u6700\u5927\u4fdd\u5b58\u65f6\u95f4 <p>\u907f\u514d\u8986\u76d6\u7531\u5305\u7ba1\u7406\u5668\u7ba1\u7406\u7684\u6587\u4ef6</p> <p>\u81ea systemd v249 \u8d77\uff08Ubuntu 22.04\uff0cDebian 12 Bookworm\uff09\uff0c\u6240\u6709 <code>/etc/systemd/*.conf</code> \u6587\u4ef6\u5747\u652f\u6301 <code>*.conf.d</code> \u76ee\u5f55\uff0c\u5373\u53ef\u4ee5\u521b\u5efa <code>/etc/systemd/journald.conf.d/</code> \u76ee\u5f55\uff0c\u5e76\u5728\u5176\u4e2d\u521b\u5efa\u6587\u4ef6\u6765\u8986\u76d6\u9ed8\u8ba4\u914d\u7f6e\uff0c\u800c\u65e0\u9700\u4fee\u6539 <code>*.conf</code> \u6587\u4ef6\u672c\u8eab\uff0c\u4f7f\u7528\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u907f\u514d\u5728\u8f6f\u4ef6\u5305\u66f4\u65b0\u6216\u7cfb\u7edf\u5347\u7ea7\u65f6\u5904\u7406\u914d\u7f6e\u6587\u4ef6\u7684\u4fee\u6539\u51b2\u7a81\u3002</p> <p>\u4f8b\u5982\uff0c\u8981\u9650\u5236\u78c1\u76d8\u5360\u7528\uff08<code>/var/log/journal</code>\uff09\u4e3a 1G\uff0c\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6587\u4ef6\uff0c\u7136\u540e\u91cd\u542f <code>systemd-journald</code> \u670d\u52a1\uff1a</p> /etc/systemd/journald.conf.d/override.conf<pre><code>[Journal]\nSystemMaxUse=1G\n</code></pre> <p>\u5982\u679c\u4f60\u9700\u8981\u624b\u52a8\u6e05\u7406\u65e5\u5fd7\uff0c\u91ca\u653e\u78c1\u76d8\u7a7a\u95f4\u7684\u8bdd\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>journalctl --vacuum-size=100M</code> \u6765\u6e05\u7406\u65e5\u5fd7\uff0cjournald \u4f1a\u5220\u9664\u65e5\u5fd7\uff0c\u76f4\u5230\u78c1\u76d8\u5360\u7528\u5c0f\u4e8e 100M\u3002\u53e6\u5916\u6709\u4e24\u4e2a\u7c7b\u4f3c\u7684\u53c2\u6570 <code>--vacuum-time=</code> \u548c <code>--vacuum-files=10</code> \u4e5f\u53ef\u53c2\u8003\u3002</p>"},{"location":"ops/service/#logrotate","title":"logrotate","text":"<p>\u6309\u7167 Unix \u7684\u201c\u4e00\u4e2a\u7a0b\u5e8f\u53ea\u505a\u4e00\u4ef6\u4e8b\u201d\u7684\u8bbe\u8ba1\u601d\u60f3\uff0c\u4e00\u822c\u7684\u7a0b\u5e8f\u53ea\u7ba1\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230\u6307\u5b9a\u5730\u65b9\uff0c\u56e0\u6b64\u6709\u4e86 logrotate \u8fd9\u4e2a\u5de5\u5177\u6765\u8d1f\u8d23\u65e5\u5fd7\u7684\u201c\u6eda\u52a8\u201d\uff08rotate\uff09\uff0c\u5373\u91cd\u547d\u540d\u3001\u538b\u7f29\u3001\u5220\u9664\u7b49\u64cd\u4f5c\u3002</p> <p>logrotate \u7684\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>/etc/logrotate.conf</code>\uff0c\u800c\u6bcf\u4e2a\u670d\u52a1\u7684\u914d\u7f6e\u6587\u4ef6\u5219\u4f4d\u4e8e <code>/etc/logrotate.d/</code> \u76ee\u5f55\u4e0b\u3002\u4ee5 Telegraf \u4e3a\u4f8b\uff0c\u5176\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> /etc/logrotate.d/telegraf<pre><code>/var/log/telegraf/telegraf.log\n{\n    rotate 6\n    daily\n    missingok\n    dateext\n    copytruncate\n    notifempty\n    compress\n}\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u7684\u5f00\u5934\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u6587\u4ef6\uff08\u6bcf\u884c\u4e00\u4e2a\uff0c\u53ef\u4ee5\u4f7f\u7528 shell \u7684\u901a\u914d\u7b26\uff09\uff0c\u7136\u540e\u662f\u4e00\u7cfb\u5217\u7684\u914d\u7f6e\u9879\u3002\u5e38\u89c1\u7684\u914d\u7f6e\u9879\u6709\uff1a</p> rotate &lt;n&gt; <p>\u4fdd\u7559\u7684\u989d\u5916\u65e5\u5fd7\u6587\u4ef6\u6570\u91cf\u3002\u4f8b\u5982 <code>rotate 6</code> \u4f1a\u4fdd\u7559 <code>example.log</code>\u3001<code>example.log.1</code> \u76f4\u5230 <code>example.log.6</code>\uff0c\u800c <code>example.log.7</code> \u5219\u4f1a\u76f4\u63a5\u5220\u9664\u3002</p> daily / weekly / monthly / yearly <p>rotate \u7684\u9891\u7387\uff0c\u4e5f\u8bb8\u4f60\u5e76\u4e0d\u9700\u8981\u4f7f\u7528\u540e\u4e24\u8005\u3002</p> missingok / notifempty <p>\u7279\u6b8a\u60c5\u51b5\u7684\u5904\u7406\u65b9\u5f0f\uff08\u89c1\u8fd9\u4e24\u4e2a\u9009\u9879\u7684\u5b57\u9762\u542b\u4e49\uff09\u3002</p> dateext / dateformat <p>\u4f7f\u7528\u65e5\u671f\u4f5c\u4e3a\u540e\u7f00\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 <code>.1</code>\u3001<code>.2</code> \u7b49\u3002\u53e6\u6709 <code>dateyesterday</code> \u9009\u9879\uff0c\u5373\u4f7f\u7528\u6628\u5929\u7684\u65e5\u671f\u6765\u547d\u540d\uff0c\u4fdd\u8bc1\u6587\u4ef6\u540d\u4e2d\u7684\u65e5\u671f\u548c\u6587\u4ef6\u5185\u5bb9\u5c3d\u53ef\u80fd\u4e00\u81f4\u3002</p> copytruncate <p>\u5c06\u6587\u4ef6\u5185\u5bb9\u590d\u5236\u5230\u65b0\u6587\u4ef6\uff0c\u7136\u540e\u6e05\u7a7a\u539f\u6587\u4ef6\u3002\u7a0b\u5e8f\u9700\u8981\u4ee5 <code>O_APPEND</code> \u7684\u65b9\u5f0f\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u9020\u6210\u9519\u4e71\u3002</p> <p>\u9002\u7528\u4e8e\u4e0d\u652f\u6301\u901a\u8fc7 <code>SIGHUP</code> \u7b49\u65b9\u5f0f\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\u7684\u7a0b\u5e8f\u3002\u5bf9\u4e8e\u652f\u6301\u201c\u91cd\u8f7d\u65e5\u5fd7\u6587\u4ef6\u201d\u7684\u7a0b\u5e8f\uff0c\u4e0d\u63a8\u8350\u4f7f\u7528\u8fd9\u4e2a\u9009\u9879\u3002</p> create &lt;mode&gt; &lt;owner&gt; &lt;group&gt; <p>\u521b\u5efa\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6\u65f6\u7684\u6743\u9650\u548c\u6240\u6709\u8005\u3002\u5982\u679c\u7a0b\u5e8f\u53ef\u4ee5\u81ea\u5df1\u521b\u5efa\u65e5\u5fd7\u6587\u4ef6\uff0c\u90a3\u4e48\u53ef\u4ee5\u5ffd\u7565\u3002</p> compresscompresscmduncompresscmdcompressextcompressoptions <p>\u538b\u7f29\u65e7\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u4ee5\u53ca\u538b\u7f29\u53c2\u6570\uff08\u9ed8\u8ba4\u4f7f\u7528 <code>gzip</code> / <code>gunzip</code> / <code>.gz</code> / <code>-9</code>\uff09\u3002\u5176\u4e2d <code>compress</code> \u662f\u5f00\u5173\uff0c\u9ed8\u8ba4\u884c\u4e3a\u662f <code>nocompress</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f7f\u7528 Zstd \u538b\u7f29\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>compresscmd /usr/bin/zstd\nuncompresscmd /usr/bin/unzstd\ncompressext .zst\ncompressoptions -13 -T0\n</code></pre> delaycompress <p>\u4e0d\u538b\u7f29\u521a rotate \u51fa\u6765\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u5373\u4fdd\u7559 <code>example.log</code> \u548c <code>example.log.1</code>\uff0c\u538b\u7f29 <code>.2</code> \u5f00\u59cb\u7684\u65e5\u5fd7\u6587\u4ef6\u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u9009\u9879\uff0c\u90a3\u4e48 <code>example.log.1</code> \u4f1a\u88ab\u538b\u7f29</p> prerotate / postrotate <p>\u5728 rotate \u4e4b\u524d/\u4e4b\u540e\u6267\u884c\u7684\u547d\u4ee4\uff0c\u547d\u4ee4\u5757\u9700\u8981\u4ee5 <code>endscript</code> \u7ed3\u675f\u3002\u4e0e Makefile / Dockerfile \u7b49\u8bed\u6cd5\u7c7b\u4f3c\uff0c\u6bcf\u884c\u4e3a\u5355\u72ec\u7684\u4e00\u4e2a\u547d\u4ee4\uff0c\u56e0\u6b64\u5982\u679c\u8981\u5c06 <code>if</code> \u7b49 shell \u8bed\u6cd5\u5199\u6210\u591a\u884c\uff0c\u9700\u8981\u5728\u9664\u4e86\u6700\u540e\u4e00\u884c\u4ee5\u5916\u7684\u6bcf\u4e00\u884c\u672b\u5c3e\u4f7f\u7528\u53cd\u659c\u6760\uff0c\u907f\u514d\u88ab\u89e3\u91ca\u6210\u591a\u6761\u547d\u4ee4\u3002</p> <p>\u4f8b\u5982\uff0cNginx \u8f6f\u4ef6\u5305\u63d0\u4f9b\u7684\u914d\u7f6e\u5c31\u4f1a\u5728 rotate \u4e4b\u540e\u91cd\u8f7d Nginx\uff1a</p> /etc/logrotate.d/nginx<pre><code>postrotate\n    invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1\nendscript\n</code></pre> <p>\u4fee\u6539\u4e86 logrotate \u7684\u914d\u7f6e\u6587\u4ef6\u4e4b\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>logrotate -d /etc/logrotate.conf</code> \u6765\u6d4b\u8bd5\u914d\u7f6e\u6587\u4ef6\u7684\u6b63\u786e\u6027\uff0c\u800c\u4e0d\u4f1a\u771f\u6b63\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002</p> <p>\u540c\u65f6\u7531\u4e8e logrotate \u4e0d\u5b58\u5728\u5b88\u62a4\u8fdb\u7a0b\uff0c\u800c\u662f\u901a\u8fc7 systemd timer \u6765\u5b9a\u671f\u6267\u884c\u7684\uff0c\u56e0\u6b64\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u4e4b\u540e\u4e0d\u9700\u8981\u91cd\u542f\u4efb\u4f55\u670d\u52a1\u3002</p>"},{"location":"ops/network-service/intranet/","title":"\u96a7\u9053\u7ec4\u7f51","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u5728\u7f51\u7edc\u4e2d\uff0c\u96a7\u9053\u662f\u4e00\u79cd\u5c06\u6570\u636e\u5305\u4ece\u4e00\u4e2a\u7f51\u7edc\u8282\u70b9\u5c01\u88c5\u5e76\u4f20\u8f93\u5230\u53e6\u4e00\u4e2a\u7f51\u7edc\u8282\u70b9\u7684\u6280\u672f\u3002\u5b83\u53ef\u4ee5\u7528\u4e8e\u5728\u4e24\u4e2a\u4e0d\u540c\u7684\u7f51\u7edc\u4e4b\u95f4\u5efa\u7acb\u865a\u62df\u8fde\u63a5\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u7ed5\u8fc7\u9632\u706b\u5899\u6216\u5176\u4ed6\u7f51\u7edc\u9650\u5236\u3002</p> <p>\u5728\u96a7\u9053\u4e2d\uff0c\u6570\u636e\u5305\u4f1a\u88ab\u5c01\u88c5\u5728\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5305\u4e2d\uff0c\u5e76\u4f7f\u7528\u96a7\u9053\u534f\u8bae\u8fdb\u884c\u4f20\u8f93\u3002</p> <p>\u5728\u865a\u62df\u4e13\u7528\u7f51\u7edc\uff08VPN\uff09\u4e2d\uff0c\u96a7\u9053\u7528\u4e8e\u5c06\u7528\u6237\u8bbe\u5907\u4e0e VPN \u670d\u52a1\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u52a0\u5bc6\u5e76\u5c01\u88c5\u3002\u8fd9\u4f7f\u5f97\u7528\u6237\u8bbe\u5907\u53ef\u4ee5\u5b89\u5168\u5730\u8fde\u63a5\u5230 VPN \u670d\u52a1\u5668\uff0c\u5e76\u901a\u8fc7 VPN \u670d\u52a1\u5668\u8bbf\u95ee\u53d7\u9650\u7684\u7f51\u7edc\u8d44\u6e90\uff0c\u901a\u5e38\u662f\u5185\u7f51\u73af\u5883\uff08IntraNet\uff09\u4e0b\u7684\u5404\u79cd\u670d\u52a1\u3002</p> <p>\u5982\u4eca\u7565\u663e\u9648\u65e7\u7684 PPTP\u3001SSTP\u3001L2TP \u534f\u8bae\u4e0b\u9762\u4e0d\u518d\u63d0\u53ca\u3002\u4e00\u4e9b\u9ad8\u6821\u548c\u4f01\u4e1a\u4f7f\u7528\u7684\u6df1\u4fe1\u670d EasyConnect \u7531\u4e8e\u670d\u52a1\u7aef\u5e76\u672a\u653e\u51fa\u4e14\u4ecd\u5728\u4f7f\u7528 Java applet \u5b9e\u73b0 SSL VPN\uff0c\u56e0\u6b64\u540c\u6837\u7565\u8fc7\u3002</p>"},{"location":"ops/network-service/intranet/#ipsec","title":"IPsec","text":"<p>\u6807\u51c6\u5316\u7a0b\u5ea6\u9ad8\uff0c\u652f\u6301\u5e7f\u6cdb</p>"},{"location":"ops/network-service/intranet/#gre-over-ipsec","title":"GRE over IPsec","text":""},{"location":"ops/network-service/intranet/#anyconnect","title":"AnyConnect","text":"<p>\u662f\u601d\u79d1\u7684\u4e13\u6709\u8f6f\u4ef6\uff0c\u4f46\u662f openconnect/ocserv \u517c\u5bb9\u4e86\u5176\u534f\u8bae</p> <p>\u6613\u4e8e\u4f7f\u7528\uff0c\u5b89\u5168\u6027\u9ad8\uff0c\u652f\u6301\u591a\u79cd\u5e73\u53f0</p>"},{"location":"ops/network-service/intranet/#openvpn","title":"OpenVPN","text":"<p>\u5f00\u6e90\uff0c\u514d\u8d39\uff0c\u53ef\u5b9a\u5236\uff0c\u4f46\u662f\u901f\u5ea6\u76f8\u5bf9\u8f83\u6162</p>"},{"location":"ops/network-service/intranet/#ikev2","title":"IKEv2","text":"<p>\u5b89\u5168\u6027\u9ad8\uff0c\u6613\u4e8e\u914d\u7f6e\uff0c\u4f46\u662f\u57fa\u4e8e udp</p>"},{"location":"ops/network-service/intranet/#wireguard","title":"WireGuard","text":"<p>WireGuard \u662f\u4e00\u79cd\u73b0\u4ee3\u7684 VPN \u534f\u8bae\uff0c\u901f\u5ea6\u5feb\uff0c\u914d\u7f6e\u7b80\u5355\uff0c\u5b89\u5168\u6027\u9ad8\uff0c\u4f46\u662f\u57fa\u4e8e udp</p>"},{"location":"ops/network-service/intranet/#wireguard_1","title":"\u5b89\u88c5 WireGuard","text":"<p>\u5927\u591a\u6570\u73b0\u4ee3 Linux \u53d1\u884c\u7248\u90fd\u53ef\u4ee5\u76f4\u63a5\u4ece\u5b98\u65b9\u4ed3\u5e93\u4e2d\u5b89\u88c5 WireGuard\u3002\u4f8b\u5982\uff0c\u5728\u57fa\u4e8e Debian \u7684\u7cfb\u7edf\uff08\u5982 Ubuntu\uff09\u4e0a\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>sudo apt update\nsudo apt install wireguard\n</code></pre> <p>\u5728 Red Hat \u6216 Fedora \u7cfb\u5217\u7684\u7cfb\u7edf\u4e0a\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528<code>dnf</code>\uff1a</p> <pre><code>sudo dnf install wireguard-tools\n</code></pre>"},{"location":"ops/network-service/intranet/#_2","title":"\u751f\u6210\u5bc6\u94a5\u5bf9","text":"<p>\u6bcf\u4e2a WireGuard \u63a5\u53e3\u90fd\u9700\u8981\u4e00\u4e2a\u79c1\u94a5\u548c\u516c\u94a5\u3002<code>wg genkey</code>\u751f\u6210\u4e00\u4e2a\u79c1\u94a5\uff0c<code>wg pubkey</code>\u6839\u636e\u8f93\u5165\u7684\u79c1\u94a5\u8f93\u51fa\u516c\u94a5\u3002</p> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u751f\u6210\u5bc6\u94a5\u5bf9\uff1a</p> <pre><code>wg genkey | tee privatekey | wg pubkey &gt; publickey\n</code></pre> <p>\u8fd9\u5c06\u5728\u5f53\u524d\u76ee\u5f55\u4e0b\u751f\u6210\u4e24\u4e2a\u6587\u4ef6\uff1a<code>privatekey</code> \u548c <code>publickey</code></p>"},{"location":"ops/network-service/intranet/#_3","title":"\u521b\u5efa\u914d\u7f6e\u6587\u4ef6","text":"<p>\u8fd9\u91cc\u4ee5\u4e00\u4e2a\u7b80\u5355\u7684\u573a\u666f\u4e3a\u4f8b\uff0c\u4e24\u53f0\u673a\u5668 A \u548c B \u8fdb\u884c\u7ec4\u7f51\u3002\u5176\u4e2d A \u6709\u516c\u7f51 ip\uff0c\u5bf9\u5e94\u57df\u540d <code>example.com</code></p> <p>A \u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>[Interface]\nAddress = 10.0.0.1/24\nListenPort = 51820\nPrivateKey = &lt;A\u7684\u79c1\u94a5&gt;\n\n[Peer]\nPublicKey = &lt;B\u7684\u516c\u94a5&gt;\nAllowedIPs = 10.0.0.4/32\n</code></pre> <p>B \u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>[Interface]\nAddress = 10.0.0.4/24\nPrivateKey = &lt;B\u7684\u79c1\u94a5&gt;\n\n[Peer]\nPublicKey = &lt;A\u7684\u516c\u94a5&gt;\nEndpoint = example.com:51820\nAllowedIPs = 10.0.11.0/24\nPersistentKeepalive = 25\n</code></pre> <p>\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5bc6\u94a5\u7684\u66ff\u6362\u6210\u5bc6\u94a5\u7684\u6587\u672c\uff0c\u800c\u4e0d\u662f\u5bc6\u94a5\u6587\u4ef6\u7684\u8def\u5f84\u3002</p> <p>\u8bbe\u5907 A \u7684 VPN \u5185\u90e8 IP \u5730\u5740\u8bbe\u7f6e\u4e3a <code>10.0.0.1</code>\uff0c\u8bbe\u5907 B \u7684 VPN \u5185\u90e8 IP \u5730\u5740\u8bbe\u7f6e\u4e3a <code>10.0.0.4</code>\uff0c\u5b50\u7f51\u63a9\u7801\u4e3a 24 \u4f4d\u3002</p> <p><code>PersistentKeepalive=25</code> \u4ee3\u8868\u6bcf 25 \u79d2\u53d1\u9001\u4e00\u4e2a\u65e0\u5b9e\u8d28\u6570\u636e\u7684\u5fc3\u8df3\u5305\uff0c\u7528\u4e8e\u5728 NAT \u6216\u9632\u706b\u5899\u73af\u5883\u4e2d\u4fdd\u6301\u8fde\u63a5\u6d3b\u8dc3\u3002</p> <p><code>AllowedIPs</code> \u6307\u5b9a\u4e86\u53ef\u4ee5\u901a\u8fc7 VPN \u53d1\u9001\u5230\u54ea\u4e9b IP \u5730\u5740\u7684\u6570\u636e\u3002\u4f8b\u5982 <code>10.0.0.1/32</code> \u8868\u793a\u53ea\u6709\u76ee\u6807\u4e3a <code>10.0.0.1</code> \u7684\u6570\u636e\u5305\u53ef\u4ee5\u901a\u8fc7 VPN \u53d1\u9001\u7ed9\u5bf9\u65b9\u3002</p> <p>\u914d\u7f6e\u6587\u4ef6\u5199\u5230 <code>/etc/wireguard/&lt;\u914d\u7f6e\u540d&gt;.conf</code> \u4e2d\u3002\u4f8b\u5982\uff1a<code>/etc/wireguard/wg0.conf</code></p>"},{"location":"ops/network-service/intranet/#wireguard_2","title":"\u542f\u52a8 WireGuard \u63a5\u53e3","text":"<p>\u4f7f\u7528<code>wg-quick</code>\u5de5\u5177\u542f\u52a8 WireGuard \u63a5\u53e3\uff1a</p> <pre><code>sudo wg-quick up wg0\n</code></pre> <p>\u5176\u4e2d<code>wg0</code>\u662f\u914d\u7f6e\u6587\u4ef6\u7684\u540d\u79f0\uff0c\u4e0d\u5e26<code>.conf</code>\u540e\u7f00\u3002</p>"},{"location":"ops/network-service/intranet/#_4","title":"\u68c0\u67e5\u63a5\u53e3\u72b6\u6001","text":"<p>\u53ef\u4ee5\u4f7f\u7528 wg \u547d\u4ee4\u67e5\u770b\u5f53\u524d\u7684 WireGuard \u72b6\u6001\uff1a</p> <pre><code>sudo wg\n</code></pre>"},{"location":"ops/network-service/intranet/#wireguard_3","title":"\u505c\u6b62 WireGuard \u63a5\u53e3","text":"<p>\u5f53\u4e0d\u518d\u9700\u8981\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u505c\u6b62\u63a5\u53e3\uff1a</p> <pre><code>sudo wg-quick down wg0\n</code></pre>"},{"location":"ops/storage/","title":"\u5b58\u50a8\u7cfb\u7edf","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p> <p>\u670d\u52a1\u5668\u9700\u8981\u4f7f\u7528\u7684\u5b58\u50a8\u65b9\u6848\u4e0e\u4e2a\u4eba\u8ba1\u7b97\u673a\u7684\u5dee\u5f02\u8f83\u5927\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u670d\u52a1\u5668\u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u76d8\u4f4d\uff0c\u4e0d\u540c\u670d\u52a1\u5668\u7684\u76d8\u4f4d\u4f7f\u7528\u7684\u63a5\u53e3\u3001\u78c1\u76d8\u7684\u5c3a\u5bf8\u53ef\u80fd\u4e0d\u540c\u3002</li> <li>\u670d\u52a1\u5668\u4e00\u822c\u63d0\u4f9b RAID \u5361\uff0c\u53ef\u4ee5\u5728\u786c\u4ef6\u5c42\u9762\u5b9e\u73b0 RAID \u529f\u80fd\uff0c\u5927\u90e8\u5206 RAID \u5361\u4e5f\u5141\u8bb8\u7ba1\u7406\u5458\u8bbe\u7f6e\u76f4\u901a\u5230\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u7531\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u73b0 RAID \u529f\u80fd\u3002</li> <li>\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e0d\u540c\uff0c\u53ef\u80fd\u9700\u8981\u8003\u8651\u4e0d\u540c\u6587\u4ef6\u7cfb\u7edf\u7684\u5dee\u5f02\uff0c\u5e76\u4e14\u9009\u62e9\u5408\u9002\u7684\u6587\u4ef6\u7cfb\u7edf\u3002</li> <li>\u7531\u4e8e\u78c1\u76d8\u6570\u91cf\u591a\uff0c\u78c1\u76d8\u6545\u969c\u7684\u6982\u7387\u4e5f\u4f1a\u589e\u52a0\uff0c\u56e0\u6b64\u9700\u8981\u80fd\u591f\u53ca\u65f6\u53d1\u73b0\u6545\u969c\uff0c\u5e76\u91c7\u53d6\u76f8\u5e94\u7684\u63aa\u65bd\u3002</li> <li>\u2026\u2026\u2026\u2026</li> </ul> <p>\u672c\u90e8\u5206\u4f1a\u5bf9\u8fd0\u7ef4\u9700\u8981\u4e86\u89e3\u7684\u57fa\u7840\u77e5\u8bc6\u8fdb\u884c\u4ecb\u7ecd\u3002</p>"},{"location":"ops/storage/#disks","title":"\u78c1\u76d8","text":""},{"location":"ops/storage/#disk-type","title":"\u78c1\u76d8\u7c7b\u578b\u7b80\u4ecb","text":"<p>\u5728\u670d\u52a1\u5668\u4e0a\u6700\u5e38\u89c1\u7684\u4e3a\u673a\u68b0\u786c\u76d8\uff08HDD\uff09\u548c\u56fa\u6001\u786c\u76d8\uff08SSD\uff09\u3002\u673a\u68b0\u786c\u76d8\u4f7f\u7528\u78c1\u76d8\u7247\u548c\u673a\u68b0\u81c2\u8fdb\u884c\u6570\u636e\u8bfb\u5199\uff0c\u56fa\u6001\u786c\u76d8\u4f7f\u7528\u95ea\u5b58\u82af\u7247\u8fdb\u884c\u6570\u636e\u8bfb\u5199\u3002 \u9664\u6b64\u4ee5\u5916\uff0c\u8fd8\u53ef\u80fd\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u5b58\u50a8\u8bbe\u5907\uff0c\u4f8b\u5982\u78c1\u5e26\u3001Intel Optane \u7b49\uff0c\u8fd9\u91cc\u4e0d\u505a\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p>\u4e00\u822c\u6765\u8bb2\uff0c\u5355\u5757\u673a\u68b0\u786c\u76d8\u7684\u6027\u80fd\u53d6\u51b3\u4e8e RPM\uff08\u8f6c\u901f\uff09\u3002\u5728\u4f30\u7b97\u65f6\u53ef\u4ee5\u8ba4\u4e3a\u987a\u5e8f\u8bfb\u5199\u5e26\u5bbd\u5728 100 MB/s \u5de6\u53f3\uff0c4K \u968f\u673a\u8bfb\u5199\u5e26\u5bbd\u5728 1 MB/s \u5de6\u53f3\uff0cIOPS<sup>1</sup> \u5728 100 \u5de6\u53f3\u3002 \u800c\u5355\u5757\u56fa\u6001\u786c\u76d8\u7684\u987a\u5e8f\u8bfb\u5199\u5e26\u5bbd\u5728 500 MB/s (SATA) \u6216 1500 MB/s (NVMe) \u4ee5\u4e0a\uff0c4K \u968f\u673a\u8bfb\u5199\u5e26\u5bbd\u5728 50 MB/s \u5de6\u53f3\uff0cIOPS \u5728 10000 \u5de6\u53f3\u3002 \u5bf9\u4e8e\u4f01\u4e1a\u7ea7\u786c\u76d8\uff0c\u8fd9\u4e9b\u6027\u80fd\u6307\u6807\u53ef\u80fd\u4f1a\u66f4\u9ad8\u3002</p> <p>\u786c\u76d8\u7684\u4f7f\u7528\u5bff\u547d\u7684\u4e00\u9879\u91cd\u8981\u53c2\u6570\u662f MTBF\uff08Mean Time Between Failures\uff0c\u5e73\u5747\u6545\u969c\u95f4\u9694\u65f6\u95f4\uff09\u3002 \u7531\u4e8e\u673a\u68b0\u786c\u76d8\u5305\u542b\u8fd0\u52a8\u7684\u90e8\u4ef6\uff0c\u673a\u68b0\u786c\u76d8\u7684 MTBF \u4e00\u822c\u4f1a\u6bd4\u56fa\u6001\u786c\u76d8\u4f4e\uff0c\u5927\u81f4\u5728 10 \u4e07\u5c0f\u65f6\u5230 100 \u4e07\u5c0f\u65f6\u3002 \u5c3d\u7ba1\u770b\u8d77\u6765\u5f88\u957f\uff0c\u4f46\u662f\u7531\u4e8e\u5b9e\u9645\u4f7f\u7528\u4e2d\u7684\u632f\u52a8\u3001\u6e29\u5ea6\u3001\u8bfb\u5199\u6b21\u6570\u7b49\u56e0\u7d20\uff0c\u786c\u76d8\u7684\u5b9e\u9645\u5bff\u547d\u53ef\u80fd\u4f1a\u8fdc\u8fdc\u4f4e\u4e8e MTBF\u3002 \u800c\u5bf9\u4e8e SSD \u6765\u8bf4\uff0c\u4e00\u9879\u66f4\u52a0\u91cd\u8981\u7684\u53c2\u6570\u662f TBW\uff08Total Bytes Written\uff0c\u603b\u5199\u5165\u5b57\u8282\u6570\uff09\uff0c\u5b83\u8868\u793a\u4e86\u95ea\u5b58\u82af\u7247\u53ef\u4ee5\u627f\u53d7\u7684\u603b\u5199\u5165\u91cf\uff0c\u4e00\u822c\u5728\u51e0\u5341\u5230\u6570\u5343 TB\uff1b \u8bfb\u53d6\u64cd\u4f5c\u5bf9 SSD \u7684\u635f\u8017\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8ba1\u3002</p> <p>\u5bf9\u5177\u4f53\u7684\u786c\u76d8\u578b\u53f7\uff0c\u5efa\u8bae\u9605\u8bfb\u5382\u5546\u7684\u6587\u6863\uff08\u4f8b\u5982 datasheet \u7b49\uff09\uff0c\u4ee5\u83b7\u53d6\u51c6\u786e\u7684\u4fe1\u606f\u3002</p>"},{"location":"ops/storage/#disk-size","title":"\u78c1\u76d8\u89c4\u683c\u4e0e\u5c3a\u5bf8","text":"<p>\u5173\u4e8e\u78c1\u76d8\u89c4\u683c\uff0c\u5728\u670d\u52a1\u5668\u5b89\u88c5\u65f6\u6211\u4eec\u4e3b\u8981\u5173\u5fc3\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u78c1\u76d8\u7684\u5c3a\u5bf8\uff082.5 \u82f1\u5bf8\u30013.5 \u82f1\u5bf8\uff09<ul> <li>\u90e8\u5206\u624b\u518c\u4f1a\u5c06 2.5 \u82f1\u5bf8\u7684\u78c1\u76d8\u79f0\u4e3a SFF\uff08Small Form Factor\uff09\uff0c3.5 \u82f1\u5bf8\u7684\u78c1\u76d8\u79f0\u4e3a LFF\uff08Large Form Factor\uff09\u3002</li> </ul> </li> <li>\u78c1\u76d8\u7684\u63a5\u53e3\u4e0e\u534f\u8bae\uff08SAS\u3001SATA\u3001NVMe\u3001M.2\u3001U.2\uff09</li> <li>\u662f\u5426\u4e0e\u670d\u52a1\u5668\u914d\u7f6e\u517c\u5bb9\uff1a<ul> <li>\u90e8\u5206\u670d\u52a1\u5668\u4f1a\u6709\u786c\u76d8\u767d\u540d\u5355\uff0c\u53ea\u6709\u767d\u540d\u5355\u4e2d\u7684\u786c\u76d8\u624d\u80fd\u8bc6\u522b\u3002</li> <li>\u4f7f\u7528\u7684\u786c\u4ef6 RAID \u65b9\u6848\u53ef\u80fd\u4f1a\u5bf9\u786c\u76d8\u63a5\u53e3\u6709\u8981\u6c42\uff0c\u4f8b\u5982 SATA \u548c SAS \u63a5\u53e3\u7684\u786c\u76d8\u4e0d\u80fd\u6df7\u7528\u3002</li> </ul> </li> </ul> <p>\u4ed4\u7ec6\u9605\u8bfb\u5e76\u786e\u8ba4\u5382\u5546\u6587\u6863</p> <p>\u4e00\u4e2a\u73b0\u5b9e\u4e2d\u53d1\u751f\u8fc7\u7684\u4f8b\u5b50\u662f\uff1a\u5c06\u9519\u8bef\u7684\u786c\u76d8\u6258\u67b6\u5b89\u88c5\u81f3\u670d\u52a1\u5668\u76d8\u4f4d\uff0c\u5bfc\u81f4\u6258\u67b6\u5361\u4f4f\u65e0\u6cd5\u53d6\u51fa\uff0c\u6700\u540e\u8d39\u4e86\u8fd1\u534a\u4e2a\u5c0f\u65f6\uff0c\u751a\u81f3\u7528\u4e0a\u4e86\u87ba\u4e1d\u5200\u4f5c\u4e3a\u6760\u6746\uff0c\u624d\u5c06\u5176\u677e\u52a8\uff0c\u53d6\u51fa\u786c\u76d8\u3002</p> <p>\u78c1\u76d8\u9700\u8981\u5e26\u4e0a\u6258\u67b6\u624d\u80fd\u5b89\u88c5\u5230\u670d\u52a1\u5668\u4e2d\u3002\u6258\u67b6\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u56fa\u5b9a\u4f4f\u78c1\u76d8\uff0c\u5e76\u4e14\u65b9\u4fbf\u5b89\u88c5\u548c\u53d6\u51fa\u3002\u6258\u67b6\u7684\u5c3a\u5bf8\u4e0e\u78c1\u76d8\u7684\u5c3a\u5bf8\u6709\u5173\uff0c3.5 \u82f1\u5bf8\u78c1\u76d8\u7684\u6258\u67b6\u4e00\u822c\u9700\u8981\u5b89\u88c5\u8f6c\u63a5\u677f\u624d\u80fd\u5b89\u88c5 2.5 \u82f1\u5bf8\u7684\u78c1\u76d8\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u6258\u67b6\u9884\u7559\u4e86 2.5 \u82f1\u5bf8\u78c1\u76d8\u7684\u87ba\u4e1d\u5b54\u4f4d\u3002\u540c\u65f6\uff0c\u6258\u67b6\u4e5f\u4e00\u822c\u6709 LED \u706f\uff0c\u5728\u78c1\u76d8\u6545\u969c\u65f6\u4f1a\u4eae\u9ec4\u706f\u6216\u7ea2\u706f\uff0c\u4e5f\u4e00\u822c\u80fd\u591f\u4f7f\u7528\u670d\u52a1\u5668\u7684\u7ba1\u7406\u5de5\u5177\u63a7\u5236\u706f\u95ea\u70c1\u6765\u5b9a\u4f4d\u78c1\u76d8\u3002</p>"},{"location":"ops/storage/#disk-interface","title":"\u78c1\u76d8\u63a5\u53e3\u4e0e\u534f\u8bae","text":"<p>\u673a\u68b0\u786c\u76d8\u4f7f\u7528 SATA\uff08Serial ATA\uff09\u6216 SAS\uff08Serial Attached SCSI\uff09\u63a5\u53e3\u8fde\u63a5\uff0c\u4e00\u4e9b\u56fa\u6001\u786c\u76d8\u4e5f\u4f1a\u4f7f\u7528 SATA \u63a5\u53e3\u3002SATA \u662f\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e0a\u6700\u5e38\u89c1\u7684\u786c\u76d8\u8fde\u63a5\u65b9\u5f0f\uff0c\u800c SAS \u7684\u63a5\u53e3\u5e26\u5bbd\u66f4\u9ad8\uff08\u867d\u7136\u673a\u68b0\u786c\u76d8\u5b9e\u9645\u7684\u4f20\u8f93\u901f\u5ea6\u901a\u5e38\u65e0\u6cd5\u8dd1\u6ee1 SATA \u7684\u5e26\u5bbd\uff09\uff0c\u652f\u6301\u66f4\u591a\u529f\u80fd\uff0c\u5e76\u4e14\u5411\u4e0b\u517c\u5bb9 SATA\uff0c\u56e0\u6b64\u5728\u670d\u52a1\u5668\u4e0a\u66f4\u5e38\u89c1\u3002</p> <p>SATA \u4e0e SAS \u7684\u8be6\u7ec6\u5bf9\u6bd4\u53ef\u53c2\u8003\u82f1\u6587 Wikipedia \u4e2d SAS \u7684 \"Comparison with SATA\" \u4e00\u8282\u3002</p> <p>\u968f\u7740\u56fa\u6001\u786c\u76d8\u7684\u666e\u53ca\uff0cPCIe \u63a5\u53e3\u7684\u56fa\u6001\u786c\u76d8\u4e5f\u8d8a\u6765\u8d8a\u591a\u89c1\u3002PCIe \u63a5\u53e3\u7684\u56fa\u6001\u786c\u76d8\u901a\u5e38\u4f7f\u7528 NVMe \u534f\u8bae\uff0c\u56e0\u6b64\u4e5f\u88ab\u79f0\u4e3a NVMe SSD\u3002NVMe SSD \u5e38\u89c1\u7684\u63a5\u53e3\u5f62\u6001\u6709 U.2\u3001M.2 \u548c AIC\uff08PCIe Add-in Card\uff0c\u5373\u6269\u5c55\u5361\uff09\u3002</p> <ul> <li> <p>M.2 \u63a5\u53e3\u7684\u5c3a\u5bf8\u6700\u5c0f\uff0c\u5728\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e0a\u4e5f\u66f4\u5e38\u89c1\uff0c\u751a\u81f3\u53ef\u4ee5\u653e\u5165\u786c\u76d8\u76d2\u4e2d\u4f5c\u4e3a\u5c0f\u5de7\u8f7b\u4fbf\u7684\u79fb\u52a8\u786c\u76d8\u4f7f\u7528\u3002</p> <ul> <li>\u5e38\u89c1\u7684 M.2 \u63a5\u53e3\u6709 B-key \u548c M-key \u4e24\u79cd\uff0c\u4e3b\u6d41\u7684 NVMe SSD \u901a\u5e38\u4f7f\u7528 M-key \u63a5\u53e3\uff0c\u800c SATA SSD \u901a\u5e38\u4f7f\u7528 B-key \u6216 B+M\uff08\u4e24\u4e2a\u7f3a\u53e3\uff09\u3002\u4e00\u4e2a M.2 \u63a5\u53e3\u662f\u5426\u652f\u6301 NVMe \u6216 SATA \u534f\u8bae\u53d6\u51b3\u4e8e\u4e3b\u677f\u6216\u63a7\u5236\u5668\uff0c\u56e0\u6b64\u5177\u4f53\u60c5\u51b5\u9700\u8981\u53c2\u8003\u4ea7\u54c1\u7684\u8bf4\u660e\u4e66\u3002<ul> <li>\u4f5c\u4e3a\u53c2\u8003\uff0c2023 \u5e74\u4ee5\u6765\u5e02\u9762\u4e0a\u5df2\u7ecf\u89c1\u4e0d\u5230\u53ea\u652f\u6301 SATA \u800c\u4e0d\u652f\u6301 NVme \u7684 M.2 \u63a5\u53e3\u4e86\uff0c\u5c3d\u7ba1 M.2 SATA \u7684 SSD \u4ecd\u7136\u6709\u5356\u3002</li> </ul> </li> <li>\u9664\u4e86\u63a5\u53e3\u7684\u5f62\u72b6\uff0cM.2 \u63a5\u53e3\u7684\u957f\u5bbd\u4e5f\u6709\u4e00\u7cfb\u5217\u9009\u9879\uff0c\u4f8b\u5982 2230\u30012242\u30012280\u300122110 \u7b49\uff0c\u5373\u5bbd\u5ea6\u4e3a 22 mm\uff0c\u957f\u5ea6\u5206\u522b\u4e3a 30\u300142\u300180\u3001110 mm \u7b49\u3002\u4e2a\u4eba\u7535\u8111\u4e00\u822c\u91c7\u7528 2280 \u7684\u5c3a\u5bf8\uff0c\u800c\u670d\u52a1\u5668\uff08\u548c\u4e00\u4e9b\u9ad8\u7aef\u53f0\u5f0f\u673a\u4e3b\u677f\uff09\u4e0a\u53ef\u80fd\u4f1a\u4f7f\u7528 22110 \u7684\u5c3a\u5bf8\u3002\u8fd9\u4e9b\u5c3a\u5bf8\u4e0d\u5f71\u54cd\u63a5\u53e3\u7684\u7535\u6c14\u7279\u6027\uff0c\u53ea\u662f\u4e3a\u4e86\u9002\u5e94\u4e0d\u540c\u7684\u7a7a\u95f4\u548c\u6563\u70ed\u9700\u6c42\u3002</li> </ul> </li> <li> <p>U.2 \u63a5\u53e3\u5f62\u72b6\u4e0e SAS \u7c7b\u4f3c\uff0c\u4f46\u662f\u4e0d\u517c\u5bb9 SAS\uff08\u6bd5\u7adf\u5e95\u5c42\u534f\u8bae\u90fd\u4e0d\u4e00\u6837\uff09\uff0c\u4e14 2.5 \u82f1\u5bf8\u548c 15 mm \u4ee5\u4e0a\u539a\u5ea6\u7684\u5916\u5f62\u76f8\u6bd4 M.2 \u4e5f\u5177\u6709\u66f4\u597d\u7684\u6563\u70ed\u80fd\u529b\uff0c\u662f\u670d\u52a1\u5668\u4e0a\u7684\u5e38\u89c1\u5f62\u6001\u3002</p> </li> <li>AIC \u5c31\u662f\u4e00\u5757 PCIe \u6269\u5c55\u5361\uff0c\u53ef\u4ee5\u63d2\u5165 PCIe \u63d2\u69fd\u4e2d\u4f7f\u7528\u3002</li> </ul> \u56fe\u7247\uff1aM.2 SSD <p> M.2 2280 SSD </p> \u56fe\u7247\uff1aU.2 SSD <p> U.2 SSD </p> \u56fe\u7247\uff1aAIC SSD <p> PCIe \u63d2\u5361\u5f0f SSD </p>"},{"location":"ops/storage/#smart","title":"S.M.A.R.T.","text":"<p>\u78c1\u76d8\u7684 S.M.A.R.T.\uff08Self-Monitoring, Analysis and Reporting Technology\uff09\u529f\u80fd\u53ef\u4ee5\u8bb0\u5f55\u78c1\u76d8\u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5e76\u4e14\u5728\u78c1\u76d8\u51fa\u73b0\u6545\u969c\u524d\u63d0\u4f9b\u9884\u8b66\u3002S.M.A.R.T. \u53ef\u4ee5\u8bb0\u5f55\u78c1\u76d8\u7684\u6e29\u5ea6\u3001\u8bfb\u5199\u9519\u8bef\u7387\u3001\u78c1\u76d8\u65cb\u8f6c\u901f\u5ea6\u3001\u78c1\u76d8\u7684\u5bff\u547d\u7b49\u4fe1\u606f\u3002</p> <p>Linux \u7cfb\u7edf\u4e0a\u53ef\u4ee5\u5b89\u88c5 <code>smartmontools</code> \u5305\u6765\u67e5\u770b\u78c1\u76d8\u7684 S.M.A.R.T. \u4fe1\u606f\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u53ef\u7528\u7684\u78c1\u76d8\u4e0e\u5176 S.M.A.R.T \u72b6\u6001\uff1a</p> <pre><code>$ sudo smartctl --scan\n/dev/nvme0 -d nvme # /dev/nvme0, NVMe device\n$ sudo smartctl -a /dev/nvme0\n\uff08\u5185\u5bb9\u7701\u7565\uff09\n</code></pre> <p>\u5728\u670d\u52a1\u5668\u4e0a\uff0c\u5982\u679c\u4f7f\u7528\u786c\u4ef6 RAID\uff0c\u4f7f\u7528 <code>smartctl</code> \u9700\u8981\u6dfb\u52a0\u989d\u5916\u7684\u53c2\u6570\u6765\u4ece RAID \u63a7\u5236\u5668\u83b7\u53d6\u771f\u5b9e\u7684\u78c1\u76d8\u4fe1\u606f\uff0c\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo smartctl --scan\n/dev/sda -d scsi # /dev/sda, SCSI device\n/dev/sdb -d scsi # /dev/sdb, SCSI device\n/dev/sdc -d scsi # /dev/sdc, SCSI device\n/dev/sdd -d scsi # /dev/sdd, SCSI device\n/dev/bus/4 -d megaraid,8 # /dev/bus/4 [megaraid_disk_08], SCSI device\n/dev/bus/4 -d megaraid,9 # /dev/bus/4 [megaraid_disk_09], SCSI device\n/dev/bus/4 -d megaraid,10 # /dev/bus/4 [megaraid_disk_10], SCSI device\n/dev/bus/4 -d megaraid,11 # /dev/bus/4 [megaraid_disk_11], SCSI device\n/dev/bus/4 -d megaraid,12 # /dev/bus/4 [megaraid_disk_12], SCSI device\n/dev/bus/4 -d megaraid,13 # /dev/bus/4 [megaraid_disk_13], SCSI device\n/dev/bus/4 -d megaraid,14 # /dev/bus/4 [megaraid_disk_14], SCSI device\n/dev/bus/4 -d megaraid,15 # /dev/bus/4 [megaraid_disk_15], SCSI device\n/dev/bus/0 -d megaraid,8 # /dev/bus/0 [megaraid_disk_08], SCSI device\n/dev/bus/0 -d megaraid,9 # /dev/bus/0 [megaraid_disk_09], SCSI device\n/dev/bus/0 -d megaraid,10 # /dev/bus/0 [megaraid_disk_10], SCSI device\n/dev/bus/0 -d megaraid,11 # /dev/bus/0 [megaraid_disk_11], SCSI device\n/dev/bus/0 -d megaraid,12 # /dev/bus/0 [megaraid_disk_12], SCSI device\n/dev/bus/0 -d megaraid,13 # /dev/bus/0 [megaraid_disk_13], SCSI device\n$ sudo smartctl -a /dev/sdd  # \u76f4\u63a5\u67e5\u8be2\u53ea\u80fd\u770b\u5230\u6ca1\u6709\u610f\u4e49\u7684\u63a7\u5236\u5668\u4fe1\u606f\nsmartctl 7.2 2020-12-30 r5155 [x86_64-linux-5.10.0-21-amd64] (local build)\nCopyright (C) 2002-20, Bruce Allen, Christian Franke, www.smartmontools.org\n\n=== START OF INFORMATION SECTION ===\nVendor:               AVAGO\nProduct:              MR9361-8i\nRevision:             4.68\nCompliance:           SPC-3\nUser Capacity:        1,919,816,826,880 bytes [1.91 TB]\nLogical block size:   512 bytes\nPhysical block size:  4096 bytes\nLogical Unit id:      0x600605b00f17786026223e2d33c1767b\nSerial number:        007b76c1332d3e22266078170fb00506\nDevice type:          disk\nLocal Time is:        Sun Feb 11 18:40:45 2024 CST\nSMART support is:     Unavailable - device lacks SMART capability.\n\n=== START OF READ SMART DATA SECTION ===\nCurrent Drive Temperature:     0 C\nDrive Trip Temperature:        0 C\n\nError Counter logging not supported\n\nDevice does not support Self Test logging\n$ sudo smartctl -a /dev/bus/4 -d megaraid,8  # \u6dfb\u52a0\u53c2\u6570\u53ef\u4ee5\u770b\u5230\u771f\u5b9e\u7684\u78c1\u76d8\u4fe1\u606f\n\uff08\u5185\u5bb9\u7701\u7565\uff09\n</code></pre> <p>\u6709\u5173 S.M.A.R.T. \u6307\u6807\u89e3\u91ca\u4e0e\u76d1\u63a7\u7684\u5185\u5bb9\u5c06\u4f1a\u5728 LVM \u4e0e RAID \u4e2d\u4ecb\u7ecd\u3002</p>"},{"location":"ops/storage/#trim-discardunmap","title":"Trim (Discard/Unmap)","text":"<p>SSD \u7684\u95ea\u5b58\u5b58\u50a8\u7684\u7279\u70b9\u662f\uff1a\u4e0d\u652f\u6301\u4efb\u610f\u7684\u968f\u673a\u5199\uff0c\u4fee\u6539\u6570\u636e\u53ea\u80fd\u901a\u8fc7\u6e05\u7a7a\u533a\u5757\u4e4b\u540e\u91cd\u65b0\u5199\u5165\u6765\u5b9e\u73b0\u3002\u5e76\u4e14\u533a\u5757\u80fd\u591f\u7ecf\u53d7\u7684\u5199\u5165\u6b21\u6570\u662f\u6709\u9650\u7684\u3002 SSD \u4e2d\u7684\u56fa\u4ef6\u4f1a\u8fdb\u884c\u533a\u5757\u7ba1\u7406\uff0c\u4ee5\u5c06\u5199\u5165\u5e26\u6765\u7684\u78e8\u635f\u5206\u6563\u5230\u6240\u6709\u533a\u5757\u4e2d\u3002\u4f46\u662f\uff0c\u56fa\u4ef6\u5e76\u4e0d\u6e05\u695a\u6587\u4ef6\u7cfb\u7edf\u7684\u60c5\u51b5\uff0c\u56e0\u6b64\u5728\u6587\u4ef6\u7cfb\u7edf\u4e2d\u5220\u9664\u67d0\u4e2a\u6587\u4ef6\u4e4b\u540e\uff0c SSD \u56fa\u4ef6\u4f1a\u4ecd\u7136\u8ba4\u4e3a\u5bf9\u5e94\u7684\u533a\u5757\u5b58\u50a8\u4e86\u6570\u636e\uff0c\u4e0d\u80fd\u91ca\u653e\u3002Trim \u64cd\u4f5c\u7531\u64cd\u4f5c\u7cfb\u7edf\u53d1\u51fa\uff0c\u544a\u8bc9\u56fa\u4ef6\u54ea\u4e9b\u533a\u5757\u53ef\u4ee5\u91ca\u653e\uff0c\u4ee5\u63d0\u5347\u6027\u80fd\uff0c\u5ef6\u957f SSD \u4f7f\u7528\u5bff\u547d\u3002\u4e00\u4e9b\u7279\u6b8a\u7684\u5b58\u50a8\u8bbe\u5907\u4e5f\u4f1a\u652f\u6301 trim \u64cd\u4f5c\uff0c\u4f8b\u5982\u865a\u62df\u673a\u78c1\u76d8\uff08<code>virtio-scsi</code>\uff09\u3001\u90e8\u5206\u4f01\u4e1a\u7ea7\u7684 SAN \u7b49\u3002</p> \u5173\u6ce8\u5b58\u50a8\u7684\u53ef\u7528\u7a7a\u95f4\u6bd4\u4f8b <p>\u4e0d\u5efa\u8bae\u5c06\u5b58\u50a8\u7684\u53ef\u7528\u7a7a\u95f4\u5168\u90e8\u6216\u63a5\u8fd1\u5168\u90e8\u8017\u5c3d\uff0c\u8fd9\u662f\u56e0\u4e3a\uff1a</p> <ul> <li>\u673a\u68b0\u786c\u76d8\uff1a\u53ef\u7528\u7a7a\u95f4\u4e0d\u8db3\u65f6\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e3a\u4e86\u5b58\u50a8\u6570\u636e\uff0c\u4f1a\u4e0d\u5f97\u4e0d\u4ea7\u751f\u5927\u91cf\u78c1\u76d8\u788e\u7247\uff0c\u800c\u673a\u68b0\u786c\u76d8\u7684\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5f88\u5dee\uff1b</li> <li>\u56fa\u6001\u786c\u76d8\uff1a\u53ef\u7528\u7a7a\u95f4\u4e0d\u8db3\u4f1a\u5bfc\u81f4\u6ca1\u6709\u8db3\u591f\u7684\u7a7a\u533a\u5757\u6539\u5199\u5185\u5bb9\uff0c\u56e0\u6b64\u53ef\u80fd\u4e0d\u5f97\u4e0d\u5927\u91cf\u91cd\u590d\u64e6\u5199\u5df2\u6709\u7684\u533a\u5757\uff0c\u52a0\u901f\u78e8\u635f\u3002</li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u786e\u4fdd <code>fstrim.timer</code> \u5904\u4e8e\u542f\u7528\u72b6\u6001\u5373\u53ef\u3002\u4e00\u4e9b\u6587\u4ef6\u7cfb\u7edf\u4e5f\u652f\u6301\u8c03\u6574 trim/discard \u53c2\u6570\uff08\u7acb\u5373 discard \u6216\u5468\u671f\u6027 discard\uff0c \u4e00\u822c\u63a8\u8350\u540e\u8005\uff09\u3002</p>"},{"location":"ops/storage/#raid","title":"RAID","text":"<p>RAID\uff08Redundant Array of Inexpensive Disks\uff09\u662f\u4e00\u79cd\u5c06\u591a\u4e2a\u78c1\u76d8\u7ec4\u5408\u5728\u4e00\u8d77\u5b9e\u73b0\u6570\u636e\u5197\u4f59\u548c\u6027\u80fd\u63d0\u5347\u7684\u6280\u672f\u3002\u4e0d\u540c\u7684\u78c1\u76d8\u7ec4\u5408\u65b9\u5f0f\u79f0\u4e3a\u201cRAID \u7ea7\u522b\uff08RAID Level\uff09\u201d\uff0c\u5e38\u89c1\u7684\u6709 RAID 0\u3001RAID 1\u3001RAID 5\u3001RAID 6\u3001RAID 10 \u7b49\u3002</p> RAID 0 <p>\u4e5f\u79f0\u4f5c\u6761\u5e26\u5316\uff08Striped\uff09\uff0c\u5c06\u6570\u636e\u5206\u5757\u5b58\u50a8\u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u53ef\u4ee5\u5145\u5206\u5229\u7528\u6240\u6709\u5bb9\u91cf\uff0c\u83b7\u5f97\u53e0\u52a0\u7684\u987a\u5e8f\u8bfb\u5199\u6027\u80fd\uff08\u4f46\u968f\u673a\u8bfb\u5199\u6027\u80fd\u4e00\u822c\uff09\uff0c\u4f46\u6ca1\u6709\u5197\u4f59\uff0c\u4efb\u4f55\u4e00\u5757\u78c1\u76d8\u635f\u574f\u90fd\u4f1a\u5bfc\u81f4\u6574\u4e2a\u9635\u5217\u7684\u6570\u636e\u4e22\u5931\uff0c\u9002\u5408\u9700\u8981\u9ad8\u6027\u80fd\u8bfb\u5199\u4f46\u4e0d\u9700\u8981\u6570\u636e\u5b89\u5168\u6027\u7684\u573a\u666f\u3002</p> RAID 1 <p>\u4e5f\u79f0\u4f5c\u955c\u50cf\uff08Mirrored\uff09\uff0c\u5c06\u6570\u636e\u5b8c\u5168\u590d\u5236\u5230\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u63d0\u4f9b\u4e86\u7edd\u5bf9\u5197\u4f59\uff0c\u6574\u4e2a\u9635\u5217\u4e2d\u53ea\u9700\u8981\u6709\u4e00\u5757\u76d8\u5b58\u6d3b\uff0c\u6570\u636e\u5c31\u4e0d\u4f1a\u4e22\u5931\u3002\u4ee3\u4ef7\u662f\u6574\u4e2a\u9635\u5217\u7684\u5bb9\u91cf\u7b49\u5355\u5757\u78c1\u76d8\u7684\u5bb9\u91cf\uff0c\u7a7a\u95f4\u5229\u7528\u7387\u4f4e\u4e0b\uff0c\u9002\u5408\u9700\u8981\u9ad8\u53ef\u9760\u6027\u800c\u4e14\u4e0d\u7f3a\u94b1\u7684\u573a\u666f\u3002\u540c\u65f6\u7531\u4e8e\u6bcf\u5757\u76d8\u4e0a\u7684\u6570\u636e\u5b8c\u5168\u4e00\u81f4\uff0cRAID 1 \u7684\u8bfb\u53d6\u6027\u80fd\u53ef\u4ee5\u53e0\u52a0\uff08\u751a\u81f3\u5305\u62ec\u968f\u673a\u8bfb\u53d6\uff09\uff0c\u4f46\u5199\u5165\u6027\u80fd\u4e0d\u4f1a\u63d0\u5347\u3002</p> RAID 5 <p>\u5c06\u6570\u636e\u548c\u4e00\u4efd\u6821\u9a8c\u4fe1\u606f\u5206\u5757\u5b58\u50a8\u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u53ef\u4ee5\u5141\u8bb8\u9635\u5217\u4e2d\u4efb\u4f55\u4e00\u5757\u78c1\u76d8\u635f\u574f\uff0c\u517c\u987e\u5197\u4f59\u6027\u548c\u5bb9\u91cf\u5229\u7528\u7387\u3002\u91cd\u5efa\u671f\u95f4\u7684\u6027\u80fd\u4f1a\u4e25\u91cd\u4e0b\u964d\uff0c\u5e76\u4e14\u4e00\u65e6\u5728\u91cd\u5efa\u5b8c\u6210\u524d\u53c8\u574f\u4e86\u4e00\u5757\u76d8\uff0c\u90a3\u4e48\u4f60\u5c31\u5bc4\u4e86\u3002</p> RAID 6 <p>\u5c06\u6570\u636e\u548c\u4e24\u4efd\u6821\u9a8c\u4fe1\u606f\u5206\u5757\u5b58\u50a8\u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\uff0c\u6bd4 RAID 5 \u591a\u4e86\u4e00\u4efd\u6821\u9a8c\u4fe1\u606f\uff0c\u53ef\u4ee5\u5bb9\u7eb3\u4e24\u5757\u78c1\u76d8\u635f\u574f\uff0c\u9002\u5408\u5927\u5bb9\u91cf\u6216\u8005\u78c1\u76d8\u8f83\u591a\u7684\u9635\u5217\u3002\u5c3d\u7ba1\u5141\u8bb8\u4e24\u5757\u76d8\u635f\u574f\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u5efa\u8bae\u5728\u7b2c\u4e00\u5757\u76d8\u635f\u574f\u540e\u7acb\u5373\u66f4\u6362\u5e76\u91cd\u5efa\uff0c\u4e0d\u8981\u7b49\u5230\u66f4\u5371\u9669\u7684\u65f6\u5019\u3002</p> RAID 10, 50, 60 <p>\u5c06\u4e0d\u540c\u7ea7\u522b\u7684 RAID \u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u517c\u987e\u6027\u80fd\u548c\u5197\u4f59\uff0c\u5404\u53d6\u6240\u957f\uff0c\u5bf9\u4e8e 10 \u5757\u76d8\u4ee5\u4e0a\u7684\u9635\u5217\u662f\u66f4\u52a0\u5e38\u89c1\u7684\u9009\u62e9\u3002\u4f8b\u5982 RAID 10 = RAID 1 + RAID 0\uff0c\u901a\u5e38\u5c06\u6bcf\u4e24\u5757\u76d8\u7ec4\u6210 RAID 1\uff0c\u518d\u5c06\u8fd9\u4e9b RAID 1 \u7684\u7ec4\u5408\u62fc\u6210\u4e00\u4e2a\u5927 RAID 0\u3002</p> <p>\u78c1\u76d8\u9635\u5217\u4e0d\u662f\u5907\u4efd</p> <p>RAID \u4e0d\u662f\u5907\u4efd\uff0c\u5b83\u53ef\u4ee5\u5b9e\u73b0\u5728\u67d0\u5757\u78c1\u76d8\u6545\u969c\u65f6\u4fdd\u8bc1\u7cfb\u7edf\u7ee7\u7eed\u8fd0\u884c\uff0c\u4f46\u662f\u4e0d\u80fd\u5728\u6570\u636e\u8bef\u5220\u9664\u3001\u81ea\u7136\u707e\u5bb3\u3001\u4eba\u4e3a\u7834\u574f\u7b49\u60c5\u51b5\u4e0b\u4fdd\u62a4\u6570\u636e\u3002</p> <p></p> <p>\u56fe\u7247\u6765\u81ea\u91d1\u67aa\u9c7c\u4e4b\u591c\uff1a\u5b9e\u9a8c\u7269\u7406\u5783\u573e\u4f6c\u4e4b\u4e50\u2014\u2014PB \u7ea7\u78c1\u76d8\u9635\u5217\u6f14\u8fdb</p>"},{"location":"ops/storage/#raid_1","title":"RAID \u7b49\u7ea7\u6bd4\u8f83","text":"\u7b49\u7ea7 \u5bb9\u91cf \u5197\u4f59 \u8bfb\u5199\u6027\u80fd \u9002\u7528\u573a\u666f RAID 0 \u5168\u90e8\u53e0\u52a0 \u65e0\uff0c\u6302\u4e00\u5757\u76d8\u5c31\u5bc4\u4e86 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u9ad8\uff0c\u968f\u673a\u8bfb\u5199\u6027\u80fd\u4e00\u822c\uff08\u7565\u597d\u4e8e\u5355\u5757\u76d8\uff09 \u4e34\u65f6\u6570\u636e\u3001\u7f13\u5b58 RAID 1 \u5355\u5757\u76d8 \u6700\u9ad8\uff0c\u53ea\u8981\u6709\u4e00\u5757\u76d8\u5b58\u6d3b\u5c31\u884c \u53e0\u52a0\u7684\u8bfb\u6027\u80fd\uff0c\u4f46\u662f\u53ea\u6709\u5355\u5757\u76d8\u7684\u5199\u6027\u80fd \u91cd\u8981\u6570\u636e RAID 5 N-1 \u5757\u76d8 \u53ef\u4ee5\u574f\u4e00\u5757\u76d8 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u9ad8\uff0c\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5dee\uff1b\u91cd\u5efa\u671f\u95f4\u5f88\u5dee \u517c\u987e\u5bb9\u91cf\u548c\u5b89\u5168\u6027 RAID 6 N-2 \u5757\u76d8 \u53ef\u4ee5\u574f\u4e24\u5757\u76d8 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u9ad8\uff0c\u968f\u673a\u8bfb\u5199\u6027\u80fd\u5dee\uff1b\u91cd\u5efa\u671f\u95f4\u66f4\u5dee \u6bd4 RAID 5 \u66f4\u7a33\u4e00\u70b9 RAID 10 \u6bcf\u7ec4 RAID 1 \u5bb9\u91cf\u53e0\u52a0 \u6bcf\u7ec4 RAID 1 \u5185\u53ea\u9700\u8981\u5b58\u6d3b\u4e00\u5757\u76d8 \u987a\u5e8f\u548c\u968f\u673a\u6027\u80fd\u90fd\u4e0d\u9519\uff0c\u5e76\u4e14\u91cd\u5efa\u671f\u95f4\u8fd8\u51d1\u5408 \u517c\u987e\u6027\u80fd\u548c\u5b89\u5168\u6027 RAID 60 \uff08\u81ea\u884c\u8ba1\u7b97\uff09 \u6bcf\u7ec4 RAID 6 \u5185\u53ef\u4ee5\u574f\u4e24\u5757\u76d8 \u987a\u5e8f\u8bfb\u5199\u6027\u80fd\u4e0d\u9519\uff0c\u5e76\u4e14\u91cd\u5efa\u671f\u95f4\u66f4\u51d1\u5408\u4e86 \u76d8\u5f88\u591a\uff0c\u5e76\u4e14\u517c\u987e\u5bb9\u91cf\u548c\u5b89\u5168\u6027 <p>RAID 4 \u548c RAID 50 \u5728\u8fd9\u91cc\u4e0d\u4f5c\u8ba8\u8bba\uff0c\u56e0\u4e3a\u5b83\u4eec\u6ca1\u4eba\u7528\u3002</p> <p>\u601d\u8003\u9898</p> <ol> <li>\u4e3a\u4ec0\u4e48 RAID 5 \u548c RAID 6 \u7684\u91cd\u5efa\u671f\u95f4\u6027\u80fd\u4f1a\u5f88\u5dee\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u5c06\u5927\u91cf\u7684\u78c1\u76d8\u7ec4\u5408\u6210\u5355\u4e2a RAID 6 \u4e0d\u662f\u4e00\u4e2a\u597d\u4e3b\u610f\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u5bf9\u5927\u5bb9\u91cf\u78c1\u76d8\u4f7f\u7528 RAID 5 \u662f\u4e00\u4e2a\u574f\u4e3b\u610f\uff1f</li> <li>\u4e3a\u4ec0\u4e48\u8bf4 RAID 5/6 \u6709\u5f88\u9ad8\u7684\u5199\u60e9\u7f5a\uff08Write Penalty\uff09\uff1f</li> </ol>"},{"location":"ops/storage/#raid_2","title":"RAID \u5b9e\u73b0\u65b9\u5f0f","text":"<p>RAID \u53ef\u4ee5\u5728\u786c\u4ef6\u5c42\u9762\u5b9e\u73b0\uff0c\u4e5f\u53ef\u4ee5\u5728\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u901a\u8fc7\u8f6f\u4ef6\u5b9e\u73b0\u3002</p> <p>\u786c\u4ef6\uff1a</p> <ul> <li>LSI MegaRAID \u7cfb\u5217\u662f\u6700\u5e38\u89c1\u7684\u786c\u4ef6 RAID \u5361</li> <li>HPE Smart Array \u7cfb\u5217</li> <li>\u4e00\u4e9b\u4e13\u7528\u7684\u5b58\u50a8\u670d\u52a1\u5668\uff0c\u5982 HPE MSA\u3001Dell EMC PowerVault \u7b49\u5b58\u50a8\u7f51\u7edc\uff08SAN\uff09\u8bbe\u5907</li> <li>Intel RST \u548c Intel VMD\uff0c\u662f\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e0a\u5e38\u89c1\u7684\u786c\u4ef6 RAID \u65b9\u6848\uff08\u4f46\u662f\u975e\u5e38\u96be\u7528\uff09</li> </ul> <p>Windows\uff1a</p> <ul> <li>\u8f83\u65e9\u7684\u201c\u52a8\u6001\u78c1\u76d8\u201d\u529f\u80fd\u652f\u6301 RAID 0\u30011\u30015 \u7b49\u7ea7\u522b\uff0c\u5e76\u4e14\u662f\u5728\u5206\u533a\u5c42\u9762\u5b9e\u73b0\u7684\uff0c\u56e0\u6b64\u540c\u4e00\u4e2a\u786c\u76d8\u7ec4\u4e0a\u53ef\u4ee5\u540c\u65f6\u5b58\u5728\u591a\u4e2a\u91c7\u7528\u4e0d\u540c RAID \u7ea7\u522b\u7684\u5377\uff08\u6587\u4ef6\u7cfb\u7edf\uff09</li> <li>\u8f83\u65b0\u7684 Windows \u5f00\u59cb\u652f\u6301 Storage Spaces\uff0c\u53ef\u4ee5\u5b9e\u73b0\u66f4\u591a RAID \u7ea7\u522b\uff0c\u4ee5\u53ca\u201c\u955c\u50cf\u52a0\u901f\u201d\u3001\u201c\u81ea\u52a8\u70ed\u8fc1\u79fb\u201d\u7b49\u529f\u80fd\uff0c\u4f46\u662f\u6bd4\u52a8\u6001\u78c1\u76d8\u66f4\u52a0\u96be\u7528\uff0c\u91cd\u5efa\u4e5f\u66f4\u590d\u6742</li> </ul> <p>Linux\uff1a</p> <ul> <li>mdadm \u662f Linux \u4e0a\u6700\u5e38\u89c1\u7684\u8f6f\u4ef6 RAID \u5b9e\u73b0\u65b9\u5f0f\u4e4b\u4e00</li> <li>Linux \u5e38\u7528\u7684\u903b\u8f91\u5377\u7ba1\u7406\u5de5\u5177 LVM \u4e5f\u652f\u6301 RAID \u529f\u80fd</li> <li>\u4e00\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\uff0c\u5982 ZFS \u548c Btrfs\uff0c\u4e5f\u652f\u6301 RAID \u529f\u80fd</li> </ul> <p>\u670d\u52a1\u5668\u4e00\u822c\u90fd\u914d\u5907\u4e86\u786c\u4ef6 RAID \u5361\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u8f6f\u4ef6 RAID\uff0c\u9700\u8981\u8bbe\u7f6e RAID \u5361\u6216\u5bf9\u5e94\u78c1\u76d8\u5230 HBA \u6a21\u5f0f\uff08\u4e5f\u53eb JBOD/Non-RAID/\u76f4\u901a \u6a21\u5f0f\uff09\u3002 \u4e00\u90e8\u5206\u4f4e\u7aef RAID \u5361\u4e0d\u63d0\u4f9b\u76f8\u5173\u529f\u80fd\u7684\u652f\u6301\uff0c\u5c3d\u7ba1\u53ef\u4ee5\u901a\u8fc7\u4e3a\u6bcf\u5757\u78c1\u76d8\u521b\u5efa\u5355\u72ec\u7684 RAID 0 \u9635\u5217\u5b9e\u73b0\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u3002</p>"},{"location":"ops/storage/#_2","title":"\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u5728 Linux \u4e0a\uff0cext4 \u662f\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u4f46\u662f\u5bf9\u4e8e\u67d0\u4e9b\u9700\u6c42\uff0cext4 \u53ef\u80fd\u65e0\u6cd5\u6ee1\u8db3\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u9700\u8981\u652f\u6301\u5b58\u50a8\u5927\u91cf\u6587\u4ef6\uff0c\u6570\u91cf\u751a\u81f3\u53ef\u80fd\u8d85\u8fc7 ext4 \u7684\u9650\u5236</li> <li>\u9700\u8981\u652f\u6301\u5feb\u7167\u3001\u900f\u660e\u538b\u7f29\u3001\u6570\u636e\u6821\u9a8c\u7b49\u9ad8\u7ea7\u529f\u80fd</li> </ul> <p>\u5728\u300c\u5206\u533a\u4e0e\u6587\u4ef6\u7cfb\u7edf\u300d\u90e8\u5206\u4f1a\u5bf9\u6587\u4ef6\u7cfb\u7edf\u7684\u9009\u62e9\u8fdb\u884c\u4ecb\u7ecd\u3002</p> <ol> <li> <p>IOPS \u4e3a\u6bcf\u79d2\u7684 I/O \u64cd\u4f5c\u6570\uff0c\u53ef\u4ee5\u7b80\u5355\u8ba4\u4e3a\u662f\u547d\u4ee4\u64cd\u4f5c\u5ef6\u8fdf\u7684\u5012\u6570\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/filesystem/","title":"\u5206\u533a\u4e0e\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u672c\u6587\u521d\u7a3f\u5df2\u5b8c\u6210\uff0c\u4f46\u53ef\u80fd\u4ecd\u9700\u5927\u5e45\u5ea6\u4fee\u6539</p>"},{"location":"ops/storage/filesystem/#_2","title":"\u76f8\u5173\u6982\u5ff5","text":"\u5757\u8bbe\u5907 <p>\u5e38\u89c1\u7684\u78c1\u76d8\u8bbe\u5907\u7684\u8bfb\u5199\u5747\u4ee5\u5757\uff08\u800c\u4e0d\u662f\u5b57\u8282\uff09\u4e3a\u5355\u4f4d\uff0c\u56e0\u6b64\u5728 Linux \u4e2d\uff0c\u8bbe\u5907\u6587\u4ef6\u5206\u4e3a\u5757\u8bbe\u5907\u548c\u5b57\u7b26\u8bbe\u5907\u4e24\u79cd\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>lsblk</code> \u547d\u4ee4\u67e5\u770b\u7cfb\u7edf\u4e2d\u7684\u5757\u8bbe\u5907\u3002\u4e00\u4e2a\u684c\u9762\u7cfb\u7edf\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nnvme0n1     259:0    0  1.9T  0 disk \n\u251c\u2500nvme0n1p1 259:1    0  260M  0 part \n\u251c\u2500nvme0n1p2 259:2    0   56G  0 part [SWAP]\n\u2514\u2500nvme0n1p3 259:3    0  1.8T  0 part /var/lib/docker/btrfs\n                                     /var\n                                     /tmp\n                                     /opt\n                                     /home\n                                     /\n</code></pre> \u5206\u533a\u8868 <p>\u4e00\u4e2a\u5757\u8bbe\u5907\u4e0a\u53ef\u4ee5\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5206\u533a\uff0c\u800c\u5206\u533a\u8868\u5219\u8bb0\u5f55\u4e86\u5206\u533a\u7684\u4fe1\u606f\uff0c\u5e38\u89c1\u7684\u5206\u533a\u8868\u6709 MBR \u548c GPT \u4e24\u79cd\u683c\u5f0f\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>fdisk</code> \u67e5\u770b\u5757\u8bbe\u5907\u7684\u5206\u533a\u8868\uff0c\u4f8b\u5982\uff1a</p> <pre><code>$ sudo fdisk -l /dev/nvme0n1\nDisk /dev/nvme0n1: 1.86 TiB, 2048408248320 bytes, 4000797360 sectors\nDisk model: INTEL SSDPEKNU020TZ                     \nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: BAF03C52-854E-41AD-9C42-6DD5C0E9F156\n\nDevice             Start        End    Sectors  Size Type\n/dev/nvme0n1p1      2048     534527     532480  260M EFI System\n/dev/nvme0n1p2    534528  117975039  117440512   56G Linux swap\n/dev/nvme0n1p3 117975040 4000796671 3882821632  1.8T Linux filesystem\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u5757\u8bbe\u5907\u4f7f\u7528\u4e86 GPT \u5206\u533a\u8868\uff0c\u6709\u4e09\u4e2a\u5206\u533a\u3002</p> \u6587\u4ef6\u7cfb\u7edf <p>\u6bcf\u4e2a\u5206\u533a\u9700\u8981\u88ab\u683c\u5f0f\u5316\u6210\u67d0\u79cd\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c\u624d\u80fd\u5b58\u50a8\u6587\u4ef6\u3002</p>"},{"location":"ops/storage/filesystem/#_3","title":"\u672c\u5730\u56de\u73af","text":"<p>Linux \u652f\u6301\u300c\u672c\u5730\u56de\u73af\u8bbe\u5907\u300d\uff0c\u652f\u6301\u6302\u8f7d\u4e00\u4e2a\u6587\u4ef6\u4f5c\u4e3a\u5757\u8bbe\u5907\u4f7f\u7528\uff0c\u7c7b\u4f3c\u4e8e\u300c\u865a\u62df\u5149\u9a71\u300d\u7c7b\u8f6f\u4ef6\u3002 \u56e0\u6b64\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u5730\u56de\u73af\u7684\u65b9\u5f0f\uff0c\u5728\u4e0d\u8d2d\u4e70\u65b0\u786c\u4ef6\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u4e00\u4e9b\u78c1\u76d8\u76f8\u5173\u7684\u5b9e\u9a8c\u3002</p> <p>\u672c\u5730\u56de\u73af\u4e0e\u5bb9\u5668</p> <p>Linux \u76ee\u524d\u4e0d\u652f\u6301\u8bbe\u5907\u547d\u540d\u7a7a\u95f4\uff08\u9694\u79bb\uff09\uff0c\u56e0\u6b64\u5982\u679c\u9700\u8981\u5728\u5bb9\u5668\u73af\u5883\u5185\u5bf9\u672c\u5730\u56de\u73af\u8fdb\u884c\u6302\u8f7d\u7b49\u64cd\u4f5c\uff0c\u9700\u8981\u7279\u6743\u5bb9\u5668\uff0c\u5e76\u4e14\u4e3a root \u6743\u9650\u3002 Linux \u5185\u6838\u5f00\u53d1\u4e2d\u66fe\u6709\u8fc7\u5141\u8bb8\u975e\u7279\u6743\u7528\u6237\u6302\u8f7d\u672c\u5730\u56de\u73af\u7684\u8ba8\u8bba\uff08loopfs LWN\uff09\uff0c \u4f46\u662f\u7531\u4e8e\u5b89\u5168\u6027\u95ee\u9898\uff08\u5185\u6838\u6587\u4ef6\u7cfb\u7edf\u5f00\u53d1\u65f6\u5047\u8bbe\u6302\u8f7d\u7684\u5185\u5bb9\u4e0d\u4f1a\u88ab\u6076\u610f\u6784\u9020\uff0c\u800c\u63d0\u4f9b\u76f8\u5173\u652f\u6301\u4f1a\u7834\u574f\u8fd9\u6837\u7684\u5047\u8bbe\uff09\uff0c\u672a\u8fdb\u5165\u4e3b\u7ebf\u3002</p> <p>\u8fd9\u4e5f\u662f Vlab \u4e0d\u652f\u6301\u672c\u5730\u56de\u73af\u7684\u539f\u56e0\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528 <code>mount</code> \u547d\u4ee4\u6302\u8f7d\u6587\u4ef6\u5230\u672c\u5730\u56de\u73af\u3002\u6700\u5e38\u89c1\u7684\u7528\u9014\u662f\u6302\u8f7d\u4e00\u4e2a ISO \u6587\u4ef6\uff1a</p> <pre><code>$ sudo mount -o loop ./debian-12.4.0-amd64-DVD-1.iso /media/iso\n$ cd /media/iso\n$ ls\nboot/  debian@  doc/  firmware/  install.amd/  md5sum.txt  pool/        README.mirrors.html  README.source\ncss/   dists/   EFI/  install/   isolinux/     pics/       README.html  README.mirrors.txt   README.txt\n$ cd\n$ sudo umount /media/iso\n</code></pre> <p>\u4f46\u662f\u6709\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u6302\u8f7d\u6d4b\u8bd5\u78c1\u76d8\u955c\u50cf\u4e2d\u7684\u67d0\u4e2a\u5206\u533a\uff0c\u6b64\u65f6\u4f7f\u7528 <code>mount</code> \u5c31\u4f1a\u9ebb\u70e6\u5f88\u591a\u2014\u2014\u9700\u8981\u8ba1\u7b97\u5bf9\u5e94\u7684\u504f\u79fb\u91cf\u3002 \u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528 <code>kpartx</code> \u547d\u4ee4\uff0c\u5b83\u4f1a\u81ea\u52a8\u8bc6\u522b\u78c1\u76d8\u955c\u50cf\u4e2d\u7684\u5206\u533a\uff0c\u5e76\u521b\u5efa\u5bf9\u5e94\u7684\u56de\u73af\u8bbe\u5907\uff1a</p> <pre><code>$ fdisk -l ./root.img\nDisk ./root.img: 5 GiB, 5368709120 bytes, 10485760 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: 9E89351F-1674-4BA6-9FA3-D063E7C028E0\n\nDevice       Start      End Sectors  Size Type\n./root.img1   2048   499711  497664  243M EFI System\n./root.img2 499712 10483711 9984000  4.8G Linux filesystem\n$ sudo kpartx -av ./root.img\nadd map loop0p1 (254:0): 0 497664 linear 7:0 2048\nadd map loop0p2 (254:1): 0 9984000 linear 7:0 499712\n$ ls -l /dev/mapper/loop0p*\nlrwxrwxrwx 1 root root 7 Feb 10 17:22 /dev/mapper/loop0p1 -&gt; ../dm-0\nlrwxrwxrwx 1 root root 7 Feb 10 17:22 /dev/mapper/loop0p2 -&gt; ../dm-1\n$ sudo mount /dev/mapper/loop0p2 /media/root\n$ ls /media/root\n...\n$ sudo umount /media/root\n$ sudo kpartx -dv ./root.img\ndel devmap : loop0p1\ndel devmap : loop0p2\nloop deleted : /dev/loop0\n</code></pre> <p>\u7cfb\u7edf\u7684\u672c\u5730\u56de\u73af\u4fe1\u606f\u53ef\u4ee5\u4f7f\u7528 <code>losetup</code> \u547d\u4ee4\u67e5\u770b\u3002\u8be5\u547d\u4ee4\u4e5f\u53ef\u4ee5\u7ba1\u7406\u672c\u5730\u56de\u73af\u8bbe\u5907\uff1a</p> <pre><code>$ sudo kpartx -av ./root.img\n...\n$ sudo losetup -a\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ sudo losetup -D\n$ sudo losetup -a  # \u6b63\u5728\u4f7f\u7528\u7684\u8bbe\u5907\u4e0d\u4f1a\u88ab\u7acb\u523b\u5220\u9664\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ sudo losetup --partscan --find ./root2.img  # partscan \u7528\u4e8e\u81ea\u52a8\u8bc6\u522b\u5206\u533a\uff0cfind \u7528\u4e8e\u81ea\u52a8\u5206\u914d\u672c\u5730\u56de\u73af\u8bbe\u5907\n$ # \u4e5f\u53ef\u4ee5\u81ea\u5df1\u6307\u5b9a\u672c\u5730\u56de\u73af\u8bbe\u5907\u8def\u5f84\n$ sudo losetup -a\n/dev/loop1: [0028]:18789360 (/home/username/tmp/root2.img)\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ ls -lha /dev/loop1*  # \u8be5\u955c\u50cf\u4e2d\u5305\u542b\u7684\u4e24\u4e2a\u5206\u533a\u81ea\u52a8\u8bc6\u522b\u4e3a\u4e86 loop1p1 \u548c loop1p2\nbrw-rw---- 1 root disk   7, 1 Feb 10 17:30 /dev/loop1\nbrw-rw---- 1 root disk 259, 4 Feb 10 17:30 /dev/loop1p1\nbrw-rw---- 1 root disk 259, 5 Feb 10 17:30 /dev/loop1p2\n$ sudo losetup -d /dev/loop1\n$ sudo losetup -a\n/dev/loop0: [0028]:18723300 (/home/username/tmp/root.img)\n$ sudo kpax -dv ./root.img  # \u6e05\u7406\u73b0\u573a\n$ sudo losetup -a\n</code></pre>"},{"location":"ops/storage/filesystem/#_4","title":"\u5206\u533a\u8868","text":"<p>\u4ee5\u4e0b\u4ecb\u7ecd MBR \u4e0e GPT \u5206\u533a\u8868\u3002</p> <p>MBR\uff08Master Boot Record\uff09\u5206\u533a\u8868\u662f\u65e9\u671f\u7684\u5206\u533a\u8868\u683c\u5f0f\uff0c\u5728\u5b58\u50a8\u5206\u533a\u4fe1\u606f\u7684\u540c\u65f6\uff0c\u8fd8\u8d1f\u8d23\u7cfb\u7edf\u7684\u542f\u52a8\u3002 MBR \u4fe1\u606f\u5b58\u50a8\u5728\u78c1\u76d8\u7684\u7b2c\u4e00\u4e2a\u6247\u533a<sup>1</sup>\uff08512 \u5b57\u8282<sup>2</sup>\uff09\uff0c\u5176\u4e2d\u7528\u4e8e\u5f15\u5bfc\u7684\u4ee3\u7801\u4f4d\u4e8e\u6700\u5f00\u5934\uff0c\u5360\u636e 440 \u5b57\u8282\uff08BIOS \u5728\u542f\u52a8\u4f1a\u52a0\u8f7d\u4ee3\u7801\uff0c\u5e76\u4e14\u8df3\u8f6c\uff09\uff1b \u63d0\u4f9b\u7ed9\u5206\u533a\u4fe1\u606f\u7684\u7a7a\u95f4\u53ea\u6709 64 \u4e2a\u5b57\u8282\u3002\u7531\u4e8e\u6bcf\u4e2a\u5206\u533a\u9700\u8981 16 \u5b57\u8282\u7684\u4fe1\u606f\uff0c\u56e0\u6b64 MBR \u5206\u533a\u8868\u6700\u591a\u652f\u6301 4 \u4e2a\u4e3b\u5206\u533a\u3002 \u4e3a\u4e86\u8ba9\u78c1\u76d8\u652f\u6301\u66f4\u591a\u5206\u533a\uff0c\u51fa\u73b0\u4e86\u6269\u5c55\u5206\u533a\u7684\u6982\u5ff5\u3002 \u6269\u5c55\u5206\u533a\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u4e3b\u5206\u533a\uff0c\u53ef\u4ee5\u5212\u5206\u4e3a\u591a\u4e2a\u903b\u8f91\u5206\u533a\u3002\u53d7\u5230\u8bbe\u8ba1\u9650\u5236\uff0cMBR \u4ec5\u652f\u6301\u6700\u5927 2 TiB \u7684\u78c1\u76d8\u3002</p> <p>\u800c GPT\uff08GUID Partition Table\uff09\u5206\u533a\u8868\u662f\u65b0\u4e00\u4ee3\u7684\u5206\u533a\u8868\u683c\u5f0f\uff0c\u4e0d\u518d\u5b58\u50a8\u5f15\u5bfc\u4fe1\u606f\uff0c\u5e76\u4e14\u652f\u6301\u66f4\u591a\u7684\u5206\u533a\u3001\u66f4\u5927\u7684\u78c1\u76d8\u3002 \u76ee\u524d\u9664\u975e\u6781\u5176\u8001\u65e7\u7684\u7cfb\u7edf\uff0c\u90fd\u4f7f\u7528 GPT \u5206\u533a\u8868\u3002GPT \u5206\u533a\u8868\u5728\u6700\u5f00\u5934\u5b58\u50a8\u4e86\u4e00\u4efd\u300c\u4fdd\u62a4\u6027 MBR\u300d\uff08Protective MBR\uff09\uff0c\u7528\u4e8e\u9632\u6b62\u4e0d\u8ba4\u8bc6 GPT \u7684\u65e7\u7cfb\u7edf\u548c\u8f6f\u4ef6\u5bf9\u78c1\u76d8\u8bef\u64cd\u4f5c\uff0c \u540c\u65f6\u5206\u533a\u8868\u4fe1\u606f\u5728\u78c1\u76d8\u6700\u540e\u6709\u4e00\u4efd\u5907\u4efd\uff0c\u4ee5\u51cf\u5c0f\u635f\u574f\u98ce\u9669\u3002</p> <p>\u90a3 GPT \u7684\u78c1\u76d8\u600e\u4e48\u5f00\u673a\u5462\uff1f</p> <p>\u5bf9\u4e8e\u4f7f\u7528\u4f20\u7edf BIOS \u7684\u673a\u5668\uff0cGPT \u5f00\u5934\u7684\u4fdd\u62a4\u6027 MBR \u4ecd\u7136\u53ef\u4ee5\u5b58\u50a8\u5f15\u5bfc\u4ee3\u7801\u3002\u4e0d\u8fc7\uff0c\u76ee\u524d\u7684\u4e3b\u6d41\u662f\u4f7f\u7528 UEFI\uff0c\u4e0d\u518d\u9700\u8981\u5728\u6247\u533a\u91cc\u5b58\u50a8\u5f15\u5bfc\u4ee3\u7801\uff0c \u800c\u662f\u6709\u4e00\u4e2a\u4e13\u95e8\u7684 EFI \u7cfb\u7edf\u5206\u533a\uff08\u5fc5\u987b\u683c\u5f0f\u5316\u4e3a FAT32\uff09\uff0c\u7528\u6765\u5b58\u50a8\u5f15\u5bfc\u7a0b\u5e8f\u4e0e\u5176\u4ed6\u4fe1\u606f\u3002</p> <p>\u4ee5\u4e0b\u5c55\u793a\u4e00\u4e2a EFI \u7cfb\u7edf\u5206\u533a\u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo mount /dev/disk/by-uuid/0E62-46C6 /efi\n$ mount | grep efi\n...\n/dev/nvme0n1p1 on /efi type vfat (rw,relatime,fmask=0077,dmask=0077,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro)\n$ sudo tree /efi\n/efi/\n\u251c\u2500\u2500 $RECYCLE.BIN\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 desktop.ini\n\u251c\u2500\u2500 BOOT\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 BOOT.SDI\n\u251c\u2500\u2500 EFI\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 arch\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 fw\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 fwupdx64.efi\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Boot\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 bootx64.efi\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 LenovoBT.EFI\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 License.txt\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 ReadMe.txt\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 GRUB\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 grubx64.efi\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 Linux\n\u2514\u2500\u2500 System Volume Information\n    \u251c\u2500\u2500 IndexerVolumeGuid\n    \u2514\u2500\u2500 WPSettings.dat\n\n10 directories, 10 files\n</code></pre> <p>\u8fd9\u91cc <code>efi</code> \u540e\u7f00\u7684\u6587\u4ef6\u5c31\u662f UEFI \u4f1a\u9009\u62e9\u7684\u542f\u52a8\u5f15\u5bfc\u7a0b\u5e8f\uff0c\u4e00\u822c\u53ef\u4ee5\u5728\u542f\u52a8\u65f6\u6309\u4e0b F12 \u6216\u8005\u5176\u4ed6\u5feb\u6377\u952e\u9009\u62e9\u542f\u52a8\u7684\u8bbe\u5907\u6216 EFI \u6587\u4ef6\u3002</p>"},{"location":"ops/storage/filesystem/#_5","title":"\u5b9e\u9a8c\u64cd\u4f5c\u5c55\u793a","text":"<p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u8bf8\u5982 <code>fdisk</code>, <code>parted</code> \u7b49\u5de5\u5177\u5bf9\u5206\u533a\u8868\u8fdb\u884c\u64cd\u4f5c\u3002\u5bf9\u4e8e\u56fe\u5f62\u754c\u9762\u7528\u6237\uff0c<code>gparted</code> \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u7a7a\u6587\u4ef6\uff1a</p> <pre><code>truncate -s 8G test.img\n</code></pre> <p>\u7a00\u758f\u6587\u4ef6</p> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u300c\u7a00\u758f\u6587\u4ef6\u300d\uff08Sparse file\uff09\u3002\u5c3d\u7ba1\u6587\u4ef6\u5927\u5c0f\u662f 8G\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u53ea\u5360\u7528\u4e86\u5f88\u5c11\u7684\u78c1\u76d8\u7a7a\u95f4\u3002\u53ef\u4ee5\u4ee5\u6b64\u9a8c\u8bc1\uff1a</p> <pre><code>$ du -h test.img\n0   test.img\n$ du -h --apparent-size test.img\n8G  test.img\n</code></pre> <p>\u4e4b\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5c\u8fd9\u4e2a\u6587\u4ef6\uff0c\u800c\u4e0d\u7528\u62c5\u5fc3\u7834\u574f\u771f\u5b9e\u7684\u78c1\u76d8\u3002</p> <pre><code>fdisk test.img\n# \u6216\u8005\nparted test.img\n</code></pre> <p>\u4ee5\u4e0b\u7684\u4f8b\u5b50\u4f1a\u521b\u5efa\u4e00\u4e2a 256M \u7684 EFI \u5206\u533a\uff0c\u4e00\u4e2a 1G \u7684 swap \u5206\u533a\uff0c\u5269\u4e0b\u7684\u7a7a\u95f4\u4f5c\u4e3a\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u5206\u533a\u3002</p> fdisk \u64cd\u4f5c\u793a\u4f8b <p>fdisk \u9ed8\u8ba4\u4f7f\u7528 MBR \u5206\u533a\u8868\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528 GPT \u5206\u533a\u8868\uff0c\u9700\u8981\u4f7f\u7528 <code>g</code> \u547d\u4ee4\u3002 \u5728\u521b\u5efa\u5206\u533a\u65f6\uff0c\u6309\u56de\u8f66\u4f7f\u7528\u9ed8\u8ba4\u53c2\u6570\u3002\u8bbe\u7f6e\u5206\u533a\u672b\u5c3e\u4f4d\u7f6e\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>+</code> \u8868\u793a\u76f8\u5bf9\u4e8e\u5f53\u524d\u4f4d\u7f6e\u7684\u504f\u79fb\u91cf\uff08\u5373\u5206\u533a\u5927\u5c0f\uff09\uff0c\u6216\u8005\u4f7f\u7528 <code>-</code> \u8868\u793a\u76f8\u5bf9\u4e8e\u78c1\u76d8\u672b\u5c3e\u7684\u504f\u79fb\u91cf\uff08\u5373\u5728\u5c3e\u90e8\u7559\u51fa\u591a\u5c11\u7a7a\u95f4\uff09\u3002</p> <p>\u6700\u540e\u4f7f\u7528 <code>w</code> \u547d\u4ee4\u5199\u5165\u5206\u533a\u8868\u3002\u5982\u679c\u4e0d\u60f3\u5b9e\u9645\u5199\u5165\u5230\u78c1\u76d8\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>q</code> \u9000\u51fa\u800c\u4e0d\u4fdd\u5b58\u3002 \u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u4f7f\u7528 <code>m</code> \u547d\u4ee4\u67e5\u770b\u5e2e\u52a9\u3002</p> <pre><code>$ fdisk test.img\nWelcome to fdisk (util-linux 2.39.3).\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\nDevice does not contain a recognized partition table.\nCreated a new DOS (MBR) disklabel with disk identifier 0xb7358160.\n\nCommand (m for help): g\nCreated a new GPT disklabel (GUID: E19C12C2-CAB9-4A9A-88D5-2F389F7B4452).\n\nCommand (m for help): n\nPartition number (1-128, default 1): \nFirst sector (2048-16777182, default 2048): \nLast sector, +/-sectors or +/-size{K,M,G,T,P} (2048-16777182, default 16775167): +256M\n\nCreated a new partition 1 of type 'Linux filesystem' and of size 256 MiB.\n\nCommand (m for help): n\nPartition number (2-128, default 2): \nFirst sector (526336-16777182, default 526336): \nLast sector, +/-sectors or +/-size{K,M,G,T,P} (526336-16777182, default 16775167): +1G\n\nCreated a new partition 2 of type 'Linux filesystem' and of size 1 GiB.\n\nCommand (m for help): n\nPartition number (3-128, default 3): \nFirst sector (2623488-16777182, default 2623488): \nLast sector, +/-sectors or +/-size{K,M,G,T,P} (2623488-16777182, default 16775167): \n\nCreated a new partition 3 of type 'Linux filesystem' and of size 6.7 GiB.\n\nCommand (m for help): t\nPartition number (1-3, default 3): 1\nPartition type or alias (type L to list all): L\n\uff08\u7701\u7565\uff09\nPartition type or alias (type L to list all): 1\n\nChanged type of partition 'Linux filesystem' to 'EFI System'.\n\nCommand (m for help): t\nPartition number (1-3, default 3): 2\nPartition type or alias (type L to list all): 19\n\nChanged type of partition 'Linux filesystem' to 'Linux swap'.\n\nCommand (m for help): p\nDisk test.img: 8 GiB, 8589934592 bytes, 16777216 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: E19C12C2-CAB9-4A9A-88D5-2F389F7B4452\n\nDevice       Start      End  Sectors  Size Type\ntest.img1     2048   526335   524288  256M EFI System\ntest.img2   526336  2623487  2097152    1G Linux swap\ntest.img3  2623488 16775167 14151680  6.7G Linux filesystem\n\nCommand (m for help): w\nThe partition table has been altered.\nSyncing disks.\n</code></pre> parted \u64cd\u4f5c\u793a\u4f8b <p>\u8fd9\u91cc\u4e0d\u63a8\u8350\u4ea4\u4e92\u5f0f\u4f7f\u7528 <code>parted</code>\uff0c\u56e0\u4e3a\u5176\u4ea4\u4e92\u4e0d\u5982 <code>fdisk</code> \u76f4\u89c2\uff0c\u5e76\u4e14\u6240\u6709\u64cd\u4f5c\u5747\u4e3a\u7acb\u523b\u5199\u5165\u3002\u4f46\u662f <code>parted</code> \u5728\u811a\u672c\u4e2d\u4f7f\u7528\u66f4\u52a0\u65b9\u4fbf\u3002 parted \u811a\u672c\u7684\u4f8b\u5b50\u53ef\u4ee5\u53c2\u8003 101strap \u811a\u672c\u3002</p> <pre><code>$ parted -a optimal test.img  # \u4f7f\u7528 optimal \u53c2\u6570\uff0c\u5728\u521b\u5efa\u65b0\u5206\u533a\u65f6\u4f7f\u7528\u6700\u4f73\u5bf9\u9f50\nWARNING: You are not superuser.  Watch out for permissions.\nGNU Parted 3.6\nUsing /home/taoky/tmp/201/test.img\nWelcome to GNU Parted! Type 'help' to view a list of commands.\n(parted) mklabel gpt\n(parted) mkpart efi 0% 256M\n(parted) mkpart swap 256M 1289M\n(parted) mkpart rootfs 1289M 100%\n(parted) set 1 esp\nNew state?  [on]/off?\n(parted) set 2 swap\nNew state?  [on]/off?\n(parted) print\nModel:  (file)\nDisk /home/taoky/tmp/201/test.img: 8590MB\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags: \n\nNumber  Start   End     Size    File system  Name    Flags\n1      1049kB  256MB   255MB                efi     boot, esp\n2      256MB   1289MB  1033MB               swap    swap\n3      1289MB  8589MB  7300MB               rootfs\n\n(parted) quit\n</code></pre> <p>\u5728\u521b\u5efa\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>file</code> \u548c <code>fdisk</code> \u5de5\u5177\u9a8c\u8bc1\u5206\u533a\u8868\u7684\u7c7b\u578b\uff1a</p> <pre><code>$ file test.img  # MBR \u53ea\u6709\u4e00\u4e2a\u5206\u533a\uff0c\u5e76\u4e14\u5206\u533a ID \u4e3a 0xee\uff0c\u4ee3\u8868\u8be5\u78c1\u76d8\u955c\u50cf\u4f7f\u7528 GPT\ntest.img: DOS/MBR boot sector; partition 1 : ID=0xee, start-CHS (0x0,0,2), end-CHS (0x3ff,255,63), startsector 1, 16777215 sectors, extended partition table (last)\n$ fdisk -l test.img\nDisk test.img: 8 GiB, 8589934592 bytes, 16777216 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: E19C12C2-CAB9-4A9A-88D5-2F389F7B4452\n\nDevice       Start      End  Sectors  Size Type\ntest.img1     2048   526335   524288  256M EFI System\ntest.img2   526336  2623487  2097152    1G Linux swap\ntest.img3  2623488 16775167 14151680  6.7G Linux filesystem\n</code></pre> <p>\u5982\u679c\u5bf9 GPT \u7684\u7ec6\u8282\u611f\u5174\u8da3\uff0c\u53ef\u4ee5\u4f7f\u7528\u5341\u516d\u8fdb\u5236\u7f16\u8f91\u5668\u67e5\u770b\u955c\u50cf\u5185\u5bb9\uff0c\u5e76\u4e0e GPT \u6807\u51c6\u5bf9\u7167\u3002</p> \u5206\u533a\u5bf9\u9f50 <p>\u89c2\u5bdf fdisk \u7684\u8f93\u51fa\u53ef\u4ee5\u53d1\u73b0\u4e00\u4e9b\u6709\u8da3\u7684\u5730\u65b9\uff1a\u67e5\u627e\u8d44\u6599\u53ef\u4ee5\u77e5\u9053\uff0cGPT \u5206\u533a\u8868\u672c\u8eab\u53ea\u9700\u8981 34 \u4e2a\u6247\u533a\uff0c\u4f46\u662f\u4e0a\u6587\u4e2d\u9996\u4e2a\u5206\u533a\u5374\u4ece\u7b2c 2048 \u4e2a\u6247\u533a\u5f00\u59cb\u3002 \u8fd9\u662f\u57fa\u4e8e\u5c06\u5206\u533a\u4e0e\u7269\u7406\u8bbe\u5907\u7684\u6247\u533a/\u8bbf\u95ee\u8fb9\u754c\u300c\u5bf9\u9f50\u300d\u7684\u8003\u8651\u3002</p> <p>\u5728\u5b9e\u8df5\u4e2d\u6211\u4eec\u4e00\u822c\u91c7\u53d6 4K\uff088 \u4e2a\u6247\u533a\uff09\u5bf9\u9f50\uff0c\u56e0\u6b64\u8d77\u59cb\u4f4d\u7f6e\u9700\u8981\u4e3a 4K\uff088 \u4e2a\u6247\u533a\uff09\u7684\u6574\u6570\u500d\u3002 2048 \u4e2a\u6247\u533a\u5373 1M\uff0c\u662f\u73b0\u4ee3\u7248\u672c fdisk \u7684\u9ed8\u8ba4\u5bf9\u9f50\u7c92\u5ea6\uff0c\u53ef\u4ee5\u5e94\u5bf9\u672a\u6765\u7684\u5bf9\u9f50\u9700\u6c42\uff0c\u56e0\u6b64\u662f\u4e00\u4e2a\u5408\u7406\u4e14\u88ab\u666e\u904d\u4f7f\u7528\u7684\u9009\u62e9\u3002</p>"},{"location":"ops/storage/filesystem/#_6","title":"\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u4e0b\u8868\u7ed9\u51fa\u4e86\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u5728\u67d0\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u4e00\u90e8\u5206\u6587\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5\u7b2c\u4e09\u65b9\u8f6f\u4ef6\u7684\u65b9\u5f0f\u5b9e\u73b0\u652f\u6301\uff0c\u4f46\u662f\u53ef\u80fd\u5b58\u5728\u989d\u5916\u7684\u6027\u80fd\u6216\u53ef\u9760\u6027\u95ee\u9898\u3002</p> \u6587\u4ef6\u7cfb\u7edf Linux macOS Windows \u7279\u70b9\u4e0e\u5907\u6ce8 FAT32 (VFAT) \u4ec5\u9002\u7528\u4e8e EFI \u5206\u533a\u548c\u90e8\u5206\u60c5\u51b5\u4e0b\u7684 <code>/boot</code>\uff0c\u6216\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u4ea4\u6362\u6587\u4ef6\u7684\u573a\u5408\u3002\u4e0d\u652f\u6301\u5927\u4e8e 4 GiB \u7684\u6587\u4ef6\u3002 exFAT \u5e94\u4ec5\u7528\u4e8e\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7edf\u4ea4\u6362\u6587\u4ef6\u3002\u4e0d\u652f\u6301\u65e5\u5fd7\u3002 ext4 Linux \u4e0a\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 XFS \u9002\u7528\u4e8e\u5927\u6587\u4ef6\u3001\u5927\u5bb9\u91cf\u7684\u573a\u5408\u3002\u65e0\u6cd5\u968f\u610f\u7f29\u5c0f<sup>3</sup>\u3002 ReiserFS  (deprecated) \u9002\u7528\u4e8e\u5b58\u50a8\u5927\u91cf\u5c0f\u6587\u4ef6\u7684\u573a\u5408\u3002\u7531\u4e8e\u5185\u6838\u4e3b\u7ebf\u5df2\u7ecf\u8003\u8651\u79fb\u9664\u652f\u6301\uff0c\u5982\u6709\u5b58\u50a8\u5927\u91cf\u5c0f\u6587\u4ef6\u9700\u6c42\uff0c\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u65b9\u6848\u66ff\u4ee3\u3002 Btrfs \u5185\u7f6e\u4e8e Linux \u5185\u6838\u7684\u65b0\u4e00\u4ee3\u7684 CoW \u6587\u4ef6\u7cfb\u7edf\uff0c\u652f\u6301\u5feb\u7167\u3001\u900f\u660e\u538b\u7f29\u7b49\u9ad8\u7ea7\u529f\u80fd\u3002RAID 5/6 \u652f\u6301\u4e0d\u7a33\u5b9a\uff0c\u4e5f\u6709\u5bf9\u6574\u4f53\u7a33\u5b9a\u6027\u7684\u4e89\u8bae\u3002 ZFS \uff08\u9700\u8981 kernel module\uff09 \u8d77\u6e90\u4e8e Solaris \u7684 CoW \u6587\u4ef6\u7cfb\u7edf\uff0c\u9002\u7528\u4e8e\u5b58\u50a8\u5927\u91cf\u6587\u4ef6\u3001\u9700\u8981\u9ad8\u7ea7\u529f\u80fd\u7684\u573a\u5408\u3002\u9700\u8981\u989d\u5916\u7684\u5185\u5b58\u548c CPU \u8d44\u6e90\u3002 NTFS  (Linux 5.15+) \u53ea\u8bfb Windows \u4e0a\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 HFS+ \u53ea\u8bfb \u53ea\u8bfb\uff0cBootcamp macOS \u8f83\u65e9\u671f\u7248\u672c\u6700\u5e38\u89c1\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 APFS macOS \u8f83\u65b0\u7248\u672c\u7684 CoW \u6587\u4ef6\u7cfb\u7edf\u3002 <p>\u4ee5\u4e0b\u5c06\u5173\u6ce8\u5728 Linux \u670d\u52a1\u5668\u7aef\u5e38\u89c1\u7684\u573a\u666f\u3002\u8868\u683c\u4e2d\u6307\u5411 ArchWiki \u7684\u94fe\u63a5\u4e5f\u53ef\u80fd\u6709\u6240\u5e2e\u52a9\u3002</p>"},{"location":"ops/storage/filesystem/#ext4","title":"ext4","text":"<p>ext4 \u662f\u5305\u62ec Debian \u548c Ubuntu \u5728\u5185\u7684\u4f17\u591a\u53d1\u884c\u7248\u4e3a\u7cfb\u7edf\u5206\u533a\uff08\u6839\u6587\u4ef6\u7cfb\u7edf\uff09\u9ed8\u8ba4\u91c7\u7528\u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\u3002 \u5982\u679c\u6ca1\u6709\u7279\u6b8a\u7684\u9700\u6c42\uff0cext4 \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9009\u62e9\uff1b\u5373\u4f7f\u6709\u5176\u4ed6\u9700\u6c42\uff0c\u4e5f\u5efa\u8bae\u5bf9\u7cfb\u7edf\u5206\u533a\u4f7f\u7528 ext4\u3002 ext4 \u6700\u5e38\u89c1\u7684\u95ee\u9898\u4e4b\u4e00\u662f inode \u7684\u6570\u91cf\u9650\u5236\u3002</p> <p>inode</p> <p>inode \u662f Unix \u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u6982\u5ff5\uff0c\u5176\u5305\u542b\u4e86\u6587\u4ef6\uff08\u6587\u4ef6\u7cfb\u7edf\u5bf9\u8c61\uff09\u7684\u5143\u6570\u636e\uff08\u5982\u6743\u9650\u3001\u5927\u5c0f\u3001\u65f6\u95f4\u7b49\uff09\uff0c\u6bcf\u4e2a\u6587\u4ef6\u5bf9\u5e94\u4e00\u4e2a inode\uff0c\u6709\u4e00\u4e2a\u5728\u6587\u4ef6\u7cfb\u7edf\u4e0a\u552f\u4e00\u7684 inode \u53f7\u7801\u3002 \u53ef\u4ee5\u4f7f\u7528 <code>stat</code> \u6216 <code>ls -i</code> \u67e5\u770b\u6587\u4ef6\u7684 inode \u4fe1\u606f\u3002</p> <pre><code>$ stat test\n  File: test\n  Size: 0           Blocks: 0          IO Block: 4096   regular empty file\nDevice: 0,28    Inode: 54475724    Links: 1\nAccess: (0644/-rw-r--r--)  Uid: ( 1000/   username)   Gid: ( 1000/   username)\nAccess: 2024-02-11 00:23:27.743633975 +0800\nModify: 2024-02-11 00:23:27.743633975 +0800\nChange: 2024-02-11 00:23:27.743633975 +0800\n Birth: 2024-02-11 00:23:27.743633975 +0800\n</code></pre> <p>\u8fd9\u91cc test \u6587\u4ef6\u7684 inode \u53f7\u7801\u5219\u4e3a 54475724\u3002</p> <p>\u5728\u521b\u5efa ext4 \u6587\u4ef6\u7cfb\u7edf\u65f6\uff0c\u4f1a\u56fa\u5b9a\u540d\u4e3a \"bytes-per-inode\" \u7684\u53c2\u6570\uff0c\u7528\u4e8e\u63a7\u5236\u603b\u7684 inode \u6570\u91cf\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u786c\u76d8\u4e0a\u6bcf\u6709 16KB \u7684\u7a7a\u95f4\uff0c\u5c31\u4f1a\u4fdd\u7559\u4e00\u4e2a inode\u3002 \u8be5\u53c2\u6570\u65e0\u6cd5\u5728\u6587\u4ef6\u7cfb\u7edf\u521b\u5efa\u540e\u66f4\u6539\u3002 \u56e0\u6b64\uff0c\u5982\u679c\u521b\u5efa\u4e86\u5927\u91cf\u5c0f\u6587\u4ef6\uff0c\u53ef\u80fd\u4f1a\u53d1\u73b0\u78c1\u76d8\u7a7a\u95f4\u5e76\u6ca1\u6709\u7528\u5b8c\uff0c\u4f46\u662f\u5df2\u7ecf\u65e0\u6cd5\u518d\u521b\u5efa\u65b0\u6587\u4ef6\u4e86\u3002 \u6b64\u65f6\u5982\u679c\u6269\u5145\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684\u5bb9\u91cf\uff0c\u90a3\u4e48 inode \u7684\u6570\u91cf\u4e5f\u4f1a\u6309\u6bd4\u4f8b\u589e\u52a0\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0cext4 \u9ed8\u8ba4\u7684 5% \u4fdd\u7559\u7a7a\u95f4\u4e5f\u662f\u5e38\u4f1a\u9047\u5230\u7684\u95ee\u9898\u3002\u8fd9\u4e00\u90e8\u5206\u4fdd\u7559\u7a7a\u95f4\u4ec5\u5141\u8bb8 root \u7528\u6237\u4f7f\u7528\uff0c\u4ee5\u5728\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u65f6\u4ecd\u4fdd\u8bc1 root \u6743\u9650\u7684\u8fdb\u7a0b\u80fd\u591f\u6b63\u5e38\u8fd0\u884c\u3002 \u4f46\u662f\u5bf9\u4e8e\u73b0\u4ee3\u7684\u5927\u5bb9\u91cf\u78c1\u76d8\u6765\u8bf4\uff0c\u8fd9\u4e00\u90e8\u5206\u7a7a\u95f4\u53ef\u80fd\u4f1a\u6d6a\u8d39\u5f88\u591a\u3002\u53ef\u4ee5\u4f7f\u7528 <code>tune2fs</code> \u547d\u4ee4\u8c03\u6574\u8fd9\u4e00\u53c2\u6570\uff1a</p> <pre><code>sudo tune2fs -m 1 /dev/sda1  # \u5c06\u4fdd\u7559\u7a7a\u95f4\u8c03\u6574\u4e3a 1%\n</code></pre>"},{"location":"ops/storage/filesystem/#btrfs","title":"Btrfs","text":"<p>\u5c3d\u7ba1\u5728\u6211\u4eec\u7684\u5b9e\u8df5\u4e2d\uff0c\u6211\u4eec\u4e0d\u592a\u5efa\u8bae\u4f7f\u7528 Btrfs\u2014\u2014\u9ad8\u7ea7\u7279\u6027\u7528\u4e0d\u4e0a\uff0c\u800c\u8bb8\u591a\u5e74\u524d\u5728\u955c\u50cf\u7ad9\u4e0a\u7684\u6d4b\u8bd5\u8868\u660e Btrfs \u5728\u957f\u65f6\u95f4\u8fd0\u884c\u540e\u5b58\u5728\u4e25\u91cd\u7684\u6027\u80fd\u95ee\u9898\u3002 \u4f46\u662f\u5728\u8bb8\u591a\u5e74\u7684\u5f00\u53d1\u540e\uff0cBtrfs \u7684\u7a33\u5b9a\u6027\u6709\u4e86\u5f88\u5927\u7684\u63d0\u5347\uff0c\u5e76\u4e14\u4e00\u90e8\u5206\u7279\u6027\u5728\u67d0\u4e9b\u573a\u5408\u4e0b\u5f88\u6709\u7528\uff0c\u56e0\u6b64\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e9b\u76f8\u5173\u7684\u4ecb\u7ecd\u3002</p>"},{"location":"ops/storage/filesystem/#subvolume","title":"Subvolume","text":"<p>Subvolume \u662f Btrfs \u7684\u4e00\u4e2a\u91cd\u8981\u6982\u5ff5\uff0c\u53ef\u4ee5\u770b\u4f5c\u662f Btrfs \u7684\u300c\u5b50\u6587\u4ef6\u7cfb\u7edf\u300d\u3002\u4e0e\u76ee\u5f55\u4e0d\u540c\uff0cSubvolume \u662f\u72ec\u7acb\u7684\uff0c\u53ef\u4ee5\u6709\u81ea\u5df1\u7684\u6302\u8f7d\u70b9\u3002 \u540c\u65f6 subvolume \u5171\u4eab\u540c\u4e00\u4e2a Btrfs \u6587\u4ef6\u7cfb\u7edf\u7684\u7a7a\u95f4\uff0c\u4e0d\u9700\u8981\u624b\u52a8\u5206\u914d\u7a7a\u95f4\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6765\u8bd5\u4e00\u8bd5\uff1a</p> <pre><code>$ truncate -s 8G btrfs.img\n$ mkfs.btrfs btrfs.img\n\uff08\u8f93\u51fa\u7701\u7565\uff09\n$ sudo mount btrfs.img /media/btrfs\n$ sudo btrfs filesystem show /media/btrfs  # \u53ef\u4ee5\u4f7f\u7528 btrfs \u5de5\u5177\u7ba1\u7406 Btrfs \u6587\u4ef6\u7cfb\u7edf\nLabel: none  uuid: 5cdcf4bb-8020-45f9-8dfd-95e04a2a2bc1\n    Total devices 1 FS bytes used 144.00KiB\n    devid    1 size 8.00GiB used 536.00MiB path /dev/loop0\n\n$ # btrfs \u5de5\u5177\u4e5f\u53ef\u4ee5\u7ba1\u7406\u79bb\u7ebf\u7684 btrfs \u5757\u8bbe\u5907\n$ # \u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e9b subvolume\n$ sudo btrfs subvolume create /media/btrfs/subvol1\nCreate subvolume '/media/btrfs/subvol1'\n$ sudo btrfs subvolume create /media/btrfs/subvol2\nCreate subvolume '/media/btrfs/subvol2'\n$ sudo btrfs subvolume create /media/btrfs/subvol3\nCreate subvolume '/media/btrfs/subvol3'\n$ sudo btrfs subvolume list /media/btrfs\nID 256 gen 8 top level 5 path subvol1\nID 257 gen 8 top level 5 path subvol2\nID 258 gen 8 top level 5 path subvol3\n$ ls -lh /media/btrfs  # \u770b\u8d77\u6765\u548c\u666e\u901a\u76ee\u5f55\u6ca1\u4ec0\u4e48\u533a\u522b\ntotal 0\ndrwxr-xr-x 1 root root 0 Feb 11 14:50 subvol1/\ndrwxr-xr-x 1 root root 0 Feb 11 14:50 subvol2/\ndrwxr-xr-x 1 root root 0 Feb 11 14:50 subvol3/\n$ sudo umount /media/btrfs\n$ sudo mount -o subvol=subvol1 btrfs.img /media/btrfs1  # \u6302\u8f7d subvol1\n$ sudo mount -o subvol=subvol2 btrfs.img /media/btrfs2  # \u6302\u8f7d subvol2\n$ mount | grep btrfs.img\n/path/to/btrfs.img on /media/btrfs1 type btrfs (rw,relatime,ssd,discard=async,space_cache=v2,subvolid=256,subvol=/subvol1)\n/path/to/btrfs.img on /media/btrfs2 type btrfs (rw,relatime,ssd,discard=async,space_cache=v2,subvolid=257,subvol=/subvol2)\n$ sudo umount /media/btrfs1\n$ sudo umount /media/btrfs2\n</code></pre> <p>Subvolume \u7684\u6302\u8f7d\u53c2\u6570</p> <p>\u5927\u90e8\u5206 Btrfs \u7684\u6302\u8f7d\u53c2\u6570\uff08\u4f8b\u5982\u900f\u660e\u538b\u7f29\uff09\u53ea\u9002\u7528\u4e8e\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u5728\u9996\u4e2a subvolume \u4e0a\u6302\u8f7d\u65f6\uff0c\u8fd9\u4e9b\u53c2\u6570\u4f1a\u88ab\u5e94\u7528\u5230\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u3002 \u540e\u7eed\u6302\u8f7d\u4f7f\u7528\u7684\u53c2\u6570\u4f1a\u88ab\u5ffd\u7565\u3002</p>"},{"location":"ops/storage/filesystem/#_7","title":"\u5feb\u7167","text":"<p>\u5728 subvolume \u7684\u57fa\u7840\u4e0a\uff0cBtrfs \u652f\u6301\u4e86\u5feb\u7167\u529f\u80fd\u3002\u8fd9\u91cc\u7684\u5feb\u7167\u53ef\u80fd\u4e0e\u6211\u4eec\u719f\u6089\u7684\u300c\u5feb\u7167\u300d\uff08\u4f8b\u5982\u865a\u62df\u673a\u8f6f\u4ef6\u7684\u5feb\u7167\u529f\u80fd\uff09\u6709\u6240\u4e0d\u540c\uff0c\u5b83\u672c\u8d28\u4e0a\u5c31\u662f\u548c\u5176\u4ed6 subvolume \u5171\u4eab\u6570\u636e\u7684 subvolume\u3002\u8ba9\u6211\u4eec\u8bd5\u4e00\u8bd5\u5427\uff1a</p> <pre><code>$ sudo mount btrfs.img /media/btrfs  # \u6302\u8f7d\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\n$ echo \"test1\" &gt; /media/btrfs/subvol1/test  # \u53ef\u80fd\u9700\u8981 root \u6743\u9650\n$ sudo btrfs subvolume snapshot /media/btrfs/subvol1 /media/btrfs/snap1  # \u521b\u5efa\u5feb\u7167\nCreate a snapshot of '/media/btrfs/subvol1/' in '/media/btrfs/snap1'\n$ # \u6b64\u65f6 snap1 \u548c subvol1 \u5171\u4eab\u6570\u636e\u2014\u2014\u5b58\u50a8\u7684\u662f\u76ee\u524d subvol1 \u7684\u5185\u5bb9\n$ cat /media/btrfs/snap1/test\ntest1\n$ echo \"test2\" &gt; /media/btrfs/subvol1/test  # \u4fee\u6539 subvol1\n$ cat /media/btrfs/snap1/test  # snap1 \u4e0d\u53d7\u5f71\u54cd\ntest1\n$ echo \"test3\" &gt; /media/btrfs/snap1/test  # \u4fee\u6539 snap1\n$ cat /media/btrfs/subvol1/test  # subvol1 \u4e0d\u53d7\u5f71\u54cd\ntest2\n$ sudo btrfs subvolume delete /media/btrfs/snap1  # \u5220\u9664\u5feb\u7167\nDelete subvolume 259 (no-commit): '/media/btrfs/snap1'\n$ sudo umount /media/btrfs\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u300c\u5feb\u7167\u300d\u7684\u5185\u5bb9\uff0c\u5728 CoW \u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u4fee\u6539\u5171\u4eab\u7684\u5185\u5bb9\u4f1a\u88ab\u590d\u5236\uff0c\u800c\u672a\u4fee\u6539\u7684\u5185\u5bb9\u4f1a\u88ab\u5171\u4eab\u3002 \u4e0d\u8fc7\u5f88\u591a\u65f6\u5019\u6211\u4eec\u4e0d\u5e0c\u671b\u5feb\u7167\u53ef\u5199\uff0c\u5728\u521b\u5efa\u5feb\u7167\u65f6\u53ef\u4ee5\u52a0\u4e0a <code>-r</code> \u53c2\u6570\u3002</p>"},{"location":"ops/storage/filesystem/#_8","title":"\u900f\u660e\u538b\u7f29","text":"<p>Btrfs \u652f\u6301\u900f\u660e\u538b\u7f29\uff0c\u6587\u4ef6\u7cfb\u7edf\u4f1a\u81ea\u52a8\u538b\u7f29\u6587\u4ef6\uff0c\u800c\u4e0a\u5c42\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u5173\u5fc3\u8fd9\u4e00\u8fc7\u7a0b\u3002 \u8fd9\u4e5f\u662f\u8bb8\u591a Btrfs \u7528\u6237\u4f1a\u5f00\u542f\u7684\u6302\u8f7d\u9009\u9879\u3002 Zstd \u538b\u7f29\u7b97\u6cd5\u517c\u987e\u4e86\u6027\u80fd\u4e0e\u538b\u7f29\u6548\u7387\uff0c\u662f\u8bb8\u591a\u7528\u6237\u7684\u9009\u62e9\u3002</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u542f\u7528\u4e86 Btrfs \u900f\u660e\u538b\u7f29\uff08<code>compress=zstd:3</code>\uff09\u7684\u684c\u9762\u7528\u6237\uff0c\u5728 <code>/home</code> \u8fd9\u4e2a subvolume \u4e0b\u7684\u4f8b\u5b50\uff1a</p> <pre><code>$ sudo compsize /home\nProcessed 4429337 files, 5827189 regular extents (6428918 refs), 2327200 inline.\nType       Perc     Disk Usage   Uncompressed Referenced  \nTOTAL       78%     1017G         1.2T         1.3T       \nnone       100%      911G         911G         918G       \nzstd        27%      105G         384G         413G       \nprealloc   100%      643M         643M         1.0G\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u900f\u660e\u538b\u7f29\u7279\u6027\u4e3a\u8be5\u7528\u6237\u8282\u7701\u4e86 200G \u7684\u78c1\u76d8\u7a7a\u95f4\u3002</p>"},{"location":"ops/storage/filesystem/#_9","title":"\u5e38\u89c1\u95ee\u9898","text":"Balance <p>\u4e00\u4e2a\u5e38\u89c1\u7684\u95ee\u9898\u662f\uff1a\u660e\u660e\u8fd8\u6709\u5269\u4f59\u7a7a\u95f4\uff0c\u4f46\u662f\u5df2\u7ecf\u65e0\u6cd5\u5199\u5165\u6570\u636e\u4e86\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u8fd9\u662f\u56e0\u4e3a Btrfs \u5185\u90e8\u5b58\u50a8\u5206\u4e3a\u6570\u636e\uff08Data\uff09\u548c\u5143\u6570\u636e\uff08Metadata\uff09\u7b49\u90e8\u5206\uff0c\u5f53\u4e24\u8005\u4efb\u4e00\u5df2\u6ee1\uff0c\u5e76\u4e14\u6ca1\u6709\u672a\u5206\u914d\uff08Unallocated\uff09\u7684\u7a7a\u95f4\uff0c\u90a3\u4e48\u5c31\u65e0\u6cd5\u518d\u5199\u5165\u6570\u636e\u4e86\u3002\u8fd9\u53ef\u4ee5\u901a\u8fc7\u6267\u884c <code>btrfs filesystem usage</code> \u5224\u65ad\uff1a</p> <pre><code>$ sudo btrfs filesystem usage /\nOverall:\n    Device size:           1.81TiB\n    Device allocated:          1.66TiB\n    Device unallocated:      156.45GiB\n    Device missing:          0.00B\n    Device slack:            0.00B\n    Used:              1.39TiB\n    Free (estimated):        414.79GiB  (min: 336.57GiB)\n    Free (statfs, df):       414.79GiB\n    Data ratio:               1.00\n    Metadata ratio:           2.00\n    Global reserve:      512.00MiB  (used: 0.00B)\n    Multiple profiles:              no\n\nData,single: Size:1.62TiB, Used:1.37TiB (84.43%)\n/dev/nvme0n1p3     1.62TiB\n\nMetadata,DUP: Size:18.00GiB, Used:11.54GiB (64.13%)\n/dev/nvme0n1p3    36.00GiB\n\nSystem,DUP: Size:8.00MiB, Used:208.00KiB (2.54%)\n/dev/nvme0n1p3    16.00MiB\n\nUnallocated:\n/dev/nvme0n1p3   156.45GiB\n</code></pre> <p>\u9664\u4e86\u76f4\u63a5\u5220\u9664\u6587\u4ef6\u4ee5\u5916\uff0c\u4f7f\u7528 <code>truncate</code> \u5c06\u5927\u6587\u4ef6\u7684\u5927\u5c0f\u622a\u65ad\u4e3a 0 \u53ef\u4ee5\u5728\u4e0d\u6dfb\u52a0 metadata \u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\u91ca\u653e\u7a7a\u95f4\u3002 \u5982\u679c metadata \u5df2\u6ee1\uff0c\u4f46\u662f data \u4ecd\u6709\u7a7a\u95f4\uff0c\u53ef\u4ee5\u4f7f\u7528 balance \u529f\u80fd\u91cd\u65b0\u5206\u914d\u7a7a\u95f4\uff1a</p> <pre><code>$ sudo btrfs balance start /mountpoint -dusage=0\n</code></pre> <p><code>-dusage=0</code> \u4ee3\u8868\u5c06 data \u4e2d\u6ca1\u6709\u4f7f\u7528\uff08\u4f7f\u7528\u7387\u4e3a 0%\uff09\u7684\u7a7a\u95f4\u91ca\u653e\u3002\u89c6\u60c5\u51b5\uff0c\u6709\u53ef\u80fd\u9700\u8981\u589e\u5927 <code>-dusage</code> \u53c2\u6570\u7684\u503c\u3002</p> Check <p>Btrfs \u7684\u6587\u4ef6\u7cfb\u7edf\u68c0\u67e5\u5de5\u5177 <code>btrfs-check</code> \u4e0d\u662f\u4f20\u7edf\u6587\u4ef6\u7cfb\u7edf fsck \u7684\u5e73\u66ff\u3002 \u5bf9\u51fa\u73b0\u95ee\u9898\u7684 Btrfs \u5206\u533a\u4f7f\u7528 <code>btrfs-check</code> \u7684 <code>--repair</code> \u9009\u9879\u5f88\u53ef\u80fd\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u3002</p> <p>\u4e00\u822c\u6765\u8bb2\uff0c\u5efa\u8bae\u8bbe\u7f6e\u5b9a\u65f6 scrub \u4efb\u52a1\uff0c\u4ee5\u68c0\u67e5 checksum \u4e0e\u5b9e\u9645\u5185\u5bb9\u662f\u5426\u4e00\u81f4\u3002Scrub \u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u6267\u884c\uff0c\u4f46\u662f\u4e0d\u68c0\u67e5\u7ed3\u6784\u662f\u5426\u6b63\u786e\u3002</p> \u5173\u95ed CoW <p>\u5bf9\u4e8e\u90e8\u5206\u5e94\u7528\u573a\u666f\uff08\u4f8b\u5982\u6570\u636e\u5e93\u3001\u865a\u62df\u673a\u955c\u50cf\uff09\uff0cBtrfs \u7684 CoW \u7279\u6027\u53ef\u80fd\u4f1a\u5e26\u6765\u6027\u80fd\u95ee\u9898\u3002\u53ef\u4ee5\u5bf9\u6587\u4ef6\u4f7f\u7528 <code>chattr +C</code> \u547d\u4ee4\u5173\u95ed CoW \u7279\u6027\u3002</p>"},{"location":"ops/storage/filesystem/#zfs","title":"ZFS","text":"<p>\u53c2\u89c1 ZFS\u3002</p> <ol> <li> <p>\u5f53\u7136\u4e86\uff0c\u300c\u6247\u533a\u300d\u7684\u6982\u5ff5\u5728\u73b0\u4ee3\u78c1\u76d8\uff0c\u7279\u522b\u662f\u56fa\u6001\u786c\u76d8\u4e0a\u5df2\u7ecf\u4e0d\u518d\u51c6\u786e\uff0c\u4f46\u662f\u8fd9\u91cc\u4ecd\u7136\u4f7f\u7528\u8fd9\u4e2a\u4e60\u60ef\u6027\u7684\u672f\u8bed\u3002\u00a0\u21a9</p> </li> <li> <p>\u6247\u533a\u7684\u5927\u5c0f\uff08\u7279\u522b\u662f\u73b0\u4ee3\u78c1\u76d8\u5728\u5b9e\u9645\u7269\u7406\u4e0a\uff09\u4e0d\u4e00\u5b9a\u662f 512 \u5b57\u8282\uff0c\u4f46\u5728\u5b9e\u9645\u521b\u5efa\u5206\u533a\u65f6\uff0c\u4e00\u822c\u90fd\u662f\u4ee5 512 \u5b57\u8282\u4e3a\u5355\u4f4d\u3002\u00a0\u21a9</p> </li> <li> <p>xfs_growfs(8): A filesystem with only 1 AG cannot be shrunk further, and a filesystem cannot be shrunk to the point where it would only have 1 AG.\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/lvm-raid/","title":"LVM \u4e0e RAID","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>\u672c\u6587\u5c06\u4ecb\u7ecd LVM\uff0c\u4ee5\u53ca\u5e38\u89c1\u7684 RAID \u65b9\u6848\u7684\u4f7f\u7528\u4e0e\u7ef4\u62a4\u3002</p>"},{"location":"ops/storage/lvm-raid/#lvm","title":"LVM","text":"<p>LVM\uff08Logical Volume Manager\uff09\u662f Linux \u4e0b\u7684\u903b\u8f91\u5377\u7ba1\u7406\u5668\uff0c\u57fa\u4e8e\u5185\u6838\u7684 device mapper\uff08dm\uff09\u529f\u80fd\u3002 \u76f8\u6bd4\u4e8e\u76f4\u63a5\u5728\u521b\u5efa\u5206\u533a\u8868\u540e\u4f7f\u7528\u5206\u533a\uff0cLVM \u63d0\u4f9b\u4e86\u66f4\u52a0\u7075\u6d3b\u7684\u5b58\u50a8\u7ba1\u7406\u65b9\u5f0f\uff1a</p> <ul> <li>LVM \u53ef\u4ee5\u7ba1\u7406\u591a\u4e2a\u786c\u76d8\uff08\u7269\u7406\u5377\uff09\u4e0a\u7684\u5b58\u50a8\u7a7a\u95f4</li> <li>LVM \u4e2d\u7684\u903b\u8f91\u5377\u53ef\u4ee5\u8de8\u8d8a\u591a\u4e2a\u7269\u7406\u5377\uff0c\u6587\u4ef6\u7cfb\u7edf\u4e0d\u9700\u8981\u5173\u5fc3\u7269\u7406\u5377\u7684\u4f4d\u7f6e</li> <li>LVM \u7684\u903b\u8f91\u5377\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\u5927\u5c0f\uff0c\u800c\u4e0d\u9700\u8981\u79fb\u52a8\u5206\u533a\u7684\u4f4d\u7f6e\u2014\u2014\u79fb\u52a8\u5206\u533a\u7684\u8d77\u59cb\u4f4d\u7f6e\u662f\u4e00\u4e2a\u5371\u9669\u4e14\u8017\u65f6\u7684\u64cd\u4f5c</li> </ul> <p>\u4e00\u4e9b Linux \u53d1\u884c\u7248\u7684\u5b89\u88c5\u7a0b\u5e8f\u9ed8\u8ba4\u4f7f\u7528 LVM \u6765\u7ba1\u7406\u78c1\u76d8\uff0c\u4f8b\u5982 Fedora\u3001CentOS \u7b49\u3002\u5982\u679c\u9700\u8981\u5b9e\u9645\u4f7f\u7528 LVM\uff0c\u4e5f\u63a8\u8350\u9605\u8bfb\u6765\u81ea\u7ea2\u5e3d RHEL \u7684 LVM \u7ba1\u7406\u6307\u5357<sup>1</sup>\u3002</p> <p>\u672c\u90e8\u5206\u65e0\u6cd5\u6db5\u76d6\u5168\u90e8\u5185\u5bb9</p> <p>LVM \u5305\u542b\u4e86\u5f88\u591a\u529f\u80fd\uff0c\u5728\u672c\u4efd\u6587\u6863\u4e2d\u4e0d\u53ef\u80fd\u9762\u9762\u4ff1\u5230\uff0c\u56e0\u6b64\u6211\u4eec\u4ec5\u4ecb\u7ecd\u5728 LUG \u4e0e Vlab \u9879\u76ee\u4e2d\u4f7f\u7528\u8fc7\u7684\u529f\u80fd\u3002</p>"},{"location":"ops/storage/lvm-raid/#_1","title":"\u57fa\u7840\u6982\u5ff5","text":"<p>LVM \u4e2d\u6709\u4e09\u4e2a\u57fa\u672c\u6982\u5ff5\uff1a</p> <ul> <li>\u7269\u7406\u5377\uff08Physical Volume\uff0cPV\uff09\uff1a\u901a\u5e38\u662f\u4e00\u5757\u786c\u76d8\uff08\u5206\u533a\uff09</li> <li>\u5377\u7ec4\uff08Volume Group\uff0cVG\uff09\uff1a\u7531\u4e00\u4e2a\u6216\u591a\u4e2a\u7269\u7406\u5377\u7ec4\u6210</li> <li>\u903b\u8f91\u5377\uff08Logical Volume\uff0cLV\uff09\uff1a\u5728\u5377\u7ec4\u91cc\u5206\u914d\u7684\u903b\u8f91\u5b58\u50a8\u7a7a\u95f4\u3002\u79f0\u4e4b\u4e3a\u300c\u903b\u8f91\u300d\uff0c\u662f\u56e0\u4e3a\u5b83\u53ef\u4ee5\u8de8\u8d8a\u591a\u4e2a\u7269\u7406\u5377\uff0c\u4e5f\u4e0d\u4e00\u5b9a\u662f\u8fde\u7eed\u7684</li> </ul> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e09\u4e2a 1GB \u7684\u6587\u4ef6\u4f5c\u4e3a\u7269\u7406\u5377\uff0c\u5e76\u4e14\u52a0\u5165\u5230\u4e00\u4e2a\u5377\u7ec4\u4e2d\uff1a</p> <p>\u907f\u514d\u5728\u7269\u7406\u78c1\u76d8\u4e0a\u521b\u5efa\u65e0\u5206\u533a\u8868\u7684\u6587\u4ef6\u7cfb\u7edf/\u7269\u7406\u5377</p> <p>\u5728\u5b9e\u8df5\u4e2d\uff0c\u5c3d\u7ba1\u6ca1\u6709\u4ec0\u4e48\u963b\u6b62\u8fd9\u4e48\u505a\uff0c\u4f46\u662f\u4e0d\u521b\u5efa\u5206\u533a\u8868\u3001\u76f4\u63a5\u5c06\u6574\u4e2a\u78c1\u76d8\u683c\u5f0f\u5316\u4e3a\u67d0\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u6216\u8005\u52a0\u5165 LVM \u4e2d\u662f\u4e0d\u5efa\u8bae\u7684\u3002 \u8fd9\u4f1a\u7ed9\u5176\u4ed6\u4eba\u5e26\u6765\u56f0\u60d1\uff0c\u5e76\u4e14\u5982\u679c\u672a\u6765\u6709\u5728\u5bf9\u5e94\u78c1\u76d8\u4e0a\u542f\u52a8\u7cfb\u7edf\u7b49\u9700\u8981\u591a\u5206\u533a\u7684\u9700\u6c42\uff0c\u4f1a\u5e26\u6765\u5f88\u591a\u9ebb\u70e6\uff08\u53ef\u80fd\u53ea\u80fd\u5907\u4efd\u6570\u636e\u540e\u4ece\u5934\u518d\u6765\uff09\u3002</p> <p>\u76f4\u63a5\u5bf9\u7269\u7406\u78c1\u76d8\u8bbe\u5907\u683c\u5f0f\u5316\u4e3a\u6587\u4ef6\u7cfb\u7edf\u4e5f\u662f\u64cd\u4f5c\u65f6\u5e38\u89c1\u7684\u8f93\u5165\u9519\u8bef\uff1a</p> <pre><code>$ mkfs.ext4 /dev/sdz  # \u9519\u8bef \u274c\n$ mkfs.ext4 /dev/sdz1 # \u6b63\u786e \u2705\n</code></pre> <p>\u5728\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u64cd\u4f5c\uff0c\u6211\u4eec\u5047\u8bbe pv[1-3].img \u76f8\u5f53\u4e8e\u6bcf\u5757\u786c\u76d8\u4e0a\u4f7f\u7528\u5168\u90e8\u7a7a\u95f4\u7684\u5206\u533a\u3002</p> <pre><code>$ truncate -s 1G pv1.img pv2.img pv3.img\n$ sudo losetup -f --show pv1.img\n/dev/loop0\n$ sudo losetup -f --show pv2.img\n/dev/loop1\n$ sudo losetup -f --show pv3.img\n/dev/loop2\n$ sudo pvcreate /dev/loop0 /dev/loop1 /dev/loop2  # \u521b\u5efa\u7269\u7406\u5377\n  Physical volume \"/dev/loop0\" successfully created.\n  Physical volume \"/dev/loop1\" successfully created.\n  Physical volume \"/dev/loop2\" successfully created.\n$ sudo vgcreate vg201-test /dev/loop0 /dev/loop1 /dev/loop2  # \u521b\u5efa\u5377\u7ec4\n  Volume group \"vg201-test\" successfully created\n$ sudo pvs  # \u67e5\u770b\u7269\u7406\u5377\u4fe1\u606f\n  PV         VG         Fmt  Attr PSize    PFree   \n  /dev/loop0 vg201-test lvm2 a--  1020.00m 1020.00m\n  /dev/loop1 vg201-test lvm2 a--  1020.00m 1020.00m\n  /dev/loop2 vg201-test lvm2 a--  1020.00m 1020.00m\n$ sudo vgs  # \u67e5\u770b\u5377\u7ec4\u4fe1\u606f\n  VG         #PV #LV #SN Attr   VSize  VFree \n  vg201-test   3   0   0 wz--n- &lt;2.99g &lt;2.99g\n$ sudo lvcreate -n lvol0 -L 2.5G vg201-test  # \u521b\u5efa\u4e00\u4e2a 2.5G \u7684\u903b\u8f91\u5377\n  Logical volume \"lvol0\" created.\n$ sudo lvs  # \u67e5\u770b\u903b\u8f91\u5377\u4fe1\u606f\n  LV    VG         Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvol0 vg201-test -wi-a----- 2.50g\n$ ls -lh /dev/mapper/\ntotal 0\ncrw------- 1 root root 10, 236 Feb 11 13:30 control\nlrwxrwxrwx 1 root root       7 Feb 12 00:09 vg201--test-lvol0 -&gt; ../dm-0\n$ # /dev/mapper/vg201--test-lvol0 \u5c31\u662f\u6211\u4eec\u521b\u5efa\u7684\u903b\u8f91\u5377\uff08\u5757\u8bbe\u5907\uff09\uff0c\u53ef\u4ee5\u5728\u4e0a\u9762\u521b\u5efa\u6587\u4ef6\u7cfb\u7edf\u3002\n$ sudo lvchange -an vg201-test/lvol0  # \u53d6\u6d88\u6fc0\u6d3b (disactivate) \u521a\u624d\u521b\u5efa\u7684\u903b\u8f91\u5377\n$ sudo lvs\n  LV    VG         Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvol0 vg201-test -wi------- 2.50g \n$ sudo losetup -D  # \u5378\u8f7d\u672c\u5730\u56de\u73af\n</code></pre> <p>\u4e4b\u540e\u518d\u6b21\u6302\u8f7d\uff1a</p> <pre><code>$ sudo losetup -f --show pv1.img\n/dev/loop0\n$ sudo losetup -f --show pv2.img\n/dev/loop1\n$ sudo losetup -f --show pv3.img\n/dev/loop2\n$ sudo pvs  # \u53ef\u4ee5\u770b\u5230\u7269\u7406\u5377\u88ab\u81ea\u52a8\u8bc6\u522b\u4e86\n  PV         VG         Fmt  Attr PSize    PFree  \n  /dev/loop0 vg201-test lvm2 a--  1020.00m      0 \n  /dev/loop1 vg201-test lvm2 a--  1020.00m      0 \n  /dev/loop2 vg201-test lvm2 a--  1020.00m 500.00m\n$ sudo lvchange -ay vg201-test/lvol0  # \u6fc0\u6d3b LV\n$ sudo lvs\n  LV    VG         Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvol0 vg201-test -wi-a----- 2.50g\n</code></pre> <p>\u7b49\u7b49\uff0c\u600e\u4e48\u6bcf\u5757\u76d8\u5c11\u4e86\u51e0 MB \u7a7a\u95f4\uff1f</p> <p>\u5176\u5b9e\u5927\u6982\u53ef\u4ee5\u731c\u5230\uff0c\u8fd9\u4e9b\u7a7a\u95f4\u7559\u7ed9\u4e86 LVM \u7684\u5143\u6570\u636e\u3002LVM \u7684\u5143\u6570\u636e\u4e3a\u7eaf\u6587\u672c\u683c\u5f0f\uff0c\u53ef\u4ee5\u5b58\u50a8\u76f8\u5bf9\u590d\u6742\u7684\u4fe1\u606f\uff0c\u4f46\u662f\u4e5f\u5e26\u6765\u4e86\u4e0b\u8ff0\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ul> <li>LVM \u7684\u5143\u6570\u636e\u683c\u5f0f\u6ca1\u6709\u4e66\u9762\u7684\u6807\u51c6\uff0c\u56e0\u6b64\u5176\u4ed6\u8f6f\u4ef6\u5728\u89e3\u6790 LVM \u5143\u6570\u636e\u65f6\u53ef\u80fd\u4f1a\u51fa\u73b0\u95ee\u9898\u3002\u79d1\u5927\u955c\u50cf\u7ad9\u7684\u673a\u5668\u5c31\u9047\u5230\u8fc7 GRUB \u89e3\u6790 LVM \u5143\u6570\u636e\u4ee3\u7801\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u65e0\u6cd5\u6b63\u786e\u914d\u7f6e\u542f\u52a8\u5668\u3002 \u8fd9\u4e2a\u95ee\u9898\u76f4\u5230\u73b0\u5728\u90fd\u6ca1\u6709\u88ab GRUB \u4fee\u590d\uff0c\u56e0\u6b64\u53ea\u80fd\u81ea\u884c\u7f16\u8bd1\u624b\u52a8\u4fee\u590d\u540e\u7684\u7248\u672c\uff0c\u5e76\u4e14\u56fa\u5b9a GRUB \u7248\u672c\u3002</li> <li>LVM \u7684\u7eaf\u6587\u672c\u683c\u5f0f\u5bfc\u81f4\u5143\u6570\u636e\u672c\u8eab\u8f83\u5927\uff0c\u5982\u679c\u9884\u5206\u914d\u7684\u5143\u6570\u636e\u7a7a\u95f4\u4e0d\u8db3\uff0c\u5e76\u4e14\u5377\u7ec4\u4e2d\u6709\u5927\u91cf\u903b\u8f91\u5377\uff08\u9ed8\u8ba4\u503c + \u4e0a\u5343\u4e2a LV \u5c31\u4f1a\u51fa\u73b0\u95ee\u9898\uff09\uff0c\u90a3\u4e48\u6700\u540e\u4f1a\u5bfc\u81f4\u65e0\u6cd5\u518d\u521b\u5efa/\u6269\u5bb9\u903b\u8f91\u5377\uff0c\u5e76\u4e14\u53ea\u80fd\u901a\u8fc7\u6dfb\u52a0\u65b0\u7684\u7269\u7406\u5377\uff0c\u7136\u540e\u7531\u8be5\u5377\u5b58\u50a8\u5143\u6570\u636e\u6765\u89e3\u51b3\u95ee\u9898\u3002Vlab \u9879\u76ee\u66fe\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u95ee\u9898\u3002</li> </ul> <p>\u8fd9\u91cc\u521b\u5efa\u7684\u903b\u8f91\u5377\u6a2a\u8de8\u4e86\u4e09\u5757\u76d8\uff0c\u6240\u4ee5 LVM \u9ed8\u8ba4\u662f RAID 0\uff1f</p> <p>\u8fd9\u662f\u4e0d\u6b63\u786e\u7684\u3002\u8fd9\u91cc\u903b\u8f91\u5377\u7684\u6570\u636e\u5e03\u5c40\u4e0e RAID 0 \u4e0d\u540c\u3002RAID 0 \u8003\u8651\u7684\u662f\u6027\u80fd\uff0c\u56e0\u6b64\u6570\u636e\u7c7b\u4f3c\u4e8e\u8fd9\u4e48\u5b58\u50a8\uff1a</p> Disk 1 Disk 2 Disk 3 0 1 2 3 4 5 6 7 8 ... ... ... <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u5e94\u7528\u7a0b\u5e8f\u987a\u5e8f\u8bfb\u5199\u65f6\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u591a\u5757\u76d8\u7684\u5e76\u884c\u8bfb\u5199\u80fd\u529b\u3002\u4f46\u662f LVM \u7c7b\u4f3c\u4e8e\u8fd9\u6837\uff1a</p> Disk 1 Disk 2 Disk 3 0 100000 200000 1 100001 200001 2 100002 200002 ... ... ... <p>\u6bcf\u5757\u76d8\u662f\u987a\u5e8f\u586b\u5145\u7684\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u66f4\u52a0\u7075\u6d3b\u5730\u7ba1\u7406\u7a7a\u95f4\uff0c\u4f46\u662f\u6027\u80fd\u4e0d\u5982 RAID 0\u3002</p> <p>LVM \u4e5f\u63d0\u4f9b\u4e86\u521b\u5efa RAID 0 \u903b\u8f91\u5377\u7684\u529f\u80fd\uff0c\u88ab\u79f0\u4e3a\u300c\u6761\u5e26\u5316\u300d\uff08Striped\uff09\u5377\uff0c\u4e0a\u9762\u9ed8\u8ba4\u751f\u6210\u7684\u88ab\u79f0\u4e3a\u300c\u7ebf\u6027\u300d\uff08Linear\uff09\u5377\u3002</p>"},{"location":"ops/storage/lvm-raid/#raid","title":"\u521b\u5efa RAID","text":"<p>\u4e0d\u5efa\u8bae\u4f7f\u7528 LVM \u6784\u5efa RAID</p> <p>\u76f8\u6bd4\u4e8e mdadm\uff0cLVM \u4e0e RAID \u76f8\u5173\u7684\u6982\u5ff5\u4e0e\u63d0\u4f9b\u7684\u5de5\u5177\u66f4\u52a0\u590d\u6742\uff0c\u5e76\u4e14\u8fd9\u79cd\u590d\u6742\u6027\u5728\u5f88\u591a\u573a\u666f\u4e0b\u6ca1\u6709\u6536\u76ca\u3002 \u66f4\u52a0\u5e38\u89c1\u7684\u6a21\u5f0f\u662f\uff0c\u4f7f\u7528 mdadm \u6784\u5efa RAID\uff0c\u7136\u540e\u4f7f\u7528 LVM \u7ba1\u7406\u6784\u5efa\u597d\u7684 RAID \u4e0a\u7684\u903b\u8f91\u5377\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u5bf9\u4e8e\u591a\u76d8\u573a\u666f\uff0c\u4e0a\u9762\u7684\u4f8b\u5b50\u663e\u7136\u662f\u4e0d\u6ee1\u8db3\u9700\u6c42\u7684\uff1a\u521b\u5efa\u51fa\u7684\u903b\u8f91\u5377\u4ecd\u7136\u662f\u6709\u4e00\u5757\u76d8\u574f\u6389\u5c31\u4f1a\u6545\u969c\u7684\u72b6\u6001\u3002 \u4ee5\u4e0b\u5c55\u793a\u4e86 RAID0, 1, 5 \u7684\u521b\u5efa\u65b9\u5f0f\uff1a</p> <pre><code>$ sudo lvremove vg201-test/lvol0  # \u5220\u9664\u521a\u624d\u7684 LV\uff0c\u817e\u51fa\u4e00\u4e9b\u7a7a\u95f4\nDo you really want to remove active logical volume vg201-test/lvol0? [y/n]: y\n  Logical volume \"lvol0\" successfully removed.\n$ # RAID 0 (striped)\u3002--stripes \u53c2\u6570\u6307\u5b9a\u4e86\u6761\u5e26\u7684\u6570\u91cf\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\u548c\u76d8\u6570\u91cf\u4e00\u81f4\n$ sudo lvcreate -n lvraid0 -L 0.5G --type striped --stripes 3 vg201-test\n  Using default stripesize 64.00 KiB.\n  Logical volume \"lvraid0\" created.\n$ # RAID 1\u3002--mirrors \u53c2\u6570\u6307\u5b9a\u4e86\u526f\u672c\u6570\u91cf\uff08\u4e0d\u542b\u672c\u4f53\uff09\uff0c\u6240\u4ee5\u662f\u76d8\u6570\u91cf\u51cf\u4e00\n$ sudo lvcreate -n lvraid1 -L 0.5G --type raid1 --mirrors 2 vg201-test\n  Logical volume \"lvraid1\" created.\n$ # \u56e0\u4e3a\u53ea\u6709 3 \u5757\u76d8\uff0c\u8fd9\u91cc\u5c55\u793a RAID 5\u3002--stripes \u53c2\u6570\u4e0d\u5305\u542b\u989d\u5916\u7684\u9a8c\u8bc1\u76d8\u3002\n$ sudo lvcreate -n lvraid5 -L 0.2G --type raid5 --stripes 2 vg201-test\n  Using default stripesize 64.00 KiB.\n  Rounding up size to full physical extent 208.00 MiB\n  Logical volume \"lvraid5\" created.\n$ sudo lvs\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvraid0 vg201-test -wi-a----- 516.00m                                                    \n  lvraid1 vg201-test rwi-a-r--- 512.00m                                    100.00          \n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00\n</code></pre> <p>\u4e0d\u8981\u4f7f\u7528 <code>--type mirror</code></p> <p><code>mirror</code> \u548c <code>raid1</code> \u662f\u4e24\u4e2a\u4e0d\u540c\u7684 type\u3002\u9664\u975e\u6709\u7279\u6b8a\u9700\u8981\uff0c\u5426\u5219\u5e94\u8be5\u4f7f\u7528 <code>--type raid1</code> \u521b\u5efa RAID 1 \u9635\u5217\u3002 \u53ef\u4ee5\u4f7f\u7528 <code>lvconvert</code> \u5c06 mirror \u8f6c\u6362\u4e3a raid1\u3002</p> <p>\u76f8\u5173\u8ba8\u8bba\u53ef\u67e5\u770b In what case(s) will <code>--type mirror</code> continue to be a good choice / is not deprecated?\u3002</p> <p>\u5728\u540e\u6587\u7684\u7f3a\u76d8\u6d4b\u8bd5\u4e2d\uff0c<code>mirror</code> \u7684\u884c\u4e3a\u4e5f\u4e0e\u9884\u671f\u4e0d\u540c\u2014\u2014LVM \u9ed8\u8ba4\u4f1a\u62d2\u7edd\u6302\u8f7d\uff0c\u5982\u679c\u5f3a\u884c\u6302\u8f7d\uff0c\u4f1a\u76f4\u63a5\u5c06\u7f3a\u5931\u7684\u76d8\u4e22\u6389\u3002</p> <p>Extent \u662f\u591a\u5927</p> <p>\u6709\u65f6\u5728\u8f93\u5165\u9519\u8bef\u7684\u53c2\u6570\u4e4b\u540e\uff0c\u4f1a\u51fa\u73b0 extent \u4e0d\u8db3\u7684\u63d0\u793a\uff0c\u7c7b\u4f3c\u4e8e\u8fd9\u6837\uff1a</p> <pre><code>$ # --mirrors \u53c2\u6570\u591a\u4e86\u4e00\uff0c\u7a7a\u95f4\u4e0d\u591f\n$ sudo lvcreate -n lvraid1 -L 0.5G --type raid1 --mirrors 3 vg201-test\n  Insufficient suitable allocatable extents for logical volume lvraid1: 516 more required\n</code></pre> <p>\u4f46\u662f \"extent\" \u662f\u591a\u5927\u5462\uff1f\u5728 LVM \u4e2d\uff0c\u6709\u4e24\u79cd extent: PE\uff08Physical Extent\uff09\u548c LE\uff08Logical Extent\uff09\uff0c \u5bf9\u5e94\u7269\u7406\u5377\u548c\u903b\u8f91\u5377\u7684\u5927\u5c0f\u53c2\u6570\u3002\u8fd9\u91cc\u6307\u7684\u662f PE\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>pvdisplay</code> \u6216 <code>vgdisplay</code> \u67e5\u770b\u3002</p> <pre><code>$ sudo vgdisplay\n  --- Volume group ---\n  VG Name               vg201-test\n  System ID             \n  Format                lvm2\n  Metadata Areas        3\n  Metadata Sequence No  11\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                2\n  Open LV               0\n  Max PV                0\n  Cur PV                3\n  Act PV                3\n  VG Size               &lt;2.99 GiB\n  PE Size               4.00 MiB\n  Total PE              765\n  Alloc PE / Size       514 / &lt;2.01 GiB\n  Free  PE / Size       251 / 1004.00 MiB\n  VG UUID               Ybsskf-2giI-Q5PU-LCof-Irr9-EDud-nlB0Ms\n$ sudo pvdisplay\n  --- Physical volume ---\n  PV Name               /dev/loop0\n  VG Name               vg201-test\n  PV Size               1.00 GiB / not usable 4.00 MiB\n  Allocatable           yes \n  PE Size               4.00 MiB\n  Total PE              255\n  Free PE               84\n  Allocated PE          171\n  PV UUID               DBn9ke-9UfO-tZJA-ymSh-GQtP-jMq8-tSm62B\n\n  --- Physical volume ---\n  PV Name               /dev/loop1\n  VG Name               vg201-test\n  PV Size               1.00 GiB / not usable 4.00 MiB\n  Allocatable           yes \n  PE Size               4.00 MiB\n  Total PE              255\n  Free PE               84\n  Allocated PE          171\n  PV UUID               aut3hf-J6Tl-O5Gq-0TIw-bneD-mfzr-8wMJJx\n\n  --- Physical volume ---\n  PV Name               /dev/loop2\n  VG Name               vg201-test\n  PV Size               1.00 GiB / not usable 4.00 MiB\n  Allocatable           yes \n  PE Size               4.00 MiB\n  Total PE              255\n  Free PE               83\n  Allocated PE          172\n  PV UUID               AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 PE \u662f 4M\uff0c\u56e0\u6b64\u7f3a\u5c11 516 \u4e2a extent \u6307\u7f3a\u5c11 516 * 4M ~= 2G \u7a7a\u95f4\u3002 \u8fd9\u91cc\u662f\u56e0\u4e3a PV \u6570\u91cf\u4e0d\u8db3\uff0c\u6240\u4ee5\u65e0\u6cd5\u627e\u5230\u80fd\u591f\u5b58\u50a8\u7b2c\u56db\u4efd\u526f\u672c\u7684\u78c1\u76d8\u3002</p> <p><code>lvs</code> \u652f\u6301\u6307\u5b9a\u53c2\u6570\u67e5\u770b LV \u7684\u5176\u4ed6\u4fe1\u606f\uff0c\u8fd9\u91cc\u6211\u4eec\u67e5\u770b\u903b\u8f91\u5377\u5b9e\u9645\u4f7f\u7528\u7684\u7269\u7406\u5377\uff1a</p> <pre><code>$ sudo lvs -a -o +devices vg201-test\n  LV                 VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices                                                    \n  lvraid0            vg201-test -wi-a----- 516.00m                                                     /dev/loop0(0),/dev/loop1(0),/dev/loop2(0)                  \n  lvraid1            vg201-test rwi-a-r--- 512.00m                                    100.00           lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0] vg201-test iwi-aor--- 512.00m                                                     /dev/loop0(44)                                             \n  [lvraid1_rimage_1] vg201-test iwi-aor--- 512.00m                                                     /dev/loop1(44)                                             \n  [lvraid1_rimage_2] vg201-test iwi-aor--- 512.00m                                                     /dev/loop2(44)                                             \n  [lvraid1_rmeta_0]  vg201-test ewi-aor---   4.00m                                                     /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]  vg201-test ewi-aor---   4.00m                                                     /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]  vg201-test ewi-aor---   4.00m                                                     /dev/loop2(43)                                             \n  lvraid5            vg201-test rwi-a-r--- 208.00m                                    100.00           lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0] vg201-test iwi-aor--- 104.00m                                                     /dev/loop0(173)                                            \n  [lvraid5_rimage_1] vg201-test iwi-aor--- 104.00m                                                     /dev/loop1(173)                                            \n  [lvraid5_rimage_2] vg201-test iwi-aor--- 104.00m                                                     /dev/loop2(173)                                            \n  [lvraid5_rmeta_0]  vg201-test ewi-aor---   4.00m                                                     /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]  vg201-test ewi-aor---   4.00m                                                     /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]  vg201-test ewi-aor---   4.00m                                                     /dev/loop2(172)\n</code></pre> rimage, rmeta\uff08\u4e0e mimage, mlog\uff09 <p>\u53ef\u4ee5\u89c2\u5bdf\u5230\uff0c\u5217\u8868\u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9ed8\u8ba4\u9690\u85cf\u7684\u903b\u8f91\u5377\uff0c\u5b83\u4eec\u662f\u521b\u5efa RAID 1/5/6 \u7684\u4ea7\u7269\uff1a</p> <ul> <li>rimage: \"RAID image\"\uff0c\u4ee3\u8868\u4e86\u5b9e\u9645\u5b58\u50a8\u6570\u636e\uff08\u4ee5\u53ca\u6821\u9a8c\u4fe1\u606f\uff09\u7684\u903b\u8f91\u5377</li> <li>rmeta: \u5b58\u50a8\u4e86 RAID \u7684\u5143\u6570\u636e\u4fe1\u606f</li> </ul> <p>\u5982\u679c\u5728\u521b\u5efa RAID 1 \u65f6\u9009\u62e9\u4e86 <code>--type mirror</code>\uff0c\u90a3\u4e48\u5bf9\u5e94\u521b\u5efa\u7684\u662f mimage \u548c mlog\uff1a</p> <ul> <li>mimage: \"mirrored image\"\uff0c\u6570\u636e\u5199\u5165\u65f6\uff0c\u4f1a\u5411\u6bcf\u4e2a\u5173\u8054\u7684 mimage \u5199\u5165\u6570\u636e</li> <li>mlog: \u5b58\u50a8\u4e86 RAID 1 \u7684\u76d8\u4e4b\u95f4\u7684\u540c\u6b65\u72b6\u6001\u4fe1\u606f</li> </ul>"},{"location":"ops/storage/lvm-raid/#raid_1","title":"RAID \u7ef4\u62a4","text":""},{"location":"ops/storage/lvm-raid/#raid_2","title":"RAID \u72b6\u6001\u4e0e\u91cd\u5efa","text":"<p>\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c<code>lvs</code> \u8fd4\u56de\u7684 RAID 1/5/6 \u8bbe\u5907\u7684 \"Cpy%Sync\" \u5e94\u8be5\u662f 100.00\uff0c\u8868\u793a\u6570\u636e\u5df2\u7ecf\u540c\u6b65\u5230\u6240\u6709\u76d8\u4e0a\u3002 \u5e76\u4e14 <code>health_status</code> \u5c5e\u6027\u5e94\u8be5\u4e3a\u7a7a\u3002\u8fd9\u91cc\u6a21\u62df\u5f3a\u5236\u5220\u9664\u4e00\u5757\u76d8\u7684\u60c5\u51b5\uff1a</p> <pre><code>$ sudo vgchange -an vg201-test\n  0 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo losetup -D\n$ # \u63a5\u4e0b\u6765\u53ea\u6302\u8f7d\u4e24\u5757\u76d8\n$ sudo losetup -f --show pv1.img\n/dev/loop0\n$ sudo losetup -f --show pv2.img\n/dev/loop1\n$ sudo pvs\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  PV         VG         Fmt  Attr PSize    PFree  \n  /dev/loop0 vg201-test lvm2 a--  1020.00m 228.00m\n  /dev/loop1 vg201-test lvm2 a--  1020.00m 228.00m\n  [unknown]  vg201-test lvm2 a-m  1020.00m 224.00m\n$ sudo vgchange -ay vg201-test\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  Refusing activation of partial LV vg201-test/lvraid0.  Use '--activationmode partial' to override.\n  2 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo lvs -a -o name,copy_percent,health_status,devices vg201-test\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  LV                 Cpy%Sync Health          Devices                                                    \n  lvraid0                     partial         /dev/loop0(0),/dev/loop1(0),[unknown](0)                   \n  lvraid1            100.00   partial         lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0]                          /dev/loop0(44)                                             \n  [lvraid1_rimage_1]                          /dev/loop1(44)                                             \n  [lvraid1_rimage_2]          partial         [unknown](44)                                              \n  [lvraid1_rmeta_0]                           /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]                           /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]           partial         [unknown](43)                                              \n  lvraid5            100.00   partial         lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0]                          /dev/loop0(173)                                            \n  [lvraid5_rimage_1]                          /dev/loop1(173)                                            \n  [lvraid5_rimage_2]          partial         [unknown](173)                                             \n  [lvraid5_rmeta_0]                           /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]                           /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]           partial         [unknown](172)\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\uff1a</p> <ul> <li>RAID 0 \u7531\u4e8e\u7f3a\u5c11\u4e00\u5757\u76d8\uff0cLVM \u4f1a\u62d2\u7edd\u6fc0\u6d3b</li> <li>RAID 1/5 \u53ef\u4ee5\u6fc0\u6d3b\uff0c\u4f46\u662f health_status \u4e3a partial\uff0c\u8868\u793a\u5bf9\u5e94\u9635\u5217\u5904\u4e8e\u4e0d\u5b8c\u6574\u7684\u72b6\u6001</li> </ul> <p>\u5047\u8bbe\u6211\u4eec\u6dfb\u52a0\u4e00\u5757\u65b0\u76d8\uff0c\u5e76\u5220\u9664\u65e7\u76d8\uff0c\u8fdb\u884c RAID 1/5 \u7684\u91cd\u5efa\uff1a</p> <pre><code>$ truncate -s 1G pv4.img\n$ sudo losetup /dev/loop3 pv4.img\n$ sudo pvcreate /dev/loop3\n  Physical volume \"/dev/loop3\" successfully created.\n$ sudo vgextend vg201-test /dev/loop3\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to /dev/loop2).\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  Volume group \"vg201-test\" successfully extended\n$ sudo lvconvert --repair vg201-test/lvraid1\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to [unknown]).\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\nAttempt to replace failed RAID images (requires full device resync)? [y/n]: y\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  Faulty devices in vg201-test/lvraid1 successfully replaced.\n$ sudo lvconvert --repair vg201-test/lvraid5\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to [unknown]).\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\nAttempt to replace failed RAID images (requires full device resync)? [y/n]: y\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  Faulty devices in vg201-test/lvraid5 successfully replaced.\n$ sudo lvs -a -o name,copy_percent,health_status,devices vg201-test\n  WARNING: Couldn't find device with uuid AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test is missing PV AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ (last written to [unknown]).\n  LV                 Cpy%Sync Health          Devices                                                    \n  lvraid0                     partial         /dev/loop0(0),/dev/loop1(0),[unknown](0)                   \n  lvraid1            100.00                   lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0]                          /dev/loop0(44)                                             \n  [lvraid1_rimage_1]                          /dev/loop1(44)                                             \n  [lvraid1_rimage_2]                          /dev/loop3(1)                                              \n  [lvraid1_rmeta_0]                           /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]                           /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]                           /dev/loop3(0)                                              \n  lvraid5            100.00                   lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0]                          /dev/loop0(173)                                            \n  [lvraid5_rimage_1]                          /dev/loop1(173)                                            \n  [lvraid5_rimage_2]                          /dev/loop3(130)                                            \n  [lvraid5_rmeta_0]                           /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]                           /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]                           /dev/loop3(129)\n</code></pre> <p>\u4e0b\u9762\u5c55\u793a\u5c06\u539f\u59cb\u7684 <code>/dev/loop2</code> \u6062\u590d\u56de vg201-test \u7684\u8fc7\u7a0b\uff0c\u4ee5\u300c\u6062\u590d\u300d\u6700\u540e\u7684 RAID 0\u3002 \u901a\u8fc7\u4f7f\u7528 <code>vgextend</code> \u7684 <code>--restoremissing</code> \u53c2\u6570\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u91cd\u65b0\u521d\u59cb\u5316 <code>/dev/loop2</code>\uff0c\u800c\u662f\u76f4\u63a5\u5c06\u5176\u52a0\u5165\u5230\u5377\u7ec4\u4e2d\u3002 \u53ea\u5728\u786e\u5b9a\u539f\u59cb\u7684 PV \u6ca1\u6709\u88ab\u4fee\u6539\u7684\u60c5\u51b5\u4e0b\u624d\u80fd\u5982\u6b64\u64cd\u4f5c\u3002</p> <pre><code>$ sudo losetup /dev/loop2 pv3.img\n$ sudo pvs\n  WARNING: ignoring metadata seqno 37 on /dev/loop2 for seqno 43 on /dev/loop0 for VG vg201-test.\n  WARNING: Inconsistent metadata found for VG vg201-test.\n  See vgck --updatemetadata to correct inconsistency.\n  WARNING: VG vg201-test was previously updated while PV /dev/loop2 was missing.\n  WARNING: VG vg201-test was missing PV /dev/loop2 AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  PV         VG         Fmt  Attr PSize    PFree  \n  /dev/loop0 vg201-test lvm2 a--  1020.00m 224.00m\n  /dev/loop1 vg201-test lvm2 a--  1020.00m 224.00m\n  /dev/loop2 vg201-test lvm2 a-m  1020.00m 848.00m\n  /dev/loop3 vg201-test lvm2 a--  1020.00m 396.00m\n$ sudo vgextend vg201-test /dev/loop2 --restoremissing\n  WARNING: ignoring metadata seqno 37 on /dev/loop2 for seqno 43 on /dev/loop0 for VG vg201-test.\n  WARNING: Inconsistent metadata found for VG vg201-test.\n  See vgck --updatemetadata to correct inconsistency.\n  WARNING: VG vg201-test was previously updated while PV /dev/loop2 was missing.\n  WARNING: VG vg201-test was missing PV /dev/loop2 AQj8ej-EKps-ud3h-0KkP-wDxo-ZagG-ZJIdnZ.\n  WARNING: VG vg201-test was previously updated while PV /dev/loop2 was missing.\n  WARNING: updating old metadata to 44 on /dev/loop2 for VG vg201-test.\n  Volume group \"vg201-test\" successfully extended\n$ sudo lvs -a -o name,copy_percent,health_status,devices vg201-test\n  LV                 Cpy%Sync Health          Devices                                                    \n  lvraid0                                     /dev/loop0(0),/dev/loop1(0),/dev/loop2(0)                  \n  lvraid1            100.00                   lvraid1_rimage_0(0),lvraid1_rimage_1(0),lvraid1_rimage_2(0)\n  [lvraid1_rimage_0]                          /dev/loop0(44)                                             \n  [lvraid1_rimage_1]                          /dev/loop1(44)                                             \n  [lvraid1_rimage_2]                          /dev/loop3(1)                                              \n  [lvraid1_rmeta_0]                           /dev/loop0(43)                                             \n  [lvraid1_rmeta_1]                           /dev/loop1(43)                                             \n  [lvraid1_rmeta_2]                           /dev/loop3(0)                                              \n  lvraid5            100.00                   lvraid5_rimage_0(0),lvraid5_rimage_1(0),lvraid5_rimage_2(0)\n  [lvraid5_rimage_0]                          /dev/loop0(173)                                            \n  [lvraid5_rimage_1]                          /dev/loop1(173)                                            \n  [lvraid5_rimage_2]                          /dev/loop3(130)                                            \n  [lvraid5_rmeta_0]                           /dev/loop0(172)                                            \n  [lvraid5_rmeta_1]                           /dev/loop1(172)                                            \n  [lvraid5_rmeta_2]                           /dev/loop3(129)\n</code></pre>"},{"location":"ops/storage/lvm-raid/#_2","title":"\u5b8c\u6574\u6027\u68c0\u67e5","text":"<p>\u5373\u4f7f\u6b63\u5e38\u8fd0\u884c\uff0cRAID \u4e5f\u65e0\u6cd5\u9632\u6b62\u9635\u5217\u4e2d\u7684\u67d0\u5757\u786c\u76d8\u56e0\u4e3a\u67d0\u79cd\u539f\u56e0\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5\uff08\u4f8b\u5982\u6bd4\u7279\u7ffb\u8f6c\uff09\uff0c \u56e0\u6b64\u5b9a\u671f\u8fdb\u884c\u5b8c\u6574\u6027\u68c0\u67e5\uff08Scrub\uff09\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002\u4ee5\u4e0b\u5c55\u793a\u4e00\u4e2a\u6ca1\u6709\u5b9a\u671f scrub \u7684\u53cd\u4f8b\uff1a</p> <p>\u6709\u4e00\u4e2a\u4e09\u5757\u76d8\u7684 RAID1\uff0c\u56e0\u4e3a\u67d0\u4e9b\u795e\u5947\u7684\u8bef\u64cd\u4f5c\uff0c\u5176\u4e2d\u4e00\u5757\u76d8\u7684\u72b6\u6001\u4e00\u76f4\u662f 2018 \u5e74\u7684\uff0c\u53e6\u4e24\u5757\u662f\u6b63\u786e\u7684 RAID1\uff0c\u7136\u540e\u8fd9\u7ec4\u76d8\u88ab\u632a\u5230\u4e86\u65b0\u673a\u5668\uff0c\u88ab\u91cd\u65b0\u52a0\u6210\u4e86\u4e00\u4e2a\u4e09\u76d8\u7684 RAID1\uff0c\u8f6f RAID \u8f6f\u4ef6 somehow \u6ca1\u6709\u505a\u68c0\u67e5\u5c31\u8dd1\u4e86\u8d77\u6765\uff0c\u4e8e\u662f\u8bfb\u6587\u4ef6\u65f6\u6709 1/3 \u6982\u7387\u8bfb\u53d6\u5230\u65e7\u76d8\uff0c\u4e5f\u5c31\u662f ls \u4e00\u4e0b\u53ef\u80fd\u770b\u5230\u65e7\u6587\u4ef6\u4e5f\u53ef\u80fd\u770b\u5230\u65b0\u6587\u4ef6\uff0c\u53ef\u80fd\u8fd9\u6837\u7528\u4e86\u5f88\u957f\u4e00\u6bb5\u65f6\u95f4\u4e00\u76f4\u6ca1\u53d1\u73b0\uff0c\u6628\u5929\u91cd\u542f\u4e4b\u540e\u7a81\u7136\u53d1\u73b0 glibc \u56de\u5230\u4e86 2018 \u5e74</p> <p>\u53e6\u4e00\u4e2a\u6ca1\u6709 scrub \u6570\u636e\uff0c\u6700\u7ec8\u5bfc\u81f4\u6587\u4ef6\u4e22\u5931\u7684\u4f8b\u5b50\u662f Linus Tech Tips\uff08YouTube/Bilibili, 05:15\uff09\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u5411 <code>pv4.img</code> \u4e2d\u95f4\u5199\u5165 1M \u7684\u968f\u673a\u6570\u636e\uff0c\u5e76\u5c55\u793a LVM \u7684\u68c0\u67e5\u4e0e\u4fee\u590d\u529f\u80fd\u3002</p> <pre><code>$ sudo dd if=/dev/urandom of=/dev/loop3 bs=1M count=1 oseek=100\n1+0 records in\n1+0 records out\n1048576 bytes (1.0 MB, 1.0 MiB) copied, 0.00402655 s, 260 MB/s\n$ sudo lvs -o devices vg201-test\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvraid0 vg201-test -wi------- 516.00m                                                    \n  lvraid1 vg201-test rwi-a-r--- 512.00m                                    100.00          \n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00\n$ sudo lvchange --syncaction check vg201-test/lvraid1\n$ sudo dmesg\n\uff08\u7701\u7565\uff09\n[1655658.162616] md: mdX: data-check done.\n[1655663.533169] md: data-check of RAID array mdX\n$ sudo lvs -o +raid_sync_action,raid_mismatch_count\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert SyncAction Mismatches\n  lvraid0 vg201-test -wi------- 516.00m                                                                          \n  lvraid1 vg201-test rwi-a-r-m- 512.00m                                    100.00           idle             2048\n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00           idle                0\n$ # \u56e0\u4e3a\u6211\u4eec\u7684 RAID 1 \u6709\u4e09\u5757\u76d8\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684\u300c\u4e0d\u4e00\u81f4\u300d\u8fd8\u53ef\u4ee5\u4fee\u590d\u3002\n$ sudo lvchange --syncaction repair vg201-test/lvraid1\n$ sudo dmesg\n\uff08\u7701\u7565\uff09\n[1655787.490037] md: requested-resync of RAID array mdX\n[1655789.691174] md: mdX: requested-resync done.\n$ sudo lvs -o +raid_sync_action,raid_mismatch_count\n  LV      VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert SyncAction Mismatches\n  lvraid0 vg201-test -wi------- 516.00m                                                                          \n  lvraid1 vg201-test rwi-a-r--- 512.00m                                    100.00           idle                0\n  lvraid5 vg201-test rwi-a-r--- 208.00m                                    100.00           idle                0\n</code></pre> <p>dm-integrity</p> <p>LVM \u652f\u6301\u5728\u8bbe\u7f6e RAID \u65f6\u6dfb\u52a0 integrity \u529f\u80fd\uff08<code>--raidintegrity</code>\uff09\uff0c\u8fd9\u9879\u529f\u80fd\u4e3a\u6570\u636e\u6dfb\u52a0\u4e86\u6821\u9a8c\u548c\uff0c LVM \u5728\u53d1\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u65f6\u4f1a\u5728\u5185\u6838\u65e5\u5fd7\u4e2d\u62a5\u544a\uff0c\u5e76\u5728\u53ef\u4ee5\u4fee\u590d\u7684\u60c5\u51b5\u4e0b\u81ea\u52a8\u4fee\u590d\u3002</p> <p>\u8fd9\u9879\u529f\u80fd\u4e0d\u662f scrub \u7684\u66ff\u4ee3\u54c1\u3002</p>"},{"location":"ops/storage/lvm-raid/#ssd","title":"SSD \u7f13\u5b58","text":"<p>LVM \u652f\u6301\u5c06 SSD \u4f5c\u4e3a HDD \u7684\u7f13\u5b58\uff0c\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002\u4ee5\u4e0b\u4ecb\u7ecd\u57fa\u4e8e dm-cache \u7684\u8bfb\u5199\u7f13\u5b58\u3002</p> <p>dm-writecache</p> <p>\u672c\u90e8\u5206\u4e0d\u4ecb\u7ecd\u4ee5\u4f18\u5316\u5199\u5165\u4e3a\u76ee\u7684\u7684 dm-writecache\u2014\u2014\u6211\u4eec\u6ca1\u6709\u76f8\u5173\u7684\u4f7f\u7528\u573a\u666f\u3002</p> <p>\u7f13\u5b58\u65b9\u6848</p> <p>\u76ee\u524d\u5185\u6838\u81ea\u5e26\u8fd9\u4e9b\u7f13\u5b58\u65b9\u6848\uff1a</p> <ul> <li>bcache\uff1a\u9700\u8981\u5c06 SSD \u548c HDD \u5bf9\u5e94\u7684\u5757\u8bbe\u5907\u5206\u533a\u4f7f\u7528 <code>make-bcache</code> \u521d\u59cb\u5316\u540e\uff0c \u5728 bcache \u66b4\u9732\u7684 <code>/dev/bcache0</code> \u4e0a\u8fdb\u884c\u64cd\u4f5c\u3002</li> <li>lvmcache\uff1a\u9700\u8981\u5728 LVM \u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u64cd\u4f5c\u3002\u57fa\u4e8e\u5185\u6838\u7684 dm-cache\u3002</li> </ul> <p>\u6b64\u5916\uff0c\u5728 Linux 6.7\uff082024 \u5e74 1 \u6708\uff09\u4e4b\u540e\uff0c\u5185\u6838\u5408\u5e76\u4e86 bcachefs \u652f\u6301\uff0c\u5b83\u540c\u6837\u4e5f\u5305\u542b\u4e86 SSD \u7f13\u5b58\u7684\u529f\u80fd\u3002 \u4f46\u662f bcachefs \u7684\u7a33\u5b9a\u6027\u4ecd\u7136\u9700\u8981\u81f3\u5c11\u6570\u5e74\u7684\u65f6\u95f4\u6765\u9a8c\u8bc1\u3002ZFS \u540c\u6837\u4e5f\u5305\u542b\u7f13\u5b58\u529f\u80fd\uff08ARC \u4e0e L2ARC\uff09\uff0c\u5c06\u5728 ZFS \u4e2d\u4ecb\u7ecd\u3002</p> <p>\u4e0d\u8fc7\uff0c\u968f\u7740 SSD \u5355\u4f4d\u7a7a\u95f4\u6210\u672c\u9010\u6e10\u964d\u4f4e\uff0cSSD \u7f13\u5b58\u7684\u610f\u4e49\u4e5f\u5728\u9010\u6e10\u51cf\u5c0f\u3002 \u751a\u81f3\u4e5f\u6709\u9884\u6d4b\u8868\u660e\uff0c\u5230 2026 \u5e74\u540e SSD \u7684\u6210\u672c\u751a\u81f3\u4f1a\u4f4e\u4e8e HDD\u3002\u5185\u6838\u4e2d <code>dm-cache</code> \u7684\u5f00\u53d1\u4e5f\u4e0d\u6d3b\u8dc3\u3002</p> <p>\u5728\u8003\u8651\u7f13\u5b58\u65b9\u6848\u7684\u9009\u62e9\u65f6\uff0c\u9700\u8981\u8003\u8651\u5404\u79cd\u56e0\u7d20\uff0c\u4e0b\u6587\u4f1a\u505a\u4e00\u4e9b\u7b80\u5355\u7684\u4ecb\u7ecd\u3002</p> <p>\u9996\u5148\u5220\u9664\u4e0a\u9762\u521b\u5efa\u7684 LV \u4e0e PV\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5927\u7684 image \u548c\u4e00\u4e2a\u5c0f\u7684 image \u4f5c\u4e3a HDD \u4e0e SSD\uff1a</p> <pre><code>$ sudo lvremove vg201-test/lvraid0 vg201-test/lvraid1 vg201-test/lvraid5\n  Logical volume \"lvraid0\" successfully removed.\nDo you really want to remove active logical volume vg201-test/lvraid1? [y/n]: y\n  Logical volume \"lvraid1\" successfully removed.\nDo you really want to remove active logical volume vg201-test/lvraid5? [y/n]: y\n  Logical volume \"lvraid5\" successfully removed.\n$ sudo vgremove vg201-test\n  Volume group \"vg201-test\" successfully removed\n$ sudo losetup -D\n$ rm pv*.img\n$ truncate -s 100G hdd.img\n$ truncate -s 10G ssd.img\n$ sudo losetup -f --show hdd.img\n/dev/loop0\n$ sudo losetup -f --show ssd.img\n/dev/loop1\n$ sudo pvcreate /dev/loop0 /dev/loop1\n  Physical volume \"/dev/loop0\" successfully created.\n  Physical volume \"/dev/loop1\" successfully created.\n$ sudo vgcreate vg201-test /dev/loop0 /dev/loop1\n  Volume group \"vg201-test\" successfully created\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa\u5b58\u50a8\uff08\u540e\u5907\uff09\u6570\u636e\u7684 LV\uff0c\u8fd9\u4e2a LV \u53ea\u5e94\u8be5\u5728 HDD \u4e0a\uff1a</p> <pre><code>$ sudo lvcreate -n lvdata -l 100%FREE vg201-test /dev/loop0\n  Logical volume \"lvdata\" created.\n$ sudo lvs -o +devices vg201-test\n  LV     VG         Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices      \n  lvdata vg201-test -wi-a----- &lt;100.00g                                                     /dev/loop0(0)\n</code></pre> <p>@taoky: \u53e6\u4e00\u79cd\u505a\u6cd5</p> <p>\u5728\u914d\u7f6e mirrors4 \u670d\u52a1\u5668\u7684\u7f13\u5b58\u65f6\uff0c\u6211\u4eec\u7684\u6587\u6863\u4e2d\u7684\u505a\u6cd5\u662f\u628a SSD \u548c HDD \u5206\u522b\u5f00 VG\uff0c\u5728\u540e\u9762\u521b\u5efa\u597d\u4e4b\u540e\u518d <code>vgmerge</code>\u3002</p> <p>\u8fd9\u4e48\u505a\u5176\u5b9e\u662f\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u53ea\u8981 <code>lvcreate</code> \u7684\u65f6\u5019\u6e05\u9192\u4e00\u4e9b\u5c31\u884c\u3002 \u51b5\u4e14\u7f13\u5b58\u76d8\u548c\u540e\u5907\u8bbe\u5907\u5fc5\u987b\u5728\u540c\u4e00\u4e2a VG \u91cc\u5934\u3002</p> <p>\u4e4b\u540e\u6211\u4eec\u9700\u8981\u521b\u5efa\u7f13\u5b58\u76f8\u5173\u7684 LV\u3002LVM \u652f\u6301\u4e24\u79cd\u65b9\u5f0f\uff1a<code>cachevol</code> \u548c <code>cachepool</code>\uff1a</p> <ul> <li><code>cachevol</code> \u5728\u4e00\u4e2a LV \u4e2d\u5305\u542b\u4e86\u7f13\u5b58\u7684\u6570\u636e\u548c\u5143\u6570\u636e</li> <li><code>cachepool</code> \u5c06\u7f13\u5b58\u7684\u6570\u636e\u548c\u5143\u6570\u636e\u5206\u5f00\u5b58\u50a8\uff08\u56e0\u6b64\u53ef\u4ee5\u5c06\u6570\u636e\u548c\u5143\u6570\u636e\u653e\u5230\u4e0d\u540c\u7684\u8bbe\u5907\u4e0a\uff09</li> </ul> <p>\u8bb8\u591a\u6559\u7a0b\u4e2d\u90fd\u4f7f\u7528 <code>cachepool</code>\uff0c\u4f46\u662f\u5f88\u591a\u65f6\u5019\u662f\u6ca1\u6709\u5fc5\u8981\u7684\u3002</p> <p>\u4e0b\u9762\u5148\u5c55\u793a <code>cachevol</code> \u7684\u64cd\u4f5c\uff08\u53ea\u9700\u4e24\u6b65\uff1a\u521b\u5efa\u7f13\u5b58\u76d8\uff0c\u7136\u540e <code>lvconvert</code> \u914d\u7f6e\u7f13\u5b58\u5373\u53ef\uff09\uff1a</p> <pre><code>$ sudo lvcreate -n lvdata_cache -l 100%FREE vg201-test /dev/loop1\n  Logical volume \"lvdata_cache\" created.\n$ sudo lvconvert --type cache --cachevol lvdata_cache vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  Logical volume vg201-test/lvdata is now cached.\n$ sudo lvs -a -o +devices vg201-test\n  LV                  VG         Attr       LSize    Pool                Origin         Data%  Meta%  Move Log Cpy%Sync Convert Devices        \n  lvdata              vg201-test Cwi-a-C--- &lt;100.00g [lvdata_cache_cvol] [lvdata_corig] 0.01   11.07           0.00             lvdata_corig(0)\n  [lvdata_cache_cvol] vg201-test Cwi-aoC---  &lt;10.00g                                                                            /dev/loop1(0)  \n  [lvdata_corig]      vg201-test owi-aoC--- &lt;100.00g                                                                            /dev/loop0(0)\n</code></pre> <p><code>lvs</code> \u4e5f\u53ef\u4ee5\u8f93\u51fa\u4e00\u4e9b\u7f13\u5b58\u76f8\u5173\u7684\u914d\u7f6e\u548c\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <pre><code>$ sudo lvs -o devices,cache_policy,cachemode,cache_settings,cache_total_blocks,cache_used_blocks,cache_dirty_blocks,cache_read_hits,cache_read_misses,cache_write_hits,cache_write_misses\n  Devices         CachePolicy CacheMode    CacheSettings CacheTotalBlocks CacheUsedBlocks  CacheDirtyBlocks CacheReadHits    CacheReadMisses  CacheWriteHits   CacheWriteMisses\n  lvdata_corig(0) smq         writethrough                         163584               15                0                5               51                0                0\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u7f13\u5b58\u7684\u6a21\u5f0f\u662f writethrough\uff0c\u7b56\u7565\u662f smq\uff0c\u4ee5\u53ca\u7f13\u5b58\u7684\u8bfb\u5199\u547d\u4e2d\u7387\u4e0e\u810f\u5757\u6570\u91cf\u3002</p> <p>resize</p> <p>\u76f4\u5230\u76f8\u5bf9\u65b0\uff08&gt;= 2.03.12\uff0c\u53d1\u5e03\u4e8e 2021/05/08\uff09\u7684 LVM \u5de5\u5177\u4e4b\u524d\uff0c\u88ab\u7f13\u5b58\u7684 LV \u4e0d\u80fd\u88ab resize\u3002\u56e0\u6b64 resize \u4e4b\u524d\u5fc5\u987b\u5148\u64a4\u4e0b\u7f13\u5b58\uff0cresize \u7ed3\u675f\u540e\u518d\u5b89\u56de\u53bb\u3002</p> <p>\u56e0\u6b64 Debian Bookworm \u7684 LVM \u5de5\u5177\u652f\u6301\u8fd9\u79cd\u60c5\u51b5\u4e0b\u7684 resize\uff0c\u800c Bullseye \u4e0d\u652f\u6301\u3002</p> <p>lvmcache \u7684\u7f13\u5b58\u6a21\u5f0f\u3001\u7b56\u7565\u4e0e\u90e8\u5206\u672f\u8bed</p> <p>lvmcache \u652f\u6301\u4e09\u79cd\u7f13\u5b58\u6a21\u5f0f\uff1a</p> <ul> <li>passthrough: \u7f13\u5b58\u65e0\u6548\u3002\u6b64\u65f6\u6240\u6709\u8bfb\u5199\u90fd\u5230\u540e\u5907\u8bbe\u5907\u3002\u540c\u65f6\u5199\u547d\u4e2d\u4f1a\u89e6\u53d1\u5bf9\u5e94\u7684\u5757\u7f13\u5b58\u5931\u6548\u3002</li> <li>writethrough: \u5199\u5165\u64cd\u4f5c\u5728\u7f13\u5b58\u548c\u540e\u5907\u8bbe\u5907\u4e0a\u90fd\u8fdb\u884c\u3002</li> <li>writeback: \u5199\u5165\u64cd\u4f5c\u53ea\u5728\u7f13\u5b58\u4e0a\u8fdb\u884c\uff0c\u5bf9\u5e94\u7684\u5757\u6807\u8bb0\u4e3a\u810f\u5757\uff08Dirty Block\uff09\u3002 \u9664\u975e\u88ab\u7f13\u5b58\u7684\u6570\u636e\u5b8c\u5168\u65e0\u5173\u7d27\u8981\uff0c\u6216\u8005\u6709\u591a\u5757 SSD \u8fdb\u884c\u7f13\u5b58\uff0c\u5426\u5219\u4e0d\u8981\u4f7f\u7528 writeback\u3002\u6587\u4ef6\u7cfb\u7edf\u6838\u5fc3\u5143\u6570\u636e\u7684\u635f\u574f\u53ef\u80fd\u76f4\u63a5\u5bfc\u81f4\u6574\u4e2a\u6587\u4ef6\u7cfb\u7edf\u65e0\u6cd5\u8bfb\u53d6\u3002</li> </ul> <p>\u5728\u7b56\u7565\u4e00\u680f\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 \"smq\"\u3002\u4e8b\u5b9e\u4e0a\uff0clvmcache \u552f\u4e00\u652f\u6301\u7684\u6709\u6548\u7684\u73b0\u4ee3\u7b56\u7565\u5c31\u662f smq\uff08Stochastic Multi-Queue\uff09\u3002 \u53e6\u4e00\u79cd cleaner \u7b56\u7565\u7528\u4e8e\u5c06\u6240\u6709\u810f\u5757\u5199\u56de\u540e\u5907\u8bbe\u5907\u3002</p> <p>\u6b64\u5916\uff0c\u5728\u9605\u8bfb\u76f8\u5173\u8d44\u6599\u65f6\uff0c\u53ef\u80fd\u4f1a\u770b\u5230\u4e0b\u9762\u4e09\u4e2a\u672f\u8bed\uff1a</p> <ul> <li>Migration\uff1a\u5c06\u4e00\u5757\u6570\u636e\u4ece\u4e00\u4e2a\u8bbe\u5907\u590d\u5236\u5230\u53e6\u4e00\u4e2a\u8bbe\u5907</li> <li>Promotion\uff1a\u5c06\u4e00\u5757\u6570\u636e\u4ece\u540e\u5907\u8bbe\u5907\u590d\u5236\u5230\u7f13\u5b58\u8bbe\u5907</li> <li>Demotion\uff1a\u5c06\u4e00\u5757\u6570\u636e\u4ece\u7f13\u5b58\u8bbe\u5907\u590d\u5236\u5230\u540e\u5907\u8bbe\u5907</li> </ul> <p>@taoky: \u5173\u4e8e\u7f13\u5b58\u6a21\u5f0f</p> <p>\u5206\u4eab\u4e00\u4e2a\u7b11\u8bdd\uff0c\u6700\u5f00\u59cb @iBug \u914d\u7684\u7f13\u5b58\u6a21\u5f0f\u9009\u4e86 passthrough\uff0c\u7406\u7531\u662f\uff1a</p> <p>\u8fd9\u91cc\u7684\u7f13\u5b58\u6a21\u5f0f\u91c7\u7528 passthrough\uff0c\u5373\u5199\u5165\u52a8\u4f5c\u7ed5\u8fc7\u7f13\u5b58\u76f4\u63a5\u5199\u56de\u539f\u8bbe\u5907\uff08\u5f53\u7136\u5566\uff0c\u5199\u5165\u90fd\u662f\u7531\u4ece\u4e0a\u6e38\u540c\u6b65\u4ea7\u751f\u7684\uff09\uff0c\u53e6\u5916\u4e24\u79cd writeback \u548c writethrough \u90fd\u4f1a\u5199\u5165\u7f13\u5b58\uff0c\u4e0d\u662f\u6211\u4eec\u60f3\u8981\u7684\u3002</p> <p>\uff08\u5f53\u7136\uff0c\u8fd9\u662f\u9519\u7684\uff09</p> <p>\u53e6\u5916\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c<code>lvmcache</code> \u505a\u4e86\u8fd9\u4e48\u4e00\u4e2a\u5047\u8bbe\uff1a\u5199\u5165\u7684\u5185\u5bb9\u5f88\u5feb\u5c31\u4f1a\u88ab\u8bfb\u53d6\u3002\u4f46\u662f\u8fd9\u4e2a\u5047\u8bbe\u771f\u7684\u603b\u662f\u6210\u7acb\u5417\uff1f writearound \u7684\u505a\u6cd5\u662f\u5199\u5165\u7684\u5185\u5bb9\u4f1a\u7ed5\u8fc7\u7f13\u5b58\uff0c\u5f53\u7136 lvmcache \u6ca1\u6709\u5b9e\u73b0\u8fd9\u4e2a\u6a21\u5f0f\u3002</p> <code>dm-cache-policy-smq.c</code> \u4e2d\u5b9e\u73b0\u7684 SMQ \u7b56\u7565\u7b97\u6cd5 <p>\u6838\u5fc3\u7684\u7ed3\u6784\u4f53\u662f <code>smq_policy</code>\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e09\u4e2a SMQ \u961f\u5217\uff1a\u70ed\u70b9\uff08hotspot\uff09\u961f\u5217\u3001clean \u961f\u5217\u548c dirty \u961f\u5217\u3002 \u6bcf\u4e2a SMQ \u961f\u5217\u4e2d\u5305\u542b 64 \u4e2a LRU \u961f\u5217\u3002\u8fd9 64 \u4e2a\u961f\u5217\u6784\u6210\u4e0d\u540c\u7684\u7b49\u7ea7\uff0c\u5b58\u50a8\u7531\u70ed\u5230\u51b7\u7684\u5185\u5bb9\u3002</p> <p>\u5982\u679c\u4e0d\u5173\u5fc3\u6570\u636e\u5377\u548c\u5143\u6570\u636e\u5377\u7684\u7ec6\u8282\uff0c\u521b\u5efa <code>cachepool</code> \u7684\u4f53\u9a8c\u4e5f\u7c7b\u4f3c\u3002\u5148\u628a\u4e0a\u9762\u7684 uncache \u6389\uff1a</p> <pre><code>$ sudo lvconvert --uncache vg201-test/lvdata\n  Logical volume \"lvdata_cache\" successfully removed.\n  Logical volume vg201-test/lvdata is not cached and vg201-test/lvdata_cache is removed.\n</code></pre> <p>\u7136\u540e\u521b\u5efa cache-pool \u7c7b\u578b\u7684 LV\uff0c\u5e76\u4e14\u9644\u52a0\u5230\u540e\u5907\u8bbe\u5907\u4e0a\uff1a</p> <pre><code>$ sudo lvcreate --type cache-pool -n lvdata_cache -l 100%FREE vg201-test /dev/loop1\n  Logical volume \"lvdata_cache\" created.\n$ sudo lvs -a\n  LV                   VG         Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata               vg201-test -wi-a----- &lt;100.00g                                                    \n  lvdata_cache         vg201-test Cwi---C---    9.97g                                                    \n  [lvdata_cache_cdata] vg201-test Cwi-------    9.97g                                                    \n  [lvdata_cache_cmeta] vg201-test ewi-------   12.00m                                                    \n  [lvol0_pmspare]      vg201-test ewi-------   12.00m\n$ sudo lvconvert --type cache --cachepool lvdata_cache vg201-test/lvdata\nDo you want wipe existing metadata of cache pool vg201-test/lvdata_cache? [y/n]: y\n  Logical volume vg201-test/lvdata is now cached.\n$ sudo lvs -a\n  LV                         VG         Attr       LSize    Pool                 Origin         Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata                     vg201-test Cwi-a-C--- &lt;100.00g [lvdata_cache_cpool] [lvdata_corig] 0.01   11.07           0.00            \n  [lvdata_cache_cpool]       vg201-test Cwi---C---    9.97g                                     0.01   11.07           0.00            \n  [lvdata_cache_cpool_cdata] vg201-test Cwi-ao----    9.97g                                                                            \n  [lvdata_cache_cpool_cmeta] vg201-test ewi-ao----   12.00m                                                                            \n  [lvdata_corig]             vg201-test owi-aoC--- &lt;100.00g                                                                            \n  [lvol0_pmspare]            vg201-test ewi-------   12.00m\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\uff0c\u5728 <code>lvcreate --type cache-pool</code> \u7684\u65f6\u5019\uff0cLVM \u4f1a\u81ea\u52a8\u521b\u5efa\u4e24\u4e2a LV\uff1a<code>lvdata_cache_cdata</code> \u548c <code>lvdata_cache_cmeta</code>\u3002 \u4f46\u662f\u66f4\u8001\u4e00\u4e9b\u7684\u6559\u7a0b\u4e2d\u4f1a\u4ecb\u7ecd\u5206\u522b\u624b\u5de5\u521b\u5efa\u7f13\u5b58\u548c\u5143\u6570\u636e LV \u7684\u5185\u5bb9\u3002\u8ba9\u6211\u4eec\u5148\u628a\u8fd9\u4e2a\u518d\u62c6\u6389\uff08uncache\uff09\uff0c\u7136\u540e\u624b\u5de5\u505a\u8fd9\u4e2a\u8fc7\u7a0b\u3002</p> <p>\u6839\u636e RHEL 6 \u7684\u6587\u6863\uff0c\u6570\u636e\u548c\u5143\u6570\u636e\u7684\u63a8\u8350\u5927\u5c0f\u6bd4\u4f8b\u662f 1000:1\uff08\u4f8b\u5982\u5982\u679c\u6709 2G \u7684\u7f13\u5b58\uff0c\u90a3\u4e48\u5c31\u9700\u8981 12M \u7684\u5143\u6570\u636e\uff09\u3002 \u8fd9\u91cc\u6211\u4eec\u7684 \"SSD\" \u6709 10G\uff0c\u56e0\u6b64\u5927\u7ea6\u9700\u8981 60M \u7684\u5143\u6570\u636e\uff0c\u53ef\u4ee5\u5148\u521b\u5efa\u5143\u6570\u636e LV\uff0c\u7136\u540e\u5269\u4e0b\u7684\u2014\u2014\u5168\u90e8\u7ed9\u6570\u636e\uff1f</p> <pre><code>$ sudo lvcreate -L 60M -n lvdata_cache_meta vg201-test /dev/loop1\n  Logical volume \"lvdata_cache_meta\" created.\n$ sudo lvcreate -l 100%FREE -n lvdata_cache_data vg201-test /dev/loop1\n  Logical volume \"lvdata_cache_data\" created.\n$ sudo lvconvert --type cache-pool --poolmetadata lvdata_cache_meta --cachemode writethrough vg201-test/lvdata_cache_data\n  WARNING: Converting vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta to cache pool's data and metadata volumes with metadata wiping.\n  THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.)\nDo you really want to convert vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta? [y/n]: y\n  Volume group \"vg201-test\" has insufficient free space (0 extents): 15 required.\n  Failed to set up spare metadata LV for pool.\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd8\u9700\u8981\u4e00\u4e9b\u7a7a\u95f4\uff0815 \u4e2a extent\uff09\uff0c\u56e0\u6b64\u4f7f\u7528 <code>lvreduce</code> \u7559\u70b9\u51fa\u6765\uff1a</p> <pre><code>$ sudo lvreduce -l -15 vg201-test/lvdata_cache_data\n  No file system found on /dev/vg201-test/lvdata_cache_data.\n  Size of logical volume vg201-test/lvdata_cache_data changed from &lt;9.94 GiB (2544 extents) to &lt;9.88 GiB (2529 extents).\n  Logical volume vg201-test/lvdata_cache_data successfully resized.\n$ sudo lvconvert --type cache-pool --poolmetadata lvdata_cache_meta --cachemode writethrough vg201-test/lvdata_cache_data\n  WARNING: Converting vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta to cache pool's data and metadata volumes with metadata wiping.\n  THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.)\nDo you really want to convert vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta? [y/n]: y\n  Converted vg201-test/lvdata_cache_data and vg201-test/lvdata_cache_meta to cache pool.\n</code></pre> <p>\u4e4b\u540e\u5c31\u548c\u4e0a\u9762\u4e00\u81f4\u4e86\uff1a</p> <pre><code>$ sudo lvs -a\n  LV                        VG         Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata                    vg201-test -wi-a----- &lt;100.00g                                                    \n  lvdata_cache_data         vg201-test Cwi---C---   &lt;9.88g                                                    \n  [lvdata_cache_data_cdata] vg201-test Cwi-------   &lt;9.88g                                                    \n  [lvdata_cache_data_cmeta] vg201-test ewi-------   60.00m                                                    \n  [lvol0_pmspare]           vg201-test ewi-------   60.00m\n$ sudo lvconvert --type cache --cachepool lvdata_cache_data vg201-test/lvdata\nDo you want wipe existing metadata of cache pool vg201-test/lvdata_cache_data? [y/n]: y\n  Logical volume vg201-test/lvdata is now cached.\n</code></pre>"},{"location":"ops/storage/lvm-raid/#does-lvmcache-scale","title":"Does lvmcache scale?","text":"<p>\u73b0\u5b9e\u4e2d\u6211\u4eec\u80af\u5b9a\u4e0d\u53ef\u80fd\u53ea\u7528 10G \u7684 SSD \u6765\u505a\u7f13\u5b58\uff0c\u800c\u5728\u975e\u5bb6\u7528\u7684\u573a\u666f\u4e0b\uff0c\u9700\u8981\u7f13\u5b58\u7684\u540e\u5907\u5b58\u50a8\u4e5f\u4e0d\u53ef\u80fd\u53ea\u6709 100G \u8fd9\u4e48\u5927\u3002 \u4e0b\u9762\u8003\u8651\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u76ee\u524d mirrors \u7684\u573a\u666f\uff1a1.5T \u7684 SSD \u7a7a\u95f4\u5bf9 65T \u7684 HDD \u7a7a\u95f4\u8fdb\u884c\u7f13\u5b58\uff08\u6bd4\u4f8b\u5927\u7ea6 1:45\uff09\u3002</p> <p>\u628a\u5df2\u6709\u7684\u62c6\u6389\u4e4b\u540e\u91cd\u65b0\u521b\u5efa 1.5T\uff081536G\uff09\u548c 65T \u7684\u7a00\u758f\u6587\u4ef6\u4f5c\u4e3a SSD \u548c HDD\uff0c\u52a0\u5165 LVM\uff0c\u7136\u540e\u8ba9\u6211\u4eec\u8bd5\u8bd5 cachevol\u2026\u2026</p> <pre><code>$ sudo lvconvert --type cache --cachevol lvdata_cache vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  Cache data blocks 3219046400 and chunk size 128 exceed max chunks 1000000.\n  Use smaller cache, larger --chunksize or increase max chunks setting.\n</code></pre> <p>\u8fd9\u91cc cache \u9700\u8981\u8bb0\u5f55\u7f13\u5b58\u6570\u636e\u7684\u8bbf\u95ee\u60c5\u51b5\uff0c\u8bb0\u5f55\u7684\u5355\u4f4d\u5c31\u662f chunk\uff08\u9700\u8981\u662f 32K \u7684\u500d\u6570\uff09\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cchunk \u5927\u5c0f\u8bbe\u7f6e\u4e3a 64KB\u3002 \u5e76\u4e14 LVM \u63a8\u8350 chunk \u4e0d\u8d85\u8fc7\u4e00\u767e\u4e07\u4e2a\uff08\u8fd9\u4e5f\u662f allocation/cache_pool_max_chunks \u8bbe\u7f6e\u7684\u9ed8\u8ba4\u503c\uff09\u3002 \u6362\u53e5\u8bdd\u8bb2\uff0c\u5982\u679c\u4fdd\u6301\u9ed8\u8ba4\u8bbe\u7f6e\uff0c\u90a3\u4e48\u540e\u5907\u6570\u636e\u6700\u5927\u53ea\u80fd\u6709 64KB * 1,000,000 ~= 64GB &lt;&lt; 1.5T\uff0c\u8fd9\u663e\u7136\u662f\u4e0d\u591f\u7684\u3002</p> <p>\u76f4\u89c9\u6765\u8bb2\uff0c\u65e2\u7136 chunk \u63a8\u8350\u4e0d\u8d85\u8fc7\u4e00\u767e\u4e07\u4e2a\uff0c\u90a3\u5c31\u62c9\u9ad8 chunk size\uff1f\u4f46\u662f\u9700\u8981\u8003\u8651\u8fd9\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u5982\u679c\u8bbf\u95ee\u7684\u6a21\u5f0f\u4e0d\u90a3\u4e48\u8fde\u7eed\uff0c\u90a3\u4e48\u66f4\u5927\u7684 chunk size \u5c31\u52bf\u5fc5\u5bfc\u81f4\u66f4\u591a\u7684\u6570\u636e\u5728\u7f13\u5b58\u548c\u540e\u5907\u8bbe\u5907\u4e4b\u95f4\u6765\u56de\u4f20\u8f93\u3002\uff08\u547d\u4e2d\u7387\u964d\u4f4e\uff09</li> <li>SSD \u7684\u5199\u5165\u91cf\u662f\u6709\u9650\u5236\u7684\u3002\u4e0a\u9762\u4e00\u70b9\u4e2d\u63d0\u5230\u7684\u547d\u4e2d\u7387\u964d\u4f4e\u7684\u95ee\u9898\u4f1a\u5bfc\u81f4\u66f4\u591a\u7684\u5199\u5165\uff0c\u6700\u7ec8\u5bfc\u81f4 SSD \u7684\u5bff\u547d\u7f29\u77ed\u3002</li> </ol> <p>\u56e0\u6b64\u66f4\u597d\u7684\u9009\u62e9\u662f\u4ee5\uff08\u76f8\u5bf9\u66f4\u80fd\u63a5\u53d7\u7684\uff09\u4e00\u4e9b\u989d\u5916\u7684 overhead \u4e3a\u4ee3\u4ef7\uff0c\u589e\u52a0 chunk \u6570\u91cf\u3002\u5177\u4f53\u7684\u300c\u4ee3\u4ef7\u300d\u5728\u540e\u7eed\u521b\u5efa\u540e\uff0c\u53ef\u4ee5\u5728\u5185\u6838\u65e5\u5fd7\u91cc\u9762\u770b\u5230\uff1a</p> <pre><code>[2030783.641796] device-mapper: cache: You have created a cache device with a lot of individual cache blocks (12578624)\n                 All these mappings can consume a lot of kernel memory, and take some time to read/write.\n                 Please consider increasing the cache block size to reduce the overall cache block count.\n</code></pre> <p>\u8003\u8651\u5230\u5728\u670d\u52a1\u5668\u573a\u5408\uff0c\u5185\u5b58\u4e00\u822c\u90fd\u662f\u8db3\u591f\uff08\u751a\u81f3\u8fc7\u91cf\uff09\u7684\uff0c\u56e0\u6b64\u552f\u4e00\u53ef\u80fd\u9700\u8981\u8003\u8651\u7684\u5c31\u662f\u989d\u5916\u7684\u5ef6\u8fdf\u4e86\u3002</p> <p>@taoky: \u771f\u5b9e\u4e8b\u4ef6\u7684\u6559\u8bad</p> <p>\u6700\u5f00\u59cb\u7684\u65f6\u5019\uff0cmirrors \u7684 chunk size \u8bbe\u7f6e\u4e3a\u4e86 1M\uff0c\u7ed3\u679c\u8fc7\u4e86\u4e24\u5e74\u591a\u5c31\u53d1\u73b0 SSD \u5feb\u6302\u4e86\u3002 \u67e5\u770b\u7edf\u8ba1\u53d1\u73b0 SSD \u6bcf\u5c0f\u65f6\u8bfb\u53d6 0.1T\uff0c\u4f46\u662f\u5199 1T \u6570\u636e\u2026\u2026</p> <p>\u56e0\u4e3a\u7ecf\u5386\u8fc7 SSD \u88ab lvmcache \u78e8\u6ca1\u7684\u4e8b\u4ef6\uff0c\u6240\u4ee5\u6211\u4e2a\u4eba\u7684\u770b\u6cd5\u662f\uff0c \u5728 201 \u4e2d\uff0c\u63d0\u53ca\u8fd9\u4e00\u70b9\uff08\u4ee5\u53ca\u540e\u9762\u4f1a\u4ecb\u7ecd lvmcache \u8fd8\u6709\u5176\u4ed6\u7684\u5751\uff09\u662f\u5f88\u91cd\u8981\u7684\u2014\u2014\u6709\u4e9b\u65b9\u6848\u653e\u5927\u89c4\u6a21\u4e4b\u540e\uff0c\u5c31\u4f1a\u51fa\u73b0\u610f\u60f3\u4e0d\u5230\u7684\u95ee\u9898\u3002</p> <pre><code>$ sudo lvconvert --type cache --cachevol lvdata_cache --config allocation/cache_pool_max_chunks=25148800 vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  WARNING: Configured cache_pool_max_chunks value 25148800 is higher then recommended 1000000.\n  Logical volume vg201-test/lvdata is now cached.\n</code></pre> <p>64K \u4e5f\u662f\u76ee\u524d mirrors \u673a\u5668\u4f7f\u7528\u7684 chunk size\u3002</p> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u628a chunk size \u7565\u5fae\u8c03\u5927\u5230 128K\uff0c\u8fd9\u6837\u7684\u8bdd chunk \u5c31\u5c11\u4e00\u4e9b\uff1a</p> <pre><code>$ sudo lvconvert --type cache --cachevol lvdata_cache --chunksize 128K --config allocation/cache_pool_max_chunks=12578624 vg201-test/lvdata\nErase all existing data on vg201-test/lvdata_cache? [y/n]: y\n  WARNING: Configured cache_pool_max_chunks value 12578624 is higher then recommended 1000000.\n  Logical volume vg201-test/lvdata is now cached.\n</code></pre> <p>\u53ef\u80fd\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u6027\u80fd\u6d4b\u8bd5\u6765\u6743\u8861 chunk size \u5e26\u6765\u7684\u5f71\u54cd\u2014\u2014\u8003\u8651\u5230\u672c\u5730\u6d4b\u8bd5\u65f6\u7a00\u758f\u6587\u4ef6\u7b49\u56e0\u7d20\uff0c\u5b9e\u9645\u7684\u6027\u80fd\u6d4b\u8bd5\u53ef\u80fd\u9700\u8981\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u8fdb\u884c\u3002 \u4f8b\u5982\uff0c<code>fio</code> \u5de5\u5177\u53ef\u4ee5\u5bf9\u5757\u8bbe\u5907\u6d4b\u8bd5\u8bfb\u5ef6\u8fdf\u7b49\u6027\u80fd\u6307\u6807\u3002</p> \u4f7f\u7528 fio \u6d4b\u8bd5\u968f\u673a\u8bfb\u5ef6\u8fdf\u7684\u4f8b\u5b50 <p>\u672c\u90e8\u5206\u53c2\u8003\u4e86 Oracle \u7684\u6587\u6863\u3002</p> <p>\u4e00\u4e2a\u53ea\u8bfb\u60c5\u51b5\u4e0b\u6d4b\u8bd5 10s <code>/dev/mapper/vg201--test-lvdata</code> \u7684 4K \u968f\u673a\u8bfb\u7684\u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>$ sudo fio --filename=/dev/mapper/vg201--test-lvdata --direct=1 --rw=randread --bsudo fio --filename=/dev/mapper/vg201--test-lvdata --direct=1 --rw=randread --bs=4k --ioengine=libaio --iodepth=1 --numjobs=1 --time_based --group_reporting --name=readlatency-test-job --runtime=10 --eta-newline=1 --readonly\nreadlatency-test-job: (g=0): rw=randread, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1\nfio-3.36\nStarting 1 process\nfio: file /dev/mapper/vg201--test-lvdata exceeds 32-bit tausworthe random generator.\nfio: Switching to tausworthe64. Use the random_generator= option to get rid of this warning.\nJobs: 1 (f=1): [r(1)][30.0%][r=233MiB/s][r=59.6k IOPS][eta 00m:07s]\nJobs: 1 (f=1): [r(1)][50.0%][r=218MiB/s][r=55.9k IOPS][eta 00m:05s] \nJobs: 1 (f=1): [r(1)][70.0%][r=226MiB/s][r=57.8k IOPS][eta 00m:03s] \nJobs: 1 (f=1): [r(1)][90.0%][r=219MiB/s][r=56.1k IOPS][eta 00m:01s] \nJobs: 1 (f=1): [r(1)][100.0%][r=220MiB/s][r=56.2k IOPS][eta 00m:00s]\nreadlatency-test-job: (groupid=0, jobs=1): err= 0: pid=1334208: Sat Feb 17 23:46:54 2024\nread: IOPS=56.0k, BW=219MiB/s (229MB/s)(2186MiB/10001msec)\n    slat (nsec): min=1143, max=870047, avg=2109.53, stdev=1843.07\n    clat (nsec): min=211, max=26562k, avg=14946.90, stdev=60736.24\n    lat (usec): min=10, max=26564, avg=17.06, stdev=60.82\n    clat percentiles (usec):\n    |  1.00th=[   10],  5.00th=[   12], 10.00th=[   12], 20.00th=[   13],\n    | 30.00th=[   13], 40.00th=[   13], 50.00th=[   13], 60.00th=[   13],\n    | 70.00th=[   14], 80.00th=[   15], 90.00th=[   22], 95.00th=[   23],\n    | 99.00th=[   52], 99.50th=[   76], 99.90th=[  174], 99.95th=[  243],\n    | 99.99th=[  465]\nbw (  KiB/s): min=185288, max=249304, per=100.00%, avg=223874.11, stdev=13053.14, samples=19\niops        : min=46322, max=62326, avg=55968.53, stdev=3263.28, samples=19\nlat (nsec)   : 250=0.01%, 500=0.01%, 750=0.01%, 1000=0.01%\nlat (usec)   : 2=0.01%, 4=0.01%, 10=1.43%, 20=87.06%, 50=10.48%\nlat (usec)   : 100=0.75%, 250=0.24%, 500=0.03%, 750=0.01%, 1000=0.01%\nlat (msec)   : 2=0.01%, 4=0.01%, 10=0.01%, 20=0.01%, 50=0.01%\ncpu          : usr=7.91%, sys=18.76%, ctx=560581, majf=0, minf=23\nIO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%\n    submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%\n    issued rwts: total=559688,0,0,0 short=0,0,0,0 dropped=0,0,0,0\n    latency   : target=0, window=0, percentile=100.00%, depth=1\n\nRun status group 0 (all jobs):\nREAD: bw=219MiB/s (229MB/s), 219MiB/s-219MiB/s (229MB/s-229MB/s), io=2186MiB (2292MB), run=10001-10001msec\n</code></pre>"},{"location":"ops/storage/lvm-raid/#too-dirty-to-use","title":"Too dirty to use","text":"<p>lvmcache \u65b9\u6848\u7684\u4e00\u4e2a\u65e0\u6cd5\u5ffd\u89c6\u7684\u5f0a\u7aef\u662f\uff1a\u5373\u4f7f\u6a21\u5f0f\u8bbe\u7f6e\u4e3a writethrough\uff0c\u5982\u679c\u6ca1\u6709\u5e72\u51c0\u5730\u5378\u8f7d\uff0c\u90a3\u4e48\u5728\u4e0b\u6b21\u52a0\u8f7d\u540e\uff0c\u7f13\u5b58\u4e2d\u6240\u6709\u7684\u5757\u90fd\u4f1a\u88ab\u6807\u8bb0\u4e3a\u810f\u5757\u3002 \u66f4\u52a0\u81f4\u547d\u7684\u662f\uff0c\u5728\u751f\u4ea7\u8d1f\u8f7d\u4e0b\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u810f\u5757\u5199\u56de\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6781\u5176\u7f13\u6162\u7684\u95ee\u9898\uff08\u5373\u4f7f\u8bbe\u7f6e policy \u4e3a cleaner\uff09\uff0c\u4ee5\u81f3\u4e8e\u53ef\u80fd\u8fc7\u4e86\u51e0\u4e2a\u5c0f\u65f6\u90fd\u6ca1\u6709\u8fc1\u79fb\u4efb\u4f55\u4e00\u4e2a\u5757\u3002</p> <p>lvmcache \u7684\u8bbe\u8ba1</p> <p>\u4ece\u524d\u9762\u7684\u7edf\u8ba1\u6570\u636e\u53ef\u4ee5\u6ce8\u610f\u5230\uff0c\u810f\u5757\u7684\u6570\u91cf\u662f\u4e00\u4e2a\u6307\u6807\u3002\u5728 lvmcache \u7684\u8bbe\u8ba1\u4e2d\uff0c\u5b58\u5728\u51fa\u73b0\u6a21\u5f0f\u4e3a writethrough \u5e76\u4e14\u5b58\u5728\u810f\u5757\u7684\u53ef\u80fd\uff0c\u6240\u4ee5\u76ee\u524d\u7a0b\u5e8f\u4e0a\u6ca1\u6709\u5b9e\u73b0\u770b\u5230 writethrough \u4e4b\u540e \u5c31\u5ffd\u7565\u810f\u5757\u7684\u95ee\u9898\u3002</p> \u6a21\u62df\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u7684\u60c5\u51b5 <p>\u683c\u5f0f\u5316\u6211\u4eec\u521a\u624d\u521b\u5efa\u7684\u6709 cache \u7684 LV\uff0c\u4f7f\u7528 <code>fio</code> \u4e0a\u70b9\u538b\u529b\uff1a</p> <pre><code>$ sudo fio --filename=./test --filesize=2G --direct=1 --rw=randrw --bs=4k --ioengine=libaio --iodepth=256 --runtime=120 --numjobs=4 --time_based --group_reporting --name=job_name --eta-newline=1\n</code></pre> <p>\u540c\u65f6\u505a\u5207\u6362 cachemode \u7684\u64cd\u4f5c\uff1a</p> <pre><code>$ sudo lvchange --cachemode writeback vg201-test/lvdata\n  WARNING: repairing a damaged cachevol is not yet possible.\n  WARNING: cache mode writethrough is suggested for safe operation.\nContinue using writeback without repair?y\n  Logical volume vg201-test/lvdata changed.\n$ sudo lvchange --cachemode writethrough vg201-test/lvdata\n  Flushing 16401 blocks for cache vg201-test/lvdata.\n  Flushing 16405 blocks for cache vg201-test/lvdata.\n  Flushing 12309 blocks for cache vg201-test/lvdata.\n  Flushing 8213 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 6481 blocks for cache vg201-test/lvdata.\n  Flushing 2411 blocks for cache vg201-test/lvdata.\n  Logical volume vg201-test/lvdata changed.\n</code></pre> <p>\u53ef\u4ee5\u6ce8\u610f\u5230\u5361\u5728\u4e86 <code>Flushing 6481 blocks</code> \u6bd4\u8f83\u957f\u7684\u65f6\u95f4\u3002\u6d4b\u8bd5\u73af\u5883\u4e3a\u7b14\u8bb0\u672c\u7535\u8111\u7684 NVMe SSD\uff0c\u5982\u679c\u662f\u5b9e\u9645\u7684 HDD + \u8f83\u5927\u8d1f\u8f7d\u7684\u8bdd\uff0c\u95ee\u9898\u4f1a\u4e25\u91cd\u5f97\u591a\u3002</p> <p>\u6839\u636e\u6587\u6863\uff0c<code>migration_threshold</code> \u53c2\u6570\u63a7\u5236\u6bcf\u6b21\u8fc1\u79fb\u810f\u5757\u7684\u6247\u533a\uff08512K\uff09\u6570\u91cf\u3002\u76f8\u5173\u7684 bug report \u5efa\u8bae\u5c06\u8fd9\u4e2a\u503c\u8bbe\u7f6e\u4e3a chunk size \u7684\u81f3\u5c11 8 \u500d\uff08\u9ed8\u8ba4\u4e3a 2048\uff0c\u5bf9\u5e94 1M\uff09\u3002 \u5728\u8c03\u8bd5\u95ee\u9898\u65f6\u53d1\u73b0\uff0c\u4fee\u6539\u8fd9\u4e2a\u503c\u53ef\u4ee5\u5b9e\u73b0\u5f3a\u5236\u8fc1\u79fb\uff08\u4f46\u662f\u8fc1\u79fb\u65f6\u6240\u6709\u76f8\u5173\u7684 IO \u64cd\u4f5c\u90fd\u4f1a\u6682\u505c\uff09\uff0c\u811a\u672c\u7c7b\u4f3c\u8fd9\u6837\uff1a</p> <pre><code># dirty hack\nsudo lvchange --cachepolicy cleaner lug/repo\nfor i in `seq 1 1500`; do sudo lvchange --cachesettings migration_threshold=2113536 lug/repo &amp;&amp; sudo lvchange --cachesettings migration_threshold=16384 lug/repo &amp;&amp; echo $i &amp;&amp; sleep 15; done;\n# \u9700\u8981\u786e\u8ba4\u6ca1\u6709\u810f\u5757\u3002\u5982\u679c\u8fd8\u6709\u7684\u8bdd\u7ee7\u7eed\u6267\u884c\uff08\u6b21\u6570\u8c03\u5c0f\u4e00\u4e9b\uff09\n# \u5982\u679c\u662f\u4ece writeback \u5207\u6362\uff0c\u9700\u8981\u5148\u628a\u6a21\u5f0f\u5207\u5230 writethrough\n# \u7136\u540e\u518d\u4fee\u6539 cachepolicy \u5230 smq\nsudo lvchange --cachepolicy smq lug/repo\n</code></pre> <p>GRUB \u53ef\u80fd\u65e0\u6cd5\u5904\u7406\u81ea\u5b9a\u4e49\u7684 migration_threshold \u7b49\u5c5e\u6027</p> <p>\u53c2\u8003 patch: https://github.com/taoky/grub/commit/484b718831ab3ca034bb5ea3624a85efeb5bf2ba\u3002</p> <p>\u76f8\u5173\u7684\u5907\u6ce8\u4fe1\u606f\uff1ahttps://blog.taoky.moe/attachments/2021-04-17-tunight/show.html#21\u3002</p> <p>\u867d\u7136\u8fd9\u4e2a patch \u4e5f\u6709\u95ee\u9898\uff0c\u5e76\u4e14 GRUB \u7684\u5f00\u53d1\u975e\u5e38\u4e0d\u6d3b\u8dc3\uff0c\u6240\u4ee5\u53ef\u80fd\u4e00\u76f4\u90fd\u8981\u81ea\u5df1\u7f16\u8bd1 GRUB \u4e86\u3002</p> <p>\u6211\u4eec\u76ee\u524d\u7684\u5efa\u8bae\u662f\u5728\u8ba1\u5212\u91cd\u542f\uff08\u7ef4\u62a4\u7a97\u53e3\uff09\u524d\u624b\u52a8\u5378\u8f7d\u7f13\u5b58\uff0c\u5728\u91cd\u542f\u540e\u518d\u6302\u8f7d\uff08\u4e4b\u524d\u7ef4\u62a4\u65f6\u89c2\u5bdf\u5230\uff0c\u5373\u4f7f\u6b63\u5e38\u5173\u673a\uff0c\u4e5f\u53ef\u80fd\u51fa\u73b0\u810f\u5757\u7684\u95ee\u9898\uff09\u3002 \u53e6\u4e00\u79cd\u65b9\u5f0f\u662f\uff1a\uff08\u5728\u786e\u8ba4\u6ca1\u6709\u4e8b\u5b9e\u4e0a\u7684\u810f\u5757\u7684\u524d\u63d0\u4e0b\uff09\u624b\u52a8\u4fee\u6539 LVM \u5143\u6570\u636e\uff0c\u628a\u7f13\u5b58\u6254\u6389\u3002</p> <p>\u5c0f\u5fc3\u64cd\u4f5c</p> <p>\u5bf9\u6bcf\u6b21 LVM \u64cd\u4f5c\uff0clvm \u7684\u5de5\u5177\u90fd\u4f1a\u5728 <code>/etc/lvm/archive</code> \u5907\u4efd\u64cd\u4f5c\u524d\u7684\u5143\u6570\u636e\u4fe1\u606f\uff0c\u540c\u65f6\u5728 <code>/etc/lvm/backup</code> \u5b58\u50a8\u5f53\u524d\u7684\u5143\u6570\u636e\uff0c\u4f46\u662f\u8fd8\u662f\u5c3d\u91cf\u5c0f\u5fc3\uff0c\u4ee5\u514d\u917f\u6210\u60b2\u5267\u3002</p> VG \u5143\u6570\u636e\u4f8b\u5b50 <pre><code># Generated by LVM2 version 2.03.23(2) (2023-11-21): Sun Feb 18 00:25:36 2024\n\ncontents = \"Text Format Volume Group\"\nversion = 1\n\ndescription = \"Created *after* executing 'lvconvert --type cache --cachevol lvdata_cache --config allocation/cache_pool_max_chunks=25148800 vg201-test/lvdata'\"\n\ncreation_host = \"shimarin.taoky.moe\"    # Linux shimarin.taoky.moe 6.6.10-arch1-1 #1 SMP PREEMPT_DYNAMIC Fri, 05 Jan 2024 16:20:41 +0000 x86_64\ncreation_time = 1708187136  # Sun Feb 18 00:25:36 2024\n\nvg201-test {\n    id = \"kDKbJ2-kebs-HaIJ-4Vfj-E4OB-aCce-yEcdAy\"\n    seqno = 34\n    format = \"lvm2\"         # informational\n    status = [\"RESIZEABLE\", \"READ\", \"WRITE\"]\n    flags = []\n    extent_size = 8192      # 4 Megabytes\n    max_lv = 0\n    max_pv = 0\n    metadata_copies = 0\n\n    physical_volumes {\n\n        pv0 {\n            id = \"VfZ83M-BPwe-bIQ1-JJRO-ZBSf-ks8d-fMln8E\"\n            device = \"/dev/loop0\"   # Hint only\n\n            status = [\"ALLOCATABLE\"]\n            flags = []\n            dev_size = 139586437120 # 65 Terabytes\n            pe_start = 2048\n            pe_count = 17039359 # 65 Terabytes\n        }\n\n        pv1 {\n            id = \"8hZXeS-gZJX-OfrY-vfUm-tG1R-pw3V-6c3CBI\"\n            device = \"/dev/loop1\"   # Hint only\n\n            status = [\"ALLOCATABLE\"]\n            flags = []\n            dev_size = 3221225472   # 1.5 Terabytes\n            pe_start = 2048\n            pe_count = 393215   # 1.5 Terabytes\n        }\n    }\n\n    logical_volumes {\n\n        lvdata {\n            id = \"6BsYbX-T21Z-BgiW-pZET-a3Lf-wcSh-E5hSm2\"\n            status = [\"READ\", \"WRITE\", \"VISIBLE\"]\n            flags = []\n            creation_time = 1708181300  # 2024-02-17 22:48:20 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 17039359 # 65 Terabytes\n\n                type = \"cache+CACHE_USES_CACHEVOL\"\n                cache_pool = \"lvdata_cache_cvol\"\n                origin = \"lvdata_corig\"\n                metadata_format = 2\n                chunk_size = 128\n                cache_mode = \"writethrough\"\n                policy = \"smq\"\n                metadata_start = 0\n                metadata_len = 2170880\n                data_start = 2170880\n                data_len = 3219046400\n            }\n        }\n\n        lvdata_cache_cvol {\n            id = \"RuL2He-0xlL-J4fd-T0eD-2YTr-QASe-gsWtBV\"\n            status = [\"READ\", \"WRITE\"]\n            flags = [\"CACHE_VOL\"]\n            creation_time = 1708187133  # 2024-02-18 00:25:33 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 393215   # 1.5 Terabytes\n\n                type = \"striped\"\n                stripe_count = 1    # linear\n\n                stripes = [\n                    \"pv1\", 0\n                ]\n            }\n        }\n\n        lvdata_corig {\n            id = \"xIprwR-KD4I-f6E8-tdgp-lcjN-iUdk-rS63YR\"\n            status = [\"READ\", \"WRITE\"]\n            flags = []\n            creation_time = 1708187136  # 2024-02-18 00:25:36 +0800\n            creation_host = \"shimarin.taoky.moe\"\n            segment_count = 1\n\n            segment1 {\n                start_extent = 0\n                extent_count = 17039359 # 65 Terabytes\n\n                type = \"striped\"\n                stripe_count = 1    # linear\n\n                stripes = [\n                    \"pv0\", 0\n                ]\n            }\n        }\n    }\n\n}\n</code></pre> <p>\u9996\u5148\u5bf9\u6bd4 archive \u548c backup \u4e2d\u7684\u5143\u6570\u636e\uff0c\u786e\u8ba4\u65e0\u8bef\u4e4b\u540e\u4f7f\u7528 <code>vgcfgrestore</code> \u6062\u590d\u5143\u6570\u636e\u3002 \u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u9700\u8981\u7f16\u8f91\u5143\u6570\u636e\u6587\u4ef6\u4ee5\u7b26\u5408\u5b9e\u9645\u60c5\u51b5\uff08\u4f8b\u5982\u5728\u521b\u5efa\u7f13\u5b58\u4e4b\u540e\u53c8\u505a\u4e86\u5176\u4ed6\u64cd\u4f5c\uff09\u3002</p> <pre><code>$ sudo vgcfgrestore -f /etc/lvm/archive/vg201-test_00084-792872325.vg vg201-test\n  Volume group vg201-test has active volume: lvdata.\n  Volume group vg201-test has active volume: lvdata_cache_cvol.\n  Volume group vg201-test has active volume: lvdata_cache_cvol.\n  Volume group vg201-test has active volume: lvdata_cache_cvol.\n  Volume group vg201-test has active volume: lvdata_corig.\n  WARNING: Found 5 active volume(s) in volume group \"vg201-test\".\n  Restoring VG with active LVs, may cause mismatch with its metadata.\nDo you really want to proceed with restore of volume group \"vg201-test\", while 5 volume(s) are active? [y/n]: y\n  Restored volume group vg201-test.\n$ sudo lvs -a\n  WARNING: Detected cache segment type does not match expected type striped for vg201-test/lvdata.\n  LV           VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata       vg201-test -wi-XX--X- &lt;65.00t                                                    \n  lvdata_cache vg201-test -wi-a-----  &lt;1.50t\n</code></pre> <p>\u5728\u91cd\u65b0 activate \u4e4b\u540e\uff0c\u72b6\u6001\u5373\u6062\u590d\u6b63\u5e38\uff1a</p> <pre><code>$ sudo vgchange -an vg201-test\n  0 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo vgchange -ay vg201-test\n  2 logical volume(s) in volume group \"vg201-test\" now active\n$ sudo lvs -a\n  LV           VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert\n  lvdata       vg201-test -wi-a----- &lt;65.00t                                                    \n  lvdata_cache vg201-test -wi-a-----  &lt;1.50t\n</code></pre>"},{"location":"ops/storage/lvm-raid/#_3","title":"\u7f13\u5b58\u7b97\u6cd5\u6bd4\u8f83","text":"<ol> <li> <p>\u63a8\u8350\u67e5\u770b\u6700\u65b0\u7248\u672c\u7684 RHEL \u624b\u518c\u8fdb\u884c\u9605\u8bfb\uff0c\u56e0\u4e3a\u65b0\u7248\u672c\u53ef\u80fd\u5305\u542b\u4e00\u4e9b\u65b0\u7279\u6027\uff0c\u5e76\u4e14 Debian \u7684\u7248\u672c\u66f4\u65b0\u6bd4 RHEL \u66f4\u5feb\u3002\u672c\u94fe\u63a5\u6307\u5411\u76ee\u524d\u6700\u65b0\u7684 RHEL 9 \u7684 LVM \u624b\u518c\u3002\u00a0\u21a9</p> </li> </ol>"},{"location":"ops/storage/zfs/","title":"ZFS","text":""},{"location":"ops/virtualization/qemu-kvm/","title":"QEMU/KVM","text":"<p>\u672c\u6587\u4ecd\u5728\u7f16\u8f91\u4e2d</p> <p>QEMU/KVM \u662f Linux \u670d\u52a1\u5668\u4e0a\u5e38\u7528\u7684\u865a\u62df\u5316\u65b9\u6848\u3002\u5176\u5206\u4e3a\u8fd0\u884c\u5728\u7528\u6237\u7a7a\u95f4\u7684 QEMU \u548c\u8fd0\u884c\u5728\u5185\u6838\u7a7a\u95f4\u7684 KVM \u4e24\u90e8\u5206\u3002QEMU \u8d1f\u8d23\u6a21\u62df\u786c\u4ef6\uff0cKVM \u5219\u8d1f\u8d23\u865a\u62df\u673a\u7684\u8fd0\u884c\u3002</p> <p>\u672c\u90e8\u5206\u5c06\u5bf9 QEMU \u548c KVM \u57fa\u7840\u77e5\u8bc6\u548c\u57fa\u672c\u64cd\u4f5c\u8fdb\u884c\u4ecb\u7ecd\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_1","title":"\u7ec4\u4ef6\u4ecb\u7ecd","text":""},{"location":"ops/virtualization/qemu-kvm/#qemu","title":"QEMU","text":"<p>QEMU\uff08Quick Emulator\uff09\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u865a\u62df\u5316\u8f6f\u4ef6\uff0c\u5b83\u901a\u8fc7\u52a8\u6001\u4e8c\u8fdb\u5236\u7ffb\u8bd1\u6765\u6a21\u62df CPU\uff0c\u5e76\u63d0\u4f9b\u4e00\u7cfb\u5217\u7684\u786c\u4ef6\u6a21\u578b\uff0c\u53ef\u4ee5\u6a21\u62df\u591a\u79cd\u5916\u8bbe\u786c\u4ef6\u3002QEMU \u53ef\u4ee5\u5728\u6ca1\u6709\u786c\u4ef6\u52a0\u901f\u7684\u60c5\u51b5\u4e0b\u72ec\u7acb\u8fd0\u884c\uff0c\u4f46\u8fd9\u6837\u5176\u4e2d\u7684 CPU \u90e8\u5206\u662f\u6a21\u62df\u6307\u4ee4\u7684\u6267\u884c\uff0c\u6027\u80fd\u4f4e\u4e0b\u3002</p> <p>\u6b64\u5916 QEMU \u4e5f\u53ef\u4ee5\u4ec5\u7528\u4e8e CPU \u6307\u4ee4\u548c\u7cfb\u7edf\u8c03\u7528\u7684\u7ffb\u8bd1\uff0c\u4e0d\u6a21\u62df\u786c\u4ef6\u6a21\u578b\uff0c\u8fd9\u79cd\u6a21\u5f0f\u79f0\u4e3a User Mode\u3002\u4e3b\u8981\u7528\u4e8e\u8fd0\u884c\u4e0d\u540c\u4e8e\u5bbf\u4e3b\u7cfb\u7edf CPU \u6307\u4ee4\u96c6\u7684\u7528\u6237\u6001\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#kvm","title":"KVM","text":"<p>KVM\uff08Kernel-based Virtual Machine\uff09\u662f\u4e00\u79cd\u57fa\u4e8eLinux\u5185\u6838\u7684\u5f00\u6e90\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\u3002KVM\u5c06Linux\u8f6c\u53d8\u6210\u4e00\u4e2a\u865a\u62df\u673a\u76d1\u89c6\u5668\uff08Hypervisor\uff09\u3002\u5b83\u5229\u7528\u4e86\u73b0\u4ee3\u5904\u7406\u5668\u4e2d\u7684\u786c\u4ef6\u865a\u62df\u5316\u652f\u6301\uff08\u4f8b\u5982Intel VT\u6216AMD-V\uff09\uff0c\u4ee5\u5b9e\u73b0\u9ad8\u6027\u80fd\u7684\u865a\u62df\u5316\u3002\u5b83\u4e13\u6ce8\u4e8e\u4ee5\u6700\u5c0f\u7684\u5f00\u9500\u5728Linux\u4e0a\u63d0\u4f9b\u5b89\u5168\u548c\u9694\u79bb\u7684\u865a\u62df\u73af\u5883\uff0c\u540c\u65f6\u7ef4\u6301\u63a5\u8fd1\u539f\u751f\u7684\u6027\u80fd\u3002\u5b83\u5411\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u4e86\u865a\u62df CPU \u548c\u5185\u5b58\u5b50\u7cfb\u7edf\u7684\u914d\u7f6e\u548c\u6267\u884c\u63a7\u5236\u76f8\u5173\u63a5\u53e3\uff0c\u4f46 KVM \u4e0d\u5305\u542b\u786c\u4ef6\u6a21\u578b\uff0c\u4e0d\u80fd\u72ec\u7acb\u6784\u6210\u865a\u62df\u673a\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#qemukvm_1","title":"QEMU/KVM","text":"<p>QEMU \u4e0e KVM \u7684\u5173\u7cfb\u662f\u4e92\u8865\u7684\u3002\u5f53\u4e8c\u8005\u7ed3\u5408\u4f7f\u7528\u65f6\uff0cQEMU \u8d1f\u8d23\u63d0\u4f9b\u8f6f\u4ef6\u6a21\u62df\u548c\u7528\u6237\u754c\u9762\uff0c\u800c KVM \u5219\u5728\u5185\u6838\u7ea7\u522b\u63d0\u4f9b\u786c\u4ef6\u52a0\u901f\u652f\u6301\u3002\u8fd9\u79cd\u914d\u5408\u4f7f\u5f97\u865a\u62df\u673a\u80fd\u591f\u4ee5\u8f83\u4f4e\u7684\u6027\u80fd\u5f00\u9500\u8fd0\u884c\uff0c\u540c\u65f6\u7528\u6237\u8fd8\u53ef\u4ee5\u4eab\u53d7\u5230 QEMU \u5728\u8bbe\u5907\u6a21\u62df\u65b9\u9762\u63d0\u4f9b\u7684\u7075\u6d3b\u6027\u3002\u5b9e\u9645\u4e0a\uff0cQEMU \u901a\u5e38\u4f5c\u4e3a\u7528\u6237\u7a7a\u95f4\u7684\u5de5\u5177\u4e0e KVM \u7684\u5185\u6838\u865a\u62df\u5316\u529f\u80fd\u914d\u5408\uff0c\u4e00\u8d77\u5f62\u6210\u4e86\u73b0\u4ee3 Linux \u73af\u5883\u4e2d\u5f3a\u5927\u7684\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_2","title":"\u5b89\u88c5\u914d\u7f6e","text":"<p>\u73b0\u5728\u5927\u591a\u6570\u53d1\u884c\u7248\u63d0\u4f9b\u7684\u5185\u6838\u90fd\u5305\u542b KVM \u76f8\u5173\u6a21\u5757\uff0c\u4e5f\u63d0\u4f9b\u4e86 QEMU \u7684\u4e8c\u8fdb\u5236\u5305\u3002\u56e0\u6b64\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0cKVM \u65e0\u9700\u8fdb\u884c\u4efb\u4f55\u914d\u7f6e\uff0c\u53ea\u9700\u8981\u5b89\u88c5 QEMU \u7684\u4e8c\u8fdb\u5236\u5305\u5373\u53ef\u3002</p> <p>\u5982\u679c\u9700\u8981\u624b\u52a8\u8fdb\u884c\u914d\u7f6e\uff0c\u4ee5\u4e0b\u5185\u5bb9\u53ef\u4ee5\u4f5c\u4e3a\u53c2\u8003\u3002</p> KVM <p>\u4ee5 x86 \u4e3a\u4f8b\u3002</p> <ol> <li>\u786e\u4fdd\u5185\u6838\u914d\u7f6e\u4e2d\u5305\u542b\u4e86 KVM \u76f8\u5173\u6a21\u5757\u3002\u9700\u8981\u7684\u914d\u7f6e\u9879\u5305\u62ec\uff1a<ul> <li><code>CONFIG_KVM</code></li> <li><code>CONFIG_KVM_INTEL</code> \u6216 <code>CONFIG_KVM_AMD</code></li> <li>EPT \u652f\u6301\u7b49\u6a21\u5757</li> </ul> </li> <li>\u52a0\u8f7d KVM \u6a21\u5757\uff1a<code>modprobe kvm_intel</code> \u6216 <code>modprobe kvm_amd</code>\u3002</li> <li>\u6b63\u786e\u914d\u7f6e <code>/dev/kvm</code> \u5b57\u7b26\u8bbe\u5907\u7684\u6743\u9650\uff0c\u4f7f\u9700\u8981\u8fd0\u884c\u865a\u62df\u673a\u7684\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8bbe\u5907\u3002</li> </ol> QEMU <p>\u53ea\u9700\u5b89\u88c5 QEMU \u7684\u4e8c\u8fdb\u5236\u5305\u3002</p> <p>\u5982\u679c\u53d1\u884c\u7248\u4e0d\u63d0\u4f9b\u76f8\u5173\u5305\uff0c\u4e5f\u53ef\u4ee5\u4ece QEMU \u5b98\u7f51 \u4e0b\u8f7d\u6e90\u7801\u7f16\u8bd1\u5b89\u88c5\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_3","title":"\u7b2c\u4e00\u53f0\u865a\u62df\u673a","text":"<p>\u4ee5\u4e0b\u5b9e\u4f8b\u547d\u4ee4\u7528\u4e8e\u542f\u52a8\u4e00\u4e2a\u4f7f\u7528 KVM, \u5e26\u6709\u53cc\u6838 CPU\uff0c1GB \u5185\u5b58\uff0c\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>example.img</code> \u7684\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u548c\u7528\u6237\u6001\u7f51\u7edc\u7684\u865a\u62df\u673a\u3002</p> <pre><code>qemu-system-x86_64 \\\n    -enable-kvm \\\n    -m 1024 \\\n    -cpu host \\\n    -smp cores=2 \\\n    -drive file=example.img,format=raw,if=virtio \\\n    -nic user,model=virtio\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u7684\u5404\u4e2a\u53c2\u6570\u610f\u4e49\u5982\u4e0b\uff1a</p> <ul> <li><code>qemu-system-x86_64</code>: QEMU \u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u540d\uff0c\u8fd9\u91cc\u8868\u793a\u8fd0\u884c x86_64 \u67b6\u6784\u7684\u7cfb\u7edf\u7ea7\u6a21\u62df\u5668\u3002</li> <li><code>-enable-kvm</code>: \u542f\u7528 KVM\u3002</li> <li><code>-m 1024</code>: \u5206\u914d 1024MB \u5185\u5b58\u3002</li> <li><code>-cpu host</code>: \u4f7f\u7528\u5bbf\u4e3b\u673a CPU \u6a21\u578b\u3002</li> <li><code>-smp cores=2</code>: \u4f7f\u7528 2 \u4e2a CPU \u6838\u5fc3\u3002</li> <li><code>-drive file=example.img,format=raw,if=virtio</code>: \u4f7f\u7528 <code>example.img</code> \u4f5c\u4e3a\u78c1\u76d8\u955c\u50cf\uff0c\u683c\u5f0f\u4e3a <code>raw</code>\uff0c\u4f7f\u7528 <code>virtio</code> \u8bbe\u5907\u6a21\u578b\u3002</li> <li><code>-nic user,model=virtio</code>: \u4f7f\u7528\u7528\u6237\u6001\u7f51\u7edc\u8bbe\u5907\uff0c\u4f7f\u7528 <code>virtio</code> \u8bbe\u5907\u6a21\u578b\u3002</li> </ul> <p>\u8fd9\u53ea\u662f\u521b\u5efa\u865a\u62df\u673a\u7684\u4e00\u4e2a\u57fa\u672c\u793a\u4f8b\uff0cQEMU \u63d0\u4f9b\u4e86\u5f88\u591a\u5176\u4ed6\u9009\u9879\uff0c\u53ef\u4ee5\u8ba9\u60a8\u5b9a\u5236\u7f51\u7edc\u3001\u56fe\u5f62\u8f93\u51fa\u3001\u8bbe\u5907\u7b49\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_4","title":"\u8be6\u7ec6\u914d\u7f6e","text":""},{"location":"ops/virtualization/qemu-kvm/#_5","title":"\u5757\u5b58\u50a8","text":""},{"location":"ops/virtualization/qemu-kvm/#_6","title":"\u5b58\u50a8\u683c\u5f0f","text":"<p>QEMU \u652f\u6301\u591a\u79cd\u5b58\u50a8\u683c\u5f0f\uff0c\u6bcf\u79cd\u683c\u5f0f\u90fd\u6709\u5176\u7279\u5b9a\u7684\u4f18\u70b9\u548c\u7528\u9014\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u6700\u5e38\u89c1\u7684 QEMU \u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff1a</p> <ol> <li>raw: \u8fd9\u662f\u6700\u7b80\u5355\u7684\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\u3002\u5b83\u662f\u672a\u7ecf\u8fc7\u4efb\u4f55\u5904\u7406\u7684\u78c1\u76d8\u955c\u50cf\uff0c\u6ca1\u6709\u4efb\u4f55\u5143\u6570\u636e\u6216\u9644\u52a0\u7279\u6027\u3002\u56e0\u4e3a\u5176\u7b80\u5355\u6027\uff0c\u5b83\u901a\u5e38\u6709\u6700\u597d\u7684\u6027\u80fd\uff0c\u5e76\u4e14\u53ef\u4ee5\u76f4\u63a5\u88ab\u8bb8\u591a\u5176\u4ed6\u5de5\u5177\u8bfb\u53d6\uff0c\u6bd4\u5982 dd\u3002\u5982\u679c\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\u7a00\u758f\u6587\u4ef6\uff0c\u90a3\u4e48 raw \u683c\u5f0f\u7684\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u53ef\u4ee5\u975e\u5e38\u5c0f\uff0c\u56e0\u4e3a\u5b83\u53ea\u4f1a\u5728\u9700\u8981\u65f6\u624d\u589e\u957f\u5230\u6240\u9700\u5927\u5c0f\u3002\u5982\u679c\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u652f\u6301 hole-punching \u64cd\u4f5c\uff0c\u90a3\u4e48 raw \u683c\u5f0f\u7684\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u53ef\u4ee5\u76f4\u63a5\u91ca\u653e\u672a\u4f7f\u7528\u7684\u7a7a\u95f4\u3002</li> <li>qcow2 (QEMU Copy-On-Write version 2): \u8fd9\u662fQEMU\u6700\u5e38\u7528\u7684\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\u3002\u5b83\u652f\u6301\u8bb8\u591a\u9ad8\u7ea7\u7279\u6027\uff0c\u5982\u5199\u65f6\u590d\u5236 (copy-on-write)\uff0c\u5feb\u7167\uff0c\u538b\u7f29\uff0c\u52a0\u5bc6\u548c\u589e\u91cf\u5907\u4efd\u3002</li> </ol> <p>\u6b64\u5916 QEMU \u8fd8\u652f\u6301\u8bb8\u591a\u5176\u4ed6\u78c1\u76d8\u683c\u5f0f\uff0c\u5982 vmdk, vdi, vhdx \u7b49\u3002\u7531\u4e8e\u8fd9\u4e9b\u683c\u5f0f\u4e0d\u662f\u5f88\u5e38\u89c1\uff0c\u8fd9\u91cc\u4e0d\u518d\u8be6\u7ec6\u4ecb\u7ecd\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_7","title":"\u914d\u7f6e\u53c2\u6570","text":"<p>QEMU \u4e2d\u5b58\u50a8\u5206\u4e3a\u5b58\u50a8\u540e\u7aef\u548c\u5b58\u50a8\u8bbe\u5907\u4e24\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u4f7f\u7528 <code>-blockdev</code> \u548c <code>-device</code> \u53c2\u6570\u8fdb\u884c\u914d\u7f6e\u3002</p> <p><code>-blockdev</code> \u53c2\u6570\u7528\u4e8e\u914d\u7f6e\u5b58\u50a8\u540e\u7aef\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>-blockdev driver=&lt;file|raw|qcow2&gt;,node-name=&lt;name&gt;,file=&lt;path&gt;,&lt;other opts&gt;\n</code></pre> <p>\u5176\u4e2d <code>raw</code> \u548c <code>qcow2</code> driver \u901a\u5e38\u5c42\u53e0\u5728 <code>file</code> \u540e\u7aef\u4e0a\u4f7f\u7528\u3002<code>node-name</code> \u53c2\u6570\u7528\u4e8e\u6307\u5b9a\u8be5\u540e\u7aef\u7684\u540d\u79f0\uff0c\u4ee5\u4fbf\u4e8e\u540e\u9762\u5f15\u7528\u3002</p> <p><code>-device</code> \u53c2\u6570\u7528\u4e8e\u914d\u7f6e\u8bbe\u5907\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>-device virtio-blk-pci,drive=&lt;blockdev node name&gt;,&lt;other opts&gt;\n</code></pre> <p>\u5176\u4e2d <code>virtio-blk-pci</code> \u662f\u8bbe\u5907\u6a21\u578b\uff0c<code>drive</code> \u53c2\u6570\u7528\u4e8e\u6307\u5b9a\u8be5\u8bbe\u5907\u7684\u540e\u7aef\u3002\u9664\u4e86 <code>virtio-blk-pci</code>\uff0cQEMU \u8fd8\u652f\u6301\u5176\u4ed6\u8bbe\u5907\u6a21\u578b\uff0c\u5982 <code>ide</code>\uff0c<code>scsi</code> \u7b49\u3002</p> <p>\u6b64\u5916\uff0cQEMU \u8fd8\u652f\u6301 <code>-drive</code> \u53c2\u6570\u7528\u4e8e\u540c\u65f6\u914d\u7f6e\u5b58\u50a8\u540e\u7aef\u548c\u8bbe\u5907\uff0c\u5176\u5b9e\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>-drive file=example.img,format=raw,if=virtio\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u66f4\u52a0\u7b80\u6d01\uff0c\u4f46\u4e0d\u5982 <code>-blockdev</code> \u548c <code>-device</code> \u53c2\u6570\u7075\u6d3b\u3002\u5f53 <code>if</code> \u9009\u9879\u503c\u4e3a <code>none</code> \u65f6\uff0c<code>-drive</code> \u9009\u9879\u4ec5\u521b\u5efa\u540e\u7aef\uff0c\u4e0d\u521b\u5efa\u8bbe\u5907\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_8","title":"\u7f51\u7edc","text":"<p>QEMU \u652f\u6301\u591a\u79cd\u7f51\u7edc\u540e\u7aef\uff0c\u5305\u62ec <code>user</code>\uff0c<code>tap</code>\uff0c<code>bridge</code> \u7b49\u3002\u5176\u4e2d <code>user</code> \u662f\u6700\u7b80\u5355\u7684\u7f51\u7edc\u540e\u7aef\uff0c\u5b83\u4f7f\u7528\u5bbf\u4e3b\u673a\u7684 NAT \u7f51\u7edc\u8fdb\u884c\u7f51\u7edc\u8fde\u63a5\u3002<code>tap</code> \u5219\u662f\u6700\u5e38\u7528\u7684\u7f51\u7edc\u540e\u7aef\uff0c\u5b83\u4f7f\u7528\u4e3b\u673a\u4e0a\u7684 TAP \u8bbe\u5907\u8fdb\u884c\u7f51\u7edc\u8fde\u63a5\u3002<code>bridge</code> \u4e0e <code>tap</code> \u6ca1\u6709\u672c\u8d28\u533a\u522b\uff0c\u5b83\u53ea\u662f\u81ea\u52a8\u5c06\u521b\u5efa\u7684 tap \u63a5\u53e3\u63a5\u5230\u7f51\u6865\u4e0a\u3002</p> <p><code>-nic</code> \u53c2\u6570\u540c\u65f6\u914d\u7f6e\u7f51\u7edc\u540e\u7aef\u548c\u8bbe\u5907\uff0c\u5e38\u7528\u7684\u914d\u7f6e\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>-nic [tap|bridge|user|l2tpv3|vde|netmap|af-xdp|vhost-user|socket][,...][,mac=macaddr][,model=mn]\n</code></pre> <p>QEMU \u652f\u6301\u591a\u79cd\u7f51\u7edc\u8bbe\u5907\u6a21\u578b\uff0c\u5305\u62ec <code>virtio</code>\uff0c<code>e1000</code>\uff0c<code>rtl8139</code> \u7b49\u3002\u5176\u4e2d <code>virtio</code> \u662f\u6027\u80fd\u6700\u597d\u7684\u8bbe\u5907\u6a21\u578b\uff0c\u4e14\u73b0\u5728\u51e0\u4e4e\u6240\u6709 Linux \u53d1\u884c\u7248\u5747\u5305\u542b\u4e86\u5bf9\u5e94\u9a71\u52a8\uff0c\u56e0\u6b64\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u76f4\u63a5\u4f7f\u7528\u8be5\u6a21\u578b\u5373\u53ef\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_9","title":"\u5185\u5b58","text":"<p>\u672c\u8282\u5185\u5bb9\u5f85\u8865\u5145</p>"},{"location":"ops/virtualization/qemu-kvm/#cpu","title":"CPU","text":"<p>\u672c\u8282\u5185\u5bb9\u5f85\u8865\u5145</p>"},{"location":"ops/virtualization/qemu-kvm/#_10","title":"\u5b9e\u7528\u5de5\u5177","text":""},{"location":"ops/virtualization/qemu-kvm/#qemu-img","title":"qemu-img","text":"<p><code>qemu-img</code> \u662f QEMU \u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u4e8e\u521b\u5efa\u3001\u8f6c\u6362\u548c\u64cd\u4f5c\u78c1\u76d8\u955c\u50cf\u7684\u5de5\u5177\u3002\u5b83\u652f\u6301\u591a\u79cd\u78c1\u76d8\u683c\u5f0f\uff0c\u53ef\u4ee5\u65b9\u4fbf\u5730\u8fdb\u884c\u78c1\u76d8\u955c\u50cf\u7684\u521b\u5efa\u3001\u8f6c\u6362\u3001\u6269\u5bb9\u7b49\u64cd\u4f5c\u3002</p> <p><code>qemu-img</code> \u7684\u8be6\u7ec6\u7528\u6cd5\u548c\u9009\u9879\u53ef\u4ee5\u901a\u8fc7 <code>man qemu-img</code> \u6216 <code>qemu-img --help</code> \u67e5\u770b\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_11","title":"\u521b\u5efa","text":"<p><code>qemu-img create</code> \u547d\u4ee4\u7528\u4e8e\u521b\u5efa\u78c1\u76d8\u955c\u50cf\uff0c\u57fa\u672c\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>qemu-img create -f &lt;FORMAT:raw|qcow2|...&gt; -o &lt;OPTIONS&gt; &lt;IMAGE&gt; &lt;SIZE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>-o</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u683c\u5f0f\u76f8\u5173\u7684\u9009\u9879\uff0c<code>&lt;IMAGE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\uff0c<code>&lt;SIZE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u5927\u5c0f\u3002</p> <p>Tip</p> <p>\u521b\u5efa <code>qcow2</code> \u683c\u5f0f\u7684\u78c1\u76d8\u955c\u50cf\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>-o preallocation=metadata</code> \u9009\u9879\u6307\u5b9a\u9884\u5206\u914d\u5143\u6570\u636e\uff0c\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_12","title":"\u8f6c\u6362","text":"<p><code>qemu-img convert</code> \u547d\u4ee4\u7528\u4e8e\u8f6c\u6362\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c\u57fa\u672c\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>qemu-img convert -f &lt;SRC_FORMAT:raw|qcow2|...&gt; -O &lt;DST_FORMAT:raw|qcow2|...&gt; -o &lt;OPTIONS&gt; &lt;SRC_IMAGE&gt; &lt;DST_IMAGE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u6e90\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>-O</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u76ee\u6807\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>-o</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u683c\u5f0f\u76f8\u5173\u7684\u9009\u9879\uff0c<code>&lt;SRC_IMAGE&gt;</code> \u4e3a\u6e90\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\uff0c<code>&lt;DST_IMAGE&gt;</code> \u4e3a\u76ee\u6807\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_13","title":"\u6269\u7f29\u5bb9","text":"<p><code>qemu-img resize</code> \u547d\u4ee4\u7528\u4e8e\u6269\u7f29\u5bb9\u78c1\u76d8\u955c\u50cf\uff0c\u57fa\u672c\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>qemu-img resize -f &lt;FORMAT&gt; [--shrink] &lt;IMAGE&gt; [+|-]&lt;SIZE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>--shrink</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u662f\u5426\u6536\u7f29\u78c1\u76d8\u955c\u50cf\uff0c<code>&lt;IMAGE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u540d\uff0c<code>&lt;SIZE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u5927\u5c0f\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7f29\u5c0f\u955c\u50cf\u65f6\uff0c\u8d85\u8fc7\u6307\u5b9a\u5927\u5c0f\u7684\u6570\u636e\u5c06\u88ab\u622a\u65ad\u4e22\u5f03\uff0c\u56e0\u6b64\u9700\u8981\u5728\u955c\u50cf\u5185\u90e8\u5148\u8fdb\u884c\u6587\u4ef6\u7cfb\u7edf\u5bb9\u91cf\u8c03\u6574\u548c\u5206\u533a\u8868\u8c03\u6574\u64cd\u4f5c\uff0c\u5e76\u9700\u8981\u5c0f\u5fc3\u8ba1\u7b97\u5404\u5206\u533a\u504f\u79fb\u91cf\u548c\u76ee\u6807\u955c\u50cf\u5927\u5c0f\u3002</p> <p>Tip</p> <p>\u7f29\u5bb9\u65f6\uff0c\u53ef\u4ee5\u5148\u5c06\u5185\u90e8\u6587\u4ef6\u7cfb\u7edf\u8c03\u6574\u81f3\u6700\u5c0f\u5927\u5c0f\uff0c\u7136\u540e\u8c03\u6574\u5206\u533a\u5927\u5c0f\u81f3\u76ee\u6807\u5927\u5c0f\uff0c\u63a5\u7740\u8c03\u6574\u955c\u50cf\u5927\u5c0f\uff0c\u6700\u540e\u518d\u5c06\u6587\u4ef6\u7cfb\u7edf\u6269\u5bb9\u81f3\u6700\u5927\u3002\u5728\u6b64\u8fc7\u7a0b\u4e2d\u4e5f\u9700\u8981\u5c0f\u5fc3\u8ba1\u7b97\u6d89\u53ca\u5230\u7684\u5404\u79cd\u5927\u5c0f\u548c\u504f\u79fb\u91cf\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#qemu-nbd","title":"qemu-nbd","text":"<p><code>qemu-nbd</code> \u662f QEMU \u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u4e8e\u6302\u8f7d\u78c1\u76d8\u955c\u50cf\u7684\u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u5c06\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u6620\u5c04\u4e3a\u4e00\u4e2a\u5757\u8bbe\u5907\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>mount</code> \u547d\u4ee4\u5c06\u5176\u6302\u8f7d\u5230\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6216\u8005\u5bf9\u8be5\u5757\u8bbe\u5907\u8fdb\u884c\u5176\u4ed6\u64cd\u4f5c\u3002</p> <p>\u4f7f\u7528\u524d\u9700\u8981\u5148\u52a0\u8f7d <code>nbd</code> \u5185\u6838\u6a21\u5757\uff1a</p> <pre><code>modprobe nbd\n</code></pre> <p>\u5751</p> <p><code>nbd</code> \u9ed8\u8ba4\u521b\u5efa\u5f88\u591a nbd \u8bbe\u5907\uff0c\u5360\u636e\u5927\u91cf\u8bbe\u5907\u53f7\uff0c\u5982\u679c\u4e3b\u673a\u4e0a\u672c\u6765\u5c31\u5df2\u7ecf\u6709\u5f88\u591a\u8bbe\u5907\uff0c\u5728\u52a0\u8f7d <code>nbd</code> \u6a21\u5757\u7684\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u56e0\u8bbe\u5907\u53f7\u5206\u914d\u5931\u8d25\u800c\u51fa\u9519\uff0c\u5728\u5185\u6838\u65e5\u5fd7\u4e2d\u7559\u4e0b\u4e00\u4e2a oops\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u901a\u8fc7 <code>nbds_max</code> \u53c2\u6570\u9650\u5236 <code>nbd</code> \u8bbe\u5907\u7684\u6570\u91cf\u3002</p> <pre><code>modprobe nbd nbds_max=2\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>qemu-nbd</code> \u547d\u4ee4\u6302\u8f7d\u78c1\u76d8\u955c\u50cf\uff0c\u5e38\u7528\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>qemu-nbd -c /dev/nbdX -f &lt;FORMAT:raw|qcow2|...&gt; --discard=&lt;unmap|ignore&gt; &lt;IMAGE&gt;\n</code></pre> <p>\u5176\u4e2d <code>-c</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a nbd \u8bbe\u5907\u53f7\uff0c<code>-f</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u683c\u5f0f\uff0c<code>--discard</code> \u9009\u9879\u7528\u4e8e\u6307\u5b9a\u78c1\u76d8\u955c\u50cf\u652f\u6301\u7684 TRIM/DISCARD \u64cd\u4f5c\uff0c<code>&lt;IMAGE&gt;</code> \u4e3a\u78c1\u76d8\u955c\u50cf\u6587\u4ef6\u3002\u5982\u679c\u9700\u8981\u53ea\u8bfb\u6302\u8f7d\uff0c\u53ef\u4ee5\u6307\u5b9a <code>-r</code> \u9009\u9879\u3002<code>qemu-nbd</code> \u7684\u5176\u4ed6\u7528\u6cd5\u548c\u9009\u9879\u53ef\u4ee5\u901a\u8fc7 <code>man qemu-nbd</code> \u6216 <code>qemu-nbd --help</code> \u67e5\u770b\u3002</p>"},{"location":"ops/virtualization/qemu-kvm/#_14","title":"\u7ba1\u7406\u5de5\u5177","text":"<p>\u672c\u8282\u5185\u5bb9\u5f85\u8865\u5145</p> <p>QEMU \u76f4\u63a5\u8fd0\u884c\u53c2\u6570\u4f17\u591a\uff0c\u914d\u7f6e\u590d\u6742\uff0c\u56e0\u6b64\u4e00\u822c\u4e0d\u76f4\u63a5\u8fd0\u884c QEMU \u547d\u4ee4\uff0c\u800c\u662f\u4f7f\u7528\u4e00\u4e9b\u7ba1\u7406\u5de5\u5177\u6765\u521b\u5efa\u548c\u7ba1\u7406\u865a\u62df\u673a\uff0c\u5982 libvirt\uff0cvirt-manager, Proxmox VE \u7b49\u3002</p>"}]}